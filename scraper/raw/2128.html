<html data-wf-domain="positive.security" data-wf-page="606c724dd0233ea40b7bce57" data-wf-site="5f6498c074436c50c016e745" class="w-mod-js wf-montserrat-n1-active wf-montserrat-n2-active wf-montserrat-n4-active wf-montserrat-i1-active wf-montserrat-i2-active wf-montserrat-i3-active wf-montserrat-i4-active wf-montserrat-n3-active wf-montserrat-n5-active wf-montserrat-i5-active wf-montserrat-n6-active wf-montserrat-i6-active wf-montserrat-n7-active wf-montserrat-i7-active wf-montserrat-n8-active wf-montserrat-i8-active wf-montserrat-n9-active wf-montserrat-i9-active wf-active w-mod-ix"><head><style>.wf-force-outline-none[tabindex="-1"]:focus{outline:none;}</style><meta charset="utf-8"><title>Allow arbitrary URLs, expect arbitrary code execution | Positive Security</title><meta content="Insecure URL handling leading to 1-click code execution vulnerabilities in Telegram, Nextcloud (CVE-2021-22879), VLC, LibreOffice (CVE-2021-25631), OpenOffice (CVE-2021-30245), Bitcoin/Dogecoin Wallets, Wireshark (CVE-2021-22191) and Mumble (CVE-2021-27229)." name="description"><meta content="Allow arbitrary URLs, expect arbitrary code execution | Positive Security" property="og:title"><meta content="Insecure URL handling leading to 1-click code execution vulnerabilities in Telegram, Nextcloud (CVE-2021-22879), VLC, LibreOffice (CVE-2021-25631), OpenOffice (CVE-2021-30245), Bitcoin/Dogecoin Wallets, Wireshark (CVE-2021-22191) and Mumble (CVE-2021-27229)." property="og:description"><meta content="https://assets-global.website-files.com/5f6498c074436c349716e747/61dc7f371652096ee90d7223_schemes_white.png" property="og:image"><meta content="Allow arbitrary URLs, expect arbitrary code execution | Positive Security" property="twitter:title"><meta content="Insecure URL handling leading to 1-click code execution vulnerabilities in Telegram, Nextcloud (CVE-2021-22879), VLC, LibreOffice (CVE-2021-25631), OpenOffice (CVE-2021-30245), Bitcoin/Dogecoin Wallets, Wireshark (CVE-2021-22191) and Mumble (CVE-2021-27229)." property="twitter:description"><meta content="https://assets-global.website-files.com/5f6498c074436c349716e747/61dc7f371652096ee90d7223_schemes_white.png" property="twitter:image"><meta property="og:type" content="website"><meta content="summary_large_image" name="twitter:card"><meta content="width=device-width, initial-scale=1" name="viewport"><link href="https://assets-global.website-files.com/5f6498c074436c50c016e745/css/positive-security-staging-72d251d7bb6be.webflow.e6d46c054.css" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com" rel="preconnect"><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous"><script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic" media="all"><script type="text/javascript">WebFont.load({  google: {    families: ["Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic"]  }});</script><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f7ddb13deeceb266b162f8d_favicon-32x32_white.png" rel="shortcut icon" type="image/x-icon"><link href="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f7dd71edeeceb5d47162386_256_256.png" rel="apple-touch-icon"><link href="rss.xml" rel="alternate" title="RSS Feed" type="application/rss+xml"><!-- Cloudflare Web Analytics --><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;678f2da7b07b4b19bc4a7086e8b09ce7&quot;}"></script><!-- End Cloudflare Web Analytics --></head><body><div data-collapse="medium" data-animation="default" data-duration="400" data-w-id="18638a64-158e-82a5-ef35-2151b27a4e25" data-easing="ease" data-easing2="ease" role="banner" class="navigation navbar navbar-2 w-nav" style="transform: translate3d(0px, 0px, 0px) scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg) rotateZ(0deg) skew(0deg); transform-style: preserve-3d;"><div class="navigation-wrap"><div class="menu"><div class="menu-button w-nav-button" style="-webkit-user-select: text;" aria-label="menu" role="button" tabindex="0" aria-controls="w-nav-overlay-0" aria-haspopup="menu" aria-expanded="false"><img src="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436cf0ef16e7ad_menu_icon_flipped.png" width="22" alt="" class="menu-icon"></div><div class="div-block-2"><div data-w-id="8273737f-5eae-c72a-80ef-62133345865f" class="div-block-3"></div><nav role="navigation" class="navigation-items w-nav-menu"><a href="/" class="navigation-item w-nav-link">HOME</a><a href="/about" class="navigation-item w-nav-link">About</a><a href="/services" class="navigation-item w-nav-link">Services</a><a href="/blog" class="navigation-item w-nav-link">Blog</a><a href="/contact" class="navigation-item w-nav-link">Contact</a></nav><div class="div-block-4"></div></div></div></div><a href="/" class="link-block w-inline-block"><img src="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c270016e798_purple.png" loading="lazy" width="67" data-w-id="4e453caa-e370-2d4c-2b58-5d8876e99ccf" alt="" srcset="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c270016e798_purple-p-500.png 500w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c270016e798_purple-p-800.png 800w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c270016e798_purple-p-1080.png 1080w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c270016e798_purple-p-1600.png 1600w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c270016e798_purple.png 2879w" sizes="67px" class="image-8" style="transform: translate3d(0px, 0px, 0px) scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg) rotateZ(0deg) skew(0deg); transform-style: preserve-3d;"></a><div class="w-nav-overlay" data-wf-ignore="" id="w-nav-overlay-0"></div></div><div class="section"><div class="container cc-blog-detail"><div class="blog-detail-header-wrap"><h1>Allow arbitrary URLs, expect arbitrary code execution</h1><div class="columns-3 w-row"><div class="column-3 w-col w-col-6"><div class="label cc-blog-date">April 15, 2021</div></div><div class="column-4 w-col w-col-6"><div class="label cc-blog-date author">By&nbsp;</div><div class="rich-text label author w-richtext"><p><a href="mailto:fabian@positive.security" target="_blank">Fabian&nbsp;Br√§unlein</a>, <a href="mailto:lukas@positive.security" target="_blank">Lukas&nbsp;Euler</a></p></div></div></div><img loading="lazy" alt="" src="" class="image-15 w-dyn-bind-empty"></div><div class="w-embed w-script"><script src="https://cdnjs.cloudflare.com/ajax/libs/postscribe/2.0.8/postscribe.min.js"></script>
<link href="https://s3-us-west-2.amazonaws.com/daily-web/prism.css" rel="stylesheet" type="text/css">
<script src="https://s3-us-west-2.amazonaws.com/daily-web/prism.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.0/showdown.min.js"></script>
<style>
    /* make prism-formatted code block font a little
       smaller than the default
    pre[class*="language-"] {
    font-size: 0.8em;
    line-height: 0.8em; */
    a {
        display: inline;
    }
    code {
        display: inline;
        background-color: #e8e8e8;
        border-radius: 3px;
        padding: .1rem .2rem;
    }
    code[class*='language-'] {
    	  background-color: initial;
        border-radius: initial;
        padding: initial;
    }
    video {
    	  width: 100%;
        height: auto;
    }
    figcaption {
    	  margin-bottom: 2rem;
    }
    ul {
        margin-top: 5px;
        margin-bottom: 5px;
    }
    li {
        margin-top: 5px;
        margin-bottom: 5px;
    }
    ol > li {
        list-style-type: decimal;
    }
    .rich-text p {
        opacity: initial !important;
        margin-bottom: 15px;
    }
    h2 {
        margin-top: 30px;
    }
    h3 {
        margin-top: 30px;
    }
    h4 {
        margin-top: 30px;
    }
    h5 {
        margin-top: 30px;
    }
    h6 {
        margin-top: 30px;
    }
    .zoomed-img {
    	  z-index: 99;
        cursor: zoom-out;
        position: fixed;
        max-width: 95vw;
        max-height: 95vh;
        transform: translate(-50%,-50%);
        left: 50%;
        top: 50%;
		}
    .zoomed-img-container {
			  z-index: 98;
		    cursor: zoom-out;
		    position: fixed;
		    height: 100vh;
		    width: 100vw;
		    top: 0px;
		    left: 0px;
		    background-color: rgba(0, 0, 0, 0.4);
		}
    /*
     CSS for collapsibles
    */
    .accordion > input[type="checkbox"] {
      position: absolute;
      left: -100vw;
    }

    .accordion .collapsible-content {
      overflow-y: hidden;
      height: 0;
      transition: height 0.3s ease;
    }

    .accordion > input[type="checkbox"]:checked ~ .collapsible-content {
      height: auto;
      overflow: visible;
    }

    .accordion label {
      display: block;
      margin-bottom: inherit;
      font-size: inherit;
      line-height: inherit;
      font-weight: inherit;
      letter-spacing: inherit;
      text-transform: inherit;
    }

    /*
     Styling
    */

    .accordion {
      margin-bottom: 1em;
    }

    .accordion > input[type="checkbox"]:checked ~ .collapsible-content {
      padding: 15px;
      border: 1px solid #e8e8e8;
      border-top: 0;
    }

    .accordion .handle {
      margin: 0;
      padding-bottom: 0px;
    }

    .accordion label {
      color: #333;
      cursor: pointer;
      font-weight: normal;
      padding: 15px;
      background: #e8e8e8;
    }

    .accordion label:hover,
    .accordion label:focus {
      background: #d8d8d8;
    }

    .accordion .handle label:before {
      content: "·ê≥";
      display: inline-block;
      margin-right: 10px;
      font-size: .58em;
      line-height: 1.556em;
      vertical-align: middle;
    }

    .accordion > input[type="checkbox"]:checked ~ .handle label:before {
      content: "·êØ";
    }
</style></div><div class="rich-text w-richtext"><p><ul>
<li>We found and reported 1-click code execution vulnerabilities in popular software including <strong>Telegram</strong>, <strong>Nextcloud</strong>, <strong>VLC</strong>, <strong>Libre-/OpenOffice</strong>, <strong>Bitcoin/Dogecoin Wallets</strong>, <strong>Wireshark</strong> and <strong>Mumble</strong></li>
<li>Desktop applications which pass user supplied URLs to be opened by the operating system are frequently vulnerable to <strong>code execution with user interaction</strong></li>
<li>Code execution can be achieved either when a URL pointing to a malicious executable (<code>.desktop</code>, <code>.jar</code>, <code>.exe</code>, ‚Ä¶) hosted on an internet accessible file share (<code>nfs</code>, <code>webdav</code>, <code>smb</code>, ‚Ä¶) is opened, or an additional vulnerability in the opened application‚Äôs URI handler is exploited</li>
<li>Vulnerabilities following this pattern have already been found in other software, with more expected to be revealed going forward</li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>In this post, we show code execution vulnerabilities in numerous desktop applications, all with the same root cause: insufficient validation of user input that is later treated as a URL and opened with the help of the operating system. The required user interaction and exploitation strategy depends on the desktop environment and whether the application was hardened, for instance, with a URI-scheme allow/block list. As an example, here is what exploitation of this issue in Nextcloud (&lt; 3.1.3) on Xubuntu 20.04 looks like:</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/606898a123801ecbb1861d81_nextcloud_rce_xubuntu_nfs_redacted_cropped_2-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606898a123801ecbb1861d81_nextcloud_rce_xubuntu_nfs_redacted_cropped_2-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606898a123801ecbb1861d81_nextcloud_rce_xubuntu_nfs_redacted_cropped_2-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting Nextcloud on Xubuntu</figcaption>
</figure></div><p><p>After explaining the root cause, vulnerable patterns and oddities of different OS‚Äôs and desktop environments, we‚Äôll explore how this vulnerability type can be exploited in various popular desktop applications.</p>
<h4 id="table-of-contents">Table of Contents</h4>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#root-cause-user-supplied-urls-opened-by-the-os">Root cause: user-supplied URLs opened by the OS</a></li>
<li><a href="#finding-vulnerable-features-is-straightforward">Finding vulnerable features is straightforward</a></li>
<li><a href="#operating-systems-and-desktop-environments-have-different-url-opening-behaviors">Operating systems and desktop environments have different URL opening behaviors</a><ul>
<li><a href="#windows-10-19042">Windows 10 19042</a></li>
<li><a href="#xubuntu-2004-xfce">Xubuntu 20.04</a></li>
<li><a href="#other-linux-operating-systems">Other Linux Operating Systems</a> + <a href="#snap">Snap</a></li>
<li><a href="#mac-catalina-10156">Mac (Catalina 10.15.6)</a></li></ul></li>
<li><a href="#vulnerabilities">Vulnerabilities</a><ul>
<li><a href="#nextcloud">Nextcloud</a></li>
<li><a href="#telegram">Telegram</a></li>
<li><a href="#vlc">VLC</a></li>
<li><a href="#open-libreoffice">Open-/LibreOffice</a></li>
<li><a href="#mumble">Mumble</a></li>
<li><a href="#bitcoindogecoin-wallets">Bitcoin/Dogecoin Wallets</a></li>
<li><a href="#wireshark">Wireshark</a></li>
<li><a href="#bonus-vulnerability-winscp">Bonus-Vulnerability: WinSCP</a></li></ul></li>
<li><a href="#systematic-mitigation-requires-contributions-from-os-framework-and-application-maintainers">Systematic mitigation requires contributions from OS, Framework, and Application maintainers</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<h2 id="root-cause-user-supplied-urls-opened-by-the-os">Root cause: user-supplied URLs opened by the OS</h2>
<p>A common way to open files and links from a native desktop application is by passing a URI to the operating system to handle (e.g. to open the default mail application for a <code>mailto:</code> link).</p>
<p>This is done via the following functions/programs:</p>
<ul>
<li>Windows: <code>ShellExecute*</code></li>
<li>Linux: <code>xdg-open</code> (detects desktop environment and calls <code>gio open</code>, <code>gvfs-open</code>, <code>gnome-open</code>, <code>mate-open</code>, <code>exo-open</code> or <code>enlightment_open</code>)</li>
<li>Mac: <code>NSWorkspace#openURL()</code></li>
</ul></p><figure style="max-width:1765pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><a target="_blank" class="w-inline-block"><div><img src="https://assets-global.website-files.com/5f6498c074436c349716e747/606c3f0e0d743a40364867ab_Quick_Overview_URI_handling_white.png" loading="lazy" alt="" style="cursor: zoom-in;"></div></a><figcaption>General URI handling flow overview</figcaption></figure><p><p>When a user-supplied URL is opened in this way without additional checks, this can lead to code execution:</p>
<ul>
<li>By exploiting OS behavior for specific URI schemes and file extensions</li>
<li>By exploiting vulnerabilities in 3rd party application URL handlers (e.g. <a href="http://revuln.com/files/ReVuln_Steam_Browser_Protocol_Insecurity.pdf" target="_blank">this vulnerability in the <code>steam://</code> protocol</a>)</li>
</ul>
<p>Browsers are aware of the potential security implications and disable <code>file://</code>-links as one of the most dangerous URI schemes, as well as at least showing a popup before navigating to other external URLs.</p>
<p>While these additional checks have been implemented over time by security-conscious browser developers, they are missing in many other applications.</p>
<h2 id="finding-vulnerable-features-is-straightforward">Finding vulnerable features is straightforward</h2>
<p>For any given software, check all features where user-supplied values are opened as URLs (e.g. hyperlinks). If the feature, under the hood, uses the OS to handle the opening and allows arbitrary schemes without comprehensive warning messages, there is likely a way to exploit the feature on certain platforms.</p>
<p>We found that QT‚Äôs <code>QDesktopServices::openUrl()</code> function fulfills the first condition and checked popular QT-based open source software for instances where the function is called with insufficiently validated user input. Tools such as <a href="https://searchcode.com/?q=QDesktopServices%3A%3AopenUrl" target="_blank">searchcode allow to easily expand a search across millions of indexed open source projects</a>.</p>
<p>Please note that this behavior and issue is not unique to QT. As another example, Electron‚Äôs <code>shell.openExternal()</code> <a href="https://benjamin-altpeter.de/shell-openexternal-dangers/" target="_blank">has the same behavior</a>, which lead e.g. to an <a href="https://github.com/wireapp/wire-desktop/security/advisories/GHSA-5gpx-9976-ggpm" target="_blank">RCE in the Wire Messenger</a>.</p>
<h2 id="operating-systems-and-desktop-environments-have-different-url-opening-behaviors">Operating systems and desktop environments have different URL opening behaviors</h2>
<p>From our point of view, the ideal URL opening behavior for an OS includes the following characteristics:</p>
<ul>
<li><strong>Does not automatically mount</strong> previously unmounted file shares without a comprehensive user warning as simply mounting an <code>smb</code> share can cause credential leakage</li>
<li><strong>Displays a comprehensive user warning</strong> before opening an executable or risky (i.e. <code>.docm</code>) file from a remote file share</li>
</ul>
<p>The remainder of this section contains a detailed write-up of deviations from this behavior we have observed in different operating systems. If you are not interested in those specifics, you can <a href="#vulnerabilities">skip ahead to the vulnerabilities section</a> where we demo the different vulnerable desktop applications.</p>
<h3 id="windows-10-19042">Windows 10 19042</h3>
<ul>
<li>Executable <code>.jar</code> files do not trigger a warning when they are located on a mounted file share (standard JRE installation required)</li>
<li>UNC paths for all compatible file share protocols cause automatic mounting without a warning:<ul>
<li><code>smb</code>: <code>\\&lt;hostname&gt;\&lt;filename&gt;</code></li>
<li><code>webdav</code>: <code>\\&lt;hostname&gt;\DavWWWRoot\&lt;filename&gt;</code></li>
<li><code>webdavs</code>: <code>\\&lt;hostname&gt;@SSL\DavWWWRoot\&lt;filename&gt;</code></li></ul></li>
<li>Many applications convert file URLs to UNC paths: <code>file://&lt;hostname&gt;/DavWWWRoot/&lt;filename&gt;</code> becomes <code>\\hostname\DavWWWRoot\&lt;filename&gt;</code>, allowing one to bypass client-side checks</li>
<li>When the UNC path points to a file in the root folder of the share, mounting and opening the file is done with a single URL open/click (otherwise, taking two clicks to first mount and then open)</li>
</ul>
<h3 id="xubuntu-2004-xfce">Xubuntu 20.04 (Xfce)</h3>
<ul>
<li>Executing a <code>.desktop</code> file (and therefore running the specified command) does not trigger a warning when it‚Äôs located on a mounted file share and the file has the executable bit set</li>
<li><code>nfs</code> URLs cause automatic mounting without a warning/notification and allow for mounting and execution via a single URL open action</li>
<li><code>dav</code> and <code>davs</code> URLs pointing to the root folder of an unmounted share cause automatic mounting. If the server is modified to return a <code>collection</code> element in the response to the first PROPFIND request to <code>/file</code>, automatic mounting is also done for URLs pointing to specific files on the share</li>
<li><code>dav</code>, <code>davs</code>, <code>ftp</code>, <code>ftps</code> URLs cause automatic mounting without a warning. When the mounting is initiated by a URL pointing to an executable file, a warning message about the unknown origin of that file is shown after mounting. However, even if the execution is canceled by the user, when the same URL is opened again, with the share now already being mounted, the file is executed and no further warning is displayed</li>
<li><code>smb</code> URLs initiate a mounting process which shows a connect dialog (not a security warning) that can be confirmed with one click on the pre-selected confirm button</li>
<li><code>sftp</code> URLs initiate a mounting process which shows the host key confirmation dialog on first connect</li>
</ul>
<h3 id="other-linux-operating-systems">Other Linux Operating Systems</h3>
<p>The exact opening behavior is dependent on the desktop environment and configuration. After quick review, xfce seems to have the most exploitable features:</p>
<ul>
<li><strong>Auto-mounting:</strong> In Kubuntu/KDE (<code>kde-open5</code>), remote files are auto-opened but the remote share is not permanently mounted. When a remote file is opened, it is downloaded and then opened/executed with the default program (but executable-flags are not retained during this download). Ubuntu/GNOME (gio open) does not auto-mount remote shares (‚ÄúThe specified location is not mounted‚Äù), however the contents of already mounted shares can be referenced as local files (<code>file:///var/run/user/&lt;id&gt;/gvfs/...</code>)</li>
<li><strong>File types:</strong> .desktop files are often not parsed/executed, but rather opened in a text editor. Since this was unexpected to many, and meant that there was no on-board way to launch .desktop files from the command line, a bug was filed in 2009 <a href="https://bugs.launchpad.net/ubuntu/+source/glib2.0/+bug/378783" target="_blank">https://bugs.launchpad.net/ubuntu/+source/glib2.0/+bug/378783</a> and many similar discussions can be found on the Internet. In December 2020, the bug was closed with the introduction of a new separate <code>gio launch</code> command. Users that have implemented workarounds, for example, <a href="https://github.com/jceb/dex" target="_blank">by associating <code>.desktop</code> files with <code>dex</code></a> are likely still vulnerable.</li>
</ul>
<h3 id="snap">Snap</h3>
<p>Snap apps are subject to an additional URI scheme allowlist. Initially, this list only contained <code>http</code>, <code>https</code>, <code>mailto</code> and <code>snap</code>, which broke a lot of applications including Google Chrome. Recently <a href="https://github.com/snapcore/snapd/blob/30ef6dd52df387d359afdcd15f96210e6e0a1d71/usersession/userd/launcher.go#L56-L118" target="_blank">more URI schemes were added</a>.</p>
<p>The snap team has the explicit goal to harden <code>xdg-open</code> calls using the following criteria:</p>
<ul>
<li>The scheme is understood and documented in the code</li>
<li>The scheme itself does not cause <code>xdg-open</code> to open files (e.g. <code>file://</code>)</li>
<li>It is verified that the recipient of the url (ie, the callee of <code>xdg-open</code>) won't process file paths or other arguments in a way that can be leveraged to break out of the sandbox (requires understanding how the url can drive the recipient application)</li>
</ul>
<p>From a security perspective, this much appreciated. However, the initial usability decrease was high which probably drove users to overall less constrained .deb packages. Even though more URI schemes were added, many use cases are still broken. As a rather mundane example, we found that <code>ftp://</code>-links are opened (safely in the browser) from the ‚Äúnormal‚Äù Telegram desktop app, but nothing happens in the snap version (‚Äúuser-open error: supplied URL scheme ‚Äúftp‚Äù is not allowed")</p>
<h3 id="mac-catalina-10156">Mac (Catalina 10.15.6)</h3>
<ul>
<li><code>smb</code> URLs open a connect dialog. Confirming the the connection will mount the share and open a Finder (file explorer) view</li>
<li><code>smb</code> URLs to specific files on shares are interpreted as URLs to a share‚Äôs root folder. They trigger another connect dialog even if the real root folder has been mounted already. Confirming that connection adds an additional entry with the name of the referenced file to <code>/Volumes</code></li>
<li>Files on already mounted shares can be referenced via <code>file</code> URLs pointing to <code>/Volumes/&lt;share_name&gt;/&lt;file_name&gt;</code></li>
<li><code>file</code> URLs to specific files open the file with the associated application only for some file types like <code>.txt</code>, and only if the file has been opened manually before (for example by double-clicking in the Finder)</li>
<li>In all other tested cases, <code>file</code> URLs pointing to specific files open up the Finder for the containing folder rather than opening the file</li>
</ul>
<p><strong>Please note:</strong> Besides these different combinations of file share URI schemes and extensions, many more dangers can be introduced with custom URL scheme handlers, independent of the OS. In this blog post, we disclose one such RCE in a 3rd party application that allows for arbitrary code execution without additional user interaction. In an upcoming blog post, we‚Äôll explore a similar vulnerability in a Windows 10 default URI handler.</p></p><figure style="max-width:2047pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><a target="_blank" class="w-inline-block"><div><img src="https://assets-global.website-files.com/5f6498c074436c349716e747/606c448b5beae5f62902730f_URL_Overview.png" loading="lazy" alt="" style="cursor: zoom-in;"></div></a><figcaption>Summary of preconditions, observed behavior and exploitation strategies</figcaption></figure><p><h2 id="vulnerabilities">Vulnerabilities</h2>
<h3 id="nextcloud">Nextcloud</h3>
<p>The Nextcloud Desktop client uses <code>QDesktopServices::openUrl</code> in various places, however, the most interesting case is when the user connects to a Nextcloud server. In this case, the server‚Äôs login page is loaded in a WebView. QT's default behavior is that a click on a link in a WebView does not directly call the OS' handler, so it‚Äôs safe against our attack. However, the Nextcloud code was specifically <a href="https://github.com/nextcloud/desktop/blob/4b985ab3b322d18773c76e1d1afd6cbad3cdbba2/src/gui/wizard/webview.cpp#L226-L232" target="_blank">intercepting those requests and passing them to <code>QDesktopServices::openUrl</code> by overwriting <code>acceptNavigationRequest()</code></a>.</p></p><p><pre class="  language-js"><code class="  language-js">bool ExternalWebEnginePage<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">acceptNavigationRequest</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">const</span> QUrl <span class="token operator">&amp;</span>url<span class="token punctuation">,</span> QWebEnginePage<span class="token punctuation">:</span><span class="token punctuation">:</span>NavigationType type<span class="token punctuation">,</span> bool isMainFrame</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">Q_UNUSED</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">Q_UNUSED</span><span class="token punctuation">(</span>isMainFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        QDesktopServices<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">openUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></p><p><p>Without any filtering on the URI scheme, this gives many possibilities and allows for smooth exploitation without additional confirmation as shown in the video in the Introduction section. The following two videos show an alternative exploit strategy for Xubuntu (using <code>sftp://</code>) and exploitation on Windows in combination with a vulnerable URI handler:</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/606898ad23801e90e5861daa_nextcloud_rce_sftp_xubuntu_redacted_cropped_2-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606898ad23801e90e5861daa_nextcloud_rce_sftp_xubuntu_redacted_cropped_2-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606898ad23801e90e5861daa_nextcloud_rce_sftp_xubuntu_redacted_cropped_2-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Alternative exploitation on Xubuntu via the `sftp://` scheme</figcaption>
</figure>

<figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/60689bd94e5efd8fc40e6915_nextcloud_rce_win_redacted_cropped_3-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/60689bd94e5efd8fc40e6915_nextcloud_rce_win_redacted_cropped_3-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/60689bd94e5efd8fc40e6915_nextcloud_rce_win_redacted_cropped_3-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploitation on Windows, here using a vulnerable URI handling application. Alternatively, a file:// URI pointing to a remote executable/jar file could also be used</figcaption>
</figure></div><p><p>The issue has been fixed by the Nextcloud team by replacing <code>QDesktopServices::openUrl</code> with their utility function <code>Utility::openBrowser</code>, which implements an additional AllowList-check (<code>http</code>/<code>https</code>/<code>oauthtest</code>) before passing it to <code>QDesktopServices::openUrl</code>.</p>
<p><strong>CVE:</strong> CVE-2021-22879<br>
<strong>Patch:</strong> <a href="https://github.com/nextcloud/desktop/pull/2906" target="_blank">Validate sensitive URLs to only allow http(s) schemes</a><br>
<strong>HackerOne report:</strong> <a href="https://hackerone.com/reports/1078002" target="_blank">Nextcloud Desktop Client RCE via malicious URI schemes</a><br>
<strong>Security Advisory:</strong> <a href="https://nextcloud.com/security/advisory/?id=NC-SA-2021-008" target="_blank">https://nextcloud.com/security/advisory/?id=NC-SA-2021-008</a></p>
<h3 id="telegram">Telegram</h3>
<p>The Telegram Desktop Application for Windows/Linux/Mac OS seemed like an interesting target because it‚Äôs based on Qt and passes links directly to <code>QDesktopServices::openUrl</code>.</p>
<p>While Telegram optionally supports End-to-End-encrypted chats, the Desktop Application only supports non-E2E-encrypted chats. In this case, Telegram makes use of their ability to filter the sent URLs.</p>
<p>The Telegram API defines specific <code>MessageEntity</code>s (<a href="https://core.telegram.org/type/MessageEntity" target="_blank">https://core.telegram.org/type/MessageEntity</a>), that have an <code>offset</code>, a <code>length</code> and optional additional parameters. The MessageEntities related to URLs are <a href="https://core.telegram.org/constructor/messageEntityUrl" target="_blank">messageEntityUrl</a> and <a href="https://core.telegram.org/constructor/messageEntityTextUrl" target="_blank">messageEntityTextUrl</a>.</p>
<p>With <code>messageEntityTextUrl</code>, any text can point to any URL (offset and length define which part of the message to underline while the <code>url</code> parameter defines the destination). In this case, the backend performs strict checks on the URL and in many cases returns a ‚Äú400 - Unsupported url protocol‚Äù. We found that for <code>messageEntityUrl</code> items (which have no URL field, so the underlined text is also the link destination), a slightly more relaxed filter list is used that allows the <code>sftp://</code> URI scheme. On Xubuntu, this can be exploited by linking to an executable .desktop file via <code>sftp://</code> (including the username and with an empty password set on the server for minimal interaction):</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6068b58b0b7cdaa7ac6d38e9_telegram_rce_xubuntu_redacted_cropped-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6068b58b0b7cdaa7ac6d38e9_telegram_rce_xubuntu_redacted_cropped-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6068b58b0b7cdaa7ac6d38e9_telegram_rce_xubuntu_redacted_cropped-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploitation on Xubuntu</figcaption>
</figure></div><p><p>In a default Windows installation, there are no applications installed for handling <code>sftp://</code> links. However, our testing machine had WinSCP installed which by default registers itself as <code>sftp://</code> URI handler. <a href="https://winscp.net/eng/index.php" target="_blank">Having been downloaded 150 million times</a>, WinSCP is popular and almost without competition as <code>sftp</code>/<code>scp</code> client for Windows, so we had a quick look to see what‚Äôs possible. Check out <a href="#bonus-vulnerability-winscp">Bonus-Vulnerability: WinSCP</a> below to see the code execution on Windows (with WinSCP installed).</p>
<p>Interestingly, we could trace back the different treatment of <code>sftp://</code> to <a href="https://github.com/telegramdesktop/tdesktop/issues/1201" target="_blank">a Github issue from 2015</a>, where a user observed and reported a seemingly surprising behavior, and the URI scheme was added without an actual use case.</p></p><figure style="max-width:1279pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><a target="_blank" class="w-inline-block"><div><img src="https://assets-global.website-files.com/5f6498c074436c349716e747/60676b12a382c154aba17083_Selection_999(233).png" loading="lazy" alt="" style="cursor: zoom-in;"></div></a><figcaption>sftp link handling introduced in a Telegram GitHub issue from 2015</figcaption></figure><p><p>The issue was reported to Telegram on January 11th, and after several follow-ups, closed via a server-side change on (or slightly before) February 10th.</p>
<h3 id="vlc">VLC</h3>
<p>In the case of VLC, it might not be so obvious that the exploited functionality is opening a URL under the hood. The vulnerable feature is the ‚ÄúShow Containing Folder‚Ä¶‚Äù action in the context menu of a playlist item.</p>
<p>When clicking the item, the path of the containing directory is fetched and opened by <code>QDesktopServices::openUrl</code>. By adding an additional <code>/</code> or <code>/doesnotexist.mp4</code> to a playlist entry‚Äôs URL, ‚ÄúShow Containing Folder‚Ä¶‚Äù can be diverted to open files with the associated default application.</p>
<p>However, before being passed to <code>QDesktopServices::openUrl</code>, the URI is fed through the following functions:</p>
<ul>
<li><code>vlc_uri2path</code>: This VLC function contains <a href="https://code.videolan.org/videolan/vlc/-/blob/2090c051abb8d3b15fd1824c394897eedda63c7f/src/text/url.c#L291" target="_blank">code that looks like it was intended to filter out UNC paths</a>, but the relevant code seems to be unreachable and the function executes succesfully for UNC paths</li>
<li><a href="https://doc.qt.io/qt-5/qurl.html#fromLocalFile" target="_blank"><code>FromLocalFile</code></a>: Returns a QUrl representation of a "local file" string, but maybe suprisingly also support remote files ("This function also accepts paths with a doubled leading slash (or backslash) to indicate a remote file, as in <code>//servername/path/to/file.txt</code>")</li>
<li><a href="https://doc.qt.io/qt-5/qurl.html#isLocalFile" target="_blank"><code>isLocalFile</code></a>: Returns <code>true</code> for any URI starting with <code>file:</code> ("Note that this function considers URLs with hostnames to be local file paths")</li>
</ul>
<p>As all of those functions allow remote <code>file://</code>-paths, this can be exploited on Windows using a malicious playlist file containing a file URL or UNC path pointing to a .jar file on a WebDav share:</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/606abaa50447307a673f4dc9_VLC_Windows_jar_RCE-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606abaa50447307a673f4dc9_VLC_Windows_jar_RCE-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606abaa50447307a673f4dc9_VLC_Windows_jar_RCE-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting VLC on Windows</figcaption>
</figure></div><p><p>Exploitation on Linux is heavily restricted due to the URI scheme limitation. As no remote files can be referenced to force an auto-mount, only already-mounted remote shares (e.g.  where the playlist resides) can be referenced using the special <code>/run/user</code> directory (e.g. <code>file:///run/user/1000/gvfs/sftp:host=&lt;host&gt;,user=&lt;user&gt;</code>)</p>
<p>The issue was mitigated by adding a check to ensure that the opened URI is a directory, preventing the RCE.<br>
<code>vlc_uri2path</code> was not changed. So although the function may appear to have the goal of disallowing remote files, UNC files can still be specified (leading to an NTLM hash leak or potentially other unexpected behavior when <code>vlc_uri2path</code> is used).</p>
<p>We reported the vulnerability to VLC on January 18th, together with 3 patch candidates. One candidate was merged on Feb 08th and the patched version 3.0.13 will presumably be released next week.</p>
<p><strong>Pending Security Advisory:</strong> <a href="https://www.videolan.org/security/sb-vlc3013.html" target="_blank">https://www.videolan.org/security/sb-vlc3013.html</a></p>
<h3 id="open-libreoffice">Open-/LibreOffice</h3>
<p>OpenOffice and LibreOffice allow for Hyperlinks to be embedded in various types of documents, including macro-disabled file types which are frequently shared among untrusted parties. Hyperlinks can be CTRL-clicked, sending them on to a call to <code>ShellExecute</code> on Windows, or <code>xdg-open</code> on Linux. One-click exploits are shown for OpenOffice on Windows and Xubuntu, as well as LibreOffice on Xubuntu:</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e27325e5e3aaad9663f5_OpenOffice_Xubuntu-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e27325e5e3aaad9663f5_OpenOffice_Xubuntu-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e27325e5e3aaad9663f5_OpenOffice_Xubuntu-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting OpenOffice on Xubuntu</figcaption>
</figure>

<figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e28925e5e305919663f8_OpenOffice_Windows-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e28925e5e305919663f8_OpenOffice_Windows-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e28925e5e305919663f8_OpenOffice_Windows-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting OpenOffice on Windows</figcaption>
</figure>

<figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e29b49106c60d8b53779_LibreOffice_Xubuntu-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e29b49106c60d8b53779_LibreOffice_Xubuntu-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e29b49106c60d8b53779_LibreOffice_Xubuntu-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting LibreOffice on Xubuntu</figcaption>
</figure></div><p><p>In the Windows version of LibreOffice, a <a href="https://github.com/LibreOffice/core/blob/5e4c771c0b89452ab55d1ab30dbb1634f15d3775/shell/source/win32/SysShExec.cxx#L340" target="_blank">file extension blacklist</a> aimed at protecting against this type of attack was implemented long before our research. However, we quickly found a way to bypass this blacklist, allowing for 2-click exploitation on Windows, showcasing the unreliability of such an approach.</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e2b4ba47d6cb3f7e0543_LibreOffice_Windows_ext_filter_bypass-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e2b4ba47d6cb3f7e0543_LibreOffice_Windows_ext_filter_bypass-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e2b4ba47d6cb3f7e0543_LibreOffice_Windows_ext_filter_bypass-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Bypassing the LibreOffice file extension blacklist on Windows</figcaption>
</figure></div><p><p>The office suites allow for files with pretty complex content and functionality and are sometimes used in contexts where niche features like <code>ftp</code> hyperlinks in documents are actually expected to work. Therefore, a fully restrictive fix would not be possible without a potentially critical impact on the user experience. As a fix, we suggest displaying a comprehensive warning message to the user before opening any non http(s) hyperlinks. This would match the behavior displayed by the Microsoft Office suite.</p>
<h4 id="openoffice-response">OpenOffice response</h4>
<p><strong>Pending CVE:</strong> CVE-2021-30245<br>
<strong>Pending Patch:</strong> The OpenOffice team is currently working on a fix which addresses the issue on all platforms to be included in the upcoming 4.1.10 release.</p>
<h4 id="libreoffice-response">LibreOffice response</h4>
<p>LibreOffice opted to only <a href="https://github.com/LibreOffice/core/commit/f456c4dacf700e064e112ef068ff7edb04239754#diff-a145690dcc0afd8668d723e0a74793b6f19f358c3c3599b45d887973f333d94e" target="_blank">patch the file extension blacklist bypass for Windows</a>. CVE-2021-25631 was assigned for the blacklist bypass.<br>
Regarding the Xubuntu/xfce exploit, they argued that protecting against the showcased 1-click code execution is not their responsibility as the app developer.<br>
As a result, LibreOffice on Xubuntu is still vulnerable to the exploit shown above, and at the time of writing the team has no intention of publishing a patch to fix the issue.</p>
<h3 id="mumble">Mumble</h3>
<p>The Mumble voice chatting software features a centrally managed public server list which makes it convenient for users to find and connect to servers that have opted in to be listed. In addition to the server name, server operators can provide a URL meant to link to an associated website. When a user chooses the <code>Open Webpage</code> action in the context menu for a publicly listed server, the URL is passed to <code>QDesktopServices::openUrl()</code></p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064d3c5b0d5c4768db268e3_Mumble_Windows-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover"><source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064d3c5b0d5c4768db268e3_Mumble_Windows-transcode.mp4" data-wf-ignore="true"><source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064d3c5b0d5c4768db268e3_Mumble_Windows-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting Mumble on Windows</figcaption>
</figure></div><p><p>In the video, the <code>Open Webpage</code> action is selected twice to first mount the file share and then execute the hosted .jar file. A one-click exploit for windows should have been possible by using a <a href="#windows-10-19042">webdav URL which points to a malicious file in the root folder of the share</a>. We do not have video evidence of that as we discovered this optimization later when the patch was already underway and we did not want to mess around with the public server list anymore.</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064d501bb822c899ffcbb55_Mumble_Xubuntu-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover"><source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064d501bb822c899ffcbb55_Mumble_Xubuntu-transcode.mp4" data-wf-ignore="true"><source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064d501bb822c899ffcbb55_Mumble_Xubuntu-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting Mumble on Xubuntu</figcaption>
</figure></div><p><p>In the above video the user must confirm an OS dialog to connect to the public smb share. One-click RCE should again also be possible here <a href="#xubuntu-2004-xfce">using an nfs share</a>, but we did not create a PoC due to same reasons.</p>
<p>Exploitation in Mumble differs from the other examples here because it does not require specifically targeting the victim to achieve the desired interaction. An attacker could simply flood the public server list with entries enticing users to perform the <code>Open Webpage</code> action and gain widespread code execution (i.e. ‚ÄúFree Mumble server ‚Äì Visit our website to get your own!‚Äù).</p>
<p><strong>CVE:</strong> <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27229" target="_blank">CVE-2021-27229</a><br>
<strong>Patch:</strong> <a href="https://github.com/mumble-voip/mumble/commit/e59ee87abe249f345908c7d568f6879d16bfd648" target="_blank">Restricting allowed schemes to http and https</a></p>
<h3 id="bitcoindogecoin-wallets">Bitcoin/Dogecoin Wallets</h3>
<p>The Bitcoin-Qt client (and any Altcoin using its codebase) allows users to specify the blockchain explorer website they want to use in the GUI settings window by defining a list of URIs (split by ‚Äò|‚Äô). Those entries are then shown in the context menu for a transaction where no validation is performed on the URI scheme, and the URI is opened with its default application:</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/606882419c3b8513337aa30f_btc_win_java_rce_cropped-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606882419c3b8513337aa30f_btc_win_java_rce_cropped-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606882419c3b8513337aa30f_btc_win_java_rce_cropped-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting Bitcoin wallet on Windows</figcaption>
</figure></div><p><p>While some social engineering is required to get the victim to add their malicious URI, in the world of cryptocurrency scams, where users transfer their coins in the hope to receive them back doubled, this is still quite a low bar. Scammers have previously also instructed their victims to run malicious commands in the client‚Äôs RPC console, after which warning messages were added to the console:</p></p><figure style="max-width:1028pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="https://assets-global.website-files.com/5f6498c074436c349716e747/60676f3ede5c8dcf55978aa3_Selection_999(236).png" loading="lazy" alt=""></div><figcaption>Warning message in&nbsp;RPC Console</figcaption></figure><p><p>Adding Blockchain Explorer URLs to the average user should seem less dangerous/more of a normal interaction than pasting code snippets into the RPC console.</p>
<p>The issue was disclosed to Bitcoin Core, Bitcoin Gold, Bitcoin Cash, Bitcoin ABC and Dogecoin on January 18th.</p>
<p><strong>Dogecoin:</strong> <a href="https://github.com/dogecoin/dogecoin/commit/b2211a41393358f496b6977df7336dd8f5fdfd78" target="_blank">Fixed</a> in v1.14.3 (released Feb 28th).<br>
<strong>Bitcoin ABC:</strong> <a href="https://github.com/Bitcoin-ABC/bitcoin-abc/commit/9936d093400b7be6365e828adddcde21218b65d4" target="_blank">Fixed</a> in version 0.22.15 (released March 9th).<br>
<strong>Bitcoin Cash:</strong> <a href="https://gitlab.com/bitcoin-cash-node/bitcoin-cash-node/-/commit/1394a383426a5edf090f2949c70622bb10ae1a3d" target="_blank">Fixed</a> in version 23.0.0 (released April 15th).<br>
<strong>Bitcoin Gold:</strong> Initially responded, that "per the scoring matrix, it does not qualify as a security vulnerability" and closed the report. After sharing this blog post draft, <a href="https://github.com/BTCGPU/BTCGPU/pull/414" target="_blank">a patch was developed and merged into master</a> (but no new version released yet).<br>
<strong>Bitcoin:</strong> No fix planned.</p>
<h3 id="wireshark">Wireshark</h3>
<p>The QT based Wireshark packet analyzer application makes some fields which contain URLs double-clickable. These URLs were simply passed to <code>QDesktopServices::openUrl</code>, allowing for exploitation via malicious capture files or the live capture of maliciously crafted traffic.</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e230b0d5c4488bb2ccd3_Wireshark_Windows-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e230b0d5c4488bb2ccd3_Wireshark_Windows-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e230b0d5c4488bb2ccd3_Wireshark_Windows-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting Wireshark on Windows</figcaption>
</figure>

<figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e245a3e7243f25aab019_Wireshark_Xubuntu-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e245a3e7243f25aab019_Wireshark_Xubuntu-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6064e245a3e7243f25aab019_Wireshark_Xubuntu-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting Wireshark on Xubuntu</figcaption>
</figure></div><p><p><strong>CVE:</strong>  <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22191" target="_blank">CVE-2021-22191</a><br>
<strong>Patch:</strong> <a href="https://gitlab.com/wireshark/wireshark/-/commit/b2c58d020c100958beb59d9e62471efab5c3cc2d#6d973ab1ed4d54d26e69b4c965288a463af4f975" target="_blank">Changing double-click behavior to copy URLs to the clipboard rather than opening them</a></p>
<h3 id="bonus-vulnerability-winscp">Bonus-Vulnerability: WinSCP</h3>
<p>WinSCP is a remote file manager that installs itself to handle many protocols including: <code>sftp://</code>, <code>ftp://</code>, <code>ftps://</code>, <code>ftpes://</code>, <code>scp://</code>, <code>ssh://</code>, <code>dav://</code>, <code>davs://</code>, <code>s3://</code>, <code>winscp-sftp://</code>, <code>winscp-ftp://</code>, ‚Ä¶</p>
<p>While it's expected that e.g. a username can be provided in the URI, the documentation <a href="https://winscp.net/eng/docs/integration_url#save" target="_blank">also mentions WinSCP-specific parameters</a> to save session data, e.g. <code>winscp-sftp://fingerprint=ssh-rsa-xxxxxxxxxxx...=@example.com/;save</code>.</p>
<p>Those parameters are so-called ‚ÄúRaw Settings‚Äù. Exploring the <a href="https://winscp.net/eng/docs/rawsettings" target="_blank">corresponding docs page</a>, there seemed to be a few potentially dangerous parameters. Specifically, when setting <code>ProxyMethod</code> to <code>5</code> (Local) and a command as <code>ProxyTelnetCommand</code>, the provided command is executed immediately when the link is opened.</p>
<p>While the documentation recommends the use of a URI scheme with the <code>winscp</code>-prefix for such commands, it is not required. We can use this to craft a URI that is accepted by Telegram and when opened by a user with WinSCP installed, allows for immediate code execution:</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/6068840a3013aa6c7a062804_telegram_rce_win_cropped_redacted-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6068840a3013aa6c7a062804_telegram_rce_win_cropped_redacted-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/6068840a3013aa6c7a062804_telegram_rce_win_cropped_redacted-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Combining the Telegram and WinSCP vulnerability for a Windows exploit</figcaption>
</figure></div><p><p>The following video shows exploitation from a website:</p></p><div class="w-embed"><figure class="w-richtext-align-fullwidth w-richtext-figure-type-image">
<video preload="none" poster="https://assets-global.website-files.com/5f6498c074436c50c016e745/606883e1af2d3e13f18f7e1b_chrome_link_cropped-poster-00001.jpg" controls="" data-wf-ignore="true" data-object-fit="cover">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606883e1af2d3e13f18f7e1b_chrome_link_cropped-transcode.mp4" data-wf-ignore="true">
<source src="https://assets-global.website-files.com/5f6498c074436c50c016e745/606883e1af2d3e13f18f7e1b_chrome_link_cropped-transcode.webm" data-wf-ignore="true"></video>
<figcaption>Exploiting the WinSCP vulnerability from Google Chrome</figcaption>
</figure></div><p><p>It‚Äôs interesting to note that Chrome is neither showing the full URL nor the application that will be opened.</p>
<p><strong>CVE:</strong> <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-3331" target="_blank">CVE-2021-3331</a><br>
<strong>Patch:</strong> <a href="https://github.com/winscp/winscp/commit/faa96e8144e6925a380f94a97aa382c9427f688d" target="_blank">Prevent loading session settings that can lead to remote code execution from handled URLs</a><br>
‚Äç</p>
<h2 id="systematic-mitigation-requires-contributions-from-os-framework-and-application-maintainers">Systematic mitigation requires contributions from OS, Framework, and Application maintainers</h2>
<p>This issue spans multiple layers in the targeted system‚Äôs application stack, therefore making it easy for the maintainers of any one to shift the blame and avoid taking on the burden of implementing mitigation measures on their end. However, due to the diversity of client systems and their configuration states, it is crucial that every party involved takes on some amount of responsibility and adds their contribution in the form of mitigation measures:</p>
<p><strong>For OS/Desktop environments:</strong></p>
<ul>
<li>Remote shares should not be auto-mounted</li>
<li>Appropriate warning messages should be shown (e.g. when calling <code>xdg-open</code> on a remote <code>.desktop</code> file on Xubuntu)</li>
</ul>
<p><strong>For Frameworks:</strong></p>
<ul>
<li>Parameters should be secure by default (e.g. QT's <code>openURL</code> could only open <code>http</code>/<code>https</code> by default and allow other schemes via extra flags/parameters)</li>
</ul>
<p><strong>For Applications:</strong></p>
<ul>
<li>Applications that let users open external URLs should validate the URLs with a URI scheme allowlist</li>
<li>Applications that register themselves as a URI scheme or file extension handler need to take extra care not to introduce a vulnerability that can then be exploited from numerous other unhardened applications</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>In this post, we have explored URL handling Operating System behavior and application vulnerabilities. While most issues were quickly fixed by the developers, the following applications are still vulnerable as of 2021-04-15:</p>
<ul>
<li><strong>Bitcoin (and Bitcoin Gold) Desktop Clients:</strong> <br>
It is quite surprising and noteworthy to see forks taking the issue more seriously and implementing measures to protect their users which Bitcoin does not</li>
<li><strong>LibreOffice:</strong> <br>
They did not consider it their responsibility to protect against the Xubuntu variant.<br>
Our recommendation to replace the file extension blacklist for Windows with a more robust measure was dismissed, even though we showcased its general unreliability by pointing out missing file extensions, as well as, the (now fixed) bypass we promptly discovered.<br>
Both versions will also stay susceptible to exploitation in case of other vulnerabilities in 3rd party URL handlers (see <a href="#bonus-vulnerability-winscp">the WinSCP vulnerability shown here</a> as an example)</li>
<li><strong>OpenOffice:</strong> <br>
A fix is scheduled to be released in the upcoming 4.1.10 version.<br>
We would like to use this opportunity to remind users that all files from untrusted sources (including non macro enabled documents) should be handled with utmost caution</li>
<li><strong>VLC:</strong><br>
The patched version 3.0.13 was initially scheduled for before April 9th but its release has been postponed. It's now expected for next week</li>
</ul>
<p>The issues were easy to find and we had a high success rate when checking applications for this vulnerability. Therefore, we expect more vulnerabilities of this type to be discovered when looking at other applications or UI frameworks.</p></p></div><div class="rich-text-block-4 followblock w-richtext"><h5>Follow us on Twitter&nbsp;(<a href="https://twitter.com/positive_sec" target="_blank">@positive_sec</a>) to keep up to date with our posts.</h5><p>‚Äç</p></div><div class="w-embed w-script"><script>
    // Highlight code
    const codeStart = "-- CODE ";
    function formatCode(el) {
        // find our magic declaration string. if we don't find it,
        // do nothing
        if (el.innerText.substring(0, codeStart.length) != codeStart) {
            return;
        }
        let match = el.innerText.match(/--\s*CODE\s+(.*)\s*--/),
            classNames, codeEl;
        if (match && match[1]) {
          classNames = match[1].trim();
        } else {
          return;
        }
        // strip off the magic string, everything preceding it, and
        // all leading and trailing whitespace
        let txt = el.innerText.substring(match.index+match[0].length);
        el.innerHTML = '';
        if (classNames.match(/language-markup/)) {
          codeEl = el.appendChild(document.createElement('script'));
          codeEl.type = 'text/plain';
        } else {
          codeEl = el.appendChild(document.createElement('pre')).
                      appendChild(document.createElement('code'));
        }
        codeEl.className = classNames;
        codeEl.innerHTML = txt;
      }

      let snips = document.getElementsByTagName('p');
      Array.from(snips).forEach(formatCode);
      Prism.highlightAll();

      // Markdown
      function markdownToHtml(txt) {
          let converter = new showdown.Converter({
              ghCompatibleHeaderId: true,
              simpleLineBreaks: true,
              headerLevelStart: 2,
              literalMidWordUnderscores: true
          });
          let html = converter.makeHtml(txt);
          // console.log(html);
          return html;
      }

      const markdownStart = "-- MARKDOWN --";
      const markdownStop = "-- /MARKDOWN --";

      function opensMarkdown(el) {
          return el.innerText.substring(0, markdownStart.length) == markdownStart;
      }

      function closesMarkdown(el) {
          return el.innerText.substring(el.innerText.length - markdownStop.length) == markdownStop;
      }

      function getMarkdownStreaks() {
          var streaks = [];
          var currentStreak = [];
          var inMarkdown = false;
          var paragraphs = Array.from(document.getElementsByClassName("w-richtext")[1].children).filter((el) => el.tagName.toLowerCase() == "p");
          paragraphs.forEach((p) => {
            inMarkdown = inMarkdown || opensMarkdown(p);
            if (inMarkdown) {
                if (currentStreak.length == 0) {
                    streaks.push(currentStreak);
                } else if (p.previousElementSibling != currentStreak[currentStreak.length - 1]) {
                    currentStreak = [];
                    streaks.push(currentStreak);
                }
                currentStreak.push(p);
            }
            if (closesMarkdown(p)) {
                currentStreak = [];
                inMarkdown = false;
            }
          });
          return streaks;
      }

      function getCleanInnerText(el) {
          var text = el.innerText;
          if (opensMarkdown(el)) {
              text = text.substring(markdownStart.length);
          }
          if (closesMarkdown(el)) {
              text = text.substring(0, text.length - markdownStop.length);
          }
          // treat &nbsp; as normal space for markdown since the webflow editor does not support leading regular spaces required for nested lists
          return text.replace(new RegExp(String.fromCharCode(160), 'g'), " ");
      }

      function applyMarkdown(markdownStreak) {
          var markdownText = markdownStreak.map((el) => getCleanInnerText(el)).join("\n\n");
          markdownStreak.forEach((el) => {
              if (el == markdownStreak[0]) {
                  el.innerHTML = markdownToHtml(markdownText);
              } else {
                  el.parentElement.removeChild(el);
              }
          });
      }

      getMarkdownStreaks().forEach(applyMarkdown);

      // Zoom images
      const zoomHref = "https://positive.security/#zoom";

      function removeZoomedImg() {
          var img = document.getElementById("zoomed-img-container");
          if (img) {
              img.parentElement.removeChild(img);
          }
      }

      function zoomImg(img) {
          removeZoomedImg();
          var container = document.createElement("div");
          container.className = "zoomed-img-container";
          container.id = "zoomed-img-container";
          var zoomedImg = document.createElement("img");
          zoomedImg.src = img.src;
          zoomedImg.className = "zoomed-img";
          container.appendChild(zoomedImg);
          document.body.appendChild(container);
      }

      document.body.addEventListener('click', removeZoomedImg);
      Array.from(document.getElementsByTagName("img")).filter((img) => img.parentElement.parentElement.href == zoomHref).forEach((img) => {
          img.parentElement.parentElement.removeAttribute("href");
          img.style.cursor = "zoom-in";
          img.addEventListener('click', function (e) {zoomImg(img); e.preventDefault(); e.stopPropagation()});
      });

      // Make external links pop up new tab
      Array.from(document.getElementsByTagName("a")).filter((a) => a.href && new URL(a.href, location.href).host != document.domain).forEach((img) => {
          img.target = "_blank";
      });

      // https://codepen.io/markcaron/pen/RVvmaz
      function setup_collapsibles() {
          var post_elements = Array.from(document.getElementsByClassName("w-richtext")[1].children);
          var collapsibles = [];
          var current_collapsible = null;
          for (var i = 0; i < post_elements.length; i++) {
              var element = post_elements[i];
              console.log(element);
              if (current_collapsible == null) {
                  if (element.children.length > 0 && element.children[0].getAttribute("collapsible-start")) {
                      current_collapsible = {"start": element, "content": []};
                  }
              } else {
                  if (element.children.length > 0 && element.children[0].getAttribute("collapsible-end")) {
                      current_collapsible["end"] = element;
                      collapsibles.push(current_collapsible);
                      current_collapsible = null;
                  } else {
                      current_collapsible["content"].push(element);
                  }
              }
          }
          for (var i = 0; i < collapsibles.length; i++) {
              var collapsible = collapsibles[i];
              collapsible["start"].children[0].classList.add("accordion");
              var label_html = collapsible["start"].children[0].innerHTML;
              collapsible["start"].children[0].innerHTML = `<input type="checkbox" name="collapse" id="c-handle${i}">
                  <h2 class="handle">
                    <label for="c-handle${i}">${label_html}</label>
                  </h2>`;
              var content_div = document.createElement("div");
              content_div.classList.add("collapsible-content");
              collapsible["start"].children[0].appendChild(content_div);
              for (var j = 0; j < collapsible["content"].length; j++) {
                  var content_element = collapsible["content"][j];
                  //content_element.parentElement.removeChild(content_element);
                  content_div.appendChild(content_element);
              }
              collapsible["end"].parentElement.removeChild(collapsible["end"]);
          }
      }

      setup_collapsibles();
  </script></div></div></div><div class="section"><div class="container"><div class="footer-wrap"><a href="/" class="home-link w-inline-block"><img src="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f7ddb13deeceb266b162f8d_favicon-32x32_white.png" width="15" alt="" class="webflow-logo-tiny"><div class="paragraph-tiny">¬© 2023 Positive Security</div></a><a href="/contact#legal" class="home-link w-inline-block"><div class="paragraph-tiny-imprint">Legal disclosure</div></a></div></div></div><img src="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c6cbd16e799_top.png" loading="lazy" width="377" sizes="(max-width: 991px) 100vw, 377px" alt="" srcset="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c6cbd16e799_top-p-500.png 500w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c6cbd16e799_top-p-800.png 800w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c6cbd16e799_top-p-1080.png 1080w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c6cbd16e799_top-p-1600.png 1600w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c6cbd16e799_top-p-2000.png 2000w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c6cbd16e799_top.png 2878w" class="image-3 blob" style="will-change: transform; transform: translate3d(0px, 0px, 0px) scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg) rotateZ(0deg) skew(0deg); transform-style: preserve-3d;"><img src="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c36af16e7a5_bottom.png" loading="lazy" width="374" sizes="(max-width: 479px) 100vw, 374px" alt="" srcset="https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c36af16e7a5_bottom-p-500.png 500w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c36af16e7a5_bottom-p-800.png 800w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c36af16e7a5_bottom-p-1080.png 1080w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c36af16e7a5_bottom-p-1600.png 1600w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c36af16e7a5_bottom-p-2000.png 2000w, https://assets-global.website-files.com/5f6498c074436c50c016e745/5f6498c074436c36af16e7a5_bottom.png 2878w" class="image-4 test" style="will-change: transform; transform: translate3d(0px, 257px, 0px) scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg) rotateZ(0deg) skew(0deg); transform-style: preserve-3d;"><script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=5f6498c074436c50c016e745" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script src="https://assets-global.website-files.com/5f6498c074436c50c016e745/js/webflow.01333f34a.js" type="text/javascript"></script></body></html>