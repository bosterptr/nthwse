<html lang="en" dir="auto"><head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Send()-ing Myself Belated Christmas Gifts - GitHub.com's Environment Variables &amp; GHES Shell | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Earlier this year, in mid-January, you might have come across this security announcement by GitHub.
In this article, I will unveil the shocking story of how I discovered CVE-2024-0200, a deceptively simple, one-liner vulnerability which I initially assessed to likely be of low impact, and how I turned it into one of the most impactful bugs in GitHub‚Äôs bug bounty history.
Spoiler: The vulnerability enabled disclosure of all environment variables of a production container on GitHub.">
<meta name="author" content="Ngo Wei Lin (@Creastery)">
<link rel="canonical" href="https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer="" crossorigin="anonymous" src="/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://starlabs.sg/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://starlabs.sg/logo-white.png">
<link rel="apple-touch-icon" href="https://starlabs.sg/logo-white.png">
<link rel="mask-icon" href="https://starlabs.sg/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0F9M1FRFWQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Send()-ing Myself Belated Christmas Gifts - GitHub.com's Environment Variables &amp; GHES Shell">
<meta property="og:description" content="Earlier this year, in mid-January, you might have come across this security announcement by GitHub.
In this article, I will unveil the shocking story of how I discovered CVE-2024-0200, a deceptively simple, one-liner vulnerability which I initially assessed to likely be of low impact, and how I turned it into one of the most impactful bugs in GitHub‚Äôs bug bounty history.
Spoiler: The vulnerability enabled disclosure of all environment variables of a production container on GitHub.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/"><meta property="og:image" content="https://starlabs.sg/logo-white.png"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2024-05-06T00:00:00+00:00">
<meta property="article:modified_time" content="2024-05-06T00:00:00+00:00"><meta property="og:site_name" content="STAR Labs">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png">
<meta name="twitter:title" content="Send()-ing Myself Belated Christmas Gifts - GitHub.com's Environment Variables &amp; GHES Shell">
<meta name="twitter:description" content="Earlier this year, in mid-January, you might have come across this security announcement by GitHub.
In this article, I will unveil the shocking story of how I discovered CVE-2024-0200, a deceptively simple, one-liner vulnerability which I initially assessed to likely be of low impact, and how I turned it into one of the most impactful bugs in GitHub‚Äôs bug bounty history.
Spoiler: The vulnerability enabled disclosure of all environment variables of a production container on GitHub.">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://starlabs.sg/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Send()-ing Myself Belated Christmas Gifts - GitHub.com's Environment Variables \u0026 GHES Shell",
      "item": "https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Send()-ing Myself Belated Christmas Gifts - GitHub.com's Environment Variables \u0026 GHES Shell",
  "name": "Send()-ing Myself Belated Christmas Gifts - GitHub.com\u0027s Environment Variables \u0026 GHES Shell",
  "description": "Earlier this year, in mid-January, you might have come across this security announcement by GitHub.\nIn this article, I will unveil the shocking story of how I discovered CVE-2024-0200, a deceptively simple, one-liner vulnerability which I initially assessed to likely be of low impact, and how I turned it into one of the most impactful bugs in GitHub\u0026rsquo;s bug bounty history.\nSpoiler: The vulnerability enabled disclosure of all environment variables of a production container on GitHub.",
  "keywords": [
    
  ],
  "articleBody": "Earlier this year, in mid-January, you might have come across this security announcement by GitHub.\nIn this article, I will unveil the shocking story of how I discovered CVE-2024-0200, a deceptively simple, one-liner vulnerability which I initially assessed to likely be of low impact, and how I turned it into one of the most impactful bugs in GitHub‚Äôs bug bounty history.\nSpoiler: The vulnerability enabled disclosure of all environment variables of a production container on GitHub.com, including numerous access keys and secrets. Additionally, this vulnerability can be further escalated to achieve remote code execution (RCE) on GitHub Enterprise Servers (GHES), but not on GitHub.com. More on this later.\nBackstory Back in early December 2023, I was performing some research on GHES. On the day before I went on vacation, I located a potential (but likely minor) bug. Fast-forward to the day after Christmas, I finally found some time to triage and analyse this potential vulnerability. At that point, I still had zero expectations of the potential bug to be this impactful‚Ä¶ until an accident happened.\nA Quick Primer on Ruby Reflections Before I spill the tea, allow me to begin with a brief introduction to Ruby.\nSimilar to JavaScript, almost everything (e.g. booleans, strings, integers) is an Object in Ruby. The Object includes the Kernel module as a mixin, rendering methods in the Kernel module accessible by every Ruby object. Notably, it is possible to do reflection (i.e. indirect method invocation) by using Kernel#send() as such:\nclass HelloWorld def print(*args) puts(\"Hello \" + args.join(' ')) end end obj = HelloWorld.new() obj.print('world') # = 'Hello World' obj.send('print', 'world') # = 'Hello World' As shown above, it is possible to dynamically invoke a method using Kernel#send() to perform reflection on any object. Naturally, this makes it an obvious code sink to search for, since having ability to invoke arbitrary methods on an object can be disastrous. For example, unsafe reflections with 2 controllable arguments can easily lead to arbitrary code execution:\nuser_input1 = 'eval' user_input2 = 'arbitrary Ruby code here' obj.send(user_input1, user_input2) # is equivalent to: obj.send('eval', 'arbitrary Ruby code here') # which is equivalent to: Kernel.eval('arbitrary Ruby code here') # which has the same effect as: eval('arbitrary Ruby code here') # note: because everything is an object, including the current context If you have more than 2 controllable arguments, then it is also trivial to achieve arbitrary code execution by calling send() repeatedly:\nobj.send('send', 'send', 'send', 'send', 'eval', '1+1') # will call:  obj.send('send', 'send', 'send', 'eval', '1+1') # ... obj.send('eval', '1+1') # to finally call: eval('1+1') You can read more about unsafe reflections in Phrack Issue 0x45 by @joernchen or this Ruby security discussion published on Seebug (in Chinese).\nInterestingly enough, I did not come across any discussions on unsafe reflections with only 1 controllable argument in Kernel#send() as shown below:\nuser_input = 'method_name_here' obj.send(user_input) At first glance, it seems rather difficult to escalate impact at all in this scenario. From the list of default methods inherited from Object, I identified the following useful methods:\n# Disclosing filepaths: obj.send('__dir__') # leak resolved absolute path to directory containing current file obj.send('caller') # return execution call stack, and may leak filepaths # Disclosing class name obj.send('class') # Disclosing method names obj.send('__callee__') obj.send('__method__') obj.send('matching_methods') obj.send('methods') # Object#methods() returns list of public and protected methods obj.send('private_methods') obj.send('protected_methods') obj.send('public_methods') obj.send('singleton_methods') # Disclosing variable names obj.send('instance_variables') obj.send('global_variables') obj.send('local_variables') # Stringify variable obj.send('inspect') # calls to_s recursively obj.send('to_s') # string representation of the object # Read from standard input obj.send('gets') obj.send('readline') obj.send('readlines') # Terminates process (please exercise caution) obj.send('abort') obj.send('fail') obj.send('exit') obj.send('exit!') These methods may come in handy when attempting to gather more information on the target, especially when performing blind, unsafe reflections.\nHowever, in the case of GitHub, this won‚Äôt be necessary since we can audit the source code of GHES, which is largely identical to the one deployed on GitHub.com. Now, we are ready to move on to discuss the vulnerability.\nDiscovering the Vulnerability Note: The source code presented below were extracted from GitHub Enterprise Server (GHES) 3.11.0 to pinpoint the root cause of the vulnerability.\nDoing a quick search on the codebase, I found an unvalidated Kernel#send() call in Organizations::Settings::RepositoryItemsComponent found in app/components/organizations/settings/repository_items_component.rb:\n... class Organizations::Settings::RepositoryItemsComponent  ApplicationComponent def initialize(organization:, repositories:, selected_repositories:, current_page:, total_count:, data_url:, aria_id_prefix:, repository_identifier_key: :global_relay_id, form_id: nil) @organization = organization @repositories = repositories @selected_repositories = selected_repositories @show_next_page = current_page * Orgs::RepositoryItemsHelper::PER_PAGE  total_count @data_url = data_url @current_page = current_page @aria_id_prefix = aria_id_prefix @repository_identifier_key = repository_identifier_key # [2] @form_id = form_id end ... def identifier_for(repository) repository.send(@repository_identifier_key) # [1] end ... end At [1], repository.send(@repository_identifier_key) is invoked in the identifier_for() method without any prior input validation on @repository_identifier_key (set at [2]). This allows all methods accessible by the object (including private or protected methods, and any other methods inherited from ancestor classes) to be invoked.\nThe identifier_for() method of the Organizations::Settings::RepositoryItemsComponent class is used in app/components/organizations/settings/repository_items_component.html.erb (the template file to be rendered and returned within the HTTP response body) at [3]:\n%# erblint:counter ButtonComponentMigrationCounter 1 % hidden class=\"css-truncate d-flex flex-items-center width-full\" {@form_id}\" if @form_id.present? % type=\"checkbox\" name=\"repository_ids[]\" value=\"%= identifier_for(repository) %\" # [3] id=\"-\" ... Backtracing further, it can be seen that Organizations::Settings::RepositoryItemsComponent objects are initialised in app/controllers/orgs/actions_settings/repository_items_controller.rb:\nclass Orgs::ActionsSettings::RepositoryItemsController  Orgs::Controller ... def index ... respond_to do |format| format.html do render(Organizations::Settings::RepositoryItemsComponent.new( organization: current_organization, repositories: additional_repositories(selected_repository_ids), selected_repositories: [], current_page: page, total_count: current_organization.repositories.size, data_url: data_url, aria_id_prefix: aria_id_prefix, repository_identifier_key: repository_identifier_key, # [4] form_id: form_id ), layout: false) end end end ... def rid_key params[:rid_key] # [6] end ... def repository_identifier_key return :global_relay_id unless rid_key.present? # [5] rid_key end ... end At [4], the result of the repository_identifier_key() method is passed as the repository_identifier_key keyword argument when initialising the Organizations::Settings::RepositoryItemsComponent object. At [5], in repository_identifier_key(), observe that :global_relay_id is returned only when the return value of rid_key() is absent. Otherwise, the repository_identifier_key() method simply passes on the return value from rid_key() ‚Äì params[:rid_key] (at [6]).\nPutting it all together, the unsafe reflection repository.send(@repository_identifier_key) allows for a ‚Äúzero-argument arbitrary method invocation‚Äù on a Repository object.\nIn Search of Impact This is exactly the same scenario I discussed earlier. Unfortunately, none of the options I shared earlier are applicable in this case ‚Äì the information is likely available to us already, or they do not do anything useful for us at this point. So, how can we escalate the impact further?\nIt is crucial to recognise that we are not limited to methods inherited from Object ‚Äì we can expand the search of candidate methods by looking at methods accessible by a Repository object.\nNext, let‚Äôs refer back to the assumption of having a ‚Äúzero-argument arbitrary method invocation‚Äù. What does that even mean? Can we only invoke methods accepting no arguments at all?\nThe answer is: No. Surprise!\nActually, this is a common misassumption with a pretty straightforward counter-example to disprove it (as shown below):\nclass Test # zero arguments required def zero_arg() end # 1 positional argument required def one_pos_arg(arg1) end # 2 positional arguments required, but second argument has default value def one_pos_arg_one_default_pos_arg(arg1, arg2 = 'default') end # 2 positionals argument required, but both arguments have default values def two_default_pos_args(arg1 = 'default', arg2 = 'default') end # 1 keyword argument (similar to positional argument) required (no default value) def one_keyword_arg(keyword_arg1:) end # 1 keyword argument (has default value) required def one_default_keyword_arg(keyword_arg1: 'default') end # 1 positional (no default value) \u0026 1 keyword argument (has default value) required def one_pos_arg_one_default_keyword_arg(arg1, keyword_arg2: 'default') end end obj = Test.new() obj.send('zero_arg') # = OK obj.send('one_pos_arg') # = in `one_pos_arg': wrong number of arguments (given 0, expected 1) (ArgumentError) obj.send('one_pos_arg_one_default_pos_arg') # = in `one_pos_arg_one_default_pos_arg': wrong number of arguments (given 0, expected 1..2) (ArgumentError) obj.send('two_default_pos_args') # = OK obj.send('one_keyword_arg') # = in `one_keyword_arg`: missing keyword: :keyword_arg1 (ArgumentError) obj.send('one_default_keyword_arg') # = OK obj.send('one_pos_arg_one_default_keyword_arg') # = in `one_pos_arg_one_default_keyword_arg': wrong number of arguments (given 0, expected 1) (ArgumentError) Clearly, we are able to invoke methods requiring arguments just fine ‚Äì so long as they have default values assigned to them!\nWith these two tricks in our bag, we are now ready to start searching for candidate methods‚Ä¶ but how? We can simply grep until we find something useful, but this will be a tedious process. The main Docker image containing the Ruby on Rails application source code contains more than a whopping 100k files (~1.5 GB), so we clearly need a better strategy.\nA simple solution to this complex task is just to drop into a Rails console in a test GHES setup, and use reflection to aid us in our quest:\nrepo = Repository.find(1) # get first repo methods = [ # get names of all methods accessible by Repository object repo.public_methods(), repo.private_methods(), repo.protected_methods(), ].flatten() methods.length() # = 5542 Yes, you read that correctly. I was quite shocked when I saw the output too.\nWhy on earth does the Repository object even have 5542 methods? Well, to be fair, most of it came from autogenerated code by Ruby on Rails, which leverages Ruby metaprogramming to define getters/setter methods on objects.\nLet‚Äôs further reduce the search space by finding methods matching the criteria (i.e. no required positional or keyword arguments that do not have default values). This is because we need to prevent Ruby from throwing ArgumentError due to obvious mismatch of the number of required arguments. Going back to the previous example on the Test class, let‚Äôs examine the arity of the method:\nclass Test # zero arguments required def zero_arg() end # 1 positional argument required def one_pos_arg(arg1) end # 2 positional arguments required, but second argument has default value def one_pos_arg_one_default_pos_arg(arg1, arg2 = 'default') end # 2 positionals argument required, but both arguments have default values def two_default_pos_args(arg1 = 'default', arg2 = 'default') end # 1 keyword argument (similar to positional argument) required (no default value) def one_keyword_arg(keyword_arg1:) end # 1 keyword argument (has default value) required def one_default_keyword_arg(keyword_arg1: 'default') end # 1 positional (no default value) \u0026 1 keyword argument (has default value) required def one_pos_arg_one_default_keyword_arg(arg1, keyword_arg2: 'default') end end obj = Test.new() obj.method('zero_arg').arity() # = 0 obj.method('one_pos_arg').arity() # = 1 obj.method('one_pos_arg_one_default_pos_arg').arity() # = -2 obj.method('two_default_pos_args').arity() # = -1 obj.method('one_keyword_arg').arity() # = 1 obj.method('one_default_keyword_arg').arity() # = -1 obj.method('one_pos_arg_one_default_keyword_arg').arity() # = -2 It appears that only methods with arity of 0 or -1 can be used by us in this case.\nNow, we can filter the list of candidate methods further:\nrepo = Repository.find(1) # get first repo repo_methods = [ # get names of all methods accessible by Repository object repo.public_methods(), repo.private_methods(), repo.protected_methods(), ].flatten() repo_methods.length() # = 5542 candidate_methods = repo_methods.select() do |method_name| [0, -1].include?(repo.method(method_name).arity()) end candidate_methods.length() # = 3595 I guess that is slightly better‚Ä¶? Metaprogramming can be a curse sometimes. üòÖ\nWhile I could further reduce the search space, I didn‚Äôt want to risk having missing out on any potentially useful functions. It is probably a good idea to scan through the output to get a better sensing of what methods are available first before further processing.\nLet‚Äôs dump the location of where the methods are defined:\ncandidate_methods.map!() do |method_name| method = repo.method(method_name) [ method_name, method.arity(), method.source_location() ] end puts(candidate_methods.sort()) The output is a long list of 3595 methods and their location:\n[ [:!, [0, nil]], [:Nn_, [-1, [\"/github/vendor/gems/3.2.2/ruby/3.2.0/gems/fast_gettext-2.2.0/lib/fast_gettext/translation.rb\", 65]]], [:_, [-1, [\"/github/vendor/gems/3.2.2/ruby/3.2.0/gems/gettext_i18n_rails-1.8.1/lib/gettext_i18n_rails/html_safe_translations.rb\", 10]]], [:__callbacks, [0, [\"/github/vendor/gems/3.2.2/ruby/3.2.0/gems/activesupport-7.1.0.alpha.bb4dbd14f8/lib/active_support/callbacks.rb\", 70]]], ... [:xcode_clone_url, [-1, [\"/github/app/helpers/url_helper.rb\", 218]]], [:xcode_project?, [0, [\"/github/packages/repositories/app/models/repository/git_dependency.rb\", 323]]], [:xcode_urls_enabled?, [0, [\"/github/app/helpers/url_helper.rb\", 213]]], [:yield_self, [0, [\"\", 144]]] ] Triaging Candidate Methods I started triaging the list of potentially useful methods, but as I was testing locally, I realised my test GHES installation wasn‚Äôt working correctly somehow and had to be re-installed. At this point, I noticed most of the methods would likely only affect my own organisation repositories, or allow me to leak some information like file paths on the server, which may come in handy in the future.\nI didn‚Äôt really want to waste precious time doing nothing while waiting for the re-installation to complete, so I decided to test it on the production GitHub.com server in my own test organisation given the current potential impact achievable.\nNothing could possibly go wrong, right‚Ä¶? üôà\nWrong. I was completely off the mark. The following response came back shortly after I began testing on the production GitHub.com server, leaving me completely speechless and stunned in disbelief: That‚Äôs ~2MB worth of environment variables belonging to GitHub.com containing a massive list of access keys and secrets within the response body. How did these secrets end up here?!\nGetting the Environment Variables Let‚Äôs examine the Repository::GitDependency module (at packages/repositories/app/models/repository/git_dependency.rb) included by the Repository containing the dangerous method nw_fsck():\nmodule Repository::GitDependency ... def nw_fsck(trust_synced: false) rpc.nw_fsck(trust_synced: trust_synced) end ... end Note: In Ruby, the last evaluated line of any method/block is the implicit return value.\nThis nw_fsck() method is extremely inconspicuous, but holds a wealth of information. To understand why, let‚Äôs examine the GitRPC backend implementation in vendor/gitrpc/lib/gitrpc/backend/nw.rb:\nmodule GitRPC class Backend ... rpc_writer :nw_fsck, output_varies: true def nw_fsck(trust_synced: false) argv = [] argv  \"--connectivity-only\" argv  \"--trust-synced\" if trust_synced spawn_git(\"nw-fsck\", argv) # [7] end ... end end At [7], the return value of the nw_fsck() method is the git process created using the spawn_git() method. The spawn_git() method eventually calls and returns GitRPC::Native#spawn():\n... module GitRPC ... class Native ... def spawn(argv, input = nil, env = {}, options = {}) ... { # Report unhandled signals as failure :ok = !!process.status.success?, # Report the exit status as the signal number if we have it :status = process.status.exitstatus || process.status.termsig, :signaled = process.status.signaled?, :pid = process.status.pid, :out = process.out, :err = process.err, :argv = argv, :env = env, # [8] :path = @path, :options = options, :truncated = truncated, } end ... end end Observe that the value returned by GitRPC::Native.spawn() is a Hash object containing the environment variables passed to the git process at [8]. Digging deeper, the list of environment variables passed to the git process created can be found in vendor/gitrpc/lib/gitrpc/backend.rb:\n... module GitRPC ... class Backend ... def self.environment @environment ||= ENV.to_h.freeze # [10] end ... def native @native ||= GitRPC::Native.new(path, native_env, native_options) end ... def native_env env = GitRPC::Backend.environment.dup # [9] env.merge!(options[:env] || {}) env.merge!(GitRPC.extra_native_env || {}) env[\"GITHUB_TELEMETRY_LOGS_NOOP\"] = \"true\" env[\"GIT_DIR\"] = path env[\"GIT_LITERAL_PATHSPECS\"] = \"1\" env[\"GIT_SOCKSTAT_VAR_via\"] = \"gitrpc\" if options[:info] git_sockstat_var_options.each do |(prefix, sym)| env[\"GIT_SOCKSTAT_VAR_#{sym}\"] = \"#{prefix}#{options[:info][sym]}\" if options[:info][sym] end end if alternates = alternate_object_paths env[\"GIT_ALTERNATE_OBJECT_DIRECTORIES\"] = alternates.join(\":\") end env end ... end end At [9], GitRPC::Backend#native_env() duplicates the environment variable Hash object returned by GitRPC::Backend::environment() at [10], which is basically a copy of all environment variables passed to Rails.\nSince GitRPC::Native#spawn() returns the list of environment variables in a Hash, and Repository::GitDependency#nw_fsck() kindly returns the Hash to us, we are able to disclose all the environment variables passed to Rails!\nThe Actual Impact I inadvertently gained access to a total of 1220 environment variables (~2MB) containing a lot production access keys. I immediately stopped my testing, reached out to folks at GitHub to alerting them of this incident and proceeded to submit a vulnerability report soon after.\nSpecial thanks to Simon Gerst and Jorge Rosillo for their help in getting in contact with someone from the GitHub Security Incident Response Team (SIRT) team so that I could give them an early heads-up notice on this.\nGetting Remote Code Execution (RCE) The following day, I continued further research to see if it is possible to escalate the impact further and achieve remote code execution. Of course, not with the access keys! I didn‚Äôt want to mess with the production GitHub.com environment further, so I continued my research using my new test GHES setup.\nI quickly noticed that the list of environment variables included ENTERPRISE_SESSION_SECRET, which is used for signing marshalled data stored in session cookies:\nAs previously demonstrated in @iblue‚Äôs remote code execution in GitHub Enterprise management console, having knowledge of ENTERPRISE_SESSION_SECRET value allows an attacker to sign arbitrary serialised data.\n Ruby on Rails implements session storage using a cryptographically signed serialized Ruby Hash. This Hash is serialized into a cookie using Marshal.dump and subsequently deserialized using Marshal.load. If an attacker can construct a valid signature, they can create a session cookie that contains arbitrary input passed to Marshal.load. As noted by the Ruby documentation for Marshal.load, this can result in code execution:\n By design, ::load can deserialize almost any class loaded into the Ruby process. In many cases this can lead to remote code execution if the Marshal data is loaded from an untrusted source.\nAs a result, ::load is not suitable as a general purpose serialization format and you should never unmarshal user supplied input or other untrusted data.\n  This is a clear path to obtaining RCE, but there are still a few more hurdles to resolve (which I will discuss another time). However, this environment variable is not set on GitHub.com, so there‚Äôs no quick and easy way to get remote code execution on GitHub.com except to use the access keys (but don‚Äôt do this, please!).\nTo reiterate, this vulnerability can be chained to achieve RCE on GHES, but GitHub.com is not affected.\nExploit Conditions This vulnerability affects GitHub.com and any GitHub Enterprise Server with GitHub Actions enabled. An attacker also needs to have the organisation owner role.\nSuggested Mitigations  Validate the rid_key parameter in the Orgs::ActionsSettings::RepositoryItemsController class against an allowlist to ensure that only intended methods of the Repository class can be invoked. Revoke and regenerate all secrets used in GitHub.com / any GitHub Enterprise Server that may have been compromised. Consider spawning git processes with a minimal set of environment variables required for functioning instead. Currently, a total of 1220 environment variables is being passed to the git process on GitHub.com.  Detection Guidance It is possible to detect the exploitation of this vulnerability by checking the server‚Äôs access logs for all requests made to /orgainzations//settings/actions/repository_items with an abnormal rid_key parameter value set. However, it is worthwhile to note that Rails accepts rid_key parameter supplied within the request body as well.\nTimeline  2023-12-26 Vendor Disclosure 2023-12-26 Initial Vendor Contact 2023-12-26 Hotfixed on Github.com Production Servers 2023-12-28 Sent RCE Report to Vendor 2024-01-16 Vendor Patch \u0026 Announcement Release 2024-05-06 Public Release  Closing Thoughts Regrettably, this vulnerability was discovered and exploited at a really inopportune time (day after Christmas). I want to express my sincere apologies and gratitude to all Hubbers involved and working during the Christmas/New Year festive period, since the amount of work created for the Hubbers as a consequence of this bug report must have been insanely huge. It is, however, incredibly impressive to see them get this vulnerability patched quickly, rotate all secrets (an awfully painful process), as well as running and concluding a full investigation to confirm that this vulnerability had not been exploited in-the-wild previously.\nI hope you have enjoyed reading the whole process on how I managed to exploit this inconspicuous, unsafe reflection bug with limited control and turning it one of the most impactful bugs on GitHub. Thanks for reading!\n",
  "wordCount" : "3159",
  "inLanguage": "en",
  "datePublished": "2024-05-06T00:00:00Z",
  "dateModified": "2024-05-06T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Ngo Wei Lin (@Creastery)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/blog/2024/04-sending-myself-github-com-environment-variables-and-ghes-shell/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>
<body class=" dark" id="top">
<header class="header">
<nav class="nav">
<div class="logo">
<a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
<img src="https://starlabs.sg/logo-white.png" alt="logo" aria-label="logo" height="35"> </a>
<span class="logo-switches">
</span>
</div>
<ul id="menu">
<li>
<a href="https://starlabs.sg/" title="Home">
<span>Home</span>
</a>
</li>
<li>
<a href="https://starlabs.sg/about/" title="About">
<span>About</span>
</a>
</li>
<li>
<a href="https://starlabs.sg/advisories/" title="Advisories">
<span>Advisories</span>
</a>
</li>
<li>
<a href="https://starlabs.sg/blog/" title="Blog">
<span>Blog</span>
</a>
</li>
<li>
<a href="https://starlabs.sg/achievements/" title="Achievements">
<span>Achievements</span>
</a>
</li>
<li>
<a href="https://starlabs.sg/publications/" title="Publications">
<span>Publications</span>
</a>
</li>
<li>
<a href="https://starlabs.sg/search/" title="Search (Alt + /)" accesskey="/">
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class="main">
<article class="post-single">
<header class="post-header">
<div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;¬ª&nbsp;<a href="https://starlabs.sg/blog/">Blogs</a></div>
<h1 class="post-title">
Send()-ing Myself Belated Christmas Gifts - GitHub.com's Environment Variables &amp; GHES Shell
</h1>
<div class="post-meta"><span title="2024-05-06 00:00:00 +0000 UTC">May 6, 2024</span>&nbsp;¬∑&nbsp;15 min&nbsp;¬∑&nbsp;Ngo Wei Lin (@Creastery)
</div>
</header> <div class="toc">
<details>
<summary accesskey="c" title="(Alt + C)">
<span class="details">Table of Contents</span>
</summary>
<div class="inner"><ul>
<li>
<a href="#backstory" aria-label="Backstory">Backstory</a></li>
<li>
<a href="#a-quick-primer-on-ruby-reflections" aria-label="A Quick Primer on Ruby Reflections">A Quick Primer on Ruby Reflections</a></li>
<li>
<a href="#discovering-the-vulnerability" aria-label="Discovering the Vulnerability">Discovering the Vulnerability</a></li>
<li>
<a href="#in-search-of-impact" aria-label="In Search of Impact">In Search of Impact</a></li>
<li>
<a href="#triaging-candidate-methods" aria-label="Triaging Candidate Methods">Triaging Candidate Methods</a></li>
<li>
<a href="#getting-the-environment-variables" aria-label="Getting the Environment Variables">Getting the Environment Variables</a></li>
<li>
<a href="#the-actual-impact" aria-label="The Actual Impact">The Actual Impact</a></li>
<li>
<a href="#getting-remote-code-execution-rce" aria-label="Getting Remote Code Execution (RCE)">Getting Remote Code Execution (RCE)</a></li>
<li>
<a href="#exploit-conditions" aria-label="Exploit Conditions">Exploit Conditions</a></li>
<li>
<a href="#suggested-mitigations" aria-label="Suggested Mitigations">Suggested Mitigations</a></li>
<li>
<a href="#detection-guidance" aria-label="Detection Guidance">Detection Guidance</a></li>
<li>
<a href="#timeline" aria-label="Timeline">Timeline</a></li>
<li>
<a href="#closing-thoughts" aria-label="Closing Thoughts">Closing Thoughts</a>
</li>
</ul>
</div>
</details>
</div>
<div class="post-content"><p>Earlier this year, in mid-January, you might have come across <a href="https://github.blog/2024-01-16-rotating-credentials-for-github-com-and-new-ghes-patches/">this security announcement</a> by GitHub.</p>
<p>In this article, I will unveil the shocking story of how I discovered <a href="https://www.cve.org/CVERecord?id=CVE-2024-0200">CVE-2024-0200</a>, a deceptively simple, one-liner vulnerability which I initially assessed to likely be of low impact, and how I turned it into one of the most impactful bugs in GitHub‚Äôs bug bounty history.</p>
<p><em><strong>Spoiler:</strong> The vulnerability enabled disclosure of <strong>all</strong> environment variables of a production container on <code>GitHub.com</code>, including numerous access keys and secrets. Additionally, this vulnerability can be further escalated to achieve remote code execution (RCE) on GitHub Enterprise Servers (GHES), but not on <code>GitHub.com</code>. More on this later.</em></p>
<h2 id="backstory">Backstory<a hidden="" class="anchor" aria-hidden="true" href="#backstory">#</a></h2>
<p>Back in early December 2023, I was performing some research on GHES. On the day before I went on vacation, I located a potential (but likely minor) bug. Fast-forward to the day after Christmas, I finally found some time to triage and analyse this potential vulnerability. At that point, I still had zero expectations of the potential bug to be <em>this</em> impactful‚Ä¶ until an accident happened.</p>
<h2 id="a-quick-primer-on-ruby-reflections">A Quick Primer on Ruby Reflections<a hidden="" class="anchor" aria-hidden="true" href="#a-quick-primer-on-ruby-reflections">#</a></h2>
<p>Before I spill the tea, allow me to begin with a brief introduction to Ruby.</p>
<p>Similar to JavaScript, almost everything (e.g. booleans, strings, integers) is an <code>Object</code> in Ruby. The <code>Object</code> includes the <code>Kernel</code> module as a mixin, rendering methods in the <code>Kernel</code> module accessible by every Ruby object. Notably, it is possible to do reflection (i.e. indirect method invocation) by using <code>Kernel#send()</code> as such:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="nc"><span class="hljs-class"><span class="hljs-title">HelloWorld</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="o"><span class="hljs-function"><span class="hljs-params">*</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="nb">puts</span><span class="p">(</span><span class="s2"><span class="hljs-string">"Hello "</span></span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1"><span class="hljs-string">' '</span></span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="no">HelloWorld</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1"><span class="hljs-string">'world'</span></span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># =&gt; 'Hello World'</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'print'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'world'</span></span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># =&gt; 'Hello World'</span></span>
</span></span></code></pre></div><p>As shown above, it is possible to dynamically invoke a method using <code>Kernel#send()</code> to perform reflection on any object.
Naturally, this makes it an obvious code sink to search for, since having ability to invoke arbitrary methods on an object can be disastrous. For example, <strong>unsafe reflections with 2 controllable arguments</strong> can easily lead to arbitrary code execution:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="n">user_input1</span> <span class="o">=</span> <span class="s1"><span class="hljs-string">'eval'</span></span>
</span></span><span class="line"><span class="cl"><span class="n">user_input2</span> <span class="o">=</span> <span class="s1"><span class="hljs-string">'arbitrary Ruby code here'</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">user_input1</span><span class="p">,</span> <span class="n">user_input2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># is equivalent to:</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'eval'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'arbitrary Ruby code here'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># which is equivalent to:</span></span>
</span></span><span class="line"><span class="cl"><span class="no">Kernel</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1"><span class="hljs-string">'arbitrary Ruby code here'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># which has the same effect as:</span></span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span><span class="p">(</span><span class="s1"><span class="hljs-string">'arbitrary Ruby code here'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># note: because everything is an object, including the current context</span></span>
</span></span></code></pre></div><p>If you have more than <strong>2 controllable arguments</strong>, then it is also trivial to achieve arbitrary code execution by calling <code>send()</code> repeatedly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'send'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'send'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'send'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'send'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'eval'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'1+1'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># will call: </span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'send'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'send'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'send'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'eval'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'1+1'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># ...</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'eval'</span></span><span class="p">,</span> <span class="s1"><span class="hljs-string">'1+1'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># to finally call:</span></span>
</span></span><span class="line"><span class="cl"><span class="nb">eval</span><span class="p">(</span><span class="s1"><span class="hljs-string">'1+1'</span></span><span class="p">)</span>
</span></span></code></pre></div><p>You can read more about unsafe reflections in <a href="http://phrack.org/issues/69/12.html?#:~:text=2.3.3%20Indirections">Phrack Issue 0x45</a> by <a href="https://twitter.com/joernchen">@joernchen</a> or this <a href="https://paper.seebug.org/1951/">Ruby security discussion published on Seebug</a> (in Chinese).</p>
<p>Interestingly enough, I did not come across any discussions on unsafe reflections with only <strong>1 controllable argument</strong> in <code>Kernel#send()</code> as shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="n">user_input</span> <span class="o">=</span> <span class="s1"><span class="hljs-string">'method_name_here'</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>
</span></span></code></pre></div><p>At first glance, it seems rather difficult to escalate impact at all in this scenario. From the list of default methods inherited from <code>Object</code>, I identified the following useful methods:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># Disclosing filepaths:</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'__dir__'</span></span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># leak resolved absolute path to directory containing current file</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'caller'</span></span><span class="p">)</span>  <span class="c1"><span class="hljs-comment"># return execution call stack, and may leak filepaths</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># Disclosing class name</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'class'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># Disclosing method names</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'__callee__'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'__method__'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'matching_methods'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'methods'</span></span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># Object#methods() returns list of public and protected methods</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'private_methods'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'protected_methods'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'public_methods'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'singleton_methods'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># Disclosing variable names</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'instance_variables'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'global_variables'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'local_variables'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># Stringify variable</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'inspect'</span></span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># calls to_s recursively</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'to_s'</span></span><span class="p">)</span>    <span class="c1"><span class="hljs-comment"># string representation of the object</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># Read from standard input</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'gets'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'readline'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'readlines'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment"># Terminates process (please exercise caution)</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'abort'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'fail'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'exit'</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'exit!'</span></span><span class="p">)</span>
</span></span></code></pre></div><p>These methods may come in handy when attempting to gather more information on the target, especially when performing blind, unsafe reflections.</p>
<p>However, in the case of GitHub, this won‚Äôt be necessary since we can audit the source code of GHES, which is largely identical to the one deployed on <code>GitHub.com</code>. Now, we are ready to move on to discuss the vulnerability.</p>
<h2 id="discovering-the-vulnerability">Discovering the Vulnerability<a hidden="" class="anchor" aria-hidden="true" href="#discovering-the-vulnerability">#</a></h2>
<p><em><strong>Note:</strong> The source code presented below were extracted from <strong>GitHub Enterprise Server (GHES) 3.11.0</strong> to pinpoint the root cause of the vulnerability.</em></p>
<p>Doing a quick search on the codebase, I found an unvalidated <code>Kernel#send()</code> call in <code>Organizations::Settings::RepositoryItemsComponent</code> found in <code>app/components/organizations/settings/repository_items_component.rb</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="nc"><span class="hljs-class"><span class="hljs-title">Organizations</span></span></span><span class="o"><span class="hljs-class"><span class="hljs-title">::</span></span></span><span class="no"><span class="hljs-class"><span class="hljs-title">Settings</span></span></span><span class="o"><span class="hljs-class"><span class="hljs-title">::</span></span></span><span class="no"><span class="hljs-class"><span class="hljs-title">RepositoryItemsComponent</span></span></span><span class="hljs-class"> </span><span class="o"><span class="hljs-class">&lt;</span></span><span class="hljs-class"> </span><span class="no"><span class="hljs-class">ApplicationComponent</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">organization</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">repositories</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">selected_repositories</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">current_page</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">total_count</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">data_url</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">aria_id_prefix</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">repository_identifier_key</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:global_relay_id</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">form_id</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">nil</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="vi">@organization</span> <span class="o">=</span> <span class="n">organization</span>
</span></span><span class="line"><span class="cl">    <span class="vi">@repositories</span> <span class="o">=</span> <span class="n">repositories</span>
</span></span><span class="line"><span class="cl">    <span class="vi">@selected_repositories</span> <span class="o">=</span> <span class="n">selected_repositories</span>
</span></span><span class="line"><span class="cl">    <span class="vi">@show_next_page</span> <span class="o">=</span> <span class="n">current_page</span> <span class="o">*</span> <span class="no">Orgs</span><span class="o">::</span><span class="no">RepositoryItemsHelper</span><span class="o">::</span><span class="no">PER_PAGE</span> <span class="o">&lt;</span> <span class="n">total_count</span>
</span></span><span class="line"><span class="cl">    <span class="vi">@data_url</span> <span class="o">=</span> <span class="n">data_url</span>
</span></span><span class="line"><span class="cl">    <span class="vi">@current_page</span> <span class="o">=</span> <span class="n">current_page</span>
</span></span><span class="line"><span class="cl">    <span class="vi">@aria_id_prefix</span> <span class="o">=</span> <span class="n">aria_id_prefix</span>
</span></span><span class="line"><span class="cl">    <span class="vi">@repository_identifier_key</span> <span class="o">=</span> <span class="n">repository_identifier_key</span> <span class="c1"><span class="hljs-comment"># [2]</span></span>
</span></span><span class="line"><span class="cl">    <span class="vi">@form_id</span> <span class="o">=</span> <span class="n">form_id</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">identifier_for</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">repository</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="n">repository</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="vi">@repository_identifier_key</span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># [1]</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span></code></pre></div><p>At [1], <code>repository.send(@repository_identifier_key)</code> is invoked in the <code>identifier_for()</code> method without any prior input validation on <code>@repository_identifier_key</code> (set at [2]). This allows all methods accessible by the object (including private or protected methods, and any other methods inherited from ancestor classes) to be invoked.</p>
<p>The <code>identifier_for()</code> method of the <code>Organizations::Settings::RepositoryItemsComponent</code> class is used in <code>app/components/organizations/settings/repository_items_component.html.erb</code> (the template file to be rendered and returned within the HTTP response body) at [3]:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="s">%<span class="hljs-comment"># erblint:counter ButtonComponentMigrationCounter 1 %&gt;</span>
</span></span></span><span class="line"><span class="cl"><span class="s">&lt;% @repositories.each <span class="hljs-keyword">do</span> <span class="hljs-params">|repository|</span> %&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">  &lt;li &lt;% <span class="hljs-keyword">unless</span> first_page? %&gt; hidden &lt;% <span class="hljs-keyword">end</span> %&gt; <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">css</span>-<span class="hljs-title">truncate</span> <span class="hljs-title">d</span>-<span class="hljs-title">flex</span> <span class="hljs-title">flex</span>-<span class="hljs-title">items</span>-<span class="hljs-title">center</span> <span class="hljs-title">width</span>-<span class="hljs-title">full</span>"&gt;</span>
</span></span></span><span class="line"><span class="cl"><span class="s">    &lt;input
</span></span></span><span class="line"><span class="cl"><span class="s">      &lt;%= <span class="hljs-string">"form=<span class="hljs-subst">#</span></span></span><span class="p"><span class="hljs-string"><span class="hljs-subst">{</span></span></span><span class="vi"><span class="hljs-string"><span class="hljs-subst">@form_id</span></span></span><span class="p"><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="s2"><span class="hljs-string">"</span> <span class="hljs-keyword">if</span> @form_id.present? %&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">      type=<span class="hljs-string">"</span></span><span class="n"><span class="hljs-string">checkbox</span></span><span class="s2"><span class="hljs-string">"</span> name=<span class="hljs-string">"</span></span><span class="n"><span class="hljs-string">repository_ids</span></span><span class="o"><span class="hljs-string">[]</span></span><span class="s2"><span class="hljs-string">"</span>
</span></span></span><span class="line"><span class="cl"><span class="s2">      value=<span class="hljs-string">"</span></span><span class="o"><span class="hljs-string">&lt;</span></span><span class="s"><span class="hljs-string">%= identifier_for(repository) %&gt;"</span> <span class="hljs-comment"># [3]</span>
</span></span></span><span class="line"><span class="cl"><span class="s">      id=</span><span class="s2"><span class="hljs-string">"&lt;%= @aria_id_prefix %&gt;-&lt;%= repository.id %&gt;"</span></span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span></code></pre></div><p>Backtracing further, it can be seen that <code>Organizations::Settings::RepositoryItemsComponent</code> objects are initialised in <code>app/controllers/orgs/actions_settings/repository_items_controller.rb</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="nc"><span class="hljs-class"><span class="hljs-title">Orgs</span></span></span><span class="o"><span class="hljs-class"><span class="hljs-title">::</span></span></span><span class="no"><span class="hljs-class"><span class="hljs-title">ActionsSettings</span></span></span><span class="o"><span class="hljs-class"><span class="hljs-title">::</span></span></span><span class="no"><span class="hljs-class"><span class="hljs-title">RepositoryItemsController</span></span></span><span class="hljs-class"> </span><span class="o"><span class="hljs-class">&lt;</span></span><span class="hljs-class"> </span><span class="no"><span class="hljs-class">Orgs</span></span><span class="o"><span class="hljs-class">::</span></span><span class="no"><span class="hljs-class">Controller</span></span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">index</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">respond_to</span> <span class="k"><span class="hljs-keyword">do</span></span> <span class="o"><span class="hljs-params">|</span></span><span class="nb"><span class="hljs-params">format</span></span><span class="o"><span class="hljs-params">|</span></span>
</span></span><span class="line"><span class="cl">      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="k"><span class="hljs-keyword">do</span></span>
</span></span><span class="line"><span class="cl">        <span class="n">render</span><span class="p">(</span><span class="no">Organizations</span><span class="o">::</span><span class="no">Settings</span><span class="o">::</span><span class="no">RepositoryItemsComponent</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">organization</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">current_organization</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">repositories</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">additional_repositories</span><span class="p">(</span><span class="n">selected_repository_ids</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">selected_repositories</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="o">[]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">current_page</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">page</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">total_count</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">current_organization</span><span class="o">.</span><span class="n">repositories</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">data_url</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">data_url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">aria_id_prefix</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">aria_id_prefix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">repository_identifier_key</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">repository_identifier_key</span><span class="p">,</span> <span class="c1"><span class="hljs-comment"># [4]</span></span>
</span></span><span class="line"><span class="cl">          <span class="ss"><span class="hljs-symbol">form_id</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">form_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span> <span class="ss"><span class="hljs-symbol">layout</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="kp"><span class="hljs-literal">false</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">rid_key</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span><span class="o">[</span><span class="ss"><span class="hljs-symbol">:rid_key</span></span><span class="o">]</span> <span class="c1"><span class="hljs-comment"># [6]</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">repository_identifier_key</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">return</span></span> <span class="ss"><span class="hljs-symbol">:global_relay_id</span></span> <span class="k"><span class="hljs-keyword">unless</span></span> <span class="n">rid_key</span><span class="o">.</span><span class="n">present?</span> <span class="c1"><span class="hljs-comment"># [5]</span></span>
</span></span><span class="line"><span class="cl">    <span class="n">rid_key</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span></code></pre></div><p>At [4], the result of the <code>repository_identifier_key()</code> method is passed as the <code>repository_identifier_key</code> keyword argument when initialising the <code>Organizations::Settings::RepositoryItemsComponent</code> object. At [5], in <code>repository_identifier_key()</code>, observe that <code>:global_relay_id</code> is returned only when the return value of <code>rid_key()</code> is absent. Otherwise, the <code>repository_identifier_key()</code> method simply passes on the return value from <code>rid_key()</code> ‚Äì <code>params[:rid_key]</code> (at [6]).</p>
<p>Putting it all together, the unsafe reflection <code>repository.send(@repository_identifier_key)</code> allows for a ‚Äúzero-argument arbitrary method invocation‚Äù on a <code>Repository</code> object.</p>
<h2 id="in-search-of-impact">In Search of Impact<a hidden="" class="anchor" aria-hidden="true" href="#in-search-of-impact">#</a></h2>
<p>This is exactly the same scenario I discussed earlier. Unfortunately, none of the options I shared earlier are applicable in this case ‚Äì the information is likely available to us already, or they do not do anything useful for us at this point. So, how can we escalate the impact further?</p>
<p>It is crucial to recognise that we are not limited to methods inherited from <code>Object</code> ‚Äì we can expand the search of candidate methods by looking at methods accessible by a <code>Repository</code> object.</p>
<p>Next, let‚Äôs refer back to the assumption of having a ‚Äúzero-argument arbitrary method invocation‚Äù. What does that even mean? Can we only invoke methods accepting no arguments at all?</p>
<p>The answer is: <strong>No</strong>. Surprise!</p>
<p>Actually, this is a common misassumption with a pretty straightforward counter-example to disprove it (as shown below):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="nc"><span class="hljs-class"><span class="hljs-title">Test</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># zero arguments required</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">zero_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">()</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 1 positional argument required</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_pos_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg1</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 2 positional arguments required, but second argument has default value</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_pos_arg_one_default_pos_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg1</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg2</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 2 positionals argument required, but both arguments have default values</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">two_default_pos_args</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg1</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg2</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 1 keyword argument (similar to positional argument) required (no default value)</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_keyword_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">keyword_arg1</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 1 keyword argument (has default value) required</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_default_keyword_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">keyword_arg1</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 1 positional (no default value) &amp; 1 keyword argument (has default value) required</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_pos_arg_one_default_keyword_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg1</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">keyword_arg2</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span> 
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="no">Test</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'zero_arg'</span></span><span class="p">)</span>                            <span class="c1"><span class="hljs-comment"># =&gt; OK</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_pos_arg'</span></span><span class="p">)</span>                         <span class="c1"><span class="hljs-comment"># =&gt; in `one_pos_arg': wrong number of arguments (given 0, expected 1) (ArgumentError)</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_pos_arg_one_default_pos_arg'</span></span><span class="p">)</span>     <span class="c1"><span class="hljs-comment"># =&gt; in `one_pos_arg_one_default_pos_arg': wrong number of arguments (given 0, expected 1..2) (ArgumentError)</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'two_default_pos_args'</span></span><span class="p">)</span>                <span class="c1"><span class="hljs-comment"># =&gt; OK</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_keyword_arg'</span></span><span class="p">)</span>                     <span class="c1"><span class="hljs-comment"># =&gt; in `one_keyword_arg`: missing keyword: :keyword_arg1 (ArgumentError)</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_default_keyword_arg'</span></span><span class="p">)</span>             <span class="c1"><span class="hljs-comment"># =&gt; OK</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_pos_arg_one_default_keyword_arg'</span></span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># =&gt; in `one_pos_arg_one_default_keyword_arg': wrong number of arguments (given 0, expected 1) (ArgumentError)</span></span>
</span></span></code></pre></div><p>Clearly, we are able to invoke methods requiring arguments just fine ‚Äì so long as they have default values assigned to them!</p>
<p>With these two tricks in our bag, we are now ready to start searching for candidate methods‚Ä¶ but how?
We can simply <code>grep</code> until we find something useful, but this will be a tedious process. The main Docker image containing the Ruby on Rails application source code contains more than a whopping <strong>100k files (~1.5 GB)</strong>, so we clearly need a better strategy.</p>
<p>A simple solution to this complex task is just to drop into a Rails console in a test GHES setup, and use reflection to aid us in our quest:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="n">repo</span> <span class="o">=</span> <span class="no">Repository</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi"><span class="hljs-number">1</span></span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># get first repo</span></span>
</span></span><span class="line"><span class="cl"><span class="nb">methods</span> <span class="o">=</span> <span class="o">[</span> <span class="c1"><span class="hljs-comment"># get names of all methods accessible by Repository object</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">repo</span><span class="o">.</span><span class="n">public_methods</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="n">repo</span><span class="o">.</span><span class="n">private_methods</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="n">repo</span><span class="o">.</span><span class="n">protected_methods</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="o">].</span><span class="n">flatten</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">methods</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="c1"><span class="hljs-comment"># =&gt; 5542</span></span>
</span></span></code></pre></div><p>Yes, you read that correctly. I was quite shocked when I saw the output too.<br>
Why on earth does the <code>Repository</code> object even have <strong>5542</strong> methods? Well, to be fair, most of it came from autogenerated code by Ruby on Rails, which leverages Ruby metaprogramming to define getters/setter methods on objects.</p>
<p>Let‚Äôs further reduce the search space by finding methods matching the criteria (i.e. no required positional or keyword arguments that do not have default values). This is because we need to prevent Ruby from throwing <code>ArgumentError</code> due to obvious mismatch of the number of required arguments. Going back to the previous example on the <code>Test</code> class, let‚Äôs examine the arity of the method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="nc"><span class="hljs-class"><span class="hljs-title">Test</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># zero arguments required</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">zero_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">()</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 1 positional argument required</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_pos_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg1</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 2 positional arguments required, but second argument has default value</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_pos_arg_one_default_pos_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg1</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg2</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 2 positionals argument required, but both arguments have default values</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">two_default_pos_args</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg1</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg2</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 1 keyword argument (similar to positional argument) required (no default value)</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_keyword_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">keyword_arg1</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span>)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 1 keyword argument (has default value) required</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_default_keyword_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">keyword_arg1</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment"># 1 positional (no default value) &amp; 1 keyword argument (has default value) required</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">one_pos_arg_one_default_keyword_arg</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">arg1</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">keyword_arg2</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s1"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'default'</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span> 
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">obj</span> <span class="o">=</span> <span class="no">Test</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="s1"><span class="hljs-string">'zero_arg'</span></span><span class="p">)</span><span class="o">.</span><span class="n">arity</span><span class="p">()</span>                            <span class="c1"><span class="hljs-comment"># =&gt; 0</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_pos_arg'</span></span><span class="p">)</span><span class="o">.</span><span class="n">arity</span><span class="p">()</span>                         <span class="c1"><span class="hljs-comment"># =&gt; 1</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_pos_arg_one_default_pos_arg'</span></span><span class="p">)</span><span class="o">.</span><span class="n">arity</span><span class="p">()</span>     <span class="c1"><span class="hljs-comment"># =&gt; -2</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="s1"><span class="hljs-string">'two_default_pos_args'</span></span><span class="p">)</span><span class="o">.</span><span class="n">arity</span><span class="p">()</span>                <span class="c1"><span class="hljs-comment"># =&gt; -1</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_keyword_arg'</span></span><span class="p">)</span><span class="o">.</span><span class="n">arity</span><span class="p">()</span>                     <span class="c1"><span class="hljs-comment"># =&gt; 1</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_default_keyword_arg'</span></span><span class="p">)</span><span class="o">.</span><span class="n">arity</span><span class="p">()</span>             <span class="c1"><span class="hljs-comment"># =&gt; -1</span></span>
</span></span><span class="line"><span class="cl"><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="s1"><span class="hljs-string">'one_pos_arg_one_default_keyword_arg'</span></span><span class="p">)</span><span class="o">.</span><span class="n">arity</span><span class="p">()</span> <span class="c1"><span class="hljs-comment"># =&gt; -2</span></span>
</span></span></code></pre></div><p>It appears that only methods with arity of <code>0</code> or <code>-1</code> can be used by us in this case.</p>
<p>Now, we can filter the list of candidate methods further:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="n">repo</span> <span class="o">=</span> <span class="no">Repository</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi"><span class="hljs-number">1</span></span><span class="p">)</span>  <span class="c1"><span class="hljs-comment"># get first repo</span></span>
</span></span><span class="line"><span class="cl"><span class="n">repo_methods</span> <span class="o">=</span> <span class="o">[</span>           <span class="c1"><span class="hljs-comment"># get names of all methods accessible by Repository object</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">repo</span><span class="o">.</span><span class="n">public_methods</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="n">repo</span><span class="o">.</span><span class="n">private_methods</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="n">repo</span><span class="o">.</span><span class="n">protected_methods</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="o">].</span><span class="n">flatten</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">repo_methods</span><span class="o">.</span><span class="n">length</span><span class="p">()</span>      <span class="c1"><span class="hljs-comment"># =&gt; 5542</span></span>
</span></span><span class="line"><span class="cl"><span class="n">candidate_methods</span> <span class="o">=</span> <span class="n">repo_methods</span><span class="o">.</span><span class="n">select</span><span class="p">()</span> <span class="k"><span class="hljs-keyword">do</span></span> <span class="o"><span class="hljs-params">|</span></span><span class="n"><span class="hljs-params">method_name</span></span><span class="o"><span class="hljs-params">|</span></span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="mi"><span class="hljs-number">0</span></span><span class="p">,</span> <span class="o">-</span><span class="mi"><span class="hljs-number">1</span></span><span class="o">].</span><span class="n"><span class="hljs-keyword">include</span>?</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span><span class="o">.</span><span class="n">arity</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl"><span class="n">candidate_methods</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="c1"><span class="hljs-comment"># =&gt; 3595</span></span>
</span></span></code></pre></div><p>I guess that is slightly better‚Ä¶? Metaprogramming can be a curse sometimes. üòÖ</p>
<p>While I could further reduce the search space, I didn‚Äôt want to risk having missing out on any potentially useful functions. It is probably a good idea to scan through the output to get a better sensing of what methods are available first before further processing.</p>
<p>Let‚Äôs dump the location of where the methods are defined:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="n">candidate_methods</span><span class="o">.</span><span class="n">map!</span><span class="p">()</span> <span class="k"><span class="hljs-keyword">do</span></span> <span class="o"><span class="hljs-params">|</span></span><span class="n"><span class="hljs-params">method_name</span></span><span class="o"><span class="hljs-params">|</span></span>
</span></span><span class="line"><span class="cl">  <span class="nb">method</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">method_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nb">method</span><span class="o">.</span><span class="n">arity</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="nb">method</span><span class="o">.</span><span class="n">source_location</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl"><span class="nb">puts</span><span class="p">(</span><span class="n">candidate_methods</span><span class="o">.</span><span class="n">sort</span><span class="p">())</span>
</span></span></code></pre></div><p>The output is a long list of 3595 methods and their location:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="o">[</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="p"><span class="hljs-symbol">:</span></span><span class="o">!</span><span class="p">,</span> <span class="o">[</span><span class="mi"><span class="hljs-number">0</span></span><span class="p">,</span> <span class="kp"><span class="hljs-literal">nil</span></span><span class="o">]]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="ss"><span class="hljs-symbol">:Nn_</span></span><span class="p">,</span> <span class="o">[-</span><span class="mi"><span class="hljs-number">1</span></span><span class="p">,</span> <span class="o">[</span><span class="s2"><span class="hljs-string">"/github/vendor/gems/3.2.2/ruby/3.2.0/gems/fast_gettext-2.2.0/lib/fast_gettext/translation.rb"</span></span><span class="p">,</span> <span class="mi"><span class="hljs-number">65</span></span><span class="o">]]]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="ss"><span class="hljs-symbol">:_</span></span><span class="p">,</span> <span class="o">[-</span><span class="mi"><span class="hljs-number">1</span></span><span class="p">,</span> <span class="o">[</span><span class="s2"><span class="hljs-string">"/github/vendor/gems/3.2.2/ruby/3.2.0/gems/gettext_i18n_rails-1.8.1/lib/gettext_i18n_rails/html_safe_translations.rb"</span></span><span class="p">,</span> <span class="mi"><span class="hljs-number">10</span></span><span class="o">]]]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="ss"><span class="hljs-symbol">:__callbacks</span></span><span class="p">,</span> <span class="o">[</span><span class="mi"><span class="hljs-number">0</span></span><span class="p">,</span> <span class="o">[</span><span class="s2"><span class="hljs-string">"/github/vendor/gems/3.2.2/ruby/3.2.0/gems/activesupport-7.1.0.alpha.bb4dbd14f8/lib/active_support/callbacks.rb"</span></span><span class="p">,</span> <span class="mi"><span class="hljs-number">70</span></span><span class="o">]]]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="ss"><span class="hljs-symbol">:xcode_clone_url</span></span><span class="p">,</span> <span class="o">[-</span><span class="mi"><span class="hljs-number">1</span></span><span class="p">,</span> <span class="o">[</span><span class="s2"><span class="hljs-string">"/github/app/helpers/url_helper.rb"</span></span><span class="p">,</span> <span class="mi"><span class="hljs-number">218</span></span><span class="o">]]]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="ss"><span class="hljs-symbol">:xcode_project?</span></span><span class="p">,</span> <span class="o">[</span><span class="mi"><span class="hljs-number">0</span></span><span class="p">,</span> <span class="o">[</span><span class="s2"><span class="hljs-string">"/github/packages/repositories/app/models/repository/git_dependency.rb"</span></span><span class="p">,</span> <span class="mi"><span class="hljs-number">323</span></span><span class="o">]]]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="ss"><span class="hljs-symbol">:xcode_urls_enabled?</span></span><span class="p">,</span> <span class="o">[</span><span class="mi"><span class="hljs-number">0</span></span><span class="p">,</span> <span class="o">[</span><span class="s2"><span class="hljs-string">"/github/app/helpers/url_helper.rb"</span></span><span class="p">,</span> <span class="mi"><span class="hljs-number">213</span></span><span class="o">]]]</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">[</span><span class="ss"><span class="hljs-symbol">:yield_self</span></span><span class="p">,</span> <span class="o">[</span><span class="mi"><span class="hljs-number">0</span></span><span class="p">,</span> <span class="o">[</span><span class="s2"><span class="hljs-string">"&lt;internal:kernel&gt;"</span></span><span class="p">,</span> <span class="mi"><span class="hljs-number">144</span></span><span class="o">]]]</span>
</span></span><span class="line"><span class="cl"><span class="o">]</span>
</span></span></code></pre></div><h2 id="triaging-candidate-methods">Triaging Candidate Methods<a hidden="" class="anchor" aria-hidden="true" href="#triaging-candidate-methods">#</a></h2>
<p>I started triaging the list of potentially useful methods, but as I was testing locally, I realised my test GHES installation wasn‚Äôt working correctly somehow and had to be re-installed. At this point, I noticed most of the methods would likely only affect my own organisation repositories, or allow me to leak some information like file paths on the server, which may come in handy in the future.</p>
<p>I didn‚Äôt really want to waste precious time doing nothing while waiting for the re-installation to complete, so I decided to test it on the production <code>GitHub.com</code> server in my own test organisation given the current potential impact achievable.</p>
<p>Nothing could possibly go wrong, right‚Ä¶? üôà</p>
<p>Wrong. I was completely off the mark. The following response came back shortly after I began testing on the production <code>GitHub.com</code> server, leaving me completely speechless and stunned in disbelief:
<img loading="lazy" src="/blog/2024/images/poc-github-env-vars.png" alt="">
</p>
<p>That‚Äôs <strong>~2MB worth of environment variables</strong> belonging to <code>GitHub.com</code> containing a massive list of access keys and secrets within the response body. How did these secrets end up here?!</p>
<h2 id="getting-the-environment-variables">Getting the Environment Variables<a hidden="" class="anchor" aria-hidden="true" href="#getting-the-environment-variables">#</a></h2>
<p>Let‚Äôs examine the <code>Repository::GitDependency</code> module (at <code>packages/repositories/app/models/repository/git_dependency.rb</code>) included by the <code>Repository</code> containing the dangerous method <code>nw_fsck()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="nn"><span class="hljs-class"><span class="hljs-title">Repository::GitDependency</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">nw_fsck</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">trust_synced</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="n">rpc</span><span class="o">.</span><span class="n">nw_fsck</span><span class="p">(</span><span class="ss"><span class="hljs-symbol">trust_synced</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="n">trust_synced</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span></code></pre></div><p><em><strong>Note:</strong> In Ruby, the last evaluated line of any method/block is the implicit return value.</em></p>
<p>This <code>nw_fsck()</code> method is extremely inconspicuous, but holds a wealth of information. To understand why, let‚Äôs examine the GitRPC backend implementation in <code>vendor/gitrpc/lib/gitrpc/backend/nw.rb</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="nn"><span class="hljs-class"><span class="hljs-title">GitRPC</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="nc"><span class="hljs-class"><span class="hljs-title">Backend</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">rpc_writer</span> <span class="ss"><span class="hljs-symbol">:nw_fsck</span></span><span class="p">,</span> <span class="ss"><span class="hljs-symbol">output_varies</span></span><span class="p"><span class="hljs-symbol">:</span></span> <span class="kp"><span class="hljs-literal">true</span></span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">nw_fsck</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="ss"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">trust_synced</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">)</span></span></span>
</span></span><span class="line"><span class="cl">      <span class="n">argv</span> <span class="o">=</span> <span class="o">[]</span>
</span></span><span class="line"><span class="cl">      <span class="n">argv</span> <span class="o">&lt;&lt;</span> <span class="s2"><span class="hljs-string">"--connectivity-only"</span></span>
</span></span><span class="line"><span class="cl">      <span class="n">argv</span> <span class="o">&lt;&lt;</span> <span class="s2"><span class="hljs-string">"--trust-synced"</span></span> <span class="k"><span class="hljs-keyword">if</span></span> <span class="n">trust_synced</span>
</span></span><span class="line"><span class="cl">      <span class="n">spawn_git</span><span class="p">(</span><span class="s2"><span class="hljs-string">"nw-fsck"</span></span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="c1"><span class="hljs-comment"># [7]</span></span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span></code></pre></div><p>At [7], the return value of the <code>nw_fsck()</code> method is the <code>git</code> process created using the <code>spawn_git()</code> method. The <code>spawn_git()</code> method eventually calls and returns <code>GitRPC::Native#spawn()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="nn"><span class="hljs-class"><span class="hljs-title">GitRPC</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="nc"><span class="hljs-class"><span class="hljs-title">Native</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">spawn</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">argv</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">nil</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">env</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">{},</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="o"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">{})</span></span></span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"><span class="hljs-comment"># Report unhandled signals as failure</span></span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:ok</span></span>        <span class="o">=&gt;</span> <span class="o">!!</span><span class="n">process</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">success?</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1"><span class="hljs-comment"># Report the exit status as the signal number if we have it</span></span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:status</span></span>    <span class="o">=&gt;</span> <span class="n">process</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o"><span class="hljs-params">||</span></span> <span class="n">process</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">termsig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:signaled</span></span>  <span class="o">=&gt;</span> <span class="n">process</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">signaled?</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:pid</span></span>       <span class="o">=&gt;</span> <span class="n">process</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:out</span></span>       <span class="o">=&gt;</span> <span class="n">process</span><span class="o">.</span><span class="n">out</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:err</span></span>       <span class="o">=&gt;</span> <span class="n">process</span><span class="o">.</span><span class="n">err</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:argv</span></span>      <span class="o">=&gt;</span> <span class="n">argv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:env</span></span>       <span class="o">=&gt;</span> <span class="n">env</span><span class="p">,</span> <span class="c1"><span class="hljs-comment"># [8]</span></span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:path</span></span>      <span class="o">=&gt;</span> <span class="vi">@path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:options</span></span>   <span class="o">=&gt;</span> <span class="n">options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="ss"><span class="hljs-symbol">:truncated</span></span> <span class="o">=&gt;</span> <span class="n">truncated</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span></code></pre></div><p>Observe that the value returned by <code>GitRPC::Native.spawn()</code> is a <code>Hash</code> object containing the environment variables passed to the <code>git</code> process at [8]. Digging deeper, the list of environment variables passed to the <code>git</code> process created can be found in <code>vendor/gitrpc/lib/gitrpc/backend.rb</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby hljs" data-lang="ruby"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="nn"><span class="hljs-class"><span class="hljs-title">GitRPC</span></span></span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="nc"><span class="hljs-class"><span class="hljs-title">Backend</span></span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nc"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="o"><span class="hljs-function">.</span></span><span class="nf"><span class="hljs-function"><span class="hljs-title">environment</span></span></span>
</span></span><span class="line"><span class="cl">      <span class="vi">@environment</span> <span class="o"><span class="hljs-params">||</span>=</span> <span class="no">ENV</span><span class="o">.</span><span class="n">to_h</span><span class="o">.</span><span class="n">freeze</span> <span class="c1"><span class="hljs-comment"># [10]</span></span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">native</span></span></span>
</span></span><span class="line"><span class="cl">      <span class="vi">@native</span> <span class="o"><span class="hljs-params">||</span>=</span> <span class="no">GitRPC</span><span class="o">::</span><span class="no">Native</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">native_env</span><span class="p">,</span> <span class="n">native_options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="nf"><span class="hljs-function"><span class="hljs-title">native_env</span></span></span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span> <span class="o">=</span> <span class="no">GitRPC</span><span class="o">::</span><span class="no">Backend</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">dup</span> <span class="c1"><span class="hljs-comment"># [9]</span></span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss"><span class="hljs-symbol">:env</span></span><span class="o">]</span> <span class="o"><span class="hljs-params">||</span></span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="no">GitRPC</span><span class="o">.</span><span class="n">extra_native_env</span> <span class="o"><span class="hljs-params">||</span></span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="o">[</span><span class="s2"><span class="hljs-string">"GITHUB_TELEMETRY_LOGS_NOOP"</span></span><span class="o">]</span> <span class="o">=</span> <span class="s2"><span class="hljs-string">"true"</span></span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="o">[</span><span class="s2"><span class="hljs-string">"GIT_DIR"</span></span><span class="o">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="o">[</span><span class="s2"><span class="hljs-string">"GIT_LITERAL_PATHSPECS"</span></span><span class="o">]</span> <span class="o">=</span> <span class="s2"><span class="hljs-string">"1"</span></span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="o">[</span><span class="s2"><span class="hljs-string">"GIT_SOCKSTAT_VAR_via"</span></span><span class="o">]</span> <span class="o">=</span> <span class="s2"><span class="hljs-string">"gitrpc"</span></span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">if</span></span> <span class="n">options</span><span class="o">[</span><span class="ss"><span class="hljs-symbol">:info</span></span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">git_sockstat_var_options</span><span class="o">.</span><span class="n">each</span> <span class="k"><span class="hljs-keyword">do</span></span> <span class="o"><span class="hljs-params">|</span></span><span class="p"><span class="hljs-params">(</span></span><span class="n"><span class="hljs-params">prefix</span></span><span class="p"><span class="hljs-params">,</span></span><span class="hljs-params"> </span><span class="n"><span class="hljs-params">sym</span></span><span class="p"><span class="hljs-params">)</span></span><span class="o"><span class="hljs-params">|</span></span>
</span></span><span class="line"><span class="cl">          <span class="n">env</span><span class="o">[</span><span class="s2"><span class="hljs-string">"GIT_SOCKSTAT_VAR_</span></span><span class="si"><span class="hljs-string"><span class="hljs-subst">#{</span></span></span><span class="n"><span class="hljs-string"><span class="hljs-subst">sym</span></span></span><span class="si"><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="s2"><span class="hljs-string">"</span></span><span class="o">]</span> <span class="o">=</span> <span class="s2"><span class="hljs-string">"</span></span><span class="si"><span class="hljs-string"><span class="hljs-subst">#{</span></span></span><span class="n"><span class="hljs-string"><span class="hljs-subst">prefix</span></span></span><span class="si"><span class="hljs-string"><span class="hljs-subst">}</span><span class="hljs-subst">#{</span></span></span><span class="n"><span class="hljs-string"><span class="hljs-subst">options</span></span></span><span class="o"><span class="hljs-string"><span class="hljs-subst">[</span></span></span><span class="ss"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-symbol">:info</span></span></span></span><span class="o"><span class="hljs-string"><span class="hljs-subst">][</span></span></span><span class="n"><span class="hljs-string"><span class="hljs-subst">sym</span></span></span><span class="o"><span class="hljs-string"><span class="hljs-subst">]</span></span></span><span class="si"><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="s2"><span class="hljs-string">"</span></span> <span class="k"><span class="hljs-keyword">if</span></span> <span class="n">options</span><span class="o">[</span><span class="ss"><span class="hljs-symbol">:info</span></span><span class="o">][</span><span class="n">sym</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">if</span></span> <span class="n">alternates</span> <span class="o">=</span> <span class="n">alternate_object_paths</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span><span class="o">[</span><span class="s2"><span class="hljs-string">"GIT_ALTERNATE_OBJECT_DIRECTORIES"</span></span><span class="o">]</span> <span class="o">=</span> <span class="n">alternates</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2"><span class="hljs-string">":"</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">end</span></span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">end</span></span>
</span></span></code></pre></div><p>At [9], <code>GitRPC::Backend#native_env()</code> duplicates the environment variable <code>Hash</code> object returned by <code>GitRPC::Backend::environment()</code> at [10], which is basically a copy of <strong>all environment variables passed to Rails</strong>.</p>
<p>Since <code>GitRPC::Native#spawn()</code> returns the list of environment variables in a <code>Hash</code>, and <code>Repository::GitDependency#nw_fsck()</code> kindly returns the <code>Hash</code> to us, we are able to disclose all the environment variables passed to Rails!</p>
<h2 id="the-actual-impact">The Actual Impact<a hidden="" class="anchor" aria-hidden="true" href="#the-actual-impact">#</a></h2>
<p>I inadvertently gained access to a total of <strong>1220 environment variables (~2MB)</strong> containing a lot production access keys. I immediately stopped my testing, reached out to folks at GitHub to alerting them of this incident and proceeded to submit a vulnerability report soon after.</p>
<p>Special thanks to <a href="https://twitter.com/intrigus_">Simon Gerst</a> and <a href="https://twitter.com/jorge_ctf">Jorge Rosillo</a> for their help in getting in contact with someone from the GitHub Security Incident Response Team (SIRT) team so that I could give them an early heads-up notice on this.</p>
<h2 id="getting-remote-code-execution-rce">Getting Remote Code Execution (RCE)<a hidden="" class="anchor" aria-hidden="true" href="#getting-remote-code-execution-rce">#</a></h2>
<p>The following day, I continued further research to see if it is possible to escalate the impact further and achieve remote code execution. Of course, not with the access keys! I didn‚Äôt want to mess with the production <code>GitHub.com</code> environment further, so I continued my research using my new test GHES setup.</p>
<p>I quickly noticed that the list of environment variables included <code>ENTERPRISE_SESSION_SECRET</code>, which is used for signing marshalled data stored in session cookies:</p>
<p>As previously demonstrated in <a href="https://bounty.github.com/researchers/iblue.html">@iblue‚Äôs remote code execution in GitHub Enterprise management console</a>, having knowledge of <code>ENTERPRISE_SESSION_SECRET</code> value allows an attacker to sign arbitrary serialised data.</p>
<blockquote>
<p>Ruby on Rails implements session storage using a cryptographically signed serialized Ruby <code>Hash</code>. This Hash is serialized into a cookie using <code>Marshal.dump</code> and subsequently deserialized using <code>Marshal.load</code>. If an attacker can construct a valid signature, they can create a session cookie that contains arbitrary input passed to <code>Marshal.load</code>. As noted by the <a href="https://ruby-doc.org/core-2.3.0/Marshal.html#method-c-load">Ruby documentation</a> for <code>Marshal.load</code>, this can result in code execution:</p>
<blockquote>
<p>By design, <code>::load</code> can deserialize almost any class loaded into the Ruby process. In many cases this can lead to remote code execution if the Marshal data is loaded from an untrusted source.</p>
<p>As a result, <code>::load</code> is not suitable as a general purpose serialization format and you should never unmarshal user supplied input or other untrusted data.</p>
</blockquote>
</blockquote>
<p>This is a clear path to obtaining RCE, but there are still a few more hurdles to resolve (which I will discuss another time). However, this environment variable is not set on <code>GitHub.com</code>, so there‚Äôs no quick and easy way to get remote code execution on <code>GitHub.com</code> except to use the access keys (but don‚Äôt do this, please!).</p>
<p>To reiterate, this vulnerability can be chained to achieve RCE on GHES, but <code>GitHub.com</code> is not affected.</p>
<h2 id="exploit-conditions">Exploit Conditions<a hidden="" class="anchor" aria-hidden="true" href="#exploit-conditions">#</a></h2>
<p>This vulnerability affects <code>GitHub.com</code> and any GitHub Enterprise Server with GitHub Actions enabled. An attacker also needs to have the organisation owner role.</p>
<h2 id="suggested-mitigations">Suggested Mitigations<a hidden="" class="anchor" aria-hidden="true" href="#suggested-mitigations">#</a></h2>
<ol>
<li>Validate the <code>rid_key</code> parameter in the <code>Orgs::ActionsSettings::RepositoryItemsController</code> class against an allowlist to ensure that only intended methods of the <code>Repository</code> class can be invoked.</li>
<li>Revoke and regenerate all secrets used in <code>GitHub.com</code> / any GitHub Enterprise Server that may have been compromised.</li>
<li>Consider spawning <code>git</code> processes with a minimal set of environment variables required for functioning instead. Currently, a total of <strong>1220 environment variables</strong> is being passed to the <code>git</code> process on <code>GitHub.com</code>.</li>
</ol>
<h2 id="detection-guidance">Detection Guidance<a hidden="" class="anchor" aria-hidden="true" href="#detection-guidance">#</a></h2>
<p>It is possible to detect the exploitation of this vulnerability by checking the server‚Äôs access logs for all requests made to <code>/orgainzations/&lt;organisation_name&gt;/settings/actions/repository_items</code> with an abnormal <code>rid_key</code> parameter value set. However, it is worthwhile to note that Rails accepts <code>rid_key</code> parameter supplied within the request body as well.</p>
<h2 id="timeline">Timeline<a hidden="" class="anchor" aria-hidden="true" href="#timeline">#</a></h2>
<ul>
<li>2023-12-26 Vendor Disclosure</li>
<li>2023-12-26 Initial Vendor Contact</li>
<li>2023-12-26 Hotfixed on <code>Github.com</code> Production Servers</li>
<li>2023-12-28 Sent RCE Report to Vendor</li>
<li>2024-01-16 Vendor Patch &amp; Announcement Release</li>
<li>2024-05-06 Public Release</li>
</ul>
<h2 id="closing-thoughts">Closing Thoughts<a hidden="" class="anchor" aria-hidden="true" href="#closing-thoughts">#</a></h2>
<p>Regrettably, this vulnerability was discovered and exploited at a really inopportune time (day after Christmas). I want to express my sincere apologies and gratitude to all Hubbers involved and working during the Christmas/New Year festive period, since the amount of work created for the Hubbers as a consequence of this bug report must have been insanely huge. It is, however, incredibly impressive to see them get this vulnerability patched quickly, rotate all secrets (an awfully painful process), as well as running and concluding a full investigation to confirm that this vulnerability had not been exploited in-the-wild previously.</p>
<p>I hope you have enjoyed reading the whole process on how I managed to exploit this inconspicuous, unsafe reflection bug with limited control and turning it one of the most impactful bugs on GitHub. Thanks for reading!</p>
</div>
<footer class="post-footer">
<ul class="post-tags">
</ul>
</footer>
</article>
</main>
<footer class="footer">
<span>¬© 2024 <a href="https://starlabs.sg/">STAR Labs</a></span>
<span>
Powered by
<a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &amp;
<a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
</span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
<path d="M12 6H0l6-6z"></path>
</svg>
</a>
<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>


</body></html>