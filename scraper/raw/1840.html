<html lang="en"><head><meta charset="utf-8"><title>Building a Red Team Infrastructure in 2023</title><link rel="icon" href="/favicon.png"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5"><meta name="twitter:card" content="summary"><meta property="og:title" content="Building a Red Team Infrastructure in 2023"><meta name="twitter:title" content="Building a Red Team Infrastructure in 2023"><meta name="description" content="In this blog post an overview of the different components of a red team infrastructure is given. This includes explanations how these work, as well as the comparison of different solutions and their characteristics."><meta property="og:description" content="In this blog post an overview of the different components of a red team infrastructure is given. This includes explanations how these work, as well as the comparison of different solutions and their characteristics."><meta name="twitter:description" content="In this blog post an overview of the different components of a red team infrastructure is given. This includes explanations how these work, as well as the comparison of different solutions and their characteristics."><meta property="og:image" content="https://www.securesystems.de/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_title_image.jpg"><meta name="twitter:image" content="https://www.securesystems.de/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_title_image.jpg"><meta name="twitter:site" content="@sse_gmbh"><meta name="next-head-count" content="13"><link rel="preload" href="/_next/static/css/db9f03050b6afaf5.css" as="style"><link rel="stylesheet" href="/_next/static/css/db9f03050b6afaf5.css" data-n-g=""><link rel="preload" href="/_next/static/css/5674832e1468d24d.css" as="style"><link rel="stylesheet" href="/_next/static/css/5674832e1468d24d.css" data-n-p=""><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-1d1ff18a14e951e5.js" defer=""></script><script src="/_next/static/chunks/framework-92bbbf8e181344ea.js" defer=""></script><script src="/_next/static/chunks/main-8b102e728b2bb7f2.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4520b3a239034a25.js" defer=""></script><script src="/_next/static/chunks/349-4829cc9e50472a70.js" defer=""></script><script src="/_next/static/chunks/973-bb21b4a796c234aa.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bfilename%5D-7fd799114750b5d1.js" defer=""></script><script src="/_next/static/_Ba6vOXc9SzScRkVtmF5c/_buildManifest.js" defer=""></script><script src="/_next/static/_Ba6vOXc9SzScRkVtmF5c/_ssgManifest.js" defer=""></script><link as="script" rel="prefetch" href="/_next/static/chunks/pages/%5B%5B...filename%5D%5D-5aeeef54a3401ae4.js"></head><body><div id="__next" data-reactroot=""><div class="sse-viewport"><header class="sse-fixed-head canvas following-main-margin-top" style="background-color:#000000"><div class="h-full flex flex-col"><div class="sse-head-bar text-white"><div class="z-40 sse-head-brand"><a class="sse-head-logo" href="/"><img src="/images/sse-logo.svg" alt="SSE Logo" title="SSE Logo"></a></div><div class="sse-head-desk-nav hidden md:flex flex-row justify-end items-center"><nav class="flex flex-col md:flex-row gap-4 md:gap-8 xl:gap-16 h-full items-stretch" role="navigation" aria-label="menu"><div class="group md:px-2 lg:px-4 h-full flex flex-col justify-center"><div class="relative uppercase font-medium text-sm border-b-2 border-transparent "><div class="whitespace-nowrap cursor-default sse-text-shadow">Service</div></div><nav class="pointer-events-none opacity-0 group-hover:pointer-events-auto group-hover:opacity-100 transition-opacity ease-in-out delay-150 duration-300 absolute bg-black rounded-xl px-8 py-4 top-32 whitespace-nowrap shadow-sse-white" role="subnavigation" aria-label="menu"><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/defensive-security-services/">Defensive Security</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/offensive-security-services/">Offensive Security</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/training/">Training &amp; Awareness</a></ul></nav></div><div class="group md:px-2 lg:px-4 h-full flex flex-col justify-center"><div class="relative uppercase font-medium text-sm border-b-2 border-transparent hover:border-sse-orange"><a class="whitespace-nowrap cursor-pointer sse-text-shadow" target="_self" href="/engineering-and-contributions/">Contributions</a></div><nav class="pointer-events-none opacity-0 group-hover:pointer-events-auto group-hover:opacity-100 transition-opacity ease-in-out delay-150 duration-300 absolute bg-black rounded-xl px-8 py-4 top-32 whitespace-nowrap shadow-sse-white" role="subnavigation" aria-label="menu"><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/dns-security/">DNS Security</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/connaisseur/">Connaisseur</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/public-suffix-list/">Public Suffix List</a></ul><ul class="flex-col text-white"><a class="pb-2 py-4 uppercase font-medium text-xs hover:text-sse-orange block" target="_self" href="/internet-architecture/">Internet Architecture</a></ul></nav></div><div class="group md:px-2 lg:px-4 h-full flex flex-col justify-center"><div class="relative uppercase font-medium text-sm border-b-2 border-transparent hover:border-sse-orange"><a class="whitespace-nowrap cursor-pointer sse-text-shadow" target="_self" href="/blog/">Blog</a></div></div><div class="group md:px-2 lg:px-4 h-full flex flex-col justify-center"><div class="relative uppercase font-medium text-sm border-b-2 border-transparent hover:border-sse-orange"><a class="whitespace-nowrap cursor-pointer sse-text-shadow" target="_self" href="/about-us/">About Us</a></div></div></nav></div><div class="z-[200] md:hidden text-white flex flex-row justify-end items-center cursor-pointer"><svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 6h16M4 12h16M4 18h16"></path></svg></div></div><div class="transition-opacity ease-in-out delay-150 duration-300 z-10 md:hidden hidden opacity-0 flex-row justify-end items-center"><div class="fixed inset-0 bg-black text-white overflow-y-auto touch-pan-x z-90"><nav class="pt-24 px-8 flex flex-col justify-center items-left text-white min-h-full" role="navigation" aria-label="menu"><div class=""><div class="font-medium text-xl font-serif py-6 hover:text-sse-orange text-white"><div class="whitespace-nowrap text-gray-500">Service</div></div><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/defensive-security-services/">Defensive Security</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/offensive-security-services/">Offensive Security</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/training/">Training &amp; Awareness</a></ul></div><div class=""><div class="font-medium text-xl font-serif py-6 hover:text-sse-orange text-white"><a class="whitespace-nowrap" target="_self" href="/engineering-and-contributions/">Contributions</a></div><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/dns-security/">DNS Security</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/connaisseur/">Connaisseur</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/public-suffix-list/">Public Suffix List</a></ul><ul class="ml-6 flex-col text-white"><a class="font-serif text-base py-4 hover:text-sse-orange block" target="_self" href="/internet-architecture/">Internet Architecture</a></ul></div><div class=""><div class="font-medium text-xl font-serif py-6 hover:text-sse-orange text-white"><a class="whitespace-nowrap" target="_self" href="/blog/">Blog</a></div></div><div class=""><div class="font-medium text-xl font-serif py-6 hover:text-sse-orange text-white"><a class="whitespace-nowrap" target="_self" href="/about-us/">About Us</a></div></div></nav></div></div></div></header><main class="sse-main"><div class="w-full canvas !pb-0 "><div class="border-b border-sse-orange text-sse-orange hover:text-sse-black cursor-pointer"><div class="flex items-center pb-4"><div class="w-8 h-8 mr-4"><svg class="" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg></div><div class=""><a class="text-xs font-medium">Back to the SSE Blog</a></div></div></div></div><div class="canvas" style="background-color:"><div class="grid gap-16 lg:gap-16 grid-cols-1 lg:grid-cols-[minmax(min-content,_1fr)_260px] "><div style="text-align:left"><div class="text-sm md:text-base sse-markdown "><h1>Building a Red Team Infrastructure in 2023</h1>
<h2>Intro</h2>
<p>The infrastructure of a red team engagement might be poetically described as the beating heart of an engagement. It is the central point where everything is connected and runs together. All the data is stored here and when it crashes (or is crashed), it might as well end the whole engagement. This leads to several requirements that have to be met, rooting from different perspectives like functionality, stability, but also security and deception of the blue team.</p>
<p>The topic of building a red team infrastructure is not a new one and although several blog posts on this topic exist [<a href="https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki" target="_blank">1</a>], I tried to let my insights and struggle flow into this post, which will hopefully help you to make better decisions and avoid potential pitfalls.</p>
<p>The following questions are drawing the outline for this blog post:</p>
<ul>
<li>What requirements have to be met?</li>
<li>What are the components a red team infrastructure consists of?</li>
<li>What software can be used?</li>
<li>How are these components set up?</li>
</ul>
<p>In order to answer these, I will first lay out the requirements for the infrastructure, then give an overview of the whole system and zoom in on the different components to give my opinion on these as well as a quick look on the setup of each.</p>
<h2>Requirements</h2>
<p>For a red team exercise not only the requirements of a common infrastructure, like the actual functionality, reliability as well as stability apply, but also another layer of security and obfuscation has to be added to prevent the blue team from detecting the infrastructure on the first day of the phishing campaign. An overview of these requirements can be seen in the graphic below.</p>
<figure class="rehype-figure"><img src="/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_overview_requirements.png" alt="red_team_infrastructure_overview_requirements" title="Overview of requirements"><figcaption>red_team_infrastructure_overview_requirements</figcaption></figure>
<p>These requirements constitute the baseline of the necessary infrastructure components. Of course, you can customize these towards your own needs, but instead of stripping away points, I would rather add more requirements.</p>
<h2>Overview of Components</h2>
<p>So, what are the components that are necessary to satisfy the aforementioned requirements? In the graphic below, the network, including components and connections, is depicted.</p>
<figure class="rehype-figure"><img src="/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_network_overview.png" alt="red_team_infrastructure_network_overview" title="Exemplary network overview"><figcaption>red_team_infrastructure_network_overview</figcaption></figure>
<p>The following components are part the infrastructure:</p>
<ul>
<li><strong>Phishing/Payload Server</strong>: used to create and execute phishing campaigns and store payload code for attacks.</li>
<li><strong>C2-Team-Server</strong>: central communication and steering centre for red team operators.</li>
<li><strong>Redirectors</strong>: for mail, https and dns traffic. Serve as proxies for the traffic and protect core assets.</li>
<li><strong>[Optional] Vaultwarden</strong>: represents a secure data storage solution for the duration of the engagement, e.g. for secrets or gathered credentials.</li>
<li><strong>[Optional] Red ELK</strong>: basically a SOC for red teams, helps to monitor your infrastructure and detect the blue team snooping around your assets.</li>
</ul>
<p>A detailed explanation of each component is given in later paragraphs.</p>
<h3>Network Segregation</h3>
<p>The image also shows the distinction between the internal network and the public internet. As the redirectors have to be accessible via the public internet and camouflage as legit web, dns or mail servers, these of course should have a public IP address.</p>
<p>The core assets like the C2-team-server or the phishing and the payload server should be spun up in a protected or internal network. If that is not possible, it should be at least ensured that the open ports of these machines are only accessible by legitimate users. This can be done via connections restricted to specific IP-addresses or certificates. Furthermore, only necessary ports, e.g. SSH- or VPN-ports should be externally accessible.</p>
<h3>Cloud Providers</h3>
<p>Regarding cloud providers, just go with your preferred one. Personally, for the redirectors we use AWS and as Azure makes the implementation of their apps pretty easy, we used Azure for the Outlook instance. But also CloudFront or Digital Ocean are fine for spinning up instances. More important is to
let the provider know that you are operating a professional red team operation otherwise any cloud provider will deactivate your machines without further notice.</p>
<h2>C2-Infrastructure</h2>
<p>I will start the deep dive into individual components with the C2-infrastructure, which consists of one or more C2-instances and several traffic redirectors.</p>
<h3>C2 Team Server</h3>
<p>The C2-instance serves as the central communication and steering point for red team operators. Implant traffic is controlled from this point and can also be changed from the way it communicates, up to single commands sent to be executed on the target's computer. C2-frameworks also offer a wide range of integrated tools, that help to execute a successful attack.</p>
<p>A critical decision to be made is whether you want to (or rather can) afford a paid C2 or not. For many years Cobalt Strike was the industry-standard for red teams, but during the recent years many other alternatives arose. Open-source frameworks get a more and more popular, especially with threat actors. The reason they were used by threat actors is simple: these C2s are not as widespread as Cobalt Strike or other paid industry standard C2-frameworks and defensive mechanisms often do not catch them as easily, as their behaviour has not been fingerprinted as well. This even went so far, that the first implants generated by Havoc last year were not even caught by Windows Defender.</p>
<p>The following questions might help you with choosing the best solution:</p>
<ul>
<li>Do I want to pay for a C2?</li>
<li>What communication channels do I want?</li>
<li>Do I want a GUI?</li>
<li>Do I need several operators to connect to the C2?</li>
<li>What operating system does the C2 have to run on?</li>
<li>What evasion features do I want?</li>
</ul>
<p>You can also have a look at the <a href="https://www.thec2matrix.com" target="_blank">C2 Matrix</a> but pay attention as some of the information might be not perfectly up to date. Nevertheless, it gives a good overview on the existing C2 frameworks.
When deciding for an open-source framework, always check the latest releases and commits to make sure these are not seriously outdated. And most important, it should go without saying, test and play around with your C2 of choice. If you cannot decide, there is always the option to implement two or more C2s and use these in parallel.</p>
<p>Personally, I decided to give Sliver a go, especially as it is really well maintained, but honestly also as it got hyped a bit at the time I started this experiment. Nevertheless, Sliver did not disappoint. Below I listed my personal advantages and disadvantages for Sliver:</p>
<figure class="rehype-figure"><img src="/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_advantages_disadvantages_sliver.png" alt="red_team_infrastructure_advantages_disadvantages_sliver" title="Sliver C2 advantages and disadvantages"><figcaption>red_team_infrastructure_advantages_disadvantages_sliver</figcaption></figure>
<p>Some of the disadvantages could be easy to solve as it is open-source and everyone can help to improve it.</p>
<h3>C2-Redirectors</h3>
<p>These can be divided into different kinds based on the traffic they redirect, which will be in this blog post: mail traffic (phishing), HTTPS traffic (short term), DNS traffic (long term). An overview of the redirectors relevant for the C2-traffic can be found below. The mail redirector will be covered in a later paragraph.</p>
<figure class="rehype-figure"><img src="/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_c2_redirectors.png" alt="red_team_infrastructure_c2_redirectors" title="C2 traffic redirectors overview"><figcaption>red_team_infrastructure_c2_redirectors</figcaption></figure>
<p>The main tasks of a redirector is to protect the respective core assets and to proxy all the traffic destined for and sent by those instances (here: the C2-team server(s)). If a beacon's traffic is discovered by the target's blue team, only the IP or domain of the redirector is lost. In that case just the redirector has to be exchanged, maybe there is even a backup redirector in place. Consequently, only the traffic has to be rerouted to another redirector instead of having to set up the whole infrastructure again. The two different traffic channels for the C2 exist for reasons of redundancy. Should the HTTPS-channel be discovered, there still is the DNS-channel available. DNS traffic is not monitored in many companies and therefore often flies under the radar.</p>
<p>Please note, that if another kind of protocol for the implant communication is used, another redirector is necessary.</p>
<h3>HTTPS Redirector</h3>
<p>Two kinds of approaches exist for a redirector for HTTPS traffic. Traffic can be redirected via a simple pipe or via a reverse web proxy. The first option, achieved via socat or an IP tables rule, blindly forwards traffic arriving at a certain port. This basically describes the functionality one would expect from a redirector. In contrast, a reverse web proxy adds the possibility to filter out unwanted visitors based on factors like geolocation or user agent. It enables you to route the implant traffic to your C2-server and show all other visitors a common web site. This principle is also shown in the picture below.</p>
<figure class="rehype-figure"><img src="/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_redirector_flow.png" alt="red_team_infrastructure_redirector_flow" title="Redirector traffic flow"><figcaption>red_team_infrastructure_redirector_flow</figcaption></figure>
<p>It can be seen that a marker on every request reaching the redirector is evaluated. Based on the outcome of that evaluation, if the request is categorized as a valid request coming from the implant, it is forwarded to the C2 server. Otherwise, the request is forwarded to a web server containing an ordinary web page or an error code.</p>
<h4>Software Options</h4>
<p>Regarding the proxy software, three main options exist: Apache, Nginx or Caddy. All of these are open-source applications. Of course, you can also use another web server if it fulfils the previously mentioned criteria.</p>
<p>Apache and Nginx are well-known options and lots of tutorials for the setup are available. They function almost out of the box and have lots of modules to block unwanted guests or IPs based on the regarding geolocation. Also, as these are widely used, they do not stand out in terms of the product itself.</p>
<p>A lesser known and used option is <a href="https://github.com/caddyserver/caddy" target="_blank">Caddy</a>. I have not tried it yet, but it promises an easy setup with automated HTTPS support (via ZeroSSL or Let's Encrypt) for public domains. A big plus is also that you only need a single file called "Caddyfile", which handles all settings. It is written in Go and does not have any further dependencies. It has also been demonstrated that Caddy can be specifically used as a redirector for C2-traffic [<a href="https://medium.com/geekculture/an-nginx-apache-alternative-for-c2-redirecting-61e92a917101" target="_blank">2</a>].</p>
<h4>Setup/Hardening Process</h4>
<p>The correct setup and hardening of the redirectors are crucial processes. If done correctly the redirector will look like a common web site. If not, the blue team will catch you sooner than you think.</p>
<p>First of all, all traffic to and from the redirector should be encrypted via HTTPS. Otherwise, the SOC will easily pick up your implant, as all transmitted data can be read. From an OPSEC-perspective you do not want to have an unencrypted connection into a client's network, as anyone could eavesdrop on the traffic. Plus, unencrypted traffic always stands out as it could be an indicator for suspicious activity.</p>
<p>Which leads to the next point: do not use self-signed certificates. An easy way to generate valid certificates is using Let's Encrypt and getting automatically generated certificates for your domain. You can either generate the certificate yourself or use <a href="https://certbot.eff.org/" target="_blank">Certbot</a>, which opens a web server on port 80 of your IP (to make sure you legally own the domain) and does all the work. If you are running another service (e.g. Nginx) on port 80, this service should be stopped for the time Certbot is running.
As the certificates from Let's Encrypt are free, a lot of people use them - this includes loads of suspicious actors and scammers. Consequently, if you have the budget available, buy some certificates from any other certificate authority (honestly, it does not matter from which one).</p>
<p>Speaking of issuing certificates to a domain: your redirector should have a domain, as connections to IP-addresses are pretty suspicious. Choose a domain name based on your OSINT-results. Ideas would be anything infrastructure related, campaigns/promotions related to special events like Christmas or even a domain with the target's name and a well-hidden typo in it.</p>
<p>If you have the time, you should definitely create a simple, but convincing web site. This will critically add to the site's credibility and help to conceal the real purpose of the web server (to tunnel implant traffic).</p>
<p>Off to more specific settings to block unwanted visitors. As scanner bots often use specific user agents, it is rather simple to map unwanted strings in user agents to a rule that either responds with an error code or forwards the visitor to another website (like <a href="https://www.google.com" target="_blank">google.com</a>).</p>
<p>The most crucial part is to hide the implant traffic to the C2. This is commonly done by making the implant query a specific directory or file on the webserver. The webserver then forwards all traffic to the C2 server.</p>
<p>To only get desired traffic reaching the C2 server, a restriction-layer based on multiple factors (like user agent, IP address or domain if available) and responding with an error code for queries not matching the required pattern is implemented.</p>
<p>In this example I chose Nginx as a redirector, so the following paragraphs are tailored towards it. Nevertheless, similar functions do exist in Apache or Caddy.</p>
<p>For Nginx you can set the <code>proxy_pass</code> attribute when a certain location is requested. As a restriction, based on the requested location could be detected easily, another factor is needed. In this example, it will be the user agent. The following snippet is from Nginx's <code>default.conf</code>.</p>
<pre><code># map useragents to proxypasses
map $http_user_agent $goodagent {                                                                                                                                        
    default 0;           
    "Supersecretuseragent" 1;
}

[...]

server {

[...]

# C2 route
  location /supersecretlocation/ {
      proxy_ssl_certificate /etc/nginx/https-cert.pem;
      proxy_ssl_certificate_key /etc/nginx/https-key.pem;
      proxy_ssl_verify off;
      proxy_ssl_server_name      on;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass https://localhost:5443;
      if ($goodagent = 0) {
      return 404;
	}
  }
 } 
</code></pre>
<p>In a first step, different user agents have to be categorized. As you can see, the variable <code>$goodagent</code> is set to <code>false</code> for any user agent apart from <code>Supersecretuseragent</code>. In the server-block, the <code>proxy_pass</code> for the route <code>supersecretlocation</code> is defined. That is the route, the beacon will request with the user agent <code>Supersecretuseragent</code>. The proxy-connection itself forwards to <code>https://localhost:5443</code>. The reason for this is, as you will see later on, that the connection from C2 to the redirector is solved through ssh and remote port forwarding. If the request comes with a user agent, not categorized as <code>$goodagent</code> a 404-error will be thrown.</p>
<p>Another restriction can be implemented, based on geolocations. Therefore, the <a href="https://www.maxmind.com/" target="_blank">MaxMind</a> database is used, which maps IP addresses to countries. In the Nginx configuration these countries can be referenced and assigned to different server responses [<a href="https://medium.com/@maxime.durand.54/add-the-geoip2-module-to-nginx-f0b56e015763" target="_blank">3</a>]. The restriction process is similar to the restriction of user agents.</p>
<p>Last, of course, the web server itself has to be hardened. This consists of the following points:</p>
<ul>
<li>make sure the implemented version is up to date</li>
<li>strip out all instances of the version number</li>
<li>change default credentials (if applicable)</li>
<li>remove all unnecessary files (like Changelogs, Publisher Notes, etc.)</li>
<li>remove all metadata from files and media</li>
<li>remove comments in code</li>
<li>check and clean all certificate data</li>
</ul>
<p>After this step go and scan your redirector server, to see whether you can gain information or hack it. Specifically, do port scans or wordlist enumeration. The aim should be to check whether you forgot something to clean. It might also help to let a fresh pair of eyes do this.</p>
<h3>DNS Redirector</h3>
<p>For a DNS redirector no specific DNS service on the redirector itself is necessary. As the traffic is only forwarded and not processed two main options do exist: socat or iptables. Iptables might offer slightly more options, as you can specify the IP-ranges of incoming traffic and implement forwarding rules for IPs not coming from that range. On the other hand,  socat is a bit easier and faster to set up [<a href="https://www.cobaltstrike.com/blog/simple-dns-redirectors-for-cobalt-strike/" target="_blank">4</a>].</p>
<p>It also pays off to have a look at how your C2-server handles DNS requests and if it could be fingerprinted through that [<a href="https://labs.withsecure.com/publications/detecting-exposed-cobalt-strike-dns-redirectors" target="_blank">5</a>].</p>
<p>To make the redirector work properly, a few more steps have to be taken. These steps differ based on the respective C2. Basically, you need to register an A record as well as an NS record for the (sub)domain of your redirector. For Sliver a comprehensive tutorial exists in the official Wiki [<a href="https://github.com/BishopFox/sliver/wiki/DNS-C2" target="_blank">6</a>].</p>
<h2>Phishing/Payload Infrastructure</h2>
<p>This part of the infrastructure consists of three components: the actual phishing/payload server, a Postfix redirector and an instance of Outlook in the Azure cloud. The phishing/payload server contains the actual phishing software and functions as storage for stage-1-payloads (staged payloads consist of a small piece of code, the stage-0, which is executed by the target and loads the actual payload, the so-called stage-1). The Postfix redirector is used for changing or stripping out suspicious mail headers and the Outlook instance is necessary to make the mails look more trustworthy. Additionally, if a response to the mails is sent from the target, the communication can be carried onwards from the Outlook inbox.</p>
<p>The diagram below gives an overview this part of the infrastructure and the respective functions described before.</p>
<figure class="rehype-figure"><img src="/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_diagram_mail_infrastructure.png" alt="red_team_infrastructure_diagram_mail_infrastructure" title="Phishing infrastructure overview"><figcaption>red_team_infrastructure_diagram_mail_infrastructure</figcaption></figure>
<h3>Phishing/Payload Server</h3>
<p>In terms of phishing software <a href="https://getgophish.com/" target="_blank">Gophish</a> is the go-to-standard for years. It helps in the creation of fake websites, can monitor clicks or personalize links with IDs to identify the behaviour of certain users. Gophish also comes with a web server for your fake websites or stage-1-payloads. So, if a HTTPS-redirector is placed in front of the Gophish instance it can be used as a combined phishing and payload service. Aside from that, GoPhish does its job pretty well. Some small OPSEC-customizations have to be done, but that's because GoPhish is tailored towards phishing engagements only and implements not-so-stealthy headers containing the value "gophish" to distinct these from real phishing mails. As that is a clear indicator for defensive mechanisms, these headers have to be stripped out (this will be done by the Postfix redirector).</p>
<h3>Setup Process</h3>
<p>First of all, you should register your domain with a DNS service and afterwards set up all necessary DNS records. In this case I used <a href="https://aws.amazon.com/route53/" target="_blank">Route 53</a> as it allows an easy setup with Terraform, but also any other DNS Service is absolutely fine (like SSE's very own <a href="https://desec.io/" target="_blank">deSEC</a>). The following records have to be set: A, MX, SPF, DMARC, DKIM. If not already happened by now, also purchase an MS Office365 or Outlook license. Then spin up the Outlook instance in Azure and follow the steps below to connect the components.</p>
<p>The process to use Office365 as an SMTP relay is already described step by step in this <a href="https://poweradm.com/postfix-with-microsoft-365-smtp-relay/" target="_blank">blogpost</a>. In the following paragraphs, I will briefly sum the process up and add some information relevant for phishing. First, the MS365 host is implemented. Therefore, you need to set up an Azure box with MS Office365 and enable SMTP-authentication for a single user account (the one you plan to use for the forwarding).</p>
<p>Then you have to set up the Postfix instance on an internal server. After installing it (for Ubuntu it is just <code>apt-get</code>), some configuration files have to be created and hashed. If you follow the aforementioned blog post this is quite simple. By now, Gophish does not know that a redirector is used. This can be changed with so "Sending Profiles", which can be created via the Gophish UI and where you just need to add your Postfix server values [<a href="https://docs.getgophish.com/user-guide/documentation/sending-profiles" target="_blank">7</a>].</p>
<p>Afterwards, the headers Gophish sends along with an email have to be removed, otherwise the phishing mail will be instantly recognized and blocked by mail servers. The cleaning of the mail headers is mainly done by integrating a file called "header_checks" in Postfix. This file tells Postfix how to handle certain headers. In our case, this means to find certain headers and either strip these out or overwrite the values. Apart from headers containing your IP and hostname or domain, the file should also handle the header "X-Mailer", as it is specific to Gophish and a clear indicator for phishing. Additionally, in Postfix's main configuration file (main.cf) the variable <code>myhostname</code> should be set to something unsuspicious like a subdomain of your phishing domain (e.g. something like <code>mail.domain.com</code>)</p>
<p>The following is an example of how Postfix's <code>header_checks.cf</code> file can look like:</p>
<pre><code>      /^Received:/ IGNORE
      /^X-Mailer:/ IGNORE
      /^Message-ID:/ IGNORE
      /^User-Agent:/ IGNORE
      /^X-Originating-IP:/    IGNORE
      /^Mime-Version:/        IGNORE
      /^In-Reply-To:/ IGNORE
      /^References:/ IGNORE
</code></pre>
<p>After setting up the Gophish server, send some test mails and analyse custom or suspicious headers. It might help to grep for the used hostname, expressions like "phish" and anything related to the Gophish server's IP address or hostname.</p>
<h2>Connections</h2>
<p>Now that the single components have been depicted, also the collaboration between the elements has to be defined.</p>
<p>In the present infrastructure three connections between servers are needed:</p>
<ul>
<li>C2-team-server to HTTPS-redirector (implant communication)</li>
<li>C2-team-server to DNS-redirector (implant communication)</li>
<li>Payload-server to HTTPS-redirector (stage-1-payload)</li>
</ul>
<p>The connections from the internal network to the redirectors can be handled via ssh and remote port forwarding. In that way traffic can be forwarded in a comfortable and fast way. For this use case I implemented <a href="https://manpages.ubuntu.com/manpages/trusty/man1/autossh.1.html" target="_blank">Autossh</a> as a service. Autossh makes sure that the connection is held up and if it is lost reconnects automatically.</p>
<p>It makes sense to establish Autossh as a service, as it is more stable. In the snippet below the service for a connection to the DNS-redirector is depicted:</p>
<pre><code>[Unit]
Description=AutoSSH tunnel to DNS-Redirector
After=network.target
[Service]
Environment="AUTOSSH_GATETIME=0"
ExecStart=/usr/bin/autossh -M 0 -q -N -o "ServerAliveInterval 60" -o "ServerAliveCountMax 3" -R 5353:localhost:53 -i &lt;SSH-KEY&gt; &lt;USER&gt;@&lt;DNS_Redirector_IP&gt;
[Install]
WantedBy=multi-user.target
</code></pre>
<p>Of course, also other services or methods can be used, as long as these offers a stable connection and offers an automatic reconnection. An example for this would be Wireguard [<a href="https://www.wireguard.com/" target="_blank">8</a>].</p>
<h2>Automate Setup Process</h2>
<p>As you do not want to set up every host by hand, automation is almost a must . This reduces mistakes and if done correctly it also saves a lot of time in case parts of the infrastructure have to be changed (which almost happens for every engagement). For this reason, a mixture between Terraform, Vagrant and Ansible can be used.</p>
<p>I used these in the following way: Terraform for the setup of the AWS boxes, Vagrant for the setup of the boxes on the internal network and Ansible for automating the installation of software and everything else following after an installation of a machine's operation system. This included web servers, ssh connections, certificates, movement of files and more. Additionally, the three tools can be intertwined seamlessly and work together like a charm. Depending on the size of the infrastructure, it makes sense to create automation scripts in a modular way, for example with Ansible roles for each host. An example for automating a red team setup with Terraform and Digital Ocean can be found under this <a href="https://www.ired.team/offensive-security/red-team-infrastructure/automating-red-team-infrastructure-with-terraform" target="_blank">blogpost</a>.</p>
<h2>Summary</h2>
<p>As you can see the topic is a very broad one, with lots of branches and paths to go down. I tried to trim these to a minimum to keep the path clear and give an overview without diving too deep into the rabbit holes of different components. I hope I could answer the following questions.</p>
<h3>What requirements have to be met?</h3>
<p>The requirements can be divided into requirements related to functionality &amp; performance, security &amp; obfuscation and additional requirements not fitting the other two categories.
The infrastructure should be able to send and receive phishing mails, host files and allow C2 communication. All of this functionality should be protected from the target's blue team or other defensive tools (like Antivirus software) and has to work proper and stable.</p>
<h3>What are the components a red team infrastructure consists of?</h3>
<p>The main infrastructure can be divided into the phishing infrastructure and the C2-infrastructure. Each of these contains the main component (phishing/payload server or C2 server) and several redirectors.</p>
<p>For the C2-infrastructure, these are redirectors used to forward beacon traffic and protect the main C2 server. A minimum of two different redirectors are recommended, one for the main beacon traffic using a fast protocol like HTTPS and one backup channel using a more subtle protocol like DNS.</p>
<p>The mail infrastructure uses two redirectors in a row, one Postfix redirector to clean outgoing mail traffic and afterwards an MS Office365 instance to make the mail traffic look more trustworthy as well as to provide an inbox for potential responses.</p>
<h3>What software can be used?</h3>
<p>This question does not have a definitive answer, as it comes down to individual preferences and budget. Regarding the mail infrastructure there is more or less a definitive answer as Gophish is the de-facto industry standard nowadays. Paired with a Postfix redirector and a Microsoft Outlook instance as a mail relay it is in my opinion the best choice.</p>
<p>The choice of a C2-framework offers much more possibilities, as a decision has to be made between paid and open-source frameworks. For paid frameworks I would choose between Cobalt Strike, Brute Ratel or Nighthawk. In terms of free frameworks, at the current point in time, I would go with Sliver, Havoc or Mythic.</p>
<p>For redirectors for C2 traffic there would be the choice between Apache, Nginx or Caddy for the HTTPS redirector and Socat or IPtables for the DNS redirector.</p>
<h3>Conclusion</h3>
<p>This blog post serves as a base to create your own red team infrastructure and hopefully helps to give an overview on the different branches. Each branch can be explored deeper, which I might do in future blog posts focusing on single elements, but this should be enough for today. If you have questions or just want to chat about what you just read, do not hesitate and hit me up.</p>
<h2>Links</h2>
<p>[<a href="https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki" target="_blank">1</a>]: <a href="https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki" target="_blank">https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki</a>
[<a href="https://medium.com/geekculture/an-nginx-apache-alternative-for-c2-redirecting-61e92a917101" target="_blank">2</a>]: <a href="https://medium.com/geekculture/an-nginx-apache-alternative-for-c2-redirecting-61e92a917101" target="_blank">https://medium.com/geekculture/an-nginx-apache-alternative-for-c2-redirecting-61e92a917101</a>
[<a href="https://medium.com/@maxime.durand.54/add-the-geoip2-module-to-nginx-f0b56e015763" target="_blank">3</a>]: <a href="https://medium.com/@maxime.durand.54/add-the-geoip2-module-to-nginx-f0b56e015763" target="_blank">https://medium.com/@maxime.durand.54/add-the-geoip2-module-to-nginx-f0b56e015763</a>
[<a href="https://www.cobaltstrike.com/blog/simple-dns-redirectors-for-cobalt-strike/" target="_blank">4</a>]: <a href="https://www.cobaltstrike.com/blog/simple-dns-redirectors-for-cobalt-strike/" target="_blank">https://www.cobaltstrike.com/blog/simple-dns-redirectors-for-cobalt-strike/</a>
[<a href="https://labs.withsecure.com/publications/detecting-exposed-cobalt-strike-dns-redirectors" target="_blank">5</a>]: <a href="https://labs.withsecure.com/publications/detecting-exposed-cobalt-strike-dns-redirectors" target="_blank">https://labs.withsecure.com/publications/detecting-exposed-cobalt-strike-dns-redirectors</a>
[<a href="https://github.com/BishopFox/sliver/wiki/DNS-C2" target="_blank">6</a>]: <a href="https://github.com/BishopFox/sliver/wiki/DNS-C2" target="_blank">https://github.com/BishopFox/sliver/wiki/DNS-C2</a>
[<a href="https://docs.getgophish.com/user-guide/documentation/sending-profiles" target="_blank">7</a>]: <a href="https://docs.getgophish.com/user-guide/documentation/sending-profiles" target="_blank">https://docs.getgophish.com/user-guide/documentation/sending-profiles</a>
[<a href="https://www.wireguard.com/" target="_blank">8</a>]: <a href="https://www.wireguard.com/" target="_blank">https://www.wireguard.com/</a></p></div></div><div style="text-align:left"><div class="flex flex-row lg:flex-col gap-16 text-sse-black mb-16 mr-4 "><div class="min-w-fit"><picture><source class="inline object-cover w-48 h-48 mr-2 rounded-full" srcset="/images/team/andre.webp" type="image/webp" width="12rem" height="12rem"><source class="inline object-cover w-48 h-48 mr-2 rounded-full" srcset="/images/team/andre.jpg" type="image/jpeg" width="12rem" height="12rem"><img class="inline object-cover w-48 h-48 mr-2 rounded-full" src="/images/team/andre.jpg" alt="" width="12rem" height="12rem"></picture></div><div class="flex-1"><div class="font-bold mb-4">André Tschapeller</div><div class="mb-8">André is passionate about creative attack paths and using systems in unintended ways, which he tries to include in assessments for our clients. He is part of our Offensive Security Team and mainly involved in web application security.</div><div class=""><a class="text-sse-grey-dark w-6 h-6 inline-block mr-8" href="https://twitter.com/hipstertrojan" title="Twitter" target="_blank" rel="noreferrer"><svg width="29" height="27" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.492 0 0 6.045 0 13.5S6.492 27 14.5 27 29 20.955 29 13.5 22.508 0 14.5 0Zm7.33 10.85c.22 4.546-3.42 9.613-9.865 9.613-1.96 0-3.783-.536-5.32-1.453 1.842.203 3.68-.274 5.139-1.337-1.518-.026-2.8-.961-3.244-2.245a3.731 3.731 0 0 0 1.569-.055c-1.669-.313-2.822-1.712-2.784-3.21a3.66 3.66 0 0 0 1.572.404c-1.546-.962-1.983-2.862-1.074-4.314 1.71 1.955 4.269 3.241 7.153 3.376-.506-2.02 1.14-3.968 3.382-3.968.997 0 1.9.393 2.533 1.02a7.241 7.241 0 0 0 2.204-.783 3.297 3.297 0 0 1-1.526 1.787 7.327 7.327 0 0 0 1.992-.51 6.72 6.72 0 0 1-1.731 1.676Z" fill="currentColor" fill-rule="nonzero"></path></svg></a><a class="text-sse-grey-dark w-6 h-6 inline-block mr-8" href="https://de.linkedin.com/in/andre-tschapeller-70a206135" title="LinkedIn" target="_blank" rel="noreferrer"><svg width="29" height="27" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.492 0 0 6.045 0 13.5S6.492 27 14.5 27 29 20.955 29 13.5 22.508 0 14.5 0Zm-2.417 18H9.667v-6.75h2.416V18Zm-1.208-7.752c-.733 0-1.33-.558-1.33-1.248 0-.688.595-1.248 1.33-1.248.735 0 1.33.56 1.33 1.248 0 .69-.597 1.248-1.33 1.248ZM20.542 18h-2.415v-3.219c0-2.116-2.419-1.937-2.419 0V18h-2.416v-6.75h2.416v1.23c1.054-1.818 4.834-1.953 4.834 1.741V18Z" fill="currentColor" fill-rule="nonzero"></path></svg></a><a class="text-sse-grey-dark w-6 h-6 inline-block mr-8" href="https://medium.com/@hipstertrojan" title="Medium" target="_blank" rel="noreferrer"><svg width="29" height="29" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.494 0 0 6.491 0 14.5 0 22.508 6.494 29 14.5 29 22.508 29 29 22.508 29 14.5 29 6.491 22.508 0 14.5 0Zm8.427 21.215v-.284l-1.32-1.296a.394.394 0 0 1-.15-.378V9.743a.394.394 0 0 1 .15-.378l1.351-1.296v-.284h-4.675L14.951 16.1l-3.792-8.314H6.254v.284l1.58 1.903a.652.652 0 0 1 .213.553v7.477a.861.861 0 0 1-.228.742l-1.777 2.155v.284h5.038V20.9l-1.777-2.155a.891.891 0 0 1-.244-.742v-6.467l4.422 9.648h.514l3.798-9.648v7.69c0 .206 0 .245-.134.379l-1.366 1.327v.284h6.634Z" fill="currentColor" fill-rule="evenodd"></path></svg></a><a class="text-sse-grey-dark w-6 h-6 inline-block mr-8" href="https://github.com/hipstertrojan" title="Github" target="_blank" rel="noreferrer"><svg width="27" height="27" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)" fill="currentColor"></path></svg></a></div></div></div></div></div></div></main><footer class="sse-footer canvas"><div class="flex flex-col md:flex-row"><div class="flex-1 md:w-2/3 my-16"><nav class="grid grid-cols-1 grid-row-4 md:grid-cols-2 md:grid-row-2 gap-8 md:gap-16" role="navigation" aria-label="menu"><div class="flex-1 text-white mb-8 mr-8 nav-current text-white"><a class="font-serif text-xl" target="_self" href="/">Service</a><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/defensive-security-services/">Defensive Security</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/offensive-security-services/">Offensive Security</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/training/">Training &amp; Awareness</a></li></ul></div><div class="flex-1 text-white mb-8 mr-8 nav-current text-white"><a class="font-serif text-xl" target="_self" href="/engineering-and-contributions/">Contributions</a><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/dns-security/">DNS Security</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/connaisseur/">Connaisseur</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/public-suffix-list/">Public Suffix List</a></li></ul><ul class="first-of-type:mt-8 mt-2 flex flex-col gap-4 text-white"><li><a class="pb-2" href="/internet-architecture/">Internet Architecture</a></li></ul></div><div class="flex-1 text-white mb-8 mr-8 nav-current text-white"><a class="font-serif text-xl" target="_self" href="/about-us/">About Us</a></div><div class="flex-1 text-white mb-8 mr-8 nav-current text-white"><a class="font-serif text-xl" target="_self" href="/blog/">Blog</a></div></nav></div><div class="my-16 md:w-1/3 text-center md:text-right"><div class="text-white uppercase text-sm">Follow <strong>SSE</strong> on:</div><div class="mt-4 text-white"><a class="sse-social-icon inline py-4 px-2" href="https://twitter.com/sse_gmbh" title="Twitter" target="_blank" rel="noreferrer"><svg width="29" height="27" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.492 0 0 6.045 0 13.5S6.492 27 14.5 27 29 20.955 29 13.5 22.508 0 14.5 0Zm7.33 10.85c.22 4.546-3.42 9.613-9.865 9.613-1.96 0-3.783-.536-5.32-1.453 1.842.203 3.68-.274 5.139-1.337-1.518-.026-2.8-.961-3.244-2.245a3.731 3.731 0 0 0 1.569-.055c-1.669-.313-2.822-1.712-2.784-3.21a3.66 3.66 0 0 0 1.572.404c-1.546-.962-1.983-2.862-1.074-4.314 1.71 1.955 4.269 3.241 7.153 3.376-.506-2.02 1.14-3.968 3.382-3.968.997 0 1.9.393 2.533 1.02a7.241 7.241 0 0 0 2.204-.783 3.297 3.297 0 0 1-1.526 1.787 7.327 7.327 0 0 0 1.992-.51 6.72 6.72 0 0 1-1.731 1.676Z" fill="currentColor" fill-rule="nonzero"></path></svg></a><a class="sse-social-icon inline py-4 px-2" href="https://www.linkedin.com/company/sse-secure-systems-engineering" title="LinkedIn" target="_blank" rel="noreferrer"><svg width="29" height="27" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.492 0 0 6.045 0 13.5S6.492 27 14.5 27 29 20.955 29 13.5 22.508 0 14.5 0Zm-2.417 18H9.667v-6.75h2.416V18Zm-1.208-7.752c-.733 0-1.33-.558-1.33-1.248 0-.688.595-1.248 1.33-1.248.735 0 1.33.56 1.33 1.248 0 .69-.597 1.248-1.33 1.248ZM20.542 18h-2.415v-3.219c0-2.116-2.419-1.937-2.419 0V18h-2.416v-6.75h2.416v1.23c1.054-1.818 4.834-1.953 4.834 1.741V18Z" fill="currentColor" fill-rule="nonzero"></path></svg></a><a class="sse-social-icon inline py-4 px-2" href="https://medium.com/sse-blog" title="Medium" target="_blank" rel="noreferrer"><svg width="29" height="29" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 0C6.494 0 0 6.491 0 14.5 0 22.508 6.494 29 14.5 29 22.508 29 29 22.508 29 14.5 29 6.491 22.508 0 14.5 0Zm8.427 21.215v-.284l-1.32-1.296a.394.394 0 0 1-.15-.378V9.743a.394.394 0 0 1 .15-.378l1.351-1.296v-.284h-4.675L14.951 16.1l-3.792-8.314H6.254v.284l1.58 1.903a.652.652 0 0 1 .213.553v7.477a.861.861 0 0 1-.228.742l-1.777 2.155v.284h5.038V20.9l-1.777-2.155a.891.891 0 0 1-.244-.742v-6.467l4.422 9.648h.514l3.798-9.648v7.69c0 .206 0 .245-.134.379l-1.366 1.327v.284h6.634Z" fill="currentColor" fill-rule="evenodd"></path></svg></a></div></div></div><div class="flex flex-col md:flex-row mt-8 mb-16"><div class="flex-1 text-center md:text-right md:order-2 text-white"><a class="mx-8 md:ml-0 text-white" href="/privacy/">Privacy</a><a class="mx-8 md:mr-0" href="/imprint/">Imprint</a></div><div class="flex-1 md:order-1 text-white text-xs text-center md:text-left md:text-sm mt-8 md:mt-auto">© SSE – Secure Systems Engineering GmbH</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"posts":{"_sys":{"filename":"building-a-red-team-infrastructure-in-2023","basename":"building-a-red-team-infrastructure-in-2023.md","breadcrumbs":["building-a-red-team-infrastructure-in-2023"],"path":"content/posts/building-a-red-team-infrastructure-in-2023.md","relativePath":"building-a-red-team-infrastructure-in-2023.md","extension":".md"},"id":"content/posts/building-a-red-team-infrastructure-in-2023.md","locale":"en-GB","title":"Building a Red Team Infrastructure in 2023","description":"In this blog post an overview of the different components of a red team infrastructure is given. This includes explanations how these work, as well as the comparison of different solutions and their characteristics.","image":"https://www.securesystems.de/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_title_image.jpg","excerpt":"In this blog post an overview of the different components of a red team infrastructure is given. This includes explanations how these work, as well as the comparison of different solutions and their characteristics.","urlImage":"/images/blog/building-a-red-team-infrastructure-in-2023/red_team_infrastructure_title_image.jpg","tags":["Red Team"],"internalTags":["oss"],"date":"2023-04-26T22:00:00.000Z","scrollopacity":null,"blocks":[{"__typename":"PostsBlocks_LinkBack","href":"/blog/","linkText":"Back to the SSE Blog","className":""},{"__typename":"PostsBlocks_TwoColumnsBlog","fullWidth":false,"left":[{"__typename":"PostsBlocks_TwoColumnsBlogLeft_Markdown","markdown":"# Building a Red Team Infrastructure in 2023\n\n## Intro\n\nThe infrastructure of a red team engagement might be poetically described as the beating heart of an engagement. It is the central point where everything is connected and runs together. All the data is stored here and when it crashes (or is crashed), it might as well end the whole engagement. This leads to several requirements that have to be met, rooting from different perspectives like functionality, stability, but also security and deception of the blue team.\n\nThe topic of building a red team infrastructure is not a new one and although several blog posts on this topic exist [[1](https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki)], I tried to let my insights and struggle flow into this post, which will hopefully help you to make better decisions and avoid potential pitfalls.\n\nThe following questions are drawing the outline for this blog post: \n- What requirements have to be met?\n- What are the components a red team infrastructure consists of?\n- What software can be used?\n- How are these components set up?\n\nIn order to answer these, I will first lay out the requirements for the infrastructure, then give an overview of the whole system and zoom in on the different components to give my opinion on these as well as a quick look on the setup of each.\n\n\n## Requirements\n\nFor a red team exercise not only the requirements of a common infrastructure, like the actual functionality, reliability as well as stability apply, but also another layer of security and obfuscation has to be added to prevent the blue team from detecting the infrastructure on the first day of the phishing campaign. An overview of these requirements can be seen in the graphic below. \n\n![red_team_infrastructure_overview_requirements](red_team_infrastructure_overview_requirements.png \"Overview of requirements\")\n\n\nThese requirements constitute the baseline of the necessary infrastructure components. Of course, you can customize these towards your own needs, but instead of stripping away points, I would rather add more requirements.\n\n\n## Overview of Components\n\nSo, what are the components that are necessary to satisfy the aforementioned requirements? In the graphic below, the network, including components and connections, is depicted. \n\n![red_team_infrastructure_network_overview](red_team_infrastructure_network_overview.png \"Exemplary network overview\")\n\nThe following components are part the infrastructure:\n\n- **Phishing/Payload Server**: used to create and execute phishing campaigns and store payload code for attacks.\n- **C2-Team-Server**: central communication and steering centre for red team operators.\n- **Redirectors**: for mail, https and dns traffic. Serve as proxies for the traffic and protect core assets.\n- **[Optional] Vaultwarden**: represents a secure data storage solution for the duration of the engagement, e.g. for secrets or gathered credentials.\n- **[Optional] Red ELK**: basically a SOC for red teams, helps to monitor your infrastructure and detect the blue team snooping around your assets.\n\nA detailed explanation of each component is given in later paragraphs.\n\n### Network Segregation\n\nThe image also shows the distinction between the internal network and the public internet. As the redirectors have to be accessible via the public internet and camouflage as legit web, dns or mail servers, these of course should have a public IP address.  \n\nThe core assets like the C2-team-server or the phishing and the payload server should be spun up in a protected or internal network. If that is not possible, it should be at least ensured that the open ports of these machines are only accessible by legitimate users. This can be done via connections restricted to specific IP-addresses or certificates. Furthermore, only necessary ports, e.g. SSH- or VPN-ports should be externally accessible.\n\n\n### Cloud Providers\n\nRegarding cloud providers, just go with your preferred one. Personally, for the redirectors we use AWS and as Azure makes the implementation of their apps pretty easy, we used Azure for the Outlook instance. But also CloudFront or Digital Ocean are fine for spinning up instances. More important is to \nlet the provider know that you are operating a professional red team operation otherwise any cloud provider will deactivate your machines without further notice.\n\n\n## C2-Infrastructure\n\nI will start the deep dive into individual components with the C2-infrastructure, which consists of one or more C2-instances and several traffic redirectors. \n\n### C2 Team Server\n\nThe C2-instance serves as the central communication and steering point for red team operators. Implant traffic is controlled from this point and can also be changed from the way it communicates, up to single commands sent to be executed on the target's computer. C2-frameworks also offer a wide range of integrated tools, that help to execute a successful attack.\n\nA critical decision to be made is whether you want to (or rather can) afford a paid C2 or not. For many years Cobalt Strike was the industry-standard for red teams, but during the recent years many other alternatives arose. Open-source frameworks get a more and more popular, especially with threat actors. The reason they were used by threat actors is simple: these C2s are not as widespread as Cobalt Strike or other paid industry standard C2-frameworks and defensive mechanisms often do not catch them as easily, as their behaviour has not been fingerprinted as well. This even went so far, that the first implants generated by Havoc last year were not even caught by Windows Defender. \n\nThe following questions might help you with choosing the best solution:\n\n- Do I want to pay for a C2?\n- What communication channels do I want?\n- Do I want a GUI?\n- Do I need several operators to connect to the C2?\n- What operating system does the C2 have to run on?\n- What evasion features do I want?\n\nYou can also have a look at the [C2 Matrix](https://www.thec2matrix.com) but pay attention as some of the information might be not perfectly up to date. Nevertheless, it gives a good overview on the existing C2 frameworks.\nWhen deciding for an open-source framework, always check the latest releases and commits to make sure these are not seriously outdated. And most important, it should go without saying, test and play around with your C2 of choice. If you cannot decide, there is always the option to implement two or more C2s and use these in parallel. \n\nPersonally, I decided to give Sliver a go, especially as it is really well maintained, but honestly also as it got hyped a bit at the time I started this experiment. Nevertheless, Sliver did not disappoint. Below I listed my personal advantages and disadvantages for Sliver:\n\n![red_team_infrastructure_advantages_disadvantages_sliver](red_team_infrastructure_advantages_disadvantages_sliver.png \"Sliver C2 advantages and disadvantages\")\n\n\nSome of the disadvantages could be easy to solve as it is open-source and everyone can help to improve it. \n\n\n### C2-Redirectors\n\nThese can be divided into different kinds based on the traffic they redirect, which will be in this blog post: mail traffic (phishing), HTTPS traffic (short term), DNS traffic (long term). An overview of the redirectors relevant for the C2-traffic can be found below. The mail redirector will be covered in a later paragraph.\n\n![red_team_infrastructure_c2_redirectors](red_team_infrastructure_c2_redirectors.png \"C2 traffic redirectors overview\")\n\nThe main tasks of a redirector is to protect the respective core assets and to proxy all the traffic destined for and sent by those instances (here: the C2-team server(s)). If a beacon's traffic is discovered by the target's blue team, only the IP or domain of the redirector is lost. In that case just the redirector has to be exchanged, maybe there is even a backup redirector in place. Consequently, only the traffic has to be rerouted to another redirector instead of having to set up the whole infrastructure again. The two different traffic channels for the C2 exist for reasons of redundancy. Should the HTTPS-channel be discovered, there still is the DNS-channel available. DNS traffic is not monitored in many companies and therefore often flies under the radar. \n\nPlease note, that if another kind of protocol for the implant communication is used, another redirector is necessary.\n\n### HTTPS Redirector\n\nTwo kinds of approaches exist for a redirector for HTTPS traffic. Traffic can be redirected via a simple pipe or via a reverse web proxy. The first option, achieved via socat or an IP tables rule, blindly forwards traffic arriving at a certain port. This basically describes the functionality one would expect from a redirector. In contrast, a reverse web proxy adds the possibility to filter out unwanted visitors based on factors like geolocation or user agent. It enables you to route the implant traffic to your C2-server and show all other visitors a common web site. This principle is also shown in the picture below.\n\n![red_team_infrastructure_redirector_flow](red_team_infrastructure_redirector_flow.png \"Redirector traffic flow\")\n\nIt can be seen that a marker on every request reaching the redirector is evaluated. Based on the outcome of that evaluation, if the request is categorized as a valid request coming from the implant, it is forwarded to the C2 server. Otherwise, the request is forwarded to a web server containing an ordinary web page or an error code.\n\n#### Software Options\n\nRegarding the proxy software, three main options exist: Apache, Nginx or Caddy. All of these are open-source applications. Of course, you can also use another web server if it fulfils the previously mentioned criteria. \n\nApache and Nginx are well-known options and lots of tutorials for the setup are available. They function almost out of the box and have lots of modules to block unwanted guests or IPs based on the regarding geolocation. Also, as these are widely used, they do not stand out in terms of the product itself.\n\nA lesser known and used option is [Caddy](https://github.com/caddyserver/caddy). I have not tried it yet, but it promises an easy setup with automated HTTPS support (via ZeroSSL or Let's Encrypt) for public domains. A big plus is also that you only need a single file called \"Caddyfile\", which handles all settings. It is written in Go and does not have any further dependencies. It has also been demonstrated that Caddy can be specifically used as a redirector for C2-traffic [[2](https://medium.com/geekculture/an-nginx-apache-alternative-for-c2-redirecting-61e92a917101)].\n\n#### Setup/Hardening Process\n\nThe correct setup and hardening of the redirectors are crucial processes. If done correctly the redirector will look like a common web site. If not, the blue team will catch you sooner than you think.\n\nFirst of all, all traffic to and from the redirector should be encrypted via HTTPS. Otherwise, the SOC will easily pick up your implant, as all transmitted data can be read. From an OPSEC-perspective you do not want to have an unencrypted connection into a client's network, as anyone could eavesdrop on the traffic. Plus, unencrypted traffic always stands out as it could be an indicator for suspicious activity. \n\nWhich leads to the next point: do not use self-signed certificates. An easy way to generate valid certificates is using Let's Encrypt and getting automatically generated certificates for your domain. You can either generate the certificate yourself or use [Certbot](https://certbot.eff.org/), which opens a web server on port 80 of your IP (to make sure you legally own the domain) and does all the work. If you are running another service (e.g. Nginx) on port 80, this service should be stopped for the time Certbot is running. \nAs the certificates from Let's Encrypt are free, a lot of people use them - this includes loads of suspicious actors and scammers. Consequently, if you have the budget available, buy some certificates from any other certificate authority (honestly, it does not matter from which one). \n\nSpeaking of issuing certificates to a domain: your redirector should have a domain, as connections to IP-addresses are pretty suspicious. Choose a domain name based on your OSINT-results. Ideas would be anything infrastructure related, campaigns/promotions related to special events like Christmas or even a domain with the target's name and a well-hidden typo in it. \n\nIf you have the time, you should definitely create a simple, but convincing web site. This will critically add to the site's credibility and help to conceal the real purpose of the web server (to tunnel implant traffic). \n\nOff to more specific settings to block unwanted visitors. As scanner bots often use specific user agents, it is rather simple to map unwanted strings in user agents to a rule that either responds with an error code or forwards the visitor to another website (like [google.com](https://www.google.com)).\n\nThe most crucial part is to hide the implant traffic to the C2. This is commonly done by making the implant query a specific directory or file on the webserver. The webserver then forwards all traffic to the C2 server.\n\nTo only get desired traffic reaching the C2 server, a restriction-layer based on multiple factors (like user agent, IP address or domain if available) and responding with an error code for queries not matching the required pattern is implemented.\n\nIn this example I chose Nginx as a redirector, so the following paragraphs are tailored towards it. Nevertheless, similar functions do exist in Apache or Caddy. \n\nFor Nginx you can set the `proxy_pass` attribute when a certain location is requested. As a restriction, based on the requested location could be detected easily, another factor is needed. In this example, it will be the user agent. The following snippet is from Nginx's `default.conf`. \n\n```\n# map useragents to proxypasses\nmap $http_user_agent $goodagent {                                                                                                                                        \n    default 0;           \n    \"Supersecretuseragent\" 1;\n}\n\n[...]\n\nserver {\n\n[...]\n\n# C2 route\n  location /supersecretlocation/ {\n      proxy_ssl_certificate /etc/nginx/https-cert.pem;\n      proxy_ssl_certificate_key /etc/nginx/https-key.pem;\n      proxy_ssl_verify off;\n      proxy_ssl_server_name      on;\n      proxy_set_header Host $host;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_pass https://localhost:5443;\n      if ($goodagent = 0) {\n      return 404;\n\t}\n  }\n } \n```\n\nIn a first step, different user agents have to be categorized. As you can see, the variable `$goodagent` is set to `false` for any user agent apart from `Supersecretuseragent`. In the server-block, the `proxy_pass` for the route `supersecretlocation` is defined. That is the route, the beacon will request with the user agent `Supersecretuseragent`. The proxy-connection itself forwards to `https://localhost:5443`. The reason for this is, as you will see later on, that the connection from C2 to the redirector is solved through ssh and remote port forwarding. If the request comes with a user agent, not categorized as `$goodagent` a 404-error will be thrown.\n\nAnother restriction can be implemented, based on geolocations. Therefore, the [MaxMind](https://www.maxmind.com/) database is used, which maps IP addresses to countries. In the Nginx configuration these countries can be referenced and assigned to different server responses [[3](https://medium.com/@maxime.durand.54/add-the-geoip2-module-to-nginx-f0b56e015763)]. The restriction process is similar to the restriction of user agents.\n\nLast, of course, the web server itself has to be hardened. This consists of the following points:\n- make sure the implemented version is up to date\n- strip out all instances of the version number\n- change default credentials (if applicable)\n- remove all unnecessary files (like Changelogs, Publisher Notes, etc.)\n- remove all metadata from files and media\n- remove comments in code\n- check and clean all certificate data\n\nAfter this step go and scan your redirector server, to see whether you can gain information or hack it. Specifically, do port scans or wordlist enumeration. The aim should be to check whether you forgot something to clean. It might also help to let a fresh pair of eyes do this. \n\n\n### DNS Redirector\n\nFor a DNS redirector no specific DNS service on the redirector itself is necessary. As the traffic is only forwarded and not processed two main options do exist: socat or iptables. Iptables might offer slightly more options, as you can specify the IP-ranges of incoming traffic and implement forwarding rules for IPs not coming from that range. On the other hand,  socat is a bit easier and faster to set up [[4](https://www.cobaltstrike.com/blog/simple-dns-redirectors-for-cobalt-strike/)].\n\nIt also pays off to have a look at how your C2-server handles DNS requests and if it could be fingerprinted through that [[5](https://labs.withsecure.com/publications/detecting-exposed-cobalt-strike-dns-redirectors)].\n\nTo make the redirector work properly, a few more steps have to be taken. These steps differ based on the respective C2. Basically, you need to register an A record as well as an NS record for the (sub)domain of your redirector. For Sliver a comprehensive tutorial exists in the official Wiki [[6](https://github.com/BishopFox/sliver/wiki/DNS-C2)]. \n\n\n## Phishing/Payload Infrastructure\n\nThis part of the infrastructure consists of three components: the actual phishing/payload server, a Postfix redirector and an instance of Outlook in the Azure cloud. The phishing/payload server contains the actual phishing software and functions as storage for stage-1-payloads (staged payloads consist of a small piece of code, the stage-0, which is executed by the target and loads the actual payload, the so-called stage-1). The Postfix redirector is used for changing or stripping out suspicious mail headers and the Outlook instance is necessary to make the mails look more trustworthy. Additionally, if a response to the mails is sent from the target, the communication can be carried onwards from the Outlook inbox. \n\nThe diagram below gives an overview this part of the infrastructure and the respective functions described before.\n\n![red_team_infrastructure_diagram_mail_infrastructure](red_team_infrastructure_diagram_mail_infrastructure.png \"Phishing infrastructure overview\")\n\n\n### Phishing/Payload Server\n\nIn terms of phishing software [Gophish](https://getgophish.com/) is the go-to-standard for years. It helps in the creation of fake websites, can monitor clicks or personalize links with IDs to identify the behaviour of certain users. Gophish also comes with a web server for your fake websites or stage-1-payloads. So, if a HTTPS-redirector is placed in front of the Gophish instance it can be used as a combined phishing and payload service. Aside from that, GoPhish does its job pretty well. Some small OPSEC-customizations have to be done, but that's because GoPhish is tailored towards phishing engagements only and implements not-so-stealthy headers containing the value \"gophish\" to distinct these from real phishing mails. As that is a clear indicator for defensive mechanisms, these headers have to be stripped out (this will be done by the Postfix redirector).\n\n\n### Setup Process\n\nFirst of all, you should register your domain with a DNS service and afterwards set up all necessary DNS records. In this case I used [Route 53](https://aws.amazon.com/route53/) as it allows an easy setup with Terraform, but also any other DNS Service is absolutely fine (like SSE's very own [deSEC](https://desec.io/)). The following records have to be set: A, MX, SPF, DMARC, DKIM. If not already happened by now, also purchase an MS Office365 or Outlook license. Then spin up the Outlook instance in Azure and follow the steps below to connect the components.\n\nThe process to use Office365 as an SMTP relay is already described step by step in this [blogpost](https://poweradm.com/postfix-with-microsoft-365-smtp-relay/). In the following paragraphs, I will briefly sum the process up and add some information relevant for phishing. First, the MS365 host is implemented. Therefore, you need to set up an Azure box with MS Office365 and enable SMTP-authentication for a single user account (the one you plan to use for the forwarding). \n\nThen you have to set up the Postfix instance on an internal server. After installing it (for Ubuntu it is just `apt-get`), some configuration files have to be created and hashed. If you follow the aforementioned blog post this is quite simple. By now, Gophish does not know that a redirector is used. This can be changed with so \"Sending Profiles\", which can be created via the Gophish UI and where you just need to add your Postfix server values [[7](https://docs.getgophish.com/user-guide/documentation/sending-profiles)].\n\nAfterwards, the headers Gophish sends along with an email have to be removed, otherwise the phishing mail will be instantly recognized and blocked by mail servers. The cleaning of the mail headers is mainly done by integrating a file called \"header_checks\" in Postfix. This file tells Postfix how to handle certain headers. In our case, this means to find certain headers and either strip these out or overwrite the values. Apart from headers containing your IP and hostname or domain, the file should also handle the header \"X-Mailer\", as it is specific to Gophish and a clear indicator for phishing. Additionally, in Postfix's main configuration file (main.cf) the variable `myhostname` should be set to something unsuspicious like a subdomain of your phishing domain (e.g. something like `mail.domain.com`)\n\nThe following is an example of how Postfix's `header_checks.cf` file can look like:\n\n```\n      /^Received:/ IGNORE\n      /^X-Mailer:/ IGNORE\n      /^Message-ID:/ IGNORE\n      /^User-Agent:/ IGNORE\n      /^X-Originating-IP:/    IGNORE\n      /^Mime-Version:/        IGNORE\n      /^In-Reply-To:/ IGNORE\n      /^References:/ IGNORE\n```\n\nAfter setting up the Gophish server, send some test mails and analyse custom or suspicious headers. It might help to grep for the used hostname, expressions like \"phish\" and anything related to the Gophish server's IP address or hostname.\n\n\n## Connections\n\nNow that the single components have been depicted, also the collaboration between the elements has to be defined.\n\n In the present infrastructure three connections between servers are needed:\n- C2-team-server to HTTPS-redirector (implant communication)\n- C2-team-server to DNS-redirector (implant communication)\n- Payload-server to HTTPS-redirector (stage-1-payload)\n\nThe connections from the internal network to the redirectors can be handled via ssh and remote port forwarding. In that way traffic can be forwarded in a comfortable and fast way. For this use case I implemented [Autossh](https://manpages.ubuntu.com/manpages/trusty/man1/autossh.1.html) as a service. Autossh makes sure that the connection is held up and if it is lost reconnects automatically. \n\nIt makes sense to establish Autossh as a service, as it is more stable. In the snippet below the service for a connection to the DNS-redirector is depicted:\n\n```\n[Unit]\nDescription=AutoSSH tunnel to DNS-Redirector\nAfter=network.target\n[Service]\nEnvironment=\"AUTOSSH_GATETIME=0\"\nExecStart=/usr/bin/autossh -M 0 -q -N -o \"ServerAliveInterval 60\" -o \"ServerAliveCountMax 3\" -R 5353:localhost:53 -i <SSH-KEY> <USER>@<DNS_Redirector_IP>\n[Install]\nWantedBy=multi-user.target\n```\n\nOf course, also other services or methods can be used, as long as these offers a stable connection and offers an automatic reconnection. An example for this would be Wireguard [[8](https://www.wireguard.com/)].\n\n\n## Automate Setup Process\n\nAs you do not want to set up every host by hand, automation is almost a must . This reduces mistakes and if done correctly it also saves a lot of time in case parts of the infrastructure have to be changed (which almost happens for every engagement). For this reason, a mixture between Terraform, Vagrant and Ansible can be used. \n\nI used these in the following way: Terraform for the setup of the AWS boxes, Vagrant for the setup of the boxes on the internal network and Ansible for automating the installation of software and everything else following after an installation of a machine's operation system. This included web servers, ssh connections, certificates, movement of files and more. Additionally, the three tools can be intertwined seamlessly and work together like a charm. Depending on the size of the infrastructure, it makes sense to create automation scripts in a modular way, for example with Ansible roles for each host. An example for automating a red team setup with Terraform and Digital Ocean can be found under this [blogpost](https://www.ired.team/offensive-security/red-team-infrastructure/automating-red-team-infrastructure-with-terraform).\n\n\n## Summary\n\nAs you can see the topic is a very broad one, with lots of branches and paths to go down. I tried to trim these to a minimum to keep the path clear and give an overview without diving too deep into the rabbit holes of different components. I hope I could answer the following questions.\n\n### What requirements have to be met?\n\nThe requirements can be divided into requirements related to functionality & performance, security & obfuscation and additional requirements not fitting the other two categories.\nThe infrastructure should be able to send and receive phishing mails, host files and allow C2 communication. All of this functionality should be protected from the target's blue team or other defensive tools (like Antivirus software) and has to work proper and stable. \n\n### What are the components a red team infrastructure consists of?\n\nThe main infrastructure can be divided into the phishing infrastructure and the C2-infrastructure. Each of these contains the main component (phishing/payload server or C2 server) and several redirectors. \n\nFor the C2-infrastructure, these are redirectors used to forward beacon traffic and protect the main C2 server. A minimum of two different redirectors are recommended, one for the main beacon traffic using a fast protocol like HTTPS and one backup channel using a more subtle protocol like DNS.\n\nThe mail infrastructure uses two redirectors in a row, one Postfix redirector to clean outgoing mail traffic and afterwards an MS Office365 instance to make the mail traffic look more trustworthy as well as to provide an inbox for potential responses. \n\n### What software can be used?\n\nThis question does not have a definitive answer, as it comes down to individual preferences and budget. Regarding the mail infrastructure there is more or less a definitive answer as Gophish is the de-facto industry standard nowadays. Paired with a Postfix redirector and a Microsoft Outlook instance as a mail relay it is in my opinion the best choice. \n\nThe choice of a C2-framework offers much more possibilities, as a decision has to be made between paid and open-source frameworks. For paid frameworks I would choose between Cobalt Strike, Brute Ratel or Nighthawk. In terms of free frameworks, at the current point in time, I would go with Sliver, Havoc or Mythic.\n\nFor redirectors for C2 traffic there would be the choice between Apache, Nginx or Caddy for the HTTPS redirector and Socat or IPtables for the DNS redirector.\n\n### Conclusion\n\nThis blog post serves as a base to create your own red team infrastructure and hopefully helps to give an overview on the different branches. Each branch can be explored deeper, which I might do in future blog posts focusing on single elements, but this should be enough for today. If you have questions or just want to chat about what you just read, do not hesitate and hit me up. \n\n## Links\n\n[[1](https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki)]: [https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki](https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki)\n[[2](https://medium.com/geekculture/an-nginx-apache-alternative-for-c2-redirecting-61e92a917101)]: [https://medium.com/geekculture/an-nginx-apache-alternative-for-c2-redirecting-61e92a917101](https://medium.com/geekculture/an-nginx-apache-alternative-for-c2-redirecting-61e92a917101) \n[[3](https://medium.com/@maxime.durand.54/add-the-geoip2-module-to-nginx-f0b56e015763)]: [https://medium.com/@maxime.durand.54/add-the-geoip2-module-to-nginx-f0b56e015763](https://medium.com/@maxime.durand.54/add-the-geoip2-module-to-nginx-f0b56e015763)\n[[4](https://www.cobaltstrike.com/blog/simple-dns-redirectors-for-cobalt-strike/)]: [https://www.cobaltstrike.com/blog/simple-dns-redirectors-for-cobalt-strike/](https://www.cobaltstrike.com/blog/simple-dns-redirectors-for-cobalt-strike/)\n[[5](https://labs.withsecure.com/publications/detecting-exposed-cobalt-strike-dns-redirectors)]: [https://labs.withsecure.com/publications/detecting-exposed-cobalt-strike-dns-redirectors](https://labs.withsecure.com/publications/detecting-exposed-cobalt-strike-dns-redirectors)\n[[6](https://github.com/BishopFox/sliver/wiki/DNS-C2)]: [https://github.com/BishopFox/sliver/wiki/DNS-C2](https://github.com/BishopFox/sliver/wiki/DNS-C2)\n[[7](https://docs.getgophish.com/user-guide/documentation/sending-profiles)]: [https://docs.getgophish.com/user-guide/documentation/sending-profiles](https://docs.getgophish.com/user-guide/documentation/sending-profiles)\n[[8](https://www.wireguard.com/)]: [https://www.wireguard.com/](https://www.wireguard.com/)\n","className":"","prefix":"/images/blog/building-a-red-team-infrastructure-in-2023/"}],"leftAlign":"left","right":null,"rightAlign":"left","fiftyFifty":false,"bgColor":"","className":"","additional":{"_sys":{"filename":"andre_tschapeller","basename":"andre_tschapeller.md","breadcrumbs":["andre_tschapeller"],"path":"content/author/andre_tschapeller.md","relativePath":"andre_tschapeller.md","extension":".md"},"id":"content/author/andre_tschapeller.md","name":"André Tschapeller","description":"André is passionate about creative attack paths and using systems in unintended ways, which he tries to include in assessments for our clients. He is part of our Offensive Security Team and mainly involved in web application security.","image":"/images/team/andre.jpg","title":"Senior Security Consultant","email":"andre.tschapeller@securesystems.de","phone":null,"twitter":"https://twitter.com/hipstertrojan","github":"https://github.com/hipstertrojan","linkedin":"https://de.linkedin.com/in/andre-tschapeller-70a206135","medium":"https://medium.com/@hipstertrojan","className":null}}],"author":{"id":"content/author/andre_tschapeller.md"}}},"variables":{"relativePath":"building-a-red-team-infrastructure-in-2023.md"},"authorConnection":{"data":{"authorConnection":{"totalCount":9,"edges":[{"node":{"_sys":{"filename":"andre_tschapeller","basename":"andre_tschapeller.md","breadcrumbs":["andre_tschapeller"],"path":"content/author/andre_tschapeller.md","relativePath":"andre_tschapeller.md","extension":".md"},"id":"content/author/andre_tschapeller.md","name":"André Tschapeller","description":"André is passionate about creative attack paths and using systems in unintended ways, which he tries to include in assessments for our clients. He is part of our Offensive Security Team and mainly involved in web application security.","image":"/images/team/andre.jpg","title":"Senior Security Consultant","email":"andre.tschapeller@securesystems.de","phone":null,"twitter":"https://twitter.com/hipstertrojan","github":"https://github.com/hipstertrojan","linkedin":"https://de.linkedin.com/in/andre-tschapeller-70a206135","medium":"https://medium.com/@hipstertrojan","className":null}},{"node":{"_sys":{"filename":"anneke_breust","basename":"anneke_breust.md","breadcrumbs":["anneke_breust"],"path":"content/author/anneke_breust.md","relativePath":"anneke_breust.md","extension":".md"},"id":"content/author/anneke_breust.md","name":"Anneke Breust","description":"Anneke is part of our Defensive Security Team. With a focus on application security, cloud infrastructure and cryptography, Anneke works closely with the development teams.","image":"/images/team/anneke.jpg","title":"Security Expert","email":"anneke.breust@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":null,"medium":null,"className":null}},{"node":{"_sys":{"filename":"bastian_kanbach","basename":"bastian_kanbach.md","breadcrumbs":["bastian_kanbach"],"path":"content/author/bastian_kanbach.md","relativePath":"bastian_kanbach.md","extension":".md"},"id":"content/author/bastian_kanbach.md","name":"Bastian Kanbach","description":"Bastian is part of our Offensive Security Team delivering tailored security assessments and Red Team exercises that fit the requirements of our clients. He specializes in network and infrastructure security.","image":"/images/team/bastian.jpg","title":"Senior Security Consultant","email":"bastian.kanbach@securesystems.de","phone":null,"twitter":"https://twitter.com/_bka_","github":"https://github.com/bka-dev","linkedin":"https://www.linkedin.com/in/bastian-kanbach/","medium":null,"className":null}},{"node":{"_sys":{"filename":"carsten_sandker","basename":"carsten_sandker.md","breadcrumbs":["carsten_sandker"],"path":"content/author/carsten_sandker.md","relativePath":"carsten_sandker.md","extension":".md"},"id":"content/author/carsten_sandker.md","name":"Carsten Sandker","description":"Carsten was part of our Offensive Security Team, helping our clients identify vulnerabilities and preventing attacks. He is specialized in Active Directory security and scenario-based attacks.","image":"/images/team/carsten.jpg","title":"Senior Security Consultant","email":"carsten.sandker@securesystems.de","phone":null,"twitter":"https://twitter.com/0xcsandker","github":"https://github.com/csandker","linkedin":"https://www.linkedin.com/in/carsten-sandker","medium":"https://medium.com/@csandker","className":null}},{"node":{"_sys":{"filename":"christoph_hamsen","basename":"christoph_hamsen.md","breadcrumbs":["christoph_hamsen"],"path":"content/author/christoph_hamsen.md","relativePath":"christoph_hamsen.md","extension":".md"},"id":"content/author/christoph_hamsen.md","name":"Dr. Christoph Hamsen","description":"Christoph is part of our Defensive Security Team supporting our clients to design, build and operate secure solutions.","image":"/images/team/christoph.jpg","title":"Senior Security Manager","email":"christoph.hamsen@securesystems.de","phone":null,"twitter":null,"github":"https://github.com/xopham","linkedin":"https://de.linkedin.com/in/hamsen","medium":null,"className":null}},{"node":{"_sys":{"filename":"peter_thomassen","basename":"peter_thomassen.md","breadcrumbs":["peter_thomassen"],"path":"content/author/peter_thomassen.md","relativePath":"peter_thomassen.md","extension":".md"},"id":"content/author/peter_thomassen.md","name":"Dr. Peter Thomassen","description":"Peter is passionate about creating security solutions for both individual enterprises and the Internet infrastructure in general. He has significant experience in designing Internet protocols and software systems.","image":"/images/team/peter.jpg","title":"Senior Solutions Architect","email":"peter.thomassen@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":"https://www.linkedin.com/in/dr-peter-thomassen-4400406a/","medium":null,"className":null}},{"node":{"_sys":{"filename":"philipp_belitz","basename":"philipp_belitz.md","breadcrumbs":["philipp_belitz"],"path":"content/author/philipp_belitz.md","relativePath":"philipp_belitz.md","extension":".md"},"id":"content/author/philipp_belitz.md","name":"Philipp Belitz","description":"As part of the Defensive Security Team, Philipp works closely with our clients, designing new concepts with security in mind and helping throughout whole development processes. He specializes in all topics surrounding Container Security and the Kubernetes ecosystem.","image":"/images/team/philipp.jpg","title":"Security Engineer","email":"philipp.belitz@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":"https://www.linkedin.com/in/philipp-belitz-41a65b187/","medium":null,"className":null}},{"node":{"_sys":{"filename":"teetje_stark","basename":"teetje_stark.md","breadcrumbs":["teetje_stark"],"path":"content/author/teetje_stark.md","relativePath":"teetje_stark.md","extension":".md"},"id":"content/author/teetje_stark.md","name":"Teetje Stark","description":"Teetje is a Security Expert at SSE. He is lead of our Defensive Security Team. As such he helps create secure applications both in design and implementation phase. He specializes in and is passionate about cryptography.","image":"/images/team/teetje.jpg","title":"Security Expert","email":"teetje.stark@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":null,"medium":null,"className":null}},{"node":{"_sys":{"filename":"tim_ohlendorf","basename":"tim_ohlendorf.md","breadcrumbs":["tim_ohlendorf"],"path":"content/author/tim_ohlendorf.md","relativePath":"tim_ohlendorf.md","extension":".md"},"id":"content/author/tim_ohlendorf.md","name":"Tim Ohlendorf","description":"Tim Ohlendorf was part of our Defense Security Team. He is a distinguished expert in the field of mobile device security and digital identity solutions with experience in commercial and public projects.","image":"/images/team/tim.jpg","title":"Senior Security Manager","email":"tim.ohlendorf@securesystems.de","phone":null,"twitter":null,"github":null,"linkedin":null,"medium":null,"className":null}}]}},"variables":{}},"navigationConnection":{"data":{"navigationConnection":{"totalCount":2,"edges":[{"node":{"_sys":{"filename":"footer","basename":"footer.md","breadcrumbs":["footer"],"path":"content/navigation/footer.md","relativePath":"footer.md","extension":".md"},"id":"content/navigation/footer.md","name":"Footer","blocks":[{"__typename":"NavigationBlocks_NavItem","label":"Service","url":"/","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Defensive Security","url":"/defensive-security-services/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Offensive Security","url":"/offensive-security-services/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Training & Awareness","url":"/training/","target":"_self","className":"","suffix":"Footer"}],"target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItem","label":"Contributions","url":"/engineering-and-contributions/","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"DNS Security","url":"/dns-security/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Connaisseur","url":"/connaisseur/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Public Suffix List","url":"/public-suffix-list/","target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Internet Architecture","url":"/internet-architecture/","target":"_self","className":"","suffix":"Footer"}],"target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItem","label":"About Us","url":"/about-us/","children":null,"target":"_self","className":"","suffix":"Footer"},{"__typename":"NavigationBlocks_NavItem","label":"Blog","url":"/blog/","children":null,"target":"_self","className":"","suffix":"Footer"}]}},{"node":{"_sys":{"filename":"header","basename":"header.md","breadcrumbs":["header"],"path":"content/navigation/header.md","relativePath":"header.md","extension":".md"},"id":"content/navigation/header.md","name":"Header","blocks":[{"__typename":"NavigationBlocks_NavItem","label":"Service","url":"","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Defensive Security","url":"/defensive-security-services/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Offensive Security","url":"/offensive-security-services/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Training & Awareness","url":"/training/","target":"_self","className":"","suffix":"Mobile"}],"target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItem","label":"Contributions","url":"/engineering-and-contributions/","children":[{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"DNS Security","url":"/dns-security/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Connaisseur","url":"/connaisseur/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Public Suffix List","url":"/public-suffix-list/","target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItemChildren_NavSubItem","label":"Internet Architecture","url":"/internet-architecture/","target":"_self","className":"","suffix":"Mobile"}],"target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItem","label":"Blog","url":"/blog/","children":null,"target":"_self","className":"","suffix":"Mobile"},{"__typename":"NavigationBlocks_NavItem","label":"About Us","url":"/about-us/","children":null,"target":"_self","className":"","suffix":"Mobile"}]}}]}},"variables":{}}},"__N_SSG":true},"page":"/blog/[filename]","buildId":"_Ba6vOXc9SzScRkVtmF5c","isFallback":false,"gsp":true,"scriptLoader":[]}</script><next-route-announcer><p aria-live="assertive" id="__next-route-announcer__" role="alert" style="border: 0px; clip: rect(0px, 0px, 0px, 0px); height: 1px; margin: -1px; overflow: hidden; padding: 0px; position: absolute; width: 1px; white-space: nowrap; overflow-wrap: normal;"></p></next-route-announcer><script src="/_next/static/chunks/pages/%5B%5B...filename%5D%5D-5aeeef54a3401ae4.js"></script></body></html>