<html lang="en" class="js"><head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<link rel="profile" href="https://gmpg.org/xfn/11">
	<link rel="pingback" href="https://scorpiosoftware.net/xmlrpc.php">
	<!--[if lt IE 9]>
	<script src="https://s0.wp.com/wp-content/themes/pub/twentyfifteen/js/html5.js?ver=3.7.0"></script>
	<![endif]-->
	<script type="text/javascript" async="" src="//widgets.wp.com/platform.js"></script><script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Pavel Yosifovich – Adventures in Coding, Internals and Learning</title>
<meta name="robots" content="max-image-preview:large">

<!-- Async WordPress.com Remote Login -->
<script id="wpcom_remote_login_js">
var wpcom_remote_login_extra_auth = '';
function wpcom_remote_login_remove_dom_node_id( element_id ) {
	var dom_node = document.getElementById( element_id );
	if ( dom_node ) { dom_node.parentNode.removeChild( dom_node ); }
}
function wpcom_remote_login_remove_dom_node_classes( class_name ) {
	var dom_nodes = document.querySelectorAll( '.' + class_name );
	for ( var i = 0; i < dom_nodes.length; i++ ) {
		dom_nodes[ i ].parentNode.removeChild( dom_nodes[ i ] );
	}
}
function wpcom_remote_login_final_cleanup() {
	wpcom_remote_login_remove_dom_node_classes( "wpcom_remote_login_msg" );
	wpcom_remote_login_remove_dom_node_id( "wpcom_remote_login_key" );
	wpcom_remote_login_remove_dom_node_id( "wpcom_remote_login_validate" );
	wpcom_remote_login_remove_dom_node_id( "wpcom_remote_login_js" );
	wpcom_remote_login_remove_dom_node_id( "wpcom_request_access_iframe" );
	wpcom_remote_login_remove_dom_node_id( "wpcom_request_access_styles" );
}

// Watch for messages back from the remote login
window.addEventListener( "message", function( e ) {
	if ( e.origin === "https://r-login.wordpress.com" ) {
		var data = {};
		try {
			data = JSON.parse( e.data );
		} catch( e ) {
			wpcom_remote_login_final_cleanup();
			return;
		}

		if ( data.msg === 'LOGIN' ) {
			// Clean up the login check iframe
			wpcom_remote_login_remove_dom_node_id( "wpcom_remote_login_key" );

			var id_regex = new RegExp( /^[0-9]+$/ );
			var token_regex = new RegExp( /^.*|.*|.*$/ );
			if (
				token_regex.test( data.token )
				&& id_regex.test( data.wpcomid )
			) {
				// We have everything we need to ask for a login
				var script = document.createElement( "script" );
				script.setAttribute( "id", "wpcom_remote_login_validate" );
				script.src = '/remote-login.php?wpcom_remote_login=validate'
					+ '&wpcomid=' + data.wpcomid
					+ '&token=' + encodeURIComponent( data.token )
					+ '&host=' + window.location.protocol
					+ '//' + window.location.hostname
					+ '&postid=2115'
					+ '&is_singular=';
				document.body.appendChild( script );
			}

			return;
		}

		// Safari ITP, not logged in, so redirect
		if ( data.msg === 'LOGIN-REDIRECT' ) {
			window.location = 'https://wordpress.com/log-in?redirect_to=' + window.location.href;
			return;
		}

		// Safari ITP, storage access failed, remove the request
		if ( data.msg === 'LOGIN-REMOVE' ) {
			var css_zap = 'html { -webkit-transition: margin-top 1s; transition: margin-top 1s; } /* 9001 */ html { margin-top: 0 !important; } * html body { margin-top: 0 !important; } @media screen and ( max-width: 782px ) { html { margin-top: 0 !important; } * html body { margin-top: 0 !important; } }';
			var style_zap = document.createElement( 'style' );
			style_zap.type = 'text/css';
			style_zap.appendChild( document.createTextNode( css_zap ) );
			document.body.appendChild( style_zap );

			var e = document.getElementById( 'wpcom_request_access_iframe' );
			e.parentNode.removeChild( e );

			document.cookie = 'wordpress_com_login_access=denied; path=/; max-age=31536000';

			return;
		}

		// Safari ITP
		if ( data.msg === 'REQUEST_ACCESS' ) {
			console.log( 'request access: safari' );

			// Check ITP iframe enable/disable knob
			if ( wpcom_remote_login_extra_auth !== 'safari_itp_iframe' ) {
				return;
			}

			// If we are in a "private window" there is no ITP.
			var private_window = false;
			try {
				var opendb = window.openDatabase( null, null, null, null );
			} catch( e ) {
				private_window = true;
			}

			if ( private_window ) {
				console.log( 'private window' );
				return;
			}

			var iframe = document.createElement( 'iframe' );
			iframe.id = 'wpcom_request_access_iframe';
			iframe.setAttribute( 'scrolling', 'no' );
			iframe.setAttribute( 'sandbox', 'allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-top-navigation-by-user-activation' );
			iframe.src = 'https://r-login.wordpress.com/remote-login.php?wpcom_remote_login=request_access&origin=' + encodeURIComponent( data.origin ) + '&wpcomid=' + encodeURIComponent( data.wpcomid );

			var css = 'html { -webkit-transition: margin-top 1s; transition: margin-top 1s; } /* 9001 */ html { margin-top: 46px !important; } * html body { margin-top: 46px !important; } @media screen and ( max-width: 660px ) { html { margin-top: 71px !important; } * html body { margin-top: 71px !important; } #wpcom_request_access_iframe { display: block; height: 71px !important; } } #wpcom_request_access_iframe { border: 0px; height: 46px; position: fixed; top: 0; left: 0; width: 100%; min-width: 100%; z-index: 99999; background: #23282d; } ';

			var style = document.createElement( 'style' );
			style.type = 'text/css';
			style.id = 'wpcom_request_access_styles';
			style.appendChild( document.createTextNode( css ) );
			document.body.appendChild( style );

			document.body.appendChild( iframe );
		}

		if ( data.msg === 'DONE' ) {
			wpcom_remote_login_final_cleanup();
		}
	}
}, false );

// Inject the remote login iframe after the page has had a chance to load
// more critical resources
window.addEventListener( "DOMContentLoaded", function( e ) {
	var iframe = document.createElement( "iframe" );
	iframe.style.display = "none";
	iframe.setAttribute( "scrolling", "no" );
	iframe.setAttribute( "id", "wpcom_remote_login_key" );
	iframe.src = "https://r-login.wordpress.com/remote-login.php"
		+ "?wpcom_remote_login=key"
		+ "&origin=aHR0cHM6Ly9zY29ycGlvc29mdHdhcmUubmV0"
		+ "&wpcomid=143820068"
		+ "&time=1718432680";
	document.body.appendChild( iframe );
}, false );
</script>
<link rel="dns-prefetch" href="//s0.wp.com">
<link rel="alternate" type="application/rss+xml" title="Pavel Yosifovich » Feed" href="https://scorpiosoftware.net/feed/">
<link rel="alternate" type="application/rss+xml" title="Pavel Yosifovich » Comments Feed" href="https://scorpiosoftware.net/comments/feed/">
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
	<script>
window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s0.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1710334132i&ver=6.6-beta2-58412"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!n(e,"\ud83c\uddfa\ud83c\uddf3","\ud83c\uddfa\u200b\ud83c\uddf3")&&!n(e,"\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!n(e,"\ud83d\udc26\u200d\u2b1b","\ud83d\udc26\u200b\u2b1b")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
</script>
<link crossorigin="anonymous" rel="stylesheet" id="all-css-0-1" href="https://s0.wp.com/_static/??-eJyVjFsKwjAQAC9kXIJU6od4lhI3unUfwd1Qentb0AP4MzAfM7C0VEwDNUB6atwfpA4zRpvK6+sgZjvundEhniiYwowdikmbAmLZ+rVSDUQ9FvcD/P8lraQUmLy8jfnn6/67yTWfxyGf8ngZ5g/JHUQb&amp;cssminify=yes" type="text/css" media="all">
<style id="wp-emoji-styles-inline-css">

	img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}
</style>
<link crossorigin="anonymous" rel="stylesheet" id="all-css-2-1" href="https://s0.wp.com/_static/??-eJylzFsKgCAQQNENlcNAD3+itaQNZo0WPgp3n7SFPi8XDjxXq0+fyCe4OBvrI5hcU1Ew9QSCG6XoBILKlldQfOqjZavCEgrEVJiEjrGBf1DayH3Q7CYccehHib3cXybLOGM=&amp;cssminify=yes" type="text/css" media="all">
<style id="wp-block-library-inline-css">
.has-text-align-justify {
	text-align:justify;
}
.has-text-align-justify{text-align:justify;}
</style>
<link crossorigin="anonymous" rel="stylesheet" id="all-css-4-1" href="https://s0.wp.com/_static/??-eJzTLy/QzcxLzilNSS3WzyrWz01NyUxMzUnNTc0rQeEU5CRWphbp5qSmJyZX6uVm5uklFxfr6OPTDpRD5sM02efaGpoZmFkYGRuZGmQBAHPvL0Y=&amp;cssminify=yes" type="text/css" media="all">
<style id="jetpack-sharing-buttons-style-inline-css">
.jetpack-sharing-buttons__services-list{display:flex;flex-direction:row;flex-wrap:wrap;gap:0;list-style-type:none;margin:5px;padding:0}.jetpack-sharing-buttons__services-list.has-small-icon-size{font-size:12px}.jetpack-sharing-buttons__services-list.has-normal-icon-size{font-size:16px}.jetpack-sharing-buttons__services-list.has-large-icon-size{font-size:24px}.jetpack-sharing-buttons__services-list.has-huge-icon-size{font-size:36px}@media print{.jetpack-sharing-buttons__services-list{display:none!important}}.editor-styles-wrapper .wp-block-jetpack-sharing-buttons{gap:0;padding-inline-start:0}ul.jetpack-sharing-buttons__services-list.has-background{padding:1.25em 2.375em}
</style>
<link crossorigin="anonymous" rel="stylesheet" id="all-css-6-1" href="https://s0.wp.com/_static/??-eJyVjEEOwiAQAD/ksgGN4sH4Fko3hJYCYZea/r49mF6Nx0lmBj8VfMlCWbCmHmJmDP3AgVqAIRU/M04k1fkZkttKFwgtjsiyJVKe+YL/LJqTmAP/yH35ZkZpqzRwXGoiaLSqG46R5TTgHL2Xl75bba/GPB/TDthVT3U=&amp;cssminify=yes" type="text/css" media="all">
<style id="classic-theme-styles-inline-css">
/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}
</style>
<link crossorigin="anonymous" rel="stylesheet" id="all-css-8-1" href="https://s0.wp.com/_static/??/wp-content/mu-plugins/core-compat/wp-mediaelement.css,/wp-content/mu-plugins/wpcom-bbpress-premium-themes.css?m=1432920480j&amp;cssminify=yes" type="text/css" media="all">
<style id="global-styles-inline-css">
:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #fff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--color--dark-gray: #111;--wp--preset--color--light-gray: #f1f1f1;--wp--preset--color--yellow: #f4ca16;--wp--preset--color--dark-brown: #352712;--wp--preset--color--medium-pink: #e53b51;--wp--preset--color--light-pink: #ffe5d1;--wp--preset--color--dark-purple: #2e2256;--wp--preset--color--purple: #674970;--wp--preset--color--blue-gray: #22313f;--wp--preset--color--bright-blue: #55c3dc;--wp--preset--color--light-blue: #e9f2f9;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--gradient--dark-gray-gradient-gradient: linear-gradient(90deg, rgba(17,17,17,1) 0%, rgba(42,42,42,1) 100%);--wp--preset--gradient--light-gray-gradient: linear-gradient(90deg, rgba(241,241,241,1) 0%, rgba(215,215,215,1) 100%);--wp--preset--gradient--white-gradient: linear-gradient(90deg, rgba(255,255,255,1) 0%, rgba(230,230,230,1) 100%);--wp--preset--gradient--yellow-gradient: linear-gradient(90deg, rgba(244,202,22,1) 0%, rgba(205,168,10,1) 100%);--wp--preset--gradient--dark-brown-gradient: linear-gradient(90deg, rgba(53,39,18,1) 0%, rgba(91,67,31,1) 100%);--wp--preset--gradient--medium-pink-gradient: linear-gradient(90deg, rgba(229,59,81,1) 0%, rgba(209,28,51,1) 100%);--wp--preset--gradient--light-pink-gradient: linear-gradient(90deg, rgba(255,229,209,1) 0%, rgba(255,200,158,1) 100%);--wp--preset--gradient--dark-purple-gradient: linear-gradient(90deg, rgba(46,34,86,1) 0%, rgba(66,48,123,1) 100%);--wp--preset--gradient--purple-gradient: linear-gradient(90deg, rgba(103,73,112,1) 0%, rgba(131,93,143,1) 100%);--wp--preset--gradient--blue-gray-gradient: linear-gradient(90deg, rgba(34,49,63,1) 0%, rgba(52,75,96,1) 100%);--wp--preset--gradient--bright-blue-gradient: linear-gradient(90deg, rgba(85,195,220,1) 0%, rgba(43,180,211,1) 100%);--wp--preset--gradient--light-blue-gradient: linear-gradient(90deg, rgba(233,242,249,1) 0%, rgba(193,218,238,1) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--font-family--albert-sans: 'Albert Sans', sans-serif;--wp--preset--font-family--alegreya: Alegreya, serif;--wp--preset--font-family--arvo: Arvo, serif;--wp--preset--font-family--bodoni-moda: 'Bodoni Moda', serif;--wp--preset--font-family--bricolage-grotesque: 'Bricolage Grotesque', sans-serif;--wp--preset--font-family--cabin: Cabin, sans-serif;--wp--preset--font-family--chivo: Chivo, sans-serif;--wp--preset--font-family--commissioner: Commissioner, sans-serif;--wp--preset--font-family--cormorant: Cormorant, serif;--wp--preset--font-family--courier-prime: 'Courier Prime', monospace;--wp--preset--font-family--crimson-pro: 'Crimson Pro', serif;--wp--preset--font-family--dm-mono: 'DM Mono', monospace;--wp--preset--font-family--dm-sans: 'DM Sans', sans-serif;--wp--preset--font-family--dm-serif-display: 'DM Serif Display', serif;--wp--preset--font-family--domine: Domine, serif;--wp--preset--font-family--eb-garamond: 'EB Garamond', serif;--wp--preset--font-family--epilogue: Epilogue, sans-serif;--wp--preset--font-family--fahkwang: Fahkwang, sans-serif;--wp--preset--font-family--figtree: Figtree, sans-serif;--wp--preset--font-family--fira-sans: 'Fira Sans', sans-serif;--wp--preset--font-family--fjalla-one: 'Fjalla One', sans-serif;--wp--preset--font-family--fraunces: Fraunces, serif;--wp--preset--font-family--gabarito: Gabarito, system-ui;--wp--preset--font-family--ibm-plex-mono: 'IBM Plex Mono', monospace;--wp--preset--font-family--ibm-plex-sans: 'IBM Plex Sans', sans-serif;--wp--preset--font-family--ibarra-real-nova: 'Ibarra Real Nova', serif;--wp--preset--font-family--instrument-serif: 'Instrument Serif', serif;--wp--preset--font-family--inter: Inter, sans-serif;--wp--preset--font-family--josefin-sans: 'Josefin Sans', sans-serif;--wp--preset--font-family--jost: Jost, sans-serif;--wp--preset--font-family--libre-baskerville: 'Libre Baskerville', serif;--wp--preset--font-family--libre-franklin: 'Libre Franklin', sans-serif;--wp--preset--font-family--literata: Literata, serif;--wp--preset--font-family--lora: Lora, serif;--wp--preset--font-family--merriweather: Merriweather, serif;--wp--preset--font-family--montserrat: Montserrat, sans-serif;--wp--preset--font-family--newsreader: Newsreader, serif;--wp--preset--font-family--noto-sans-mono: 'Noto Sans Mono', sans-serif;--wp--preset--font-family--nunito: Nunito, sans-serif;--wp--preset--font-family--open-sans: 'Open Sans', sans-serif;--wp--preset--font-family--overpass: Overpass, sans-serif;--wp--preset--font-family--pt-serif: 'PT Serif', serif;--wp--preset--font-family--petrona: Petrona, serif;--wp--preset--font-family--piazzolla: Piazzolla, serif;--wp--preset--font-family--playfair-display: 'Playfair Display', serif;--wp--preset--font-family--plus-jakarta-sans: 'Plus Jakarta Sans', sans-serif;--wp--preset--font-family--poppins: Poppins, sans-serif;--wp--preset--font-family--raleway: Raleway, sans-serif;--wp--preset--font-family--roboto: Roboto, sans-serif;--wp--preset--font-family--roboto-slab: 'Roboto Slab', serif;--wp--preset--font-family--rubik: Rubik, sans-serif;--wp--preset--font-family--rufina: Rufina, serif;--wp--preset--font-family--sora: Sora, sans-serif;--wp--preset--font-family--source-sans-3: 'Source Sans 3', sans-serif;--wp--preset--font-family--source-serif-4: 'Source Serif 4', serif;--wp--preset--font-family--space-mono: 'Space Mono', monospace;--wp--preset--font-family--syne: Syne, sans-serif;--wp--preset--font-family--texturina: Texturina, serif;--wp--preset--font-family--urbanist: Urbanist, sans-serif;--wp--preset--font-family--work-sans: 'Work Sans', sans-serif;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}.has-albert-sans-font-family{font-family: var(--wp--preset--font-family--albert-sans) !important;}.has-alegreya-font-family{font-family: var(--wp--preset--font-family--alegreya) !important;}.has-arvo-font-family{font-family: var(--wp--preset--font-family--arvo) !important;}.has-bodoni-moda-font-family{font-family: var(--wp--preset--font-family--bodoni-moda) !important;}.has-bricolage-grotesque-font-family{font-family: var(--wp--preset--font-family--bricolage-grotesque) !important;}.has-cabin-font-family{font-family: var(--wp--preset--font-family--cabin) !important;}.has-chivo-font-family{font-family: var(--wp--preset--font-family--chivo) !important;}.has-commissioner-font-family{font-family: var(--wp--preset--font-family--commissioner) !important;}.has-cormorant-font-family{font-family: var(--wp--preset--font-family--cormorant) !important;}.has-courier-prime-font-family{font-family: var(--wp--preset--font-family--courier-prime) !important;}.has-crimson-pro-font-family{font-family: var(--wp--preset--font-family--crimson-pro) !important;}.has-dm-mono-font-family{font-family: var(--wp--preset--font-family--dm-mono) !important;}.has-dm-sans-font-family{font-family: var(--wp--preset--font-family--dm-sans) !important;}.has-dm-serif-display-font-family{font-family: var(--wp--preset--font-family--dm-serif-display) !important;}.has-domine-font-family{font-family: var(--wp--preset--font-family--domine) !important;}.has-eb-garamond-font-family{font-family: var(--wp--preset--font-family--eb-garamond) !important;}.has-epilogue-font-family{font-family: var(--wp--preset--font-family--epilogue) !important;}.has-fahkwang-font-family{font-family: var(--wp--preset--font-family--fahkwang) !important;}.has-figtree-font-family{font-family: var(--wp--preset--font-family--figtree) !important;}.has-fira-sans-font-family{font-family: var(--wp--preset--font-family--fira-sans) !important;}.has-fjalla-one-font-family{font-family: var(--wp--preset--font-family--fjalla-one) !important;}.has-fraunces-font-family{font-family: var(--wp--preset--font-family--fraunces) !important;}.has-gabarito-font-family{font-family: var(--wp--preset--font-family--gabarito) !important;}.has-ibm-plex-mono-font-family{font-family: var(--wp--preset--font-family--ibm-plex-mono) !important;}.has-ibm-plex-sans-font-family{font-family: var(--wp--preset--font-family--ibm-plex-sans) !important;}.has-ibarra-real-nova-font-family{font-family: var(--wp--preset--font-family--ibarra-real-nova) !important;}.has-instrument-serif-font-family{font-family: var(--wp--preset--font-family--instrument-serif) !important;}.has-inter-font-family{font-family: var(--wp--preset--font-family--inter) !important;}.has-josefin-sans-font-family{font-family: var(--wp--preset--font-family--josefin-sans) !important;}.has-jost-font-family{font-family: var(--wp--preset--font-family--jost) !important;}.has-libre-baskerville-font-family{font-family: var(--wp--preset--font-family--libre-baskerville) !important;}.has-libre-franklin-font-family{font-family: var(--wp--preset--font-family--libre-franklin) !important;}.has-literata-font-family{font-family: var(--wp--preset--font-family--literata) !important;}.has-lora-font-family{font-family: var(--wp--preset--font-family--lora) !important;}.has-merriweather-font-family{font-family: var(--wp--preset--font-family--merriweather) !important;}.has-montserrat-font-family{font-family: var(--wp--preset--font-family--montserrat) !important;}.has-newsreader-font-family{font-family: var(--wp--preset--font-family--newsreader) !important;}.has-noto-sans-mono-font-family{font-family: var(--wp--preset--font-family--noto-sans-mono) !important;}.has-nunito-font-family{font-family: var(--wp--preset--font-family--nunito) !important;}.has-open-sans-font-family{font-family: var(--wp--preset--font-family--open-sans) !important;}.has-overpass-font-family{font-family: var(--wp--preset--font-family--overpass) !important;}.has-pt-serif-font-family{font-family: var(--wp--preset--font-family--pt-serif) !important;}.has-petrona-font-family{font-family: var(--wp--preset--font-family--petrona) !important;}.has-piazzolla-font-family{font-family: var(--wp--preset--font-family--piazzolla) !important;}.has-playfair-display-font-family{font-family: var(--wp--preset--font-family--playfair-display) !important;}.has-plus-jakarta-sans-font-family{font-family: var(--wp--preset--font-family--plus-jakarta-sans) !important;}.has-poppins-font-family{font-family: var(--wp--preset--font-family--poppins) !important;}.has-raleway-font-family{font-family: var(--wp--preset--font-family--raleway) !important;}.has-roboto-font-family{font-family: var(--wp--preset--font-family--roboto) !important;}.has-roboto-slab-font-family{font-family: var(--wp--preset--font-family--roboto-slab) !important;}.has-rubik-font-family{font-family: var(--wp--preset--font-family--rubik) !important;}.has-rufina-font-family{font-family: var(--wp--preset--font-family--rufina) !important;}.has-sora-font-family{font-family: var(--wp--preset--font-family--sora) !important;}.has-source-sans-3-font-family{font-family: var(--wp--preset--font-family--source-sans-3) !important;}.has-source-serif-4-font-family{font-family: var(--wp--preset--font-family--source-serif-4) !important;}.has-space-mono-font-family{font-family: var(--wp--preset--font-family--space-mono) !important;}.has-syne-font-family{font-family: var(--wp--preset--font-family--syne) !important;}.has-texturina-font-family{font-family: var(--wp--preset--font-family--texturina) !important;}.has-urbanist-font-family{font-family: var(--wp--preset--font-family--urbanist) !important;}.has-work-sans-font-family{font-family: var(--wp--preset--font-family--work-sans) !important;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
:where(.wp-block-pullquote){font-size: 1.5em;line-height: 1.6;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
</style>
<link rel="stylesheet" id="twentyfifteen-fonts-css" href="https://s0.wp.com/wp-content/themes/pub/twentyfifteen/assets/fonts/noto-sans-plus-noto-serif-plus-inconsolata.css?ver=20230328" media="all">
<link crossorigin="anonymous" rel="stylesheet" id="all-css-12-1" href="https://s0.wp.com/_static/??-eJyNjbEOwjAQQ3+IYhWlFQyIT0H0dC1pk0vEXVT174lQBwYGNtt6trHmhpIYiyGWJocyeVHMbPlBy+4RUxLcvRAmFn752tDf8kiqB3yN2pMjK3IZYGsNttGPxixQ2wL/j1cQQ0i0fC5u8dr25649XZxz8xtDC0n5&amp;cssminify=yes" type="text/css" media="all">
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentyfifteen-ie-css' href='https://s0.wp.com/wp-content/themes/pub/twentyfifteen/css/ie.css?m=1683318229i&#038;ver=20220908' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentyfifteen-ie7-css' href='https://s0.wp.com/wp-content/themes/pub/twentyfifteen/css/ie7.css?m=1418225460i&#038;ver=20141210' media='all' />
<![endif]-->
<link crossorigin="anonymous" rel="stylesheet" id="all-css-16-1" href="https://s0.wp.com/_static/??-eJx9j9EKwjAMRX/IGoZM5oP4LVtNa2balDVl7O/tRNG97CXkXDgJF+ZkrETFqKAPDJghlQF0rsHiyCliBJszZF0YzZyshGPlA/yJoZjExVPM4FEMi+2VJG7AOO5p2lMnHFh8Xf374Q/3pBE19fb5YQgi67gXrkUoOoqkaLKdhPnbb9NtvX0L1+bctc2p6S7t+AI4jGdL&amp;cssminify=yes" type="text/css" media="all">
<style id="jetpack-global-styles-frontend-style-inline-css">
:root { --font-headings: unset; --font-base: unset; --font-headings-default: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif; --font-base-default: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;}
</style>
<link crossorigin="anonymous" rel="stylesheet" id="all-css-18-1" href="https://s0.wp.com/wp-content/themes/h4/global.css?m=1420737423i&amp;cssminify=yes" type="text/css" media="all">
<script id="media-video-jwt-bridge-js-extra">
var videopressAjax = {"ajaxUrl":"https:\/\/zodiacon.wordpress.com\/wp-admin\/admin-ajax.php","bridgeUrl":"\/wp-content\/mu-plugins\/jetpack-plugin\/moon\/jetpack_vendor\/automattic\/jetpack-videopress\/build\/lib\/token-bridge.js","post_id":"2115"};
</script>
<script id="wpcom-actionbar-placeholder-js-extra">
var actionbardata = {"siteID":"143820068","postID":"0","siteURL":"https:\/\/scorpiosoftware.net","xhrURL":"https:\/\/scorpiosoftware.net\/wp-admin\/admin-ajax.php","nonce":"e9720d39f2","isLoggedIn":"","statusMessage":"","subsEmailDefault":"instantly","proxyScriptUrl":"https:\/\/s0.wp.com\/wp-content\/js\/wpcom-proxy-request.js?ver=20211021","i18n":{"followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/read\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar"}};
</script>
<script crossorigin="anonymous" type="text/javascript" src="https://s0.wp.com/_static/??-eJyFjsEOwjAMQ3+IrtsBTRwQn4LaNUzp2qS06WB/z5A2BCdOVuxnOfqR1MAkQKJ90ZEtBlC1QDbj6imkGze+HPQvl4OolPm57BnSEKqD8g79vUJeNmki0l9IRRyzEfiG97VYVQp1RFo7IMkM03avzzLt3nUGcpy1qcLRiODwoWd0wClDKdpWDE4HtFp4AlI2oxthXbzEc9e3bdt3x1PrX89xZ2Y="></script>
<script id="rlt-proxy-js-after">
	window.addEventListener( 'DOMContentLoaded', function() {
		rltInitialize( {"token":null,"iframeOrigins":["https:\/\/widgets.wp.com"]} );
	} );
</script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://zodiacon.wordpress.com/xmlrpc.php?rsd">
<meta name="generator" content="WordPress.com">
<link rel="shortlink" href="https://wp.me/9Jsaw">

<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="website">
<meta property="og:title" content="Pavel Yosifovich">
<meta property="og:description" content="Adventures in Coding, Internals and Learning">
<meta property="og:url" content="https://scorpiosoftware.net/">
<meta property="og:site_name" content="Pavel Yosifovich">
<meta property="og:image" content="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=200">
<meta property="og:image:width" content="200">
<meta property="og:image:height" content="200">
<meta property="og:image:alt" content="">
<meta property="og:locale" content="en_US">

<!-- End Jetpack Open Graph Tags -->
<link rel="search" type="application/opensearchdescription+xml" href="https://scorpiosoftware.net/osd.xml" title="Pavel Yosifovich">
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com">
<meta name="theme-color" content="#043866">
<meta name="application-name" content="Pavel Yosifovich"><meta name="msapplication-window" content="width=device-width;height=device-height"><meta name="msapplication-tooltip" content="Adventures in Coding, Internals and Learning"><meta name="description" content="Adventures in Coding, Internals and Learning">
<style id="custom-background-css">
body.custom-background { background-color: #043866; }
</style>
	<style type="text/css" id="custom-colors-css">	.small-screen .widget button,
	.small-screen .widget input[type="button"],
	.small-screen .widget input[type="reset"],
	.small-screen .widget input[type="submit"],
	.small-screen .widget_calendar tbody a,
	.small-screen .widget_calendar tbody a:hover,
	.small-screen .widget_calendar tbody a:focus {
		color: #fff;
	}

	.small-screen .widget button,
	.small-screen .widget input[type="button"],
	.small-screen .widget input[type="reset"],
	.small-screen .widget input[type="submit"],
	.small-screen .widget_calendar tbody a {
		background-color: #333;
	}

	.small-screen .secondary a,
	.small-screen .dropdown-toggle:after,
	.small-screen .widget-title,
	.small-screen .widget blockquote cite,
	.small-screen .widget blockquote small {
		color: #333;
	}

	.small-screen .textwidget a {
		border-color: #333;
	}

	.small-screen .widget button:hover,
	.small-screen .widget button:focus,
	.small-screen .widget input[type="button"]:hover,
	.small-screen .widget input[type="button"]:focus,
	.small-screen .widget input[type="reset"]:hover,
	.small-screen .widget input[type="reset"]:focus,
	.small-screen .widget input[type="submit"]:hover,
	.small-screen .widget input[type="submit"]:focus,
	.small-screen .widget_calendar tbody a:hover,
	.small-screen .widget_calendar tbody a:focus {
		background-color: #707070;
		background-color: rgba(51, 51, 51, 0.7);
	}

	.small-screen .secondary a:hover,
	.small-screen .secondary a:focus,
	.small-screen .main-navigation .menu-item-description,
	.small-screen .widget,
	.small-screen .widget blockquote,
	.small-screen .widget .wp-caption-text,
	.small-screen .widget .gallery-caption {
		color: #707070;
		color: rgba(51, 51, 51, 0.7);
	}

	.small-screen .widget blockquote {
		border-color: #707070;
		border-color: rgba(51, 51, 51, 0.7);
	}

	.small-screen .widget input:focus,
	.small-screen .widget textarea:focus {
		border-color: #c1c1c1;
		border-color: rgba(51, 51, 51, 0.3);
	}

	.small-screen .sidebar a:focus,
	.small-screen .dropdown-toggle:focus {
		outline-color: #c1c1c1;
		outline-color: rgba(51, 51, 51, 0.3);
	}

	.small-screen .main-navigation ul,
	.small-screen .main-navigation li,
	.small-screen .widget input,
	.small-screen .widget textarea,
	.small-screen .widget table,
	.small-screen .widget th,
	.small-screen .widget td,
	.small-screen .widget pre,
	.small-screen .widget li,
	.small-screen .widget ul ul,
	.small-screen .widget_categories .children,
	.small-screen .widget_nav_menu .sub-menu,
	.small-screen .widget_pages .children,
	.small-screen .widget abbr[title]	{
		border-color: #eaeaea;
		border-color: rgba(51, 51, 51, 0.1);
	}

	.small-screen .dropdown-toggle:hover,
	.small-screen .dropdown-toggle:focus,
	.small-screen .widget hr {
		background-color: #eaeaea;
		background-color: rgba(51, 51, 51, 0.1);
	}

	.small-screen .widget-area .milestone-header,
	.small-screen .widget-area .milestone-countdown,
	.small-screen .widget-area .milestone-message {
		border-color: #eaeaea;
		border-color: rgba(51, 51, 51, 0.1);
		color: inherit;
	}

	.small-screen .milestone-widget .event,
	.small-screen .milestone-widget .difference {
		color: #333;
	}
body { background-color: #043866;}
body:before,
		.small-screen .site-header { background-color: #ffffff;}
.widget button,
		.widget input[type="button"],
		.widget input[type="reset"],
		.widget input[type="submit"],
		.widget_calendar tbody a,
		.widget_calendar tbody a:hover,
		.widget_calendar tbody a:focus { color: #ffffff;}
.secondary-toggle:hover,
		.secondary-toggle:focus,
		.widget input:focus,
		.widget textarea:focus { border-color: #D8D8D8;}
.site-title a,
		.sidebar a:focus,
		.dropdown-toggle:focus { outline-color: #D8D8D8;}
.main-navigation ul,
		.main-navigation li,
		.secondary-toggle,
		.widget input,
		.widget textarea,
		.widget table,
		.widget th,
		.widget td,
		.widget pre,
		.widget li,
		.widget ul ul,
		.widget_categories .children,
		.widget_nav_menu .sub-menu,
		.widget_pages .children,
		.widget abbr[title],
		.widget-area .milestone-header,
		.widget-area .milestone-countdown,
		.widget-area .milestone-message { border-color: #EAEAEA;}
.dropdown-toggle:hover,
		.dropdown-toggle:focus,
		.widget hr { background-color: #EAEAEA;}
.widget button,
		.widget input[type="button"],
		.widget input[type="reset"],
		.widget input[type="submit"],
		.widget_calendar tbody a { background-color: #333333;}
.site-title a,
		.site-description,
		.secondary-toggle,
		.secondary-toggle:before,
		.secondary a,
		.dropdown-toggle:after,
		.widget-title,
		.widget blockquote cite,
		.widget blockquote small,
		.milestone-widget .event,
		.milestone-widget .difference { color: #333333;}
.textwidget a,
		.widget_gravatar a { border-color: #333333;}
.widget button:hover,
		.widget button:focus,
		.widget input[type="button"]:hover,
		.widget input[type="button"]:focus,
		.widget input[type="reset"]:hover,
		.widget input[type="reset"]:focus,
		.widget input[type="submit"]:hover,
		.widget input[type="submit"]:focus,
		.widget_calendar tbody a:hover,
		.widget_calendar tbody a:focus { background-color: #707070;}
.site-title a:hover,
		.site-title a:focus,
		.secondary a:hover,
		.secondary a:focus,
		.main-navigation .menu-item-description,
		.widget,
		.widget blockquote,
		.widget .wp-caption-text,
		.widget .gallery-caption { color: #707070;}
.widget blockquote { border-color: #707070;}
</style>
<link rel="icon" href="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=32" sizes="32x32">
<link rel="icon" href="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=192" sizes="192x192">
<link rel="apple-touch-icon" href="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=180">
<meta name="msapplication-TileImage" content="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=270">
<!-- Your Google Analytics Plugin is missing the tracking ID -->
<link rel="stylesheet" type="text/css" href="https://s0.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b"><link rel="stylesheet" type="text/css" href="https://s0.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?m=1363304414i&amp;amp;ver=3.0.9b"><link rel="stylesheet" id="gravatar-card-css" href="https://0.gravatar.com/js/hovercards/hovercards.min.css?ver=2024244cee4591fae4bea45ee2571078613ea2fab8a404a7b5ceb1cf2b511ebc67fadd"><link href="https://s0.wp.com/wp-content/mu-plugins/actionbar/actionbar.css?v=20240115" type="text/css" rel="stylesheet"></head>

<body class="home blog custom-background wp-custom-logo wp-embed-responsive customizer-styles-applied jetpack-reblog-enabled has-site-logo custom-colors infinite-scroll neverending">
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">
		Skip to content	</a>

	<div id="sidebar" class="sidebar" style="position: relative;">
		<header id="masthead" class="site-header" role="banner">
			<div class="site-branding">
				<a href="https://scorpiosoftware.net/" class="site-logo-link" rel="home" itemprop="url"><img width="204" height="272" src="https://scorpiosoftware.net/wp-content/uploads/2018/08/beeker.png?w=204" class="site-logo attachment-twentyfifteen-logo" alt="" decoding="async" data-size="twentyfifteen-logo" itemprop="logo" data-attachment-id="29" data-permalink="https://scorpiosoftware.net/beeker/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2018/08/beeker.png" data-orig-size="300,400" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="beeker" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2018/08/beeker.png?w=225" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2018/08/beeker.png?w=300"></a>
										<h1 class="site-title"><a href="https://scorpiosoftware.net/" rel="home">Pavel Yosifovich</a></h1>
											<p class="site-description">Adventures in Coding, Internals and Learning</p>
										<button class="secondary-toggle">Menu and widgets</button>
			</div><!-- .site-branding -->
		</header><!-- .site-header -->

			<div id="secondary" class="secondary">

					<nav id="site-navigation" class="main-navigation" role="navigation">
				<div class="menu-primary-container"><ul id="menu-primary" class="nav-menu"><li id="menu-item-6" class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-6"><a href="/" aria-current="page">Home</a></li>
<li id="menu-item-7" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7"><a href="https://scorpiosoftware.net/contact/">Contact</a></li>
<li id="menu-item-64" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-64"><a href="https://scorpiosoftware.net/category/windows-internals/">Windows Internals</a></li>
<li id="menu-item-65" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-65"><a href="https://scorpiosoftware.net/category/training/">Training</a></li>
<li id="menu-item-219" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-219"><a href="https://scorpiosoftware.net/recorded-talks/">Recorded Talks</a></li>
<li id="menu-item-229" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-229"><a href="https://scorpiosoftware.net/books/">Books</a></li>
<li id="menu-item-1273" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1273"><a href="https://scorpiosoftware.net/services/">Services</a></li>
<li id="menu-item-1396" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1396"><a href="https://scorpiosoftware.net/upcoming-public-classes/">Upcoming Public Classes</a></li>
</ul></div>			</nav><!-- .main-navigation -->
		
		
					<div id="widget-area" class="widget-area" role="complementary">
				<aside id="search-1" class="widget widget_search"><form role="search" method="get" class="search-form" action="https://scorpiosoftware.net/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search …" value="" name="s">
				</label>
				<input type="submit" class="search-submit screen-reader-text" value="Search">
			</form></aside>
		<aside id="recent-posts-3" class="widget widget_recent_entries">
		<h2 class="widget-title">Recent Posts</h2><nav aria-label="Recent Posts">
		<ul>
											<li>
					<a href="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/">Building a Verifier&nbsp;DLL</a>
									</li>
											<li>
					<a href="https://scorpiosoftware.net/2024/03/26/the-power-of-ui-automation/">The Power of UI&nbsp;Automation</a>
									</li>
											<li>
					<a href="https://scorpiosoftware.net/2024/02/27/objdir-rust-version/">ObjDir – Rust&nbsp;Version</a>
									</li>
											<li>
					<a href="https://scorpiosoftware.net/2024/02/20/projected-file-system/">Projected File System</a>
									</li>
											<li>
					<a href="https://scorpiosoftware.net/2024/02/02/rust-programming-masterclass-training/">Rust Programming Masterclass&nbsp;Training</a>
									</li>
					</ul>

		</nav></aside><aside id="archives-3" class="widget widget_archive"><h2 class="widget-title">Archives</h2><nav aria-label="Archives">
			<ul>
					<li><a href="https://scorpiosoftware.net/2024/06/">June 2024</a></li>
	<li><a href="https://scorpiosoftware.net/2024/03/">March 2024</a></li>
	<li><a href="https://scorpiosoftware.net/2024/02/">February 2024</a></li>
	<li><a href="https://scorpiosoftware.net/2023/11/">November 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/10/">October 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/09/">September 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/08/">August 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/07/">July 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/06/">June 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/05/">May 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/04/">April 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/03/">March 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2023/02/">February 2023</a></li>
	<li><a href="https://scorpiosoftware.net/2022/12/">December 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2022/10/">October 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2022/09/">September 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2022/07/">July 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2022/05/">May 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2022/04/">April 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2022/03/">March 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2022/02/">February 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2022/01/">January 2022</a></li>
	<li><a href="https://scorpiosoftware.net/2021/12/">December 2021</a></li>
	<li><a href="https://scorpiosoftware.net/2021/10/">October 2021</a></li>
	<li><a href="https://scorpiosoftware.net/2021/08/">August 2021</a></li>
	<li><a href="https://scorpiosoftware.net/2021/07/">July 2021</a></li>
	<li><a href="https://scorpiosoftware.net/2021/05/">May 2021</a></li>
	<li><a href="https://scorpiosoftware.net/2021/04/">April 2021</a></li>
	<li><a href="https://scorpiosoftware.net/2021/03/">March 2021</a></li>
	<li><a href="https://scorpiosoftware.net/2021/01/">January 2021</a></li>
	<li><a href="https://scorpiosoftware.net/2020/10/">October 2020</a></li>
	<li><a href="https://scorpiosoftware.net/2020/07/">July 2020</a></li>
	<li><a href="https://scorpiosoftware.net/2020/03/">March 2020</a></li>
	<li><a href="https://scorpiosoftware.net/2020/01/">January 2020</a></li>
	<li><a href="https://scorpiosoftware.net/2019/11/">November 2019</a></li>
	<li><a href="https://scorpiosoftware.net/2019/02/">February 2019</a></li>
	<li><a href="https://scorpiosoftware.net/2019/01/">January 2019</a></li>
	<li><a href="https://scorpiosoftware.net/2018/10/">October 2018</a></li>
	<li><a href="https://scorpiosoftware.net/2018/09/">September 2018</a></li>
	<li><a href="https://scorpiosoftware.net/2018/08/">August 2018</a></li>
	<li><a href="https://scorpiosoftware.net/2018/05/">May 2018</a></li>
			</ul>

			</nav></aside><aside id="blog-stats-3" class="widget widget_blog-stats"><h2 class="widget-title">Blog Stats</h2>		<ul>
			<li>268,842 hits</li>
		</ul>
		</aside><aside id="custom_html-3" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><a class="ba-award" href="https://bookauthority.org/books/new-kernel-books?t=19h6se&amp;s=award&amp;book=1977593372" target="_blank" style="margin:20px;outline:0;" rel="noopener"><img src="https://award.bookauthority.org/new-kernel-books.png?b=1977593372&amp;c=1&amp;v=6&amp;w=200" style="width:200px;height:183px;border:0;" alt="BookAuthority Best New Kernel Books"></a></div></aside><aside id="follow_button_widget-3" class="widget widget_follow_button_widget">
		<iframe src="//widgets.wp.com/follow/index.html#href=scorpiosoftware.net&amp;lang=en&amp;blog=143820068" width="100%" height="20" frameborder="0" scrolling="no" title="Follow Button"></iframe>
		<script type="text/javascript">(function(d){ window.wpcomPlatform = {"titles":{"timelines":"Embeddable Timelines","followButton":"Follow Button","wpEmbeds":"WordPress Embeds"}}; var f = d.getElementsByTagName('SCRIPT')[0], p = d.createElement('SCRIPT');p.type = 'text/javascript';p.async = true;p.src = '//widgets.wp.com/platform.js';f.parentNode.insertBefore(p,f);}(document));</script>

		</aside>			</div><!-- .widget-area -->
		
	</div><!-- .secondary -->

	</div><!-- .sidebar -->

	<div id="content" class="site-content">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
			
<article id="post-2115" class="post-2115 post type-post status-publish format-standard has-post-thumbnail hentry category-dev category-system-programming category-uncategorized category-windows-internals tag-dev tag-native tag-programming tag-security tag-windows tag-windowsinternals">
	
	<a class="post-thumbnail" href="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/" aria-hidden="true">
		<img width="825" height="510" src="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-1.png?w=825&amp;h=510&amp;crop=1" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="Building a Verifier&nbsp;DLL" decoding="async" data-attachment-id="2119" data-permalink="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/image-1-14/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-1.png" data-orig-size="920,536" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-1" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-1.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-1.png?w=660">	</a>

		
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/" rel="bookmark">Building a Verifier&nbsp;DLL</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>The <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/application-verifierhttps://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/application-verifier" target="_blank" rel="noreferrer noopener">Application Verifier</a> tool that is part of the Windows SDK provide a way to analyze processes for various types of misbehavior. The GUI provided looks like the following:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="2117" data-permalink="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/image-24/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image.png" data-orig-size="734,422" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image.png?w=660" width="734" height="422" src="https://scorpiosoftware.net/wp-content/uploads/2024/06/image.png?w=734" alt="" class="wp-image-2117"></figure>



<p>Application Verifier application window</p>



<p>To add an application, you can browse your file system and select an executable. The Application Verifier settings are based around the executable name only – not a full path. This is because verifier settings are stored in a subkey under <strong>Image File Execution Options</strong> with the name of the executable. For the <strong>notepad</strong> example above, you’ll find the following in the Registry:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="2119" data-permalink="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/image-1-14/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-1.png" data-orig-size="920,536" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-1" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-1.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-1.png?w=660" width="920" height="536" src="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-1.png?w=920" alt="" class="wp-image-2119"></figure>



<p>Key for notepad.exe under the IFEO subkey</p>



<p>This IFEO subkey is used for NT Global Flags settings, one of which is using the Application Verifier. The <strong>GlobalFlag</strong> value is shown to be 0x100, which is the bit used for the verifier. Another way to set it without any extra information is using the <strong>GFlags</strong> tool, part of the <strong>Debugging Tools for Windows</strong> package:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="2122" data-permalink="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/image-2-13/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-2.png" data-orig-size="532,532" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-2" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-2.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-2.png?w=532" loading="lazy" width="532" height="532" src="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-2.png?w=532" alt="" class="wp-image-2122"></figure>



<p>GFlags tool</p>



<p>The Application Verifier lists a bunch of DLLs under the <strong>VerifierDLLs</strong> value. Each one must be located in the system directory (e.g., c:\Windows\System32). Full paths are not supported; this is intentional, because the list of DLLs are going to be loaded to any process running the specified executable, and it would be risky to load DLLs from arbitrary locations in the file system. The system directory, as well as the IFEO key are normally write-accessible by administrators only.</p>



<p>The list of verifier DLLs is selected based on the set of tests selected by the user on the right hand side of the GUI. You’ll find subkeys that are used by the system-provided verifier DLLs with more settings related to the tests selected.</p>



<p>The nice thing about any verifier DLL specified, is that these DLLs are loaded early in the process lifetime, by <strong>verifier.dll</strong> (in itself loaded by <strong>NTDLL.dll</strong>), before any other DLLs are loaded into the process. Even attaching a debugger to the process while launching it would “miss” the loading of these DLLs.</p>



<p>This behavior makes this technique attractive for injecting a DLL into arbitrary processes. It’s even possible to enable Application Verifier globally and even dynamically (without the need to restart the system), so that these DLLs are injected into all processes (except protected processes).</p>



<h2 class="wp-block-heading">Writing a Verifier DLL</h2>



<p>Application Verifier tests descriptions is not the focus of this post. Rather, we’ll look into what it takes to create such a DLL that can be injected early and automatically into processes of our choice. As we’ll see, it’s not just about mere injection. The verifier infrastructure (part of <strong>verifier.dll</strong>) provides convenient facilities to hook functions.</p>



<p>If we create a standard DLL, set up the verifier entries while adding our DLL to the list of verifier DLLs (possibly removing the “standard” ones), and try to run our target executable (say, notepad), we get the following nasty message box:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="2127" data-permalink="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/image-3-11/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-3.png" data-orig-size="394,152" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-3" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-3.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-3.png?w=394" loading="lazy" width="394" height="152" src="https://scorpiosoftware.net/wp-content/uploads/2024/06/image-3.png?w=394" alt="" class="wp-image-2127"></figure>



<p>The process shuts down, which means that if a verifier DLL fails to be properly processed, the process terminates rather than “skipping” the DLL.</p>



<p>Launching notepad with WinDbg spits the following output:</p>



<pre class="wp-block-code"><code>ModLoad: 00007ff7`6dfa0000 00007ff7`6dfd8000   notepad.exe
ModLoad: 00007ffd`978f0000 00007ffd`97ae8000   ntdll.dll
ModLoad: 00007ffd`1f650000 00007ffd`1f6c4000   C:\Windows\System32\verifier.dll
Page heap: pid 0x10CEC: page heap enabled with flags 0x3.
AVRF: notepad.exe: pid 0x10CEC: flags 0x81643027: application verifier enabled
ModLoad: 00007ffc`cabd0000 00007ffc`cad6f000   C:\Windows\SYSTEM32\MyVerify.dll
ModLoad: 00007ffd`97650000 00007ffd`9770d000   C:\Windows\System32\KERNEL32.dll
ModLoad: 00007ffd`951b0000 00007ffd`954a6000   C:\Windows\System32\KERNELBASE.dll
AVRF: provider MyVerify.dll did not initialize correctly</code></pre>



<p>Clearly the DLL did not initialize correctly, which is what the NTSTATUS 0xc0000142 was trying to tell us in the message box.</p>



<p>DLLs are initialized with the <code>DllMain</code> function that typically looks like this:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_251279" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">BOOL</code> <code class="cpp plain">WINAPI DllMain(</code><code class="cpp color1 bold">HMODULE</code> <code class="cpp plain">hModule, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">reason, </code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">lpReserved) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">switch</code> <code class="cpp plain">(reason) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">DLL_PROCESS_ATTACH:</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">DLL_THREAD_ATTACH:</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">DLL_THREAD_DETACH:</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">DLL_PROCESS_DETACH:</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">TRUE;</code></div><div class="line number10 index9 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The classic four values shown are used by the DLL to run code when it’s loaded into a process (<code>DLL_PROCESS_ATTACH</code>), unloaded from a process (<code>DLL_PROCESS_DETACH</code>), a thread is created in the process (<code>DLL_THREAD_ATTACH</code>), and thread is exiting in the process (<code>DLL_THREAD_DETACH</code>). It turns out that there is a fifth value, which must be used with verifiier DLLs:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_713431" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp preprocessor">#define DLL_PROCESS_VERIFIER 4</code></div></div></td></tr></tbody></table></div></div></div>


<p>Returning <code>TRUE</code> from such a case is not nearly enough. Instead, a structure expected by the caller of <code>DllMain</code> must be initialized and its address provided in <code>lpReserved</code>. The following structures and callback type definitions are needed:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_978979" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">_RTL_VERIFIER_THUNK_DESCRIPTOR {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PCHAR</code> <code class="cpp plain">ThunkName;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">ThunkOldAddress;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">ThunkNewAddress;</code></div><div class="line number5 index4 alt2"><code class="cpp plain">} RTL_VERIFIER_THUNK_DESCRIPTOR, *PRTL_VERIFIER_THUNK_DESCRIPTOR;</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">_RTL_VERIFIER_DLL_DESCRIPTOR {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PWCHAR</code> <code class="cpp plain">DllName;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code> <code class="cpp plain">DllFlags;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">DllAddress;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PRTL_VERIFIER_THUNK_DESCRIPTOR DllThunks;</code></div><div class="line number12 index11 alt1"><code class="cpp plain">} RTL_VERIFIER_DLL_DESCRIPTOR, *PRTL_VERIFIER_DLL_DESCRIPTOR;</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">void</code> <code class="cpp plain">(NTAPI* RTL_VERIFIER_DLL_LOAD_CALLBACK) (</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PWSTR</code> <code class="cpp plain">DllName,</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">DllBase,</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">SIZE_T</code> <code class="cpp plain">DllSize,</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">Reserved);</code></div><div class="line number19 index18 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">void</code> <code class="cpp plain">(NTAPI* RTL_VERIFIER_DLL_UNLOAD_CALLBACK) (</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PWSTR</code> <code class="cpp plain">DllName,</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">DllBase,</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">SIZE_T</code> <code class="cpp plain">DllSize,</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">Reserved);</code></div><div class="line number24 index23 alt1"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">void</code> <code class="cpp plain">(NTAPI* RTL_VERIFIER_NTDLLHEAPFREE_CALLBACK) (</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">AllocationBase,</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">SIZE_T</code> <code class="cpp plain">AllocationSize);</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">_RTL_VERIFIER_PROVIDER_DESCRIPTOR {</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code> <code class="cpp plain">Length;</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PRTL_VERIFIER_DLL_DESCRIPTOR ProviderDlls;</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">RTL_VERIFIER_DLL_LOAD_CALLBACK ProviderDllLoadCallback;</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">RTL_VERIFIER_DLL_UNLOAD_CALLBACK ProviderDllUnloadCallback;</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PWSTR</code> <code class="cpp plain">VerifierImage;</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code> <code class="cpp plain">VerifierFlags;</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code> <code class="cpp plain">VerifierDebug;</code></div><div class="line number37 index36 alt2">&nbsp;</div><div class="line number38 index37 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">RtlpGetStackTraceAddress;</code></div><div class="line number39 index38 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">RtlpDebugPageHeapCreate;</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">RtlpDebugPageHeapDestroy;</code></div><div class="line number41 index40 alt2">&nbsp;</div><div class="line number42 index41 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">RTL_VERIFIER_NTDLLHEAPFREE_CALLBACK ProviderNtdllHeapFreeCallback;</code></div><div class="line number43 index42 alt2"><code class="cpp plain">} RTL_VERIFIER_PROVIDER_DESCRIPTOR;</code></div></div></td></tr></tbody></table></div></div></div>


<p>That’s quite a list. The main structure is <code>RTL_VERIFIER_PROVIDER_DESCRIPTOR<br></code> that has a pointer to an array of <code>RTL_VERIFIER_DLL_DESCRIPTOR<br></code> (the last element in the array must end with all zeros), which in itself points to an array of <code>RTL_VERIFIER_THUNK_DESCRIPTOR<br></code>, used for specifying functions to hook. There are a few callbacks as well. At a minimum, we can define this descriptor like so (no hooking, no special code in callbacks):</p>



<p></p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_957137" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">RTL_VERIFIER_DLL_DESCRIPTOR noHooks{};</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="cpp plain">RTL_VERIFIER_PROVIDER_DESCRIPTOR desc = {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(desc),</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">&amp;noHooks,</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">[](</code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">) {},</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">[](</code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">) {},</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, 0, 0,</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">,</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">[](</code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">) {},</code></div><div class="line number11 index10 alt2"><code class="cpp plain">};</code></div></div></td></tr></tbody></table></div></div></div>


<p>We can define these simply as global variables and return the address of <code>desc</code> in the handling of <code>DLL_PROCESS_VERIFIER</code>:</p>



<p></p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_478733" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">case</code> <code class="cpp plain">DLL_PROCESS_VERIFIER:</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">*(</code><code class="cpp color1 bold">PVOID</code><code class="cpp plain">*)lpReserved = &amp;desc;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div></div></td></tr></tbody></table></div></div></div>


<p>With this code in place, we can try launching notepad again (after copying <strong>MyVerify.Dll</strong> to the System32 directory). Here is the output from WinDbg:</p>



<p></p>



<pre class="wp-block-code"><code>ModLoad: 00007ff7`6dfa0000 00007ff7`6dfd8000   notepad.exe
ModLoad: 00007ffd`978f0000 00007ffd`97ae8000   ntdll.dll
ModLoad: 00007ffd`1f650000 00007ffd`1f6c4000   C:\Windows\System32\verifier.dll
Page heap: pid 0xB30C: page heap enabled with flags 0x3.
AVRF: notepad.exe: pid 0xB30C: flags 0x81643027: application verifier enabled
ModLoad: 00007ffd`25b50000 00007ffd`25cf1000   C:\Windows\SYSTEM32\MyVerify.dll
ModLoad: 00007ffd`97650000 00007ffd`9770d000   C:\Windows\System32\KERNEL32.dll
ModLoad: 00007ffd`951b0000 00007ffd`954a6000   C:\Windows\System32\KERNELBASE.dll
ModLoad: 00007ffd`963e0000 00007ffd`9640b000   C:\Windows\System32\GDI32.dll
ModLoad: 00007ffd`95790000 00007ffd`957b2000   C:\Windows\System32\win32u.dll
ModLoad: 00007ffd`95090000 00007ffd`951a7000   C:\Windows\System32\gdi32full.dll
...</code></pre>



<p>This time it works. <strong>MyVerify.dll</strong> loads right after verifier.dll (which is the one managing verify DLLs).</p>



<h2 class="wp-block-heading">Hooking Functions</h2>



<p>As mentioned before, we can use the verifier engine’s support for hooking functions in arbitrary DLLs. Let’s give this a try by hooking into a couple of functions, <code>GetMessage</code> and <code>CreateFile</code>. First, we need to set up the structures for the hooks on a per-DLL basis:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_811294" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">RTL_VERIFIER_THUNK_DESCRIPTOR user32Hooks[] = {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{ (</code><code class="cpp color1 bold">PCHAR</code><code class="cpp plain">)</code><code class="cpp string">"GetMessageW"</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, HookGetMessage },</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{ </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code> <code class="cpp plain">},</code></div><div class="line number4 index3 alt1"><code class="cpp plain">};</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp plain">RTL_VERIFIER_THUNK_DESCRIPTOR kernelbaseHooks[] = {</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{ (</code><code class="cpp color1 bold">PCHAR</code><code class="cpp plain">)</code><code class="cpp string">"CreateFileW"</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, HookCreateFile },</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{ </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code> <code class="cpp plain">},</code></div><div class="line number9 index8 alt2"><code class="cpp plain">};</code></div></div></td></tr></tbody></table></div></div></div>


<p>The second <code>NULL</code> in each triplet is where the original address of the hooked function is stored by the verifier engine. Now we fill the structure with the list of DLLs, pointing to the hook arrays:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_480632" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">RTL_VERIFIER_DLL_DESCRIPTOR dlls[] = {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{ (</code><code class="cpp color1 bold">PWCHAR</code><code class="cpp plain">)</code><code class="cpp string">L"user32.dll"</code><code class="cpp plain">, 0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, user32Hooks },</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{ (</code><code class="cpp color1 bold">PWCHAR</code><code class="cpp plain">)</code><code class="cpp string">L"kernelbase.dll"</code><code class="cpp plain">, 0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, kernelbaseHooks },</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{ </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, 0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code> <code class="cpp plain">},</code></div><div class="line number5 index4 alt2"><code class="cpp plain">};</code></div></div></td></tr></tbody></table></div></div></div>


<p>Finally, we update the main structure with the <code>dlls</code> array:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_920295" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">RTL_VERIFIER_PROVIDER_DESCRIPTOR desc = {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(desc),</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">dlls,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">[](</code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">) {},</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">[](</code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">) {},</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, 0, 0,</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">,</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">[](</code><code class="cpp keyword bold">auto</code><code class="cpp plain">, </code><code class="cpp keyword bold">auto</code><code class="cpp plain">) {},</code></div><div class="line number9 index8 alt2"><code class="cpp plain">};</code></div></div></td></tr></tbody></table></div></div></div>


<p>The last thing is to actually implement the hooks:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_380176" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">BOOL</code> <code class="cpp plain">WINAPI HookGetMessage(PMSG msg, </code><code class="cpp color1 bold">HWND</code> <code class="cpp plain">hWnd, </code><code class="cpp color1 bold">UINT</code> <code class="cpp plain">filterMin, </code><code class="cpp color1 bold">UINT</code> <code class="cpp plain">filterMax) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// get original function</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">static</code> <code class="cpp keyword bold">const</code> <code class="cpp keyword bold">auto</code> <code class="cpp plain">orgGetMessage = (</code><code class="cpp keyword bold">decltype</code><code class="cpp plain">(::GetMessageW)*)user32Hooks[0].ThunkOldAddress;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">result = orgGetMessage(msg, hWnd, filterMin, filterMax);</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">char</code> <code class="cpp plain">text[128];</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">sprintf_s(text, </code><code class="cpp string">"Received message 0x%X for hWnd 0x%p\n"</code><code class="cpp plain">, msg-&gt;message, msg-&gt;hwnd);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">OutputDebugStringA(text);</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">result;</code></div><div class="line number9 index8 alt2"><code class="cpp plain">}</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">WINAPI HookCreateFile(</code><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">path, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">access, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">share, LPSECURITY_ATTRIBUTES sa, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">cd, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">flags, </code><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">hTemplate) {</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// get original function</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">static</code> <code class="cpp keyword bold">const</code> <code class="cpp keyword bold">auto</code> <code class="cpp plain">orgCreateFile = (</code><code class="cpp keyword bold">decltype</code><code class="cpp plain">(::CreateFileW)*)kernelbaseHooks[0].ThunkOldAddress;</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hFile = orgCreateFile(path, access, share, sa, cd, flags, hTemplate);</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">char</code> <code class="cpp plain">text[512];</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(hFile == INVALID_HANDLE_VALUE)</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">sprintf_s(text, </code><code class="cpp string">"Failed to open file %ws (%u)\n"</code><code class="cpp plain">, path, ::GetLastError());</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">else</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">sprintf_s(text, </code><code class="cpp string">"Opened file %ws successfuly (0x%p)\n"</code><code class="cpp plain">, path, hFile);</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">OutputDebugStringA(text);</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">hFile;</code></div><div class="line number23 index22 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The hooks just send some output with <code>OutputDebugString</code>. Here is an excerpt output when running notepad under a debugger:</p>



<pre class="wp-block-code"><code>ModLoad: 00007ff7`6dfa0000 00007ff7`6dfd8000   notepad.exe
ModLoad: 00007ffd`978f0000 00007ffd`97ae8000   ntdll.dll
ModLoad: 00007ffd`1f650000 00007ffd`1f6c4000   C:\Windows\System32\verifier.dll
Page heap: pid 0xEF18: page heap enabled with flags 0x3.
AVRF: notepad.exe: pid 0xEF18: flags 0x81643027: application verifier enabled
<strong>ModLoad: 00007ffd`25b80000 00007ffd`25d24000   C:\Windows\SYSTEM32\MyVerify.dll</strong>
ModLoad: 00007ffd`97650000 00007ffd`9770d000   C:\Windows\System32\KERNEL32.dll
ModLoad: 00007ffd`951b0000 00007ffd`954a6000   C:\Windows\System32\KERNELBASE.dll
ModLoad: 00007ffd`963e0000 00007ffd`9640b000   C:\Windows\System32\GDI32.dll
ModLoad: 00007ffd`95790000 00007ffd`957b2000   C:\Windows\System32\win32u.dll
ModLoad: 00007ffd`95090000 00007ffd`951a7000   C:\Windows\System32\gdi32full.dll
...
ModLoad: 00007ffd`964f0000 00007ffd`965bd000   C:\Windows\System32\OLEAUT32.dll
ModLoad: 00007ffd`96d10000 00007ffd`96d65000   C:\Windows\System32\shlwapi.dll
ModLoad: 00007ffd`965d0000 00007ffd`966e4000   C:\Windows\System32\MSCTF.dll
<strong>Opened file C:\Windows\Fonts\staticcache.dat successfuly (0x0000000000000164)</strong>
ModLoad: 00007ffd`7eac0000 00007ffd`7eb6c000   C:\Windows\System32\TextShaping.dll
ModLoad: 00007ffc`ed750000 00007ffc`ed82e000   C:\Windows\System32\efswrt.dll
ModLoad: 00007ffd`90880000 00007ffd`909d7000   C:\Windows\SYSTEM32\wintypes.dll
ModLoad: 00007ffd`8bf90000 00007ffd`8bfad000   C:\Windows\System32\MPR.dll
ModLoad: 00007ffd`8cae0000 00007ffd`8cce3000   C:\Windows\System32\twinapi.appcore.dll
<strong>Opened file C:\Windows\Registration\R000000000025.clb successfuly (0x00000000000001C4)</strong>
ModLoad: 00007ffd`823b0000 00007ffd`82416000   C:\Windows\System32\oleacc.dll
...
<strong>Received message 0x31F for hWnd 0x00000000001F1776
Received message 0xC17C for hWnd 0x00000000001F1776
Received message 0xF for hWnd 0x00000000001F1776
Received message 0xF for hWnd 0x00000000003010C0
Received message 0xF for hWnd 0x0000000000182E7A
Received message 0x113 for hWnd 0x00000000003319A8</strong>
...
ModLoad: 00007ffd`80e20000 00007ffd`80fd4000   C:\Windows\System32\WindowsCodecs.dll
ModLoad: 00007ffd`94ee0000 00007ffd`94f04000   C:\Windows\System32\profapi.dll
<strong>Opened file C:\Users\Pavel\AppData\Local\IconCache.db successfuly (0x0000000000000724</strong>)
ModLoad: 00007ffd`3e190000 00007ffd`3e1f6000   C:\Windows\System32\thumbcache.dll
<strong>Opened file C:\Users\Pavel\AppData\Local\Microsoft\Windows\Explorer\iconcache_idx.db successfuly (0x0000000000000450)
Opened file C:\Users\Pavel\AppData\Local\Microsoft\Windows\Explorer\iconcache_16.db successfuly (0x000000000000065C)</strong>
ModLoad: 00007ffd`90280000 00007ffd`90321000   C:\Windows\SYSTEM32\policymanager.dll</code></pre>



<p>This application verifier technique is an interesting one, and fairly easy to use. The full example can be found at <a href="https://github.com/zodiacon/VerifierDll" target="_blank" rel="noreferrer noopener">https://github.com/zodiacon/VerifierDLL</a>.</p>



<p>Happy verifying!</p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/" rel="bookmark"><time class="entry-date published" datetime="2024-06-01T05:50:22+03:00">June 1, 2024</time><time class="updated" datetime="2024-06-02T19:44:26+03:00">June 2, 2024</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/dev/" rel="category tag">DEV</a>, <a href="https://scorpiosoftware.net/category/system-programming/" rel="category tag">System Programming</a>, <a href="https://scorpiosoftware.net/category/uncategorized/" rel="category tag">Uncategorized</a>, <a href="https://scorpiosoftware.net/category/windows-internals/" rel="category tag">Windows Internals</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="https://scorpiosoftware.net/tag/dev/" rel="tag">DEV</a>, <a href="https://scorpiosoftware.net/tag/native/" rel="tag">Native</a>, <a href="https://scorpiosoftware.net/tag/programming/" rel="tag">programming</a>, <a href="https://scorpiosoftware.net/tag/security/" rel="tag">Security</a>, <a href="https://scorpiosoftware.net/tag/windows/" rel="tag">windows</a>, <a href="https://scorpiosoftware.net/tag/windowsinternals/" rel="tag">WindowsInternals</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2024/06/01/building-a-verifier-dll/#comments">2 Comments<span class="screen-reader-text"> on Building a Verifier&nbsp;DLL</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-2115 -->

<article id="post-1942" class="post-1942 post type-post status-publish format-standard hentry category-uncategorized tag-automation tag-com tag-dev">
	
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2024/03/26/the-power-of-ui-automation/" rel="bookmark">The Power of UI&nbsp;Automation</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>What if you needed to get a list of all the open browser tabs in some browser? In the (very) old days you might assume that each tab is its own window, so you could find a main browser window (using <code><a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-findwindowa" target="_blank" rel="noreferrer noopener">FindWindow</a></code>, for example), and then enumerate child windows with <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-enumchildwindows" target="_blank" rel="noreferrer noopener"><code>EnumChildWindows</code> </a>to locate the tabs. Unfortunately, this approach is destined to fail. Here is a screenshot of <strong><a href="https://github.com/zodiacon/WinSpy" target="_blank" rel="noreferrer noopener">WinSpy</a> </strong>looking at a main window of Microsoft Edge:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1945" data-permalink="https://scorpiosoftware.net/2024/03/26/the-power-of-ui-automation/image-23/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/03/image.png" data-orig-size="716,386" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/03/image.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/03/image.png?w=660" loading="lazy" width="716" height="386" src="https://scorpiosoftware.net/wp-content/uploads/2024/03/image.png?w=716" alt="" class="wp-image-1945" srcset="https://scorpiosoftware.net/wp-content/uploads/2024/03/image.png 716w, https://scorpiosoftware.net/wp-content/uploads/2024/03/image.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2024/03/image.png?w=300 300w" sizes="(max-width: 716px) 100vw, 716px"></figure>



<p>MS Edge showing only two child windows</p>



<p>The title of the main window hints to the existence of 26 tabs, but there are only two child windows and they are not tabs. The inevitable conclusion is that the tabs are not windows at all. They are being “drawn” with some technology that the Win32 windowing infrastructure doesn’t know about nor cares.</p>



<p>How can we get information about those browsing tabs? Enter <strong>UI Automation</strong>. </p>



<p>UI Automation has been around for many years, starting with the older technology called “<a href="https://learn.microsoft.com/en-us/windows/win32/winauto/microsoft-active-accessibility" target="_blank" rel="noreferrer noopener">Active Accessibility</a>“. This technology is geared towards accessibility while providing rich information that can be consumed by accessibility clients. Although Active Accessibility is still supported for compatibility reasons, a newer technology called <strong><a href="https://learn.microsoft.com/en-us/windows/win32/winauto/entry-uiauto-win32" target="_blank" rel="noreferrer noopener">UI Automation</a></strong> supersedes it.</p>



<p>UI Automation provides a tree of UI automation elements representing various aspects of a user interface. Some elements represent “true” Win32 windows (have HWND), some represent internal controls like buttons and edit boxes (created with whatever technology), and some elements are virtual (don’t have any graphical aspects), but instead provide “metadata” related to other items.</p>



<p>The UI Automation client API uses COM, where the root object implements the <a href="https://learn.microsoft.com/en-us/windows/win32/api/uiautomationclient/nn-uiautomationclient-iuiautomation" target="_blank" rel="noreferrer noopener"><code>IUIAutomation</code> </a>interface (it has extended interfaces implemented as well). To get the automation object, the following C++ code can be used (we’ll see a C# example later):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_751873" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">CComPtr&lt;IUIAutomation&gt; spUI;</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">auto</code> <code class="cpp plain">hr = spUI.CoCreateInstance(__uuidof(CUIAutomation));</code></div><div class="line number3 index2 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(FAILED(hr))</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">Error(</code><code class="cpp string">"Failed to create Automation root"</code><code class="cpp plain">, hr);</code></div></div></td></tr></tbody></table></div></div></div>


<p>The client automation interfaces are declared in <strong>&lt;UIAutomationClient.h&gt;</strong>. The code uses the ATL <code>CComPtr&lt;&gt;</code> smart pointers, but any COM smart or raw pointers will do.</p>



<p>With the UI Automation object pointer in hand, several options are available. One is to enumerate the full or part of the UI element tree. To get started, we can obtain a “walker” object by calling <code><a href="https://learn.microsoft.com/en-us/windows/win32/api/uiautomationclient/nf-uiautomationclient-iuiautomation-get_rawviewwalker" target="_blank" rel="noreferrer noopener">IUIAutomation::get_RawViewWalker</a></code>. From there, we can start enumerating by calling <a href="https://learn.microsoft.com/en-us/windows/win32/api/uiautomationclient/nn-uiautomationclient-iuiautomationtreewalker" target="_blank" rel="noreferrer noopener"><code>IUIAutomationTreeWalker</code> </a>interface methods, like <a href="https://learn.microsoft.com/en-us/windows/win32/api/uiautomationclient/nf-uiautomationclient-iuiautomationtreewalker-getfirstchildelement" target="_blank" rel="noreferrer noopener"><code>GetFirstChildElement</code> </a>and <code>GetNextSiblingElement</code>.</p>



<p>Each element, represented by a <code><a href="https://learn.microsoft.com/en-us/windows/win32/api/uiautomationclient/nn-uiautomationclient-iuiautomationelement" target="_blank" rel="noreferrer noopener">IUIAutomationElement</a></code> interface provides a set of properties, some available directly on the interface (e.g. <code>get_CurrentName</code>, <code>get_CurrentClassName</code>, <code>get_CurrentProcessId</code>), while others hide behind a generic method, <code>get_CurrentPropertyValue</code>, where each property has an integer ID, and the result is a <code>VARIANT</code>, to allow for various types of values.</p>



<p>Using this method, the menu item <strong>View Automation Tree</strong> in <strong>WinSpy </strong>shows the full automation tree, and you can drill down to any level, while many of the selected element’s properties are shown on the right:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1951" data-permalink="https://scorpiosoftware.net/2024/03/26/the-power-of-ui-automation/image-1-13/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/03/image-1.png" data-orig-size="862,528" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-1" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/03/image-1.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/03/image-1.png?w=660" loading="lazy" width="862" height="528" src="https://scorpiosoftware.net/wp-content/uploads/2024/03/image-1.png?w=862" alt="" class="wp-image-1951" srcset="https://scorpiosoftware.net/wp-content/uploads/2024/03/image-1.png 862w, https://scorpiosoftware.net/wp-content/uploads/2024/03/image-1.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2024/03/image-1.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2024/03/image-1.png?w=768 768w" sizes="(max-width: 862px) 100vw, 862px"></figure>



<p>WinSpy automation tree view</p>



<p>If you dig deep enough, you’ll find that MS Edge tabs have a UI automation class name of “EdgeTab”. This is the key to locating browser tabs. (Other browsers may have a different class name). To find tabs, we can enumerate the full tree manually, but fortunately, there is a better way. <code><a href="https://learn.microsoft.com/en-us/windows/win32/api/uiautomationclient/nn-uiautomationclient-iuiautomationelement" target="_blank" rel="noreferrer noopener">IUIAutomationElement </a></code>has a FindAll method that searches for elements based on a set of conditions. The conditions available are pretty flexible – based on some property or properties of elements, which can be combined with And, Or, etc. to get more complex conditions. In our case, we just need one condition – a class name called “EdgeTab”.</p>



<p>First, we’ll create the root object, and the condition (error handling omitted for brevity):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_687892" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">main() {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CoInitialize(</code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">);</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComPtr&lt;IUIAutomation&gt; spUI;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hr = spUI.CoCreateInstance(__uuidof(CUIAutomation));</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComPtr&lt;IUIAutomationCondition&gt; spCond;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComVariant edgeTab(</code><code class="cpp string">L"EdgeTab"</code><code class="cpp plain">);</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">spUI-&gt;CreatePropertyCondition(UIA_ClassNamePropertyId, edgeTab, &amp;spCond);</code></div></div></td></tr></tbody></table></div></div></div>


<p>We have a single condition for the class name property, which has an ID defined in the automation headers. Next, we’ll fire off the search from the root element (desktop): </p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_855559" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">CComPtr&lt;IUIAutomationElementArray&gt; spTabs;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">CComPtr&lt;IUIAutomationElement&gt; spRoot;</code></div><div class="line number3 index2 alt2"><code class="cpp plain">spUI-&gt;GetRootElement(&amp;spRoot);</code></div><div class="line number4 index3 alt1"><code class="cpp plain">hr = spRoot-&gt;FindAll(TreeScope_Descendants, spCond, &amp;spTabs);</code></div></div></td></tr></tbody></table></div></div></div>


<p>All that’s left to do is harvest the results:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_61844" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">count = 0;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">spTabs-&gt;get_Length(&amp;count);</code></div><div class="line number3 index2 alt2"><code class="cpp keyword bold">for</code> <code class="cpp plain">(</code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; count; i++) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComPtr&lt;IUIAutomationElement&gt; spTab;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">spTabs-&gt;GetElement(i, &amp;spTab);</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComBSTR name;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">spTab-&gt;get_CurrentName(&amp;name);</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">int</code> <code class="cpp plain">pid;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">spTab-&gt;get_CurrentProcessId(&amp;pid);</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"%2d PID %6d: %ws\n"</code><code class="cpp plain">, i + 1, pid, name.m_str);</code></div><div class="line number11 index10 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>Try it!</p>



<h2 class="wp-block-heading">.NET Code</h2>



<p>A convenient Nuget package called <strong>Interop.UIAutomationClient.Signed</strong> provides wrappers for the automation API for .NET clients. Here is the same search done in C# after adding the Nuget package reference:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_588453" class="syntaxhighlighter nogutter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp keyword">static</code> <code class="csharp keyword">void</code> <code class="csharp plain">Main(</code><code class="csharp keyword">string</code><code class="csharp plain">[] args) {</code></div><div class="line number2 index1 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">const</code> <code class="csharp keyword">int</code> <code class="csharp plain">ClassPropertyId = 30012;</code></div><div class="line number3 index2 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">ui = </code><code class="csharp keyword">new</code> <code class="csharp plain">CUIAutomationClass();</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">cond = ui.CreatePropertyCondition(ClassPropertyId, </code><code class="csharp string">"EdgeTab"</code><code class="csharp plain">);</code></div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">tabs = ui.GetRootElement().FindAll(TreeScope.TreeScope_Descendants, cond);</code></div><div class="line number6 index5 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">for</code> <code class="csharp plain">(</code><code class="csharp keyword">int</code> <code class="csharp plain">i = 0; i &lt; tabs.Length; i++) {</code></div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">var</code> <code class="csharp plain">tab = tabs.GetElement(i);</code></div><div class="line number8 index7 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">Console.WriteLine($</code><code class="csharp string">"{i + 1,2} PID {tab.CurrentProcessId,6}: {tab.CurrentName}"</code><code class="csharp plain">);</code></div><div class="line number9 index8 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number10 index9 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<h2 class="wp-block-heading">More Automation</h2>



<p>There is a lot more to UI automation – the word “automation” implies some more control. One capability of the API is providing various notifications when certain aspects of elements change. Examples include the <code>IUIAutomation</code> methods <code>AddAutomationEventHandler</code>, <code>AddFocusChangedEventHandler</code>, <code>AddPropertyChangedEventHandler</code>, and <code>AddStructureChangedEventHandler</code>.</p>



<p>More specific information on elements (and some control) is also available with more specific interfaces related to controls, such as <code>IUIAutomationTextPattern</code>, <code><a href="https://learn.microsoft.com/en-us/windows/win32/api/uiautomationclient/nn-uiautomationclient-iuiautomationtextrange" target="_blank" rel="noreferrer noopener">IUIAutomationTextRange</a></code>, and manu more.</p>



<p>Happy automation!</p>



<p></p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2024/03/26/the-power-of-ui-automation/" rel="bookmark"><time class="entry-date published updated" datetime="2024-03-26T20:11:36+02:00">March 26, 2024</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/uncategorized/" rel="category tag">Uncategorized</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="https://scorpiosoftware.net/tag/automation/" rel="tag">automation</a>, <a href="https://scorpiosoftware.net/tag/com/" rel="tag">COM</a>, <a href="https://scorpiosoftware.net/tag/dev/" rel="tag">DEV</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2024/03/26/the-power-of-ui-automation/#comments">3 Comments<span class="screen-reader-text"> on The Power of UI&nbsp;Automation</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1942 -->

<article id="post-1792" class="post-1792 post type-post status-publish format-standard has-post-thumbnail hentry category-dev category-rust tag-programming tag-rust">
	
	<a class="post-thumbnail" href="https://scorpiosoftware.net/2024/02/27/objdir-rust-version/" aria-hidden="true">
		<img width="257" height="257" src="https://scorpiosoftware.net/wp-content/uploads/2024/02/rust.png?w=257&amp;h=257&amp;crop=1" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="ObjDir – Rust&nbsp;Version" decoding="async" loading="lazy" data-attachment-id="1678" data-permalink="https://scorpiosoftware.net/2024/02/02/rust-programming-masterclass-training/rust/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/rust.png" data-orig-size="257,257" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Rust" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/rust.png?w=257" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/rust.png?w=257">	</a>

		
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2024/02/27/objdir-rust-version/" rel="bookmark">ObjDir – Rust&nbsp;Version</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>In the previous post, I’ve shown how to write a minimal, but functional, Projected File System provider using C++. I also semi-promised to write a version of that provider in Rust. I thought we should start small, by implementing a command line tool I wrote years ago called <a href="https://github.com/zodiacon/ObjDir" target="_blank" rel="noreferrer noopener">objdir</a>. Its purpose is to be a “command line” version of a simplified WinObj from Sysinternals. It should be able to list objects (name and type) within a given object manager namespace directory. Here are a couple of examples:</p>



<pre class="wp-block-code"><code>D:\&gt;objdir \<br>PendingRenameMutex (Mutant)<br>ObjectTypes (Directory)<br>storqosfltport (FilterConnectionPort)<br>MicrosoftMalwareProtectionRemoteIoPortWD (FilterConnectionPort)<br>Container_Microsoft.OutlookForWindows_1.2024.214.400_x64__8wekyb3d8bbwe-S-1-5-21-3968166439-3083973779-398838822-1001 (Job)<br>MicrosoftDataLossPreventionPort (FilterConnectionPort)<br>SystemRoot (SymbolicLink)<br>exFAT (Device)<br>Sessions (Directory)<br>MicrosoftMalwareProtectionVeryLowIoPortWD (FilterConnectionPort)<br>ArcName (Directory)<br>PrjFltPort (FilterConnectionPort)<br>WcifsPort (FilterConnectionPort)<br>...<br><br>D:\&gt;objdir \kernelobjects<br>MemoryErrors (SymbolicLink)<br>LowNonPagedPoolCondition (Event)<br>Session1 (Session)<br>SuperfetchScenarioNotify (Event)<br>SuperfetchParametersChanged (Event)<br>PhysicalMemoryChange (SymbolicLink)<br>HighCommitCondition (SymbolicLink)<br>BcdSyncMutant (Mutant)<br>HighMemoryCondition (SymbolicLink)<br>HighNonPagedPoolCondition (Event)<br>MemoryPartition0 (Partition)<br>...</code></pre>



<p>Since enumerating object manager directories is required for our ProjFS provider, once we implement <strong>objdir</strong> in Rust, we’ll have good starting point for implementing the full provider in Rust.</p>



<p>This post assumes you are familiar with the fundamentals of Rust. Even if you’re not, the code should still be fairly understandable, as we’re mostly going to use unsafe rust to do the real work.</p>



<h2 class="wp-block-heading">Unsafe Rust</h2>



<p>One of the main selling points of Rust is its safety – memory and concurrency safety guaranteed at compile time. However, there are cases where access is needed that cannot be checked by the Rust compiler, such as the need to call external C functions, such as OS APIs. Rust allows this by using <code>unsafe</code> blocks or functions. Within unsafe blocks, certain operations are allowed which are normally forbidden; it’s up to the developer to make sure the invariants assumed by Rust are not violated – essentially making sure nothing leaks, or otherwise misused.</p>



<p>The Rust standard library provides some support for calling C functions, mostly in the <code>std::ffi</code> module (FFI=Foreign Function Interface). This is pretty bare bones, providing a C-string class, for example. That’s not rich enough, unfortunately. First, strings in Windows are mostly UTF-16, which is not the same as a classic C string, and not the same as the Rust standard <code>String</code> type. More importantly, any C function that needs to be invoked must be properly exposed as an <code>extern "C"</code> function, using the correct Rust types that provide the same binary representation as the C types.</p>



<p>Doing all this manually is a lot of error-prone, non-trivial, work. It only makes sense for simple and limited sets of functions. In our case, we need to use native APIs, like <code>NtOpenDirectoryObject</code> and <code>NtQueryDirectoryObject</code>. To simplify matters, there are crates available in crates.io (the master Rust crates repository) that already provide such declarations.</p>



<h2 class="wp-block-heading">Adding Dependencies</h2>



<p>Assuming you have Rust installed, open a command window and create a new project named <strong>objdir</strong>:</p>



<pre class="wp-block-code"><code>cargo new objdir</code></pre>



<p>This will create a subdirectory named <strong>objdir</strong>, hosting the binary crate created. Now we can open <strong>cargo.toml</strong> (the manifest) and add dependencies for the following crates:</p>



<pre class="wp-block-code"><code>[dependencies]<br>ntapi = "0.4"<br>winapi = { version = "0.3.9", features = [ "impl-default" ] }</code></pre>



<p><a href="https://crates.io/crates/winapi" target="_blank" rel="noreferrer noopener"><strong>winapi</strong> </a>provides most of the Windows API declarations, but does not provide native APIs. <a href="https://crates.io/crates/ntapi" target="_blank" rel="noreferrer noopener"><strong>ntapi</strong> </a>provides those additional declarations, and in fact depends on <strong>winapi</strong> for some fundamental types (which we’ll need). The feature “<strong>impl-default</strong>” indicates we would like the implementations of the standard Rust <strong><code>Default</code></strong> trait provided – we’ll need that later.</p>



<h2 class="wp-block-heading">The main Function</h2>



<p>The <code>main</code> function is going to accept a command line argument to indicate the directory to enumerate. If no parameters are provided, we’ll assume the root directory is requested. Here is one way to get that directory:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_986396" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">let dir = std::env::args().skip(1).next().unwrap_or(</code><code class="cpp string">"\\"</code><code class="cpp plain">.to_owned());</code></div></div></td></tr></tbody></table></div></div></div>


<p>(Note that unfortunately the WordPress system I’m using to write this post has no syntax highlighting for Rust, the code might be uglier than expected; I’ve set it to C++).</p>



<p>The <a href="https://doc.rust-lang.org/std/env/fn.args.html" target="_blank" rel="noreferrer noopener"><code>args</code> </a>method returns an iterator. We skip the first item (the executable itself), and grab the next one with <code>next</code>. It returns an <code>Option&lt;String&gt;</code>,  so we grab the string if there is one, or use a fixed backslash as the string.</p>



<p>Next, we’ll call a helper function, <code>enum_directory</code> that does the heavy lifting and get back a <code>Result</code> where success is a vector of tuples, each containing the object’s name and type (<code>Vec&lt;(String, String)&gt;</code>). Based on the result, we can display the results or report an error:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_230054" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">let result = enum_directory(&amp;dir);</code></div><div class="line number2 index1 alt1"><code class="cpp plain">match result {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Ok(objects) =&gt; {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">for</code> <code class="cpp plain">(name, </code><code class="cpp keyword bold">typename</code><code class="cpp plain">) in &amp;objects {</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">println!(</code><code class="cpp string">"{name} ({typename})"</code><code class="cpp plain">);</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">println!(</code><code class="cpp string">"{} objects."</code><code class="cpp plain">, objects.len());</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">},</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Err(status) =&gt; println!(</code><code class="cpp string">"Error: 0x{status:X}"</code><code class="cpp plain">)</code></div><div class="line number10 index9 alt1"><code class="cpp plain">};</code></div></div></td></tr></tbody></table></div></div></div>


<p>That is it for the <code>main</code> function.</p>



<h2 class="wp-block-heading">Enumerating Objects</h2>



<p>Since we need to use APIs defined within the <strong>winapi</strong> and <strong>ntapi </strong>crates, let’s bring them into scope for easier access at the top of the file:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_651591" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">use winapi::shared::ntdef::*;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">use ntapi::ntobapi::*;</code></div><div class="line number3 index2 alt2"><code class="cpp plain">use ntapi::ntrtl::*;</code></div></div></td></tr></tbody></table></div></div></div>


<p>I’m using the “glob” operator (*) to make it easy to just use the function names directly without any prefix. Why these specific modules? Based on the APIs and types we’re going to need, these are where these are defined (check the documentation for these crates). </p>



<p><code>enum_directory</code> is where the real is done. Here its declararion:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_106402" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">fn enum_directory(dir: &amp;str) -&gt; Result&lt;Vec&lt;(String, String)&gt;, NTSTATUS&gt; {</code></div></div></td></tr></tbody></table></div></div></div>


<p>The function accepts a string slice and returns a <code>Result</code> type, where the <code>Ok</code> variant is a vector of tuples consisting of two standard Rust strings. </p>



<p>The following code follows the basic logic of the <code>EnumDirectoryObjects</code> function from the ProjFS example in the previous post, without the capability of search or filter. We’ll add that when we work on the actual ProjFS project in a future post.</p>



<p>The first thing to do is open the given directory object with <code>NtOpenDirectoryObject</code>. For that we need to prepare an <code>OBJECT_ATTRIBUTES</code> and a <code>UNICODE_STRING</code>. Here is what that looks like:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_481920" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">let mut items = vec![];</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="cpp plain">unsafe {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let mut udir = UNICODE_STRING::</code><code class="cpp keyword bold">default</code><code class="cpp plain">();</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let wdir = string_to_wstring(&amp;dir);</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">RtlInitUnicodeString(&amp;mut udir, wdir.as_ptr());</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let mut dir_attr = OBJECT_ATTRIBUTES::</code><code class="cpp keyword bold">default</code><code class="cpp plain">();</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">InitializeObjectAttributes(&amp;mut dir_attr, &amp;mut udir, OBJ_CASE_INSENSITIVE, NULL, NULL);</code></div></div></td></tr></tbody></table></div></div></div>


<p>We start by creating an empty vector to hold the results. We don’t need any type annotation because later in the code the compiler would have enough information to deduce it on its own. We then start an <code>unsafe</code> block because we’re calling C APIs.</p>



<p>Next, we create a default-initialized <code>UNICODE_STRING</code> and use a helper function to convert a Rust string slice to a UTF-16 string, usable by native APIs. We’ll see this <code>string_to_wstring</code> helper function once we’re done with this one. The returned value is in fact a <code>Vec&lt;u16&gt;</code> – an array of UTF-16 characters.</p>



<p>The next step is to call <code>RtlInitUnicodeString</code>, to initialize the <code>UNICODE_STRING</code> based on the UTF-16 string we just received. Methods such as <code>as_ptr</code> are necessary to make the Rust compiler happy. Finally, we create a default <code>OBJECT_ATTRIBUTES</code> and initialize it with the <code>udir</code> (the UTF-16 directory string). All the types and constants used are provided by the crates we’re using.</p>



<p>The next step is to actually open the directory, which could fail because of insufficient access or a directory that does not exist. In that case, we just return an error. Otherwise, we move to the next step:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_872990" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">let mut hdir: </code><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">= NULL;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">match NtOpenDirectoryObject(&amp;mut hdir, DIRECTORY_QUERY, &amp;mut dir_attr) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">0 =&gt; {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// do real work...</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">},</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">err =&gt; Err(err),</code></div><div class="line number7 index6 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The <code>NULL</code> here is just a type alias for the Rust provided C void pointer with a value of zero (<code>*mut c_void</code>). We examine the <code>NTSTATUS</code> returned using a <code>match</code> expression: If it’s not zero (<code>STATUS_SUCCESS</code>), it must be an error and we return an <code>Err</code> object with the status. if it’s zero, we’re good to go. Now comes the real work.</p>



<p>We need to allocate a buffer to receive the object information in this directory and be prepared for the case the information is too big for the allocated buffer, so we may need to loop around to get the next “chunk” of data. This is how the <code>NtQueryDirectoryObject</code> is expected to be used. Let’s allocate a buffer using the standard <code>Vec&lt;&gt;</code> type and prepare some locals:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_752744" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">const</code> <code class="cpp plain">LEN: u32 = 1 &lt;&lt; 16;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">let mut first = 1;</code></div><div class="line number3 index2 alt2"><code class="cpp plain">let mut buffer: Vec&lt;u8&gt; = Vec::with_capacity(LEN as usize);</code></div><div class="line number4 index3 alt1"><code class="cpp plain">let mut index = 0u32;</code></div><div class="line number5 index4 alt2"><code class="cpp plain">let mut size: u32 = 0;</code></div></div></td></tr></tbody></table></div></div></div>


<p>We’re allocating 64KB, but could have chosen any number. Now the loop:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_873906" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">loop {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let start = index;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">NtQueryDirectoryObject(hdir, buffer.as_mut_ptr().cast(), LEN, 0, first, &amp;mut index, &amp;mut size) &lt; 0 {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">first = 0;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let mut obuffer = buffer.as_ptr() as *</code><code class="cpp keyword bold">const</code> <code class="cpp plain">OBJECT_DIRECTORY_INFORMATION;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">for</code> <code class="cpp plain">_ in 0..index - start {</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let item = *obuffer;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let name = String::from_utf16_lossy(std::slice::from_raw_parts(item.Name.Buffer, (item.Name.Length / 2) as usize));</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let </code><code class="cpp keyword bold">typename</code> <code class="cpp plain">= String::from_utf16_lossy(std::slice::from_raw_parts(item.TypeName.Buffer, (item.TypeName.Length / 2) as usize));</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">items.push((name, </code><code class="cpp keyword bold">typename</code><code class="cpp plain">));</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">obuffer = obuffer.add(1);</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number15 index14 alt2"><code class="cpp plain">}</code></div><div class="line number16 index15 alt1"><code class="cpp plain">Ok(items)</code></div></div></td></tr></tbody></table></div></div></div>


<p>There are quite a few things going on here. if <code>NtQueryDirectoryObject</code> fails, we break out of the <code>loop</code>. This happens when there are is no more information to give. If there is data, <code>buffer</code> is cast to a <code>OBJECT_DIRECTORY_INFORMATION</code> pointer, and we can loop around on the items that were returned. <code>start</code> is used to keep track of the previous number of items delivered. <code>first</code> is 1 (true) the first time through the loop to force the <code>NtQueryDirectoryObject</code> to start from the beginning.</p>



<p>Once we have an item (<code>item</code>), its two members are extracted. <code>item</code> is of type <code>OBJECT_DIRECTORY_INFORMATION</code> and has two members: <code>Name</code> and <code>TypeName</code> (both <code>UNICODE_STRING</code>). Since we want to return standard Rust strings (which, by the way, are UTF-8 encoded), we must convert the <code>UNICODE_STRING</code>s to Rust strings. <code>String::from_utf16_lossy</code> performs such a conversion, but we must specify the number of characters, because a <code>UNICODE_STRING</code> does not have to be <code>NULL</code>-terminated. The trick here is <code>std::slice::from_raw_parts</code> that can have a length, which is half of the number of bytes (<code>Length</code> member in <code>UNICODE_STRING</code>).</p>



<p>Finally, <code>Vec&lt;&gt;.push</code> is called to add the tuple <code>(name, typename)</code> to the vector. This is what allows the compiler to infer the vector type. Once we exit the loop, the <code>Ok</code> variant of <code>Result&lt;&gt;</code> is returned with the vector.</p>



<p>The last function used is the helper to convert a Rust string slice to a UTF-16 null-terminated string:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_649254" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">fn string_to_wstring(s: &amp;str) -&gt; Vec&lt;u16&gt; {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">let mut wstring: Vec&lt;_&gt; = s.encode_utf16().collect();</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">wstring.push(0);&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// null terminator</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">wstring</code></div><div class="line number5 index4 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>And that is it. The Rust version of <strong>objdir</strong> is functional.</p>



<p>The full source is at <a href="https://github.com/zodiacon/objdir-rs">zodiacon/objdir-rs: Rust version of the objdir tool (github.com)</a></p>



<p>If you want to know more about Rust, consider signing up for my upcoming <a href="https://scorpiosoftware.net/2024/02/02/rust-programming-masterclass-training/" target="_blank" rel="noreferrer noopener">Rust masterclass programming</a>.</p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2024/02/27/objdir-rust-version/" rel="bookmark"><time class="entry-date published" datetime="2024-02-27T00:28:02+02:00">February 27, 2024</time><time class="updated" datetime="2024-02-27T15:31:03+02:00">February 27, 2024</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/dev/" rel="category tag">DEV</a>, <a href="https://scorpiosoftware.net/tag/rust/" rel="category tag">Rust</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="https://scorpiosoftware.net/tag/programming/" rel="tag">programming</a>, <a href="https://scorpiosoftware.net/tag/rust/" rel="tag">Rust</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2024/02/27/objdir-rust-version/#comments">2 Comments<span class="screen-reader-text"> on ObjDir – Rust&nbsp;Version</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1792 -->

<article id="post-1726" class="post-1726 post type-post status-publish format-standard hentry category-dev category-system-programming category-windows-internals tag-coding tag-dev tag-programming tag-windowsinternals">
	
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2024/02/20/projected-file-system/" rel="bookmark">Projected File System</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>A little-known feature in modern Windows is the ability to expose hierarchical data using the file system. This is called <strong><a href="https://learn.microsoft.com/en-us/windows/win32/projfs/projected-file-system" target="_blank" rel="noreferrer noopener">Windows Projected File System</a></strong> (ProjFS), available since Windows 10 version 1809. There is even a sample that exposes the Registry hierarchy using this technology. Using the file system as a “projection” mechanism provides a couple of advantages over a custom mechanism:</p>



<ul class="wp-block-list">
<li>Any file viewing tool can present the information such as Explorer, or commands in a terminal.</li>



<li>“Standard” file APIs are used, which are well-known, and available in any programming language or library.</li>
</ul>



<p>Let’s see how to build a Projected File System provider from scratch. We’ll expose object manager directories as file system directories, and other types of objects as “files”. Normally, we can see the object manager’s namespace with dedicated tools, such as WinObj from Sysinternals, or my own Object Explorer:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1730" data-permalink="https://scorpiosoftware.net/2024/02/20/projected-file-system/image-22/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/image.png" data-orig-size="951,666" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/image.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/image.png?w=660" loading="lazy" width="951" height="666" src="https://scorpiosoftware.net/wp-content/uploads/2024/02/image.png?w=951" alt="" class="wp-image-1730" srcset="https://scorpiosoftware.net/wp-content/uploads/2024/02/image.png 951w, https://scorpiosoftware.net/wp-content/uploads/2024/02/image.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2024/02/image.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2024/02/image.png?w=768 768w" sizes="(max-width: 951px) 100vw, 951px"></figure>



<p>WinObj showing parts of the object manager namespace</p>



<p>Here is an example of what we are aiming for (viewed with Explorer):</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1736" data-permalink="https://scorpiosoftware.net/2024/02/20/projected-file-system/image-1-12/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/image-1.png" data-orig-size="975,844" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-1" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/image-1.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/image-1.png?w=660" loading="lazy" width="975" height="844" src="https://scorpiosoftware.net/wp-content/uploads/2024/02/image-1.png?w=975" alt="" class="wp-image-1736" srcset="https://scorpiosoftware.net/wp-content/uploads/2024/02/image-1.png 975w, https://scorpiosoftware.net/wp-content/uploads/2024/02/image-1.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2024/02/image-1.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2024/02/image-1.png?w=768 768w" sizes="(max-width: 975px) 100vw, 975px"></figure>



<p>Explorer showing the root of the object manager namespace</p>



<p>First, support for ProjFS must be enabled to be usable. You can enable it with the <strong>Windows Features</strong> dialog or PowerShell:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_5588" class="syntaxhighlighter nogutter  powershell"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="powershell functions">Enable-WindowsOptionalFeature</code> <code class="powershell color1">-Online</code> <code class="powershell color1">-FeatureName</code> <code class="powershell plain">Client-ProjFS</code> <code class="powershell color1">-NoRestart</code></div></div></td></tr></tbody></table></div></div></div>


<p>We’ll start by creating a C++ console application named <strong>ObjMgrProjFS</strong>; I’ve used the <strong>Windows Desktop Wizard</strong> project with a precompiled header (pch.h):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_650267" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp preprocessor">#pragma once</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="cpp preprocessor">#include &lt;Windows.h&gt;</code></div><div class="line number4 index3 alt1"><code class="cpp preprocessor">#include &lt;projectedfslib.h&gt;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp preprocessor">#include &lt;string&gt;</code></div><div class="line number7 index6 alt2"><code class="cpp preprocessor">#include &lt;vector&gt;</code></div><div class="line number8 index7 alt1"><code class="cpp preprocessor">#include &lt;memory&gt;</code></div><div class="line number9 index8 alt2"><code class="cpp preprocessor">#include &lt;map&gt;</code></div><div class="line number10 index9 alt1"><code class="cpp preprocessor">#include &lt;ranges&gt;</code></div><div class="line number11 index10 alt2"><code class="cpp preprocessor">#include &lt;algorithm&gt;</code></div><div class="line number12 index11 alt1"><code class="cpp preprocessor">#include &lt;format&gt;</code></div><div class="line number13 index12 alt2"><code class="cpp preprocessor">#include &lt;optional&gt;</code></div><div class="line number14 index13 alt1"><code class="cpp preprocessor">#include &lt;functional&gt;</code></div></div></td></tr></tbody></table></div></div></div>


<p><strong>projectedfslib.h</strong> is where the ProjFS declarations reside. <strong>projectedfslib.lib</strong> is the import library to link against. In this post, I’ll focus on the main coding aspects, rather than going through every little piece of code. The full code can be found at <a href="https://github.com/zodiacon/objmgrprojfs" rel="nofollow">https://github.com/zodiacon/objmgrprojfs</a>. It’s of course possible to use other languages to implement a ProjFS provider. I’m going to attempt one in Rust in a future post 🙂</p>



<p>The projected file system must be rooted in a folder in the file system. It doesn’t have to be empty, but it makes sense to use such a directory for this purpose only. The <code>main</code> function will take the requested root folder as input and pass it to the <code>ObjectManagerProjection</code> class that is used to manage everything:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_592607" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">wmain(</code><code class="cpp color1 bold">int</code> <code class="cpp plain">argc, </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">wchar_t</code><code class="cpp plain">* argv[]) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(argc &lt; 2) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Usage: ObjMgrProjFS &lt;root_dir&gt;\n"</code><code class="cpp plain">);</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">0;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ObjectManagerProjection omp;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hr = omp.Init(argv[1]); hr != S_OK)</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">Error(hr);</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hr = omp.Start(); hr != S_OK)</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">Error(hr);</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Virtualizing at %ws. Press ENTER to stop virtualizing...\n"</code><code class="cpp plain">, argv[1]);</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">char</code> <code class="cpp plain">buffer[3];</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gets_s(buffer);</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">omp.Term();</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">0;</code></div><div class="line number21 index20 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>Let start with the initialization. We want to create the requested directory (if it doesn’t already exist). If it does exist, we’ll use it. In fact, it could exist because of a previous run of the provider, so we can keep track of the instance ID (a GUID) so that the file system itself can use its caching capabilities. We’ll “hide” the GUID in a hidden file within the directory. First, create the directory:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_18828" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HRESULT</code> <code class="cpp plain">ObjectManagerProjection::Init(</code><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">root) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">GUID instanceId = GUID_NULL;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::wstring instanceFile(root);</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">instanceFile += </code><code class="cpp string">L"\\_obgmgrproj.guid"</code><code class="cpp plain">;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!::CreateDirectory(root, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">)) {</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// failed, does it exist?</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(::GetLastError() != ERROR_ALREADY_EXISTS)</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">HRESULT_FROM_WIN32(::GetLastError());</code></div></div></td></tr></tbody></table></div></div></div>


<p>If creation fails not because it exists, bail out with an error. Otherwise, get the instance ID that may be there and use that GUID if present:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_634961" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hFile = ::CreateFile(instanceFile.c_str(), GENERIC_READ, </code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">FILE_SHARE_READ, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, OPEN_EXISTING, 0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">);</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(hFile != INVALID_HANDLE_VALUE &amp;&amp; ::GetFileSize(hFile, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">) == </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(GUID)) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">ret;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::ReadFile(hFile, &amp;instanceId, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(instanceId), &amp;ret, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">);</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CloseHandle(hFile);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number8 index7 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>If we need to generate a new GUID, we’ll do that with <code>CoCreateGuid</code> and write it to the hidden file:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_967523" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(instanceId == GUID_NULL) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CoCreateGuid(&amp;instanceId);</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// write instance ID</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hFile = ::CreateFile(instanceFile.c_str(), GENERIC_WRITE, 0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, CREATE_NEW, FILE_ATTRIBUTE_HIDDEN, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(hFile != INVALID_HANDLE_VALUE) {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">ret;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::WriteFile(hFile, &amp;instanceId, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(instanceId), &amp;ret, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">);</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CloseHandle(hFile);</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number12 index11 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>Finally, we must register the root with ProjFS:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_534945" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">auto</code> <code class="cpp plain">hr = ::PrjMarkDirectoryAsPlaceholder(root, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, &amp;instanceId);</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">if</code> <code class="cpp plain">(FAILED(hr))</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">hr;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="cpp plain">m_RootDir = root;</code></div><div class="line number6 index5 alt1"><code class="cpp keyword bold">return</code> <code class="cpp plain">hr;</code></div></div></td></tr></tbody></table></div></div></div>


<p>Once <code>Init</code> succeeds, we need to start the actual virtualization. To that end, a structure of callbacks must be filled so that ProjFS knows what functions to call to get the information requested by the file system. This is the job of the <code>Start</code> method:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_419747" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HRESULT</code> <code class="cpp plain">ObjectManagerProjection::Start() {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PRJ_CALLBACKS cb{};</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">cb.StartDirectoryEnumerationCallback = StartDirectoryEnumerationCallback;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">cb.EndDirectoryEnumerationCallback = EndDirectoryEnumerationCallback;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">cb.GetDirectoryEnumerationCallback = GetDirectoryEnumerationCallback;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">cb.GetPlaceholderInfoCallback = GetPlaceholderInformationCallback;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">cb.GetFileDataCallback = GetFileDataCallback;</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hr = ::PrjStartVirtualizing(m_RootDir.c_str(), &amp;cb, </code><code class="cpp keyword bold">this</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, &amp;m_VirtContext);</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">hr;</code></div><div class="line number11 index10 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The callbacks specified above are the absolute minimum required for a valid provider. <code>PrjStartVirtualizing</code> returns a virtualization context that identifies our provider, which we need to use (at least) when stopping virtualization. It’s a blocking call, which is convenient in a console app, but for other cases, it’s best put in a separate thread. The <code>this</code> value passed in is a user-defined context. We’ll use that to delegate these static callback functions to member functions. Here is the code for <code>StartDirectoryEnumerationCallback</code>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_328788" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HRESULT</code> <code class="cpp plain">ObjectManagerProjection::StartDirectoryEnumerationCallback(</code><code class="cpp keyword bold">const</code> <code class="cpp plain">PRJ_CALLBACK_DATA* callbackData, </code><code class="cpp keyword bold">const</code> <code class="cpp plain">GUID* enumerationId) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">((ObjectManagerProjection*)callbackData-&gt;InstanceContext)-&gt;DoStartDirectoryEnumerationCallback(callbackData, enumerationId);</code></div><div class="line number3 index2 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The same trick is used for the other callbacks, so that we can implement the functionality within our class. The class <code>ObjectManagerProjection</code> itself holds on to the following data members of interest:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_661263" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">GUIDComparer {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">bool</code> <code class="cpp plain">operator()(</code><code class="cpp keyword bold">const</code> <code class="cpp plain">GUID&amp; lhs, </code><code class="cpp keyword bold">const</code> <code class="cpp plain">GUID&amp; rhs) </code><code class="cpp keyword bold">const</code> <code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp functions bold">memcmp</code><code class="cpp plain">(&amp;lhs, &amp;rhs, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(rhs)) &lt; 0;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number5 index4 alt2"><code class="cpp plain">};</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">EnumInfo {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::vector&lt;ObjectNameAndType&gt; Objects;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">int</code> <code class="cpp plain">Index{ -1 };</code></div><div class="line number10 index9 alt1"><code class="cpp plain">};</code></div><div class="line number11 index10 alt2"><code class="cpp plain">std::wstring m_RootDir;</code></div><div class="line number12 index11 alt1"><code class="cpp plain">PRJ_NAMESPACE_VIRTUALIZATION_CONTEXT m_VirtContext;</code></div><div class="line number13 index12 alt2"><code class="cpp plain">std::map&lt;GUID, EnumInfo, GUIDComparer&gt; m_Enumerations;</code></div></div></td></tr></tbody></table></div></div></div>


<p><code>EnumInfo</code> is a structure used to keep an object directory’s contents and the current index requested by the file system. A map is used to keep track of all current enumerations. Remember, it’s the file system – multiple directory listings may be happening at the same time. As it happens, each one is identified by a GUID, which is why it’s used as a key to the map. <code>m_VirtContext</code> is the returned value from <code>PrjStartVirtualizing</code>.</p>



<p><code>ObjectNameAndType</code> is a little structure that stores the details of an object: its name and type:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_955731" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">ObjectNameAndType {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::wstring Name;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::wstring TypeName;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">};</code></div></div></td></tr></tbody></table></div></div></div>


<h2 class="wp-block-heading">The Callbacks</h2>



<p>Obviously, the bulk work for the provider is centered in the callbacks. Let’s start with  <code>StartDirectoryEnumerationCallback</code>. Its purpose is to let the provider know that a new directory enumeration of some sort is beginning. The provider can make any necessary preparations. In our case, it’s about adding a new enumeration structure to manage based on the provided enumeration GUID:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_889432" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HRESULT</code> <code class="cpp plain">ObjectManagerProjection::DoStartDirectoryEnumerationCallback(</code><code class="cpp keyword bold">const</code> <code class="cpp plain">PRJ_CALLBACK_DATA* callbackData, </code><code class="cpp keyword bold">const</code> <code class="cpp plain">GUID* enumerationId) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">EnumInfo info;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_Enumerations.insert({ *enumerationId, std::move(info) });</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">S_OK;</code></div><div class="line number5 index4 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>We just add a new entry to our map, since we must be able to distinguish between multiple enumerations that may be happening concurrently. The complementary callback ends an enumeration which is where we delete the item from the map:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_343915" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HRESULT</code> <code class="cpp plain">ObjectManagerProjection::DoEndDirectoryEnumerationCallback(</code><code class="cpp keyword bold">const</code> <code class="cpp plain">PRJ_CALLBACK_DATA* callbackData, </code><code class="cpp keyword bold">const</code> <code class="cpp plain">GUID* enumerationId) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_Enumerations.erase(*enumerationId);</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">S_OK;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>So far, so good. The real work is centered around the <code>GetDirectoryEnumerationCallback</code> callback where actual enumeration must take place. The callback receives the enumeration ID and a search expression – the client may try to search using functions such as <code>FindFirstFile</code> / <code>FindNextFile</code> or similar APIs. The provided <code>PRJ_CALLBACK_DATA</code> contains the basic details of the request such as the relative directory itself (which could be a subdirectory). First, we reject any unknown enumeration IDs:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_763493" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HRESULT</code> <code class="cpp plain">ObjectManagerProjection::DoGetDirectoryEnumerationCallback(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">const</code> <code class="cpp plain">PRJ_CALLBACK_DATA* callbackData, </code><code class="cpp keyword bold">const</code> <code class="cpp plain">GUID* enumerationId, </code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">searchExpression, PRJ_DIR_ENTRY_BUFFER_HANDLE dirEntryBufferHandle) {</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">it = m_Enumerations.find(*enumerationId); </code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code><code class="cpp plain">(it == m_Enumerations.end())</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">E_INVALIDARG;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code><code class="cpp plain">&amp; info = it-&gt;second;</code></div></div></td></tr></tbody></table></div></div></div>


<p>Next, we need to enumerate the objects in the provided directory, taking into consideration the search expression (that may require returning a subset of the items):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_483056" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(info.Index &lt; 0 || (callbackData-&gt;Flags &amp; PRJ_CB_DATA_FLAG_ENUM_RESTART_SCAN)) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">compare = [&amp;](</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">name) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">::PrjFileNameMatch(name, searchExpression);</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">};</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">info.Objects = ObjectManager::EnumDirectoryObjects(callbackData-&gt;FilePathName, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, compare);</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::ranges::sort(info.Objects, [](</code><code class="cpp keyword bold">auto</code> <code class="cpp keyword bold">const</code><code class="cpp plain">&amp; item1, </code><code class="cpp keyword bold">auto</code> <code class="cpp keyword bold">const</code><code class="cpp plain">&amp; item2) { </code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">::PrjFileNameCompare(item1.Name.c_str(), item2.Name.c_str()) &lt; 0; </code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">});</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">info.Index = 0;</code></div><div class="line number10 index9 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>There are quite a few things happening here. <code>ObjectManager::EnumDirectoryObjects</code> is a helper function that does the actual enumeration of objects in the object manager’s namespace given the root directory (<code>callbackData-&gt;FilePathName</code>), which is always relative to the virtualization root, which is convenient – we don’t need to care where the actual root is. The <code>compare</code> lambda is passed to <code>EnumDirectoryObjects</code> to provide a filter based on the search expression. ProjFS provides the <code>PrjFileNameMatch</code> function we can use to test if a specific name should be returned or not. It has the logic that caters for wildcards like * and ?. </p>



<p>Once the results return in a vector (<code>info.Objects</code>), we must sort it. The file system expects returned files/directories to be sorted in a case insensitive way, but we don’t actually need to know that. <code>PrjFileNameCompare</code> is provided as a function to use for sorting purposes. We call <code>sort</code> on the returned vector passing this function <code>PrjFileNameCompare</code> as the compare function.</p>



<p>The enumeration must happen if the <code>PRJ_CB_DATA_FLAG_ENUM_RESTART_SCAN</code> is specified. I also enumerate if it’s the first call for this enumeration ID.</p>



<p>Now that we have results (or an empty vector), we can proceed by telling ProjFS about the results. If we have no results, just return success (an empty directory):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_308300" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(info.Objects.empty())</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">S_OK;</code></div></div></td></tr></tbody></table></div></div></div>


<p>Otherwise, we must call <code>PrjFillDirEntryBuffer</code> for each entry in the results. However, ProjFS provides a limited buffer to accept data, which means we need to keep track of where we left off because we may be called again (without the <code>PRJ_CB_DATA_FLAG_ENUM_RESTART_SCAN </code>flag) to continue filling in data. This is why we keep track of the index we need to use.</p>



<p>The first step in the loop is to fill in details of the item: is it a subdirectory or a “file”? We can also specify the size of its data and common times like creation time, modify time, etc.:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_440265" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">while</code> <code class="cpp plain">(info.Index &lt; info.Objects.size()) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PRJ_FILE_BASIC_INFO itemInfo{};</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code><code class="cpp plain">&amp; item = info.Objects[info.Index];</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">itemInfo.IsDirectory = item.TypeName == </code><code class="cpp string">L"Directory"</code><code class="cpp plain">;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">itemInfo.FileSize = itemInfo.IsDirectory ? 0 : </code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">GetObjectSize((callbackData-&gt;FilePathName + std::wstring(</code><code class="cpp string">L"\\"</code><code class="cpp plain">) + item.Name).c_str(), item);</code></div></div></td></tr></tbody></table></div></div></div>


<p>We fill in two details: a directory or not, based on the kernel object type being “Directory”, and a file size (in case of another type object). What is the meaning of a “file size”? It can mean whatever we want it to mean, including just specifying a size of zero. However, I decided that the “data” being held in an object would be text that provides the object’s name, type, and target (if it’s a symbolic link). Here are a few example when running the provider and using a command window:</p>



<pre class="wp-block-code"><code>C:\objectmanager&gt;dir p*<br> Volume in drive C is OS<br> Volume Serial Number is 18CF-552E<br><br> Directory of C:\objectmanager<br><br>02/20/2024  11:09 AM                60 PdcPort.ALPC Port<br>02/20/2024  11:09 AM                76 PendingRenameMutex.Mutant<br>02/20/2024  11:09 AM                78 PowerMonitorPort.ALPC Port<br>02/20/2024  11:09 AM                64 PowerPort.ALPC Port<br>02/20/2024  11:09 AM                88 PrjFltPort.FilterConnectionPort<br>               5 File(s)            366 bytes<br>               0 Dir(s)  518,890,110,976 bytes free<br><br>C:\objectmanager&gt;type PendingRenameMutex.Mutant<br>Name: PendingRenameMutex<br>Type: Mutant<br><br>C:\objectmanager&gt;type powerport<br>Name: PowerPort<br>Type: ALPC Port</code></pre>



<p>Here is <code>PRJ_FILE_BASIC_INFO</code>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_460173" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">PRJ_FILE_BASIC_INFO {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">BOOLEAN</code> <code class="cpp plain">IsDirectory;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">INT64</code> <code class="cpp plain">FileSize;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">LARGE_INTEGER CreationTime;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">LARGE_INTEGER LastAccessTime;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">LARGE_INTEGER LastWriteTime;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">LARGE_INTEGER ChangeTime;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">UINT32</code> <code class="cpp plain">FileAttributes;</code></div><div class="line number9 index8 alt2"><code class="cpp plain">} PRJ_FILE_BASIC_INFO;</code></div></div></td></tr></tbody></table></div></div></div>


<p>What is the meaning of the various times and file attributes? It can mean whatever you want – it might make sense for some types of data. If left at zero, the current time is used.</p>



<p><code>GetObjectSize</code> is a helper function that calculates the number of bytes needed to keep the object’s text, which is what is reported to the file system.</p>



<p>Now we can pass the information for the item to ProjFS by calling <code>PrjFillDirEntryBuffer</code>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_917769" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(FAILED(::PrjFillDirEntryBuffer(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">(itemInfo.IsDirectory ? item.Name : (item.Name + </code><code class="cpp string">L"."</code> <code class="cpp plain">+ item.TypeName)).c_str(), </code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">&amp;itemInfo, dirEntryBufferHandle)))</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">info.Index++;</code></div><div class="line number6 index5 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The “name” of the item is comprised of the kernel object’s name, and the “file extension” is the object’s type name. This is just a matter of choice – I could have passed the object’s name only so that it would appear as a file with no extension. If the call to <code>PrjFillDirEntryBuffer</code> fails, it means the buffer is full, so we break out, but the index is not incremented, so we can provide the next object in the next callback that does not requires a rescan.</p>



<p>We have two callbacks remaining. One is <code>GetPlaceholderInformationCallback</code>, whose purpose is to provide “placeholder” information about an item, without providing its data. This is used by the file system for caching purposes. The implementation is like so:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_438492" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HRESULT</code> <code class="cpp plain">ObjectManagerProjection::DoGetPlaceholderInformationCallback(</code><code class="cpp keyword bold">const</code> <code class="cpp plain">PRJ_CALLBACK_DATA* callbackData) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">path = callbackData-&gt;FilePathName;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">dir = ObjectManager::DirectoryExists(path);</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::optional&lt;ObjectNameAndType&gt; object;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!dir)</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">object = ObjectManager::ObjectExists(path);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code><code class="cpp plain">(!dir &amp;&amp; !object)</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">HRESULT_FROM_WIN32(ERROR_FILE_NOT_FOUND);</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">PRJ_PLACEHOLDER_INFO info{};</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">info.FileBasicInfo.IsDirectory = dir;</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">info.FileBasicInfo.FileSize = dir ? 0 : GetObjectSize(path, object.value());</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">PrjWritePlaceholderInfo(m_VirtContext, callbackData-&gt;FilePathName, &amp;info, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(info));</code></div><div class="line number14 index13 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The item could be a file or a directory. We use the file path name provided to figure out if it’s a directory kernel object or something else by utilizing some helpers in the <code>ObjectManager</code> class (we’ll examine those later). Then the structure <code>PRJ_PLACEHOLDER_INFO</code> is filled with the details and provided to <code>PrjWritePlaceholderInfo</code>.</p>



<p>The final required callback is the one that provides the data for files – objects in our case:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_364282" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HRESULT</code> <code class="cpp plain">ObjectManagerProjection::DoGetFileDataCallback(</code><code class="cpp keyword bold">const</code> <code class="cpp plain">PRJ_CALLBACK_DATA* callbackData, </code><code class="cpp color1 bold">UINT64</code> <code class="cpp plain">byteOffset, </code><code class="cpp color1 bold">UINT32</code> <code class="cpp plain">length) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">object = ObjectManager::ObjectExists(callbackData-&gt;FilePathName);</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!object)</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">HRESULT_FROM_WIN32(ERROR_FILE_NOT_FOUND);</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">buffer = ::PrjAllocateAlignedBuffer(m_VirtContext, length);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!buffer)</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">E_OUTOFMEMORY;</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">data = GetObjectData(callbackData-&gt;FilePathName, object.value());</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">memcpy</code><code class="cpp plain">(buffer, (</code><code class="cpp color1 bold">PBYTE</code><code class="cpp plain">)data.c_str() + byteOffset, length);</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hr = ::PrjWriteFileData(m_VirtContext, &amp;callbackData-&gt;DataStreamId, buffer, byteOffset, length);</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::PrjFreeAlignedBuffer(buffer);</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">hr;</code></div><div class="line number16 index15 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>First we check if the object’s path is valid. Next, we need to allocate buffer for the data. There are some ProjFS alignment requirements, so we call <code>PrjAllocateAlignedBuffer</code> to allocate a properly-aligned buffer. Then we get the object data (a string, by calling our helper <code>GetObjectData</code>), and copy it into the allocated buffer. Finally, we pass the buffer to <code>PrjWriteFileData</code> and free the buffer. The byte offset provided is usually zero, but could theoretically be larger if the client reads from a non-zero position, so we must be prepared for it. In our case, the data is small, but in general it could be arbitrarily large.</p>



<p><code>GetObjectData</code> itself looks like this:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_764442" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">std::wstring ObjectManagerProjection::GetObjectData(</code><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">fullname, ObjectNameAndType </code><code class="cpp keyword bold">const</code><code class="cpp plain">&amp; info) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::wstring target;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(info.TypeName == </code><code class="cpp string">L"SymbolicLink"</code><code class="cpp plain">) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">target = ObjectManager::GetSymbolicLinkTarget(fullname);</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">result = std::format(</code><code class="cpp string">L"Name: {}\nType: {}\n"</code><code class="cpp plain">, info.Name, info.TypeName);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!target.empty())</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">result = std::format(</code><code class="cpp string">L"{}Target: {}\n"</code><code class="cpp plain">, result, target);</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">result;</code></div><div class="line number10 index9 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>It calls a helper function, <code>ObjectManager::GetSymbolicLinkTarget</code> in case of a symbolic link, and builds the final string by using <code>format</code> (C++ 20) before returning it to the caller.</p>



<p>That’s all for the provider, except when terminating:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_444985" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">ObjectManagerProjection::Term() {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::PrjStopVirtualizing(m_VirtContext);</code></div><div class="line number3 index2 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<h2 class="wp-block-heading">The Object Manager</h2>



<p>Looking into the <code>ObjectManager</code> helper class is somewhat out of the focus of this post, since it has nothing to do with ProjFS. It uses native APIs to enumerate objects in the object manager’s namespace and get details of a symbolic link’s target. For more information about the native APIs, check out my book “<a href="https://leanpub.com/windowsnativeapiprogramming" target="_blank" rel="noreferrer noopener">Windows Native API Programming</a>” or search online. First, it includes &lt;Winternl.h&gt; to get some basic native functions like <code>RtlInitUnicodeString</code>, and also adds the APIs for directory objects:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_896016" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code> <code class="cpp plain">_OBJECT_DIRECTORY_INFORMATION {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">UNICODE_STRING Name;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">UNICODE_STRING TypeName;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">} OBJECT_DIRECTORY_INFORMATION, * POBJECT_DIRECTORY_INFORMATION;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp preprocessor">#define DIRECTORY_QUERY&nbsp; 0x0001</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="cpp keyword bold">extern</code> <code class="cpp string">"C"</code> <code class="cpp plain">{</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">NTSTATUS NTAPI NtOpenDirectoryObject(</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_Out_ </code><code class="cpp color1 bold">PHANDLE</code> <code class="cpp plain">hDirectory,</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ ACCESS_MASK AccessMask,</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ POBJECT_ATTRIBUTES ObjectAttributes);</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">NTSTATUS NTAPI NtQuerySymbolicLinkObject(</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ </code><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">LinkHandle,</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_Inout_ PUNICODE_STRING LinkTarget,</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_Out_opt_ </code><code class="cpp color1 bold">PULONG</code> <code class="cpp plain">ReturnedLength);</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">NTSTATUS NTAPI NtQueryDirectoryObject(</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp; </code><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">hDirectory,</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_Out_ POBJECT_DIRECTORY_INFORMATION DirectoryEntryBuffer,</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp; </code><code class="cpp color1 bold">ULONG</code> <code class="cpp plain">DirectoryEntryBufferSize,</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp; </code><code class="cpp color1 bold">BOOLEAN</code>&nbsp; <code class="cpp plain">bOnlyFirstEntry,</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp; </code><code class="cpp color1 bold">BOOLEAN</code> <code class="cpp plain">bFirstEntry,</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp; </code><code class="cpp color1 bold">PULONG</code>&nbsp; <code class="cpp plain">EntryIndex,</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_Out_ </code><code class="cpp color1 bold">PULONG</code>&nbsp; <code class="cpp plain">BytesReturned);</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">NTSTATUS NTAPI NtOpenSymbolicLinkObject(</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_Out_&nbsp; </code><code class="cpp color1 bold">PHANDLE</code> <code class="cpp plain">LinkHandle,</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp; ACCESS_MASK DesiredAccess,</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp; POBJECT_ATTRIBUTES ObjectAttributes);</code></div><div class="line number31 index30 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>Here is the main code that enumerates directory objects (some details omitted for clarity, see the full source code in the Github repo):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_807276" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">std::vector&lt;ObjectNameAndType&gt; ObjectManager::EnumDirectoryObjects(</code><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">path, </code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">objectName, std::function&lt;</code><code class="cpp color1 bold">bool</code><code class="cpp plain">(</code><code class="cpp color1 bold">PCWSTR</code><code class="cpp plain">)&gt; compare) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::vector&lt;ObjectNameAndType&gt; objects;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">hDirectory;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">OBJECT_ATTRIBUTES attr;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">UNICODE_STRING name;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::wstring spath(path);</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(spath[0] != </code><code class="cpp string">L'\\'</code><code class="cpp plain">)</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">spath = </code><code class="cpp string">L'\\'</code> <code class="cpp plain">+ spath;</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::wstring object(objectName ? objectName : </code><code class="cpp string">L""</code><code class="cpp plain">);</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">RtlInitUnicodeString(&amp;name, spath.c_str());</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">InitializeObjectAttributes(&amp;attr, &amp;name, 0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">);</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!NT_SUCCESS(NtOpenDirectoryObject(&amp;hDirectory, DIRECTORY_QUERY, &amp;attr)))</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">objects;</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">objects.reserve(128);</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">BYTE</code> <code class="cpp plain">buffer[1 &lt;&lt; 12];</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">info = </code><code class="cpp keyword bold">reinterpret_cast</code><code class="cpp plain">&lt;OBJECT_DIRECTORY_INFORMATION*&gt;(buffer);</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">bool</code> <code class="cpp plain">first = </code><code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code> <code class="cpp plain">size, index = 0;</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">for</code> <code class="cpp plain">(;;) {</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">start = index;</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!NT_SUCCESS(NtQueryDirectoryObject(hDirectory, info, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(buffer), FALSE, first, &amp;index, &amp;size)))</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">first = </code><code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">for</code> <code class="cpp plain">(</code><code class="cpp color1 bold">ULONG</code> <code class="cpp plain">i = 0; i &lt; index - start; i++) {</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ObjectNameAndType data;</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code><code class="cpp plain">&amp; p = info[i];</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">data.Name = std::wstring(p.Name.Buffer, p.Name.Length / </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(</code><code class="cpp color1 bold">WCHAR</code><code class="cpp plain">));</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code><code class="cpp plain">(compare &amp;&amp; !compare(data.Name.c_str()))</code></div><div class="line number33 index32 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">continue</code><code class="cpp plain">;</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">data.TypeName = std::wstring(p.TypeName.Buffer, p.TypeName.Length / </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(</code><code class="cpp color1 bold">WCHAR</code><code class="cpp plain">));</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code><code class="cpp plain">(!objectName)</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">objects.push_back(std::move(data));</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(objectName &amp;&amp; _wcsicmp(object.c_str(), data.Name.c_str()) == 0 || </code></div><div class="line number38 index37 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_wcsicmp(object.c_str(), (data.Name + </code><code class="cpp string">L"."</code> <code class="cpp plain">+ data.TypeName).c_str()) == 0) {</code></div><div class="line number39 index38 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">objects.push_back(std::move(data));</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number41 index40 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number42 index41 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number43 index42 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number44 index43 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CloseHandle(hDirectory);</code></div><div class="line number45 index44 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">objects;</code></div><div class="line number46 index45 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p><code>NtQueryDirectoryObject</code> is called in a loop with increasing indices until it fails. The returned details for each entry is the object’s name and type name.</p>



<p>Here is how to get a symbolic link’s target:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_12041" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">std::wstring ObjectManager::GetSymbolicLinkTarget(</code><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">path) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::wstring spath(path);</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(spath[0] != </code><code class="cpp string">L'\\'</code><code class="cpp plain">)</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">spath = </code><code class="cpp string">L"\\"</code> <code class="cpp plain">+ spath;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">hLink;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">OBJECT_ATTRIBUTES attr;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::wstring target;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">UNICODE_STRING name;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">RtlInitUnicodeString(&amp;name, spath.c_str());</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">InitializeObjectAttributes(&amp;attr, &amp;name, 0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">);</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(NT_SUCCESS(NtOpenSymbolicLinkObject(&amp;hLink, GENERIC_READ, &amp;attr))) {</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">WCHAR</code> <code class="cpp plain">buffer[1 &lt;&lt; 10];</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">UNICODE_STRING result;</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">result.Buffer = buffer;</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">result.MaximumLength = </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(buffer);</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(NT_SUCCESS(NtQuerySymbolicLinkObject(hLink, &amp;result, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">)))</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">target.assign(result.Buffer, result.Length / </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(</code><code class="cpp color1 bold">WCHAR</code><code class="cpp plain">));</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CloseHandle(hLink);</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">target;</code></div><div class="line number22 index21 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>See the full source code at <a href="https://github.com/zodiacon/ObjMgrProjFS">https://github.com/zodiacon/ObjMgrProjFS</a>.</p>



<h2 class="wp-block-heading">Conclusion</h2>



<p>The example provided is the bare minimum needed to write a ProjFS provider. This could be interesting for various types of data that is convenient to access with I/O APIs. Feel free to extend the example and resolve any bugs.</p>



<p></p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2024/02/20/projected-file-system/" rel="bookmark"><time class="entry-date published" datetime="2024-02-20T18:43:22+02:00">February 20, 2024</time><time class="updated" datetime="2024-02-25T18:49:58+02:00">February 25, 2024</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/dev/" rel="category tag">DEV</a>, <a href="https://scorpiosoftware.net/category/system-programming/" rel="category tag">System Programming</a>, <a href="https://scorpiosoftware.net/category/windows-internals/" rel="category tag">Windows Internals</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="https://scorpiosoftware.net/tag/coding/" rel="tag">coding</a>, <a href="https://scorpiosoftware.net/tag/dev/" rel="tag">DEV</a>, <a href="https://scorpiosoftware.net/tag/programming/" rel="tag">programming</a>, <a href="https://scorpiosoftware.net/tag/windowsinternals/" rel="tag">WindowsInternals</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2024/02/20/projected-file-system/#comments">6 Comments<span class="screen-reader-text"> on Projected File System</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1726 -->

<article id="post-1674" class="post-1674 post type-post status-publish format-standard has-post-thumbnail hentry category-dev category-system-programming category-training tag-training">
	
	<a class="post-thumbnail" href="https://scorpiosoftware.net/2024/02/02/rust-programming-masterclass-training/" aria-hidden="true">
		<img width="257" height="257" src="https://scorpiosoftware.net/wp-content/uploads/2024/02/rust.png?w=257&amp;h=257&amp;crop=1" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="Rust Programming Masterclass&nbsp;Training" decoding="async" loading="lazy" data-attachment-id="1678" data-permalink="https://scorpiosoftware.net/2024/02/02/rust-programming-masterclass-training/rust/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/rust.png" data-orig-size="257,257" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Rust" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/rust.png?w=257" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2024/02/rust.png?w=257">	</a>

		
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2024/02/02/rust-programming-masterclass-training/" rel="bookmark">Rust Programming Masterclass&nbsp;Training</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>Unless you’ve been living under a rock for the past several years (and you are a software developer), the <a href="https://www.rust-lang.org/" target="_blank" rel="noreferrer noopener">Rust programming language</a> is hard to ignore – in fact, it’s been voted as the “most loved” language for several years (whatever that means). Rust provides the power and performance of C++ with full memory and concurrency safety. It’s a system programming languages, but has high-level features like functional programming style and modularity. That said, Rust has a relatively steep learning curve compared to other mainstream languages. </p>



<p>I’m happy to announce a new training class – <strong>Rust Programming Masterclass</strong>. This is a brand new, <strong>4 day class, split into 8 half-days</strong>, that covers all the foundational pieces of Rust. Here is the list of modules:</p>



<ul class="wp-block-list">
<li>Module 1: Introduction to Rust</li>



<li>Module 2: Language Fundamentals</li>



<li>Module 3: Ownership</li>



<li>Module 4: Compound Types</li>



<li>Module 5: Common Types and Collections</li>



<li>Module 6: Modules and Project Management</li>



<li>Module 7: Error Handling</li>



<li>Module 8: Generics and Traits</li>



<li>Module 9: Smart Pointers</li>



<li>Module 10: Functional Programming</li>



<li>Module 11: Threads and Concurrency</li>



<li>Module 12: Async and Await</li>



<li>Module 13: Unsafe Rust and Interoperability</li>



<li>Module 14: Macros</li>



<li>Module 15: Lifetimes</li>
</ul>



<p>Dates are listed below. The times are <strong>11am-3pm EST </strong>(8am-12pm PST) (4pm-8pm UT)<br><strong>March</strong>: 25, 27, 29, <strong>April</strong>: 1, 3, 5, 8, 10.</p>



<p>Cost: <strong>850 USD</strong> (if paid by an individual), <strong>1500</strong> USD if paid by a company. Previous students in my classes get 10% off. </p>



<p><strong>Special bonus for this course</strong>: anyone registering gets a <strong>50% discount to any two courses</strong> at <a href="https://training.trainsec.net" rel="nofollow">https://training.trainsec.net</a>.</p>



<h2 class="wp-block-heading">Registration</h2>



<p>If you’d like to register, please send me an email to&nbsp;<a href="mailto:zodiacon@live.com" target="_blank" rel="noreferrer noopener">zodiacon@live.com</a>&nbsp;and provide your full name, company (if any), preferred contact email, and your time zone. </p>



<p>The sessions will be recorded, so you can watch any part you may be missing, or that may be somewhat overwhelming in “real time”.</p>



<p>As usual, if you have any questions, feel free to send me an email, or DM on X (twitter) or Linkedin.</p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2024/02/02/rust-programming-masterclass-training/" rel="bookmark"><time class="entry-date published" datetime="2024-02-02T20:17:14+02:00">February 2, 2024</time><time class="updated" datetime="2024-03-10T16:42:24+02:00">March 10, 2024</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/dev/" rel="category tag">DEV</a>, <a href="https://scorpiosoftware.net/category/system-programming/" rel="category tag">System Programming</a>, <a href="https://scorpiosoftware.net/tag/training/" rel="category tag">Training</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="https://scorpiosoftware.net/tag/training/" rel="tag">Training</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2024/02/02/rust-programming-masterclass-training/#comments">1 Comment<span class="screen-reader-text"> on Rust Programming Masterclass&nbsp;Training</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1674 -->

<article id="post-1541" class="post-1541 post type-post status-publish format-standard has-post-thumbnail hentry category-dev category-training category-windows-internals tag-training tag-windowsinternals">
	
	<a class="post-thumbnail" href="https://scorpiosoftware.net/2023/11/02/x64-architecture-and-programming-class/" aria-hidden="true">
		<img width="825" height="510" src="https://scorpiosoftware.net/wp-content/uploads/2023/11/x64asm.png?w=825&amp;h=510&amp;crop=1" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="x64 Architecture and Programming&nbsp;Class" decoding="async" loading="lazy" data-attachment-id="1544" data-permalink="https://scorpiosoftware.net/2023/11/02/x64-architecture-and-programming-class/x64asm/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/11/x64asm.png" data-orig-size="1497,1157" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="x64asm" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/11/x64asm.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/11/x64asm.png?w=660">	</a>

		
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2023/11/02/x64-architecture-and-programming-class/" rel="bookmark">x64 Architecture and Programming&nbsp;Class</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>I promised this class a while back, and now it is happening. This is a brand new, 3 day class, split into 6 half-days, that covers the x64 processor architecture, programming in general, and programming in the context of Windows. The syllabus can be found <a href="https://github.com/zodiacon/syllabi/blob/main/x64ArchAndProg.pdf" target="_blank" rel="noreferrer noopener">here</a>. It may change a bit, but should mostly be stable.</p>



<p>Dates are listed below. The times are <strong>12pm-4pm EST </strong>(9am-1pm PST) (5pm-9pm UT)<br><strong>January</strong>: 15, 17, 22, 24, 29, 31.</p>



<p>Cost: <strong>750 USD</strong> (if paid by an individual), <strong>1400</strong> USD if paid by a company.</p>



<h2 class="wp-block-heading">Registration</h2>



<p>If you’d like to register, please send me an email to&nbsp;<a href="mailto:zodiacon@live.com" target="_blank" rel="noreferrer noopener">zodiacon@live.com</a>&nbsp;and provide your full name, company (if any), preferred contact email, and your time zone. Previous participants in my classes get 10% off.</p>



<p>The sessions will be recorded, so you can watch any part you may be missing, or that may be somewhat overwhelming in “real time”.</p>



<p>As usual, if you have any questions, feel free to send me an email, or DM on X (twitter) or Linkedin.</p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2023/11/02/x64-architecture-and-programming-class/" rel="bookmark"><time class="entry-date published updated" datetime="2023-11-02T18:27:31+02:00">November 2, 2023</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/dev/" rel="category tag">DEV</a>, <a href="https://scorpiosoftware.net/tag/training/" rel="category tag">Training</a>, <a href="https://scorpiosoftware.net/category/windows-internals/" rel="category tag">Windows Internals</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="https://scorpiosoftware.net/tag/training/" rel="tag">Training</a>, <a href="https://scorpiosoftware.net/tag/windowsinternals/" rel="tag">WindowsInternals</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2023/11/02/x64-architecture-and-programming-class/#comments">8 Comments<span class="screen-reader-text"> on x64 Architecture and Programming&nbsp;Class</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1541 -->

<article id="post-1506" class="post-1506 post type-post status-publish format-standard has-post-thumbnail hentry category-device-drivers category-kernel category-training">
	
	<a class="post-thumbnail" href="https://scorpiosoftware.net/2023/10/07/kernel-programming-masterclass/" aria-hidden="true">
		<img width="825" height="510" src="https://scorpiosoftware.net/wp-content/uploads/2023/02/kernel3.png?w=825&amp;h=510&amp;crop=1" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="Kernel Programming MasterClass" decoding="async" loading="lazy" data-attachment-id="1050" data-permalink="https://scorpiosoftware.net/2023/02/20/windows-kernel-programming-class-recordings/kernel3/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/02/kernel3.png" data-orig-size="1586,1049" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="kernel3" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/02/kernel3.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/02/kernel3.png?w=660">	</a>

		
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2023/10/07/kernel-programming-masterclass/" rel="bookmark">Kernel Programming MasterClass</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>It’s been a while since I have taught a public class. I am happy to launch a new class that combines <strong>Windows Kernel Programming</strong> and <strong>Advanced Windows Kernel Programming</strong> into a 6-day (48 hours) masterclass. The full syllabus can be found <a href="https://github.com/zodiacon/syllabi/blob/main/KernelProgrammingMasterClass.pdf" target="_blank" rel="noreferrer noopener">here</a>.</p>



<p>There is a special bonus for those registering for this class: you get one free recorded course from <a href="https://training.trainsec.net/windows-internals-and-programming">Windows Internals and Programming (trainsec.net)</a>!</p>



<p>For those who have attended the <strong>Windows Kernel Programming</strong> class, and wish to capture the more “advanced” stuff, I offer one of two options:</p>



<ul class="wp-block-list">
<li>Join the second part (3 days) of the training, at 60% of the entire course cost.</li>



<li>Register for the entire course with a 20% discount, and get the free recorded course.<br></li>
</ul>



<p>The course is planned to stretch from mid-December to late-January, in 4-hour chunks to make it easier to combine with other activities and also have the time to do lab exercises (very important for truly understanding the material). Yes, I know christmas is in the middle there, I’ll keep the last week of December free 🙂</p>



<p>The course will be conducted remotely using MS Teams or similar.</p>



<p>Dates and times (not final, but unlikely to change much, if at all):</p>



<ul class="wp-block-list">
<li><strong>Dec 2023: 12, 14, 19, 21</strong>: 12pm-4pm EST (9am-1pm PST)</li>



<li><strong>Jan 2024: 2, 4, 9, 11, 16, 18, 23, 25</strong>: 12pm-4pm EST (9am-1pm PST)</li>
</ul>



<p><strong>Training cost:</strong></p>



<ul class="wp-block-list">
<li>Early bird (until Nov 22): 1150 USD</li>



<li>After Nov 22: 1450 USD</li>
</ul>



<p>If you’d like to register, please write to <a rel="noreferrer noopener" href="mailto:zodiacon@live.com" target="_blank">zodiacon@live.com</a> with your name, company  name (if any), and time zone. If you have any question, use the same email or DM me on <a rel="noreferrer noopener" href="https://twitter.com/zodiacon" target="_blank">X (Twitter)</a> or <a rel="noreferrer noopener" href="https://www.linkedin.com/in/pavely" target="_blank">Linkedin</a>.</p>



<p></p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2023/10/07/kernel-programming-masterclass/" rel="bookmark"><time class="entry-date published" datetime="2023-10-07T06:37:21+03:00">October 7, 2023</time><time class="updated" datetime="2023-11-02T16:33:43+02:00">November 2, 2023</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/tag/device-drivers/" rel="category tag">Device Drivers</a>, <a href="https://scorpiosoftware.net/tag/kernel/" rel="category tag">Kernel</a>, <a href="https://scorpiosoftware.net/tag/training/" rel="category tag">Training</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2023/10/07/kernel-programming-masterclass/#respond">Leave a comment<span class="screen-reader-text"> on Kernel Programming MasterClass</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1506 -->

<article id="post-1461" class="post-1461 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
	
	<a class="post-thumbnail" href="https://scorpiosoftware.net/2023/09/24/windows-hook-events/" aria-hidden="true">
		<img width="825" height="510" src="https://scorpiosoftware.net/wp-content/uploads/2023/09/winhookinjected.png?w=825&amp;h=510&amp;crop=1" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="Windows Hook Events" decoding="async" loading="lazy" data-attachment-id="1489" data-permalink="https://scorpiosoftware.net/2023/09/24/windows-hook-events/winhookinjected/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/09/winhookinjected.png" data-orig-size="904,638" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="WinHookInjected" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/09/winhookinjected.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/09/winhookinjected.png?w=660">	</a>

		
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2023/09/24/windows-hook-events/" rel="bookmark">Windows Hook Events</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>Many developers and researcher are faimilar with the <a rel="noreferrer noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexw" target="_blank"><code>SetWindowsHookEx</code> </a>API that provides ways to intercept certain operations related to user interface, such as messages targetting windows. Most of these hooks can be set on a specific thread, or all threads attached to the current desktop. A short video showing how to use this API can be found <a rel="noreferrer noopener" href="https://www.youtube.com/watch?v=uHuEgnQ1a2c" target="_blank">here</a>. One of the options is to inject a DLL to the target process(es) that is invoked inline to process the relevant events.</p>



<p>There is another mechanism, less known, that provides various events that relate to UI, that can similarly be processed by a callback. This can be attached to a specific thread or process, or to all processes that have threads attached to the current desktop. The API in question is <code><a rel="noreferrer noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexw" target="_blank">SetWinEventHook</a></code>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_228049" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">HWINEVENTHOOK SetWinEventHook(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">eventMin,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">eventMax,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_opt_ </code><code class="cpp color1 bold">HMODULE</code> <code class="cpp plain">hmodWinEventProc,</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ WINEVENTPROC pfnWinEventProc,</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">idProcess,</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">idThread,</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_In_ </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">dwFlags);</code></div></div></td></tr></tbody></table></div></div></div>


<p>The function allows invoking a callback (<code>pfnWinEventProc</code>) when an event occurs. <code>eventMin</code> and <code>eventMax</code> provide a simple way to filter events. If all events are needed, <code>EVENT_MIN</code> and <code>EVENT_MAX</code> can be used to cover every possible event. The module is needed if the function is inside a DLL, so that <code>hmodWinEventProc</code> is the module handle loaded into the calling process. The DLL will automatically be loaded into target process(es) as needed, very similar to the way <code>SetWindowsHookEx</code> works.</p>



<p><code>idProcess</code> and <code>idThread</code> allow targetting a specific thread, a specific process, or all processes in the current desktop (if both IDs are zero). Targetting all processes is possible even without a DLL. In that case, the event information is marshalled back to the caller’s process and invoked there. This does require to pass the <code>WINEVENT_OUTOFCONTEXT</code> flag to indicate this requirement. The following example shows how to install such event monitoring for all processes/threads in the current desktop:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_578790" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">auto</code> <code class="cpp plain">hHook = ::SetWinEventHook(EVENT_MIN, EVENT_MAX, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">OnEvent, 0, 0,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">WINEVENT_OUTOFCONTEXT | </code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">WINEVENT_SKIPOWNPROCESS | WINEVENT_SKIPOWNTHREAD);</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp plain">::GetMessage(</code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, 0, 0);</code></div></div></td></tr></tbody></table></div></div></div>


<p>The last two flags indicate that events from the caller’s process should not be reported. Notice the weird-looking <code><a rel="noreferrer noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getmessage" target="_blank">GetMessage</a></code> call – it’s required for the event handler to be called. The weird part is that a <code>MSG</code> structure is not needed, contrary to the function’s SAL that requires a non-<code>NULL</code> pointer.</p>



<p>The event handler itself can do anything, however, the information provided is fundamentally different than <code>SetWindowsHookEx</code> callbacks. For example, there is no way to “change” anything – it’s just notifying about things that already happended. These events are related to accessibility and are not directly related to windows messaging. Here is the event handler prototype:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_70942" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">CALLBACK OnEvent(HWINEVENTHOOK hWinEventHook, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">event, </code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">HWND</code> <code class="cpp plain">hwnd, </code><code class="cpp color1 bold">LONG</code> <code class="cpp plain">idObject, </code><code class="cpp color1 bold">LONG</code> <code class="cpp plain">idChild, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">eventTid, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp functions bold">time</code><code class="cpp plain">);</code></div></div></td></tr></tbody></table></div></div></div>


<p><code>event</code> is the event being reported. Various such events are defined in <em>WinUser.h</em> and there are many values that can be used by third paries and OEMs. It’s worthwile checking the header file because every Microsoft-defined event has details as to when such an event is raised, and the meaning of <code>idObject</code>, <code>idChild</code> and <code>hwnd</code> for that event. <code>eventTid</code> is the thread ID from which the event originated. <code>hwnd</code> is typically the window or constrol associated with the event (if any) – some events are general enough so that no <code>hwnd</code> is provided.</p>



<p>We can get more information on the object that is associated with the event by tapping into the accessibility API. Accessibility objects implement the <a rel="noreferrer noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/oleacc/nn-oleacc-iaccessible" target="_blank"><code>IAccessible</code> </a>COM interface at least, but may implement other interfaces as well. To get an <code>IAccesible</code> pointer from an event handler, we can use <code><a href="https://learn.microsoft.com/en-us/windows/win32/api/oleacc/nf-oleacc-accessibleobjectfromevent" target="_blank" rel="noreferrer noopener">AccessibleObjectFromEvent</a></code>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_432339" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">CComPtr&lt;IAccessible&gt; spAcc;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">CComVariant child;</code></div><div class="line number3 index2 alt2"><code class="cpp plain">::AccessibleObjectFromEvent(hwnd, idObject, idChild, &amp;spAcc, &amp;child);</code></div></div></td></tr></tbody></table></div></div></div>


<p>I’ve included <code>&lt;atlbase.h&gt;</code> to get the ATL client side support (smart pointers and COM type wrappers). Other APIs that can bring an <code>IAccessible</code> in other contexts include <a href="https://learn.microsoft.com/en-us/windows/win32/api/oleacc/nf-oleacc-accessibleobjectfrompoint" target="_blank" rel="noreferrer noopener"><code>AccessibleObjectFromPoint</code> </a>and <code><a href="https://learn.microsoft.com/en-us/windows/win32/api/oleacc/nf-oleacc-accessibleobjectfromwindow" target="_blank" rel="noreferrer noopener">AccessibleObjectFromWindow</a></code>.</p>



<p>Note that you must also include <code>&lt;oleacc.h&gt;</code> and link with <code>oleacc.lib</code>.</p>



<p><code>IAccessible</code> has quite a few methods and properties, the simplest of which is <code>Name</code> that is mandatory for implementors to provide:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_962245" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">CComBSTR name;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">spAcc-&gt;get_accName(CComVariant(idChild), &amp;name);</code></div></div></td></tr></tbody></table></div></div></div>


<p>Refer to the documentation for other members of <code>IAccessible</code>. We can also get the details of the process associated with the event by going through the window handle or the thread ID and retrieving the executable name. Here is an example with a window handle:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_935592" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">pid = 0;</code></div><div class="line number2 index1 alt1"><code class="cpp color1 bold">WCHAR</code> <code class="cpp plain">exeName[MAX_PATH];</code></div><div class="line number3 index2 alt2"><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">pExeName = </code><code class="cpp string">L""</code><code class="cpp plain">;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(hwnd &amp;&amp; ::GetWindowThreadProcessId(hwnd, &amp;pid)) {</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hProcess = ::OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, FALSE, pid);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(hProcess) {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">size = _countof(exeName);</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(::QueryFullProcessImageName(hProcess, 0, exeName, &amp;size))</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">pExeName = wcsrchr(exeName, </code><code class="cpp string">L'\\'</code><code class="cpp plain">) + 1;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CloseHandle(hProcess);</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number13 index12 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p><a rel="noreferrer noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getwindowthreadprocessid" target="_blank"><code>GetWindowThreadProcessId</code> </a>retrieves the process ID (and thread ID) associated with a window handle. We could go with the given thread ID – call <code>OpenThread</code> and then <code><a rel="noreferrer noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getprocessidofthread" target="_blank">GetProcessIdOfThread</a></code>. The interested reader is welcome to try this approach to retrieve the process ID. Here is the full event handler for this example dumping all using <code>printf</code>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_716943" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">CALLBACK OnEvent(HWINEVENTHOOK hWinEventHook, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">event, </code><code class="cpp color1 bold">HWND</code> <code class="cpp plain">hwnd,</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">LONG</code> <code class="cpp plain">idObject, </code><code class="cpp color1 bold">LONG</code> <code class="cpp plain">idChild, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">idEventThread, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp functions bold">time</code><code class="cpp plain">) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComPtr&lt;IAccessible&gt; spAcc;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComVariant child;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::AccessibleObjectFromEvent(hwnd, idObject, idChild, &amp;spAcc, &amp;child);</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComBSTR name;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(spAcc)</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">spAcc-&gt;get_accName(CComVariant(idChild), &amp;name);</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">pid = 0;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">WCHAR</code> <code class="cpp plain">exeName[MAX_PATH];</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">PCWSTR</code> <code class="cpp plain">pExeName = </code><code class="cpp string">L""</code><code class="cpp plain">;</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(hwnd &amp;&amp; ::GetWindowThreadProcessId(hwnd, &amp;pid)) {</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hProcess = ::OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, FALSE, pid);</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(hProcess) {</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">size = _countof(exeName);</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(::QueryFullProcessImageName(hProcess, 0, exeName, &amp;size))</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">pExeName = wcsrchr(exeName, </code><code class="cpp string">L'\\'</code><code class="cpp plain">) + 1;</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CloseHandle(hProcess);</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Event: 0x%X (%s) HWND: 0x%p, ID: 0x%X Child: 0x%X TID: %u PID: %u (%ws) Time: %u Name: %ws\n"</code><code class="cpp plain">,</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">event, EventNameToString(event),</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">hwnd, idObject, idChild, idEventThread, </code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">pid, pExeName,</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">time</code><code class="cpp plain">, name.m_str);</code></div><div class="line number27 index26 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p><code>EventNameToString</code> is a little helper converting some event IDs to names. If you run this code (<em>SimpleWinEventHook</em> project), you’ll see lots of output, because one of the reported events is <code>EVENT_OBJECT_LOCATIONCHANGE</code> that is raised (among other reasons) when the mouse cursor position changes:</p>



<pre class="wp-block-code"><code>Event: 0x800C (Name Change) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0x1DC TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78492375 Name: (null)
Event: 0x8000 (Object Create) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0x1DD TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78492375 Name: (null)
Event: 0x800C (Name Change) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0x1DD TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78492375 Name: (null)
Event: 0x8000 (Object Create) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0x1DE TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78492375 Name: (null)
Event: 0x800C (Name Change) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0x1DE TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78492375 Name: (null)
...
Event: 0x800B (Location Changed) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 72172 PID: 0 () Time: 78492562 Name: Normal
Event: 0x800B (Location Changed) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 72172 PID: 0 () Time: 78492562 Name: Normal
...
Event: 0x800B (Location Changed) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 72172 PID: 0 () Time: 78492718 Name: Vertical size
Event: 0x800B (Location Changed) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 72172 PID: 0 () Time: 78492734 Name: Vertical size
Event: 0x800C (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 72172 PID: 0 () Time: 78492734 Name: Normal
Event: 0x800A (State Changed) HWND: 0x000000000001019E, ID: 0xFFFFFFFC Child: 0x16 TID: 15636 PID: 14060 (explorer.exe) Time: 78493000 Name: (null)
Event: 0x800A (State Changed) HWND: 0x00000000000101B0, ID: 0xFFFFFFFC Child: 0x6 TID: 15636 PID: 14060 (explorer.exe) Time: 78493000 Name: (null)
Event: 0x8004 () HWND: 0x0000000000010010, ID: 0xFFFFFFFC Child: 0x0 TID: 72172 PID: 1756 () Time: 78493000 Name: Desktop
Event: 0x8 (Capture Start) HWND: 0x0000000000271D5A, ID: 0x0 Child: 0x0 TID: 72172 PID: 67928 (WindowsTerminal.exe) Time: 78493000 Name: c:\Dev\Temp\WinEventHooks\x64\Debug\SimpleWinEventHook.exe
Event: 0x800B (Location Changed) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 72172 PID: 0 () Time: 78493093 Name: Normal
Event: 0x8001 (Object Destroy) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0x45 TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78493093 Name: (null)
Event: 0x8001 (Object Destroy) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0xB0 TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78493093 Name: (null)
...
Event: 0x800C (Name Change) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0x1A TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78493093 Name: (null)
Event: 0x800C (Name Change) HWND: 0x00000000000216F6, ID: 0xFFFFFFFC Child: 0x1B TID: 39060 PID: 64932 (Taskmgr.exe) Time: 78493109 Name: (null)
Event: 0x800B (Location Changed) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 72172 PID: 0 () Time: 78493109 Name: Normal
Event: 0x9 (Capture End) HWND: 0x0000000000271D5A, ID: 0x0 Child: 0x0 TID: 72172 PID: 67928 (WindowsTerminal.exe) Time: 78493109 Name: c:\Dev\Temp\WinEventHooks\x64\Debug\SimpleWinEventHook.exe</code></pre>



<h2 class="wp-block-heading">DLL Injection</h2>



<p>Instead of getting events on the <code>SetWinEventHook</code> caller’s thread, a DLL can be injected. Such a DLL must export the event handler so that the process setting up the handler can locate the function with <code>GetProcAddress</code>.</p>



<p>As an example, I created a simple DLL that implements the event handler similarly to the previous example (without the process name) like so:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_275562" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">extern</code> <code class="cpp string">"C"</code> <code class="cpp keyword bold">__declspec</code><code class="cpp plain">(</code><code class="cpp keyword bold">dllexport</code><code class="cpp plain">)</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">void</code> <code class="cpp plain">CALLBACK OnEvent(HWINEVENTHOOK hWinEventHook, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">event, </code><code class="cpp color1 bold">HWND</code> <code class="cpp plain">hwnd,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">LONG</code> <code class="cpp plain">idObject, </code><code class="cpp color1 bold">LONG</code> <code class="cpp plain">idChild, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">idEventThread, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp functions bold">time</code><code class="cpp plain">) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComPtr&lt;IAccessible&gt; spAcc;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComVariant child;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::AccessibleObjectFromEvent(hwnd, idObject, idChild, &amp;spAcc, &amp;child);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CComBSTR name;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(spAcc)</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">spAcc-&gt;get_accName(CComVariant(idChild), &amp;name);</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Event: 0x%X (%s) HWND: 0x%p, ID: 0x%X Child: 0x%X TID: %u Time: %u Name: %ws\n"</code><code class="cpp plain">,</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">event, EventNameToString(event),</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">hwnd, idObject, idChild, idEventThread,</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">time</code><code class="cpp plain">, name.m_str);</code></div><div class="line number15 index14 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>Note the function is exported. The code uses <code>printf</code>, but there is no guarantee that a target process has a console to use. The <code>DllMain</code> function creates such a console and attached the standard output handle to it (otherwise <code>printf</code> wouldn’t have an output handle, since the process wasn’t bootstraped with a console):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_59759" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">hConsole;</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="cpp color1 bold">BOOL</code> <code class="cpp plain">APIENTRY DllMain(</code><code class="cpp color1 bold">HMODULE</code> <code class="cpp plain">hModule, </code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">reason, </code><code class="cpp color1 bold">PVOID</code> <code class="cpp plain">lpReserved) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">switch</code> <code class="cpp plain">(reason) {</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">DLL_PROCESS_DETACH:</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(hConsole)&nbsp;&nbsp; </code><code class="cpp comments">// be nice</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::CloseHandle(hConsole);</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">DLL_PROCESS_ATTACH:</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(::AllocConsole()) {</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">hConsole = ::CreateFile(</code><code class="cpp string">L"CONOUT$"</code><code class="cpp plain">, GENERIC_WRITE, </code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, OPEN_EXISTING, 0, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">);</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(hConsole == INVALID_HANDLE_VALUE)</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">FALSE;</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::SetStdHandle(STD_OUTPUT_HANDLE, hConsole);</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">TRUE;</code></div><div class="line number21 index20 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The injector process (<em>WinHookInject</em> project) first grabs a target process ID (if any):</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_6048" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">main(</code><code class="cpp color1 bold">int</code> <code class="cpp plain">argc, </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">char</code><code class="cpp plain">* argv[]) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">pid = argc &lt; 2 ? 0 : </code><code class="cpp functions bold">atoi</code><code class="cpp plain">(argv[1]);</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(pid == 0) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Warning: injecting to potentially processes with threads connected to the current desktop.\n"</code><code class="cpp plain">);</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Continue? (y/n) "</code><code class="cpp plain">);</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">char</code> <code class="cpp plain">ans[3];</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gets_s(ans);</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(</code><code class="cpp functions bold">tolower</code><code class="cpp plain">(ans[0]) != </code><code class="cpp string">'y'</code><code class="cpp plain">)</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">0;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The warning is shown of no PID is provided, because creating consoles for certain processes could wreak havoc. If you do want to inject a DLL to all processes on the desktop, avoid creating consoles.</p>



<p>Once we have a target process (or not), we need to load the DLL (hardcoded for simplicity) and grab the exported event handler function:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_137441" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">auto</code> <code class="cpp plain">hLib = ::LoadLibrary(</code><code class="cpp string">L"Injected.Dll"</code><code class="cpp plain">);</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!hLib) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"DLL not found!\n"</code><code class="cpp plain">);</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">1;</code></div><div class="line number5 index4 alt2"><code class="cpp plain">}</code></div><div class="line number6 index5 alt1"><code class="cpp keyword bold">auto</code> <code class="cpp plain">OnEvent = (WINEVENTPROC)::GetProcAddress(hLib, </code><code class="cpp string">"OnEvent"</code><code class="cpp plain">);</code></div><div class="line number7 index6 alt2"><code class="cpp keyword bold">if</code> <code class="cpp plain">(!OnEvent) {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Event handler not found!\n"</code><code class="cpp plain">);</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">1;</code></div><div class="line number10 index9 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The final step is to register the handler. If you’re targetting all processes, you’re better off limiting the events you’re interested in, especially the noisy ones. If you just want a DLL injected and you don’t care about any events, select a range that has no events and then call a relevant function to force the DLL to be loaded into the target process(es). I’ll let the interested reader figure these things out.</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_685677" class="syntaxhighlighter  plain"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="plain plain">auto hHook = ::SetWinEventHook(EVENT_MIN, EVENT_MAX, </code></div><div class="line number2 index1 alt1"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">hLib, OnEvent, pid, 0, WINEVENT_INCONTEXT);</code></div><div class="line number3 index2 alt2"><code class="plain plain">::GetMessage(nullptr, nullptr, 0, 0);</code></div></div></td></tr></tbody></table></div></div></div>


<p>Note the arguments include the DLL module, the handler address, and the flag <code>WINEVENT_INCONTEXT</code>. Here is some output when using this DLL on a Notepad instance. A console is created the first time Notepad causes an event to be raised:</p>



<pre class="wp-block-code"><code>Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 34756 Time: 70717718 Name: Edit
Event: 0x800C (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 34756 Time: 70717718 Name: Horizontal size
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 34756 Time: 70717718 Name: Horizontal size
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717734 Name: Horizontal size
Event: 0x800C (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717734 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717734 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717734 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717750 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717765 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717765 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717781 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717781 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717796 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717796 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717812 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717812 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717828 Name: Edit
Event: 0x800B (Name Change) HWND: 0x0000000000000000, ID: 0xFFFFFFF7 Child: 0x0 TID: 29516 Time: 70717843 Name: Edit
Event: 0x8 (Capture Start) HWND: 0x0000000000091CAC, ID: 0x0 Child: 0x0 TID: 29516 Time: 70717843 Name: (null)
Event: 0x3 (Foreground) HWND: 0x00000000000A1D50, ID: 0x0 Child: 0x0 TID: 34756 Time: 70717843 Name: Untitled - Notepad
Event: 0x8004 () HWND: 0x0000000000010010, ID: 0xFFFFFFFC Child: 0x0 TID: 29516 Time: 70717859 Name: Desktop 1
Event: 0x800B (Name Change) HWND: 0x00000000000A1D50, ID: 0x0 Child: 0x0 TID: 34756 Time: 70717859 Name: Untitled - Notepad
...</code></pre>



<p>The full code is at <a href="https://github.com/zodiacon/WinEventHooks">zodiacon/WinEventHooks: SetWinEventHook Sample (github.com)</a></p>



<p></p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2023/09/24/windows-hook-events/" rel="bookmark"><time class="entry-date published" datetime="2023-09-24T01:52:13+03:00">September 24, 2023</time><time class="updated" datetime="2023-09-24T17:54:06+03:00">September 24, 2023</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/uncategorized/" rel="category tag">Uncategorized</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2023/09/24/windows-hook-events/#comments">1 Comment<span class="screen-reader-text"> on Windows Hook Events</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1461 -->

<article id="post-1434" class="post-1434 post type-post status-publish format-standard has-post-thumbnail hentry category-dev">
	
	<a class="post-thumbnail" href="https://scorpiosoftware.net/2023/08/18/writing-your-own-programming-language/" aria-hidden="true">
		<img width="538" height="510" src="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png?w=538&amp;h=510&amp;crop=1" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="Writing Your Own Programming&nbsp;Language" decoding="async" loading="lazy" data-attachment-id="1437" data-permalink="https://scorpiosoftware.net/2023/08/18/writing-your-own-programming-language/image-21/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png" data-orig-size="538,558" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png?w=289" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png?w=538">	</a>

		
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2023/08/18/writing-your-own-programming-language/" rel="bookmark">Writing Your Own Programming&nbsp;Language</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>Ever since I realized BASIC wasn’t the only living programming language, I thought about writing my own. Who wouldn’t? If you’re a developer, surely this idea popped into your mind at some point. No matter how much you love a particular programming language, you always have some ideas for improvement or even removal of annoying features.</p>



<p>The post assumes you have some background in compilers, and understand concepts like tokenizing (scanning), parsing, and Abstract Syntax Trees (ASTs)</p>



<p>Obviously, writing a programming language is not for the faint of heart. Even before you set out to implement your language, you have to <em>design</em> it first. Or maybe you have some fundamental ideas that would make your language unique, and you may decide to flesh out the details while you’re implementing it.</p>



<p>A new programming language does not have to be “general-purpose” – that is, it could be a “domain specific language” (DSL), which means it’s best suited for certain domain(s) or tasks. This makes your life (usually) at least somewhat easier; in addition, you’ll be unlikely to compete with the gazillion general-purpose languages out there. Still, a general-purpose language might be your goal.</p>



<p>Designing a programming language is a big topic, well outside the scope of this post. I’ll focus on the implementation details, so to speak. There are other considerations for a programming language beyond the language itself – its accompanying standard library, tooling (e.g., some IDE or at least syntax highlighting), debugging, testing, and few more. One decision is whether to make your language compiled or interpreted. This decision may not affect some aspects of the implementation, but it will definitely affect the language’s back-end. You can even support both interpretation and compilation for maximum flexibility.</p>



<p>I played around with the idea of creating a programming language for many years, never really getting very far beyond a basic parser and a minimal interpreter. Lately, I’ve read more about <a href="https://en.wikipedia.org/wiki/Operator-precedence_parser#Pratt_parsing">Pratt Parsing</a>, that sparked my interest again. Pratt Parsing is one of many techniques for parsing expressions, something like “a+2*b”, and doing that correctly (parenthesis, operator precedence and associativity). Pratt parsing is really elegant, much more so than other techniques, and it’s also more flexible, supporting (indirectly) ternary operations and other unusual constructs. Once you have an expression parser, the rest of the parser is fairly easy to implement (relatively speaking) using the recursive-descent approach which is well suited for hand-crafted parsers.</p>



<p>Robert Nystrom gives a nice introduction to <a href="https://journal.stuffwithstuff.com/2011/03/19/pratt-parsers-expression-parsing-made-easy/">Pratt Parsing</a> and an elegant idea for implementing it. His implementation is in Java, but there is a link to a <a href="https://github.com/jfcardinal/BantamCs">C# implementation</a> and even one in Rust. My go-to language is C++ (still), so you know where this is going. I’ve implemented a Pratt parser based on Robert’s ideas, and it turned out very well.</p>



<p>I’ve also been interested in visualization (a term which has way too much stuffed into it), but I thought I’d start small. A popular teaching language in the 80s was <a href="https://en.wikipedia.org/wiki/Logo_(programming_language)">LOGO</a>. Although it was treated as a “toy language”, it was a full-blown language, mostly resembling LISP internally.</p>



<p>However, LOGO became famous because of the “Turtle Graphics” built-in support that was provided, which allowed drawing with an imaginary turtle (you could even ask LOGO to show it) that would follow your commands like moving forward, backwards, rotating, lifting the pen and putting it back down. Why not create a fun version of Turtle Graphics with ideas from LOGO?</p>



<p>Here is an example from LOGO to draw a symmetric hexagon:</p>



<p>REPEAT 6 [ FD 100 RT 60 ]</p>



<p>You can probably guess what is going on here. “FD” is “forward” and “RT” is “right”, although it could be mistaken for “rotate”. LOGO supported functions as well, so you could create complex shapes by reusing functions.</p>



<p>My language, called “Logo2” for a lack of originality at this time, tries to capture that fun drawing, but put the syntax more inline with the C-family of functions, which I like more. The above hexagon is written with Logo2 like so:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_487205" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">repeat 6 {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">fd(100); rt(60);</code></div><div class="line number3 index2 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p></p>



<p>Indentation is not significant, so it all could be placed on the same line. You can also define functions and execute them:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_210431" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">fn circle(size, steps) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">repeat steps {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">fd(size); rt(360 / steps);</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number5 index4 alt2"><code class="cpp plain">}</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp plain">repeat 10 {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">circle(80, 20); rt(36);</code></div><div class="line number9 index8 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<figure class="wp-block-image size-large"><img data-attachment-id="1437" data-permalink="https://scorpiosoftware.net/2023/08/18/writing-your-own-programming-language/image-21/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png" data-orig-size="538,558" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png?w=289" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png?w=538" loading="lazy" width="538" height="558" src="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png?w=538" alt="" class="wp-image-1437" srcset="https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png 538w, https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png?w=145 145w, https://scorpiosoftware.net/wp-content/uploads/2023/08/image.png?w=289 289w" sizes="(max-width: 538px) 100vw, 538px"></figure>



<p></p>



<p>I also added support for colors, with the <strong>pencolor</strong>(r,g,b) function, something I don’t recall LOGO having in the 80s.</p>



<h1 class="wp-block-heading">Implementation</h1>



<p>There are 3 main projects in the solution (a fourth project in the works to create a simple IDE for easier experimentation):</p>



<ul class="wp-block-list">
<li>Logo2Core – contains the tokenizer, parser, and interpreter.</li>



<li>Logo2Runtime – contains the runtime support for turtle graphics, currently using GDI+.</li>



<li>Logo2 – is a simple REPL, that can parse and execute single line statements. If you provide a command line argument, it’s treated as file name to be parsed and executed. Anything not inside a function is executed directly (for now).</li>
</ul>



<h2 class="wp-block-heading">The Tokenizer</h2>



<p>The tokenizer’s job (Tokenizer class) is to read text and turn it into a bunch of tokens. A token is a single unit of the language, like a number, keyword, identifier, operator, etc. To start tokenization, the <strong>Tokenize</strong> method can be invoked with the string to tokenize.</p>



<p>The <strong>Next()</strong> method returns the next token, whereas the <strong>Peek()</strong> method returns the next token without advancing the stream forward. This means the tokenizer is not doing all the work immediately, but only advanced to the next token when requested. The parser is the one “driving” the tokenizer.</p>



<p>The implementation of the tokenizer is not perfect, but it works well-enough. I didn’t want to use any existing tools like YACC (or BISON), for a couple reasons. For one, I don’t like generated code that I have little control colover. Second, I like to understand what I am writing. Writing a tokenizer is not rocket science, but it’s not trivial, either. And since one of my goals is to experiment, I need the freedom not available with generated code.</p>



<h1 class="wp-block-heading">The Parser</h1>



<p>The parser is much more interesting than the tokenizer (by far). This is where the syntax of the language is fleshed out. Just like with tokenization, usage of tools like LEX (or FLEX) is inappropriate. In fact, most languages have their own hand-written parser. The parser accepts a string to parse (<strong>Parse</strong> method) or a filename (<strong>ParseFile</strong> method) and begins the parsing. It calls on the tokenizer when the next token is needed.</p>



<p>The <strong>Init</strong> method of the parser initializes the tokenizer with the specific tokens it should be able to recognize (like specific keywords and operators), and also initializes its own “parslets” (defined in the above mentioned article) to make Pratt Parsing work. I will not show here the Pratt Parsing part since there’s quite a bit of code there, but here is an example of parsing the “repeat” statement:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_201747" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">std::unique_ptr&lt;RepeatStatement&gt; Parser::ParseRepeatStatement() {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Next();&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// eat "repeat"</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">times = ParseExpression();</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_LoopCount++;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">block = ParseBlock();</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_LoopCount--;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">std::make_unique&lt;RepeatStatement&gt;(</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::move(times), std::move(block));</code></div><div class="line number10 index9 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p><strong>ParseExpression</strong> parses an expression to be used for the argument to repeat. Then <strong>ParseBlock</strong> is called to parse a curly-brace surrounded block of code. Finally, the result is an AST node representing a “repeat” statement is created, initialized, and returned to the caller.</p>



<p>The <strong>m_LoopCount</strong> variable is incremented when entering loop parsing and decremented afterwards. This is done so that parsing the keywords <strong>break</strong> and <strong>continue</strong> can check if there is any enclosing loop for these keywords to make sense.</p>



<p>Here is <strong>ParseBlock</strong>:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_231885" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">std::unique_ptr&lt;BlockExpression&gt;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">Parser::ParseBlock(std::vector&lt;std::string&gt; </code><code class="cpp keyword bold">const</code><code class="cpp plain">&amp; args) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!Match(TokenType::OpenBrace))</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">AddError(ParserError(ParseErrorType::OpenBraceExpected, Peek()));</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_Symbols.push(std::make_unique&lt;SymbolTable&gt;(m_Symbols.top().get()));</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">for</code> <code class="cpp plain">(</code><code class="cpp keyword bold">auto</code><code class="cpp plain">&amp; arg : args) {</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Symbol sym;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">sym.Name = arg;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">sym.Flags = SymbolFlags::None;</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">sym.Type = SymbolType::Argument;</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">AddSymbol(sym);</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">block = std::make_unique&lt;BlockExpression&gt;();</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">while</code> <code class="cpp plain">(Peek().Type != TokenType::CloseBrace) {</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">stmt = ParseStatement();</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!stmt)</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">block-&gt;Add(std::move(stmt));</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Next();&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// eat close brace</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_Symbols.pop();</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">block;</code></div><div class="line number26 index25 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p><strong>ParseBlock</strong> starts by making sure there is an open curly brace. Then it creates a symbol table and pushes it to be the “current” as there is a new scope within the block. The parameter to <strong>ParseBlock</strong> is used when parsing a function body, where these “args” are the parameters to the function. If this is the case, they are added to the symbol table as local variables.</p>



<p>The main work is to call <strong>ParseStatement</strong> as many times as needed until a close brace is encountered. The block is a vector of statements being filled up. Finally, the symbol table is popped and the AST node is returned.</p>



<p><strong>ParseStatement</strong> is a big switch that calls the appropriate specific parsing method based on the first token encountered. Here is an excerpt:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_741357" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">std::unique_ptr&lt;Statement&gt; Parser::ParseStatement() {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">peek = Peek();</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(peek.Type == TokenType::Invalid) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">nullptr</code><code class="cpp plain">;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">switch</code> <code class="cpp plain">(peek.Type) {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Keyword_Var: </code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">ParseVarConstStatement(</code><code class="cpp keyword bold">false</code><code class="cpp plain">);</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Keyword_Const: </code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">ParseVarConstStatement(</code><code class="cpp keyword bold">true</code><code class="cpp plain">);</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Keyword_Repeat: </code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">ParseRepeatStatement();</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Keyword_While: </code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">ParseWhileStatement();</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Keyword_Fn: </code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">ParseFunctionDeclaration();</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Keyword_Return: </code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">ParseReturnStatement();</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Keyword_Break: </code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">ParseBreakContinueStatement(</code><code class="cpp keyword bold">false</code><code class="cpp plain">);</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Keyword_Continue:</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">ParseBreakContinueStatement(</code><code class="cpp keyword bold">true</code><code class="cpp plain">);</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">expr = ParseExpression();</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(expr) {</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Match(TokenType::SemiColon);</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">std::make_unique&lt;ExpressionStatement&gt;(std::move(expr));</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">AddError(ParserError(ParseErrorType::InvalidStatement, peek));</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">nullptr</code><code class="cpp plain">;</code></div><div class="line number32 index31 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>If a statement is not recognized, an expression parsing is attempted. This allows using Logo2 as a simple calculator, for example. <strong>ParseStatement</strong> is where the support for more statements is added based on an initial token.</p>



<p>Once an AST is built by the parser, the next step is to execute the AST by some interpreter. In a more complex language (maybe once it grows some more), some semantic analysis may be appropriate, which is about looking at the usage of the language beyond the syntax. For now, we’ll just interpret what we have, and if any error is encountered it’s going to be a runtime error. Some parsing errors can be caught without semantic analysis, but some cannot.</p>



<h1 class="wp-block-heading">The Interpreter</h1>



<p>The <strong>Interpreter</strong> class provides the runtime behavior, by “executing” the AST. It receives the root of the AST tree constructed by the parser by implementing the well-known <a href="https://en.wikipedia.org/wiki/Visitor_pattern">Visitor design pattern</a>, whose purpose here is to decouple between the AST node types and the way they are handled by the interpreter. Alternatively, it would be possible to add a virtual “Execute” or “Eval” method to AST nodes, so the nodes can “evaluate” themselves, but that creates coupling, and goes against the single-responsibility principle (SRP) that states that a class should have one and only one job. Using the visitor pattern also makes it easier to add semantic analysis later without modifying the AST node types.</p>



<p>The gist of the visitor pattern is to have an “Accept” method in the AST nodes that calls back to whoever (the visitor) with the current node details. For example, here it is for a binary operator:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_863194" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">class</code> <code class="cpp plain">BinaryExpression : </code><code class="cpp keyword bold">public</code> <code class="cpp plain">Expression {</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">public</code><code class="cpp plain">:</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">BinaryExpression(std::unique_ptr&lt;Expression&gt; left, </code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Token op, std::unique_ptr&lt;Expression&gt; right);</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Value Accept(Visitor* visitor) </code><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">override</code><code class="cpp plain">;</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::string ToString() </code><code class="cpp keyword bold">const</code> <code class="cpp keyword bold">override</code><code class="cpp plain">;</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Expression* Left() </code><code class="cpp keyword bold">const</code><code class="cpp plain">;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Expression* Right() </code><code class="cpp keyword bold">const</code><code class="cpp plain">;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Token </code><code class="cpp keyword bold">const</code><code class="cpp plain">&amp; Operator() </code><code class="cpp keyword bold">const</code><code class="cpp plain">;</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="cpp keyword bold">private</code><code class="cpp plain">:</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::unique_ptr&lt;Expression&gt; m_Left, m_Right;</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Token m_Operator;</code></div><div class="line number16 index15 alt1"><code class="cpp plain">};</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="cpp plain">Value BinaryExpression::Accept(Visitor* visitor) </code><code class="cpp keyword bold">const</code> <code class="cpp plain">{</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">visitor-&gt;VisitBinary(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number20 index19 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>This same idea is repeated for all concrete AST nodes. The <strong>Visitor </strong>type is abstract, implemented by the <strong>Interpreter</strong> class having methods like: <strong>VisitBinary</strong>, <strong>VisitRepeat</strong>, etc.</p>



<p>Each one of these “Visit” method’s purpose is to “execute” (or evaluate) that node. Here is an excerpt for the binary expression visiting:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_829266" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">Value Interpreter::VisitBinary(BinaryExpression </code><code class="cpp keyword bold">const</code><code class="cpp plain">* expr) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">switch</code> <code class="cpp plain">(expr-&gt;Operator().Type) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Add: </code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">expr-&gt;Left()-&gt;Accept(</code><code class="cpp keyword bold">this</code><code class="cpp plain">) + expr-&gt;Right()-&gt;Accept(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Sub:</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">expr-&gt;Left()-&gt;Accept(</code><code class="cpp keyword bold">this</code><code class="cpp plain">) - expr-&gt;Right()-&gt;Accept(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Mul:</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">expr-&gt;Left()-&gt;Accept(</code><code class="cpp keyword bold">this</code><code class="cpp plain">) * expr-&gt;Right()-&gt;Accept(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TokenType::Div:</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">expr-&gt;Left()-&gt;Accept(</code><code class="cpp keyword bold">this</code><code class="cpp plain">) / expr-&gt;Right()-&gt;Accept(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">Value();</code></div><div class="line number13 index12 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>Here it is for “repeat”:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_490005" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">Value Interpreter::VisitRepeat(RepeatStatement </code><code class="cpp keyword bold">const</code><code class="cpp plain">* expr) {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">count = Eval(expr-&gt;Count());</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!count.IsInteger())</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">throw</code> <code class="cpp plain">RuntimeError(ErrorType::TypeMismatch, expr-&gt;Count());</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">n = count.Integer();</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">while</code> <code class="cpp plain">(n-- &gt; 0) {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">try</code> <code class="cpp plain">{</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Eval(expr-&gt;Block());</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">catch</code> <code class="cpp plain">(BreakOrContinue </code><code class="cpp keyword bold">const</code><code class="cpp plain">&amp; bc) {</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!bc.Continue)</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">nullptr</code><code class="cpp plain">;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// repeat has no return value</code></div><div class="line number17 index16 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>You should get the idea at this point. (<strong>Eval</strong> is just a simple wrapper that calls <strong>Accept</strong> with the provided node).</p>



<p>The <strong>Value </strong>type used with the above code (the one returned from <strong>Accept</strong> methods is the way to represent “values” in Logo2. Logo2 is a dynamically typed language (at least for now), so variables can hold any one of a listed of supported types, encapsulated in <strong>Value</strong>. You can think of that as a C-style union. Specifically, it wraps a <strong>std::variant&lt;&gt;</strong> C++17 type that currently supports the following: 64-bit integer, 64-bit floating point (double), bool, string (std::string), and null (representing no value). The list of possibilities will increase, allowing user-defined types as well.</p>



<h1 class="wp-block-heading">Turtle Graphics</h1>



<p>The <strong>Logo2Runtime</strong> project contains the support for managing turtles, and displaying their “drawings”. The <strong>Turtle</strong> class is a graphics-free type to manage the state of the turtle – its position and heading, but also a list of “command” indicating operations the turtle has been instructed to do, such as drawing a line, changing color, or changing width of drawing. This list is necessary whenever a window’s output needs to be refreshed.</p>



<p>The <strong>Window</strong> class servers as a wrapper for an HWND, that also has the “power” to draw a set of turtle commands. Here is its <strong>DrawTurtle</strong> method:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_600670" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">Window::DrawTurtle(Gdiplus::Graphics&amp; g, Turtle* t) </code><code class="cpp keyword bold">const</code> <code class="cpp plain">{</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">for</code> <code class="cpp plain">(</code><code class="cpp keyword bold">auto</code><code class="cpp plain">&amp; cmd : t-&gt;GetCommands()) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">DrawTurtleCommand(g, t, cmd);</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number5 index4 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>Each command does the right thing:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_520472" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">Window::DrawTurtleCommand(Gdiplus::Graphics&amp; g, Turtle* t, </code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">TurtleCommand </code><code class="cpp keyword bold">const</code><code class="cpp plain">&amp; cmd) </code><code class="cpp keyword bold">const</code> <code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">switch</code> <code class="cpp plain">(cmd.Type) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TurtleCommandType::DrawLine:</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">g.DrawLine(m_Pen.get(), cmd.Line.From.X, </code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">cmd.Line.From.Y, cmd.Line.To.X, cmd.Line.To.Y);</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TurtleCommandType::SetWidth:</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Color color;</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_Pen-&gt;GetColor(&amp;color);</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_Pen.reset(</code><code class="cpp keyword bold">new</code> <code class="cpp plain">Pen(color, cmd.Width));</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">TurtleCommandType::SetColor:</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Color color;</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">color.SetValue(cmd.Color);</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">m_Pen.reset(</code><code class="cpp keyword bold">new</code> <code class="cpp plain">Pen(color, m_Pen-&gt;GetWidth()));</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number25 index24 alt2"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>The graphical objects are GDI+ objects provided by the Windows API. Of course, it would be possible to switch to a different API. I chose GDI+ for its flexibility and 2D capabilities.</p>



<p>The <strong>Runtime</strong> class ties a turtle and a window together. It holds on to a (single) Turtle object and single Window object. In the future, this is going to be more dynamic, so any number of windows and turtles can be created, even more than one turtle in the same window.</p>



<h1 class="wp-block-heading">The REPL</h1>



<p>A simple REPL is implemented in the <strong>Logo2</strong> project. It’s not trivial, as there is a user interface that must be kept alive, meaning messages have to be pumped. This means using functions like <strong>gets_s</strong> is not good enough, as they block the calling thread. Assuming the UI is on the same thread, this will cause the UI to become non-responsive. For now, the same thread is used, so that no special synchronization is required. The downside is that a custom input “loop” has to be written, and currently it’s very simple, and only supports the BACKSPACE key for typing error correction.</p>



<p>The first step is to get the input, key by key. If there is no key available, messages are pumped. A WM_QUIT message indicates it’s time to exit. Not very elegant, but here goes:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_155390" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">Tokenizer t;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">Parser parser(t);</code></div><div class="line number3 index2 alt2"><code class="cpp plain">Interpreter inter;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">Runtime runtime(inter);</code></div><div class="line number5 index4 alt2"><code class="cpp plain">runtime.Init();</code></div><div class="line number6 index5 alt1"><code class="cpp plain">runtime.CreateLogoWindow(</code><code class="cpp string">L"Logo 2"</code><code class="cpp plain">, 800, 800);</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="cpp keyword bold">for</code> <code class="cpp plain">(;;) {</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::print(</code><code class="cpp string">"&gt;&gt; "</code><code class="cpp plain">);</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::string input;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">int</code> <code class="cpp plain">ch = 0;</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">MSG msg{};</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">while</code> <code class="cpp plain">(ch != 13) {</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">while</code> <code class="cpp plain">(::PeekMessage(&amp;msg, </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">, 0, 0, PM_REMOVE) &amp;&amp; </code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">msg.message != WM_QUIT) {</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::TranslateMessage(&amp;msg);</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">::DispatchMessage(&amp;msg);</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(msg.message == WM_QUIT)</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_kbhit()) {</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ch = _getch();</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(isprint(ch)) {</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">input += (</code><code class="cpp color1 bold">char</code><code class="cpp plain">)ch;</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"%c"</code><code class="cpp plain">, ch);</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">else</code> <code class="cpp keyword bold">if</code> <code class="cpp plain">(ch == 8) {&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// backspace</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"\b \b"</code><code class="cpp plain">);</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">input = input.substr(0, input.length() - 1);</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">else</code> <code class="cpp plain">{</code></div><div class="line number33 index32 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_kbhit())</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_getch();</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number38 index37 alt1">&nbsp;</div><div class="line number39 index38 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(msg.message == WM_QUIT)</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div></div></td></tr></tbody></table></div></div></div>


<p>Once we have a line of input, it’s time to parse and (if no errors occur), execute:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_508558" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">try</code> <code class="cpp plain">{</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"\n"</code><code class="cpp plain">);</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">ast = parser.Parse(input);</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(parser.HasErrors()) {</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">for</code> <code class="cpp plain">(</code><code class="cpp keyword bold">auto</code><code class="cpp plain">&amp; err : parser.Errors()) {</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Error (%d,%d): %d\n"</code><code class="cpp plain">, </code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">err.ErrorToken.Line, err.ErrorToken.Col, err.Error);</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">continue</code><code class="cpp plain">;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">try</code> <code class="cpp plain">{</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">auto</code> <code class="cpp plain">result = ast-&gt;Accept(&amp;inter); </code><code class="cpp comments">// execute!</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(result != </code><code class="cpp keyword bold">nullptr</code><code class="cpp plain">)</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">std::println(</code><code class="cpp string">"{}"</code><code class="cpp plain">, result.ToString());</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">catch</code> <code class="cpp plain">(RuntimeError </code><code class="cpp keyword bold">const</code><code class="cpp plain">&amp; err) {</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Runtime error: %d\n"</code><code class="cpp plain">, (</code><code class="cpp color1 bold">int</code><code class="cpp plain">)err.Error);</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number19 index18 alt2"><code class="cpp plain">}</code></div><div class="line number20 index19 alt1"><code class="cpp keyword bold">catch</code> <code class="cpp plain">(ParserError </code><code class="cpp keyword bold">const</code><code class="cpp plain">&amp; err) {</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Error (%d,%d): %d\n"</code><code class="cpp plain">, err.ErrorToken.Line, </code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">err.ErrorToken.Col, err.Error);</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">continue</code><code class="cpp plain">;</code></div><div class="line number24 index23 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div></div>


<p>Some parser errors are accumulated in a vector, some throw an exception (errors where it would be difficult for the parser to recover confidently). At runtime, errors could occur as well, such as the wrong types being used with certain operations.</p>



<h1 class="wp-block-heading">Conclusion</h1>



<p>Writing a language can be lots of fun. You can invent your “dream” language. For me, the Logo2 experiment is ongoing. I’m planning to build a simple IDE, to extend the language to support user-defined types, lambdas (with closures), and much more. Your ideas are welcome as well!</p>



<p>The project is at <a href="https://github.com/zodiacon/Logo2">zodiacon/Logo2 (github.com)</a></p>



<p></p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2023/08/18/writing-your-own-programming-language/" rel="bookmark"><time class="entry-date published" datetime="2023-08-18T03:57:15+03:00">August 18, 2023</time><time class="updated" datetime="2023-08-18T21:28:13+03:00">August 18, 2023</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/dev/" rel="category tag">DEV</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2023/08/18/writing-your-own-programming-language/#comments">3 Comments<span class="screen-reader-text"> on Writing Your Own Programming&nbsp;Language</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1434 -->

<article id="post-1343" class="post-1343 post type-post status-publish format-standard has-post-thumbnail hentry category-system-programming category-uncategorized category-windows-internals tag-systemprogramming tag-windowsinternals">
	
	<a class="post-thumbnail" href="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/" aria-hidden="true">
		<img width="825" height="510" src="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=825&amp;h=510&amp;crop=1" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" alt="Thread Priorities in&nbsp;Windows" decoding="async" loading="lazy" data-attachment-id="1359" data-permalink="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/priorities/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png" data-orig-size="1539,938" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="priorities" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=660">	</a>

		
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/" rel="bookmark">Thread Priorities in&nbsp;Windows</a></h2>	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>When a thread is created, it has some priority, which sets its importance compared to other threads competing for CPU time. The thread priority range is 0 to 31 (31 being the highest), where priority zero is used by the memory manager’s zero-page thread(s), whose purpose is to zero out physical pages (for reasons outside the scope of this post), so technically the allowed priority range is 1 to 31.</p>



<p>It stands to reason (to some extent), that a developer could change a thread’s priority to some valid value in the range of 1 to 31, but this is not the case. The Windows API sets up rules as to how thread priorities may change. First, there is a <strong>process priority class</strong> (sometimes called <strong>Base Priority</strong>), that specifies the default thread priority within that process. Processes don’t run – threads do, but still this is a process property and affects all threads in the process. You can see the value of this property very simply with Task Manager’s <strong>Base Priority</strong> column (not visible by default):</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1349" data-permalink="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/image-20/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image.png" data-orig-size="943,588" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image.png?w=660" loading="lazy" width="943" height="588" src="https://scorpiosoftware.net/wp-content/uploads/2023/07/image.png?w=943" alt="" class="wp-image-1349" srcset="https://scorpiosoftware.net/wp-content/uploads/2023/07/image.png 943w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image.png?w=768 768w" sizes="(max-width: 943px) 100vw, 943px"></figure>



<p>Base Priority column in Task Manager</p>



<p>There are six priority classes (the priority of which is specified after the colon):</p>



<ul class="wp-block-list">
<li><strong>Idle</strong> (called <strong>Low </strong>in Task Manager, probably not to give the wrong impression): 4</li>



<li><strong>Below Normal</strong> (6)</li>



<li><strong>Normal </strong>(8)</li>



<li><strong>Above Normal</strong> (10)</li>



<li><strong>Highest </strong>(13)</li>



<li><strong>Realtime </strong>(24)</li>
</ul>



<p>A few required notes:</p>



<ul class="wp-block-list">
<li>Normal is the default priority class unless overridden in some way. For example, double-clicking an executable in Explorer will launch a new process with priority class of Normal (8).</li>



<li>The term “Realtime” does not imply Windows is a real-time OS; it’s not. “Real-time” just means “higher than all the others”.</li>



<li>To set the Realtime priority class, the process in question must have the <strong>SeIncreaseBasePriorityPrivilege</strong>, normally granted to administrators. If “Realtime” is requested, but the process’s token does not poses that privilege, the result is “High”. The reason has do to with the fact that many kernel threads have priorities in the real-time range, and it could be problematic if too many threads spend a lot of time running in these priorities, potentially leading to kernel threads getting less time than they need.</li>
</ul>



<p>Is this the end of the story? Not quite. For example, looking at Task Manager, processes like <strong>Csrss.exe</strong> (Windows subsystem process) or <strong>Smss.exe</strong> (Session manager) seem to have a priority class of Normal as well. Is this really the case? Yes and no (everyone likes that kind of answer, right?) We’ll get to that soon.</p>



<h2 class="wp-block-heading">Setting a Thread’s priority</h2>



<p>Changing the process priority class is possible with the <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setpriorityclass" target="_blank" rel="noreferrer noopener"><code>SetPriorityClass</code> </a>API. For example, a process can change its own priority class like so:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_63142" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">::SetPriorityClass(::GetCurrentProcess(), HIGH_PRIORITY_CLASS);</code></div></div></td></tr></tbody></table></div></div></div>


<p>You can do the same in .NET by utilizing the <code><a href="https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.process?view=net-7.0" target="_blank" rel="noreferrer noopener">System.Diagnostics.Process</a></code> class:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_356537" class="syntaxhighlighter nogutter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">Process.GetCurrentProcess().PriorityClass = ProcessPriorityClass.High;</code></div></div></td></tr></tbody></table></div></div></div>


<p>You can also change priority class using Task Manager or Process Explorer, by right-clicking a process and selecting “Set Priority”.</p>



<p>Once the priority class is changed, it affects all threads in that process. But how?</p>



<p>It turns out that a specific thread’s priority can be changed around the process priority class. The following diagram shows the full picture:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1359" data-permalink="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/priorities/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png" data-orig-size="1539,938" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="priorities" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=660" loading="lazy" width="1024" height="624" src="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=1024" alt="" class="wp-image-1359" srcset="https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=1024 1024w, https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png?w=768 768w, https://scorpiosoftware.net/wp-content/uploads/2023/07/priorities.png 1539w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>Every small rectangle in the above diagram indicates a valid thread priority. For example, the Normal priority classes allows setting thread priorities to 1, 6, 7, 8, 9, 10, 15. To be more generic, here are the rules for all except the Realtime class. A thread priority is by default the same as the process priority class, but it can be -1, -2, +1, +2 from that base, or have two extreme values (internally called “Saturation”) with the values 1 and 15.</p>



<p>The Realtime range is unique, where the base priority is 24, but all priorities from 16 to 31 are available. The <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadpriority" target="_blank" rel="noreferrer noopener"><code>SetThreadPriority</code> </a>API that can be used to change an individual thread’s priority accepts an enumeration value (as its second argument) rather than an absolute value. Here are the macro definitions:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_393554" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp preprocessor">#define THREAD_PRIORITY_LOWEST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // -2&nbsp; </code></div><div class="line number2 index1 alt1"><code class="cpp preprocessor">#define THREAD_PRIORITY_BELOW_NORMAL&nbsp;&nbsp; // -1</code></div><div class="line number3 index2 alt2"><code class="cpp preprocessor">#define THREAD_PRIORITY_NORMAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 0</code></div><div class="line number4 index3 alt1"><code class="cpp preprocessor">#define THREAD_PRIORITY_HIGHEST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // + 2</code></div><div class="line number5 index4 alt2"><code class="cpp preprocessor">#define THREAD_PRIORITY_ABOVE_NORMAL&nbsp;&nbsp; // + 1</code></div><div class="line number6 index5 alt1"><code class="cpp preprocessor">#define THREAD_PRIORITY_TIME_CRITICAL&nbsp; // 15 or 31</code></div><div class="line number7 index6 alt2"><code class="cpp preprocessor">#define THREAD_PRIORITY_IDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 1 or 16</code></div></div></td></tr></tbody></table></div></div></div>


<p>Here is an example of changing the current thread’s priority to +2 compared to the process priority class:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_149849" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">::SetThreadPriority(::GetCurrentThread(), THREAD_PRIORITY_HIGHEST);</code></div></div></td></tr></tbody></table></div></div></div>


<p>And a C# version:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_499432" class="syntaxhighlighter nogutter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp plain">Thread.CurrentThread.Priority = ThreadPriority.Highest;</code></div></div></td></tr></tbody></table></div></div></div>


<p>You can see threads priorities in <em>Process Explorer</em>‘s bottom view:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1362" data-permalink="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/image-2-11/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png" data-orig-size="1324,557" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-2" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png?w=660" loading="lazy" width="1024" height="430" src="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png?w=1024" alt="" class="wp-image-1362" srcset="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png?w=1022 1022w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png?w=768 768w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-2.png 1324w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>Thread priorities in Process Explorer</p>



<p>There are two columns for priorities – A base priority and a Dynamic priority. The base priority is the priority set by code (<code>SetThreadPriority</code>) or the default, while the dynamic priority is the current thread’s priority, which could be slightly higher than the base (temporarily), and is changed because of certain decisions made by the kernel scheduler and other components and drivers that can produce such an effect. These thread boosting scenarios are outside the scope of this post.</p>



<p>If you want to see all threads in the system with their priorities, you can use my <a href="https://github.com/zodiacon/SystemExplorer" target="_blank" rel="noreferrer noopener">System Explorer</a> tool, and select <strong>System</strong> / <strong>Threads</strong> menu item:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1366" data-permalink="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/image-3-10/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png" data-orig-size="1034,602" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-3" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png?w=660" loading="lazy" width="1024" height="596" src="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png?w=1024" alt="" class="wp-image-1366" srcset="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png?w=1024 1024w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png?w=768 768w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-3.png 1034w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>System Explorer showing all threads in the system</p>



<p>The two priority column are shown (Priority is the same as Dynamic Priority in Process Explorer). You can sort by any column, including the priority to see which threads have the highest priority.</p>



<h2 class="wp-block-heading">Native APIs</h2>



<p>If you look in Process Explorer, there is a column named <strong>Base Priority</strong> under the Process Performance tab:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1369" data-permalink="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/image-4-10/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-4.png" data-orig-size="345,486" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-4" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-4.png?w=213" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-4.png?w=345" loading="lazy" width="345" height="486" src="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-4.png?w=345" alt="" class="wp-image-1369" srcset="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-4.png 345w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-4.png?w=106 106w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-4.png?w=213 213w" sizes="(max-width: 345px) 100vw, 345px"></figure>



<p>Process Performance tab</p>



<p>With this column visible, it indicates a process priority with a number. It’s mostly the corresponding number to the priority class (e.g. 10 for Above Normal, 13 for High, etc.), but not always. For example, <strong>Smss.exe</strong> has a value of 11, which doesn’t correspond to any priority class. <strong>Csrss.exe</strong> processes have a value of 13.</p>



<p>Changing to these numbers can only be done with the Native API. Specifically, <code>NtSetInformationProcess</code> with the <code>ProcessBasePriority</code> enumeration value can make that change. Weirdly enough, if the value is higher than the current process priority, the same privilege mentioned earlier is required. The weird part, is that calling <code>SetPriorityClass</code> to change Normal to High always works, but calling <code>NtSetInformationProcess</code>  to change from 8 to 13 (the same as Normal to High) requires that privilege; oh, well.</p>



<p>What about a specific thread? The native API allows changing a priority of a thread to any given value directly without the need to depend on the process priority class. Choosing a priority in the realtime range (16 or higher) still requires that privilege. But at least you get the flexibility to choose any priority value. The call to use is <code>NtSetInformationThread</code> with <code>ThreadPriority</code> enumeration. For example:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_463927" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">KPRIORITY priority = 14;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">NtSetInformationThread(NtCurrentThread(), ThreadPriority, </code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">&amp;priority, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(priority));</code></div></div></td></tr></tbody></table></div></div></div>


<p>Note: the definitions for the native API can be obtained from the <a href="https://github.com/winsiderss/phnt" target="_blank" rel="noreferrer noopener"><em>phnt</em> project</a>.</p>



<p>What happens if you need a high priority (16 or higher) but don’t have admin privileges in the process? Enter the Multimedia Class Scheduler.</p>



<h2 class="wp-block-heading">The MMCSS Service</h2>



<p>The multimedia class service coupled with a driver (<strong>mmcss.sys</strong>) provide a thread priority service intended for “multimedia” applications that would like to get some guarantee when “playing” multimedia. For example, if you have Spotify running locally, you’ll find there is one thread with priority 22, although the process itself has a priority class Normal:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1375" data-permalink="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/image-5-8/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png" data-orig-size="1125,528" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-5" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png?w=660" loading="lazy" width="1024" height="480" src="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png?w=1024" alt="" class="wp-image-1375" srcset="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png?w=1024 1024w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png?w=768 768w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-5.png 1125w" sizes="(max-width: 1024px) 100vw, 1024px"></figure>



<p>Spotify threads</p>



<p>You can use the MMCSS API to get that kind of support. There is a Registry key that defines several “tasks” applications can use. Third parties can add more tasks:</p>



<figure class="wp-block-image size-large"><img data-attachment-id="1377" data-permalink="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/image-6-6/" data-orig-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-6.png" data-orig-size="815,460" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="image-6" data-image-description="" data-image-caption="" data-medium-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-6.png?w=300" data-large-file="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-6.png?w=660" loading="lazy" width="815" height="460" src="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-6.png?w=815" alt="" class="wp-image-1377" srcset="https://scorpiosoftware.net/wp-content/uploads/2023/07/image-6.png 815w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-6.png?w=150 150w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-6.png?w=300 300w, https://scorpiosoftware.net/wp-content/uploads/2023/07/image-6.png?w=768 768w" sizes="(max-width: 815px) 100vw, 815px"></figure>



<p>MMCSS tasks </p>



<p>The base key is: <strong>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks</strong></p>



<p>The selected “Audio” task has several properties that are read by the MMCSS service. The most important is <strong>Priority</strong>, which is between 1 (low) and 8 (high) representing the relative priority compared to other “tasks”. Some values aren’t currently used (GPU Priority, SFIO Priority), so don’t expect anything from these.</p>



<p>Here is an example that uses the MMCSS API to increase the current thread’s priority:</p>


<div class="wp-block-syntaxhighlighter-code "><div><div id="highlighter_521334" class="syntaxhighlighter nogutter  cpp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp preprocessor">#include &lt;Windows.h&gt;</code></div><div class="line number2 index1 alt1"><code class="cpp preprocessor">#include &lt;avrt.h&gt;</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="cpp preprocessor">#pragma comment(lib, "avrt")</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp color1 bold">int</code> <code class="cpp plain">main() {</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code> <code class="cpp plain">index = 0;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">HANDLE</code> <code class="cpp plain">h = AvSetMmThreadCharacteristics(</code><code class="cpp string">L"Audio"</code><code class="cpp plain">, &amp;index);</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">AvSetMmThreadPriority(h, AVRT_PRIORITY_HIGH);</code></div></div></td></tr></tbody></table></div></div></div>


<p>The priority itself is an enumeration, where each value corresponds to a range of priorities (all above 15).</p>



<p>The returned <code>HANDLE</code> by the way, is to the MMCSS device (\Device\MMCSS). The argument to <a href="https://learn.microsoft.com/en-us/windows/win32/api/avrt/nf-avrt-avsetmmthreadcharacteristicsw" target="_blank" rel="noreferrer noopener"><code>AvSetMmThreadCharacteristics</code> </a>must correspond to one of the “Tasks” registered. Calling <a href="https://learn.microsoft.com/en-us/windows/win32/api/avrt/nf-avrt-avrevertmmthreadcharacteristics" target="_blank" rel="noreferrer noopener"><code>AvRevertMmThreadCharacteristics</code> </a>reverts the thread to “normal”. There are more APIs in that set, check the docs.</p>



<p>Happy Threading!</p>



<p></p>
	</div><!-- .entry-content -->

	
	<footer class="entry-footer">
		<span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/" rel="bookmark"><time class="entry-date published updated" datetime="2023-07-14T23:28:41+03:00">July 14, 2023</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="https://scorpiosoftware.net/category/system-programming/" rel="category tag">System Programming</a>, <a href="https://scorpiosoftware.net/category/uncategorized/" rel="category tag">Uncategorized</a>, <a href="https://scorpiosoftware.net/category/windows-internals/" rel="category tag">Windows Internals</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="https://scorpiosoftware.net/tag/systemprogramming/" rel="tag">SystemProgramming</a>, <a href="https://scorpiosoftware.net/tag/windowsinternals/" rel="tag">WindowsInternals</a></span><span class="comments-link"><a href="https://scorpiosoftware.net/2023/07/14/thread-priorities-in-windows/#comments">3 Comments<span class="screen-reader-text"> on Thread Priorities in&nbsp;Windows</span></a></span>			</footer><!-- .entry-footer -->

</article><!-- #post-1343 -->

	<nav class="navigation pagination" aria-label="Posts">
		<h2 class="screen-reader-text">Posts navigation</h2>
		<div class="nav-links"><span aria-current="page" class="page-numbers current"><span class="meta-nav screen-reader-text">Page </span>1</span>
<a class="page-numbers" href="https://scorpiosoftware.net/page/2/"><span class="meta-nav screen-reader-text">Page </span>2</a>
<span class="page-numbers dots">…</span>
<a class="page-numbers" href="https://scorpiosoftware.net/page/6/"><span class="meta-nav screen-reader-text">Page </span>6</a>
<a class="next page-numbers" href="https://scorpiosoftware.net/page/2/">Next page</a></div>
	</nav>
		</main><!-- .site-main -->
	</div><!-- .content-area -->


	</div><!-- .site-content -->

	<footer id="colophon" class="site-footer" role="contentinfo">
		<div class="site-info">
									<a href="https://wordpress.com/?ref=footer_blog" rel="nofollow">Blog at WordPress.com.</a>
		</div><!-- .site-info -->
	</footer><!-- .site-footer -->

</div><!-- .site -->

		<script type="text/javascript">
		var infiniteScroll = {"settings":{"id":"main","ajaxurl":"https:\/\/scorpiosoftware.net\/?infinity=scrolling","type":"scroll","wrapper":true,"wrapper_class":"infinite-wrap","footer":"page","click_handle":"1","text":"Older posts","totop":"Scroll back to top","currentday":"14.07.23","order":"DESC","scripts":[],"styles":[],"google_analytics":false,"offset":1,"history":{"host":"scorpiosoftware.net","path":"\/page\/%d\/","use_trailing_slashes":true,"parameters":""},"query_args":{"error":"","m":"","p":0,"post_parent":"","subpost":"","subpost_id":"","attachment":"","attachment_id":0,"name":"","pagename":"","page_id":0,"second":"","minute":"","hour":"","day":0,"monthnum":0,"year":0,"w":0,"category_name":"","tag":"","cat":"","tag_id":"","author":"","author_name":"","feed":"","tb":"","paged":0,"meta_key":"","meta_value":"","preview":"","s":"","sentence":"","title":"","fields":"","menu_order":"","embed":"","category__in":[],"category__not_in":[],"category__and":[],"post__in":[],"post__not_in":[],"post_name__in":[],"tag__in":[],"tag__not_in":[],"tag__and":[],"tag_slug__in":[],"tag_slug__and":[],"post_parent__in":[],"post_parent__not_in":[],"author__in":[],"author__not_in":[],"search_columns":[],"lazy_load_term_meta":false,"posts_per_page":10,"ignore_sticky_posts":false,"suppress_filters":false,"cache_results":true,"update_post_term_cache":true,"update_menu_item_cache":false,"update_post_meta_cache":true,"post_type":"","nopaging":false,"comments_per_page":"50","no_found_rows":false,"order":"DESC"},"query_before":"2024-06-15 09:24:40","last_post_date":"2023-07-14 23:28:41","body_class":"infinite-scroll neverending","loading_text":"Loading new page","stats":"blog=143820068&v=wpcom&tz=3&user_id=0&subd=zodiacon&x_pagetype=infinite"}};
		</script>
		<!--  -->
<script src="//0.gravatar.com/js/hovercards/hovercards.min.js?ver=2024244cee4591fae4bea45ee2571078613ea2fab8a404a7b5ceb1cf2b511ebc67fadd" id="grofiles-cards-js"></script>
<script id="wpgroho-js-extra">
var WPGroHo = {"my_hash":""};
</script>
<script crossorigin="anonymous" type="text/javascript" src="https://s0.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1610363240i"></script>

	<script>
		// Initialize and attach hovercards to all gravatars
		( function() {
			function init() {
				if ( typeof Gravatar === 'undefined' ) {
					return;
				}

				if ( typeof Gravatar.init !== 'function' ) {
					return;
				}

				Gravatar.profile_cb = function ( hash, id ) {
					WPGroHo.syncProfileData( hash, id );
				};

				Gravatar.my_hash = WPGroHo.my_hash;
				Gravatar.init(
					'body',
					'#wp-admin-bar-my-account',
					{
						i18n: {
							'Edit your profile': 'Edit your profile',
							'View profile': 'View profile',
							'Sorry, we are unable to load this Gravatar profile.': 'Sorry, we are unable to load this Gravatar profile.',
							'Sorry, we are unable to load this Gravatar profile. Please check your internet connection.': 'Sorry, we are unable to load this Gravatar profile. Please check your internet connection.',
							'Too Many Requests.': 'Too Many Requests.',
							'Internal Server Error.': 'Internal Server Error.',
						},
					}
				);
			}

			if ( document.readyState !== 'loading' ) {
				init();
			} else {
				document.addEventListener( 'DOMContentLoaded', init );
			}
		} )();
	</script>

		<div style="display:none">
	</div>
		<div id="infinite-footer">
			<div class="container">
				<div class="blog-info">
					<a id="infinity-blog-title" href="https://scorpiosoftware.net/" rel="home" title="Scroll back to top">
						Pavel Yosifovich					</a>
				</div>
				<div class="blog-credits">
					<a href="https://wordpress.com/?ref=footer_blog" rel="nofollow">Blog at WordPress.com.</a> 				</div>
			</div>
		</div><!-- #infinite-footer -->
			<div id="actionbar" class="actnbr-pub-twentyfifteen actnbr-has-follow">
		<ul>
								<li class="actnbr-btn actnbr-hidden">
								<a class="actnbr-action actnbr-actn-follow " href="">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path clip-rule="evenodd" d="m4 4.5h12v6.5h1.5v-6.5-1.5h-1.5-12-1.5v1.5 10.5c0 1.1046.89543 2 2 2h7v-1.5h-7c-.27614 0-.5-.2239-.5-.5zm10.5 2h-9v1.5h9zm-5 3h-4v1.5h4zm3.5 1.5h-1v1h1zm-1-1.5h-1.5v1.5 1 1.5h1.5 1 1.5v-1.5-1-1.5h-1.5zm-2.5 2.5h-4v1.5h4zm6.5 1.25h1.5v2.25h2.25v1.5h-2.25v2.25h-1.5v-2.25h-2.25v-1.5h2.25z" fill-rule="evenodd"></path></svg>
			<span>Subscribe</span>
		</a>
		<a class="actnbr-action actnbr-actn-following  no-display" href="">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 4.5H4V15C4 15.2761 4.22386 15.5 4.5 15.5H11.5V17H4.5C3.39543 17 2.5 16.1046 2.5 15V4.5V3H4H16H17.5V4.5V12.5H16V4.5ZM5.5 6.5H14.5V8H5.5V6.5ZM5.5 9.5H9.5V11H5.5V9.5ZM12 11H13V12H12V11ZM10.5 9.5H12H13H14.5V11V12V13.5H13H12H10.5V12V11V9.5ZM5.5 12H9.5V13.5H5.5V12Z" fill="#008A20"></path><path class="following-icon-tick" d="M13.5 16L15.5 18L19 14.5" stroke="#008A20" stroke-width="1.5"></path></svg>
			<span>Subscribed</span>
		</a>
							<div class="actnbr-popover tip tip-top-left actnbr-notice" id="follow-bubble">
							<div class="tip-arrow"></div>
							<div class="tip-inner actnbr-follow-bubble">
															<ul>
											<li class="actnbr-sitename">
			<a href="https://scorpiosoftware.net">
				<img alt="" src="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=50" srcset="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=50 1x, https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=75 1.5x, https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=100 2x, https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=150 3x, https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=200 4x" class="avatar avatar-50" height="50" width="50">				Pavel Yosifovich			</a>
		</li>
										<div class="actnbr-message no-display"></div>
									<form method="post" action="https://subscribe.wordpress.com" accept-charset="utf-8" style="display: none;">
																						<div class="actnbr-follow-count">Join 80 other subscribers</div>
																					<div>
										<input type="email" name="email" placeholder="Enter your email address" class="actnbr-email-field" aria-label="Enter your email address">
										</div>
										<input type="hidden" name="action" value="subscribe">
										<input type="hidden" name="blog_id" value="143820068">
										<input type="hidden" name="source" value="https://scorpiosoftware.net/">
										<input type="hidden" name="sub-type" value="actionbar-follow">
										<input type="hidden" id="_wpnonce" name="_wpnonce" value="1d29eb165e">										<div class="actnbr-button-wrap">
											<button type="submit" value="Sign me up">
												Sign me up											</button>
										</div>
									</form>
									<li class="actnbr-login-nudge">
										<div>
											Already have a WordPress.com account? <a href="https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fscorpiosoftware.net%252F2024%252F06%252F01%252Fbuilding-a-verifier-dll%252F">Log in now.</a>										</div>
									</li>
								</ul>
															</div>
						</div>
					</li>
							<li class="actnbr-ellipsis actnbr-hidden">
				<svg class="gridicon gridicons-ellipsis" height="24" width="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M7 12c0 1.104-.896 2-2 2s-2-.896-2-2 .896-2 2-2 2 .896 2 2zm12-2c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zm-7 0c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2z"></path></g></svg>				<div class="actnbr-popover tip tip-top-left actnbr-more">
					<div class="tip-arrow"></div>
					<div class="tip-inner">
						<ul>
									<li class="actnbr-sitename">
			<a href="https://scorpiosoftware.net">
				<img alt="" src="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=50" srcset="https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=50 1x, https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=75 1.5x, https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=100 2x, https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=150 3x, https://scorpiosoftware.net/wp-content/uploads/2018/08/cropped-beeker.png?w=200 4x" class="avatar avatar-50" height="50" width="50">				Pavel Yosifovich			</a>
		</li>
								<li class="actnbr-folded-customize">
								<a href="https://zodiacon.wordpress.com/wp-admin/customize.php?url=https%3A%2F%2Fzodiacon.wordpress.com%2F">
									<svg class="gridicon gridicons-customize" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path d="M2 6c0-1.505.78-3.08 2-4 0 .845.69 2 2 2 1.657 0 3 1.343 3 3 0 .386-.08.752-.212 1.09.74.594 1.476 1.19 2.19 1.81L8.9 11.98c-.62-.716-1.214-1.454-1.807-2.192C6.753 9.92 6.387 10 6 10c-2.21 0-4-1.79-4-4zm12.152 6.848l1.34-1.34c.607.304 1.283.492 2.008.492 2.485 0 4.5-2.015 4.5-4.5 0-.725-.188-1.4-.493-2.007L18 9l-2-2 3.507-3.507C18.9 3.188 18.225 3 17.5 3 15.015 3 13 5.015 13 7.5c0 .725.188 1.4.493 2.007L3 20l2 2 6.848-6.848c1.885 1.928 3.874 3.753 5.977 5.45l1.425 1.148 1.5-1.5-1.15-1.425c-1.695-2.103-3.52-4.092-5.448-5.977z"></path></g></svg>									<span>Customize</span>
								</a>
							</li>
																<li class="actnbr-folded-follow">
												<a class="actnbr-action actnbr-actn-follow " href="">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path clip-rule="evenodd" d="m4 4.5h12v6.5h1.5v-6.5-1.5h-1.5-12-1.5v1.5 10.5c0 1.1046.89543 2 2 2h7v-1.5h-7c-.27614 0-.5-.2239-.5-.5zm10.5 2h-9v1.5h9zm-5 3h-4v1.5h4zm3.5 1.5h-1v1h1zm-1-1.5h-1.5v1.5 1 1.5h1.5 1 1.5v-1.5-1-1.5h-1.5zm-2.5 2.5h-4v1.5h4zm6.5 1.25h1.5v2.25h2.25v1.5h-2.25v2.25h-1.5v-2.25h-2.25v-1.5h2.25z" fill-rule="evenodd"></path></svg>
			<span>Subscribe</span>
		</a>
		<a class="actnbr-action actnbr-actn-following  no-display" href="">
			<svg class="gridicon" height="20" width="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 4.5H4V15C4 15.2761 4.22386 15.5 4.5 15.5H11.5V17H4.5C3.39543 17 2.5 16.1046 2.5 15V4.5V3H4H16H17.5V4.5V12.5H16V4.5ZM5.5 6.5H14.5V8H5.5V6.5ZM5.5 9.5H9.5V11H5.5V9.5ZM12 11H13V12H12V11ZM10.5 9.5H12H13H14.5V11V12V13.5H13H12H10.5V12V11V9.5ZM5.5 12H9.5V13.5H5.5V12Z" fill="#008A20"></path><path class="following-icon-tick" d="M13.5 16L15.5 18L19 14.5" stroke="#008A20" stroke-width="1.5"></path></svg>
			<span>Subscribed</span>
		</a>
										</li>
																	<li class="actnbr-signup"><a href="https://wordpress.com/start/">Sign up</a></li>
									<li class="actnbr-login"><a href="https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fscorpiosoftware.net%252F2024%252F06%252F01%252Fbuilding-a-verifier-dll%252F">Log in</a></li>
																	<li class="flb-report">
										<a href="https://wordpress.com/abuse/?report_url=https://scorpiosoftware.net" target="_blank" rel="noopener noreferrer">
											Report this content										</a>
									</li>
																	<li class="actnbr-reader">
										<a href="https://wordpress.com/read/feeds/86421249">
											View site in Reader										</a>
									</li>
																	<li class="actnbr-subs">
										<a href="https://subscribe.wordpress.com/">Manage subscriptions</a>
									</li>
																		<li class="actnbr-fold"><a href="">Collapse this bar</a></li>
															</ul>
					</div>
				</div>
			</li>
		</ul>
	</div>
	
<script>
window.addEventListener( "load", function( event ) {
	var link = document.createElement( "link" );
	link.href = "https://s0.wp.com/wp-content/mu-plugins/actionbar/actionbar.css?v=20240115";
	link.type = "text/css";
	link.rel = "stylesheet";
	document.head.appendChild( link );

	var script = document.createElement( "script" );
	script.src = "https://s0.wp.com/wp-content/mu-plugins/actionbar/actionbar.js?v=20231122";
	script.defer = true;
	document.body.appendChild( script );
} );
</script>

			<div id="jp-carousel-loading-overlay">
			<div id="jp-carousel-loading-wrapper">
				<span id="jp-carousel-library-loading">&nbsp;</span>
			</div>
		</div>
		<div class="jp-carousel-overlay" style="display: none;">

		<div class="jp-carousel-container">
			<!-- The Carousel Swiper -->
			<div class="jp-carousel-wrap swiper-container jp-carousel-swiper-container jp-carousel-transitions" itemscope="" itemtype="https://schema.org/ImageGallery">
				<div class="jp-carousel swiper-wrapper"></div>
				<div class="jp-swiper-button-prev swiper-button-prev">
					<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<mask id="maskPrev" mask-type="alpha" maskUnits="userSpaceOnUse" x="8" y="6" width="9" height="12">
							<path d="M16.2072 16.59L11.6496 12L16.2072 7.41L14.8041 6L8.8335 12L14.8041 18L16.2072 16.59Z" fill="white"></path>
						</mask>
						<g mask="url(#maskPrev)">
							<rect x="0.579102" width="23.8823" height="24" fill="#FFFFFF"></rect>
						</g>
					</svg>
				</div>
				<div class="jp-swiper-button-next swiper-button-next">
					<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<mask id="maskNext" mask-type="alpha" maskUnits="userSpaceOnUse" x="8" y="6" width="8" height="12">
							<path d="M8.59814 16.59L13.1557 12L8.59814 7.41L10.0012 6L15.9718 12L10.0012 18L8.59814 16.59Z" fill="white"></path>
						</mask>
						<g mask="url(#maskNext)">
							<rect x="0.34375" width="23.8822" height="24" fill="#FFFFFF"></rect>
						</g>
					</svg>
				</div>
			</div>
			<!-- The main close buton -->
			<div class="jp-carousel-close-hint">
				<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<mask id="maskClose" mask-type="alpha" maskUnits="userSpaceOnUse" x="5" y="5" width="15" height="14">
						<path d="M19.3166 6.41L17.9135 5L12.3509 10.59L6.78834 5L5.38525 6.41L10.9478 12L5.38525 17.59L6.78834 19L12.3509 13.41L17.9135 19L19.3166 17.59L13.754 12L19.3166 6.41Z" fill="white"></path>
					</mask>
					<g mask="url(#maskClose)">
						<rect x="0.409668" width="23.8823" height="24" fill="#FFFFFF"></rect>
					</g>
				</svg>
			</div>
			<!-- Image info, comments and meta -->
			<div class="jp-carousel-info">
				<div class="jp-carousel-info-footer">
					<div class="jp-carousel-pagination-container">
						<div class="jp-swiper-pagination swiper-pagination"></div>
						<div class="jp-carousel-pagination"></div>
					</div>
					<div class="jp-carousel-photo-title-container">
						<h2 class="jp-carousel-photo-caption"></h2>
					</div>
					<div class="jp-carousel-photo-icons-container">
						<a href="#" class="jp-carousel-icon-btn jp-carousel-icon-info" aria-label="Toggle photo metadata visibility">
							<span class="jp-carousel-icon">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="maskInfo" mask-type="alpha" maskUnits="userSpaceOnUse" x="2" y="2" width="21" height="20">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M12.7537 2C7.26076 2 2.80273 6.48 2.80273 12C2.80273 17.52 7.26076 22 12.7537 22C18.2466 22 22.7046 17.52 22.7046 12C22.7046 6.48 18.2466 2 12.7537 2ZM11.7586 7V9H13.7488V7H11.7586ZM11.7586 11V17H13.7488V11H11.7586ZM4.79292 12C4.79292 16.41 8.36531 20 12.7537 20C17.142 20 20.7144 16.41 20.7144 12C20.7144 7.59 17.142 4 12.7537 4C8.36531 4 4.79292 7.59 4.79292 12Z" fill="white"></path>
									</mask>
									<g mask="url(#maskInfo)">
										<rect x="0.8125" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>
							</span>
						</a>
												<a href="#" class="jp-carousel-icon-btn jp-carousel-icon-comments" aria-label="Toggle photo comments visibility">
							<span class="jp-carousel-icon">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="maskComments" mask-type="alpha" maskUnits="userSpaceOnUse" x="2" y="2" width="21" height="20">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M4.3271 2H20.2486C21.3432 2 22.2388 2.9 22.2388 4V16C22.2388 17.1 21.3432 18 20.2486 18H6.31729L2.33691 22V4C2.33691 2.9 3.2325 2 4.3271 2ZM6.31729 16H20.2486V4H4.3271V18L6.31729 16Z" fill="white"></path>
									</mask>
									<g mask="url(#maskComments)">
										<rect x="0.34668" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>

								<span class="jp-carousel-has-comments-indicator" aria-label="This image has comments."></span>
							</span>
						</a>
											</div>
				</div>
				<div class="jp-carousel-info-extra">
					<div class="jp-carousel-info-content-wrapper">
						<div class="jp-carousel-photo-title-container">
							<h2 class="jp-carousel-photo-title"></h2>
						</div>
						<div class="jp-carousel-comments-wrapper">
															<div id="jp-carousel-comments-loading">
									<span>Loading Comments...</span>
								</div>
								<div class="jp-carousel-comments"></div>
								<div id="jp-carousel-comment-form-container">
									<span id="jp-carousel-comment-form-spinner">&nbsp;</span>
									<div id="jp-carousel-comment-post-results"></div>
																														<form id="jp-carousel-comment-form">
												<label for="jp-carousel-comment-form-comment-field" class="screen-reader-text">Write a Comment...</label>
												<textarea name="comment" class="jp-carousel-comment-form-field jp-carousel-comment-form-textarea" id="jp-carousel-comment-form-comment-field" placeholder="Write a Comment..."></textarea>
												<div id="jp-carousel-comment-form-submit-and-info-wrapper">
													<div id="jp-carousel-comment-form-commenting-as">
																													<fieldset>
																<label for="jp-carousel-comment-form-email-field">Email (Required)</label>
																<input type="text" name="email" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-email-field">
															</fieldset>
															<fieldset>
																<label for="jp-carousel-comment-form-author-field">Name (Required)</label>
																<input type="text" name="author" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-author-field">
															</fieldset>
															<fieldset>
																<label for="jp-carousel-comment-form-url-field">Website</label>
																<input type="text" name="url" class="jp-carousel-comment-form-field jp-carousel-comment-form-text-field" id="jp-carousel-comment-form-url-field">
															</fieldset>
																											</div>
													<input type="submit" name="submit" class="jp-carousel-comment-form-button" id="jp-carousel-comment-form-button-submit" value="Post Comment">
												</div>
											</form>
																											</div>
													</div>
						<div class="jp-carousel-image-meta">
							<div class="jp-carousel-title-and-caption">
								<div class="jp-carousel-photo-info">
									<h3 class="jp-carousel-caption" itemprop="caption description"></h3>
								</div>

								<div class="jp-carousel-photo-description"></div>
							</div>
							<ul class="jp-carousel-image-exif" style="display: none;"></ul>
							<a class="jp-carousel-image-download" href="#" target="_blank" style="display: none;">
								<svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<mask id="mask0" mask-type="alpha" maskUnits="userSpaceOnUse" x="3" y="3" width="19" height="18">
										<path fill-rule="evenodd" clip-rule="evenodd" d="M5.84615 5V19H19.7775V12H21.7677V19C21.7677 20.1 20.8721 21 19.7775 21H5.84615C4.74159 21 3.85596 20.1 3.85596 19V5C3.85596 3.9 4.74159 3 5.84615 3H12.8118V5H5.84615ZM14.802 5V3H21.7677V10H19.7775V6.41L9.99569 16.24L8.59261 14.83L18.3744 5H14.802Z" fill="white"></path>
									</mask>
									<g mask="url(#mask0)">
										<rect x="0.870605" width="23.8823" height="24" fill="#FFFFFF"></rect>
									</g>
								</svg>
								<span class="jp-carousel-download-text"></span>
							</a>
							<div class="jp-carousel-image-map" style="display: none;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>

		</div>
		<script crossorigin="anonymous" type="text/javascript" src="https://s0.wp.com/_static/??-eJzTLy/QTc7PK0nNK9EvyClNz8wr1i+uzCtJrMjITM/IAeKS1CJMEWP94uSizIISoOIM5/yiVL2sYh19yo1yKioFmldQQFXjgjMSi6hqYkB+eWpRcEZqTg5VTc1JzMwDGmifa2toZmhqYm5maWyUBQBP4KGe"></script>
<script type="text/javascript">
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://s0.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.head.appendChild( corecss );
		var themecssurl = "https://s0.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?m=1363304414i&amp;ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		document.head.appendChild( themecss );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();

	// Infinite scroll support
	document.addEventListener( 'is.post-load', function () {
		SyntaxHighlighter.highlight();
	} );
</script>
<link crossorigin="anonymous" rel="stylesheet" id="all-css-0-2" href="https://s0.wp.com/_static/??-eJyljUsKhDAQRC80mXZGDLiQOUsmaSTa+ZBOI95eBN260E3BK4pXsGRlU6wYKwRRmWT0kWHCmo2dD4aQ0h5OCBmsKUkYCXjxGYv6S3SEb8v8gge2c3QWd4XVEzo1GiIs6xXtB78wfHT/7Zu203raAHg3ZXE=&amp;cssminify=yes" type="text/css" media="all">
<script id="coblocks-loader-js-extra">
var wpcom_coblocks_js = {"coblocks_masonry_js":"https:\/\/s0.wp.com\/wp-content\/plugins\/coblocks\/2.18.1-simple-rev.4\/dist\/js\/coblocks-masonry.min.js","coblocks_lightbox_js":"https:\/\/s0.wp.com\/wp-content\/plugins\/coblocks\/2.18.1-simple-rev.4\/dist\/js\/coblocks-lightbox.min.js","jquery_core_js":"\/wp-includes\/js\/jquery\/jquery.min.js","jquery_migrate_js":"\/wp-includes\/js\/jquery\/jquery-migrate.min.js","masonry_js":"\/wp-includes\/js\/masonry.min.js","imagesloaded_js":"\/wp-includes\/js\/imagesloaded.min.js"};
var coblocksLigthboxData = {"closeLabel":"Close Gallery","leftLabel":"Previous","rightLabel":"Next"};
</script>
<script id="twentyfifteen-script-js-extra">
var screenReaderText = {"expand":"<span class=\"screen-reader-text\">expand child menu<\/span>","collapse":"<span class=\"screen-reader-text\">collapse child menu<\/span>"};
</script>
<script id="jetpack-carousel-js-extra">
var jetpackSwiperLibraryPath = {"url":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/jetpack-plugin\/moon\/_inc\/build\/carousel\/swiper-bundle.min.js"};
var jetpackCarouselStrings = {"widths":[370,700,1000,1200,1400,2000],"is_logged_in":"","lang":"en","ajaxurl":"https:\/\/scorpiosoftware.net\/wp-admin\/admin-ajax.php","nonce":"f0302a32e7","display_exif":"1","display_comments":"1","single_image_gallery":"1","single_image_gallery_media_file":"","background_color":"black","comment":"Comment","post_comment":"Post Comment","write_comment":"Write a Comment...","loading_comments":"Loading Comments...","download_original":"View full size <span class=\"photo-size\">{0}<span class=\"photo-size-times\">\u00d7<\/span>{1}<\/span>","no_comment_text":"Please be sure to submit some text with your comment.","no_comment_email":"Please provide an email address to comment.","no_comment_author":"Please provide your name to comment.","comment_post_error":"Sorry, but there was an error posting your comment. Please try again later.","comment_approved":"Your comment was approved.","comment_unapproved":"Your comment is in moderation.","camera":"Camera","aperture":"Aperture","shutter_speed":"Shutter Speed","focal_length":"Focal Length","copyright":"Copyright","comment_registration":"0","require_name_email":"1","login_url":"https:\/\/zodiacon.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fscorpiosoftware.net%2F2024%2F06%2F01%2Fbuilding-a-verifier-dll%2F","blog_id":"143820068","meta_data":["camera","aperture","shutter_speed","focal_length","copyright"],"stats_query_args":"blog=143820068&v=wpcom&tz=3&user_id=0&subd=zodiacon","is_public":"1"};
</script>
<script crossorigin="anonymous" type="text/javascript" src="https://s0.wp.com/_static/??-eJyVkF1Ow0AMhC+EY0JBhAfEUVCy8RYnXnu1P4TcnoIIoKqC9nFG/sYe4xLBmRbSgqFClLpnzThRib2bvzQGM8VnVodDZRmR1bNyIcgumcim1yawNlO+wl+pW6SzQczNGW+atmtayByiECR6bW5x5Fxw+hkCsX6kdCqvvFCgjLEOWJaDsXr2hUg/8DxzBGGdwZurGTy/XYL7qq6wab4EWqKzcAyc/0rXJ6uZ5HtuM051Pz+2sNAI+16E0vqX+mfNdg181jySB+4pPLb3193d7qHdddM7LDDdFw=="></script>

	<script type="text/javascript">
		(function () {
			var wpcom_reblog = {
				source: 'toolbar',

				toggle_reblog_box_flair: function (obj_id, post_id) {

					// Go to site selector. This will redirect to their blog if they only have one.
					const postEndpoint = `https://wordpress.com/post`;

					// Ideally we would use the permalink here, but fortunately this will be replaced with the 
					// post permalink in the editor.
					const originalURL = `${ document.location.href }?page_id=${ post_id }`; 
					
					const url =
						postEndpoint +
						'?url=' +
						encodeURIComponent( originalURL ) +
						'&is_post_share=true' +
						'&v=5';

					const redirect = function () {
						if (
							! window.open( url, '_blank' )
						) {
							location.href = url;
						}
					};

					if ( /Firefox/.test( navigator.userAgent ) ) {
						setTimeout( redirect, 0 );
					} else {
						redirect();
					}
				},
			};

			window.wpcom_reblog = wpcom_reblog;
		})();
	</script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script>		<script type="text/javascript">
			(function() {
				var extend = function(out) {
					out = out || {};

					for (var i = 1; i < arguments.length; i++) {
						if (!arguments[i])
						continue;

						for (var key in arguments[i]) {
						if (arguments[i].hasOwnProperty(key))
							out[key] = arguments[i][key];
						}
					}

					return out;
				};
				extend( window.infiniteScroll.settings.scripts, ["mobile-useragent-info","rlt-proxy","jquery-core","jquery-migrate","jquery","media-video-jwt-bridge","wpcom-actionbar-placeholder","grofiles-cards","wpgroho","syntaxhighlighter-core","syntaxhighlighter-brush-cpp","syntaxhighlighter-brush-csharp","syntaxhighlighter-brush-powershell","syntaxhighlighter-brush-plain","the-neverending-homepage","coblocks-loader","twentyfifteen-skip-link-focus-fix","twentyfifteen-script","twentyfifteen-wpcom-js","jetpack-carousel","tiled-gallery","carousel-wpcom"] );
				extend( window.infiniteScroll.settings.styles, ["twentyfifteen-jetpack","the-neverending-homepage","wp-block-library","wp-block-library-theme","mediaelement","wp-mediaelement","jetpack-layout-grid","jetpack-ratings","coblocks-frontend","wpcom-core-compat-playlist-styles","wpcom-bbpress2-staff-css","genericons","twentyfifteen-style","twentyfifteen-block-style","twentyfifteen-wpcom-style","geo-location-flair","reblogging","infinity-twentyfifteen","h4-global","wp-emoji-styles","videopress-video-style","jetpack-sharing-buttons-style","classic-theme-styles","global-styles","twentyfifteen-fonts","twentyfifteen-ie","twentyfifteen-ie7","jetpack-global-styles-frontend-style","jetpack-carousel-swiper-css","jetpack-carousel","tiled-gallery","core-block-supports-duotone"] );
			})();
		</script>
				<span id="infinite-aria" aria-live="polite"></span>
		<script src="//stats.wp.com/w.js?67" defer=""></script> <script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'143820068','blog_tz':'3','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'143820068','v':'wpcom','tz':'3','user_id':'0','subd':'zodiacon'}]);
		_stq.push(['extra', {'crypt':'UE40eW5QN0p8M2Y/RE1mNzc2NTVTamdsd0xoLz9RQkM2K298TXY9bERQMXc2MjhEaVZfb2wwakRoSj0mUkp1THptM1NdbkV1WjZIcU9mVWQmPUIvMlN6Jk8wW3NYVEJ3dWZOWExuWD9VNTEucGV1WGZBY2VVS08lWVNlMVF2clB4Y1EmPTFYfkFzb2dRd2lQZ1NfdmFySWUtT2c3czk3Z2slLTg9MDd2ZGNqcC5bTlAuYml2ZWcsaHZBfD9RSmRldGUrWnxUWW4sLStuWXJZNFFMQ1pNNyZ6b3NGOE85anYyd0RMUit8SVMmdlJLR0hjMGolT0wzJmcxNjNiLF01Ln4ufGE1UXlieUd0TjV6TW5MfFRXcURBRHhCdVlSUU5KcEJvT2M4QnBCMD1TN1hHLmxFZ3BScGFmTWNkZQ=='}]);
_stq.push([ 'clickTrackerInit', '143820068', '0' ]);
</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:1px;width:1px;overflow:hidden;position:absolute;bottom:1px;" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script>



<iframe style="display: none;" scrolling="no" id="wpcom_remote_login_key" src="https://r-login.wordpress.com/remote-login.php?wpcom_remote_login=key&amp;origin=aHR0cHM6Ly9zY29ycGlvc29mdHdhcmUubmV0&amp;wpcomid=143820068&amp;time=1718432680"></iframe><script src="https://s0.wp.com/wp-content/mu-plugins/actionbar/actionbar.js?v=20231122" defer=""></script></body></html>