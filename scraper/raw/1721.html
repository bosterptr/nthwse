<html lang="en-US"><head itemscope="" itemtype="http://schema.org/WebPage">
	<meta charset="UTF-8">
	<link rel="pingback" href="https://rastamouse.me/xmlrpc.php">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Building a (slightly) better Melkor – Rasta Mouse</title>
<meta name="robots" content="max-image-preview:large">
<link rel="dns-prefetch" href="//stats.wp.com">
<link rel="dns-prefetch" href="//i0.wp.com">
<link rel="dns-prefetch" href="//c0.wp.com">
<link rel="alternate" type="application/rss+xml" title="Rasta Mouse » Feed" href="https://rastamouse.me/feed/">
<script type="text/javascript">//<![CDATA[
window._wpemojiSettings={"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/rastamouse.me\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.5.4"}};!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!n(e,"\ud83c\uddfa\ud83c\uddf3","\ud83c\uddfa\u200b\ud83c\uddf3")&&!n(e,"\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!n(e,"\ud83d\udc26\u200d\u2b1b","\ud83d\udc26\u200b\u2b1b")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
//]]></script>
<style id="seo-css-vars-inline-css" type="text/css">@font-face{font-display:swap;font-family:'seo';src:url(https://rastamouse.me/wp-content/themes/diagnoseo/fonts/seo.eot?ay24jn);src:url(https://rastamouse.me/wp-content/themes/diagnoseo/fonts/seo.eot?ay24jn#iefix) format('embedded-opentype') , url(https://rastamouse.me/wp-content/themes/diagnoseo/fonts/seo.ttf?ay24jn) format('truetype') , url(https://rastamouse.me/wp-content/themes/diagnoseo/fonts/seo.woff?ay24jn) format('woff') , url(https://rastamouse.me/wp-content/themes/diagnoseo/fonts/seo.svg?ay24jn#m) format('svg');font-weight:normal;font-style:normal}</style>
<link rel="stylesheet" id="seo-basic-style-css" href="https://rastamouse.me/wp-content/themes/diagnoseo/css/main.css?ver=1" type="text/css" media="screen">
<style id="wp-emoji-styles-inline-css" type="text/css">img.wp-smiley,img.emoji{display:inline!important;border:none!important;box-shadow:none!important;height:1em!important;width:1em!important;margin:0 .07em!important;vertical-align:-.1em!important;background:none!important;padding:0!important}</style>
<link rel="stylesheet" id="wp-block-library-css" href="https://c0.wp.com/c/6.5.4/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all">
<style id="wp-block-library-inline-css" type="text/css">.has-text-align-justify{text-align:justify}</style>
<link rel="stylesheet" id="mediaelement-css" href="https://c0.wp.com/c/6.5.4/wp-includes/js/mediaelement/mediaelementplayer-legacy.min.css" type="text/css" media="all">
<link rel="stylesheet" id="wp-mediaelement-css" href="https://c0.wp.com/c/6.5.4/wp-includes/js/mediaelement/wp-mediaelement.min.css" type="text/css" media="all">
<style id="jetpack-sharing-buttons-style-inline-css" type="text/css">.jetpack-sharing-buttons__services-list{display:flex;flex-direction:row;flex-wrap:wrap;gap:0;list-style-type:none;margin:5px;padding:0}.jetpack-sharing-buttons__services-list.has-small-icon-size{font-size:12px}.jetpack-sharing-buttons__services-list.has-normal-icon-size{font-size:16px}.jetpack-sharing-buttons__services-list.has-large-icon-size{font-size:24px}.jetpack-sharing-buttons__services-list.has-huge-icon-size{font-size:36px}@media print{.jetpack-sharing-buttons__services-list{display:none!important}}.editor-styles-wrapper .wp-block-jetpack-sharing-buttons{gap:0;padding-inline-start:0}ul.jetpack-sharing-buttons__services-list.has-background{padding:1.25em 2.375em}</style>
<style id="classic-theme-styles-inline-css" type="text/css">.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">body{--wp--preset--color--black:#000;--wp--preset--color--cyan-bluish-gray:#abb8c3;--wp--preset--color--white:#fff;--wp--preset--color--pale-pink:#f78da7;--wp--preset--color--vivid-red:#cf2e2e;--wp--preset--color--luminous-vivid-orange:#ff6900;--wp--preset--color--luminous-vivid-amber:#fcb900;--wp--preset--color--light-green-cyan:#7bdcb5;--wp--preset--color--vivid-green-cyan:#00d084;--wp--preset--color--pale-cyan-blue:#8ed1fc;--wp--preset--color--vivid-cyan-blue:#0693e3;--wp--preset--color--vivid-purple:#9b51e0;--wp--preset--color--orange:#ff6000;--wp--preset--color--green:#31d49c;--wp--preset--color--dark-green:#03823c;--wp--preset--color--blue:#269fcc;--wp--preset--color--dark-blue:#105772;--wp--preset--color--purple:#a51ef2;--wp--preset--color--pink:#fc83f2;--wp--preset--color--red:#f55e23;--wp--preset--color--brown:#eb7f0c;--wp--preset--color--gray:#8097a6;--wp--preset--color--dark-gray:#495e6c;--wp--preset--color--light-gray:#bcc6c9;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple:linear-gradient(135deg,rgba(6,147,227,1) 0%,#9b51e0 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan:linear-gradient(135deg,#7adcb4 0%,#00d082 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange:linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red:linear-gradient(135deg,rgba(255,105,0,1) 0%,#cf2e2e 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray:linear-gradient(135deg,#eee 0%,#a9b8c3 100%);--wp--preset--gradient--cool-to-warm-spectrum:linear-gradient(135deg,#4aeadc 0%,#9778d1 20%,#cf2aba 40%,#ee2c82 60%,#fb6962 80%,#fef84c 100%);--wp--preset--gradient--blush-light-purple:linear-gradient(135deg,#ffceec 0%,#9896f0 100%);--wp--preset--gradient--blush-bordeaux:linear-gradient(135deg,#fecda5 0%,#fe2d2d 50%,#6b003e 100%);--wp--preset--gradient--luminous-dusk:linear-gradient(135deg,#ffcb70 0%,#c751c0 50%,#4158d0 100%);--wp--preset--gradient--pale-ocean:linear-gradient(135deg,#fff5cb 0%,#b6e3d4 50%,#33a7b5 100%);--wp--preset--gradient--electric-grass:linear-gradient(135deg,#caf880 0%,#71ce7e 100%);--wp--preset--gradient--midnight:linear-gradient(135deg,#020381 0%,#2874fc 100%);--wp--preset--font-size--small:13px;--wp--preset--font-size--medium:20px;--wp--preset--font-size--large:36px;--wp--preset--font-size--x-large:42px;--wp--preset--spacing--20:.44rem;--wp--preset--spacing--30:.67rem;--wp--preset--spacing--40:1rem;--wp--preset--spacing--50:1.5rem;--wp--preset--spacing--60:2.25rem;--wp--preset--spacing--70:3.38rem;--wp--preset--spacing--80:5.06rem;--wp--preset--shadow--natural:6px 6px 9px rgba(0,0,0,.2);--wp--preset--shadow--deep:12px 12px 50px rgba(0,0,0,.4);--wp--preset--shadow--sharp:6px 6px 0 rgba(0,0,0,.2);--wp--preset--shadow--outlined:6px 6px 0 -3px rgba(255,255,255,1) , 6px 6px rgba(0,0,0,1);--wp--preset--shadow--crisp:6px 6px 0 rgba(0,0,0,1)}:where(.is-layout-flex){gap:.5em}:where(.is-layout-grid){gap:.5em}body .is-layout-flex{display:flex}body .is-layout-flex{flex-wrap:wrap;align-items:center}body .is-layout-flex>*{margin:0}body .is-layout-grid{display:grid}body .is-layout-grid>*{margin:0}:where(.wp-block-columns.is-layout-flex){gap:2em}:where(.wp-block-columns.is-layout-grid){gap:2em}:where(.wp-block-post-template.is-layout-flex){gap:1.25em}:where(.wp-block-post-template.is-layout-grid){gap:1.25em}.has-black-color{color:var(--wp--preset--color--black)!important}.has-cyan-bluish-gray-color{color:var(--wp--preset--color--cyan-bluish-gray)!important}.has-white-color{color:var(--wp--preset--color--white)!important}.has-pale-pink-color{color:var(--wp--preset--color--pale-pink)!important}.has-vivid-red-color{color:var(--wp--preset--color--vivid-red)!important}.has-luminous-vivid-orange-color{color:var(--wp--preset--color--luminous-vivid-orange)!important}.has-luminous-vivid-amber-color{color:var(--wp--preset--color--luminous-vivid-amber)!important}.has-light-green-cyan-color{color:var(--wp--preset--color--light-green-cyan)!important}.has-vivid-green-cyan-color{color:var(--wp--preset--color--vivid-green-cyan)!important}.has-pale-cyan-blue-color{color:var(--wp--preset--color--pale-cyan-blue)!important}.has-vivid-cyan-blue-color{color:var(--wp--preset--color--vivid-cyan-blue)!important}.has-vivid-purple-color{color:var(--wp--preset--color--vivid-purple)!important}.has-black-background-color{background-color:var(--wp--preset--color--black)!important}.has-cyan-bluish-gray-background-color{background-color:var(--wp--preset--color--cyan-bluish-gray)!important}.has-white-background-color{background-color:var(--wp--preset--color--white)!important}.has-pale-pink-background-color{background-color:var(--wp--preset--color--pale-pink)!important}.has-vivid-red-background-color{background-color:var(--wp--preset--color--vivid-red)!important}.has-luminous-vivid-orange-background-color{background-color:var(--wp--preset--color--luminous-vivid-orange)!important}.has-luminous-vivid-amber-background-color{background-color:var(--wp--preset--color--luminous-vivid-amber)!important}.has-light-green-cyan-background-color{background-color:var(--wp--preset--color--light-green-cyan)!important}.has-vivid-green-cyan-background-color{background-color:var(--wp--preset--color--vivid-green-cyan)!important}.has-pale-cyan-blue-background-color{background-color:var(--wp--preset--color--pale-cyan-blue)!important}.has-vivid-cyan-blue-background-color{background-color:var(--wp--preset--color--vivid-cyan-blue)!important}.has-vivid-purple-background-color{background-color:var(--wp--preset--color--vivid-purple)!important}.has-black-border-color{border-color:var(--wp--preset--color--black)!important}.has-cyan-bluish-gray-border-color{border-color:var(--wp--preset--color--cyan-bluish-gray)!important}.has-white-border-color{border-color:var(--wp--preset--color--white)!important}.has-pale-pink-border-color{border-color:var(--wp--preset--color--pale-pink)!important}.has-vivid-red-border-color{border-color:var(--wp--preset--color--vivid-red)!important}.has-luminous-vivid-orange-border-color{border-color:var(--wp--preset--color--luminous-vivid-orange)!important}.has-luminous-vivid-amber-border-color{border-color:var(--wp--preset--color--luminous-vivid-amber)!important}.has-light-green-cyan-border-color{border-color:var(--wp--preset--color--light-green-cyan)!important}.has-vivid-green-cyan-border-color{border-color:var(--wp--preset--color--vivid-green-cyan)!important}.has-pale-cyan-blue-border-color{border-color:var(--wp--preset--color--pale-cyan-blue)!important}.has-vivid-cyan-blue-border-color{border-color:var(--wp--preset--color--vivid-cyan-blue)!important}.has-vivid-purple-border-color{border-color:var(--wp--preset--color--vivid-purple)!important}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background:var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple)!important}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background:var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan)!important}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background:var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange)!important}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background:var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red)!important}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background:var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray)!important}.has-cool-to-warm-spectrum-gradient-background{background:var(--wp--preset--gradient--cool-to-warm-spectrum)!important}.has-blush-light-purple-gradient-background{background:var(--wp--preset--gradient--blush-light-purple)!important}.has-blush-bordeaux-gradient-background{background:var(--wp--preset--gradient--blush-bordeaux)!important}.has-luminous-dusk-gradient-background{background:var(--wp--preset--gradient--luminous-dusk)!important}.has-pale-ocean-gradient-background{background:var(--wp--preset--gradient--pale-ocean)!important}.has-electric-grass-gradient-background{background:var(--wp--preset--gradient--electric-grass)!important}.has-midnight-gradient-background{background:var(--wp--preset--gradient--midnight)!important}.has-small-font-size{font-size:var(--wp--preset--font-size--small)!important}.has-medium-font-size{font-size:var(--wp--preset--font-size--medium)!important}.has-large-font-size{font-size:var(--wp--preset--font-size--large)!important}.has-x-large-font-size{font-size:var(--wp--preset--font-size--x-large)!important}.wp-block-navigation a:where(:not(.wp-element-button)){color:inherit}:where(.wp-block-post-template.is-layout-flex){gap:1.25em}:where(.wp-block-post-template.is-layout-grid){gap:1.25em}:where(.wp-block-columns.is-layout-flex){gap:2em}:where(.wp-block-columns.is-layout-grid){gap:2em}.wp-block-pullquote{font-size:1.5em;line-height:1.6}</style>
<link rel="stylesheet" id="mkaz-code-syntax-prism-css-css" href="https://rastamouse.me/wp-content/plugins/code-syntax-block/assets/prism-a11y-dark.css?ver=1715174480" type="text/css" media="all">
<link rel="stylesheet" id="jetpack_css-css" href="https://c0.wp.com/p/jetpack/13.5/css/jetpack.css" type="text/css" media="all">
<link rel="https://api.w.org/" href="https://rastamouse.me/wp-json/"><link rel="alternate" type="application/json" href="https://rastamouse.me/wp-json/wp/v2/posts/2267"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://rastamouse.me/xmlrpc.php?rsd">
<meta name="generator" content="WordPress 6.5.4">
<link rel="canonical" href="https://rastamouse.me/building-a-slightly-better-melkor/">
<link rel="shortlink" href="https://rastamouse.me/?p=2267">
<link rel="alternate" type="application/json+oembed" href="https://rastamouse.me/wp-json/oembed/1.0/embed?url=https%3A%2F%2Frastamouse.me%2Fbuilding-a-slightly-better-melkor%2F">
<link rel="alternate" type="text/xml+oembed" href="https://rastamouse.me/wp-json/oembed/1.0/embed?url=https%3A%2F%2Frastamouse.me%2Fbuilding-a-slightly-better-melkor%2F&amp;format=xml">
	<style>img#wpstats{display:none}</style>
			<meta itemprop="dateModified" content="2023-09-06">
	<link rel="icon" href="https://i0.wp.com/rastamouse.me/wp-content/uploads/2021/06/cropped-564-5649811_transparent-cheese-clipart-png-cheese-emoji-png.png?fit=32%2C32&amp;ssl=1" sizes="32x32">
<link rel="icon" href="https://i0.wp.com/rastamouse.me/wp-content/uploads/2021/06/cropped-564-5649811_transparent-cheese-clipart-png-cheese-emoji-png.png?fit=192%2C192&amp;ssl=1" sizes="192x192">
<link rel="apple-touch-icon" href="https://i0.wp.com/rastamouse.me/wp-content/uploads/2021/06/cropped-564-5649811_transparent-cheese-clipart-png-cheese-emoji-png.png?fit=180%2C180&amp;ssl=1">
<meta name="msapplication-TileImage" content="https://i0.wp.com/rastamouse.me/wp-content/uploads/2021/06/cropped-564-5649811_transparent-cheese-clipart-png-cheese-emoji-png.png?fit=270%2C270&amp;ssl=1">
</head>

<body class="post-template-default single single-post postid-2267 single-format-standard wp-embed-responsive wide last-widget-sticky show-menus img-hover-lightup">
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
	<input type="checkbox" id="search-popup-toggle" class="hidden" value="1">
	<header class="site-header">
		<div class="main-header">
			<input type="checkbox" id="checkbox-mainmenu" value="1" class="hidden" access-key="m">
			<div class="site-title links-right">
					<p class="logo">
			<a href="https://rastamouse.me/" class="logo">Rasta Mouse</a>
			<span class="site-tagline">Cheesy Rumbles</span>
		</p>
				<label for="checkbox-mainmenu" class="menu-toggle" data-menu="mainmenu"><span class="menu-toggle-content">
					<span class="menu-icon"></span>
				</span></label>
			</div>

			<nav class="mainmenu submenu-animation-fade-move rotate-submenu-icon" itemscope="" itemtype="http://www.schema.org/SiteNavigationElement">
				
<form method="get" class="searchform" action="https://rastamouse.me/">
<fieldset>
	<button type="submit" class="search-button" name="searchsubmit" value="Search"><i class="icon-search"></i></button><input type="text" value="" name="s" placeholder="Search">
</fieldset>
</form>
					<p class="logo">
			<a href="https://rastamouse.me/" class="logo">Rasta Mouse</a>
			<span class="site-tagline">Cheesy Rumbles</span>
		</p>
				<ul class="menu">
					<li id="menu-item-19" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-19" itemprop="name"><a href="https://rastamouse.me" itemprop="url">Home</a></li>
					<li class="menu-item-search"><label for="search-popup-toggle" class="search-popup-link"><i class="icon-search"></i></label></li>
				</ul>
			</nav>
		</div>
	</header>

<ol class="breadcrumbs" itemscope="" itemtype="http://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a href="https://rastamouse.me/" itemprop="item"><span itemprop="name">Home</span></a><meta itemprop="position" content="1"></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><span class="delimiter">/</span><a href="https://rastamouse.me/category/blog/" itemprop="item"><span itemprop="name">Blog</span></a><meta itemprop="position" content="2"></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><span class="delimiter">/</span><span itemprop="name">Building a (slightly) better Melkor</span><meta itemprop="position" content="3"></li></ol><div class="content btn-type-flat has-sidebar fancy-borders" id="content" itemscope="" itemtype="http://schema.org/Article">
<main class="main">
	<article class="post single">
				<div class="post-content">
			<h1 class="post-title">Building a (slightly) better Melkor </h1>
			<p class="post-meta">
								<span class="meta meta-category"><a href="https://rastamouse.me/category/blog/" rel="category tag">Blog</a></span> <i class="meta-sep">/</i>
								<span class="meta meta-date">September 6, 2023</span> <i class="meta-sep">/</i>
				<span class="meta meta-author">Rasta Mouse</span>
							</p>
			
<p><a href="https://github.com/FuzzySecurity/Sharp-Suite/tree/master" data-type="link" data-id="https://github.com/FuzzySecurity/Sharp-Suite/tree/master">Melkor</a> is a C# POC written by <a href="https://twitter.com/FuzzySec">FuzzySec</a> to simulate a TTP employed by <a href="https://www.welivesecurity.com/wp-content/uploads/2020/06/ESET_InvisiMole.pdf" data-type="link" data-id="https://www.welivesecurity.com/wp-content/uploads/2020/06/ESET_InvisiMole.pdf">InvisiMole</a>.  The concept is that post-ex assemblies are loaded into a payload/implant and kept encrypted using DPAPI whilst at rest. They are decrypted on demand and executed in a separate AppDomain.  The AppDomain is unloaded once execution completes and only the encrypted assembly remains in memory ready to be used again.  As a fan of .NET tradecraft, I wanted to try it out.  However, I found that the results were not as promising as I’d hoped and I was still able to find multiple instance of plaintext indictors in memory.</p>



<p>The test assembly does nothing more than pop a message box, but the string gives us something to search for as an indicator.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<pre class="wp-block-code language-csharp" tabindex="0"><code lang="csharp" class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoTheThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"Morgoth Bauglir is my name.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>To set the scene, when running Melkor with this assembly, 8 instances of the string “Morgoth Bauglir” remained in memory.  The goal of the post is to reduce this count as much as possible.  I will through instances that I was able to address and which ones still need a solution.</p>



<p>tl;dr – fuck the garbage collector.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><script data-pagespeed-no-defer="">//<![CDATA[
(function(){for(var g="function"==typeof Object.defineProperties?Object.defineProperty:function(b,c,a){if(a.get||a.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[c]=a.value)},h="undefined"!=typeof window&&window===this?this:"undefined"!=typeof global&&null!=global?global:this,k=["String","prototype","repeat"],l=0;l<k.length-1;l++){var m=k[l];m in h||(h[m]={});h=h[m]}var n=k[k.length-1],p=h[n],q=p?p:function(b){var c;if(null==this)throw new TypeError("The 'this' value for String.prototype.repeat must not be null or undefined");c=this+"";if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var a="";b;)if(b&1&&(a+=c),b>>>=1)c+=c;return a};q!=p&&null!=q&&g(h,n,{configurable:!0,writable:!0,value:q});var t=this;function u(b,c){var a=b.split("."),d=t;a[0]in d||!d.execScript||d.execScript("var "+a[0]);for(var e;a.length&&(e=a.shift());)a.length||void 0===c?d[e]?d=d[e]:d=d[e]={}:d[e]=c};function v(b){var c=b.length;if(0<c){for(var a=Array(c),d=0;d<c;d++)a[d]=b[d];return a}return[]};function w(b){var c=window;if(c.addEventListener)c.addEventListener("load",b,!1);else if(c.attachEvent)c.attachEvent("onload",b);else{var a=c.onload;c.onload=function(){b.call(this);a&&a.call(this)}}};var x;function y(b,c,a,d,e){this.h=b;this.j=c;this.l=a;this.f=e;this.g={height:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,width:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth};this.i=d;this.b={};this.a=[];this.c={}}function z(b,c){var a,d,e=c.getAttribute("data-pagespeed-url-hash");if(a=e&&!(e in b.c))if(0>=c.offsetWidth&&0>=c.offsetHeight)a=!1;else{d=c.getBoundingClientRect();var f=document.body;a=d.top+("pageYOffset"in window?window.pageYOffset:(document.documentElement||f.parentNode||f).scrollTop);d=d.left+("pageXOffset"in window?window.pageXOffset:(document.documentElement||f.parentNode||f).scrollLeft);f=a.toString()+","+d;b.b.hasOwnProperty(f)?a=!1:(b.b[f]=!0,a=a<=b.g.height&&d<=b.g.width)}a&&(b.a.push(e),b.c[e]=!0)}y.prototype.checkImageForCriticality=function(b){b.getBoundingClientRect&&z(this,b)};u("pagespeed.CriticalImages.checkImageForCriticality",function(b){x.checkImageForCriticality(b)});u("pagespeed.CriticalImages.checkCriticalImages",function(){A(x)});function A(b){b.b={};for(var c=["IMG","INPUT"],a=[],d=0;d<c.length;++d)a=a.concat(v(document.getElementsByTagName(c[d])));if(a.length&&a[0].getBoundingClientRect){for(d=0;c=a[d];++d)z(b,c);a="oh="+b.l;b.f&&(a+="&n="+b.f);if(c=!!b.a.length)for(a+="&ci="+encodeURIComponent(b.a[0]),d=1;d<b.a.length;++d){var e=","+encodeURIComponent(b.a[d]);131072>=a.length+e.length&&(a+=e)}b.i&&(e="&rd="+encodeURIComponent(JSON.stringify(B())),131072>=a.length+e.length&&(a+=e),c=!0);C=a;if(c){d=b.h;b=b.j;var f;if(window.XMLHttpRequest)f=new XMLHttpRequest;else if(window.ActiveXObject)try{f=new ActiveXObject("Msxml2.XMLHTTP")}catch(r){try{f=new ActiveXObject("Microsoft.XMLHTTP")}catch(D){}}f&&(f.open("POST",d+(-1==d.indexOf("?")?"?":"&")+"url="+encodeURIComponent(b)),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f.send(a))}}}function B(){var b={},c;c=document.getElementsByTagName("IMG");if(!c.length)return{};var a=c[0];if(!("naturalWidth"in a&&"naturalHeight"in a))return{};for(var d=0;a=c[d];++d){var e=a.getAttribute("data-pagespeed-url-hash");e&&(!(e in b)&&0<a.width&&0<a.height&&0<a.naturalWidth&&0<a.naturalHeight||e in b&&a.width>=b[e].o&&a.height>=b[e].m)&&(b[e]={rw:a.width,rh:a.height,ow:a.naturalWidth,oh:a.naturalHeight})}return b}var C="";u("pagespeed.CriticalImages.getBeaconData",function(){return C});u("pagespeed.CriticalImages.Run",function(b,c,a,d,e,f){var r=new y(b,c,a,e,f);x=r;d&&w(function(){window.setTimeout(function(){A(r)},0)})});})();pagespeed.CriticalImages.Run('/mod_pagespeed_beacon','https://rastamouse.me/building-a-slightly-better-melkor/','8Xxa2XQLv9',true,false,'7OgrC_Og3NI');
//]]></script><img fetchpriority="high" decoding="async" width="419" height="199" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-11.png?resize=419%2C199&amp;ssl=1" alt="" class="wp-image-2382" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-11.png?w=419&amp;ssl=1 419w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-11.png?resize=300%2C142&amp;ssl=1 300w" sizes="(max-width: 419px) 100vw, 419px" data-recalc-dims="1" data-pagespeed-url-hash="3168605193" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Melkor starts off by reading the assembly from disk and immediately uses DPAPI to encrypt it.</p>



<pre class="wp-block-code line-numbers language-csharp" tabindex="0"><code lang="csharp" class="language-csharp"><span class="token comment">// Encrypt module</span>
<span class="token comment">//==============</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[&gt;] Reading assembly as Byte[]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Byte<span class="token punctuation">[</span><span class="token punctuation">]</span></span> bMod <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllBytes</span><span class="token punctuation">(</span><span class="token string">@"C:\Tools\Melkor\DemoModule\bin\Release\DemoModule.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[&gt;] DPAPI CryptProtectData -&gt; assembly[]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">hMelkor<span class="token punctuation">.</span>DPAPI_MODULE</span> dpMod <span class="token operator">=</span> hMelkor<span class="token punctuation">.</span><span class="token function">dpapiEncryptModule</span><span class="token punctuation">(</span>bMod<span class="token punctuation">,</span> <span class="token string">"Melkor"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>dpMod<span class="token punctuation">.</span>pMod <span class="token operator">!=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"    |_ Success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"    |_ pCrypto : 0x"</span> <span class="token operator">+</span> String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"{0:X}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>dpMod<span class="token punctuation">.</span>pMod<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToInt64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"    |_ iSize   : "</span> <span class="token operator">+</span> dpMod<span class="token punctuation">.</span>iModSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bMod <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"\n[!] Failed to DPAPI encrypt module.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"\n[?] Press enter to continue.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="wp-block-code"><code class="">[&gt;] Reading assembly as Byte[]
[&gt;] DPAPI CryptProtectData -&gt; assembly[]
    |_ Success
    |_ pCrypto : 0x22241BC8E30
    |_ iSize   : 4850

[?] Press enter to continue..</code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Straight off the bat, we can see two instances of “Morgoth Bauglir” in Process Hacker after the encryption has taken place.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><img decoding="async" width="374" height="103" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image.png?resize=374%2C103&amp;ssl=1" alt="" class="wp-image-2286" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image.png?w=374&amp;ssl=1 374w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image.png?resize=300%2C83&amp;ssl=1 300w" sizes="(max-width: 374px) 100vw, 374px" data-recalc-dims="1" data-pagespeed-url-hash="2617601373" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Both of these are due to “oversights(?)” in Melkor.  The first is that <code>bMod = null;</code> (line 12 above) removes the reference to the original <code>byte[]</code> but it does not de-allocate the underlying memory, at least not immediately.  Dynamic memory allocations such as these are cleaned up by the CLR’s garbage collector (GC) when there are no more references pointing to it.  The complication is that since GC runs are expensive, it doesn’t bother doing it right away and it can be an indeterminate length of time until it’s actually performed.  An overarching lesson I learned with this project is that you cannot rely on the GC at all when you have these OPSEC concerns in mind.</p>



<p>I did play around with calling <code>GC.Collect()</code> and <code>GC.WaitForPendingFinalizers()</code> but that didn’t make a difference.  I assume there are some other conditions that are preventing this being cleaned (e.g. code execution still in the same method).  In this case, I believe a better approach is to clear the array manually, for which there are a couple of approaches.</p>



<p>One is to walk over the array and zero out each element.</p>



<pre class="wp-block-code language-csharp" tabindex="0"><code lang="csharp" class="language-csharp">for (var i = 0; i &lt; bMod.Length; i++)
{
    bMod[i] = 0x00;
}</code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Another is to call the <code>Array.Clear</code> method.</p>



<pre class="wp-block-code language-csharp" tabindex="0"><code lang="csharp" class="language-csharp">Array.Clear(bMod, 0, bMod.Length);</code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Testing after this change confirms that we’re down to one result.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><img decoding="async" width="370" height="79" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-1.png?resize=370%2C79&amp;ssl=1" alt="" class="wp-image-2301" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-1.png?w=370&amp;ssl=1 370w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-1.png?resize=300%2C64&amp;ssl=1 300w" sizes="(max-width: 370px) 100vw, 370px" data-recalc-dims="1" data-pagespeed-url-hash="1213095729" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>This second allocation is left over by the <code>dpapiEncryptModule</code> method.</p>



<pre class="wp-block-code language-csharp line-numbers" tabindex="0"><code lang="csharp" class="language-csharp">{
    DPAPI_MODULE dpMod = new DPAPI_MODULE();

    DATA_BLOB oPlainText = makeBlob(bMod);
    DATA_BLOB oCipherText = new DATA_BLOB();
    DATA_BLOB oEntropy = makeBlob(bEntropy);

    Boolean bStatus = CryptProtectData(ref oPlainText, sModName, ref oEntropy, IntPtr.Zero,
        IntPtr.Zero, CRYPTPROTECT_LOCAL_MACHINE, ref oCipherText);

    if (bStatus)
    {
        dpMod.sModName = sModName;
        dpMod.iModVersion = iModVersion;
        dpMod.iModSize = oCipherText.cbData;
        dpMod.pMod = oCipherText.pbData;
    }

    return dpMod;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Amongst other arguments, <code>CryptProtectData</code> takes one <code>DATA_BLOB</code> structure containing the original plaintext content and another to hold the encrypted content.  The structure looks like this:</p>



<pre class="wp-block-code language-csharp" tabindex="0"><code lang="csharp" class="language-csharp">internal struct DATA_BLOB
{
    public int cbData;
    public IntPtr pbData;
}</code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The <code>oPlainText</code> blob (line 4 above) is created using another method called <code>makeBlob</code>.</p>



<pre class="wp-block-code language-csharp line-numbers" tabindex="0"><code lang="csharp" class="language-csharp">{
    DATA_BLOB oBlob = new DATA_BLOB();

    oBlob.pbData = Marshal.AllocHGlobal(bData.Length);
    oBlob.cbData = bData.Length;
    RtlZeroMemory(oBlob.pbData, bData.Length);
    Marshal.Copy(bData, 0, oBlob.pbData, bData.Length);

    return oBlob;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>We can see that some new memory is being allocated using <code>Marshal.AllocHGlobal</code> (line 4 above) and the original <code>byte[]</code> is copied into it (line 7 above).  This is unmanaged memory and therefore will never be handled by the GC.  Instead, it must be freed manually using <code>Marshal.FreeHGlobal</code> which we can see is never called anywhere.  A somewhat dirty workaround is to call <code>Marshal.FreeHGlobal(oPlainText.pbData)</code> in <code>dpapiEncryptModule</code> right before <code>return dpMod</code>.</p>



<p>We’re now down to zero results with the encrypted assembly in memory.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="266" height="77" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-2.png?resize=266%2C77&amp;ssl=1" alt="" class="wp-image-2322" data-recalc-dims="1" data-pagespeed-url-hash="3126968070" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p></p>



<p>Melkor then moves onto the next step which is to decrypt the assembly and execute it in a new AppDomain.</p>



<pre class="wp-block-code language-csharp line-numbers" tabindex="0"><code lang="csharp" class="language-csharp">// Create AppDomain &amp; load module
//==============
Console.WriteLine("[&gt;] DPAPI CryptUnprotectData -&gt; assembly[] copy");
hMelkor.DPAPI_MODULE oMod = hMelkor.dpapiDecryptModule(dpMod);
if (oMod.iModSize != 0)
{
    Console.WriteLine("    |_ Success");
}
else
{
    Console.WriteLine("\n[!] Failed to DPAPI decrypt module..");
    return;
}

Console.WriteLine("[&gt;] Create new AppDomain and invoke module through proxy..");
hMelkor.loadAppDomainModule("dothething", "Angband", oMod.bMod);

Console.WriteLine("\n[?] Press enter to continue..");
Console.ReadLine();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="713" height="259" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-3.png?resize=713%2C259&amp;ssl=1" alt="" class="wp-image-2324" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-3.png?w=713&amp;ssl=1 713w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-3.png?resize=300%2C109&amp;ssl=1 300w" sizes="(max-width: 713px) 100vw, 713px" data-recalc-dims="1" data-pagespeed-url-hash="1611173306" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Before clearing the MessageBox, we can verify that it is indeed running inside a new AppDomain with the name “Angband”.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="667" height="167" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-4.png?resize=667%2C167&amp;ssl=1" alt="" class="wp-image-2325" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-4.png?w=667&amp;ssl=1 667w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-4.png?resize=300%2C75&amp;ssl=1 300w" sizes="(max-width: 667px) 100vw, 667px" data-recalc-dims="1" data-pagespeed-url-hash="2607746199" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>And instances of “Morgoth Bauglir” in memory has jumped to 6.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="371" height="161" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-5.png?resize=371%2C161&amp;ssl=1" alt="" class="wp-image-2326" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-5.png?w=371&amp;ssl=1 371w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-5.png?resize=300%2C130&amp;ssl=1 300w" sizes="(max-width: 371px) 100vw, 371px" data-recalc-dims="1" data-pagespeed-url-hash="689630206" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>It’s expected that we’ll find these in memory whilst the assembly is executing, so let’s see what happens when we clear the box and allow Melkor to unload the AppDomain.</p>



<pre class="wp-block-code"><code class="">[&gt;] Unloading AppDomain
[&gt;] Freeing CryptUnprotectData

[?] Press enter to exit..</code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The AppDomain is gone.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="558" height="95" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-6.png?resize=558%2C95&amp;ssl=1" alt="" class="wp-image-2331" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-6.png?w=558&amp;ssl=1 558w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-6.png?resize=300%2C51&amp;ssl=1 300w" sizes="(max-width: 558px) 100vw, 558px" data-recalc-dims="1" data-pagespeed-url-hash="1469196044" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>But now we have 8(!) instances of “Morgoth Bauglir” in memory.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="408" height="203" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-7.png?resize=408%2C203&amp;ssl=1" alt="" class="wp-image-2332" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-7.png?w=408&amp;ssl=1 408w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-7.png?resize=300%2C149&amp;ssl=1 300w" sizes="(max-width: 408px) 100vw, 408px" data-recalc-dims="1" data-pagespeed-url-hash="3435187536" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>Some of these stem from similar issues as above, specifically with how data between the <code>DPAPI_MODULE</code> and <code>DATA_BLOB</code> structures is handled.</p>



<pre class="wp-block-code language-csharp" tabindex="0"><code lang="csharp" class="language-csharp">internal struct DPAPI_MODULE
{
    public String sModName;
    public int iModVersion;
    public int iModSize;
    public IntPtr pMod;
    public Byte[] bMod;
}</code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>The <code>dpapiDecryptModule</code> initialises a new <code>DPAPI_MODULE</code> called <code>oMod</code> (line 2 below) and a new <code>DATA_BLOB</code> called <code>oPlainText</code> to hold the decrypted assembly (line 7 below).</p>



<pre class="wp-block-code language-csharp line-numbers" tabindex="0"><code lang="csharp" class="language-csharp">{
    DPAPI_MODULE oMod = new DPAPI_MODULE();

    Byte[] bEncrypted = new Byte[oEncMod.iModSize];
    Marshal.Copy(oEncMod.pMod, bEncrypted, 0, oEncMod.iModSize);

    DATA_BLOB oPlainText = new DATA_BLOB();
    DATA_BLOB oCipherText = makeBlob(bEncrypted);
    DATA_BLOB oEntropy = makeBlob(bEntropy);

    String sDescription = String.Empty;
    Boolean bStatus = CryptUnprotectData(ref oCipherText, ref sDescription, ref oEntropy,
        IntPtr.Zero, IntPtr.Zero, 0, ref oPlainText);
    
    if (bStatus)
    {
        oMod.pMod = oPlainText.pbData;
        oMod.bMod = new Byte[oPlainText.cbData];
        Marshal.Copy(oPlainText.pbData, oMod.bMod, 0, oPlainText.cbData);
        oMod.iModSize = oPlainText.cbData;
        oMod.iModVersion = oEncMod.iModVersion;
    }

    return oMod;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>If the decryption is successful it copies the unmanaged data pointer of <code>oPlainText</code> to <code>oMod.pMod</code> (line 17 above) but also makes an entire copy of the data in a new <code>byte[]</code> on<code> oMod.bMod</code> (lines 18/19 above).  So that effectively means we now have one managed and one unmanaged copy of the same decrypted assembly.  After the AppDomain has been unloaded, a method called <code>hMelkor.freeMod(oMod)</code> is executed which attempts to free the data in the <code>DPAPI_MODULE</code> structure.  All this method does is call <code>LocalFree(oMod.pMod)</code> which I think has two problems.  The first is that <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-localfree" data-type="link" data-id="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-localfree">LocalFree</a> free’s up the memory handle but doesn’t erase its content; the second is that that <code>oMod.bMod</code> is never cleared either.</p>



<p>Melkor is already using <code>RtlZeroMemory</code> in places, so we can use that to rework the method to look something like this:</p>



<pre class="wp-block-code language-csharp" tabindex="0"><code lang="csharp" class="language-csharp">public static void freeMod(DPAPI_MODULE oMod)
{
    RtlZeroMemory(oMod.pMod, oMod.iModSize);
    LocalFree(oMod.pMod);
    Array.Clear(oMod.bMod, 0, oMod.bMod.Length);
}</code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>As a side note – there are multiple instances in the project of memory allocations that contain the encrypted data that are not cleared either.  I’ve omitted them from the post since they didn’t have an impact on our plaintext string in memory.  If this code got a full refactor, then they should be freed as well.</p>



<p>If we run the tool top to bottom now, we’re down to 4 results by the end.</p>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<figure class="wp-block-image size-full"><img loading="lazy" decoding="async" width="409" height="129" src="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-9.png?resize=409%2C129&amp;ssl=1" alt="" class="wp-image-2356" srcset="https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-9.png?w=409&amp;ssl=1 409w, https://i0.wp.com/rastamouse.me/wp-content/uploads/2023/09/image-9.png?resize=300%2C95&amp;ssl=1 300w" sizes="(max-width: 409px) 100vw, 409px" data-recalc-dims="1" data-pagespeed-url-hash="2195341122" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></figure>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>These are coming from the <code>loadAppDomainModule</code> method and unfortunately, I haven’t found a way to remove them.  I believe the issue is that when you have a reference to a new AppDomain in the current AppDomain, then new heap allocations are made to hold the information, including all the assemblies that are loaded within it.</p>



<p>For example:</p>



<pre class="wp-block-code language-csharp line-numbers" tabindex="0"><code lang="csharp" class="language-csharp">// create a new AppDomain
AppDomain oDomain = AppDomain.CreateDomain(sAppDomain, null, null, null, false);

ShadowRunnerProxy pluginProxy = (ShadowRunnerProxy)oDomain.CreateInstanceAndUnwrap(
    typeof(ShadowRunnerProxy).Assembly.FullName, typeof(ShadowRunnerProxy).FullName);

// load &amp; execute the assembly
pluginProxy.LoadAssembly(bMod, sMethod);

// unload the AppDomain
AppDomain.Unload(oDomain);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<div style="height:10px" aria-hidden="true" class="wp-block-spacer"></div>



<p>We require a reference to the AppDomain, <code>oDomain</code> because we need to pass it to <code>AppDomain.Unload</code>.  The AppDomain class/type does not have any properties that tell you the base address or anything that would help in manually freeing that memory.  If anybody has more experience with this and can suggest some workarounds, do please reach out.</p>
			
			<div class="post-author">
								<span class="img-border"><img alt="" src="https://secure.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=96&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2b44f5ca5458931c49e1fa57da6705c1?s=192&amp;d=mm&amp;r=g 2x" class="avatar avatar-96 photo" height="96" width="96" loading="lazy" decoding="async" data-pagespeed-url-hash="1561347927" onload="pagespeed.CriticalImages.checkImageForCriticality(this);"></span>
				<div class="post-author-info">
					<h4 class="post-author-name">
						<a href="https://rastamouse.me/author/rasta_mouse/">
						Rasta Mouse						</a>
					</h4>
					<p class="post-author-description"></p>
				</div>
			</div>
		</div>
	</article>



	<nav class="post-nav">
					<a href="https://rastamouse.me/csharp-source-generators/" class="post-nav-link prev">
				<i class="icon-arrow_back"></i>
				<span class="post-nav-link-content">
					<span class="info" data-label="Previous post"></span>
					C# Source Generators				</span>
			</a>
						<a href="https://rastamouse.me/cobalt-strike-aggressor-callbacks/" class="post-nav-link next">
				<i class="icon-arrow_forward"></i>
				<span class="post-nav-link-content">
					<span class="info" data-label="Next post"></span>
					Cobalt Strike Aggressor Callbacks				</span>
			</a>
			</nav>

		<div class="related-posts additional-post-list">
		<h2 class="postlist-title"><span>Related posts</span></h2>
		<div class="columns">
							<article class="col col3">
						<div class="post">
												<div class="post-content">
							<h3 class="post-title"><a href="https://rastamouse.me/kerberos-delegation-test-app/">Kerberos Delegation Test App</a></h3>
							<p>I have been quietly working on some new Kerberos course content, and although it's...</p>
						</div>
						</div>
					</article>
										<article class="col col3">
						<div class="post">
												<div class="post-content">
							<h3 class="post-title"><a href="https://rastamouse.me/custom-beacon-artifacts/">Custom Beacon Artifacts</a></h3>
							<p>If you're an experienced Cobalt Strike user, you will already know what roll the...</p>
						</div>
						</div>
					</article>
										<article class="col col3">
						<div class="post">
												<div class="post-content">
							<h3 class="post-title"><a href="https://rastamouse.me/yarp-as-a-c2-redirector/">YARP as a C2 Redirector</a></h3>
							<p>YARP: Yet Another Reverse Proxy is a .NET library developed by Microsoft designed to...</p>
						</div>
						</div>
					</article>
										<article class="col col3">
						<div class="post">
												<div class="post-content">
							<h3 class="post-title"><a href="https://rastamouse.me/anysize-array-csharp/">ANYSIZE_ARRAY in C#</a></h3>
							<p>There are multiple structures in Windows that contain fixed sized arrays.  The instance...</p>
						</div>
						</div>
					</article>
										<article class="col col3">
						<div class="post">
												<div class="post-content">
							<h3 class="post-title"><a href="https://rastamouse.me/safehandle-vs-intptr/">SafeHandle vs IntPtr</a></h3>
							<p>C# is a popular language in both the commercial space (think ASP.NET Core, MVC,...</p>
						</div>
						</div>
					</article>
										<article class="col col3">
						<div class="post">
												<div class="post-content">
							<h3 class="post-title"><a href="https://rastamouse.me/cobalt-strike-aggressor-callbacks/">Cobalt Strike Aggressor Callbacks</a></h3>
							<p>The Cobalt Strike 4.9 release introduced support for registering Aggressor callbacks for several functions...</p>
						</div>
						</div>
					</article>
							</div>
	</div>
			<div class="latest-posts additional-post-list">
			<h2 class="postlist-title"><span>Latest posts</span></h2>
			<div class="columns">
							<article class="col col3">
					<div class="post">
										<div class="post-content">
						<h3 class="post-title"><a href="https://rastamouse.me/kerberos-delegation-test-app/">Kerberos Delegation Test App</a></h3>
						<p>I have been quietly working on some new Kerberos course content, and although it's...</p>
					</div>
					</div>
				</article>				<article class="col col3">
					<div class="post">
										<div class="post-content">
						<h3 class="post-title"><a href="https://rastamouse.me/custom-beacon-artifacts/">Custom Beacon Artifacts</a></h3>
						<p>If you're an experienced Cobalt Strike user, you will already know what roll the...</p>
					</div>
					</div>
				</article>				<article class="col col3">
					<div class="post">
										<div class="post-content">
						<h3 class="post-title"><a href="https://rastamouse.me/yarp-as-a-c2-redirector/">YARP as a C2 Redirector</a></h3>
						<p>YARP: Yet Another Reverse Proxy is a .NET library developed by Microsoft designed to...</p>
					</div>
					</div>
				</article>				<article class="col col3">
					<div class="post">
										<div class="post-content">
						<h3 class="post-title"><a href="https://rastamouse.me/anysize-array-csharp/">ANYSIZE_ARRAY in C#</a></h3>
						<p>There are multiple structures in Windows that contain fixed sized arrays.  The instance...</p>
					</div>
					</div>
				</article>				<article class="col col3">
					<div class="post">
										<div class="post-content">
						<h3 class="post-title"><a href="https://rastamouse.me/safehandle-vs-intptr/">SafeHandle vs IntPtr</a></h3>
						<p>C# is a popular language in both the commercial space (think ASP.NET Core, MVC,...</p>
					</div>
					</div>
				</article>				<article class="col col3">
					<div class="post">
										<div class="post-content">
						<h3 class="post-title"><a href="https://rastamouse.me/cobalt-strike-aggressor-callbacks/">Cobalt Strike Aggressor Callbacks</a></h3>
						<p>The Cobalt Strike 4.9 release introduced support for registering Aggressor callbacks for several functions...</p>
					</div>
					</div>
				</article>			</div>
		</div>
			<div class="meta">
		<meta itemprop="datePublished" content="2023-09-06">
		<meta itemprop="dateModified" content="2023-09-06T15:59:33+00:00">
		<meta itemscope="" itemprop="mainEntityOfPage" content="" itemtype="https://schema.org/WebPage" itemid="https://rastamouse.me/building-a-slightly-better-melkor/">
		<meta itemprop="headline" content="Building a (slightly) better Melkor">
		<span itemprop="author" itemscope="" itemtype="http://schema.org/Person">
		<meta itemprop="name" content="Rasta Mouse">
		</span>
		<span itemprop="publisher" itemscope="" itemtype="https://schema.org/Organization">
			<span itemprop="logo" itemscope="" itemtype="https://schema.org/ImageObject">
						</span>
			<meta itemprop="name" content="Rasta Mouse">
		</span>
			</div>
</main>
		
<aside class="sidebar">
	<div class="widget widget_search" id="search-2">
<form method="get" class="searchform" action="https://rastamouse.me/">
<fieldset>
	<button type="submit" class="search-button" name="searchsubmit" value="Search"><i class="icon-search"></i></button><input type="text" value="" name="s" placeholder="Search">
</fieldset>
</form>
</div>
		<div class="widget widget_recent_entries" id="recent-posts-2">
		<h3 class="widget-title">Recent Posts</h3>
		<ul>
											<li>
					<a href="https://rastamouse.me/kerberos-delegation-test-app/">Kerberos Delegation Test App</a>
									</li>
											<li>
					<a href="https://rastamouse.me/custom-beacon-artifacts/">Custom Beacon Artifacts</a>
									</li>
											<li>
					<a href="https://rastamouse.me/yarp-as-a-c2-redirector/">YARP as a C2 Redirector</a>
									</li>
											<li>
					<a href="https://rastamouse.me/anysize-array-csharp/">ANYSIZE_ARRAY in C#</a>
									</li>
											<li>
					<a href="https://rastamouse.me/safehandle-vs-intptr/">SafeHandle vs IntPtr</a>
									</li>
					</ul>

		</div><div class="widget widget_block" id="block-2"><div class="thinkific-product-card" data-btn-txt="Read More" data-btn-txt-color="#ffffff" data-btn-bg-color="#1b9eea" data-card-type="card" data-link-type="landing_page" data-product="1725295" data-embed-version="0.0.2" data-card-txt-color="#000000" data-card-bg-color="#ffffff" data-store-url="https://training.zeropointsecurity.co.uk/embeds/products/show" data-embed-index="0"><div class="iframe-container"><iframe src="https://training.zeropointsecurity.co.uk/embeds/products/show?button_text=Read%20More&amp;button_bg_color=%231b9eea&amp;button_text_color=%23ffffff&amp;card_bg_color=%23ffffff&amp;card_text_color=%23000000&amp;card_type=card&amp;product_id=1725295&amp;link_type=landing_page&amp;embed_version=0.0.2&amp;index=0" id="thinkific-product-embed-iframe-0" frameborder="0" height="245" width="230" scrolling="no" style="height: 257px; max-width: 230px;"></iframe></div><script type="text/javascript">document.getElementById("thinkific-product-embed")||document.write('<script id="thinkific-product-embed" type="text/javascript" src="https://assets.thinkific.com/js/embeds/product-cards-client.min.js"><\/script>');</script><script id="thinkific-product-embed" type="text/javascript" src="https://assets.thinkific.com/js/embeds/product-cards-client.min.js"></script><noscript><a href="https://training.zeropointsecurity.co.uk/courses/red-team-ops" target="_blank">Read More</a></noscript></div></div></aside>


</div>

<footer class="site-footer">
	<p class="footer-message">Copyright © 2024 Rasta Mouse </p>
</footer>

<div class="overlay seo-popup-overlay"></div>

<div class="seo-popup popup-search">
	<label for="search-popup-toggle" class="icon-close popup-close"></label>
	<h3 class="spec-heading"><span>Search</span></h3>
	
<form method="get" class="searchform" action="https://rastamouse.me/">
<fieldset>
	<button type="submit" class="search-button" name="searchsubmit" value="Search"><i class="icon-search"></i></button><input type="text" value="" name="s" placeholder="Search">
</fieldset>
</form>
</div>
<script type="text/javascript" id="mkaz-code-syntax-prism-js-js-extra">//<![CDATA[
var prism_settings={"pluginUrl":"https:\/\/rastamouse.me\/wp-content\/plugins\/code-syntax-block\/"};
//]]></script>
<script type="text/javascript" src="https://rastamouse.me/wp-content/plugins/code-syntax-block/assets/prism/prism.js?ver=1715174480" id="mkaz-code-syntax-prism-js-js"></script>
<script type="text/javascript" src="https://stats.wp.com/e-202424.js" id="jetpack-stats-js" data-wp-strategy="defer"></script>
<script type="text/javascript" id="jetpack-stats-js-after">//<![CDATA[
_stq=window._stq||[];_stq.push(["view",JSON.parse("{\"v\":\"ext\",\"blog\":\"193984547\",\"post\":\"2267\",\"tz\":\"0\",\"srv\":\"rastamouse.me\",\"j\":\"1:13.5\"}")]);_stq.push(["clickTrackerInit","193984547","2267"]);
//]]></script>


</body></html>