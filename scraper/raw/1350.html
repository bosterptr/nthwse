<html lang="en-US" class="js_active vc_desktop vc_transform vc_transform vc_transform wf-opensans-n3-active wf-opensans-n4-active wf-opensans-n6-active wf-opensans-n7-active wf-opensans-n8-active wf-opensans-i3-active wf-opensans-i4-active wf-opensans-i6-active wf-opensans-i7-active wf-opensans-i8-active wf-montserrat-n4-active wf-montserrat-n7-active wf-adamina-n4-active wf-active"><head>
<link rel="shortcut icon" href="https://azeria-labs.com/favicon.ico">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Heap Exploitation Part 2: Understanding the Glibc Heap Implementation |  Azeria Labs</title>
<link href="https://fonts.googleapis.com/css?family=Orbitron" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
<!-- Mobile Specific Metas & Favicons -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, user-scalable=1"><!-- WordPress Stuff -->
                        <script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-PFZX4BN7JZ&amp;cx=c&amp;_slc=1"></script><script async="" src="https://www.google-analytics.com/analytics.js"></script><script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.3/webfont.js" type="text/javascript" async=""></script><script>
                            /* You can add more configuration options to webfontloader by previously defining the WebFontConfig with your options */
                            if ( typeof WebFontConfig === "undefined" ) {
                                WebFontConfig = new Object();
                            }
                            WebFontConfig['google'] = {families: ['Open+Sans:300,400,600,700,800,300italic,400italic,600italic,700italic,800italic', 'Montserrat:400,700', 'Adamina:400&amp;subset=latin']};

                            (function() {
                                var wf = document.createElement( 'script' );
                                wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1.5.3/webfont.js';
                                wf.type = 'text/javascript';
                                wf.async = 'true';
                                var s = document.getElementsByTagName( 'script' )[0];
                                s.parentNode.insertBefore( wf, s );
                            })();
                        </script>
                        <meta name="robots" content="max-image-preview:large">
<link rel="alternate" type="application/rss+xml" title="Azeria Labs » Feed" href="https://azeria-labs.com/feed/">
<link rel="alternate" type="application/rss+xml" title="Azeria Labs » Comments Feed" href="https://azeria-labs.com/comments/feed/">
<meta property="og:title" content="Heap Exploitation Part 2: Understanding the Glibc Heap Implementation"><meta property="og:type" content="article"><meta property="og:url" content="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/"><meta property="og:site_name" content="Azeria-Labs"><meta property="og:image" content="https://azeria-labs.com/promo.png"><script type="text/javascript">
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/azeria-labs.com\/wp-includes\/js\/wp-emoji-release.min.js"}};
/*! This file is auto-generated */
!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){p.clearRect(0,0,i.width,i.height),p.fillText(e,0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(t,0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(p&&p.fillText)switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s("\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f","\ud83c\udff3\ufe0f\u200b\u26a7\ufe0f")?!1:!s("\ud83c\uddfa\ud83c\uddf3","\ud83c\uddfa\u200b\ud83c\uddf3")&&!s("\ud83c\udff4\udb40\udc67\udb40\udc62\udb40\udc65\udb40\udc6e\udb40\udc67\udb40\udc7f","\ud83c\udff4\u200b\udb40\udc67\u200b\udb40\udc62\u200b\udb40\udc65\u200b\udb40\udc6e\u200b\udb40\udc67\u200b\udb40\udc7f");case"emoji":return!s("\ud83e\udef1\ud83c\udffb\u200d\ud83e\udef2\ud83c\udfff","\ud83e\udef1\ud83c\udffb\u200b\ud83e\udef2\ud83c\udfff")}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(e=t.source||{}).concatemoji?c(e.concatemoji):e.wpemoji&&e.twemoji&&(c(e.twemoji),c(e.wpemoji)))}(window,document,window._wpemojiSettings);
</script>
<style type="text/css">img.wp-smiley,img.emoji{display:inline!important;border:none!important;box-shadow:none!important;height:1em!important;width:1em!important;margin:0 .07em!important;vertical-align:-.1em!important;background:none!important;padding:0!important}</style>
	<link rel="stylesheet" id="wp-block-library-css" href="https://azeria-labs.com/wp-includes/css/dist/block-library/A.style.min.css.pagespeed.cf.1qpRdvAQUt.css" type="text/css" media="all">
<link rel="stylesheet" id="classic-theme-styles-css" href="https://azeria-labs.com/wp-includes/css/A.classic-themes.min.css.pagespeed.cf.ILQxq27NYr.css" type="text/css" media="all">
<style id="global-styles-inline-css" type="text/css">body{--wp--preset--color--black:#000;--wp--preset--color--cyan-bluish-gray:#abb8c3;--wp--preset--color--white:#fff;--wp--preset--color--pale-pink:#f78da7;--wp--preset--color--vivid-red:#cf2e2e;--wp--preset--color--luminous-vivid-orange:#ff6900;--wp--preset--color--luminous-vivid-amber:#fcb900;--wp--preset--color--light-green-cyan:#7bdcb5;--wp--preset--color--vivid-green-cyan:#00d084;--wp--preset--color--pale-cyan-blue:#8ed1fc;--wp--preset--color--vivid-cyan-blue:#0693e3;--wp--preset--color--vivid-purple:#9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple:linear-gradient(135deg,rgba(6,147,227,1) 0%,#9b51e0 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan:linear-gradient(135deg,#7adcb4 0%,#00d082 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange:linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red:linear-gradient(135deg,rgba(255,105,0,1) 0%,#cf2e2e 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray:linear-gradient(135deg,#eee 0%,#a9b8c3 100%);--wp--preset--gradient--cool-to-warm-spectrum:linear-gradient(135deg,#4aeadc 0%,#9778d1 20%,#cf2aba 40%,#ee2c82 60%,#fb6962 80%,#fef84c 100%);--wp--preset--gradient--blush-light-purple:linear-gradient(135deg,#ffceec 0%,#9896f0 100%);--wp--preset--gradient--blush-bordeaux:linear-gradient(135deg,#fecda5 0%,#fe2d2d 50%,#6b003e 100%);--wp--preset--gradient--luminous-dusk:linear-gradient(135deg,#ffcb70 0%,#c751c0 50%,#4158d0 100%);--wp--preset--gradient--pale-ocean:linear-gradient(135deg,#fff5cb 0%,#b6e3d4 50%,#33a7b5 100%);--wp--preset--gradient--electric-grass:linear-gradient(135deg,#caf880 0%,#71ce7e 100%);--wp--preset--gradient--midnight:linear-gradient(135deg,#020381 0%,#2874fc 100%);--wp--preset--duotone--dark-grayscale:url(#wp-duotone-dark-grayscale);--wp--preset--duotone--grayscale:url(#wp-duotone-grayscale);--wp--preset--duotone--purple-yellow:url(#wp-duotone-purple-yellow);--wp--preset--duotone--blue-red:url(#wp-duotone-blue-red);--wp--preset--duotone--midnight:url(#wp-duotone-midnight);--wp--preset--duotone--magenta-yellow:url(#wp-duotone-magenta-yellow);--wp--preset--duotone--purple-green:url(#wp-duotone-purple-green);--wp--preset--duotone--blue-orange:url(#wp-duotone-blue-orange);--wp--preset--font-size--small:13px;--wp--preset--font-size--medium:20px;--wp--preset--font-size--large:36px;--wp--preset--font-size--x-large:42px;--wp--preset--spacing--20:.44rem;--wp--preset--spacing--30:.67rem;--wp--preset--spacing--40:1rem;--wp--preset--spacing--50:1.5rem;--wp--preset--spacing--60:2.25rem;--wp--preset--spacing--70:3.38rem;--wp--preset--spacing--80:5.06rem;--wp--preset--shadow--natural:6px 6px 9px rgba(0,0,0,.2);--wp--preset--shadow--deep:12px 12px 50px rgba(0,0,0,.4);--wp--preset--shadow--sharp:6px 6px 0 rgba(0,0,0,.2);--wp--preset--shadow--outlined:6px 6px 0 -3px rgba(255,255,255,1) , 6px 6px rgba(0,0,0,1);--wp--preset--shadow--crisp:6px 6px 0 rgba(0,0,0,1)}:where(.is-layout-flex){gap:.5em}body .is-layout-flow>.alignleft{float:left;margin-inline-start:0;margin-inline-end:2em}body .is-layout-flow>.alignright{float:right;margin-inline-start:2em;margin-inline-end:0}body .is-layout-flow>.aligncenter{margin-left:auto!important;margin-right:auto!important}body .is-layout-constrained>.alignleft{float:left;margin-inline-start:0;margin-inline-end:2em}body .is-layout-constrained>.alignright{float:right;margin-inline-start:2em;margin-inline-end:0}body .is-layout-constrained>.aligncenter{margin-left:auto!important;margin-right:auto!important}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width:var(--wp--style--global--content-size);margin-left:auto!important;margin-right:auto!important}body .is-layout-constrained>.alignwide{max-width:var(--wp--style--global--wide-size)}body .is-layout-flex{display:flex}body .is-layout-flex{flex-wrap:wrap;align-items:center}body .is-layout-flex>*{margin:0}:where(.wp-block-columns.is-layout-flex){gap:2em}.has-black-color{color:var(--wp--preset--color--black)!important}.has-cyan-bluish-gray-color{color:var(--wp--preset--color--cyan-bluish-gray)!important}.has-white-color{color:var(--wp--preset--color--white)!important}.has-pale-pink-color{color:var(--wp--preset--color--pale-pink)!important}.has-vivid-red-color{color:var(--wp--preset--color--vivid-red)!important}.has-luminous-vivid-orange-color{color:var(--wp--preset--color--luminous-vivid-orange)!important}.has-luminous-vivid-amber-color{color:var(--wp--preset--color--luminous-vivid-amber)!important}.has-light-green-cyan-color{color:var(--wp--preset--color--light-green-cyan)!important}.has-vivid-green-cyan-color{color:var(--wp--preset--color--vivid-green-cyan)!important}.has-pale-cyan-blue-color{color:var(--wp--preset--color--pale-cyan-blue)!important}.has-vivid-cyan-blue-color{color:var(--wp--preset--color--vivid-cyan-blue)!important}.has-vivid-purple-color{color:var(--wp--preset--color--vivid-purple)!important}.has-black-background-color{background-color:var(--wp--preset--color--black)!important}.has-cyan-bluish-gray-background-color{background-color:var(--wp--preset--color--cyan-bluish-gray)!important}.has-white-background-color{background-color:var(--wp--preset--color--white)!important}.has-pale-pink-background-color{background-color:var(--wp--preset--color--pale-pink)!important}.has-vivid-red-background-color{background-color:var(--wp--preset--color--vivid-red)!important}.has-luminous-vivid-orange-background-color{background-color:var(--wp--preset--color--luminous-vivid-orange)!important}.has-luminous-vivid-amber-background-color{background-color:var(--wp--preset--color--luminous-vivid-amber)!important}.has-light-green-cyan-background-color{background-color:var(--wp--preset--color--light-green-cyan)!important}.has-vivid-green-cyan-background-color{background-color:var(--wp--preset--color--vivid-green-cyan)!important}.has-pale-cyan-blue-background-color{background-color:var(--wp--preset--color--pale-cyan-blue)!important}.has-vivid-cyan-blue-background-color{background-color:var(--wp--preset--color--vivid-cyan-blue)!important}.has-vivid-purple-background-color{background-color:var(--wp--preset--color--vivid-purple)!important}.has-black-border-color{border-color:var(--wp--preset--color--black)!important}.has-cyan-bluish-gray-border-color{border-color:var(--wp--preset--color--cyan-bluish-gray)!important}.has-white-border-color{border-color:var(--wp--preset--color--white)!important}.has-pale-pink-border-color{border-color:var(--wp--preset--color--pale-pink)!important}.has-vivid-red-border-color{border-color:var(--wp--preset--color--vivid-red)!important}.has-luminous-vivid-orange-border-color{border-color:var(--wp--preset--color--luminous-vivid-orange)!important}.has-luminous-vivid-amber-border-color{border-color:var(--wp--preset--color--luminous-vivid-amber)!important}.has-light-green-cyan-border-color{border-color:var(--wp--preset--color--light-green-cyan)!important}.has-vivid-green-cyan-border-color{border-color:var(--wp--preset--color--vivid-green-cyan)!important}.has-pale-cyan-blue-border-color{border-color:var(--wp--preset--color--pale-cyan-blue)!important}.has-vivid-cyan-blue-border-color{border-color:var(--wp--preset--color--vivid-cyan-blue)!important}.has-vivid-purple-border-color{border-color:var(--wp--preset--color--vivid-purple)!important}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background:var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple)!important}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background:var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan)!important}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background:var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange)!important}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background:var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red)!important}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background:var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray)!important}.has-cool-to-warm-spectrum-gradient-background{background:var(--wp--preset--gradient--cool-to-warm-spectrum)!important}.has-blush-light-purple-gradient-background{background:var(--wp--preset--gradient--blush-light-purple)!important}.has-blush-bordeaux-gradient-background{background:var(--wp--preset--gradient--blush-bordeaux)!important}.has-luminous-dusk-gradient-background{background:var(--wp--preset--gradient--luminous-dusk)!important}.has-pale-ocean-gradient-background{background:var(--wp--preset--gradient--pale-ocean)!important}.has-electric-grass-gradient-background{background:var(--wp--preset--gradient--electric-grass)!important}.has-midnight-gradient-background{background:var(--wp--preset--gradient--midnight)!important}.has-small-font-size{font-size:var(--wp--preset--font-size--small)!important}.has-medium-font-size{font-size:var(--wp--preset--font-size--medium)!important}.has-large-font-size{font-size:var(--wp--preset--font-size--large)!important}.has-x-large-font-size{font-size:var(--wp--preset--font-size--x-large)!important}.wp-block-navigation a:where(:not(.wp-element-button)){color:inherit}:where(.wp-block-columns.is-layout-flex){gap:2em}.wp-block-pullquote{font-size:1.5em;line-height:1.6}</style>
<link rel="stylesheet" id="contact-form-7-css" href="https://azeria-labs.com/wp-content/plugins/contact-form-7/includes/css/A.styles.css.pagespeed.cf.BWVnRDAE9I.css" type="text/css" media="all">
<link rel="stylesheet" id="stylesheet-css" href="https://azeria-labs.com/wp-content/themes/unicon/A.style.css.pagespeed.cf.CxYd9aqE1A.css" type="text/css" media="all">
<link rel="stylesheet" id="js_composer_front-css" href="https://azeria-labs.com/wp-content/plugins/js_composer/assets/css/A.js_composer.min.css.pagespeed.cf.J2ymyeC32Y.css" type="text/css" media="all">
<link rel="stylesheet" id="shortcodes-css" href="https://azeria-labs.com/wp-content/themes/unicon/framework/css/A.shortcodes.css.pagespeed.cf.gQlKZUpOmq.css" type="text/css" media="all">
<link rel="stylesheet" id="responsive-css" href="https://azeria-labs.com/wp-content/themes/unicon/framework/css/A.responsive.css.pagespeed.cf.OD-Zu4XGUf.css" type="text/css" media="all">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800,300italic,400italic,600italic,700italic,800italic%7CMontserrat:400,700%7CAdamina:400&amp;amp;subset=latin"><script type="text/javascript" src="https://azeria-labs.com/wp-includes/js/jquery/jquery.min.js.pagespeed.ce.DoUKabx_0K.js" id="jquery-core-js"></script>
<script type="text/javascript" src="https://azeria-labs.com/wp-includes/js/jquery/jquery-migrate.min.js.pagespeed.ce.XPorSB3m6H.js" id="jquery-migrate-js"></script>
<link rel="https://api.w.org/" href="https://azeria-labs.com/wp-json/"><link rel="alternate" type="application/json" href="https://azeria-labs.com/wp-json/wp/v2/pages/17809"><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://azeria-labs.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://azeria-labs.com/wp-includes/wlwmanifest.xml">
<link rel="canonical" href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/">
<link rel="shortlink" href="https://azeria-labs.com/?p=17809">
<link rel="alternate" type="application/json+oembed" href="https://azeria-labs.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fazeria-labs.com%2Fheap-exploitation-part-2-glibc-heap-free-bins%2F">
<link rel="alternate" type="text/xml+oembed" href="https://azeria-labs.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fazeria-labs.com%2Fheap-exploitation-part-2-glibc-heap-free-bins%2F&amp;format=xml">
<style type="text/css">body{font:400 13px Open\ Sans,Arial,Helvetica,sans-serif;color:#fff;line-height:1.9}.wrapall,.boxed-layout{background-color:#353535}body.page-template-page-blank-php{background:#353535!important}h1{font:400 28px Adamina,Arial,Helvetica,sans-serif;color:#1cbac8}h2{font:400 24px Adamina,Arial,Helvetica,sans-serif;color:#1cbac8}h3{font:400 20px Adamina,Arial,Helvetica,sans-serif;color:#1cbac8}h4{font:400 16px Adamina,Arial,Helvetica,sans-serif;color:#1cbac8}h5{font:400 16px Adamina,Arial,Helvetica,sans-serif;color:#1cbac8}h6{font:400 16px Adamina,Arial,Helvetica,sans-serif;color:#1cbac8}.title{font-family:'Adamina',Arial,Helvetica,sans-serif}h1 a,h2 a,h3 a,h4 a,h5 a,h6 a{font-weight:inherit;color:inherit}h1 a:hover,h2 a:hover,h3 a:hover,h4 a:hover,h5 a:hover,h6 a:hover,a:hover h1,a:hover h2,a:hover h3,a:hover h4,a:hover h5,a:hover h6{color:#fff}a{color:#1cbac8}a:hover{color:#fff}input[type="text"],input[type="password"],input[type="email"],input[type="tel"],textarea,select{font-family:Open\ Sans,Arial,Helvetica,sans-serif;font-size:13px}#sidebar .widget h3{font:14px Montserrat,Arial,Helvetica,sans-serif;color:#1cbac8}.container .twelve.alt.sidebar-right,.container .twelve.alt.sidebar-left,#sidebar.sidebar-right #sidebar-widgets,#sidebar.sidebar-left #sidebar-widgets{border-color:#efefef}#topbar{background:#f5f5f5;color:#777}#topbar a{color:#999}#topbar a:hover{color:#333}@media only screen and (max-width:767px){#topbar .topbar-col1{background:#f5f5f5}}#navigation>ul>li>a{font:13px Montserrat,Arial,Helvetica,sans-serif;color:#fff}#navigation>ul>li:hover>a,#navigation>ul>li>a:hover{color:#1cbac8}#navigation li.current-menu-item>a:hover,#navigation li.current-page-ancestor>a:hover,#navigation li.current-menu-ancestor>a:hover,#navigation li.current-menu-parent>a:hover,#navigation li.current_page_ancestor>a:hover,#navigation>ul>li.sfHover>a{color:#1cbac8}#navigation li.current-menu-item>a,#navigation li.current-page-ancestor>a,#navigation li.current-menu-ancestor>a,#navigation li.current-menu-parent>a,#navigation li.current_page_ancestor>a{color:#ff5b5b}#navigation ul li:hover{border-color:#1cbac8}#navigation li.current-menu-item,#navigation li.current-page-ancestor,#navigation li.current-menu-ancestor,#navigation li.current-menu-parent,#navigation li.current_page_ancestor{border-color:#ff5b5b}#navigation .sub-menu{background:#262626}#navigation .sub-menu li a{font:13px Open\ Sans,Arial,Helvetica,sans-serif;color:#fff}#navigation .sub-menu li a:hover{color:#1b90c6}#navigation .sub-menu li.current_page_item>a,#navigation .sub-menu li.current_page_item>a:hover,#navigation .sub-menu li.current-menu-item>a,#navigation .sub-menu li.current-menu-item>a:hover,#navigation .sub-menu li.current-page-ancestor>a,#navigation .sub-menu li.current-page-ancestor>a:hover,#navigation .sub-menu li.current-menu-ancestor>a,#navigation .sub-menu li.current-menu-ancestor>a:hover,#navigation .sub-menu li.current-menu-parent>a,#navigation .sub-menu li.current-menu-parent>a:hover,#navigation .sub-menu li.current_page_ancestor>a,#navigation .sub-menu li.current_page_ancestor>a:hover{color:#1b90c6}#navigation .sub-menu li a,#navigation .sub-menu ul li a{border-color:#333}#navigation>ul>li.megamenu>ul.sub-menu{background:#262626;border-color:#1cbac8}#navigation>ul>li.megamenu>ul>li{border-right-color:#333!important}#navigation>ul>li.megamenu ul li a{color:#fff}#navigation>ul>li.megamenu>ul>li>a{color:#ff5b5b}#navigation>ul>li.megamenu>ul ul li a:hover,#header #navigation>ul>li.megamenu>ul ul li.current-menu-item a{color:#1b90c6!important;background-color:#333!important}#search-btn,#shopping-btn,#close-search-btn{color:#ff5b5b}#search-btn:hover,#shopping-btn:hover,#close-search-btn:hover{color:#ff5b5b}#slogan{font:20px Open\ Sans,Arial,Helvetica,sans-serif;color:#777;margin-top:26px}#mobile-navigation{background:#262626}#mobile-navigation ul li a{font:13px Open\ Sans,Arial,Helvetica,sans-serif;color:#fff;border-bottom-color:#333!important}#mobile-navigation ul li a:hover,#mobile-navigation ul li a:hover [class^="fa-"],#mobile-navigation li.open>a,#mobile-navigation ul li.current-menu-item>a,#mobile-navigation ul li.current-menu-ancestor>a{color:#1b90c6}body #mobile-navigation li.open>a [class^="fa-"]{color:#1b90c6}#mobile-navigation form,#mobile-navigation form input{background:#444;color:#1cbac8}#mobile-navigation form:before{color:#1cbac8}#mobile-header{background:#353535;height:90px}#mobile-navigation-btn,#mobile-cart-btn,#mobile-shopping-btn{color:#ff5b5b;line-height:90px}#mobile-navigation-btn:hover,#mobile-cart-btn:hover,#mobile-shopping-btn:hover{color:#ff5b5b}#mobile-header .logo{margin-top:0}#header.header-v1{height:90px;background:#353535}.header-v1 .logo{margin-top:0}.header-v1 #navigation>ul>li{height:90px;padding-top:65px}.header-v1 #navigation .sub-menu{top:90px}.header-v1 .header-icons-divider{line-height:90px;background:#6fbfc6}#header.header-v1 .widget_shopping_cart{top:90px}.header-v1 #search-btn,.header-v1 #close-search-btn,.header-v1 #shopping-btn{line-height:90px}.header-v1 #search-top,.header-v1 #search-top input{height:90px}.header-v1 #search-top input{color:#1cbac8;font-family:Open\ Sans,Arial,Helvetica,sans-serif}#header.header-v3{background:#353535}.header-v3 .navigation-wrap{background:#353535;border-top:1px solid #6fbfc6}.header-v3 .logo{margin-top:30px;margin-bottom:30px}#header.header-v4{background:#353535}.header-v4 .navigation-wrap{background:#353535;border-top:1px solid #6fbfc6}.header-v4 .logo{margin-top:30px;margin-bottom:30px}#transparentimage{padding:90px 0 0 0}.header-is-transparent #mobile-navigation{top:90px}.stuck{background:#353535}.titlebar h1{font:22px Open\ Sans,Arial,Helvetica,sans-serif;color:#777}#fulltitle{background:#f9f9f9;border-bottom:1px solid #efefef}#breadcrumbs{margin-top:6px}#breadcrumbs,#breadcrumbs a{font:13px Open\ Sans,Arial,Helvetica,sans-serif;color:#aaa}#breadcrumbs a:hover{color:#666}#fullimagecenter h1,#transparentimage h1{font:42px Montserrat,Arial,Helvetica,sans-serif;color:#fff;text-transform:uppercase;letter-spacing:1px;text-align:center}#footer .widget h3{font:13px Montserrat,Arial,Helvetica,sans-serif;color:#fff}#footer{color:#1cbac8;border-top:4px none #1cbac8}#footer{background-color:#262626}#footer a,#footer .widget ul li:after{color:#fff}#footer a:hover,#footer .widget ul li:hover:after{color:#fff}#footer .widget ul li{border-bottom-color:#333}#copyright{background:#1b1b1b;color:#1cbac8}#copyright a{color:#fff}#copyright a:hover{color:#1cbac8}.highlight{color:#1cbac8!important}::selection{background:#1cbac8}::-moz-selection{background:#1cbac8}#shopping-btn span{background:#1cbac8}.blog-page .post h1 a:hover,.blog-page .post h2 a:hover{color:#1cbac8}.entry-image .entry-overlay{background:#1cbac8}.entry-quote a:hover{background:#1cbac8}.entry-link a:hover{background:#1cbac8}.blog-single .entry-tags a:hover{color:#1cbac8}.sharebox ul li a:hover{color:#1cbac8}#pagination .current a{background:#1cbac8}#filters ul li a:hover{color:#1cbac8}#filters ul li a.active{color:#1cbac8}#back-to-top a:hover{background-color:#1cbac8}#sidebar .widget ul li a:hover{color:#1cbac8}#sidebar .widget ul li:hover:after{color:#1cbac8}.widget_tag_cloud a:hover,.widget_product_tag_cloud a:hover{background:#1cbac8;border-color:#1cbac8}.widget_portfolio .portfolio-widget-item .portfolio-overlay{background:#1cbac8}#sidebar .widget_nav_menu ul li a:hover{color:#1cbac8}#footer .widget_tag_cloud a:hover,#footer .widget_product_tag_cloud a:hover{background:#1cbac8;border-color:#1cbac8}.box.style-2{border-top-color:#1cbac8}.box.style-4{border-color:#1cbac8}.box.style-6{background:#1cbac8}a.button,input[type="submit"],button,.minti_button{background:#1cbac8;border-color:#1cbac8}a.button.color-2{color:#1cbac8;border-color:#1cbac8}a.button.color-3{background:#1cbac8;border-color:#1cbac8}a.button.color-9{color:#1cbac8}a.button.color-6:hover{background:#1cbac8;border-color:#1cbac8}a.button.color-7:hover{background:#1cbac8;border-color:#1cbac8}.counter-number{color:#1cbac8}.divider-title.align-center:after,.divider-title.align-left:after{background-color:#1cbac8}.divider5{border-bottom-color:#1cbac8}.dropcap.dropcap-circle{background-color:#1cbac8}.dropcap.dropcap-box{background-color:#1cbac8}.dropcap.dropcap-color{color:#1cbac8}.toggle .toggle-title.active,.color-light .toggle .toggle-title.active{background:#1cbac8;border-color:#1cbac8}.iconbox-style-1.icon-color-accent i.boxicon,.iconbox-style-2.icon-color-accent i.boxicon,.iconbox-style-3.icon-color-accent i.boxicon,.iconbox-style-8.icon-color-accent i.boxicon,.iconbox-style-9.icon-color-accent i.boxicon{color:#1cbac8!important}.iconbox-style-4.icon-color-accent i.boxicon,.iconbox-style-5.icon-color-accent i.boxicon,.iconbox-style-6.icon-color-accent i.boxicon,.iconbox-style-7.icon-color-accent i.boxicon,.flip .icon-color-accent.card .back{background:#1cbac8}.latest-blog .blog-item .blog-overlay{background:#1cbac8}.latest-blog .blog-item .blog-pic i{color:#1cbac8}.latest-blog .blog-item h4 a:hover{color:#1cbac8}.progressbar .progress-percentage{background:#1cbac8}.wpb_widgetised_column .widget ul li a:hover{color:#1cbac8}.wpb_widgetised_column .widget ul li:hover:after{color:#1cbac8}.wpb_accordion .wpb_accordion_wrapper .ui-state-active .ui-icon{background-color:#1cbac8}.wpb_accordion .wpb_accordion_wrapper .ui-state-active.wpb_accordion_header a{color:#1cbac8}.wpb_accordion .wpb_accordion_wrapper .wpb_accordion_header a:hover,.wpb_accordion .wpb_accordion_wrapper .wpb_accordion_header a:hover .ui-state-default .ui-icon{color:#1cbac8}.wpb_accordion .wpb_accordion_wrapper .wpb_accordion_header:hover .ui-icon{background-color:#1cbac8!important}.wpb_content_element.wpb_tabs .wpb_tabs_nav li.ui-tabs-active{border-bottom-color:#1cbac8}.portfolio-item h4 a:hover{color:#1cbac8}.portfolio-filters ul li a:hover{color:#1cbac8}.portfolio-filters ul li a.active{color:#1cbac8}.portfolio-overlay-icon .portfolio-overlay{background:#1cbac8}.portfolio-overlay-icon i{color:#1cbac8}.portfolio-overlay-effect .portfolio-overlay{background:#1cbac8}.portfolio-overlay-name .portfolio-overlay{background:#1cbac8}.portfolio-detail-attributes ul li a:hover{color:#1cbac8}a.catimage:hover .catimage-text{background:#1cbac8}.products li h3{font:400 13px Open\ Sans,Arial,Helvetica,sans-serif;color:#fff}.woocommerce .button.checkout-button{background:#1cbac8;border-color:#1cbac8}.woocommerce .products .onsale{background:#1cbac8}.product .onsale{background:#1cbac8}button.single_add_to_cart_button:hover{background:#1cbac8}.woocommerce-tabs>ul>li.active a{color:#1cbac8;border-bottom-color:#1cbac8}p.stars a:hover{background:#1cbac8}p.stars a.active,p.stars a.active:after{background:#1cbac8}.product_list_widget a{color:#1cbac8}.woocommerce .widget_layered_nav li.chosen a{color:#1cbac8!important}.woocommerce .widget_product_categories>ul>li.current-cat>a{color:#1cbac8!important}.woocommerce .widget_product_categories>ul>li.current-cat:after{color:#1cbac8!important}.woocommerce-message{background:#1cbac8}.bbp-topics-front ul.super-sticky .bbp-topic-title:before,.bbp-topics ul.super-sticky .bbp-topic-title:before,.bbp-topics ul.sticky .bbp-topic-title:before,.bbp-forum-content ul.sticky .bbp-topic-title:before{color:#1cbac8!important}#subscription-toggle a:hover{background:#1cbac8}.bbp-pagination-links span.current{background:#1cbac8}div.wpcf7-mail-sent-ok,div.wpcf7-mail-sent-ng,div.wpcf7-spam-blocked,div.wpcf7-validation-errors{background:#1cbac8}.wpcf7-not-valid{border-color:#1cbac8!important}.products .button.add_to_cart_button{color:#1cbac8!important}.minti_list.color-accent li:before{color:#1cbac8!important}.blogslider_text .post-categories li a{background-color:#1cbac8}.minti_zooming_slider .flex-control-nav li .minti_zooming_slider_ghost{background-color:#1cbac8}.minti_carousel.pagination_numbers .owl-dots .owl-dot.active{background-color:#1cbac8}.wpb_content_element.wpb_tour .wpb_tabs_nav li.ui-tabs-active,.color-light .wpb_content_element.wpb_tour .wpb_tabs_nav li.ui-tabs-active{background-color:#1cbac8}.masonry_icon i{color:#1cbac8}.font-special,.button,.counter-title,h6,.wpb_accordion .wpb_accordion_wrapper .wpb_accordion_header a,.pricing-plan .pricing-plan-head h3,a.catimage,.divider-title,button,input[type="submit"],input[type="reset"],input[type="button"],.vc_pie_chart h4,.page-404 h3,.minti_masonrygrid_item h4{font-family:'Montserrat',Arial,Helvetica,sans-serif}.ui-helper-reset{line-height:1.9}.blog-page .post div.entry-wrap div.entry-title h1 a,.blog-page .post div.entry-wrap div.entry-title h2 a,.entry-meta ul li a,#sidebar .widget.widget_recent_entries ul li a,#sidebar .widget.widget_categories ul li a{color:#fff}.blog-page .post div.entry-wrap div.entry-title h1 a:hover,.blog-page .post div.entry-wrap div.entry-title h2 a:hover,.entry-meta ul li a:hover,.entry-meta ul li,#sidebar .widget.widget_recent_entries ul li a:hover,#sidebar .widget.widget_categories ul li a:hover{color:#1cbac8}#header,#mobile-header{border-bottom:1px solid #fff}@media only screen and (max-width:959px){#header,.sticky-wrapper{display:none}#mobile-header{display:inherit}}</style><meta name="generator" content="Powered by WPBakery Page Builder - drag and drop page builder for WordPress.">
<style type="text/css" data-type="vc_custom-css">.wpb_wrapper p,.wpb_wrapper ul>li{text-align:justify}.wpb_wrapper p.wp-caption-text{text-align:center;color:#1cbac8;font-weight:bold}</style><noscript><style>.wpb_animate_when_almost_visible{opacity:1}</style></noscript></head>

<body class="page-template-default page page-id-17809 smooth-scroll wpb-js-composer js-comp-ver-6.9.0 vc_responsive">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99769710-1', 'auto');
  ga('send', 'pageview');

</script>
	<div class="site-wrapper wrapall">

	<header id="header" class="header header-v3 clearfix">
		
	<div class="container">
		<div class="sixteen columns">

			<div id="logo" class="logo">
									<a href="https://azeria-labs.com/"><img src="https://azeria-labs.com/wp-content/uploads/2017/08/azeria-labs-11.png.pagespeed.ce.Mn8gsglYk_.png" alt="Azeria Labs" class="logo_standard"></a>
					<a href="https://azeria-labs.com/"><img src="https://azeria-labs.com/wp-content/uploads/2017/08/azeria-labs-11.png.pagespeed.ce.Mn8gsglYk_.png" width="378" height="110" alt="Azeria Labs" class="logo_retina"></a>							</div>

			<div id="slogan" class="clearfix">
							</div>

		</div>
	</div>
	
	<div class="navigation-wrap">
		<div class="container">
			<div class="sixteen columns">
				
				<div id="navigation" class="clearfix">
					<ul id="nav" class="menu"><li id="menu-item-16543" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-16543"><a href="https://azeria-labs.com/writing-arm-assembly-part-1/">ARM Assembly</a>
<ul class="sub-menu">
	<li id="menu-item-16164" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16164"><a href="https://azeria-labs.com/writing-arm-assembly-part-1/">Part 1: Introduction to ARM Assembly</a></li>
	<li id="menu-item-16167" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16167"><a href="https://azeria-labs.com/arm-data-types-and-registers-part-2/">Part 2: ARM Data Types and Registers</a></li>
	<li id="menu-item-16172" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16172"><a href="https://azeria-labs.com/arm-instruction-set-part-3/">Part 3: ARM Instruction Set</a></li>
	<li id="menu-item-16217" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16217"><a href="https://azeria-labs.com/memory-instructions-load-and-store-part-4/">Part 4: Memory Instructions: LDR/STR</a></li>
	<li id="menu-item-16495" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16495"><a href="https://azeria-labs.com/load-and-store-multiple-part-5/">Part 5: Load and Store Multiple</a></li>
	<li id="menu-item-16175" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16175"><a href="https://azeria-labs.com/arm-conditional-execution-and-branching-part-6/">Part 6: Conditional Execution and Branching</a></li>
	<li id="menu-item-16221" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16221"><a href="https://azeria-labs.com/functions-and-the-stack-part-7/">Part 7: Stack and Functions</a></li>
	<li id="menu-item-17135" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17135"><a href="https://azeria-labs.com/assembly-basics-cheatsheet/">Assembly Basics Cheatsheet</a></li>
</ul>
</li>
<li id="menu-item-17846" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17846"><a href="https://azeria-labs.com/azm/">Online Assembler</a></li>
<li id="menu-item-17011" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-17011"><a href="https://azeria-labs.com/writing-arm-shellcode/">Exploitation</a>
<ul class="sub-menu">
	<li id="menu-item-17012" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17012"><a href="https://azeria-labs.com/writing-arm-shellcode/">Writing ARM Shellcode</a></li>
	<li id="menu-item-17294" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17294"><a href="https://azeria-labs.com/tcp-bind-shell-in-assembly-arm-32-bit/">TCP Bind Shell in Assembly (ARM 32-bit)</a></li>
	<li id="menu-item-17401" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17401"><a href="https://azeria-labs.com/tcp-reverse-shell-in-assembly-arm-32-bit/">TCP Reverse Shell in Assembly (ARM 32-bit)</a></li>
	<li id="menu-item-17071" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17071"><a href="https://azeria-labs.com/process-memory-and-memory-corruption/">Process Memory and Memory Corruption</a></li>
	<li id="menu-item-18087" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18087"><a href="https://azeria-labs.com/stack-overflow-arm32/">Stack Overflows (Arm32)</a></li>
	<li id="menu-item-18088" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18088"><a href="https://azeria-labs.com/return-oriented-programming-arm32/">Return Oriented Programming (Arm32)</a></li>
	<li id="menu-item-17212" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17212"><a href="https://azeria-labs.com/part-3-stack-overflow-challenges/">Stack Overflow Challenges</a></li>
	<li id="menu-item-17473" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17473"><a href="https://azeria-labs.com/process-continuation-shellcode/">Process Continuation Shellcode</a></li>
	<li id="menu-item-17774" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17774"><a href="https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/">Glibc Heap – malloc</a></li>
	<li id="menu-item-17833" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-17809 current_page_item menu-item-17833"><a href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/" aria-current="page">Glibc Heap – free, bins, tcache</a></li>
	<li id="menu-item-17862" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17862"><a href="https://azeria-labs.com/heap-exploit-development-part-1/">Part 1: Heap Exploit Development</a></li>
	<li id="menu-item-17883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17883"><a href="https://azeria-labs.com/heap-overflows-and-the-ios-kernel-heap/">Part 2: Heap Overflows and the iOS Kernel</a></li>
	<li id="menu-item-17927" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17927"><a href="https://azeria-labs.com/grooming-the-ios-kernel-heap/">Part 3: Grooming the iOS Kernel Heap</a></li>
</ul>
</li>
<li id="menu-item-16711" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-16711"><a href="https://azeria-labs.com/emulate-raspberry-pi-with-qemu/">Lab Environment</a>
<ul class="sub-menu">
	<li id="menu-item-17171" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17171"><a href="https://azeria-labs.com/arm-lab-vm/">ARM Lab VM 1.0</a></li>
	<li id="menu-item-18101" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18101"><a href="https://azeria-labs.com/lab-vm-2-0/">ARM Lab VM 2.0</a></li>
	<li id="menu-item-16347" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16347"><a href="https://azeria-labs.com/debugging-with-gdb-introduction/">Debugging with GDB and GEF</a></li>
	<li id="menu-item-16064" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16064"><a href="https://azeria-labs.com/emulate-raspberry-pi-with-qemu/">Emulate Raspberry Pi with QEMU</a></li>
	<li id="menu-item-18134" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18134"><a href="https://azeria-labs.com/arm-on-x86-qemu-user/">Running Arm Binaries on x86 with QEMU-User</a></li>
	<li id="menu-item-18046" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18046"><a href="https://azeria-labs.com/emulating-arm-firmware/">Emulating Arm Firmware</a></li>
</ul>
</li>
<li id="menu-item-17962" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-17962"><a href="https://azeria-labs.com/trusted-execution-environments-tee-and-trustzone/">TrustZone Research</a>
<ul class="sub-menu">
	<li id="menu-item-17963" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17963"><a href="https://azeria-labs.com/trusted-execution-environments-tee-and-trustzone/">TEEs and Arm TrustZone</a></li>
	<li id="menu-item-18019" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18019"><a href="https://azeria-labs.com/trustonics-kinibi-tee-implementation/">Trustonic’s Kinibi TEE</a></li>
</ul>
</li>
<li id="menu-item-17402" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-17402"><a href="https://azeria-labs.com/the-importance-of-deep-work-the-30-hour-method-for-learning-a-new-skill/">Self-Improvement</a>
<ul class="sub-menu">
	<li id="menu-item-17404" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17404"><a href="https://azeria-labs.com/the-importance-of-deep-work-the-30-hour-method-for-learning-a-new-skill/">Deep Work &amp; The 30-Hour Method</a></li>
	<li id="menu-item-17520" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17520"><a href="https://azeria-labs.com/paradox-of-choice/">Paradox of Choice</a></li>
	<li id="menu-item-17676" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17676"><a href="https://azeria-labs.com/the-process-of-mastering-a-skill/">The Process of Mastering a Skill</a></li>
</ul>
</li>
<li id="menu-item-16844" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16844"><a href="https://azeria-labs.com/about/">About</a></li>
</ul>				</div>

				
			</div>
		</div>
	</div>	
	
</header>

<div id="mobile-header">
	<div class="container">
		<div class="sixteen columns">
			<div id="mobile-logo" class="logo">
									<a href="https://azeria-labs.com/"><img src="https://azeria-labs.com/wp-content/uploads/2017/08/azeria-labs-11.png.pagespeed.ce.Mn8gsglYk_.png" alt="Azeria Labs" class="logo_standard"></a>
					<a href="https://azeria-labs.com/"><img src="https://azeria-labs.com/wp-content/uploads/2017/08/azeria-labs-11.png.pagespeed.ce.Mn8gsglYk_.png" width="378" height="110" alt="Azeria Labs" class="logo_retina"></a>							</div>
			<a href="#" id="mobile-navigation-btn"><i class="fa fa-bars"></i></a>
					</div>
	</div>
</div>

<div id="mobile-navigation">
	<div class="container">
		<div class="sixteen columns">
			<div class="menu-main-container"><ul id="mobile-nav" class="menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-16543"><a href="https://azeria-labs.com/writing-arm-assembly-part-1/">ARM Assembly</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16164"><a href="https://azeria-labs.com/writing-arm-assembly-part-1/">Part 1: Introduction to ARM Assembly</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16167"><a href="https://azeria-labs.com/arm-data-types-and-registers-part-2/">Part 2: ARM Data Types and Registers</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16172"><a href="https://azeria-labs.com/arm-instruction-set-part-3/">Part 3: ARM Instruction Set</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16217"><a href="https://azeria-labs.com/memory-instructions-load-and-store-part-4/">Part 4: Memory Instructions: LDR/STR</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16495"><a href="https://azeria-labs.com/load-and-store-multiple-part-5/">Part 5: Load and Store Multiple</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16175"><a href="https://azeria-labs.com/arm-conditional-execution-and-branching-part-6/">Part 6: Conditional Execution and Branching</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16221"><a href="https://azeria-labs.com/functions-and-the-stack-part-7/">Part 7: Stack and Functions</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17135"><a href="https://azeria-labs.com/assembly-basics-cheatsheet/">Assembly Basics Cheatsheet</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17846"><a href="https://azeria-labs.com/azm/">Online Assembler</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-17011"><a href="https://azeria-labs.com/writing-arm-shellcode/">Exploitation</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17012"><a href="https://azeria-labs.com/writing-arm-shellcode/">Writing ARM Shellcode</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17294"><a href="https://azeria-labs.com/tcp-bind-shell-in-assembly-arm-32-bit/">TCP Bind Shell in Assembly (ARM 32-bit)</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17401"><a href="https://azeria-labs.com/tcp-reverse-shell-in-assembly-arm-32-bit/">TCP Reverse Shell in Assembly (ARM 32-bit)</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17071"><a href="https://azeria-labs.com/process-memory-and-memory-corruption/">Process Memory and Memory Corruption</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18087"><a href="https://azeria-labs.com/stack-overflow-arm32/">Stack Overflows (Arm32)</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18088"><a href="https://azeria-labs.com/return-oriented-programming-arm32/">Return Oriented Programming (Arm32)</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17212"><a href="https://azeria-labs.com/part-3-stack-overflow-challenges/">Stack Overflow Challenges</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17473"><a href="https://azeria-labs.com/process-continuation-shellcode/">Process Continuation Shellcode</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17774"><a href="https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/">Glibc Heap – malloc</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-17809 current_page_item menu-item-17833"><a href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/" aria-current="page">Glibc Heap – free, bins, tcache</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17862"><a href="https://azeria-labs.com/heap-exploit-development-part-1/">Part 1: Heap Exploit Development</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17883"><a href="https://azeria-labs.com/heap-overflows-and-the-ios-kernel-heap/">Part 2: Heap Overflows and the iOS Kernel</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17927"><a href="https://azeria-labs.com/grooming-the-ios-kernel-heap/">Part 3: Grooming the iOS Kernel Heap</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-16711"><a href="https://azeria-labs.com/emulate-raspberry-pi-with-qemu/">Lab Environment</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17171"><a href="https://azeria-labs.com/arm-lab-vm/">ARM Lab VM 1.0</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18101"><a href="https://azeria-labs.com/lab-vm-2-0/">ARM Lab VM 2.0</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16347"><a href="https://azeria-labs.com/debugging-with-gdb-introduction/">Debugging with GDB and GEF</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16064"><a href="https://azeria-labs.com/emulate-raspberry-pi-with-qemu/">Emulate Raspberry Pi with QEMU</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18134"><a href="https://azeria-labs.com/arm-on-x86-qemu-user/">Running Arm Binaries on x86 with QEMU-User</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18046"><a href="https://azeria-labs.com/emulating-arm-firmware/">Emulating Arm Firmware</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-17962"><a href="https://azeria-labs.com/trusted-execution-environments-tee-and-trustzone/">TrustZone Research</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17963"><a href="https://azeria-labs.com/trusted-execution-environments-tee-and-trustzone/">TEEs and Arm TrustZone</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18019"><a href="https://azeria-labs.com/trustonics-kinibi-tee-implementation/">Trustonic’s Kinibi TEE</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-17402"><a href="https://azeria-labs.com/the-importance-of-deep-work-the-30-hour-method-for-learning-a-new-skill/">Self-Improvement</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17404"><a href="https://azeria-labs.com/the-importance-of-deep-work-the-30-hour-method-for-learning-a-new-skill/">Deep Work &amp; The 30-Hour Method</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17520"><a href="https://azeria-labs.com/paradox-of-choice/">Paradox of Choice</a></li>
	<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17676"><a href="https://azeria-labs.com/the-process-of-mastering-a-skill/">The Process of Mastering a Skill</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-16844"><a href="https://azeria-labs.com/about/">About</a></li>
</ul></div>			
				
		</div>
	</div>
</div>

		
			
					<div id="notitlebar"></div>
		


<div id="page-wrap" class="container">

	<div id="content" class="sidebar-right twelve alt columns">
	
		<div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="divider-title align-center">Part 2: Understanding the GLIBC Heap Implementation</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><a href="https://azeria-labs.com/wp-content/uploads/2019/03/chunk-allocated-simple-CS.png"><img decoding="async" class="wp-image-17795 alignright" src="https://azeria-labs.com/wp-content/uploads/2019/03/chunk-allocated-simple-CS.png.pagespeed.ce.4F7IE_9i1S.png" alt="" width="400" height="302" srcset="https://azeria-labs.com/wp-content/uploads/2019/03/chunk-allocated-simple-CS.png.pagespeed.ce.4F7IE_9i1S.png 500w, https://azeria-labs.com/wp-content/uploads/2019/03/chunk-allocated-simple-CS-300x227.png.pagespeed.ce.bYIMlrjhi2.png 300w" sizes="(max-width: 400px) 100vw, 400px"></a></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400;">Welcome back to this series on understanding and exploiting the </span><i><span style="font-weight: 400;">glibc </span></i><span style="font-weight: 400;">heap!</span></p>
<p><span style="font-weight: 400;">In </span><a href="https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">the first part of this series</span></a><span style="font-weight: 400;">, I explained the basic behavior of </span><a href="https://linux.die.net/man/3/malloc" target="_blank" rel="noopener noreferrer"><i><span style="font-weight: 400;">malloc</span></i></a><span style="font-weight: 400;"> and </span><a href="https://linux.die.net/man/3/free" target="_blank" rel="noopener noreferrer"><i><span style="font-weight: 400;">free</span></i></a><span style="font-weight: 400;">. We saw that, under-the-hood, </span><i><span style="font-weight: 400;">malloc</span></i><span style="font-weight: 400;"> handles memory allocation requests by allocating memory </span><i><span style="font-weight: 400;">chunks. </span></i><span style="font-weight: 400;">Each chunk not only stores the “user data” region returned by malloc that the programmer will interact with, but also metadata associated with that chunk.</span></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400;"><a href="https://azeria-labs.com/wp-content/uploads/2019/03/heap-chunks-top.gif"><img decoding="async" loading="lazy" class="alignleft wp-image-17753" src="https://azeria-labs.com/wp-content/uploads/2019/03/heap-chunks-top.gif.pagespeed.ce.-1T8whb15V.gif" alt="" width="161" height="300"></a></span></p>
<p>&nbsp;</p>
<p><span style="font-weight: 400;">We saw how the heap manager’s basic chunk-allocation strategy works, and we saw how new chunks get created from the top of the heap when there are no already-freed chunks that can be recycled to service the request.</span></p>
<p><span style="font-weight: 400;">In this post, I want to talk about how this chunk-recycling strategy works, i.e., how allocations passed back to </span><i><span style="font-weight: 400;">free</span></i><span style="font-weight: 400;"> get saved and eventually recycled to service future </span><i><span style="font-weight: 400;">malloc </span></i><span style="font-weight: 400;">requests. Lots of heap&nbsp;exploitation techniques rely on exploiting these internal mechanics—we’ll look at these in future posts—but for now, let’s just look at how these chunks get recycled by </span><i><span style="font-weight: 400;">free</span></i><span style="font-weight: 400;"> when the heap is operating correctly.</span></p>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">How Does Free Work?</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">When a programmer is finished with an allocation from </span><i><span style="font-weight: 400;">malloc</span></i><span style="font-weight: 400;"> (or a malloc-compatible allocation like </span><i><span style="font-weight: 400;">calloc</span></i><span style="font-weight: 400;">), the programmer releases it back to the heap manager by passing it to </span><a href="https://linux.die.net/man/3/free" target="_blank" rel="noopener noreferrer"><i><span style="font-weight: 400;">free</span></i></a><span style="font-weight: 400;">. The </span><a href="http://www.open-std.org/JTC1/SC22/wg14/www/docs/n1124.pdf" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">C standard</span></a><span style="font-weight: 400;"> defines </span><i><span style="font-weight: 400;">free(NULL)</span></i><span style="font-weight: 400;"> to do nothing, but for all other calls to free, the heap manager’s first job is to resolve the pointer back to its corresponding chunk. The heap manager does this by </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1172" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">subtracting the size of the chunk metadata from the pointer</span></a><span style="font-weight: 400;"> that was passed to free.</span></p>

		</div>
	</div>

	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">This conversion from pointer to chunk works because the user data region lies inside the chunk, but it is, of course, only valid if the pointer passed to free really is from a live allocation from </span><i><span style="font-weight: 400;">malloc</span></i><span style="font-weight: 400;">. If some other pointer were passed to free, the heap manager might release or recycle an invalid chunk leading to memory corruption problems that could cause the process to crash or potentially even let hackers remotely takeover the process.</span></p>
<p><span style="font-weight: 400;">For this reason, </span><i><span style="font-weight: 400;">free</span></i><span style="font-weight: 400;"> first does a couple of basic sanity checks to see if the freed pointer is obviously invalid before attempting to process it. If any of the checks fail, the program aborts. The checks include:</span></p>
<ol>
<li><span style="font-weight: 400;">A check that the allocation </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l4182" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">is aligned</span></a><span style="font-weight: 400;"> on an 8-byte (or 16-byte on 64-bit) boundary, since </span><i><span style="font-weight: 400;">malloc</span></i><span style="font-weight: 400;"> ensures all allocations are aligned.</span></li>
<li><span style="font-weight: 400;">A check that the chunk’s size field isn’t impossible–either because it is </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l4318" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">too small</span></a><span style="font-weight: 400;">, too large, not an aligned size, or </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l4175" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">would overlap the end of the process’ address space</span></a><span style="font-weight: 400;">.</span></li>
<li><span style="font-weight: 400;">A check the chunk lies </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l4318" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">within the boundaries of the arena</span></a><span style="font-weight: 400;">.</span></li>
<li><span style="font-weight: 400;">A check that the chunk is </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l4182" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">not already marked as free</span></a><span style="font-weight: 400;"> by checking the corresponding “P” bit that lies in the metadata at the start of the next chunk.</span></li>
</ol>
<p><span style="font-weight: 400;">The heap manager’s checks here are not exhaustive; an pointer to data an attacker controls could potentially bypass these sanity checks and still trigger memory corruption in the process. We’ll look at this in more detail in later posts.</span></p>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">Free Chunk Metadata</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">In my last post, I also showed how live chunks store metadata alongside the “user data” region used by the programmer. These live allocations store the “chunk size”, and three bits called “A”, “M” and “P” in their metadata. Those bits help the heap manager remember if the chunk was allocated from the non-main arena, was allocated off-heap via </span><i><span style="font-weight: 400;">mmap</span></i><span style="font-weight: 400;">, and whether the previous chunk is free respectively.</span></p>
<p><span style="font-weight: 400;">Free chunks store metadata too. Like live allocations, they store the “chunk size”, “A”, and “P” fields, but they do not use the “M” field, since an <a href="http://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="noopener noreferrer">mmap</a>-ed chunk will always be </span><a href="https://linux.die.net/man/3/munmap" target="_blank" rel="noopener noreferrer"><i><span style="font-weight: 400;">munmap-</span></i></a><span style="font-weight: 400;">ed during </span><i><span style="font-weight: 400;">free</span></i><span style="font-weight: 400;"> rather than turned into a free chunk for recycling.</span></p>
<p><span style="font-weight: 400;"><a href="https://azeria-labs.com/wp-content/uploads/2019/03/chunk-freed-CS.png"><img decoding="async" loading="lazy" class="aligncenter size-full wp-image-17810" src="https://azeria-labs.com/wp-content/uploads/2019/03/chunk-freed-CS.png.pagespeed.ce.LjsJuaS6ts.png" alt="" width="600" height="375" srcset="https://azeria-labs.com/wp-content/uploads/2019/03/chunk-freed-CS.png.pagespeed.ce.LjsJuaS6ts.png 600w, https://azeria-labs.com/wp-content/uploads/2019/03/chunk-freed-CS-300x188.png.pagespeed.ce.CM3h9xasPc.png 300w" sizes="(max-width: 600px) 100vw, 600px"></a></span></p>
<p><span style="font-weight: 400;">Free chunks also store information </span><i><span style="font-weight: 400;">after</span></i><span style="font-weight: 400;"> the user data region using a technique called “</span><a href="http://g.oswego.edu/dl/html/malloc.html" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">boundary tags</span></a><span style="font-weight: 400;">”. These boundary tags carry size information before and after the chunk. This allows chunks to be traversed starting from any known chunk and in any direction, and thereby enable very fast coalescing of adjacent free chunks.</span></p>
<p><span style="font-weight: 400;">These freed chunks are stored in corresponding “free bins” that operate as <a href="https://en.wikipedia.org/wiki/Linked_list" target="_blank" rel="noopener noreferrer">linked lists</a>. This requires each free chunk to also store pointers to other chunks. Since the “user data” in the freed chunk is (by definition) free for use by the heap manager, the heap manager repurposes this “user data” region in freed chunks as the place where this additional metadata lives.</span></p>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="divider divider1" style="margin:60px 0 60px 0 !important;"></div><div class="divider-title align-center">Recycling memory with bins</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">Internally, the heap manager needs to keep track of freed chunks so that malloc can reuse them during allocation requests. In a naive implementation, the heap manager could do this by simply storing all freed chunks together on some enormous linked list. This would work, but it would make </span><a href="https://linux.die.net/man/3/malloc" target="_blank" rel="noopener noreferrer"><i><span style="font-weight: 400;">malloc</span></i></a><span style="font-weight: 400;"> slow. Since </span><i><span style="font-weight: 400;">malloc </span></i><span style="font-weight: 400;">is a high-utilization component of most programs, this slowness would have a huge impact on the overall performance of programs running on the system. </span></p>
<p><span style="font-weight: 400;">To improve performance, the heap manager instead maintains a series of lists called “bins”, which are designed to maximize speed of allocations and frees.</span></p>
<p><span style="font-weight: 400;">There are 5 type of bins: </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1407" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">62</span></a> <b>small bins, </b><span style="font-weight: 400;">63 </span><b>large bins, </b><span style="font-weight: 400;">1 </span><b>unsorted bin, </b><span style="font-weight: 400;">10 </span><b>fast bins </b><span style="font-weight: 400;">and 64 </span><b>tcache bins </b><span style="font-weight: 400;">per thread.</span></p>
<p><span style="font-weight: 400;">The small, large, and unsorted bins are the oldest type of bin and are used to implement what I’ll refer to here as the </span><i><span style="font-weight: 400;">basic </span></i><span style="font-weight: 400;">recycling strategy of the heap. The fast bins and tcache bins are optimizations that layer on top of these.</span></p>
<p><span style="font-weight: 400;">Confusingly, the small, large, and unsorted bins all </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1686" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">live together in the same array</span></a><span style="font-weight: 400;"> in the heap manager’s source code. Index 0 is unused, 1 is the unsorted bin, bins 2-64 are small bins and bins 65-127 are large bins.</span></p>

		</div>
	</div>
<div class="single_image wpb_content_element align-center   image_zoom" data-animation="none" data-delay="0"><img width="461" height="175" src="https://azeria-labs.com/wp-content/uploads/2019/05/bins-new.png.pagespeed.ce.1uJk6oyDtu.png" class="attachment-full" alt="" decoding="async" loading="lazy" title="bins-new" srcset="https://azeria-labs.com/wp-content/uploads/2019/05/bins-new.png.pagespeed.ce.1uJk6oyDtu.png 461w, https://azeria-labs.com/wp-content/uploads/2019/05/bins-new-300x114.png.pagespeed.ce.u8zuWsIkNZ.png 300w" sizes="(max-width: 461px) 100vw, 461px"></div>
		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">Chunk recycling: the basic strategy</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">Before getting to </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> and </span><i><span style="font-weight: 400;">fastbin</span></i><span style="font-weight: 400;"> optimizations, let’s first look at the basic recycling strategy used by the heap manager.</span></p>
<p><span style="font-weight: 400;">Recall, the basic algorithm for </span><i><span style="font-weight: 400;">free </span></i><span style="font-weight: 400;">is as follows:</span></p>
<ol>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the chunk has the </span><i><span style="font-weight: 400;">M</span></i><span style="font-weight: 400;"> bit</span><span style="font-weight: 400;"> set in the metadata, the allocation was allocated off-heap and should be </span><a href="https://linux.die.net/man/3/munmap" target="_blank" rel="noopener noreferrer"><i><span style="font-weight: 400;">munmap</span></i></a><span style="font-weight: 400;">ed.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Otherwise, if the chunk </span><i><span style="font-weight: 400;">before</span></i><span style="font-weight: 400;"> this one is free, the chunk is merged backwards to create a bigger free chunk.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Similarly, if the chunk </span><i><span style="font-weight: 400;">after</span></i><span style="font-weight: 400;"> this one is free, the chunk is merged forwards to create a bigger free chunk.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">If this potentially-larger chunk borders the “top” of the heap, the whole chunk is absorbed into the end of the heap, rather than stored in a “bin”.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Otherwise, the chunk is marked as free and placed in an appropriate bin.</span></li>
</ol>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">Small Bins</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">Small bins are the easiest basic bin to understand. There are 62 of them, and each small bin stores chunks that are all the same fixed size. Every chunk less than 512 bytes on 32-bit systems (or than 1024 bytes on 64-bit systems) has a corresponding small bin. Since each small bin stores only one size of chunk, they are automatically ordered, so insertion and removal of entries on these lists is incredibly fast.</span></p>

		</div>
	</div>
<div class="single_image wpb_content_element align-center   image_zoom" data-animation="none" data-delay="0"><img width="800" height="491" src="https://azeria-labs.com/wp-content/uploads/2019/03/bins-small.png.pagespeed.ce.hyNIbbaoGL.png" class="attachment-full" alt="" decoding="async" loading="lazy" title="bins-small" srcset="https://azeria-labs.com/wp-content/uploads/2019/03/bins-small.png.pagespeed.ce.hyNIbbaoGL.png 800w, https://azeria-labs.com/wp-content/uploads/2019/03/bins-small-300x184.png.pagespeed.ce.HEuTJ4-smh.png 300w, https://azeria-labs.com/wp-content/uploads/2019/03/bins-small-768x471.png.pagespeed.ce.cQLp1n-3Qy.png 768w" sizes="(max-width: 800px) 100vw, 800px"></div>
		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">Large Bins</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">The strategy for small bins is great for small allocations, but we can’t have a bin for every possible chunk size. For chunks over 512 bytes (1024 bytes on 64-bit), the heap manager instead uses “large bins”. </span></p>
<p><span style="font-weight: 400;">Each of the 63 “large bins” operates mostly the same way as small bins, but instead of storing chunks with a fixed size, they instead store chunks within a size range. Each large bin’s size range is designed to not overlap with either the chunk sizes of small bins or the ranges of other large bins. In other words, given a chunk’s size, there is exactly one small bin or large bin that this size corresponds to.</span></p>
<p><span style="font-weight: 400;">Because large bins store a range of sizes, insertions onto the bin have to be manually sorted, and allocations from the list require traversing the list. This makes large bins inherently slower than their small bin equivalents. Large bins are, however, used less frequently during most programs. This is because programs tend to allocate (and thus release) small allocations at a far higher rate than large allocations on average. For the same reason, “large bin” ranges are clustered towards smaller chunk sizes; the smallest “large bin” covers only the 64-byte range from 512 bytes to 576 bytes, whereas the second largest covers a size range of 256KB. The largest of the large bins covers all freed chunks </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1394" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">above 1MB</span></a><span style="font-weight: 400;">.</span></p>

		</div>
	</div>
<div class="single_image wpb_content_element align-center   image_zoom" data-animation="none" data-delay="0"><img width="800" height="353" src="https://azeria-labs.com/wp-content/uploads/2019/03/bins-large.png.pagespeed.ce.ub5yRD4tiF.png" class="attachment-full" alt="" decoding="async" loading="lazy" title="bins-large" srcset="https://azeria-labs.com/wp-content/uploads/2019/03/bins-large.png.pagespeed.ce.ub5yRD4tiF.png 800w, https://azeria-labs.com/wp-content/uploads/2019/03/bins-large-300x132.png.pagespeed.ce.jFVUh2gNQ-.png 300w, https://azeria-labs.com/wp-content/uploads/2019/03/bins-large-768x339.png.pagespeed.ce.M9oEndbWxN.png 768w" sizes="(max-width: 800px) 100vw, 800px"></div>
		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">Unsorted Bin</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;"><a href="https://azeria-labs.com/wp-content/uploads/2019/03/bins-unsorted.png"><img decoding="async" loading="lazy" class="wp-image-17814 aligncenter" src="https://azeria-labs.com/wp-content/uploads/2019/03/bins-unsorted.png.pagespeed.ce.VuYxWHYx4R.png" alt="" width="238" height="500" srcset="https://azeria-labs.com/wp-content/uploads/2019/03/bins-unsorted.png.pagespeed.ce.VuYxWHYx4R.png 380w, https://azeria-labs.com/wp-content/uploads/2019/03/bins-unsorted-143x300.png.pagespeed.ce.OtJIvYEVY3.png 143w" sizes="(max-width: 238px) 100vw, 238px"></a></span></p>
<p><span style="font-weight: 400;">The heap manager improves this basic algorithm one step further using an optimizing cache layer called the “unsorted bin”. This optimization is based on the observation that often frees are clustered together, and frees are often immediately followed by allocations of similarly sized chunks. For example, a program releasing a tree or a list will often release many allocations for every entry all at once, and a program updating an entry in a list might release the previous entry before allocating space for its replacement.</span></p>
<p><span style="font-weight: 400;">In these cases, merges of these freed chunks before putting the resulting larger chunk away in the correct bin would avoid some overhead, and being able to fast-return a recently freed allocation would similarly speed up the whole process.</span></p>
<p><span style="font-weight: 400;">The heap manager introduces the </span><i><span style="font-weight: 400;">unsorted bin</span></i><span style="font-weight: 400;"> to take advantage of these observations. Instead of immediately putting newly freed chunks onto the correct bin, the heap manager coalesces it with neighbors, and dumps it onto a general </span><i><span style="font-weight: 400;">unsorted </span></i><span style="font-weight: 400;">linked list. During </span><i><span style="font-weight: 400;">malloc</span></i><span style="font-weight: 400;">, each item on the unsorted bin is checked to see if it “fits” the request. If it does, </span><i><span style="font-weight: 400;">malloc </span></i><span style="font-weight: 400;">can use it immediately. If it does not, malloc then puts the chunk into its corresponding small or large bin.</span></p>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">Fast Bins</div><div class="single_image wpb_content_element align-left   " data-animation="none" data-delay="0"><img width="800" height="491" src="https://azeria-labs.com/wp-content/uploads/2019/03/bins-fast.png.pagespeed.ce.5ckjeMVyfU.png" class="attachment-full" alt="" decoding="async" loading="lazy" title="bins-fast" srcset="https://azeria-labs.com/wp-content/uploads/2019/03/bins-fast.png.pagespeed.ce.5ckjeMVyfU.png 800w, https://azeria-labs.com/wp-content/uploads/2019/03/bins-fast-300x184.png.pagespeed.ce.ispruYaZah.png 300w, https://azeria-labs.com/wp-content/uploads/2019/03/bins-fast-768x471.png.pagespeed.ce.XCreCImCSP.png 768w" sizes="(max-width: 800px) 100vw, 800px"></div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">Fast bins are a further optimization layered on top of the three basic bins we’ve already seen. These bins essentially keep recently released small chunks on a “fast-turnaround queue”, intentionally keeping the chunk live and not merging the chunk with its neighbors so that it can be immediately repurposed if a malloc request for that chunk size comes in very soon after the chunk is freed.</span></p>
<p><span style="font-weight: 400;">Like small bins, each fast bin is responsible only for a single fixed chunk size. There are 10 such fast bins, covering chunks of size 16, 24, 32, 40, 48, 56, 64, 72, 80, and 88 bytes plus chunk metadata.</span></p>
<p><span style="font-weight: 400;">Unlike their small bin cousins, fast bins chunks are never merged with their neighbors. In practice, the way this works is the heap manager doesn’t set the “P” bit at the start of the next chunk. If you like, you can think of this conceptually as the heap manager not “truly” freeing the chunk in the fast-bins.</span></p>
<p><span style="font-weight: 400;">Like their small bin counterparts, fast bins covers only a single chunk size, are thus automatically sorted, and so insertions and removals are incredibly fast. Moreover, since fast-binned chunks are never merge candidates, they </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1678" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">can also be stored in singly-linked lists</span></a><span style="font-weight: 400;">, rather than needing to be on doubly linked lists so that they can be removed from a list if the chunk gets merged.</span></p>
<p><span style="font-weight: 400;">The downside of fastbins, of course, is that fastbin chunks are not “truly” freed or merged, and this would eventually cause the memory of the process to fragment and balloon over time. To resolve this, heap manager periodically “</span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l4448" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">consolidates</span></a><span style="font-weight: 400;">” the heap. This “flushes” each entry in the fast bin by “actually freeing” it, i.e., merging it with adjacent free chunks, and placing the resulting free chunks onto the unsorted bin for malloc to later use.</span></p>
<p><span style="font-weight: 400;">This “consolidation” stage occurs whenever a </span><i><span style="font-weight: 400;">malloc</span></i><span style="font-weight: 400;"> request is made that is larger than a </span><i><span style="font-weight: 400;">fastbin</span></i><span style="font-weight: 400;"> can service (i.e., for chunks </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l3696" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">over 512 bytes</span></a><span style="font-weight: 400;"> or 1024 bytes on 64-bit), when </span><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1592" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">freeing any chunk over 64KB</span></a><span style="font-weight: 400;"> (where 64KB is a heuristically chosen value), or when </span><a href="http://man7.org/linux/man-pages/man3/mallopt.3.html" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">malloc_trim</span></a><span style="font-weight: 400;"> or </span><a href="http://man7.org/linux/man-pages/man3/mallopt.3.html" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">mallopt</span></a><span style="font-weight: 400;"> are called by the program.</span></p>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">Tcache (per-thread cache) bins</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">The final optimization used by the heap manager to speed up allocations is the per-thread cache, or “</span><i><span style="font-weight: 400;">tcache”</span></i><span style="font-weight: 400;"> allocator. But first let’s look at the problem the tcache is trying to solve.</span></p>
<p><span style="font-weight: 400;">Each process on a given computer system has one or more threads running at the same time. Having multiple threads allows a process to execute multiple concurrent operations. For example, a high-volume web-server might have multiple simultaneous incoming requests, and the web-server might service each incoming request on its own thread, rather than have each request wait in line to be serviced.</span></p>
<p><span style="font-weight: 400;">Each thread in a given process shares the same address space, which is to say, each thread can see the same code and data in memory. Each thread gets its own registers and stack to store temporary local variables, but resources like global variables and the heap are shared between all of the threads.</span></p>

		</div>
	</div>
<div class="single_image wpb_content_element align-left   " data-animation="none" data-delay="0"><img width="800" height="399" src="https://azeria-labs.com/wp-content/uploads/2019/03/threads.png.pagespeed.ce.VaB3XNJZyR.png" class="attachment-full" alt="" decoding="async" loading="lazy" title="threads" srcset="https://azeria-labs.com/wp-content/uploads/2019/03/threads.png.pagespeed.ce.VaB3XNJZyR.png 800w, https://azeria-labs.com/wp-content/uploads/2019/03/threads-300x150.png.pagespeed.ce.yBz5j-68uL.png 300w, https://azeria-labs.com/wp-content/uploads/2019/03/threads-768x383.png.pagespeed.ce.wxVcBw-u7N.png 768w" sizes="(max-width: 800px) 100vw, 800px"></div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">Coordinating access to global resources like the heap is a complicated topic, and getting it wrong can lead to a problem known as “</span><i><span style="font-weight: 400;">race conditions”</span></i><span style="font-weight: 400;">, which cause hard-to-debug crashes which are often also exploitable by hackers.</span></p>
<p><span style="font-weight: 400;">In our example of a website, suppose a web-request being serviced on one thread tries to update a database row, and another concurrent web-request tries to read from that same row. Normally, we’ll want to make sure the second thread never sees the row mid-write as it’s being overwritten by another thread and thus seeing the row in some partial or corrupted form. Databases solve this problem by making reads and writes appear to operate </span><i><span style="font-weight: 400;">atomically</span></i><span style="font-weight: 400;">: if two threads try to access the same row at the same time, one operation must complete before the next can begin. A very common way of solving these race-conditions is to force otherwise-simultaneous requests accessing a global resource into a sequential queue by using </span><i><span style="font-weight: 400;">locks</span></i><span style="font-weight: 400;">.</span></p>
<p><span style="font-weight: 400;">In general, locks work by one thread “marking” that it has taken ownership of a global resource before using it, then doing its operation, then marking that the resource is no longer in use. If another thread comes along and wants to use the resource and sees some other thread is using it, the thread waits until the other thread is done. This ensures that the global resource is only used by one thread at a time. But it comes with a cost: the thread that is waiting on the resource is stalling and wasting time. This is called “</span><i><span style="font-weight: 400;">lock contention</span></i><span style="font-weight: 400;">”. </span></p>
<p><span style="font-weight: 400;">For many global variables, this is an acceptable cost. But for the heap which is constantly in use by all threads, this cost quickly translates into the whole program slowing down.</span></p>
<p><span style="font-weight: 400;">The heap manager mostly solves this problem by using </span><span style="font-weight: 400;">per-thread arenas where each thread gets its own arena until it hits the threshold</span><span style="font-weight: 400;">. Additionally, the </span><i><span style="font-weight: 400;">tcache&nbsp;</span></i><span style="font-weight: 400;">per-thread cache is designed to reduce </span><span style="font-weight: 400;">the cost of the lock itself because the lock instructions are quite expensive and end up taking a significant portion of the execution time in the fast path</span><span style="font-weight: 400;">. This feature was </span><a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=glibc-malloc-thread-cache" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">added to the malloc memory allocation function in glibc 2.26 </span></a><span style="font-weight: 400;">and is enabled by default.</span></p>
<p><span style="font-weight: 400;">Per-thread caching speeds up allocations by having per-thread bins of small chunks ready-to-go. That way, when a thread requests a chunk, if the thread has a chunk available on its tcache, it can service the allocation without ever needing to wait on a heap lock.</span></p>
<p><span style="font-weight: 400;">By default, each thread has 64 singly-linked tcache bins. Each bin contains a maximum of </span><a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l323" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">7 same-size chunks</span></a><span style="font-weight: 400;"> ranging from </span><a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l315" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">24 to 1032 bytes on 64-bit systems and 12 to 516 bytes on 32-bit systems</span></a><span style="font-weight: 400;">.</span></p>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="spacer" style="height: 40px;"></div><div class="divider-title align-center">How do chunks end up in tcache bins?</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">When a chunk is freed, the heap manager sees if the chunk will fit into a </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> bin corresponding to the chunk size. Like the fast-bin, chunks on the </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> bin are considered “in use”, and won’t be merged with neighboring freed chunks.</span></p>
<p><span style="font-weight: 400;">If the </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> for that chunk size is full (or the chunk is too big for a </span><i><span style="font-weight: 400;">tcache </span></i><span style="font-weight: 400;">bin), the heap manager reverts to our old slow-path strategy of obtaining the heap lock and then processing the chunk as before.</span></p>
<p><span style="font-weight: 400;">Corresponding </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> allocations are also pretty straightforward. Given a request for a chunk if a chunk is available on an appropriate </span><i><span style="font-weight: 400;">tcache </span></i><span style="font-weight: 400;">bin, the heap returns that chunk without ever obtaining the heap lock. If the chunk is too big for the </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;">, we also continue as before.</span></p>
<p><span style="font-weight: 400;">In the case where we try and make an allocation, there is a corresponding </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> bin, but that bin is full, we do a slightly-modified allocation strategy. Rather than just taking the heap lock and finding a </span><i><span style="font-weight: 400;">single </span></i><span style="font-weight: 400;">chunk, we take the heap lock and </span><a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3585" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">opportunistically promote as many chunks as possible at this size to the </span><i><span style="font-weight: 400;">tcache</span></i></a><span style="font-weight: 400;"> while we still hold the heap lock, up to the </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> bin limit of seven, </span><a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3778" target="_blank" rel="noopener noreferrer"><span style="font-weight: 400;">and return the last matching chunk</span></a><span style="font-weight: 400;"> back to the user.</span></p>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="divider divider1" style="margin:60px 0 60px 0 !important;"></div><div class="divider-title align-center">Putting it all together</div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">We now know enough to fully understand the entire behavior of </span><i><span style="font-weight: 400;">malloc</span></i><span style="font-weight: 400;"> and </span><i><span style="font-weight: 400;">free</span></i><span style="font-weight: 400;"> in the </span><i><span style="font-weight: 400;">glibc </span></i><span style="font-weight: 400;">heap implementation, and why each part of the algorithm exists. Let’s recap.</span></p>
<p><span style="font-weight: 400;">First, every allocation exists as a memory chunk which is aligned and contains metadata as well as the region the programmer wants. When a programmer requests memory from the heap, the heap manager first works out what chunk size the allocation request corresponds to, and then searches for the memory in the following order:</span></p>
<ol>
<li style="list-style-type: none;">
<ol>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the size corresponds with a </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> bin and there is a </span><i><span style="font-weight: 400;">tcache </span></i><span style="font-weight: 400;">chunk available, return that immediately.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the request is enormous allocate a chunk off-heap via </span><i><span style="font-weight: 400;">mmap.</span></i></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Otherwise we obtain the arena heap lock and then perform the following strategies, in order:</span>
<ol>
<li style="font-weight: 400;"><b>Try the <i>fastbin/smallbin </i>recycling strategy</b>
<ul>
<li style="font-weight: 400;"><span style="font-weight: 400;">If a corresponding </span><i><span style="font-weight: 400;">fast bin</span></i><span style="font-weight: 400;"> exists, try and find a chunk from there (and also opportunistically prefill the </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> with entries from the fast bin).</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Otherwise, if a corresponding </span><i><span style="font-weight: 400;">small bin</span></i><span style="font-weight: 400;"> exists, allocate from there (opportunistically prefilling the </span><i><span style="font-weight: 400;">tcache</span></i><span style="font-weight: 400;"> as we go).</span></li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<ol>
<li style="list-style-type: none;">
<ol>
<li style="list-style-type: none;">
<ol>
<li style="list-style-type: none;"></li>
<li><b>Resolve all the deferred frees</b>
<ul>
<li><span style="font-weight: 400;">Otherwise “truly free” the entries in the fast-bins and move their consolidated chunks to the </span><i><span style="font-weight: 400;">unsorted </span></i><span style="font-weight: 400;">bin.</span></li>
<li><span style="font-weight: 400;">Go through each entry in the </span><i><span style="font-weight: 400;">unsorted </span></i><span style="font-weight: 400;">bin. If it is suitable, stop. Otherwise, put the unsorted entry on its corresponding small/large bin as we go (possibly promoting small entries to the </span><i><span style="font-weight: 400;">tcache </span></i><span style="font-weight: 400;">as we go).</span></li>
</ul>
</li>
<li><b>Default back to the basic recycling strategy</b>
<ul>
<li><span style="font-weight: 400;">If the chunk size corresponds with a large bin, search the corresponding large bin now.</span></li>
</ul>
</li>
<li><b>Create a new chunk from scratch</b>
<ul>
<li style="font-weight: 400;"><span style="font-weight: 400;">Otherwise, there are no chunks available, so try and get a chunk from the top of the heap.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the top of the heap is not big enough, extend it using </span><i><span style="font-weight: 400;">sbrk</span></i><span style="font-weight: 400;">.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the top of the heap can’t be extended because we ran into something else in the address space, create a discontinuous extension using </span><i><span style="font-weight: 400;">mmap</span></i><span style="font-weight: 400;"> and allocate from there</span></li>
</ul>
</li>
<li><b>If all else fails, return NULL<span style="font-weight: 400;">.</span></b></li>
</ol>
</li>
</ol>
</li>
</ol>
<ul>
<li style="list-style-type: none;">
<ul>
<li style="list-style-type: none;">
<ul>
<li style="list-style-type: none;">
<ul>
<li style="list-style-type: none;"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li style="list-style-type: none;">
<ol>
<li style="list-style-type: none;"></li>
<li style="list-style-type: none;"></li>
<li style="list-style-type: none;"></li>
</ol>
</li>
</ol>

		</div>
	</div>

	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><span style="font-weight: 400;">And the corresponding </span><i><span style="font-weight: 400;">free</span></i><span style="font-weight: 400;"> strategy:</span></p>
<ol>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the pointer is NULL, the C standard defines the behavior as “do nothing”.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Otherwise, convert the pointer back to a chunk by subtracting the size of the chunk metadata.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Perform a few sanity checks on the chunk, and abort if the sanity checks fail.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the chunk fits into a </span><i><span style="font-weight: 400;">tcache </span></i><span style="font-weight: 400;">bin, store it there.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the chunk has the </span><i><span style="font-weight: 400;">M </span></i><span style="font-weight: 400;">bit set, give it back to the operating system via </span><i><span style="font-weight: 400;">munmap</span></i><span style="font-weight: 400;">.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Otherwise we obtain the arena heap lock and then:</span>
<ol>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the chunk fits into a fastbin, put it on the corresponding fastbin, and we’re done.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the chunk is &gt; 64KB, consolidate the fastbins immediately and put the resulting merged chunks on the unsorted bin.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Merge the chunk backwards and forwards with neighboring freed chunks in the small, large, and unsorted bins.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">If the resulting chunk lies at the top of the heap, merge it into the top of the heap rather than storing it in a bin.</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Otherwise store it in the </span><i><span style="font-weight: 400;">unsorted bin</span></i><span style="font-weight: 400;">. (</span><i><span style="font-weight: 400;">Malloc</span></i><span style="font-weight: 400;"> will later do the work to put entries from the unsorted bin into the small or large bins).</span></li>
</ol>
</li>
</ol>

		</div>
	</div>

		</div> 
	</div> 
</div></div><div class="wpb_row vc_row-fluid standard-section section  section-no-parallax  stretch   " data-speed="1" style=""><div class="col span_12 color-dark left">
	<div class="vc_col-sm-12 wpb_column column_container col no-padding color-dark" style="" data-animation="" data-delay="">
		<div class="wpb_wrapper">
			<div class="divider divider1" style="margin:60px 0 60px 0 !important;"></div>
	<div class="wpb_text_column wpb_content_element ">
		<div class="wpb_wrapper">
			<p><strong>Looking for a comprehensive training on exploit development?</strong></p>
<p>Sign up for my <a href="https://www.blackhat.com/us-19/training/schedule/index.html#azeria-labs-iot-exploit-development-for-arm-14313" target="_blank" rel="noopener noreferrer">upcoming Black Hat USA training</a> in Las Vegas, where I will be teaching a 2-day course on “Arm-based IoT Exploit Development”. My 3-day training at <a href="https://infiltratecon.com/training/" target="_blank" rel="noopener noreferrer">Infiltrate</a> is Sold Out. If your company is interested in private trainings and wants to save up to 50% compared to conference trainings, send a message to contact[at]azeria-labs.com.</p>

		</div>
	</div>

		</div> 
	</div> 
</div></div>

		
		
			</div> <!-- end content -->

		<div id="sidebar" class="sidebar-right alt">
		<div id="sidebar-widgets" class="four columns">

    <div id="nav_menu-20" class="widget widget_nav_menu"><h3>ARM Exploit Development</h3><div class="menu-arm-exploitation-container"><ul id="menu-arm-exploitation" class="menu"><li id="menu-item-17009" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17009"><a href="https://azeria-labs.com/writing-arm-shellcode/">Writing ARM Shellcode</a></li>
<li id="menu-item-17337" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17337"><a href="https://azeria-labs.com/tcp-bind-shell-in-assembly-arm-32-bit/">TCP Bind Shell (ARM 32-bit)</a></li>
<li id="menu-item-17463" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17463"><a href="https://azeria-labs.com/tcp-reverse-shell-in-assembly-arm-32-bit/">TCP Reverse Shell (ARM 32-bit)</a></li>
<li id="menu-item-17072" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17072"><a href="https://azeria-labs.com/process-memory-and-memory-corruption/">Process Memory and Memory Corruption</a></li>
<li id="menu-item-18090" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18090"><a href="https://azeria-labs.com/stack-overflow-arm32/">Stack Overflows (Arm32)</a></li>
<li id="menu-item-18089" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18089"><a href="https://azeria-labs.com/return-oriented-programming-arm32/">Return Oriented Programming (Arm32)</a></li>
<li id="menu-item-17221" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17221"><a href="https://azeria-labs.com/part-3-stack-overflow-challenges/">Stack Overflow Challenges</a></li>
<li id="menu-item-17465" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17465"><a href="https://azeria-labs.com/process-continuation-shellcode/">Process Continuation Shellcode</a></li>
<li id="menu-item-17775" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17775"><a href="https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/">Introduction to Glibc Heap (malloc)</a></li>
<li id="menu-item-17832" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-17809 current_page_item menu-item-17832"><a href="https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/" aria-current="page">Introduction to Glibc Heap (free, bins)</a></li>
<li id="menu-item-17872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17872"><a href="https://azeria-labs.com/heap-exploit-development-part-1/">Heap Exploit Development (Part 1)</a></li>
<li id="menu-item-17888" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17888"><a href="https://azeria-labs.com/heap-overflows-and-the-ios-kernel-heap/">Heap Overflows and iOS Kernel (Part 2)</a></li>
<li id="menu-item-17929" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-17929"><a href="https://azeria-labs.com/grooming-the-ios-kernel-heap/">Grooming the iOS Kernel Heap (Part 3)</a></li>
</ul></div></div><div id="text-12" class="widget widget_text">			<div class="textwidget"><hr>
<span style="color:white">Twitter: </span>
<a href="https://twitter.com/fox0x01">
@Fox0x01</a> <span style="color:white">and</span><a href="https://twitter.com/azeria_labs">
@azeria_labs</a>
<br><br>
<h3 style="color:#ff5b5b">New ARM Assembly Cheat Sheet</h3>
<a href="https://teespring.com/arm32-assembly-cheatsheet-2020" class="button color-2 small" target="_blank" rel="noopener">Poster</a>
<a href="https://gumroad.com/l/Arm-cheatsheet-2020-version" class="button color-2 small" target="_blank" rel="noopener">Digital</a> <br><br>
<img src="http://azeria-labs.com/wp-content/uploads/2020/05/cheatsheet-2020-mini.png" alt="Cheat Sheet"></div>
		</div>
</div>	</div>
	
</div> <!-- end page-wrap -->
	
		
			
		<footer id="footer">
			<div class="container">
				<div class="four columns"></div>
								<div class="four columns"></div>
												<div class="four columns"></div>
												<div class="four columns"></div>	
							</div>
		</footer>
		
		<div id="copyright" class="clearfix">
		<div class="container">
			
			<div class="sixteen columns">

				<div class="copyright-text copyright-col1">
											© 2017-2022 Azeria Labs™ | All Rights Reserved.									</div>
				
				<div class="copyright-col2">
											
<div class="social-icons clearfix">
	<ul>
													<li><a href="https://github.com/azeria-labs" target="_blank" title="Github"><i class="fa fa-github"></i></a></li>
																									<li><a href="https://twitter.com/Fox0x01" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></li>
															</ul>
</div>									</div>

			</div>
			
		</div>
	</div><!-- end copyright -->
			
	</div><!-- end wrapall / boxed -->
	
		<div id="back-to-top"><a href="#"><i class="fa fa-chevron-up"></i></a></div>
		
	<script type="text/html" id="wpb-modifications"></script><script type="text/javascript" src="https://azeria-labs.com/wp-content/plugins/contact-form-7/includes/swv/js/index.js.pagespeed.ce.e-ZawnAkx7.js" id="swv-js"></script>
<script type="text/javascript" id="contact-form-7-js-extra">
/* <![CDATA[ */
var wpcf7 = {"api":{"root":"https:\/\/azeria-labs.com\/wp-json\/","namespace":"contact-form-7\/v1"}};
/* ]]> */
</script>
<script src="https://azeria-labs.com/wp-content/plugins,_contact-form-7,_includes,_js,_index.js+themes,_unicon,_framework,_js,_jquery.easing.min.js+themes,_unicon,_framework,_js,_waypoints.min.js+themes,_unicon,_framework,_js,_waypoints-sticky.min.js+themes,_unicon,_framework,_js,_prettyPhoto.js.pagespeed.jc.5JzarGntSN.js"></script><script>eval(mod_pagespeed_ywBAY$ryOe);</script>
<script>eval(mod_pagespeed_rFGm7RXv88);</script>
<script>eval(mod_pagespeed_Mzr4as6THB);</script>
<script>eval(mod_pagespeed_rDcip3V3y8);</script>
<script>eval(mod_pagespeed_F_oZkq$P_0);</script>
<script type="text/javascript" src="https://azeria-labs.com/wp-content/themes/unicon/framework/js/isotope.pkgd.min.js.pagespeed.ce.9TqWB268we.js" id="minti-isotope-js"></script>
<script type="text/javascript" src="https://azeria-labs.com/wp-content/themes/unicon/framework/js/functions.js.pagespeed.ce.r5dJtCVMsW.js" id="minti-functions-js"></script>
<script src="https://azeria-labs.com/wp-content,_themes,_unicon,_framework,_js,_flexslider.min.js+wp-includes,_js,_comment-reply.min.js.pagespeed.jc.BVipDbzwnB.js"></script><script>eval(mod_pagespeed_mp3NGmTw$c);</script>
<script>eval(mod_pagespeed_aR3dA613tt);</script>
<script type="text/javascript" id="wpb_composer_front_js-js-extra">
/* <![CDATA[ */
var vcData = {"currentTheme":{"slug":"unicon"}};
/* ]]> */
</script>
<script type="text/javascript" src="https://azeria-labs.com/wp-content/plugins/js_composer/assets/js/dist/js_composer_front.min.js" id="wpb_composer_front_js-js"></script>

	<script type="text/javascript">
	jQuery(document).ready(function($){
		"use strict";
	    
		/* PrettyPhoto Options */
		var lightboxArgs = {			
						animation_speed: 'slow',
						overlay_gallery: false,
			autoplay_slideshow: false,
						slideshow: 5000,
									opacity: 0.8,
						show_title: false,
			social_tools: "",			deeplinking: false,
			allow_resize: true,
			allow_expand: false,
			counter_separator_label: '/',
			default_width: 1160,
			default_height: 653
		};
		
				/* Automatic Lightbox */
		$('a[href$=jpg], a[href$=JPG], a[href$=jpeg], a[href$=JPEG], a[href$=png], a[href$=gif], a[href$=bmp]:has(img)').prettyPhoto(lightboxArgs);
					
		/* General Lightbox */
		$('a[class^="prettyPhoto"], a[rel^="prettyPhoto"], .prettyPhoto').prettyPhoto(lightboxArgs);

		/* WooCommerce Lightbox */
		$("a[data-rel^='prettyPhoto']").prettyPhoto({
			hook: 'data-rel',
			social_tools: false,
			deeplinking: false,
			overlay_gallery: false,
			opacity: 0.8,
			allow_expand: false, /* Allow the user to expand a resized image. true/false */
			show_title: false
		});

		
	    
		/* Transparent Header */
	    function transparentHeader() {
			if ($(document).scrollTop() >= 60) {
				$('#header.header-v1').removeClass('header-transparent');
			}
			else {
				$('#header.header-v1.stuck').addClass('header-transparent');
			}
		}
			
		/* Sticky Header */
		if (/Android|BlackBerry|iPhone|iPad|iPod|webOS/i.test(navigator.userAgent) === false) {

			var $stickyHeaders = $('#header.header-v1, #header.header-v3 .navigation-wrap, #header.header-v4 .navigation-wrap');
			$stickyHeaders.waypoint('sticky');
			
			$(window).resize(function() {
				$stickyHeaders.waypoint('unsticky');
				if ($(window).width() < 944) {
					$stickyHeaders.waypoint('unsticky');
				}
				else {
					$stickyHeaders.waypoint('sticky');
				}
			});
			
			if ($("body").hasClass("header-is-transparent")) {
				$(document).scroll(function() { transparentHeader(); });
				transparentHeader();
		    }

		}			
	    
	    
	    	
	    /* Fill rest of page */
	    			    			$('body').css({'background-color' : '#1b1b1b' });
	    			    
	});
	</script>
	


</body></html>